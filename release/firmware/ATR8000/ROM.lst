   1:				;
   2:     -	0001          			SALLYBUILD	EQU	1
   3:     -	0000          			WD1772		EQU	0
   4:     -	0000          			SALLYRS		EQU	0
   5:				;	
   6:					ASEG
   7:     -	0000          		ORG	0
   8:				;
   9:				;
  10:				;
  11:						INCLUDE	EQUS.MAC
**** ..\src\EQUS.MAC ****
   1:				;--------------------------------------------------
   2:				; Equates for Sally2 Hi-Speed-SIO code
   3:				;--------------------------------------------------
   4:     -	0000          	NOHIGHSPEEDSIO		EQU	0
   5:				;
   6:				;--------------------------------------------------
   7:				; Track-Buffer 26*256 bytes
   8:				;--------------------------------------------------
   9:     -	1000          	TRKBUFFER		EQU	01000h
  10:					
  11:     -	0028          	SIONORMAL		EQU	40
  12:     -	0008          	SIOFAST			EQU	8
  13:				;--------------------------------------------------
  14:				;
  15:				;--------------------------------------------------
  16:				;
  17:				;
  18:				;
  19:     -	0020          	PRINTER			EQU	20H		;PRINTER OUTPUT/INPUTS
  20:     -	0030          	LATCH			EQU	30H		;DRIVE CONTROL LATCH
  21:     -	0040          	WD179X			EQU	40H		;WD TYPE DISK CONTROLLER
  22:				;		
  23:     -	0050          	SERIN			EQU	50H		;RS232 SERIAL INPUT
  24:				;		
  25:     -	0050          	ATROUT			EQU	50H		;ATARI SERIAL OUTPUT
  26:     -	0051          	SEROUT			EQU	51H		;RS232 SERIAL OUTPUT
  27:     -	0052          	BANKSW			EQU	52H		;ROM BANKSWITCH BIT
  28:     -	0053          	STROBE			EQU	53H		;PRINTER STROBE
  29:     -	0054          	INDXCLR			EQU	54H		;INDEX CONTROL FLOP CLEAR
  30:     -	0055          	DTR			EQU	55H		;DTR OUTPUT CONTROL
  31:     -	0056          	INDXSET			EQU	56H		;INDEX CONTROL FLOP SET
  32:     -	0057          	CDMUX			EQU	57H		;ATARI CMD/DATA MUX CONTROL
  33:				;		
  34:     -	0070          	ATARI			EQU	70H		;ATARI INPUT BITS PORT
  35:     -	0080          	CTC0			EQU	80H		;ZILOG COUNTER/TIMER 0
  36:     -	0081          	CTC1			EQU	81H		;ZILOG COUNTER/TIMER 1
  37:     -	0082          	CTC2			EQU	82H		;ZILOG COUNTER/TIMER 2
  38:     -	0083          	CTC3			EQU	83H		;ZILOG COUNTER/TIMER 3
  39:				;
  40:     -	0000          	CTC_D0_VECTOR:		EQU	00000000B	;Data is a Vector
  41:     -	0001          	CTC_D0_CONTROL:		EQU	00000001B	;Data is a Control Word
  42:     -	0002          	CTC_D1_SW_RST:		EQU	00000010B	;Perform a software reset
  43:     -	0004          	CTC_D2_TCNEXT:		EQU	00000100B	;Time Constant follows
  44:     -	0000          	CTC_D3_AUTOTRG:		EQU	00000000B	;Automatic trigger when Time Constant loaded
  45:     -	0008          	CTC_D3_CLKTRG:		EQU	00001000B	;CLK/TRIG pin pulse starts timer
  46:     -	0000          	CTC_D4_FALLEDGE:	EQU	00000000B	;CLK/TRIG edge selection - falling edge
  47:     -	0010          	CTC_D4_RISEEDGE:	EQU	00010000B	;CLK/TRIG edge selection - rising edge
  48:     -	0000          	CTC_D5_PRESC_16:	EQU	00000000B	;Timer prescaler value of 16
  49:     -	0020          	CTC_D5_PRESC256:	EQU	00100000B	;Timer prescaler value of 256
  50:     -	0000          	CTC_D6_MODE_TIM:	EQU	00000000B	;Selects Timer mode
  51:     -	0040          	CTC_D6_MODE_CNT:	EQU	01000000B	;Selects Counter mode
  52:     -	0000          	CTC_D7_INT_DIS:		EQU	00000000B	;Disables Interrupt
  53:     -	0080          	CTC_D7_INT_EN:		EQU	10000000B	;Enables Interrupt
  54:				;
  55:     -	0000          	NULL			EQU	00H
  56:     -	000D          	CR			EQU	0DH
  57:     -	000A          	LF			EQU	0AH
  58:				;
**** ..\src\ROM.MAC ****
  12:						INCLUDE	SYSINIT.MAC
**** ..\src\SYSINIT.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*							*
   4:				;********************************************************
   5:				;
   6:				;
   7:     -	0001          		SALLYDEBUG = 1
   8:				;
   9:				;
  10:				;
  11:    0+4	0000  F3      	INIT:		DI
  12:    4+4	0001  AF      			XOR	A
  13:    8+4	0002  3D      	INIT1:		DEC	A
  14:   12+7+5	0003  20FD    			JR	NZ,INIT1				;DO NOTHING FOR 1 MILLISECOND
  15:				
  16:   19+10	0005  21980B  			LD	HL,INITAB
  17:   29+7	0008  060B    			LD	B,ITBLEN/2				;SEND INITIAL POOP TO PROGRAMABLE I/O'S
  18:   36+7	000A  4E      	INIT2:		LD	C,(HL)
  19:   43+6	000B  23      			INC	HL
  20:   49+16	000C  EDA3    			OUTI
  21:   65+7+5	000E  20FA    			JR	NZ,INIT2
  22:				;
  23:				;	PERFORM READ/WRITE TEST OF TOP 4K RAM
  24:				;
  25:   72+10	0010  2100F0  	RAMTST:		LD	HL,MONITOR
  26:   82+7	0013  3E01    			LD	A,1
  27:   89+7	0015  0610    	RTST1:		LD	B,16
  28:   96+7	0017  77      	RTST2:		LD	(HL),A					;WRITE TEST BYTE INTO MONITOR/GLOBALS
  29:  103+4	0018  07      			RLCA						;ROTATE BIT PATTERN IN A
  30:  107+4	0019  2C      			INC	L					;BUMP L TO DO INNER LOOP 256 TIMES
  31:  111+7+5	001A  20FB    			JR	NZ,RTST2
  32:  118+4	001C  24      			INC	H
  33:  122+8+5	001D  10F8    			DJNZ	RTST2					;REPEAT 16 TIMES FOR 4096 BYTES
  34:				
  35:  130+7	001F  0E10    			LD	C,16
  36:  137+6	0021  2B      	RTST3:		DEC	HL
  37:  143+4	0022  0F      			RRCA
  38:  147+7	0023  BE      			CP	(HL)					;VERIFY THAT TEST PATTERN IS WRITTEN
  39:  154+7+5	0024  20FE    			JR	NZ,$					;STICK FOREVER IF MONITOR RAM FAILURE
  40:  161+8+5	0026  10F9    			DJNZ	RTST3
  41:  169+4	0028  0D      			DEC	C
  42:  173+7+5	0029  20F6    			JR	NZ,RTST3
  43:				
  44:  180+4	002B  87      			ADD	A,A
  45:  184+7+5	002C  20E7    			JR	NZ,RTST1				;DO 8 PASSES OVER MEMORY
  46:				;
  47:				;	NOW COPY MONITOR AND VARIABLES TO HIGH RAM
  48:				;
  49:  191+10	002E  21130D  			LD	HL,MONCOPY
  50:  201+10	0031  1100F0  			LD	DE,MONITOR
  51:  211+10	0034  010E0F  			LD	BC,MONSIZE
  52:  221+16+5	0037  EDB0    			LDIR						;COPY RESIDENT CODE INTO RAM
  53:				
  54:  237+10	0039  21211C  			LD	HL,VARCOPY
  55:  247+10	003C  1120FF  			LD	DE,glbvars
  56:  257+10	003F  012F00  			LD	BC,glbsize
  57:  267+16+5	0042  EDB0    			LDIR						;INITIALIZE GLOBAL VARIABLES
  58:  283+4	0044  AF      			XOR	A
  59:  287+7	0045  12      	ZEROS:		LD	(DE),A
  60:  294+4	0046  1C      			INC	E
  61:  298+7+5	0047  20FC    			JR	NZ,ZEROS				;FILL REST OF SCRATCHPAD WITH ZEROS
  62:				
  63:     -	0001          	IF SALLYBUILD			
  64:  305+10	0049  210000  			LD	HL, 00000h				; source
  65:  315+10	004C  110080  			LD	DE, 08000h				; dest
  66:  325+10	004F  010020  			LD	BC, 02000h
  67:  335+16+5	0052  EDB0    			LDIR
  68:  351+10	0054  215A00  			LD	HL, code8000
  69:  361+8	0057  CBFC    			SET	7, H
  70:  369+4	0059  E9      			JP	(HL)
  71:     -	005A          	code8000:
  72:  373+7	005A  3E01    			LD	A, 1
  73:  380+11	005C  D352    			OUT	(BANKSW), A
  74:  391+10	005E  210080  			LD	HL, 08000h
  75:  401+10	0061  110000  			LD	DE, 00000h
  76:  411+10	0064  010020  			LD	BC, 02000h
  77:  421+16+5	0067  EDB0    			LDIR
  78:  437+10	0069  C36C00  			JP	code0000
  79:     -	006C          	code0000:
  80:				ENDIF	;SALLYBUILD
  81:				
  82:				
  83:				;
  84:				;	ESTABLISH STACK AND INTERRUPT VECTOR BASE
  85:				;
  86:  447+10	006C  3110FF  			LD	SP,KEYBUF+16				;TEMP PLACE FOR STACK
  87:  457+7	006F  3EFF    			LD	A,HIGH RAM			
  88:  464+9	0071  ED47    			LD	I,A					;POINT I REGISTER TO VECTOR TABLE
  89:  473+8	0073  ED5E    			IM	2					;SELECT VECTORED INTERRUPTS
  90:				;			
  91:				;step 5 times in and then out to trk00.  
  92:				;set bit 6 for each online floppy in ff5eh percom block (16 bytes, byte 8 bit 6)
  93:				;
  94:  481+7	0075  3E4F    	REST:		LD	A, FBS+DRVSEL4+DRVSEL3+DRVSEL2+DRVSEL1	;INITIAL DRIVE PATTERN (ALL SELECTED) - select drive 1-4, Motor off, side 0, B/S=1, DD
  95:  488+11	0077  D330    			OUT	(LATCH), A
  96:  499+4	0079  57      			LD	D,A					;KEEP PATTERN IN D (d = 4fh)
  97:  503+7	007A  0605    			LD	B,5					;step 5 times
  98:  510+7	007C  3E4B    	REST1:		LD	A,STEPIN+NOWAITMTR+STEPRATE		;4b: 4 = step-in, b = NOWAITMTR+STEPRATE3
  99:				
 100:     -	0000          	IF WD1772
 102:				ELSE			
 103:  517+17	007E  CD6BF3  			CALL	TYP1CMD					;STEP IN 5 TIMES AS PRECAUTION FOR
 104:				ENDIF	;WD1772			
 105:							
 106:  534+8+5	0081  10F9    			DJNZ	REST1					; DRIVES THAT GET BEHIND TK0 SENSOR
 107:  542+7	0083  0664    			LD	B,100					;DO 100 STEPS TOWARD TRACK ZERO (support 100 track drives)
 108:  549+4	0085  7A      	REST2:		LD	A,D			
 109:  553+11	0086  D330    			OUT	(LATCH),A				;ISSUE SELECTS AND PAUSE A BIT
 110:  564+19	0088  E3      			EX	(SP),HL
 111:  583+19	0089  E3      			EX	(SP),HL
 112:  602+7	008A  3E6B    			LD	A,STEPOUT+NOWAITMTR+STEPRATE		;6b: 6 = step-out, b = NOWAITMTR+STEPRATE3
 113:				
 114:     -	0000          	IF WD1772
 116:				ELSE			
 117:  609+17	008C  CD6BF3  			CALL	TYP1CMD					;ISSUE STEP OUT COMMAND TO DRIVES
 118:				ENDIF	;WD1772			
 119:							
 120:  626+7	008F  1E01    			LD	E,DRVSEL1				;PREPARE TO TEST TK0 INDICATORS
 121:  633+4	0091  7B      	REST3:		LD	A,E			
 122:  637+7	0092  F640    			OR	FBS			
 123:  644+11	0094  D330    			OUT	(LATCH),A				;SELECT ONE DRIVE AT A TIME
 124:  655+19	0096  E3      			EX	(SP),HL					;Use this benign operation pair
 125:  674+19	0097  E3      			EX	(SP),HL					;to wait 38 T-states
 126:				
 127:     -	0000          	IF WD1772
 129:				ELSE
 130:  693+17	0098  CD91F3  			CALL	FORCE					;FORCE INTERRUPT TO SET TYPE 1 STATUS
 131:				ENDIF	;WD1772			
 132:							
 133:  710+8	009B  CB57    			BIT	2, A			
 134:  718+7+5	009D  2804    			JR	Z,REST3A				;JUMP IF TRACK ZERO NOT INDICATED
 135:  725+4	009F  7B      			LD	A,E			
 136:  729+4	00A0  2F      			CPL			
 137:  733+4	00A1  A2      			AND	D					;ELSE RESET SELECT BIT FOR DRIVE IN D
 138:  737+4	00A2  57      			LD	D,A			
 139:  741+8	00A3  CB23    	REST3A:		SLA	E					;ADVANCE SELECT BIT
 140:  749+8	00A5  CB63    			BIT	4,E			
 141:  757+7+5	00A7  28E8    			JR	Z,REST3					;DO SAME FOR ALL 4 DRIVES
 142:  764+8+5	00A9  10DA    			DJNZ	REST2					;THEN REPEAT STEP OUT 100 TIMES
 143:							
 144:     -	0000          	IF WD1772			
 149:				ELSE			
 150:  772+17	00AB  CD68F0  			call	shutdown				;unload the heads and deselect the drives
 151:				ENDIF	;WD1772
 152:				
 153:     -	0000          		IF SALLYRS = 1
 160:					ENDIF
 161:				
 162:     -	0001          		IF SALLYRS = 0
 163:  789+10	00AE  215EFF  			LD	HL, DMATRIX+DSKBITS
 164:  799+10	00B1  011000  			LD	BC, 16
 165:					ELSE
 168:					ENDIF
 169:  809+7	00B4  3E04    			LD	A, 4					;PREP TO SET FLAGS FOR DRIVES PRESENT
 170:  816+8	00B6  CB1A    	REST4:		RR	D			
 171:  824+7+5	00B8  3802    			JR	C,REST4A				;JUMP IF DRIVE(N) NOT AT TRACK ZERO
 172:  831+15	00BA  CBF6    			SET	PRESENT,(HL)				;ELSE SET BIT IN ARRAY(HL)
 173:  846+11	00BC  09      	REST4A:		ADD	HL,BC			
 174:  857+4	00BD  3D      			DEC	 A			
 175:  861+7+5	00BE  20F6    			JR	NZ,REST4				;DO FOR ALL 4 DRIVES
 176:				;			
 177:				
 178:  868+10	00C0  3100C1  			LD	SP, IOBUFF				;NEW PLACE FOR STACK
 179:				
 180:     -	0001          	IF SALLYBUILD
 181:				;--------------------------------------------------
 182:				; firmware patch
 183:				;--------------------------------------------------
 184:  878+7	00C3  3E28    			LD	A, SIONORMAL				;init Pokey-divisor
 185:  885+13	00C5  32D10B  			LD	(pokeydiv), A
 186:						
 187:  898+7	00C8  3E02    			LD	A, 2
 188:  905+13	00CA  32D00B  			LD	(direct), A
 189:						
 190:  918+10	00CD  21FFFF  			LD	HL, 0ffffh				;reset drive / track buffer
 191:  928+16	00D0  22D20B  			LD	(drive), HL
 192:				
 193:     -	0001          		IF SALLYRS = 0
 194:  944+10	00D3  2144F8  			LD	HL, DISKTAB+2
 195:  954+10	00D6  11B10B  			LD	DE, dsktb+3
 196:  964+10	00D9  011500  			LD	BC, 3*7
 197:  974+16+5	00DC  EDB0    			LDIR
 198:				
 199:  990+10	00DE  210800  			LD	HL, 8
 200: 1000+16	00E1  22AE0B  			LD	(dsktb),HL
 201: 1016+7	00E4  3E3F    			LD	A, '?'
 202: 1023+13	00E6  32B00B  			LD	(dsktb+2), A
 203: 1036+4	00E9  EB      			EX	DE, HL
 204:				
 205: 1040+7	00EA  3E61    			LD	A, getspeed & 255
 206: 1047+7	00EC  77      			LD	(HL), A
 207: 1054+6	00ED  23      			INC	HL
 208: 1060+7	00EE  3E03    			LD	A, getspeed / 256
 209: 1067+7	00F0  77      			LD	(HL), A
 210: 1074+6	00F1  23      			INC	HL
 211:				
 212: 1080+10	00F2  21AE0B  			LD	HL, dsktb
 213: 1090+16	00F5  2230F8  			LD	(SalyDISKID), HL
 214: 1106+16	00F8  2232F8  			LD	(SalyDISKID+2), HL
 215: 1122+16	00FB  2234F8  			LD	(SalyDISKID+4), HL
 216: 1138+16	00FE  2236F8  			LD	(SalyDISKID+6), HL
 217:				
 218:					ENDIF
 219: 1154+7	0101  3EC3    			LD	A, 0c3h					;'JP' instruction
 220: 1161+13	0103  3284F6  			LD	(XMITBUF), A
 221: 1174+13	0106  32D9F6  			LD	(RXBLOCK), A
 222: 1187+13	0109  32E2F7  			LD	(CMDWAIT), A
 223: 1200+13	010C  327EF7  			LD	(SalyLOGN1), A
 224: 1213+13	010F  321DF9  			LD	(SalyDISKWRT1), A
 225: 1226+13	0112  3298F9  			LD	(SalyDISKRD1), A
 226:				;		LD	(DISK4),A
 227:				
 228: 1239+10	0115  215508  			LD	HL, xmitbuffn
 229: 1249+16	0118  2285F6  			LD	(XMITBUF+1), HL
 230: 1265+10	011B  21A008  			LD	HL, rxblck
 231: 1275+16	011E  22DAF6  			LD	(RXBLOCK+1), HL
 232: 1291+10	0121  212C08  			LD	HL, cmdwaitfn
 233: 1301+16	0124  22E3F7  			LD	(CMDWAIT+1), HL
 234: 1317+10	0127  214801  			LD	HL, SalyLogon
 235: 1327+16	012A  227FF7  			LD	(SalyLOGN1+1), HL
 236: 1343+10	012D  219802  			LD	HL, dskreadfn
 237: 1353+16	0130  22DAF9  			LD	(SalyDISKRD3+1), HL
 238: 1369+10	0133  21B301  			LD	HL, dskrd1
 239: 1379+16	0136  2299F9  			LD	(SalyDISKRD1+1), HL
 240: 1395+10	0139  218002  			LD	HL, dskwrite
 241: 1405+16	013C  224EF9  			LD	(SalyDISKWRT3+1), HL
 242: 1421+10	013F  211E02  			LD	HL, dwrt
 243: 1431+16	0142  221EF9  			LD	(SalyDISKWRT1+1), HL
 244:				;		LD	HL, diskiodebug
 245:				;		LD	(DISK4+1),HL
 246:				
 247:				
 248:				ENDIF	;SALLYBUILD
 249:				
 250: 1447+10	0145  C362F7  			JP	EMULATOR				;GO INITIALIZE FOR ATARI OR CP/M
 251:				
 252:				
 253:     -	0001          	IF SALLYBUILD
 254:				
 255:     -	0148          	SalyLogon:
 256: 1457+13	0148  3233FF  			LD	(RWMAX),A				;DO LESS RETRIES IN ATARI MODE
 257:				
 258: 1470+7	014B  3EC3    			LD	A, 0c3h					;'JP' instruction
 259: 1477+13	014D  3267F1  			LD	(SEL4), A
 260: 1490+10	0150  215901  			LD	HL, SalySEL4
 261: 1500+16	0153  2268F1  			LD	(SEL4+1), HL
 262:     -	0000          		IF WD1772
 265:					ENDIF
 266: 1516+10	0156  C381F7  			JP	SalyLOGN2
 267:				
 268:     -	0000          		IF WD1772
 277:					ENDIF
 278:				;
 279:				;
 280:				;
 281:     -	0159          	SalySEL4:
 282: 1526+8	0159  CB70    			BIT	6, B					;8" found?
 283: 1534+7+5	015B  2850    			JR	Z, SalySEL4ex				;yes, do nothing
 284:				
 285: 1541+11	015D  C5      			PUSH	BC					;save registers
 286: 1552+11	015E  D5      			PUSH	DE
 287: 1563+11	015F  E5      			PUSH	HL
 288: 1574+15	0160  DDE5    			PUSH	IX
 289:				
 290: 1589+4	0162  78      			LD	A, B					;switch HD on
 291: 1593+8	0163  CBB7    			RES	6, A
 292: 1601+11	0165  D330    			OUT	(LATCH), A
 293:				
 294: 1612+15	0167  DDE5    			PUSH	IX					;load HL with IX
 295: 1627+10	0169  E1      			POP	HL
 296: 1637+10	016A  11DE0B  			LD	DE, dcb
 297: 1647+10	016D  010900  			LD	BC, 9
 298: 1657+16+5	0170  EDB0    			LDIR						;copy dcb
 299:							
 300: 1673+14	0172  DD21DE0B			LD	IX, dcb
 301: 1687+10	0176  21E70B  			LD	HL, idambuf
 302: 1697+16	0179  22E20B  			LD	(dcb + DSKPTR), HL
 303: 1713+10	017C  210600  			LD	HL, 6
 304: 1723+16	017F  22E40B  			LD	(dcb + DSKAUX), HL
 305: 1739+7	0182  3EC4    			LD	A, RIDCMD+4				;read address + settle delay
 306: 1746+13	0184  32C5FF  			LD	(CMDBYT), A
 307: 1759+7	0187  3E18    			LD	A, 018h					;substitute JR	Z,xx by JR xx
 308: 1766+13	0189  3200F1  			LD	(DISK3 + 031h), A
 309: 1779+7	018C  0603    			LD	B, 3
 310:     -	018E          	SalySEL4A:
 311: 1786+11	018E  C5      			PUSH	BC
 312: 1797+17	018F  CDD5F0  			CALL	SalyDISK3				;DISK3: READ 6 BYTE ID RECORD
 313: 1814+10	0192  C1      			POP	BC
 314: 1824+13	0193  3AE60B  			LD	A, (dcb + DSKSTS)
 315: 1837+4	0196  B7      			OR	A
 316: 1841+7+5	0197  2802    			JR	Z, SalySEL4B
 317: 1848+8+5	0199  10F3    			DJNZ	SalySEL4A
 318:				
 319: 1856+7	019B  3E28    	SalySEL4B:	LD	A, 028h					;reset JR Z,xx
 320: 1863+13	019D  3200F1  			LD	(DISK3 + 031h), A
 321:							
 322: 1876+14	01A0  DDE1    			POP	IX
 323: 1890+10	01A2  E1      			POP	HL
 324: 1900+10	01A3  D1      			POP	DE
 325: 1910+10	01A4  C1      			POP	BC
 326: 1920+13	01A5  3AE60B  			LD	A, (dcb + DSKSTS)			;check disk status
 327: 1933+4	01A8  B7      			OR	A
 328: 1937+7+5	01A9  2002    			JR	NZ, SalySEL4ex				;not zero, no HD
 329: 1944+8	01AB  CBB0    			RES	6, B					;
 330:     -	01AD          	SalySEL4ex:             
 331: 1952+4	01AD  78      			LD	A, B
 332: 1956+7	01AE  1600    			LD	D, 0
 333: 1963+10	01B0  C36AF1  			JP	SEL5
 334:				
 335:				;--------------------------------------------------
 336:				; hook for read directSector if aux1/2 = 0
 337:				;--------------------------------------------------
 338:     -	01B3          	dskrd1:
 339: 1973+7	01B3  3E02    			LD	A, 2
 340: 1980+13	01B5  32D00B  			LD	(direct), A				;clear direct
 341:				
 342: 1993+16	01B8  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2, test if zero
 343: 2009+4	01BB  7D      			LD	A, L
 344: 2013+4	01BC  B4      			OR	H
 345: 2017+7+5	01BD  2806    			JR	Z, dskrd2				;if zero, use direct sector number
 346: 2024+17	01BF  CD1DFA  			CALL	SECTRAN					;else use original code, call SECTRAN
 347: 2041+10	01C2  C39BF9  			JP	SalyDISKRD2				;and procees
 348:				
 349:     -	01C5          	dskrd2:
 350: 2051+14	01C5  DD2198FF			LD	IX, DKIOCB
 351: 2065+19	01C9  DD360000			LD	(IX + DSKOP), TSTRDY
 352:				;		CALL	dumpdcb
 353: 2084+11	01CD  E5      			PUSH	HL
 354: 2095+17	01CE  CD0FF0  			CALL	DISKV
 355: 2112+10	01D1  E1      			POP	HL
 356:				
 357: 2122+17	01D2  CDE901  			CALL	sec2track				;compute sector, track, side from direct sector
 358: 2139+19	01D5  DD360001			LD	(IX + DSKOP), GETSEC
 359:				;		CALL	dumpdcb
 360: 2158+11	01D9  E5      			PUSH	HL
 361: 2169+17	01DA  CD9802  			CALL	dskreadfn				;CALL DISK I/O HANDLER
 362: 2186+10	01DD  E1      			POP	HL
 363:				
 364: 2196+13	01DE  3AA0FF  			LD	A, (DKIOCB+DSKSTS)
 365: 2209+17	01E1  CDE8F9  			CALL	SETSTAT					;call SETSTAT
 366: 2226+7	01E4  1600    			LD	D, 0					;no invert
 367: 2233+10	01E6  C36CF6  			JP	SENDBUFF				;jump SENDBUFF
 368:				
 369:				;--------------------------------------------------
 370:				;compute sector, track, side from direct sector
 371:				;--------------------------------------------------
 372:     -	01E9          	sec2track:
 373: 2243+4	01E9  AF      			XOR	A					;clear carry and a
 374: 2247+7	01EA  06FF    			LD	B, 0ffh					;also b
 375: 2254+16	01EC  2ACE0B  			LD	HL, (dsector)				;compute track and side numer
 376: 2270+10	01EF  111200  			LD	DE, 18					;18 secs per track
 377:     -	01F2          	sec2track1:             
 378: 2280+4	01F2  04      			INC	B					;b holds track-number
 379: 2284+15	01F3  ED52    			sbc	HL, DE
 380: 2299+7+5	01F5  30FB    			JR	NC, sec2track1				;subtract 18 as long carry clear
 381: 2306+4	01F7  7D      			LD	A, L
 382: 2310+7	01F8  C613    			ADD	19					;add 19 to get sector number + 1
 383: 2317+13	01FA  329BFF  			LD	(DKIOCB+DSKSEC), A
 384: 2330+8	01FD  CB38    			SRL	B					;divide track by two, (we have two sides)
 385: 2338+4	01FF  78      			LD	A, B
 386: 2342+13	0200  329AFF  			LD	(DKIOCB+DSKTRK), A
 387: 2355+4	0203  1F      			RRA						;shift-in side-number from previously lowest-bit
 388: 2359+7	0204  E680    			AND	080h					;mask out bit 0-6
 389: 2366+10	0206  2199FF  			LD	HL, DKIOCB+DSKDRV
 390: 2376+15	0209  CBBE    			RES	7, (HL)
 391: 2391+7	020B  B6      			OR	(HL)
 392: 2398+7	020C  77      			LD	(HL), A
 393:							
 394:				;		CALL	serhex
 395:				;		CALL	serspace
 396:				;		LD	A, 'S'
 397:				;		CALL	seroutfn
 398:				;		LD	A, (DKIOCB+DSKSEC)
 399:				;		CALL	serhex
 400:				;		CALL	serspace
 401:				;		LD	A, 'T'
 402:				;		CALL	seroutfn
 403:				;		LD	A, (DKIOCB+DSKTRK)
 404:				;		CALL	serhex
 405:				;		CALL	sercr
 406:							
 407: 2405+10	020D  210002  			LD	HL, 512
 408: 2415+16	0210  229EFF  			LD	(DKIOCB+DSKAUX), HL
 409: 2431+10	0213  2100C1  			LD	HL, IOBUFF
 410: 2441+16	0216  229CFF  			LD	(DKIOCB+DSKPTR), HL
 411: 2457+14	0219  DD2198FF			LD	IX, DKIOCB
 412: 2471+10	021D  C9      			RET     
 413:				
 414:				;--------------------------------------------------
 415:				; hook for setDirectSector if aux1/2 = 0
 416:				;--------------------------------------------------
 417: 2481+11	021E  E5      	dwrt:		PUSH	HL
 418: 2492+16	021F  22A9FF  			LD	(LOGSIZ),HL				;SAVE DATA BLOCK LENGTH
 419:				
 420: 2508+16	0222  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2
 421: 2524+4	0225  7D      			LD	A, L
 422: 2528+4	0226  B4      			OR	H
 423: 2532+7+5	0227  2804    			JR	Z, dwrta				;if zero, do special stuff
 424:				
 425: 2539+10	0229  E1      			POP	HL					;otherwise continue
 426: 2549+10	022A  C320F9  			JP	SalyDISKWRT2				;normal
 427:				
 428: 2559+17	022D  CD5BFC  	dwrta:		CALL	SENDACK
 429:				
 430: 2576+10	0230  21D00B  			LD	HL, direct				;direct
 431:				;		LD	A, (HL)
 432:				;		CALL	serhex
 433: 2586+11	0233  35      			DEC	(HL)
 434: 2597+7+5	0234  2813    			JR	Z, dwrtd				;first sector
 435: 2604+10	0236  FA5602  			JP	M, dwrtb				;second sector
 436:				
 437: 2614+7	0239  0640    			LD	B, 64
 438: 2621+8+5	023B  10FE    			DJNZ	$					;wait some time
 439:				
 440: 2629+16	023D  2A00C1  			LD	HL, (IOBUFF)				;save 2-byte sector number (0-xxxx)
 441: 2645+16	0240  22CE0B  			LD	(dsector), HL
 442:				
 443: 2661+10	0243  E1      	dwrtc:		POP	HL
 444: 2671+7	0244  3E43    			LD	A, 'C'
 445: 2678+10	0246  C368FC  			JP	SENDCHAR
 446:				
 447: 2688+10	0249  2100C1  	dwrtd:		LD	HL, IOBUFF
 448: 2698+10	024C  1102C3  			LD	DE, IOBUFF+LEN+2
 449: 2708+10	024F  010001  			LD	BC, 0100h				;rec first half
 450: 2718+16+5	0252  EDB0    			LDIR
 451: 2734+12	0254  18ED    			JR	dwrtc
 452:				
 453: 2746+10	0256  3602    	dwrtb:		LD	(HL), 2					;direct = 2
 454:				
 455: 2756+10	0258  210002  			LD	HL, 512					;LOGSIZ 512 bytes in this case
 456: 2766+16	025B  22A9FF  			LD	(LOGSIZ), HL
 457:							
 458: 2782+10	025E  2100C1  			LD	HL, IOBUFF
 459: 2792+10	0261  1100C2  			LD	DE, IOBUFF+0100h
 460: 2802+10	0264  010001  			LD	BC, 0100h
 461: 2812+16+5	0267  EDB0    			LDIR    
 462: 2828+10	0269  2102C3  			LD	HL, IOBUFF+LEN+2
 463: 2838+10	026C  1100C1  			LD	DE, IOBUFF
 464: 2848+10	026F  010001  			LD	BC, 0100h
 465: 2858+16+5	0272  EDB0    			LDIR
 466:				
 467: 2874+17	0274  CDE901  			CALL	sec2track
 468:				
 469: 2891+19	0277  DD360002			LD	(IX + DSKOP), PUTSEC
 470: 2910+17	027B  CD8002  			CALL	dskwrite
 471:				
 472: 2927+12	027E  18C3    			JR	dwrtc
 473:				;--------------------------------------------------
 474:				; dskwrite: write through sector
 475:				;--------------------------------------------------
 476:     -	0280          	dskwrite:
 477:				;		LD	A, 'W';
 478:				;		CALL	seroutfn
 479:				
 480:				;		JP	DISKV
 481:				
 482: 2939+17	0280  CD5403  			CALL	checktrack
 483: 2956+7+5	0283  2010    			JR	NZ, dskwrite1
 484:				
 485:				;		LD	HL, (LOGSIZ)
 486:				;		CALL	seraddr
 487:				
 488: 2963+17	0285  CD3703  			CALL	compbufadr
 489:				;		CALL	seraddr
 490:				
 491: 2980+4	0288  EB      			EX	DE, HL
 492: 2984+19	0289  DD6605  			LD	H, (IX + DSKPTR+1)
 493: 3003+19	028C  DD6E04  			LD	L, (IX + DSKPTR)
 494: 3022+20	028F  ED4BA9FF			LD	BC, (LOGSIZ)
 495:				
 496: 3042+16+5	0293  EDB0    			LDIR
 497:				
 498:     -	0295          	dskwrite1:
 499: 3058+10	0295  C30FF0  			JP	DISKV
 500:				
 501:				
 502:				;--------------------------------------------------
 503:				; dskreadfn: cache a track
 504:				;--------------------------------------------------
 505:     -	0298          	dskreadfn:
 506:				;		LD	A, 'R'
 507:				;		CALL	debug
 508:				
 509: 3068+17	0298  CD5403  			CALL	checktrack
 510: 3085+10	029B  CA1703  			JP	Z, match
 511:				; 		ld	a, 'N'
 512:				;		CALL	seroutfn
 513: 3095+20	029E  ED53D20B			LD	(drive), DE				;save new drive and track
 514: 3115+15	02A2  DDE5    			PUSH	IX					;save IX
 515:				
 516: 3130+15	02A4  DDE5    			PUSH	IX					;load HL with IX
 517: 3145+10	02A6  E1      			POP	HL
 518: 3155+10	02A7  11DE0B  			LD	DE, dcb
 519: 3165+10	02AA  010900  			LD	BC, 9
 520: 3175+16+5	02AD  EDB0    			LDIR						;copy dcb
 521:							
 522: 3191+14	02AF  DD21DE0B			LD	IX, dcb					;load IX with new dcb
 523:							
 524: 3205+13	02B3  3AE50B  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 525: 3218+7	02B6  FE02    			CP	2
 526: 3225+7+5	02B8  2020    			JR	NZ, readtrack2				;no MS-DOS disk
 527:				
 528:				
 529: 3232+10	02BA  210010  			LD	HL, TRKBUFFER
 530: 3242+10	02BD  010112  			LD	BC, 18 * 256 + 1			;b=18, c = 1
 531:				
 532:     -	02C0          	readtrack3:
 533: 3252+16	02C0  22E20B  			LD	(dcb + DSKPTR), HL
 534: 3268+19	02C3  DD7103  			LD	(IX + DSKSEC),	C
 535:				
 536:				;		CALL	dumpdcb
 537:				
 538: 3287+11	02C6  E5      			PUSH	HL
 539: 3298+11	02C7  C5      			PUSH	BC
 540: 3309+17	02C8  CD0FF0  			CALL	DISKV
 541: 3326+10	02CB  C1      			POP	BC
 542: 3336+10	02CC  E1      			POP	HL
 543:				;		CALL	dumpsec 
 544: 3346+13	02CD  3AE60B  			LD	A, (dcb + DSKSTS)			;error occured?
 545: 3359+4	02D0  B7      			OR	A
 546: 3363+7+5	02D1  2036    			JR	NZ, readtrack4				;yes
 547: 3370+4	02D3  24      			INC	H
 548: 3374+4	02D4  24      			INC	H
 549: 3378+4	02D5  0C      			INC	C
 550: 3382+8+5	02D6  10E8    			DJNZ	readtrack3
 551: 3390+12	02D8  183B    			JR	readtrack5
 552:				
 553:     -	02DA          	readtrack2:
 554: 3402+7	02DA  0600    			LD	B, 0					;compute skew-list from media type
 555: 3409+19	02DC  FD4E05  			LD	C, (IY + MEDIA)
 556: 3428+10	02DF  21D60B  			LD	HL, skewtab
 557: 3438+11	02E2  09      			ADD	HL, BC
 558: 3449+7	02E3  7E      			LD	A, (HL)
 559: 3456+6	02E4  23      			INC	HL
 560: 3462+7	02E5  66      			LD	H, (HL)
 561: 3469+4	02E6  6F      			LD	L, A
 562: 3473+19	02E7  FD4603  			LD	B, (IY + NSECS+1)
 563:				
 564:     -	02EA          	readtrack1:
 565: 3492+16	02EA  22D40B  			LD	(secptr), HL
 566:				
 567:     -	02ED          	readtrack:
 568: 3508+16	02ED  2AD40B  			LD	HL, (secptr)
 569: 3524+7	02F0  7E      			LD	A, (HL)
 570: 3531+13	02F1  32E10B  			LD	(dcb + DSKSEC), A
 571: 3544+6	02F4  23      			INC	HL
 572: 3550+16	02F5  22D40B  			LD	(secptr), HL
 573:				
 574: 3566+11	02F8  C5      			PUSH	BC
 575: 3577+17	02F9  CD3703  			CALL	compbufadr
 576: 3594+16	02FC  22E20B  			LD	(dcb + DSKPTR), HL
 577:				;		CALL	dumpdcb
 578: 3610+17	02FF  CD0FF0  			CALL	DISKV
 579: 3627+10	0302  C1      			POP	BC
 580:				
 581: 3637+13	0303  3AE60B  			LD	A, (dcb + DSKSTS)			;error occured?
 582: 3650+4	0306  B7      			OR	A
 583: 3654+7+5	0307  280A    			JR	Z, readtrack6				;no
 584:     -	0309          	readtrack4:             
 585: 3661+10	0309  21FFFF  			LD	HL, 0ffffh
 586: 3671+16	030C  22D20B  			LD	(drive), HL
 587: 3687+14	030F  DDE1    			POP	IX					;yes, store in original dcb
 588: 3701+12	0311  181E    			JR	match2
 589:     -	0313          	readtrack6:             
 590: 3713+8+5	0313  10D8    			DJNZ	readtrack
 591:     -	0315          	readtrack5:
 592: 3721+14	0315  DDE1    			POP	IX
 593:				
 594:     -	0317          	match:
 595:				;		ld	a, 'M'
 596:				;		CALL	seroutfn
 597:						
 598: 3735+17	0317  CD3703  			CALL	compbufadr
 599: 3752+19	031A  DD5605  			LD	D, (IX + DSKPTR+1)
 600: 3771+19	031D  DD5E04  			LD	E, (IX + DSKPTR)
 601: 3790+20	0320  ED4BA9FF			LD	BC, (LOGSIZ)
 602: 3810+13	0324  3AE50B  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 603: 3823+7	0327  FE02    			CP	2
 604: 3830+7+5	0329  2003    			JR	NZ, match1
 605: 3837+10	032B  010002  			LD	BC, 512
 606:     -	032E          	match1:
 607: 3847+16+5	032E  EDB0    			LDIR
 608:				
 609: 3863+4	0330  AF      			XOR	A
 610:     -	0331          	match2:
 611: 3867+19	0331  DD7708  			LD	(IX + DSKSTS), A
 612:				
 613:     -	0000          		IF	WD1772
 616:					ENDIF
 617: 3886+10	0334  C33CF0  			JP	ACTIVON
 618:				
 619:				
 620:				;--------------------------------------------------
 621:				; HL = TRKBUF + DSKSEC * (128/256/512)
 622:				;--------------------------------------------------
 623:     -	0337          	compbufadr:
 624: 3896+10	0337  210010  			LD	HL, TRKBUFFER
 625: 3906+19	033A  DD4603  			LD	B, (IX + DSKSEC)
 626: 3925+4	033D  05      			DEC	B
 627: 3929+7	033E  0E00    			LD	C, 0
 628: 3936+13	0340  3AE50B  			LD	A, (dcb + DSKAUX + 1)			;load seclen highbyte
 629: 3949+4	0343  B7      			OR	A
 630: 3953+7+5	0344  2808    			JR	Z, compbufadr2				;if zero, assume 128 bytes length
 631: 3960+7	0346  FE01    			CP	1
 632: 3967+7+5	0348  2808    			JR	Z, compbufadr1				;if 1, assume 256 bytes
 633: 3974+8	034A  CB20    			SLA	B					;512 bytes
 634: 3982+12	034C  1804    			JR	compbufadr1
 635:     -	034E          	compbufadr2:
 636: 3994+8	034E  CB38    			SRL	B					;128 bytes
 637: 4002+8	0350  CB19    			RR	C
 638:     -	0352          	compbufadr1:
 639: 4010+11	0352  09      			ADD	HL, BC
 640: 4021+10	0353  C9      			RET
 641:				
 642:     -	0354          	checktrack:
 643: 4031+16	0354  2AD20B  			LD	HL, (drive)				;load
 644: 4047+19	0357  DD5602  			LD	D, (IX + DSKTRK)			;high
 645: 4066+19	035A  DD5E01  			LD	E, (IX + DSKDRV)			;low
 646: 4085+4	035D  B7      			OR	A					;clear carry
 647: 4089+15	035E  ED52    			SBC	HL, DE
 648: 4104+10	0360  C9      			RET
 649:				;
 650:				;
 651:				;--------------------------------------------------
 652:				; get Pokeydivisor command '?'
 653:				;--------------------------------------------------
 654:				;
 655:				;
 656:     -	0361          	getspeed:
 657:				;		LD	A, '?'
 658:				;		CALL	seroutfn
 659:				
 660: 4114+17	0361  CD35FC  			CALL	DRVINDEX				;POINT IY TO DRIVE'S DATA AREA
 661: 4131+5+6	0364  D8      			RET	C					;EXIT IF NOT A DRIVE IN OUR BOX
 662:				
 663:				;		CALL	HASPARMS
 664:				;		RET	Z					;EXIT IF DISK PARAMS NOT KNOWN
 665:				
 666: 4136+17	0365  CD5BFC  			CALL	SENDACK					;SEND 'ACK' FOR COMMAND FRAME
 667:				
 668: 4153+10	0368  21FFC2  			LD	HL, IOBUFF+LEN-1
 669:				
 670:     -	0001          		IF NOHIGHSPEEDSIO <> 1
 671: 4163+7	036B  3E08    			LD	A, SIOFAST
 672: 4170+7	036D  77      			LD	(HL), A
 673:					ELSE
 675:					ENDIF	; HIGHSPEEDSIO
 676:				
 677: 4177+10	036E  114300  			LD	DE, 'C'
 678: 4187+10	0371  C36CF6  			JP	SENDBUFF				;SEND 'C' AND PARAMS DATA FRAME
 679:				
 680:				;
 681:				;
 682:     -	0000          		IF SALLYRS = 1
 782:					ENDIF
 783:				;
 784:				;
 785:				;
 786:				;--------------------------------------------------
 787:				; Disk read
 788:				;--------------------------------------------------
 789:				;
 790:				;
 791:				;
 792: 4197+17	0374  CD35FC  	diskreadfn:	call	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 793: 4214+5+6	0377  D8      			ret	C			;EXIT IF NOT A DRIVE IN OUR BOX
 794:					
 795: 4219+17	0378  CD5BFC  	diskreadfn2:	call	SENDACK			;SEND 'ACK' FOR COMMAND FRAME
 796:						
 797: 4236+17	037B  CD0F07  			call	isspinning
 798: 4253+7+5	037E  3830    			jr	C, diskreadfn3
 799:								
 800: 4260+17	0380  CD9C05  			call	diskanalyse
 801: 4277+7+5	0383  382B    			jr	C, diskreadfn3
 802:							
 803: 4284+17	0385  CDF206  			call	checkmaxsec		;check if sio sector > max sector
 804: 4301+7+5	0388  3826    			jr	C, diskreadfn3		;no carry, ok
 805:				
 806: 4308+17	038A  CDF007  			call	sec2trk			;compute head / track / sec and seek
 807:				
 808: 4325+13	038D  3A2FFF  			ld	a, (OUTCPY)		;make head info as bit 7
 809: 4338+4	0390  17      			rla
 810: 4342+4	0391  17      			rla
 811: 4346+7	0392  E680    			and	10000000b
 812: 4353+19	0394  DDB601  			or	(IX + DSKDRV)
 813: 4372+4	0397  47      			ld	b, a
 814: 4376+19	0398  DD4E02  			ld	c, (IX + DSKTRK)	;BC = DRIVE/TRACK
 815:						
 816: 4395+16	039B  2AD20B  			ld	hl, (drive)
 817: 4411+15	039E  ED42    			sbc	hl, bc			;or above, carry clear!
 818: 4426+7+5	03A0  2806    			jr	z, trkmatch
 819:						
 820: 4433+17	03A2  CDBC03  			call	readtrk
 821: 4450+17	03A5  CD5705  			call	compdskbuf
 822:						
 823: 4467+17	03A8  CDF103  	trkmatch:	call	computesecbuf
 824:						
 825:				;		call	sercr
 826:				;		call	seraddr
 827:				;		call	serspace
 828:				;		ex	de, hl
 829:				;		call	seraddr
 830:				;		call	serspace
 831:				;		push	bc
 832:				;		pop	hl
 833:				;		call	seraddr
 834:				;		call	serspace
 835:						
 836: 4484+7	03AB  3E88    			ld	a, RDCMD
 837: 4491+17	03AD  CDA407  			call	diskop			;call diskio routine
 838:				
 839: 4508+17	03B0  CD7305  	diskreadfn3:	call	adjustsiobuf
 840: 4525+7	03B3  16FF    			ld	d, 0ffh			;invert data
 841: 4532+13	03B5  3AF10B  			ld	a, (siorc)
 842: 4545+4	03B8  5F      			ld	e, a
 843: 4549+10	03B9  C36CF6  			jp	SENDBUFF		;SEND 'C' AND PARAMS DATA FRAME	
 844:				
 845:				;
 846:				;
 847:				;
 848: 4559+10	03BC  C9      	readtrk:	ret
 849: 4569+17	03BD  CD9607  			call	readidam
 850:				
 851: 4586+17	03C0  CD0D04  			call	getskewtab
 852:				
 853: 4603+13	03C3  3AE90B  			ld	a, (idsector)
 854: 4616+19	03C6  FD4603  			ld	b, (IY + NSECS + 1)	;loop over #secs		
 855:				;		call	serhex
 856: 4635+7	03C9  BE      	readtrk1:	cp	(hl)
 857: 4642+7+5	03CA  2803    			jr	Z, readtrk2		;initial secnr found
 858: 4649+6	03CC  23      			inc	hl
 859: 4655+12	03CD  18FA    			jr	readtrk1
 860:						
 861: 4667+6	03CF  23      	readtrk2:	inc	hl
 862: 4673+7	03D0  7E      			ld	a, (hl)
 863: 4680+4	03D1  B7      			or	a
 864: 4684+7+5	03D2  2004    			jr	NZ, readtrk3
 865: 4691+17	03D4  CD0D04  			call	getskewtab
 866: 4708+7	03D7  7E      			ld	a, (hl)
 867:				
 868: 4715+19	03D8  DD4E03  	readtrk3:	ld	c, (IX + DSKSEC)
 869: 4734+19	03DB  DD7703  			ld	(IX + DSKSEC), a
 870: 4753+11	03DE  C5      			push	bc
 871: 4764+11	03DF  E5      			push	hl
 872: 4775+17	03E0  CDF103  			call	computesecbuf
 873: 4792+17	03E3  CD2F0B  			call	seraddr
 874: 4809+17	03E6  CD1F0B  			call	serspace
 875: 4826+10	03E9  E1      			pop	hl
 876: 4836+10	03EA  C1      			pop	bc
 877: 4846+19	03EB  DD7103  			ld	(IX + DSKSEC), c
 878:				
 879: 4865+8+5	03EE  10DF    			djnz	readtrk2
 880:						
 881: 4873+10	03F0  C9      			ret
 882:				
 883:				
 884:     -	03F1          	computesecbuf:
 885: 4883+19	03F1  FD5606  			ld	d, (IY + SECLEN)	;hi
 886: 4902+19	03F4  FD5E07  			ld	e, (IY + SECLEN + 1)	;lo
 887: 4921+11	03F7  D5      			push	de
 888: 4932+19	03F8  DD4603  			ld	b, (IX + DSKSEC)	;sec to be read;
 889: 4951+10	03FB  210000  			ld	hl, 0
 890: 4961+11	03FE  19      	trkmatch1:	add	hl, de
 891: 4972+8+5	03FF  10FD    			djnz	trkmatch1		;compute start of sector
 892: 4980+4	0401  B7      			or	a
 893: 4984+15	0402  ED52    			sbc	hl, de
 894: 4999+10	0404  110010  			ld	de, TRKBUFFER
 895: 5009+11	0407  19      			add	hl, de
 896: 5020+10	0408  1100C2  			ld	de, IOBUFF+LEN-256
 897: 5030+10	040B  C1      			pop	bc
 898: 5040+10	040C  C9      			ret
 899:				
 900:     -	040D          	getskewtab:
 901: 5050+15	040D  FDE5    			push	iy
 902: 5065+10	040F  E1      			pop	hl
 903: 5075+10	0410  111400  			ld	de, PERSKEWTAB
 904: 5085+11	0413  19      			add	hl, de
 905: 5096+10	0414  C9      			ret
 906:				;
 907:				;
 908:				;
 909:				;--------------------------------------------------
 910:				; Disk write
 911:				;--------------------------------------------------
 912:				;
 913:				;
 914:				;
 915: 5106+17	0415  CD35FC  	diskwritefn:	call	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 916: 5123+5+6	0418  D8      			ret	C			;EXIT IF NOT A DRIVE IN OUR BOX
 917:									
 918: 5128+17	0419  CD5BFC  	diskwritefn2:	call	SENDACK			;SEND 'ACK' FOR COMMAND FRAME
 919:				
 920: 5145+17	041C  CDB9F6  			CALL	RECVBUFF		;ATTEMPT TO READ DATA FRAME FROM ATARI
 921: 5162+5+6	041F  C0      			RET	NZ
 922:				
 923: 5167+16	0420  229EFF  			LD	(DKIOCB + DSKAUX),HL	;SAVE DATA BLOCK LENGTH
 924: 5183+10	0423  118000  			LD	DE,128
 925: 5193+4	0426  B7      			OR	A
 926: 5197+15	0427  ED52    			SBC	HL,DE			;TEST FOR 128 BYTE FRAME
 927: 5212+7+5	0429  2804    			JR	Z,diskwritefn1
 928: 5219+4	042B  B7      			OR	A
 929: 5223+15	042C  ED52    			SBC	HL,DE			;TEST FOR 256 BYTE FRAME
 930: 5238+5+6	042E  C0      			RET	NZ		
 931:						
 932: 5243+17	042F  CD5BFC  	diskwritefn1:	call	SENDACK			;SEND 'ACK' IF BLOCKSIZE IS 128 OR 256
 933:							
 934: 5260+17	0432  CD0F07  			call	isspinning
 935: 5277+7+5	0435  3833    			jr	C, diskwritefn4
 936:						
 937: 5284+17	0437  CD9C05  			call	diskanalyse
 938: 5301+7+5	043A  382E    			jr	C, diskwritefn4
 939:						
 940: 5308+17	043C  CDF206  			call	checkmaxsec		;check if sio sector > max sector
 941: 5325+7+5	043F  3829    			jr	C, diskwritefn4		;no carry, ok
 942:						
 943: 5332+17	0441  CDF007  			call	sec2trk			;compute head / track / sec and seek
 944:				
 945: 5349+10	0444  2100C1  			ld	hl, IOBUFF
 946: 5359+16	0447  229CFF  			ld	(DKIOCB + DSKPTR), hl
 947:				
 948: 5375+19	044A  DD4606  			ld	b, (IX + DSKAUX)	;complement data frame, only up to 256 byte sectors
 949: 5394+7	044D  7E      	diskwritefn5:	ld	a, (hl)
 950: 5401+4	044E  2F      			cpl
 951: 5405+7	044F  77      			ld	(hl), a
 952: 5412+6	0450  23      			inc	hl
 953: 5418+8+5	0451  10FA    			djnz	diskwritefn5
 954:				
 955: 5426+19	0453  FD7E06  			ld	a, (IY + SECLEN)
 956: 5445+13	0456  329FFF  			ld	(DKIOCB + DSKAUX + 1), a
 957: 5458+19	0459  FD7E07  			ld	a, (IY + SECLEN + 1)
 958: 5477+13	045C  329EFF  			ld	(DKIOCB + DSKAUX), a
 959:				
 960: 5490+7	045F  3EA8    			ld	a, WRTCMD
 961: 5497+17	0461  CDA407  			call	diskop			;call diskio routine
 962: 5514+19	0464  FD7E0C  			ld	a, (IY + CMDSTS)
 963: 5533+17	0467  CD420B  			call	serhex
 964:						
 965: 5550+13	046A  3AF10B  	diskwritefn4:	ld	a, (siorc)
 966:				;		call	seroutfn
 967: 5563+4	046D  5F      			ld	e, a
 968: 5567+10	046E  C368FC  			jp	SENDCHAR		;SEND 'C' AND PARAMS DATA FRAME	
 969:				
 970:				
 971:				;
 972:				;
 973:				;	... DISK FORMAT COMMAND PROCESSOR ...
 974:				;
 975:     -	0471          	diskformat:
 976: 5577+17	0471  CD35FC  			CALL	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 977: 5594+5+6	0474  D8      			RET	C			;EXIT IF NOT A DRIVE IN OUR BOX
 978:										
 979: 5599+16	0475  2A4FFF  			LD	HL,(PCOUNT)             
 980: 5615+4	0478  7C      			LD	A,H                     
 981: 5619+4	0479  B5      			OR	L                       
 982: 5623+5+6	047A  C0      			RET	NZ			;REFUSE TO FORMAT IF SPOOLER ACTIVE
 983:										
 984: 5628+19	047B  FD7E00  			ld	a, (IY + NTRKS) 	;REFUSE TO FORMAT IF PARAMS NOT SET
 985: 5647+4	047E  B7      			or	a                       
 986: 5651+5+6	047F  C8      			ret	Z                       
 987:										
 988: 5656+17	0480  CD5BFC  			call	SENDACK                 
 989: 5673+17	0483  CDCBF3  			call	STOPTMR			;THEN KILL CTC3 TO STOP DISK TIMER
 990:										
 991: 5690+7	0486  3E43    			ld	a, 'C'
 992: 5697+13	0488  32F10B  			ld	(siorc), a
 993:				
 994: 5710+17	048B  CD1E05  			call	computeflags
 995:						
 996: 5727+13	048E  322FFF  			ld	(OUTCPY), a
 997: 5740+11	0491  D330    			out	(LATCH), a
 998: 5751+17	0493  CD420B  			call	serhex
 999:				
1000: 5768+11	0496  F5      			push	af
1001: 5779+17	0497  CD6507  			call	restoretrack
1002: 5796+10	049A  F1      			pop	af
1003:						
1004: 5806+11	049B  E5      			push	hl
1005:					
1006: 5817+16	049C  22C1FF  			ld	(SEQPTR), hl			;STORE POINTER FOR BAD SECTOR LIST
1007: 5833+10	049F  210100  			ld	hl , 1
1008: 5843+16	04A2  22BFFF  			ld	(SEQNUM), HL			;RESET BAD SECTOR COUNTER
1009: 5859+16	04A5  2A49FF  			ld	HL, (FMTPTR)			;pointer to formats
1010: 5875+10	04A8  11B6FF  			ld	DE, FMTSTUFF
1011: 5885+10	04AB  010700  			ld	BC, FMTLEN
1012: 5895+4	04AE  07      			rlca
1013: 5899+4	04AF  07      			rlca
1014: 5903+7	04B0  E603    			and	00000011B
1015: 5910+7+5	04B2  2804    			jr	Z, diskformat5
1016: 5917+11	04B4  09      	diskformat2:	add	HL,BC
1017: 5928+4	04B5  3D      			dec	A
1018: 5932+7+5	04B6  20FC    			jr	NZ, diskformat2			;INDEX TO PROPER PARAMS FOR DISK TYPE
1019:						
1020: 5939+13	04B8  3AEE0B  	diskformat5:	ld	a, (siocmd)			;check for medium density
1021: 5952+17	04BB  CD3D0B  			call	serhexspace
1022: 5969+7	04BE  FE22    			cp	'"'
1023: 5976+7+5	04C0  2016    			jr	NZ, diskformat1
1024: 5983+16	04C2  2A49FF  			ld	hl, (FMTPTR)
1025: 5999+11	04C5  09      			add	hl, bc
1026: 6010+11	04C6  09      			add	hl, bc
1027: 6021+11	04C7  09      			add	hl, bc
1028: 6032+11	04C8  09      			add	hl, bc
1029: 6043+13	04C9  3A2FFF  			ld	a, (OUTCPY)
1030: 6056+7	04CC  E63F    			and	00111111b
1031: 6063+7	04CE  F640    			or	01000000b
1032: 6070+13	04D0  322FFF  			ld	(OUTCPY), a
1033: 6083+19	04D3  FD770E  			ld	(IY + FLAGS), a
1034: 6102+11	04D6  D330    			out	(LATCH), a
1035:				;		ld	(IY + NSECS + 1), 26
1036:				
1037: 6113+17	04D8  CD2F0B  	diskformat1:	call	seraddr
1038: 6130+16+5	04DB  EDB0    			ldir					;THEN COPY PARAMS TO 'FMTSTUFF'
1039: 6146+13	04DD  3AA0FF  			ld	A,(DKIOCB+DSKSTS)
1040: 6159+7	04E0  E6C0    			and	11000000B
1041: 6166+7+5	04E2  2017    			jr	NZ, diskformat6			;ERROR IF NOT READY OR WRITE PROTECTED
1042:					
1043: 6173+19	04E4  FD7E04  			ld	a,(iy+nsides)			;set for SS/DS init
1044: 6192+13	04E7  32BDFF  			ld	(sides),a
1045: 6205+19	04EA  FD7E00  			ld	a,(iy+ntrks)			;set for number of tracks
1046: 6224+13	04ED  32BEFF  			ld	(tracks),a
1047: 6237+15	04F0  FDE5    			push	IY
1048: 6252+15	04F2  DDE5    			push	IX
1049: 6267+17	04F4  CDD0FC  			call	FORMAT				;CALL FORMAT SUBROUTINE
1050: 6284+14	04F7  DDE1    			pop	IX
1051: 6298+14	04F9  FDE1    			pop	IY
1052:				
1053:				
1054: 6312+8	04FB  CBBF    	diskformat6:	res	7, a
1055: 6320+11	04FD  F5      			push	af
1056: 6331+7	04FE  3E3A    			ld	a, ':'
1057: 6338+17	0500  CD5B0B  			call	seroutfn
1058: 6355+10	0503  F1      			pop	af
1059: 6365+17	0504  CD420B  			call	serhex
1060: 6382+17	0507  CDE8F9  			CALL	SETSTAT				;UPDATE STATUS AS SPECIFIED BY ACC
1061:						
1062: 6399+19	050A  FD360E00			ld	(IY + FLAGS), 0
1063:				;		call	serinfn
1064: 6418+17	050E  CD9C05  			call	diskanalyse			;compute maxsec
1065:				;		call	restoretrack
1066: 6435+17	0511  CDAE09  			call	dumppercom
1067:						
1068: 6452+10	0514  E1      			POP	HL
1069: 6462+7	0515  1600    			LD	D,0
1070: 6469+13	0517  3AF10B  			ld	a, (siorc)
1071: 6482+4	051A  5F      			ld	e, a
1072: 6486+10	051B  C36CF6  			jp	SENDBUFF			;SEND BAD SECTOR DATA FRAME
1073:				;		JP	ACTIVON		;THEN RESTART THE DISK TIMER
1074:					
1075:				;--------------------------------------------------
1076:				; computeflags
1077:				;--------------------------------------------------
1078: 6496+19	051E  FD361300	computeflags:	ld	(IY + PERSTEPRATE), STEPRATE0
1079: 6515+17	0522  CD0407  			call	getdrivelatch
1080: 6532+4	0525  47      			ld	b, a
1081:						
1082: 6536+10	0526  2100C2  			ld	hl, IOBUFF+LEN-256	;256 byte bad sector list
1083: 6546+20	0529  FDCB0556			bit	DENSTY, (IY + MEDIA)    
1084: 6566+7+5	052D  2014    			jr	nz, computeflags1         
1085: 6573+10	052F  2180C2  			ld	HL, IOBUFF+LEN-128	;128 byte bad sector list
1086: 6583+8	0532  CBF0    			set	6, b			;and no HD
1087: 6591+19	0534  FD361303			ld	(IY + PERSTEPRATE), STEPRATE3
1088: 6610+19	0538  FD7E03  			ld	a, (IY + NSECS + 1)
1089: 6629+7	053B  FE1A    			cp	26
1090: 6636+7+5	053D  2813    			jr	Z, computeflags4
1091: 6643+8	053F  CBF8    			set	7, b			;set single density (FM)
1092: 6651+12	0541  180F    			jr	computeflags4
1093:				;
1094:				; HD/DD selection
1095:				; number sector >= 26 and sector-size > 128 then hd
1096:				;
1097: 6663+20	0543  FDCB077E	computeflags1:	bit	7, (IY + SECLEN + 1)		;bit 7 - low byte (128) = 1?
1098: 6683+7+5	0547  2007    			jr	NZ, computeflags3		;probably medium density
1099: 6690+19	0549  FD7E03  			ld	a, (IY + NSECS + 1)
1100: 6709+7	054C  FE1A    			cp	26
1101: 6716+7+5	054E  3002    			jr	NC, computeflags4		;>= 26 HD
1102: 6723+8	0550  CBF0    	computeflags3:	set	6, b				;< 26 sectores, normal DD
1103: 6731+4	0552  78      	computeflags4:	ld	a, b
1104: 6735+19	0553  FD770E  			ld	(IY + FLAGS), a
1105: 6754+10	0556  C9      			ret
1106:				;--------------------------------------------------
1107:				; compdskbufbuf
1108:				; siorc default to 'C' - complete
1109:				; copy percom sector length to IX + DSKAUX
1110:				; computer start of serial buffer (IOBUF+LEN - seclen)
1111:				;--------------------------------------------------
1112:     -	0557          	compdskbuf:
1113: 6764+7	0557  3E43    			ld	a, 'C'
1114: 6771+13	0559  32F10B  			ld	(siorc), a
1115:				
1116: 6784+19	055C  FD6606  			ld	h, (IY + SECLEN)	;compute start of disk-data
1117: 6803+19	055F  FD6E07  			ld	l, (IY + SECLEN + 1)	;in transfer buffer
1118: 6822+16	0562  229EFF  			ld	(DKIOCB + DSKAUX), hl
1119: 6838+4	0565  EB      			ex	de, hl
1120: 6842+4	0566  B7      			or	a
1121: 6846+10	0567  2100C3  			ld	hl, IOBUFF+LEN
1122: 6856+15	056A  ED52    			sbc	hl, de
1123: 6871+16	056C  229CFF  			ld	(DKIOCB + DSKPTR), hl
1124: 6887+16	056F  22F20B  			ld	(siobuffer), hl
1125: 6903+10	0572  C9      			ret
1126:				
1127:				;--------------------------------------------------
1128:				; adjustsiobufbuf
1129:				; if sector < 4, copy data to IOBUF+LEN - 128
1130:				; return start of SIo buffer in HL
1131:				;--------------------------------------------------
1132:     -	0573          	adjustsiobuf:	
1133: 6913+19	0573  FD7E0E  			ld	a, (IY + FLAGS)
1134: 6932+4	0576  B7      			or	a
1135: 6936+7+5	0577  2006    			jr	NZ, adjustsiobuf1
1136: 6943+10	0579  2100C2  			ld	hl, IOBUFF+256
1137: 6953+4	057C  AF      			xor	a
1138: 6957+12	057D  1808    			jr 	adjustsiobuf2
1139:				
1140: 6969+16	057F  2A9CFF  	adjustsiobuf1:	ld	hl, (DKIOCB + DSKPTR)
1141: 6985+19	0582  DD7E06  			ld	a, (IX + DSKAUX)		;sectorlen < 256
1142: 7004+4	0585  B7      			or	a
1143: 7008+5+6	0586  C0      			ret	NZ				;yes, do nothing
1144:						
1145: 7013+13	0587  3AF00B  	adjustsiobuf2:	ld	a, (siosector + 1)		;hi-byte <> 0
1146: 7026+4	058A  B7      			or	a
1147: 7030+5+6	058B  C0      			ret	NZ				;yes, no nothing
1148:						
1149: 7035+13	058C  3AEF0B  			ld	a, (siosector)		
1150: 7048+7	058F  FE04    			cp	4
1151: 7055+5+6	0591  D0      			ret	NC				;>= 4
1152:				
1153: 7060+11	0592  E5      			push	hl
1154: 7071+10	0593  018000  			ld	bc, 128
1155: 7081+11	0596  09      			add	hl, bc
1156: 7092+4	0597  EB      			ex	de, hl				;de = hl+128
1157: 7096+10	0598  E1      			pop	hl				;hl = diskbuffer
1158: 7106+16+5	0599  EDB0    			ldir
1159:				
1160: 7122+10	059B  C9      			ret
1161:						
1162:				;--------------------------------------------------
1163:				; diskanalyse - compute PERCOM values
1164:				;--------------------------------------------------
1165: 7132+7	059C  3E43    	diskanalyse:	ld	a, 'C'
1166: 7139+13	059E  32F10B  			ld	(siorc), a
1167:						
1168: 7152+19	05A1  FD7E0E  			ld	a, (IY + FLAGS)			;check if percom empty
1169: 7171+13	05A4  322FFF  			ld	(OUTCPY), a			;set LATCH und OUTCPY
1170: 7184+11	05A7  D330    			out	(LATCH), a
1171: 7195+4	05A9  B7      			or	a
1172: 7199+5+6	05AA  C0      			ret	NZ				;no continue without disk analyse
1173:				
1174:						
1175: 7204+19	05AB  FD360504			ld	(IY + MEDIA), 4			;set DD (MFM)
1176: 7223+19	05AF  FD360F03			ld	(IY + PERCONFIG), 3		;set SIZE and DDHD
1177: 7242+19	05B3  FD360400			ld	(IY + NSIDES), 0
1178: 7261+19	05B7  FD361300			ld	(IY + PERSTEPRATE), STEPRATE0	;select 6ms/3ms
1179:						
1180: 7280+17	05BB  CD0407  			call	getdrivelatch
1181: 7297+19	05BE  FD770E  			ld	(IY + FLAGS), a	
1182: 7316+11	05C1  D330    			out	(LATCH), a
1183: 7327+13	05C3  322FFF  			ld	(OUTCPY), a
1184:				
1185: 7340+17	05C6  CD6507  			call	restoretrack
1186:				
1187: 7357+17	05C9  CD1907  			call	getperiod
1188: 7374+7+5	05CC  300C    			jr	NC, diskanalyse3		;if no period, error
1189:				
1190: 7381+7	05CE  3E2D    	diskanalyse2:	ld	a, '-'
1191: 7388+17	05D0  CD5B0B  			call	seroutfn
1192: 7405+19	05D3  FD360E00			ld	(IY + FLAGS), 0
1193: 7424+10	05D7  C34307  			jp	setsioerror
1194:						
1195: 7434+19	05DA  FD7E0E  	diskanalyse3:	ld	a, (IY + FLAGS)	
1196: 7453+11	05DD  D330    			out	(LATCH), a	
1197: 7464+17	05DF  CD2408  			call 	tryidam	
1198: 7481+7+5	05E2  2825    			jr	z, diskanalyse1	
1199:				
1200: 7488+20	05E4  FDCB0E76			bit 	6, (IY + FLAGS)			;DD already set?
1201: 7508+7+5	05E8  200E    			jr	nz, diskanalyse4		;yes	
1202: 7515+23	05EA  FDCB0EF6			set	6, (IY + FLAGS)			;switch back to DD
1203: 7538+23	05EE  FDCB0F86			res	DDHD, (IY + PERCONFIG)		;reset DDHD
1204: 7561+19	05F2  FD361303			ld	(IY + PERSTEPRATE), STEPRATE3	;set to 3ms in DD mode
1205: 7580+12	05F6  18E2    			jr	diskanalyse3	
1206:							
1207: 7592+20	05F8  FDCB0E7E	diskanalyse4:	bit 	7, (IY + FLAGS)			;FM already set?
1208: 7612+10	05FC  C2CE05  			jp	nz, diskanalyse2		;bail out with C set
1209: 7622+23	05FF  FDCB0EFE			set	7, (IY + FLAGS)			;set FM
1210: 7645+23	0603  FDCB0596			res	DENSTY, (IY + MEDIA)		;reset DENSTY (FM/MFM)
1211: 7668+12	0607  18D1    			jr	diskanalyse3	
1212:				
1213:				;
1214:				; arrive here if IDAM has been found
1215:				; check for track 41 to be readable
1216:				;
1217: 7680+7	0609  3E28    	diskanalyse1:	ld	a, 40				;check for track 41
1218: 7687+19	060B  FD7700  			ld	(IY + NTRKS), a
1219: 7706+19	060E  DD7702  			ld	(IX + DSKTRK), a
1220: 7725+17	0611  CD4A07  			call	seektrack
1221: 7742+17	0614  CD2408  			call 	tryidam
1222: 7759+7+5	0617  202D    			jr	nz, diskanalyse8
1223:				;
1224:				; track 41 was readable, check if ID holds also track 41
1225:				; if not is was a 40 TRK drive and the head hit the bottom
1226:				;
1227: 7766+13	0619  3AE70B  			ld	a, (idtrack)
1228: 7779+19	061C  FDBE00  			cp	(IY + NTRKS)
1229: 7798+7+5	061F  2025    			jr	nz, diskanalyse8
1230:						
1231:				;
1232:				; now check for track 77
1233:				;
1234: 7805+7	0621  3E4D    			ld	a, 77
1235: 7812+19	0623  FD7700  			ld	(IY + NTRKS), a			;assume at least 77 tracks
1236: 7831+19	0626  DD7702  			ld	(IX + DSKTRK), a
1237: 7850+17	0629  CD4A07  			call	seektrack
1238: 7867+17	062C  CD2408  			call 	tryidam
1239: 7884+7+5	062F  2015    			jr	nz, diskanalyse8
1240:				
1241: 7891+13	0631  3AE70B  			ld	a, (idtrack)
1242: 7904+19	0634  FDBE00  			cp	(IY + NTRKS)
1243: 7923+7+5	0637  200D    			jr	nz, diskanalyse8
1244:				
1245: 7930+13	0639  3AEA0B  			ld	a, (idseclen)			;check seclen
1246: 7943+7	063C  E603    			and	a, 3
1247: 7950+7	063E  FE01    			cp	1				;has to be a 256 byte sector
1248: 7957+7+5	0640  2004    			jr	nz, diskanalyse8
1249:						
1250: 7964+19	0642  FD360050			ld	(IY + NTRKS), 80
1251:						
1252: 7983+17	0646  CD6507  	diskanalyse8:	call	restoretrack			;restore and check other side
1253:					
1254: 8000+23	0649  FDCB0EEE			set	5, (IY + FLAGS)			;set side 1
1255: 8023+19	064D  FD7E0E  			ld	a, (IY + FLAGS)
1256: 8042+11	0650  D330    			out	(LATCH), a
1257: 8053+17	0652  CD2408  			call 	tryidam
1258: 8070+7+5	0655  2003    			jr	nz, diskanalyse6
1259:						
1260: 8077+23	0657  FD3404  			inc	(IY + NSIDES)
1261:				
1262: 8100+23	065A  FDCB0EAE	diskanalyse6:	res	5, (IY + FLAGS)			;set side 0
1263: 8123+19	065E  FD7E0E  			ld	a, (IY + FLAGS)
1264: 8142+11	0661  D330    			out	(LATCH), a
1265: 8153+13	0663  322FFF  			ld	(OUTCPY), a			;set LATCH und OUTCPY
1266:				
1267: 8166+17	0666  CDC606  			call	readskew
1268:				;		call 	tryidam				;read fresh IDAM (could be CRC error from above)	
1269:						
1270: 8183+13	0669  3AEA0B  			ld	a, (idseclen)			;compute sector length
1271: 8196+7	066C  E603    			and	3				;from IDAM field
1272: 8203+4	066E  3C      			inc	a
1273: 8207+10	066F  214000  			ld	hl, 64
1274: 8217+8	0672  CB25    	compseclen:	sla	l
1275: 8225+8	0674  CB14    			rl	h
1276: 8233+4	0676  3D      			dec	a
1277: 8237+7+5	0677  20F9    			jr	NZ, compseclen	
1278: 8244+19	0679  FD7406  			ld	(IY + SECLEN), h
1279: 8263+19	067C  FD7507  			ld	(IY + SECLEN + 1), l
1280:						
1281:				;		call	seraddr		
1282:				
1283: 8282+19	067F  FD360200			ld	(IY + NSECS), 0
1284: 8301+19	0683  FD360312			ld	(IY + NSECS + 1), 18
1285: 8320+20	0687  FDCB0E76			bit	6, (IY + FLAGS)			;HD mode, set to 26
1286: 8340+7+5	068B  280F    			jr	Z, diskanalyse10
1287: 8347+20	068D  FDCB0E7E			bit	7, (IY + FLAGS)			;MFM mode 
1288: 8367+7+5	0691  200D    			jr	NZ, diskanalyse5
1289: 8374+19	0693  FD7E06  			ld	a, (IY + SECLEN)		;and seclen < 256
1290: 8393+4	0696  B7      			or	a
1291: 8397+7+5	0697  2007    			jr	NZ, diskanalyse5 		;then set also to 26
1292: 8404+19	0699  FD7705  			ld	(IY + MEDIA), a
1293:				
1294: 8423+19	069C  FD36031A	diskanalyse10:	ld	(IY + NSECS + 1), 26
1295:						
1296: 8442+10	06A0  210000  	diskanalyse5:	ld	hl, 0				;compute PERcom MAXSEC
1297: 8452+19	06A3  FD4600  			ld	b, (IY + NTRKS)
1298: 8471+19	06A6  FD5602  			ld	d, (IY + NSECS)			;compute max sector
1299: 8490+19	06A9  FD5E03  			ld 	e, (IY + NSECS + 1)		;NSECS by NTRKS
1300: 8509+11	06AC  19      	diskanalyse7:	add	hl, de
1301: 8520+8+5	06AD  10FD    			djnz	diskanalyse7			;multiply
1302: 8528+20	06AF  FDCB0446			bit	0, (IY + NSIDES)
1303: 8548+7+5	06B3  2801    			jr	z, diskanalyse9
1304: 8555+11	06B5  29      			add	hl, hl				;double
1305: 8566+19	06B6  FD7511  	diskanalyse9:	ld	(IY + PERMAXSEC), l		;save as low/hi pair
1306: 8585+19	06B9  FD7412  			ld	(IY + PERMAXSEC + 1), h
1307:				
1308: 8604+7	06BC  3E43    			ld	a, 'C'
1309: 8611+13	06BE  32F10B  			ld	(siorc), a
1310: 8624+19	06C1  FD7E0E  			ld	a, (IY + FLAGS)			;return LATCH bytes
1311: 8643+4	06C4  B7      			or	a				;return carry clear
1312: 8647+10	06C5  C9      			ret
1313:				
1314:				;--------------------------------------------------
1315:				; readskew
1316:				;--------------------------------------------------
1317:     -	06C6          	readskew:
1318: 8657+15	06C6  FDE5    			push	iy
1319: 8672+10	06C8  E1      			pop	hl
1320: 8682+10	06C9  011400  			ld	bc, PERSKEWTAB
1321: 8692+11	06CC  09      			add	hl, bc
1322: 8703+7	06CD  0624    			ld	b, 36
1323: 8710+4	06CF  EB      			ex	de, hl
1324: 8714+11	06D0  D5      			push	de
1325:						
1326: 8725+11	06D1  C5      	readskew1:	push	bc
1327: 8736+11	06D2  D5      			push	de
1328: 8747+17	06D3  CD9607  			call	readidam
1329: 8764+10	06D6  D1      			pop	de
1330: 8774+10	06D7  C1      			pop	bc
1331:						
1332: 8784+10	06D8  E1      			pop	hl
1333: 8794+11	06D9  E5      			push	hl
1334: 8805+13	06DA  3AE90B  			ld	a, (idsector)
1335: 8818+11	06DD  E5      	readskew6:	push	hl
1336: 8829+4	06DE  B7      			or	a
1337: 8833+15	06DF  ED52    			sbc 	hl, de
1338: 8848+10	06E1  E1      			pop	hl
1339: 8858+7+5	06E2  2806    			jr	Z, readskew4				;store value if c = 0		
1340: 8865+7	06E4  BE      			cp	(hl)					;did we have this sector already?
1341: 8872+7+5	06E5  2807    			jr	Z, readskew5				;get out of loop
1342: 8879+6	06E7  23      			inc	hl
1343: 8885+12	06E8  18F3    			jr	readskew6
1344:						
1345: 8897+7	06EA  12      	readskew4:	ld	(de), a
1346: 8904+6	06EB  13      			inc	de
1347: 8910+8+5	06EC  10E3    			djnz	readskew1
1348:				
1349: 8918+4	06EE  AF      	readskew5:	xor	a
1350: 8922+7	06EF  12      			ld	(de), a
1351: 8929+10	06F0  E1      			pop	hl
1352:						
1353:				;		call	sercr
1354:				;		ld	b, 36
1355:				;readskew2:	ld	a, (hl)
1356:				;		or	a
1357:				;		ret	Z
1358:				;		call	serhexspace
1359:				;		inc	hl
1360:				;		djnz	readskew2
1361: 8939+10	06F1  C9      	readskew3:	ret
1362:						
1363:				;--------------------------------------------------
1364:				; checkmaxsec
1365:				; compare zero
1366:				; compare against max sector
1367:				;--------------------------------------------------
1368:     -	06F2          	checkmaxsec:
1369: 8949+16	06F2  2AEF0B  			ld	hl, (siosector)
1370: 8965+6	06F5  2B      			dec	hl
1371:						
1372: 8971+19	06F6  FD5612  			ld	d, (IY + PERMAXSEC + 1)		;siosec - maxsec
1373: 8990+19	06F9  FD5E11  			ld	e, (IY + PERMAXSEC)
1374: 9009+4	06FC  B7      			or	a
1375: 9013+15	06FD  ED52    			sbc	hl, de
1376: 9028+4	06FF  3F      			ccf
1377: 9032+5+6	0700  D0      			ret	NC
1378:				
1379: 9037+10	0701  C34307  			jp	setsioerror
1380:				
1381:     -	0000          		IF SALLYRS = 1
1421:					ENDIF
1422:				;
1423:								
1424:				;--------------------------------------------------
1425:				; getdrivelatch
1426:				;--------------------------------------------------
1427:     -	0704          	getdrivelatch:
1428: 9047+13	0704  3A99FF  			ld	a, (DKIOCB+DSKDRV)
1429: 9060+4	0707  3C      			inc	a
1430: 9064+4	0708  47      			ld	b, a
1431: 9068+4	0709  AF      			xor	a
1432: 9072+4	070A  37      			scf
1433: 9076+4	070B  17      	getdrivelatch1:	rla
1434: 9080+8+5	070C  10FD    			djnz	getdrivelatch1
1435: 9088+10	070E  C9      			ret
1436:				
1437:				;--------------------------------------------------
1438:				; isspinning
1439:				;--------------------------------------------------
1440: 9098+11	070F  DB40    	isspinning:	in	a, (STSREG)			;Motor on?
1441: 9109+7	0711  E680    			and	10000000b			;mask bit 7 and clear carry
1442: 9116+5+6	0713  C0      			ret	NZ				;yes
1443:						
1444: 9121+17	0714  CD0407  			call	getdrivelatch
1445: 9138+11	0717  D330    			out	(LATCH), a			;fall through to getperiod
1446:						
1447:				;--------------------------------------------------
1448:				; getperiod
1449:				;--------------------------------------------------
1450: 9149+10	0719  11B80B  	getperiod:	ld	de, 3000
1451:				
1452: 9159+6	071C  1B      	getperiod1:	dec	de				;get an Index within x iterations
1453: 9165+4	071D  7A      			ld	a, d
1454: 9169+4	071E  B3      			or	e
1455: 9173+7+5	071F  281C    			jr	z, getperiod4
1456: 9180+17	0721  CD7907  			call	getfdcstatus
1457: 9197+7+5	0724  3817    			jr	C, getperiod4			;no status at all
1458: 9204+8	0726  CB4F    			bit	1, a
1459: 9212+7+5	0728  28F2    			jr	z, getperiod1
1460:							
1461: 9219+7	072A  2600    			ld	h, 0
1462:						
1463: 9226+17	072C  CD7907  	getperiod2:	call	getfdcstatus
1464: 9243+8	072F  CB4F    			bit	1, a
1465: 9251+7+5	0731  20F9    			jr	nz, getperiod2
1466:				
1467: 9258+6	0733  23      	getperiod3:	inc	hl
1468: 9264+17	0734  CD7907  			call	getfdcstatus		
1469: 9281+8	0737  CB4F    			bit	1, a
1470: 9289+7+5	0739  28F8    			jr	z, getperiod3
1471:				
1472:				;		call	seraddr
1473: 9296+4	073B  B7      			or	a
1474: 9300+10	073C  C9      			ret
1475:						
1476:     -	073D          	getperiod4:	
1477: 9310+17	073D  CD37F2  			call	SalyResetFDC
1478:				
1479: 9327+4	0740  AF      			xor	a
1480: 9331+11	0741  D330    			out	(LATCH), a
1481:						
1482: 9342+7	0743  3E45    	setsioerror:	ld	a, 'E'
1483: 9349+13	0745  32F10B  			ld	(siorc), a
1484: 9362+4	0748  37      			scf
1485: 9366+10	0749  C9      			ret
1486:						
1487:				;--------------------------------------------------
1488:				; seektrack
1489:				;--------------------------------------------------
1490:     -	074A          	seektrack:
1491: 9376+19	074A  FD7E10  			ld	a, (IY + PERTRACK)		;populate track reg
1492: 9395+11	074D  D341    			out	(TRKREG), a			;from number stored
1493: 9406+19	074F  DD7E02  			ld	a, (IX + DSKTRK)		;seek to track
1494: 9425+11	0752  D343    			out	(DATREG), a			;into DATREG
1495: 9436+19	0754  FD7E13  			ld	a, (IY + PERSTEPRATE)
1496: 9455+7	0757  C610    			add	a, SKCMD	
1497: 9462+11	0759  D340    	seektrack1:	out	(CMDREG), a			;issue step command
1498: 9473+17	075B  CD8107  			call	waitstatus
1499: 9490+19	075E  DD7E02  			ld	a, (IX + DSKTRK)		;update registers
1500:				;		out	(TRKREG), a
1501: 9509+19	0761  FD7710  			ld	(IY + PERTRACK), a
1502: 9528+10	0764  C9      			ret
1503:						
1504:				;--------------------------------------------------
1505:				; restoretrack
1506:				;--------------------------------------------------
1507: 9538+19	0765  FD7E13  	restoretrack:	ld	a, (IY + PERSTEPRATE)
1508: 9557+7	0768  C600    			add	a, RSTCMD
1509: 9564+11	076A  D340    			out	(CMDREG), a
1510: 9575+17	076C  CD8107  			call	waitstatus
1511:						
1512: 9592+4	076F  AF      			xor	a
1513: 9596+19	0770  FD7710  			ld	(IY + PERTRACK), a
1514: 9615+19	0773  DD7702  			ld	(IX + DSKTRK), a
1515: 9634+11	0776  D341    			out	(TRKREG), a
1516: 9645+10	0778  C9      			ret
1517:				;--------------------------------------------------
1518:				; getfdcstatus
1519:				;--------------------------------------------------
1520: 9655+11	0779  DB41    	getfdcstatus:	in	a, (TRKREG)			
1521: 9666+11	077B  D343    			out	(DATREG), a
1522: 9677+7	077D  3E10    			ld	a, SKCMD
1523: 9684+11	077F  D340    			out	(CMDREG), a			
1524:						
1525:				;--------------------------------------------------
1526:				; waitstatus
1527:				;--------------------------------------------------
1528: 9695+10	0781  013075  	waitstatus:	ld	bc, 30000
1529:				
1530: 9705+7	0784  3E0E    	waitstatus1:	LD	A,14	
1531: 9712+4	0786  3D      			DEC	A
1532: 9716+7+5	0787  20FD    			JR	NZ,$-1	;DELAY 56 MICROSECONDS
1533:				
1534: 9723+11	0789  DB40    			in	a, (STSREG)
1535: 9734+4	078B  B7      			or	a
1536: 9738+8	078C  CB47    			bit	0, a
1537: 9746+5+6	078E  C8      			ret	z
1538:						
1539: 9751+6	078F  0B      			dec	bc
1540: 9757+4	0790  78      			ld	a, b
1541: 9761+4	0791  B1      			or	a, c
1542: 9765+7+5	0792  20F0    			jr	nz, waitstatus1
1543:						
1544: 9772+4	0794  37      			scf
1545: 9776+10	0795  C9      			ret
1546:						
1547:				;--------------------------------------------------
1548:				; read an IDAM
1549:				;--------------------------------------------------
1550: 9786+10	0796  210600  	readidam:	ld	hl, 6
1551: 9796+16	0799  229EFF  			ld	(DKIOCB + DSKAUX), hl
1552: 9812+10	079C  21E70B  			ld	hl, idambuf
1553: 9822+16	079F  229CFF  			ld	(DKIOCB + DSKPTR), hl
1554: 9838+7	07A2  3EC0    			ld	a, RIDCMD
1555:				;		call	diskop					;fall through
1556:				;		ret
1557:						
1558:				
1559:				;--------------------------------------------------
1560:				; general disk operation
1561:				;--------------------------------------------------
1562: 9845+13	07A4  32C5FF  	diskop:		ld	(CMDBYT), a
1563: 9858+10	07A7  21EDA2  			ld	hl, 0a2edh	;12 LOAD HL WITH 'INI' OPCODE
1564: 9868+8	07AA  CB6F    			bit	5, a		;check if write command
1565: 9876+7+5	07AC  2801    			jr	z, diskop1
1566: 9883+4	07AE  24      			inc	h		;change to outi
1567: 9887+16	07AF  226600  	diskop1		LD	(NMIVEC), hl
1568: 9903+10	07B2  216800  			LD	HL,NMIVEC+2	;12
1569: 9913+10	07B5  36C9    			LD	(HL),0C9H	;10 STORE 'RET' OPCODE AFTER INI/OUTI
1570:				
1571:				;		call	resetcmd
1572:						
1573:				;		call	dumpiocb
1574:						
1575: 9923+7	07B7  0E43    			ld	c, DATREG
1576: 9930+19	07B9  DD7E06  			ld	a, (IX + DSKAUX)
1577: 9949+4	07BC  47      			ld	b, a
1578: 9953+16	07BD  2A9CFF  			ld	hl, (DKIOCB + DSKPTR)
1579:						
1580: 9969+19	07C0  DD7E03  			ld	a, (IX + DSKSEC)
1581: 9988+11	07C3  D342    			out	(SECREG), a
1582:				
1583: 9999+13	07C5  3AC5FF  			ld	a, (CMDBYT)				
1584:10012+11	07C8  D340    			out	(CMDREG), a
1585:						
1586:10023+19	07CA  DD7E07  			ld	a, (IX + DSKAUX+1)
1587:10042+8	07CD  CB3F    			srl	a											;8
1588:10050+7+5	07CF  280D    			jr	Z,read256	;JUMP IF BLOCKSIZE <= 256 BYTES						;12
1589:10057+8	07D1  CB3F    			srl	a
1590:10065+7+5	07D3  2806    			jr	Z,read512	;JUMP IF BLOCKSIZE <= 512 BYTES
1591:				
1592:				;
1593:				; 16 uS time at 500khZ
1594:				;
1595:10072+4	07D5  76      	read1024:	halt
1596:10076+7+5	07D6  20FD    			jr	NZ, $-1
1597:10083+4	07D8  76      			halt
1598:10087+7+5	07D9  20FD    			jr	NZ, $-1
1599:10094+4	07DB  76      	read512:	halt
1600:10098+7+5	07DC  20FD    			jr	NZ, $-1
1601:10105+4	07DE  76      	read256:	halt
1602:10109+7+5	07DF  20FD    			jr	NZ, $-1
1603:10116+17	07E1  CD8107  			call	waitstatus	
1604:10133+11	07E4  DB40    			in	a, (STSREG)		
1605:10144+7	07E6  E67F    			and	01111111b
1606:10151+17	07E8  CDE8F9  			call	SETSTAT
1607:10168+4	07EB  7B      			ld	a, e
1608:10172+13	07EC  32F10B  			ld	(siorc), a
1609:10185+10	07EF  C9      			ret
1610:						
1611:				;--------------------------------------------------
1612:				; sec2trk
1613:				; compute IX + DSKSEC and IX + DSKTRK from siosector
1614:				;--------------------------------------------------
1615:10195+16	07F0  2AEF0B  	sec2trk:	ld	hl, (siosector)		;sector from SIO 
1616:10211+6	07F3  2B      			dec	hl			;minus 1	
1617:10217+4	07F4  AF      			xor	a			;track to zero
1618:10221+4	07F5  57      			ld	d, a
1619:10225+19	07F6  FD5E03  			ld	e, (IY + NSECS + 1)	;load DE with assumed sec per track
1620:						
1621:10244+4	07F9  B7      	sec2trk2:	or	a			;compute track number siosector / NSECS
1622:10248+15	07FA  ED52    			sbc	hl, de
1623:10263+7+5	07FC  3803    			jr	c, sec2trk1
1624:10270+4	07FE  3C      			inc	a
1625:10274+12	07FF  18F8    			jr	sec2trk2
1626:						
1627:10286+19	0801  DD7702  	sec2trk1:	ld	(IX + DSKTRK), a	;track to be read
1628:10305+19	0804  FDBE00  			cp	(IY + NTRKS)		;check if > NTRKS
1629:10324+7+5	0807  3810    			jr	C, sec2trk3
1630:10331+19	0809  FD9600  			sub	(IY + NTRKS)
1631:10350+19	080C  DD7702  			ld	(IX + DSKTRK), a
1632:10369+13	080F  3A2FFF  			ld	a, (OUTCPY)
1633:10382+8	0812  CBEF    			set	5, a			;set head 1
1634:10390+13	0814  322FFF  			ld	(OUTCPY), a
1635:10403+11	0817  D330    			out	(LATCH), a
1636:					
1637:10414+4	0819  7D      	sec2trk3:	ld	a, l
1638:10418+19	081A  FD8603  			add	a, (IY + NSECS + 1)	;add NSECS we have subtracted too much 
1639:10437+4	081D  3C      			inc 	a			;offset by 1
1640:10441+19	081E  DD7703  			ld	(IX + DSKSEC),a		;store in IOCB
1641:						
1642:10460+10	0821  C34A07  			jp	seektrack
1643:				
1644:				;--------------------------------------------------
1645:				; tryidam
1646:				;--------------------------------------------------
1647:10470+17	0824  CD9607  	tryidam:	call	readidam		;try to get an id in MFM / HD
1648:				
1649:10487+11	0827  DB40    			in	a, (STSREG)
1650:10498+7	0829  E61C    			and	00011100b
1651:						
1652:				;		push	af
1653:				;		push	af
1654:				;		ld	a, 'i'
1655:				;		call	seroutfn
1656:				;		pop	af
1657:				;		call	serhex
1658:				;		pop	af
1659:						
1660:10505+10	082B  C9      			ret
1661:					
1662:				;--------------------------------------------------
1663:				; cmdwaitfn
1664:				;--------------------------------------------------
1665:     -	082C          	cmdwaitfn:	;in	a, (STSREG)
1666:						;rla
1667:						;jr	c, cmdwaitfn1
1668:						;xor	a
1669:						;out	(LATCH), a
1670:						
1671:10515+13	082C  3A55FF  	cmdwaitfn1:	LD	A, (CMDFLG)
1672:10528+4	082F  B7      			OR	A					;SEE IF COMMAND FRAME HAS ARRIVED
1673:10532+5+6	0830  C8      			RET	Z					;EXIT IF NOTHING HAS HAPPENED
1674:				
1675:10537+17	0831  CDEF0A  			call	sercmd
1676:						
1677:10554+13	0834  3A55FF  			LD	A, (CMDFLG)
1678:10567+7	0837  FE01    			CP	1
1679:				
1680:10574+4	0839  F3      			DI						;ELSE RESET INTERRUPT AND START AGAIN
1681:10578+7	083A  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
1682:10585+11	083C  D380    			OUT	(CTC0), A				;PERFORM THE RESET
1683:10596+4	083E  FB      			EI
1684:				
1685:				;		JP	Z, CMDL4				;good cmd-frame
1686:												;fall through
1687:10600+7+5	083F  2003    			JR	NZ, togglebaud
1688:     -	0000          		IF SALLYRS = 2
1690:					ENDIF
1691:10607+10	0841  C3F3F7  			JP	CMDL4
1692:						
1693:				;--------------------------------------------------
1694:				; togglebaud
1695:				;--------------------------------------------------
1696:     -	0844          	togglebaud:
1697:10617+13	0844  3AD10B  			LD	A, (pokeydiv)
1698:10630+7	0847  FE28    			CP	SIONORMAL
1699:10637+7	0849  3E08    			LD	A, SIOFAST
1700:10644+7+5	084B  2802    			JR	Z, togglebaud1
1701:10651+7	084D  3E28    			LD	A, SIONORMAL
1702:     -	084F          	togglebaud1:
1703:10658+13	084F  32D10B  			LD	(pokeydiv), A
1704:				;		CALL	serhex
1705:10671+10	0852  C30EF8  			JP	CMDL5
1706:				
1707:				;--------------------------------------------------
1708:				; xmitbuffn
1709:				;--------------------------------------------------
1710:     -	0855          	xmitbuffn:
1711:10681+4	0855  F3      			DI
1712:10685+13	0856  3AD10B  			LD	A, (pokeydiv)				;is fast?
1713:10698+7	0859  FE28    			CP	SIONORMAL
1714:10705+7+5	085B  2006    			JR	NZ, xmitfast				;yes, jump
1715:10712+10	085D  0119F7  			LD	BC, STARBIT
1716:10722+10	0860  C388F6  			JP	SalyXMITBUF
1717:				
1718:				
1719:     -	0863          	xmitfast:
1720:10732+7	0863  3E07    			LD	A, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
1721:10739+11	0865  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
1722:10750+7	0867  3E01    			LD	A, 1					;TIME CONSTANT OF 1 - 4uS pulses (1/4Mhz)*16
1723:10757+11	0869  D381    			OUT	(CTC1), A
1724:				
1725:     -	086B          	xmitfast1:
1726:10768+7	086B  7E      			LD	A, (HL)					;7
1727:10775+6	086C  23      			INC	HL					;6
1728:10781+4	086D  AA      			XOR	D					;4
1729:10785+4	086E  4F      			LD	C, A					;4
1730:10789+4	086F  83      			ADD	A, E					;4
1731:10793+7	0870  CE00    			ADC	0					;7
1732:10800+4	0872  5F      			LD	E, A					;4
1733:10804+17	0873  CD8108  			CALL	fastsend				;17 send byte in c (53 T-States)
1734:10821+4	0876  7C      			LD	A, H					;4
1735:10825+7	0877  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
1736:10832+7+5	0879  38F0    			JR	C, xmitfast1				;12/7 loop if buffer end not reached
1737:				
1738:10839+7	087B  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
1739:10846+11	087D  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
1740:10857+4	087F  FB      			EI
1741:10861+10	0880  C9      			RET
1742:				
1743:     -	0881          	fastsend:
1744:10871+4	0881  AF      			XOR	A					;4
1745:10875+11	0882  D350    			OUT	(ATROUT), A				;11
1746:				
1747:10886+15	0884  DDE5    			PUSH	IX					;15
1748:10901+14	0886  DDE1    			POP	IX					;14
1749:10915+4	0888  79      			LD	A, C					;4
1750:10919+7	0889  0608    			LD	B, 8					;7
1751:10926+6	088B  03      			INC	BC					;6
1752:10932+4	088C  00      			NOP						;4
1753:				
1754:     -	088D          	fastsend1:
1755:10936+4	088D  00      			NOP						;4
1756:10940+7	088E  FE01    			CP	1					;7
1757:10947+11	0890  D350    			OUT	(ATROUT), A				;11
1758:10958+4	0892  0F      			RRCA						;4
1759:10962+15	0893  DDE5    			PUSH	IX					;15
1760:10977+14	0895  DDE1    			POP	IX					;14
1761:10991+8+5	0897  10F4    			DJNZ	fastsend1				;13 / 8
1762:				
1763:10999+9	0899  ED5F    			LD	A, r					;9
1764:11008+7	089B  3E01    			LD	A, 1					;7
1765:11015+11	089D  D350    			OUT	(ATROUT), A				;11
1766:								
1767:11026+10	089F  C9      			RET						;10
1768:						
1769:				
1770:				;--------------------------------------------------
1771:				; rxblck
1772:				;--------------------------------------------------
1773:     -	08A0          	rxblck:
1774:11036+13	08A0  3AD10B  			LD	A, (pokeydiv)				;is fast?
1775:11049+7	08A3  FE28    			CP	SIONORMAL
1776:11056+10	08A5  CAB108  			JP	Z, rxblck1
1777:				
1778:11066+17	08A8  CDBC08  			CALL	fastrecv				;yes, fast speed
1779:11083+7	08AB  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
1780:11090+11	08AD  D383    			OUT	(CTC3), A				;SOFWARE RESET CTC3
1781:11101+4	08AF  4A      			LD	C, D					;checksum in c
1782:11105+10	08B0  C9      			RET
1783:				
1784:     -	08B1          	rxblck1:
1785:11115+10	08B1  010000  			LD	BC, 0					;no, normal speed
1786:11125+10	08B4  C3DCF6  			JP	SalyRXBLOCK
1787:				
1788:				
1789:				;--------------------------------------------------
1790:				; set 4ms watchdog
1791:				;--------------------------------------------------
1792:     -	08B7          	irq4ms:
1793:11135+10	08B7  F1      			POP	AF					;pop irq-addr
1794:11145+4	08B8  B7      			OR	A					;clear carry
1795:     -	08B9          	irq4ms1:
1796:11149+4	08B9  FB      			EI
1797:11153+14	08BA  ED4D    			RETI
1798:				
1799:				;--------------------------------------------------
1800:				; SIO receive 57600 baud
1801:				;--------------------------------------------------
1802:     -	08BC          	fastrecv:
1803:11167+4	08BC  F3      			DI
1804:11171+10	08BD  01B708  			LD	BC, irq4ms
1805:11181+20	08C0  ED4316FF			LD	(CTCVEC+6),bc				;SET VECTOR TO irq4ms ROUTINE
1806:11201+10	08C4  018300  			LD	BC, CTC3				;CLEAR B, LOAD C WITH ADDRESS OF CTC3
1807:11211+10	08C7  11A700  			LD	DE, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
1808:11221+12	08CA  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
1809:11233+12	08CC  ED49    			OUT	(C), C					;TIME CONSTANT OF 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
1810:11245+4	08CE  FB      			EI
1811:				
1812:     -	08CF          	fastrecv1:              
1813:11249+11	08CF  DB70    			IN	A, (ATARI)				;11
1814:11260+4	08D1  17      			RLA						;4
1815:11264+10	08D2  DACF08  			JP	C, fastrecv1				;10	NEW BYTE IS COMING IF START BIT LOW
1816:												;14-25 / 7
1817:11274+4	08D5  7A      			LD	A, D					;4
1818:11278+4	08D6  80      			ADD	A, B					;4
1819:11282+7	08D7  CE00    			ADC	A, 0					;7 ACCUMULATE CHECKSUM ATARI STYLE
1820:11289+4	08D9  57      			LD	D, A					;4
1821:								
1822:11293+7	08DA  067F    			LD	B, 07fh					;7
1823:11300+12	08DC  1800    			jr	$+2					;10 = 50
1824:				;
1825:				; SERIAL->PARALLEL CONVERSION
1826:				; Pokey DIV 8 = 59114 / 59659 average 59400 baud equals about 68 T-states
1827:				;
1828:     -	08DE          	fastrecv2:
1829:11312+11	08DE  F5      			push	af					;11
1830:11323+10	08DF  F1      			pop	af					;10
1831:11333+12	08E0  ED78    			in	a, (c)					;12
1832:						
1833:11345+11	08E2  DB70    			IN	A, (ATARI)				;11 CYCLES
1834:11356+4	08E4  17      			RLA						; 4 CYCLES
1835:11360+8	08E5  CB18    			RR	B					; 8 CYCLES
1836:11368+7+5	08E7  38F5    			JR	C, fastrecv2				;12 = 69 / 65 cycles
1837:				
1838:11375+7	08E9  70      			LD	(HL), B					;7 THEN STORE IN MEMORY BUFFER @HL
1839:11382+6	08EA  23      			INC	HL					;6
1840:11388+4	08EB  7C      			LD	A, H					;4
1841:11392+7	08EC  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
1842:11399+4	08EE  3F      			CCF						;4
1843:11403+5+6	08EF  D8      			RET	C					;5 RETURN WITH CARRY SET IF BUFFER FILLED
1844:				
1845:11408+12	08F0  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
1846:11420+12	08F2  ED49    			OUT	(C), C					;12 COUNT MOD 256 - ACTUALLY C = 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
1847:				
1848:11432+10	08F4  C3CF08  			JP	fastrecv1				;10 = 82 
1849:				
1850:     -	0001          		if SALLYDEBUG = 1 
1851:				;--------------------------------------------------
1852:				; debug and dump rouines
1853:				;--------------------------------------------------
1854:				
1855:				
1856:				;--------------------------------------------------
1857:				; dump sector inverted
1858:				;--------------------------------------------------
1859:     -	08F7          	serdumpcpl:
1860:11442+11	08F7  E5      			PUSH	HL
1861:11453+11	08F8  F5      			PUSH	AF
1862:11464+11	08F9  C5      			PUSH	BC
1863:11475+11	08FA  D5      			PUSH	DE
1864:11486+7	08FB  16FF    			LD	D, 255
1865:11493+10	08FD  C30C0B  			JP	serdump1
1866:				
1867:				
1868:				;--------------------------------------------------
1869:				; dump DKIOCB
1870:				;--------------------------------------------------
1871:11503+13	0900  3AC5FF  	diskiodebug:	LD	a, (CMDBYT)
1872:11516+7	0903  FE80    			CP	080h
1873:11523+7+5	0905  201B    			JR	NZ, diskiodebug1
1874:						
1875:11530+17	0907  CD420B  			call	serhex
1876:11547+19	090A  DD7E02  			LD	A,(IX+DSKTRK)	
1877:11566+17	090D  CD420B  			CALL	serhex
1878:11583+19	0910  DD7E03  			LD	A,(IX+DSKSEC)	
1879:11602+17	0913  CD420B  			CALL	serhex
1880:				
1881:11619+11	0916  DB40    	dbgRWBUSY:	IN	A,(STSREG)
1882:11630+8	0918  CB47    			BIT	0,A
1883:11638+7+5	091A  20FA    			JR	NZ,dbgRWBUSY				;LOOP TILL 1797 BUSY BIT GOES AWAY
1884:11645+17	091C  CD420B  			CALL	serhex
1885:				
1886:11662+17	091F  CD270B  			CALL	sercr
1887:					
1888:11679+19	0922  DD7E03  	diskiodebug1:	LD	A,(IX+DSKSEC)
1889:11698+10	0925  C3F1F0  			JP	DISK4+3
1890:						
1891:				;--------------------------------------------------
1892:				; debug code for VR177x
1893:				; test 1 write/read TRKREG or SECREG 
1894:				;--------------------------------------------------
1895:11708+4	0928  F3      			DI
1896:						
1897:11712+17	0929  CD270B  			CALL	sercr	
1898:						
1899:11729+11	092C  DB40    			in	a, (STSREG)
1900:11740+17	092E  CD420B  			CALL	serhex
1901:11757+17	0931  CD270B  			CALL	sercr
1902:				
1903:11774+17	0934  CD7B0B  			call	serinfn
1904:						
1905:11791+7	0937  0600    			LD	b, 0 
1906:11798+4	0939  78      	dloop:		LD	a, b
1907:11802+17	093A  CD420B  			CALL	serhex
1908:11819+17	093D  CD1F0B  			CALL	serspace
1909:							
1910:11836+11	0940  D342    			out	(SECREG),a
1911:11847+7	0942  0E04    			LD	c, 4				;4*8 = 32uS
1912:11854+4	0944  0D      	dloop1:		DEC	c				;4
1913:11858+7+5	0945  20FD    			JR	nz, dloop1			;12 = 16 T-states = 4uS
1914:						
1915:11865+11	0947  DB42    			in	a,(SECREG)
1916:						
1917:11876+4	0949  B8      			CP	b
1918:11880+7+5	094A  2004    			JR	NZ, error
1919:11887+8+5	094C  10EB    			DJNZ	dloop
1920:11895+12	094E  18FE    	ok:		JR	ok
1921:						
1922:11907+7	0950  3E45    	error:		ld	a, 'E'
1923:11914+17	0952  CD5B0B  			CALL	seroutfn
1924:11931+12	0955  18FE    	error1:		JR	error1
1925:				
1926:				;--------------------------------------------------
1927:				; dump 512 bytes at HL
1928:				;--------------------------------------------------
1929:11943+11	0957  D5      	dumpsecinv	push	de
1930:11954+7	0958  16FF    			ld	d, 255
1931:11961+12	095A  1803    			jr	dumpsec1
1932:     -	095C          	dumpsec:
1933:11973+11	095C  D5      			push	de
1934:11984+7	095D  1600    			ld	d, 0
1935:						
1936:11991+11	095F  C5      	dumpsec1:	push	bc
1937:12002+11	0960  E5      			push	hl
1938:12013+17	0961  CD270B  			call	sercr
1939:12030+7	0964  0E10    			ld	c, 16
1940:						
1941:12037+17	0966  CD2F0B  	dumpline:	call	seraddr
1942:12054+7	0969  3E3A    			ld	a, ':'
1943:12061+17	096B  CD5B0B  			call	seroutfn
1944:						
1945:12078+7	096E  0610    			ld	b, 16
1946:12085+7	0970  7E      	dumpline1:	ld	a, (hl)
1947:12092+4	0971  AA      			xor	a, d
1948:12096+17	0972  CD3D0B  			call	serhexspace
1949:12113+4	0975  78      			ld	a, b
1950:12117+7	0976  FE09    			cp	9
1951:12124+7+5	0978  2003    			jr	NZ, dumpline5
1952:12131+17	097A  CD1F0B  			call	serspace
1953:12148+6	097D  23      	dumpline5:	inc	hl
1954:12154+8+5	097E  10F0    			djnz	dumpline1
1955:				
1956:12162+4	0980  7A      			ld	a, d
1957:12166+10	0981  11F0FF  			ld	de, -16				;subtract 16 from hl
1958:12176+11	0984  19      			add	hl, de
1959:12187+4	0985  57      			ld	d, a
1960:12191+7	0986  0610    			ld	b, 16
1961:12198+7	0988  3E7C    			ld	a, '|'
1962:12205+17	098A  CD5B0B  			call	seroutfn
1963:						
1964:12222+7	098D  7E      	dumpline2:	ld	a, (hl)
1965:12229+4	098E  AA      			xor	a, d
1966:12233+7	098F  FE20    			cp	32
1967:12240+7+5	0991  3804    			jr	C, dumpline3			;< 32
1968:12247+7	0993  FE7F    			cp	127				;< 127
1969:12254+7+5	0995  3802    			jr	C, dumpline4
1970:12261+7	0997  3E2E    	dumpline3:	ld	a, '.'		
1971:12268+17	0999  CD5B0B  	dumpline4:	call	seroutfn
1972:12285+6	099C  23      			inc	hl
1973:12291+8+5	099D  10EE    			djnz	dumpline2
1974:						
1975:12299+7	099F  3E7C    			ld	a, '|'
1976:12306+17	09A1  CD5B0B  			call	seroutfn
1977:12323+17	09A4  CD270B  			call	sercr			
1978:						
1979:12340+4	09A7  0D      			dec	c
1980:12344+7+5	09A8  20BC    			jr	NZ, dumpline
1981:						
1982:12351+10	09AA  E1      			pop	hl
1983:12361+10	09AB  C1      			pop	bc
1984:12371+10	09AC  D1      			pop	de
1985:12381+10	09AD  C9      			ret
1986:						
1987:				;--------------------------------------------------
1988:				; Dump Percom Block in IY
1989:				;--------------------------------------------------
1990:12391+11	09AE  F5      	dumppercom:	push	af
1991:12402+11	09AF  C5      			push	bc
1992:12413+11	09B0  D5      			push	de
1993:12424+11	09B1  E5      			push	hl
1994:						
1995:12435+15	09B2  FDE5    			push	iy
1996:12450+10	09B4  E1      			pop	hl
1997:						
1998:12460+17	09B5  CD270B  			call	sercr
1999:						
2000:12477+7	09B8  3E54    			ld	a, 'T'
2001:12484+17	09BA  CD5B0B  			call	seroutfn
2002:12501+7	09BD  7E      			ld	a, (hl)
2003:12508+17	09BE  CD3D0B  			call	serhexspace
2004:						
2005:12525+6	09C1  23      			inc	hl
2006:12531+7	09C2  3E73    			ld	a, 's'
2007:12538+17	09C4  CD5B0B  			call	seroutfn
2008:12555+7	09C7  7E      			ld	a, (hl)
2009:12562+17	09C8  CD3D0B  			call	serhexspace
2010:				
2011:12579+6	09CB  23      			inc	hl
2012:12585+7	09CC  3E53    			ld	a, 'S'
2013:12592+17	09CE  CD5B0B  			call	seroutfn
2014:12609+7	09D1  7E      			ld	a, (hl)
2015:12616+17	09D2  CD420B  			call	serhex
2016:12633+6	09D5  23      			inc	hl
2017:12639+7	09D6  7E      			ld	a, (hl)
2018:12646+17	09D7  CD3D0B  			call	serhexspace
2019:				
2020:12663+6	09DA  23      			inc	hl
2021:12669+7	09DB  3E48    			ld	a, 'H'
2022:12676+17	09DD  CD5B0B  			call	seroutfn
2023:12693+7	09E0  7E      			ld	a, (hl)
2024:12700+17	09E1  CD3D0B  			call	serhexspace
2025:				
2026:12717+6	09E4  23      			inc	hl
2027:12723+7	09E5  3E44    			ld	a, 'D'
2028:12730+17	09E7  CD5B0B  			call	seroutfn
2029:12747+7	09EA  7E      			ld	a, (hl)
2030:12754+17	09EB  CD3D0B  			call	serhexspace
2031:				
2032:12771+6	09EE  23      			inc	hl
2033:12777+7	09EF  3E4C    			ld	a, 'L'
2034:12784+17	09F1  CD5B0B  			call	seroutfn
2035:12801+7	09F4  7E      			ld	a, (hl)
2036:12808+17	09F5  CD420B  			call	serhex
2037:12825+6	09F8  23      			inc	hl
2038:12831+7	09F9  7E      			ld	a, (hl)
2039:12838+17	09FA  CD3D0B  			call	serhexspace
2040:						
2041:12855+6	09FD  23      			inc	hl
2042:12861+7	09FE  3E2D    			ld	a, '-'
2043:12868+17	0A00  CD5B0B  			call	seroutfn
2044:12885+7	0A03  7E      			ld	a, (hl)
2045:12892+17	0A04  CD3D0B  			call	serhexspace
2046:				
2047:12909+7	0A07  0603    			ld	b, 3
2048:12916+6	0A09  23      	dumppercom3:	inc	hl
2049:12922+7	0A0A  7E      			ld	a, (hl)
2050:12929+17	0A0B  CD3D0B  			call	serhexspace
2051:12946+8+5	0A0E  10F9    			djnz	dumppercom3
2052:12954+17	0A10  CD270B  			call	sercr
2053:				
2054:12971+15	0A13  FDE5    			push	iy
2055:12986+10	0A15  E1      			pop	hl
2056:12996+10	0A16  011100  			ld	bc, PERMAXSEC
2057:13006+11	0A19  09      			add	hl, bc
2058:13017+7	0A1A  7E      			ld	a, (hl)
2059:13024+6	0A1B  23      			inc	hl
2060:13030+11	0A1C  E5      			push	hl
2061:13041+7	0A1D  66      			ld	h, (hl)
2062:13048+6	0A1E  23      			inc	hl
2063:13054+4	0A1F  6F      			ld	l, a
2064:13058+7	0A20  3E4D    			ld	a, 'M'
2065:13065+17	0A22  CD5B0B  			call	seroutfn
2066:13082+17	0A25  CD2F0B  			call	seraddr
2067:								
2068:13099+17	0A28  CD270B  			call	sercr
2069:						
2070:13116+10	0A2B  E1      			pop	hl
2071:13126+6	0A2C  23      			inc	hl
2072:13132+6	0A2D  23      			inc	hl
2073:13138+7	0A2E  0624    			ld	b, 36
2074:						
2075:13145+7	0A30  7E      	dumppercom2:	ld	a, (hl)
2076:13152+4	0A31  B7      			or	a
2077:13156+7+5	0A32  2806    			jr	Z, dumppercom1
2078:13163+17	0A34  CD3D0B  			call 	serhexspace
2079:13180+6	0A37  23      			inc	hl
2080:13186+8+5	0A38  10F6    			djnz	dumppercom2
2081:						
2082:13194+17	0A3A  CD270B  	dumppercom1:	call	sercr
2083:13211+10	0A3D  E1      			pop	hl
2084:13221+10	0A3E  D1      			pop	de
2085:13231+10	0A3F  C1      			pop	bc
2086:13241+10	0A40  F1      			pop	af
2087:13251+10	0A41  C9      			ret
2088:						
2089:				;--------------------------------------------------
2090:				; Debug routine
2091:				;--------------------------------------------------
2092:13261+17	0A42  CD5B0B  	debugtrk:	CALL	seroutfn
2093:13278+19	0A45  DD7E01  			LD	A, (IX + DSKDRV)
2094:13297+17	0A48  CD420B  			CALL	serhex
2095:13314+7	0A4B  3E74    			LD	A, 't'
2096:13321+17	0A4D  CD5B0B  			CALL	seroutfn
2097:13338+19	0A50  DD7E02  			LD	A, (IX + DSKTRK)
2098:13357+17	0A53  CD420B  			CALL	serhex
2099:13374+7	0A56  3E73    			LD	A, 's'
2100:13381+17	0A58  CD5B0B  			CALL	seroutfn
2101:13398+19	0A5B  DD7E03  			LD	A, (IX + DSKSEC)
2102:13417+17	0A5E  CD420B  			CALL	serhex
2103:13434+19	0A61  DD7E05  			LD	A, (IX + DSKPTR+1)
2104:13453+17	0A64  CD420B  			CALL	serhex
2105:13470+19	0A67  DD7E04  			LD	A, (IX + DSKPTR)
2106:13489+17	0A6A  CD420B  			CALL	serhex
2107:13506+19	0A6D  DD7E07  			LD	A, (IX + DSKAUX+1)
2108:13525+17	0A70  CD420B  			CALL	serhex
2109:13542+19	0A73  DD7E06  			LD	A, (IX + DSKAUX)
2110:13561+17	0A76  CD420B  			CALL	serhex
2111:				
2112:13578+17	0A79  CD1F0B  			CALL	serspace
2113:13595+13	0A7C  3AFEC2  			LD	A, (CFRAME+3)
2114:13608+17	0A7F  CD420B  			CALL	serhex
2115:13625+13	0A82  3AFDC2  			LD	A, (CFRAME+2)
2116:13638+17	0A85  CD420B  			CALL	serhex
2117:13655+17	0A88  CD1F0B  			CALL	serspace
2118:13672+19	0A8B  FD7E03  			LD	A, (IY+NSECS+1)
2119:13691+17	0A8E  CD420B  			CALL	serhex
2120:13708+19	0A91  FD7E00  			LD	A, (IY+NTRKS)
2121:13727+17	0A94  CD420B  			CALL	serhex
2122:				
2123:13744+17	0A97  CD270B  			CALL	sercr
2124:13761+10	0A9A  C9      			RET
2125:				;--------------------------------------------------
2126:				; dump DKIOCB
2127:				;--------------------------------------------------
2128:     -	0A9B          	dumpiocb:
2129:13771+11	0A9B  F5      			PUSH	AF
2130:13782+11	0A9C  C5      			PUSH	BC
2131:13793+11	0A9D  E5      			PUSH	HL
2132:				
2133:13804+17	0A9E  CD270B  			call	sercr
2134:13821+7	0AA1  3E25    			ld	a, '%'
2135:13828+17	0AA3  CD5B0B  			call	seroutfn
2136:13845+13	0AA6  3AC5FF  			ld	a, (CMDBYT)
2137:13858+17	0AA9  CD3D0B  			call	serhexspace
2138:13875+7	0AAC  3E40    			ld	a, '@'
2139:13882+17	0AAE  CD5B0B  			call	seroutfn
2140:13899+16	0AB1  2A9CFF  			ld	hl, (DKIOCB + DSKPTR)
2141:13915+17	0AB4  CD2F0B  			call	seraddr
2142:13932+7	0AB7  3E23    			ld	a, '#'
2143:13939+17	0AB9  CD5B0B  			call	seroutfn
2144:13956+16	0ABC  2A9EFF  			ld	hl, (DKIOCB + DSKAUX)
2145:13972+17	0ABF  CD2F0B  			call	seraddr
2146:13989+7	0AC2  3E48    			ld	a, 'H'
2147:13996+17	0AC4  CD5B0B  			call	seroutfn
2148:14013+13	0AC7  3A2FFF  			ld	a, (OUTCPY)
2149:14026+4	0ACA  07      			rlca
2150:14030+4	0ACB  07      			rlca
2151:14034+4	0ACC  07      			rlca
2152:14038+7	0ACD  E601    			and	1
2153:14045+17	0ACF  CD3D0B  			call	serhexspace
2154:14062+7	0AD2  3E54    			ld	a, 'T'
2155:14069+17	0AD4  CD5B0B  			call	seroutfn
2156:14086+19	0AD7  DD7E02  			ld	a, (IX + DSKTRK)
2157:14105+17	0ADA  CD3D0B  			call 	serhexspace
2158:14122+7	0ADD  3E53    			ld	a, 'S'
2159:14129+17	0ADF  CD5B0B  			call	seroutfn
2160:14146+19	0AE2  DD7E03  			ld	a, (IX + DSKSEC)
2161:14165+17	0AE5  CD3D0B  			call 	serhexspace
2162:14182+17	0AE8  CD270B  			call	sercr
2163:				
2164:14199+10	0AEB  E1      			POP	HL
2165:14209+10	0AEC  C1      			POP	BC
2166:14219+10	0AED  F1      			POP	AF
2167:14229+10	0AEE  C9      			RET
2168:				
2169:				;--------------------------------------------------
2170:				; RS232 sercmd
2171:				;--------------------------------------------------
2172:     -	0AEF          	sercmd:
2173:14239+11	0AEF  E5      			PUSH	HL
2174:14250+10	0AF0  21FBC2  			LD	HL, CFRAME
2175:14260+17	0AF3  CD270B  			CALL	sercr
2176:14277+17	0AF6  CDFE0A  			call	serouthl
2177:14294+17	0AF9  CDFE0A  			call	serouthl		
2178:14311+12	0AFC  1809    			JR	serdump2
2179:						
2180:14323+7	0AFE  7E      	serouthl:	ld	a, (hl)
2181:14330+6	0AFF  23      			inc	hl
2182:14336+17	0B00  CD5B0B  			call	seroutfn
2183:14353+10	0B03  C31F0B  			jp	serspace
2184:				;--------------------------------------------------
2185:				; RS232 dump
2186:				;--------------------------------------------------
2187:     -	0B06          	serdump:
2188:14363+11	0B06  E5      			PUSH	HL
2189:     -	0B07          	serdump2:
2190:14374+11	0B07  F5      			PUSH	AF
2191:14385+11	0B08  C5      			PUSH	BC
2192:14396+11	0B09  D5      			PUSH	DE
2193:				
2194:14407+7	0B0A  1600    			LD	D, 0
2195:     -	0B0C          	serdump1:
2196:14414+7	0B0C  7E      			LD	A, (HL)
2197:14421+4	0B0D  AA      			XOR	D
2198:14425+17	0B0E  CD420B  			CALL	serhex
2199:14442+17	0B11  CD1F0B  			CALL	serspace
2200:14459+6	0B14  23      			INC	HL
2201:14465+4	0B15  7C      			LD	A, H
2202:14469+7	0B16  FEC3    			CP	A, 0c3h
2203:14476+7+5	0B18  38F2    			JR	C, serdump1
2204:				
2205:14483+10	0B1A  D1      			POP	DE
2206:14493+10	0B1B  C1      			POP	BC
2207:14503+10	0B1C  F1      			POP	AF
2208:14513+10	0B1D  E1      			POP	HL
2209:14523+10	0B1E  C9      			RET
2210:				
2211:				;--------------------------------------------------
2212:				; RS232 <space>
2213:				;--------------------------------------------------
2214:     -	0B1F          	serspace:
2215:14533+11	0B1F  F5      			PUSH	AF
2216:14544+7	0B20  3E20    			LD	A, ' '
2217:14551+17	0B22  CD5B0B  			CALL	seroutfn
2218:14568+10	0B25  F1      			POP	AF
2219:14578+10	0B26  C9      			RET
2220:				
2221:				;--------------------------------------------------
2222:				; RS232 <CR>
2223:				;--------------------------------------------------
2224:     -	0B27          	sercr:
2225:14588+11	0B27  F5      			PUSH	AF
2226:14599+7	0B28  3E0D    			LD	A, CR
2227:14606+17	0B2A  CD5B0B  			CALL	seroutfn
2228:14623+10	0B2D  F1      			POP	AF
2229:14633+10	0B2E  C9      			RET
2230:				
2231:				;--------------------------------------------------
2232:				; RS232 output HL in hex
2233:				;--------------------------------------------------
2234:14643+11	0B2F  F5      	seraddr:	push	af
2235:14654+4	0B30  7C      			ld	a, h
2236:14658+17	0B31  CD420B  			call	serhex
2237:14675+4	0B34  7D      			ld	a, l
2238:14679+17	0B35  CD420B  			call	serhex
2239:14696+17	0B38  CD1F0B  			call	serspace
2240:14713+10	0B3B  F1      			pop	af
2241:14723+10	0B3C  C9      			ret
2242:						
2243:				;--------------------------------------------------
2244:				; RS232 output A in hex and trailing space
2245:				;--------------------------------------------------
2246:14733+17	0B3D  CD420B  	serhexspace:	call	serhex
2247:14750+12	0B40  18DD    			jr	serspace
2248:						
2249:				;--------------------------------------------------
2250:				; RS232 output A in hex
2251:				;--------------------------------------------------
2252:     -	0B42          	serhex:
2253:14762+11	0B42  F5      			PUSH	AF
2254:14773+11	0B43  F5      			PUSH	AF
2255:14784+4	0B44  0F      			RRCA
2256:14788+4	0B45  0F      			RRCA
2257:14792+4	0B46  0F      			RRCA
2258:14796+4	0B47  0F      			RRCA
2259:14800+17	0B48  CD510B  			CALL	sernib
2260:14817+10	0B4B  F1      			POP	AF
2261:14827+17	0B4C  CD510B  			CALL	sernib
2262:14844+10	0B4F  F1      			POP	AF
2263:14854+10	0B50  C9      			RET
2264:				
2265:     -	0B51          	sernib:
2266:14864+7	0B51  E60F    			AND	0fh
2267:14871+7	0B53  C630    			ADD	'0'
2268:14878+7	0B55  FE3A    			CP	'9' + 1
2269:14885+7+5	0B57  3802    			JR	C, sernib1
2270:14892+7	0B59  C607    			ADD	7
2271:     -	0B5B          	sernib1:
2272:				;--------------------------------------------------
2273:				; RS232 out	208 T-States
2274:				;--------------------------------------------------
2275:     -	0B5B          	seroutfn:
2276:14899+11	0B5B  F5      			PUSH	AF
2277:14910+11	0B5C  C5      			PUSH	BC
2278:14921+4	0B5D  47      			LD	B, A
2279:14925+4	0B5E  AF      			XOR	A
2280:14929+4	0B5F  F3      			DI
2281:14933+11	0B60  D351    			OUT	(SEROUT), A				;startbit
2282:14944+17	0B62  CD920B  			CALL	time19600				;17
2283:					
2284:14961+4	0B65  78      			LD	A, B	
2285:14965+7	0B66  0608    			LD	B, 8					;7
2286:     -	0B68          	serout1:	
2287:14972+11	0B68  D351    			OUT	(SEROUT), A				;11
2288:14983+17	0B6A  CD920B  			CALL	time19600				;17
2289:15000+4	0B6D  0F      			RRCA						;4
2290:15004+8+5	0B6E  10F8    			DJNZ	serout1					;8
2291:15012+4	0B70  FB      			EI	
2292:				
2293:15016+7	0B71  3E01    			LD	A, 1					;7 stopbit
2294:15023+11	0B73  D351    			OUT	(SEROUT), A				;11
2295:15034+17	0B75  CD920B  			CALL	time19600				;17
2296:				
2297:15051+10	0B78  C1      			POP	BC
2298:15061+10	0B79  F1      			POP	AF
2299:15071+10	0B7A  C9      			RET
2300:				
2301:				
2302:				;--------------------------------------------------
2303:				; RS232 in	208 T-States
2304:				;--------------------------------------------------
2305:     -	0B7B          	serinfn:
2306:15081+11	0B7B  C5      			PUSH	BC
2307:     -	0B7C          	serin2:
2308:15092+11	0B7C  DB50    			IN	A, (SERIN)
2309:15103+4	0B7E  07      			RLCA
2310:15107+7+5	0B7F  38FB    			JR	C, serin2
2311:				
2312:15114+19	0B81  E3      			EX	(SP), HL				;19, 4.75uS
2313:15133+19	0B82  E3      			EX	(SP), HL				;19  9uS
2314:				
2315:15152+7	0B83  0680    			LD	B, 80h
2316:     -	0B85          	serin1:
2317:15159+17	0B85  CD920B  			CALL	time19600
2318:15176+11	0B88  DB50    			IN	A, (SERIN)
2319:15187+4	0B8A  07      			RLCA
2320:15191+8	0B8B  CB18    			RR	B
2321:15199+7+5	0B8D  30F6    			JR	NC, serin1
2322:				
2323:15206+4	0B8F  78      			LD	A, B
2324:15210+10	0B90  C1      			POP	BC
2325:15220+10	0B91  C9      			RET
2326:				
2327:     -	0B92          	time19600:
2328:15230+7	0B92  0E09    			LD	C, 9					;4
2329:     -	0B94          	time19600a:
2330:15237+4	0B94  0D      			DEC	C					;4
2331:15241+7+5	0B95  20FD    			JR	NZ, time19600a				;12/7
2332:15248+10	0B97  C9      			RET						;10
2333:				
2334:					ENDIF
2335:				ENDIF	; SALLYBUILD
2336:				
2337:     -	0000          	IF WD1772
2350:				ENDIF
2351:				
2352:				;--------------------------------------------------
2353:				; 11 times port:value
2354:				;--------------------------------------------------
2355:     -	0B98  5001    	INITAB:		DEFB	ATROUT,1				;SET ATART OUTPUT TO MARK STATE
2356:     -	0B9A  5101    			DEFB	SEROUT,1				;SET RS232 OUTPUT TO MARK STATE
2357:     -	0B9C  8003    			DEFB	CTC0, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
2358:     -	0B9E  8010    			DEFB	CTC0, low ctcvec			;SET CTC0 BASE INTERRUPT VECTOR
2359:     -	0BA0  8107    			DEFB	CTC1, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	;PUT CTC1 IN TIMER MODE + SET TIME CONSTANT
2360:     -	0BA2  8101    			DEFB	CTC1, 1					;CTC1 TIME CONSTANT (DIVIDE BY 1 - 6.5us)
2361:     -	0BA4  8203    			DEFB	CTC2, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC2
2362:     -	0BA6  8303    			DEFB	CTC3, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC3
2363:     -	0BA8  5701    			DEFB	CDMUX, 1				;SET MUX TO PASS ATARI DATA
2364:     -	0000          		IF WD1772
2367:					ELSE
2368:     -	0BAA  3000    			DEFB	LATCH,00000000B				;ZEROS TO DRIVE SELECT LATCH
2369:     -	0BAC  40D0    			DEFB	CMDREG,FINCMD				;FORCE DISK CONTROLLER INTERRUPT
2370:					ENDIF	;WD1772
2371:     -	0016          	ITBLEN		EQU	$-INITAB
2372:				;
2373:				;
2374:				;
2375:				;
2376:				;
2377:				;
2378:				
2379:     -	0000          		IF SALLYRS = 1
2468:					ENDIF
2469:					
2470:     -	0001          	IF SALLYBUILD
2471:				
2472:     -	0001          		IF SALLYRS = 0
2473:				;--------------------------------------------------
2474:				; variables and data structure
2475:				;--------------------------------------------------
2476:				;
2477:				; 32 bytes for dsktb
2478:				; 7 commands copied in from DISKTAB, 3x7=21
2479:				; 2 commands added '?' and 0xDD (setDirectSector)
2480:				;
2481:     -	0BAE  00000000	dsktb:		DW	0, 0, 0, 0, 0, 0, 0, 0
	              00000000
	              00000000
	              00000000
2482:     -	0BBE  00000000			DW	0, 0, 0, 0, 0, 0, 0, 0
	              00000000
	              00000000
	              00000000
2483:					ENDIF
2484:				;
2485:				; direct MSDOS sector for each drive
2486:				;
2487:     -	0BCE  0000    	dsector:	DB	0, 0
2488:     -	0BD0  00      	direct:		DB	0
2489:				
2490:     -	0BD1  28      	pokeydiv:	DB	SIONORMAL
2491:				
2492:     -	0BD2  FF      	drive:		DB	255
2493:     -	0BD3  FF      	thetrack:	DB	255
2494:     -	0BD4  0000    	secptr:		DW	0
2495:				
2496:     -	0BD6  68FE    	skewtab:	DW	SKEWSD
2497:     -	0BD8  DAFE    			DW	SKEW13
2498:     -	0BDA  7AFE    			DW	SKEWDD
2499:     -	0BDC  F4FE    			DW	SKEW17
2500:				
2501:     -	0BDE  00      	dcb:		DB	0					;DISK OPERATION CODE
2502:     -	0BDF  00      			DB	0					;DRIVE# (WITH SIDE# IN BIT 7)
2503:     -	0BE0  00      			DB	0					;TRACK#
2504:     -	0BE1  00      			DB	0					;SECTOR#
2505:     -	0BE2  0000    			DW	0					;READ/WRITE POINTER
2506:     -	0BE4  0000    			DW	0					;AUXILLIARY PARAMETERS (2 BYTES)
2507:     -	0BE6  00      			DB	0					;OPERATION COMPLETION STATUS
2508:				
2509:     -	0BE7          	idambuf:
2510:     -	0BE7  00      	idtrack:	db	0
2511:     -	0BE8  00      	idside:		db	0
2512:     -	0BE9  00      	idsector:	db	0
2513:     -	0BEA  00      	idseclen:	db	0
2514:     -	0BEB  0000    	idcrc:		dw	0
2515:				
2516:     -	0BED  00      	siounit:	db	0
2517:     -	0BEE  00      	siocmd:		db	0
2518:     -	0BEF  0000    	siosector:	dw	0
2519:				
2520:     -	0BF1  00      	siorc:		db	0
2521:     -	0BF2  0000    	siobuffer:	dw	0
2522:				
2523:     -	0BF4          	drivedata:
2524:				;
2525:				;
2526:				;	... DATA STRUCTURE FOR DRIVE PARAMETER BLOCKS ...
2527:				;
2528:				;NTRKS		EQU	0		;NUMBER OF TRACKS
2529:				;STEPRT		EQU	1		;STEP RATE
2530:				;NSECS		EQU	2		;SECTORS PER TRACK (HI/LOW)
2531:				;NSIDES		EQU	4		;NUMBER OF SIDES
2532:				;MEDIA		EQU	5		;MEDIA SIZE AND FORMAT BITS
2533:				;SECLEN		EQU	6		;SECTOR LENGTH (HI/LOW)
2534:				;DSKBITS	EQU	8		;MISC NAUGHTY BITS
2535:				;SPARE0		EQU	9
2536:				;SPARE1		EQU	10
2537:				;SPARE2		EQU	11
2538:				;	
2539:				;CMDSTS		EQU	12		;COMMAND STATUS
2540:				;HDWSTS		EQU	13		;HARDWARE STATUS
2541:				;	
2542:				;FLAGS		EQU	14		;FLAGS BYTE FOR DISK OPERATION
2543:				;SPARE3		EQU	15
2544:				
2545:     -	000F          	PERCONFIG	equ	SPARE3
2546:				
2547:     -	0010          	PERTRACK	equ 	16
2548:     -	0011          	PERMAXSEC	equ	17
2549:     -	0013          	PERSTEPRATE	equ	19
2550:     -	0014          	PERSKEWTAB	equ	20		;NSECS+1 bytes for sector skew
2551:				
2552:     -	0000          	DDHD		equ	0
2553:				
2554:     -	0CF4          			org	$ + 256
2555:						
2556:				
2557:						include	version.asm
**** ..\src\version.asm ****
   1:     -	0CF4  73616C6C	SVERSION DB "sally-1.0.5-11-g" 
	              792D312E
	              302E352D
	              31312D67
**** ..\src\SYSINIT.MAC ****
2558:						
2559:15258+4	0D04  F3      			di
2560:15262+10	0D05  210080  			ld	hl,08000h
2561:15272+10	0D08  110000  			ld	de,00000h
2562:15282+10	0D0B  010080  			ld	bc,08000h
2563:15292+16+5	0D0E  EDB0    			ldir
2564:15308+10	0D10  C31000  			jp	RAMTST
2565:				ENDIF	;SALLYBUILD
2566:				;
2567:				;
**** ..\src\ROM.MAC ****
  13:				;
  14:				;	PHASE TO RAM-RESIDENT PART OF PROGRAM
  15:				;
  16:     -	0D13          	MONCOPY	EQU	$
  17:     -	F000          		.PHASE	0F000H
  18:				;
  19:				;
  20:     -	F000          	MONITOR	EQU	$
  21:15318+10	F000  C31BF0  			JP	RESTART
  22:15328+10	F003  C3DEF3  			JP	MINIMON		;MONITOR WARM ENTRY POINT
  23:15338+10	F006  C335F6  	CSV:	JP	CONST		;CONSOLE STATUS
  24:15348+10	F009  C340F6  	CIV:	JP	CONIN		;CONSOLE INPUT
  25:15358+10	F00C  C350F6  	COV:	JP	CONOUT		;CONSOLE OUTPUT
  26:15368+10	F00F  C322F0  	DISKV:	JP	DISKDVR		;DISK HANDLER
  27:15378+10	F012  C3DCF4  	LISTV:	JP	CENTOUT		;PARALLEL PRINTER OUT
  28:15388+10	F015  C3EBF4  			JP	CENTRDY		;PARALLEL PRINTER STATUS
  29:15398+10	F018  C315F6  	RENEW:	JP	CINIT2		;CONSOLE PORT INITAILZATION
  30:				;
  31:     -	F01B          	RESTART:
  32:15408+4	F01B  F3      			DI
  33:15412+4	F01C  AF      			XOR	A
  34:15416+11	F01D  D352    			OUT	(BANKSW),A
  35:15427+10	F01F  C30000  			JP	0			;JUMP TO ROM
  36:				;
  37:				;
  38:				;
  39:					INCLUDE	DISKIO.MAC
**** ..\src\DISKIO.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	DISK I/O DRIVER FOR ATARI BOX.	18-FEB-82	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	EQUATES FOR DISK CONTROLLER PORTS AND COMMAND CODES
   9:				;
  10:     -	0040          	STSREG		EQU	WD179X+0	;STATUS REGISTER
  11:     -	0040          	CMDREG		EQU	WD179X+0	;COMMAND REGISTER
  12:     -	0041          	TRKREG		EQU	WD179X+1	;TRACK REGISTER
  13:     -	0042          	SECREG		EQU	WD179X+2	;SECTOR REGISTER
  14:     -	0043          	DATREG		EQU	WD179X+3	;DATA REGISTER
  15:				;
  16:				;	TYPE I COMMANDS LOW NIBBLE
  17:				;
  18:     -	0000          	STEPRATE0	EQU 0			;6ms,  3 ms if 179x and 2 MHz
  19:     -	0001          	STEPRATE1	EQU 1			;12ms, 6 ms if 179x and 2 MHz
  20:     -	0002          	STEPRATE2	EQU 2			;20ms, 10ms if 179x and 2 MHz, 2ms if WD1772
  21:     -	0003          	STEPRATE3	EQU 3			;30ms, 15ms if 179x and 2 MHz, 3ms if WD1772
  22:				;
  23:				;	TYPE I AND TYPE II COMMANDS LOW NIBBLE
  24:				;	1770/1772 only
  25:     -	0000          	SPINWAIT	EQU 00000000B		;1770/1772: Enable spin up sequence
  26:     -	0008          	NOWAITMTR	EQU 00001000B		;1770/1772: Disable spin up sequence
  27:				;
  28:				;	TYPE II COMMANDS LOW NIBBLE
  29:				;	(F1)
  30:     -	0002          	SIDECMP		EQU	00000010B	;1791/1793: Side Select Compare Enabled \ 1795/1797: Update SSO to 1 \ 1773: Enable Side Compare
  31:				;
  32:				;	(F2) - Read Sector and Write Sector commands only
  33:     -	0008          	SIDESEL		EQU	00001000B	;1791/1793/1773: Side Select Compare for Side 1 \ 1795/1797: Interpret Sector Len Field 00=128, 01=256, 10=512,  11=1024
  34:				;		EQU	00000000B	;1791/1793/1773: Side Select Compare for Side 0 \ 1795/1797: Interpret Sector Len Field 00=256, 01=512, 10=1024, 11=128
  35:				;
  36:				;	TYPE II AND TYPE III COMMANDS LOW NIBBLE
  37:				;
  38:     -	0004          	SETTLE		EQU	00000100B	;179x: Add 15ms delay (2MHz)
  39:     -	0002          	WRPCOMP		EQU	00000010B	;1770/1772/1773 Write Sector and Write Track commands only: Disable Write Precompensation
  40:				;
  41:				;
  42:     -	0000          		IF WD1772
  45:					ELSE
  46:     -	0008          	HLOAD		EQU	00001000B	; ATR 8000 original
  47:     -	0003          	STEPRATE	EQU	STEPRATE3	; ATR 8000 original - 15ms step rate
  48:					ENDIF
  49:				;
  50:				;
  51:     -	00C0          	RIDCMD		EQU	11000000B	;READ ID COMMAND
  52:     -	0000          		IF WD1772
  55:					ELSE
  56:     -	0088          	RDCMD		EQU	10000000B+HLOAD	;READ COMMAND
  57:     -	00A8          	WRTCMD		EQU	10100000B+HLOAD	;WRITE COMMAND
  58:					ENDIF
  59:     -	00D0          	FINCMD		EQU	11010000B	;FORCE INTERRUPT COMMAND
  60:     -	0010          	SKCMD		EQU	00010000B	;SEEK COMMAND
  61:     -	0000          	RSTCMD		EQU	00000000B	;RESTORE COMMAND
  62:     -	0060          	STEPOUT		EQU	01100000B	;STEP OUT COMMAND
  63:     -	0040          	STEPIN		EQU	01000000B	;STEP IN COMMAND
  64:     -	00E0          	RDTRK		EQU	11100000B	;READ TRACK COMMAND
  65:     -	00F0          	WRTRK		EQU	11110000B	;WRITE TRACK COMMAND
  66:     -	00E4          	RDTKDLY		EQU	RDTRK+100B	;WRITE TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  67:     -	00F4          	WRTKDLY		EQU	WRTRK+100B	;READ TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  68:				;
  69:				;
  70:				; Drive control LATCH (U24)
  71:				;
  72:     -	0001          	DRVSEL1		EQU	00000001B	; 1 = select drive 1
  73:     -	0002          	DRVSEL2		EQU	00000010B	; 1 = select drive 2
  74:     -	0004          	DRVSEL3		EQU	00000100B	; 1 = select drive 3
  75:     -	0008          	DRVSEL4		EQU	00001000B	; 1 = select drive 4
  76:     -	0010          	FDCRESET	EQU	00010000B	; 1 = Put FDC chip in reset, 0 = Release FDC chip from reset
  77:     -	0020          	FDCSIDE		EQU	00100000B	; Side select pin on floppy connector
  78:     -	0040          	FBS		EQU	01000000B	; 0 = B, 1 = S
  79:     -	0080          	FDENSITY	EQU	10000000B	; 0 = Double, 1 = Single
  80:				;
  81:				;
  82:				;
  83:     -	0066          	NMIVEC		EQU	0066H
  84:				;
  85:				;
  86:				;
  87:				;
  88:				;	... DATA STRUCTURE FOR DISK I/O CONTROL BLOCK ...
  89:				;
  90:     -	0000          	DSKOP		EQU	0		;DISK OPERATION CODE
  91:     -	0001          	DSKDRV		EQU	1		;DRIVE# (WITH SIDE# IN BIT 7)
  92:     -	0002          	DSKTRK		EQU	2		;TRACK#
  93:     -	0003          	DSKSEC		EQU	3		;SECTOR#
  94:     -	0004          	DSKPTR		EQU	4		;READ/WRITE POINTER
  95:     -	0006          	DSKAUX		EQU	6		;AUXILLIARY PARAMETERS (2 BYTES)
  96:     -	0008          	DSKSTS		EQU	8		;OPERATION COMPLETION STATUS
  97:				;
  98:				;
  99:				;	... DISK DRIVER OPERATION CODE DEFINITIONS ...
 100:				;
 101:     -	0000          	TSTRDY		EQU	0		;SELECT DRIVE AND TEST READY
 102:     -	0001          	GETSEC		EQU	1		;READ SECTOR
 103:     -	0002          	PUTSEC		EQU	2		;WRITE SECTOR
 104:     -	0003          	GETID		EQU	3		;READ ID MARK
 105:				;
 106:				;
 107:				;
 108:     -	F022          	DISKDVR:
 109:15437+17	F022  CDCBF3  		CALL	STOPTMR		;KILL DISK TIMER INTERRUPT FROM CTC3
 110:15454+19	F025  DD7E00  		LD	A,(IX+DSKOP)
 111:15473+4	F028  B7      		OR	A
 112:15477+7+5	F029  284D    		JR	Z,TESTDRV	;JUMP IF TEST READY OPERATION
 113:15484+7	F02B  0688    		LD	B,RDCMD
 114:15491+4	F02D  3D      		DEC	A
 115:15495+7+5	F02E  287B    		JR	Z,SETSSO	;JUMP IF DISK READ OPERATION
 116:15502+7	F030  06A8    		LD	B,WRTCMD
 117:15509+4	F032  3D      		DEC	A
 118:15513+7+5	F033  2876    		JR	Z,SETSSO	;JUMP IF DISK WRITE OPERATION
 119:15520+4	F035  3D      		DEC	A
 120:15524+7+5	F036  285F    		JR	Z,READID	;JUMP IF DISK ID READ OPERATION
 121:15531+19	F038  DD3608FF		LD	(IX+DSKSTS),255	;ELSE SET ALL ERROR BITS AND RETURN
 122:				
 123:     -	F03C          	ACTIVON:
 124:15550+4	F03C  F3      		DI
 125:15554+7	F03D  3EA7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 126:15561+11	F03F  D383    		OUT	(CTC3),A	;PUT CTC3 IN TIMER MODE, PRESCALE 256
 127:15572+4	F041  AF      		XOR	A			;TIME CONSTANT OF 0 WHICH MEANS 256
 128:15576+11	F042  D383    		OUT	(CTC3),A	;COUNT MOD 256
 129:15587+4	F044  3D      		DEC	A
 130:15591+13	F045  32C9FF  		LD	(DRVTMR),A	;STOP DRIVES AFTER 255 INTERRUPTS
 131:15604+10	F048  2150F0  		LD	HL,ACTIVTY
 132:15614+16	F04B  2216FF  		LD	(CTCVEC+6),HL	;SET VECTOR TO ACTIVITY-CHECK ROUTINE
 133:15630+4	F04E  FB      		EI
 134:15634+10	F04F  C9      		RET
 135:				;
 136:				;
 137:				;
 138:     -	F050          	ACTIVTY:
 139:15644+11	F050  F5      		PUSH	AF
 140:15655+13	F051  3AC9FF  		LD	A,(DRVTMR)
 141:15668+4	F054  3D      		DEC	A
 142:15672+13	F055  32C9FF  		LD	(DRVTMR),A
 143:15685+7+5	F058  200A    		JR	NZ,ACTV2	;EXIT IF 4 SECONDS NOT ELAPSED
 144:				
 145:15692+17	F05A  CD68F0  		call	shutdown
 146:15709+7	F05D  3E21    		LD	A, CTC_D7_INT_DIS + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D0_CONTROL
 147:15716+11	F05F  D383    		OUT	(CTC3),A	;RESET INTERRUPT BUT KEEP COUNTER GOING
 148:15727+13	F061  322EFF  		LD	(DRVOFF),A	;SET 'DRVOFF' FLAG TO NON-ZERO VALUE
 149:				
 150:15740+10	F064  F1      	ACTV2:	POP	AF
 151:15750+4	F065  FB      		EI
 152:15754+14	F066  ED4D    		RETI
 153:				;
 154:				;
 155:				;
 156:     -	F068          	shutdown:
 157:     -	0000          	IF WD1772
 160:				ELSE
 161:15768+11	F068  DB41    		IN	A,(TRKREG)
 162:15779+11	F06A  D343    		OUT	(DATREG),A
 163:15790+7	F06C  3E10    		LD	A,SKCMD
 164:15797+11	F06E  D340    		OUT	(CMDREG),A	;DUMMY SEEK TO UNLOAD THE HEADS
 165:15808+13	F070  3A2FFF  		LD	A,(OUTCPY)
 166:15821+7	F073  E6F0    		AND	11110000B	;DESELECT ALL 4 DRIVES
 167:				ENDIF
 168:15828+11	F075  D330    		OUT	(LATCH),A
 169:15839+10	F077  C9      		ret
 170:					
 171:				;
 172:				;
 173:				;
 174:				;
 175:				;
 176:				;	... DRIVE READY/STATUS TEST FUNCTION ...
 177:				;
 178:				;
 179:     -	F078          	TESTDRV:
 180:15849+17	F078  CD1AF1  		CALL	SELECT		;SELECT DRIVE FOR SPIN/STATUS CHECK	
 181:15866+8	F07B  CB7F    		BIT	7,A
 182:15874+7+5	F07D  2805    		JR	Z,TDRV2		;JUMP IF DRIVE READY INDICATED
 183:				
 184:15881+10	F07F  2130FF  		LD	HL,PERIOD	;ELSE SET PERIOD TO ZERO
 185:15891+10	F082  3600    		LD	(HL),0
 186:				
 187:15901+19	F084  DD7708  	TDRV2:	LD	(IX+DSKSTS),A	;RETURN TYPE 1 STATUS IN 'DSKSTS'
 188:15920+13	F087  3A2FFF  		LD	A,(OUTCPY)
 189:15933+19	F08A  DD7706  		LD	(IX+DSKAUX),A	;RETURN CONTROL BITS IN AUX BYTE #1
 190:15952+13	F08D  3A30FF  		LD	A,(PERIOD)
 191:15965+19	F090  DD7707  		LD	(IX+DSKAUX+1),A	;RETURN PERIOD IN AUX BYTE #2
 192:15984+17	F093  CD3CF0  		CALL	ACTIVON		;START DISK ACTIVITY MONITOR AGAIN
 193:16001+10	F096  C9      		RET
 194:				;
 195:				;
 196:				;
 197:				;	... READ ID MARK FUNCTION ...
 198:				;
 199:     -	F097          	READID:
 200:16011+19	F097  DD360606		LD	(IX+DSKAUX),6
 201:16030+19	F09B  DD360700		LD	(IX+DSKAUX+1),0
 202:16049+7	F09F  06C0    		LD	B,RIDCMD
 203:16056+17	F0A1  CDB3F0  		CALL	DISK		;READ 6 BYTE ID RECORD
 204:16073+13	F0A4  3A2FFF  		LD	A,(OUTCPY)
 205:16086+19	F0A7  DD7706  		LD	(IX+DSKAUX),A	;RETURN DRIVE CONTROL LATCH BYTE
 206:16105+10	F0AA  C9      		RET
 207:				;
 208:				;
 209:				;
 210:				;	... SECTOR READ/WRITE FUNCTION ...
 211:				;
 212:     -	F0AB          	SETSSO:
 213:     -	0001          	IF WD1772 <> 1
 214:16115+20	F0AB  DDCB017E		BIT	7,(IX+DSKDRV)	;TEST SIDE# BIT IN DRIVE PARAM
 215:16135+7+5	F0AF  2802    		JR	Z,DISK
 216:16142+8	F0B1  CBC8    		SET	1,B		;SET 'SSO' CONTROL BIT IN 1797 CMD
 217:				ENDIF
 218:     -	F0B3          	DISK:
 219:16150+4	F0B3  78      		LD	A, B
 220:16154+13	F0B4  32C5FF  		LD	(CMDBYT),A					;STORE 1797 COMMAND PASSED IN B
 221:16167+17	F0B7  CD1AF1  		CALL	SELECT						;SELECT DRIVE/SIDE FOR DISK OPERATION
 222:16184+8	F0BA  CB7F    		BIT	7,A
 223:16192+7+5	F0BC  2052    		JR	NZ,DISKX					;EXIT IF NOT READY
 224:16199+13	F0BE  3A2DFF  		LD	A,(TRACK)				
 225:16212+7	F0C1  FEFF    		CP	255				
 226:16219+7+5	F0C3  2805    		JR	Z,DISK2				
 227:16226+19	F0C5  DDBE02  		CP	(IX+DSKTRK)					;TEST IF ALREADY AT DESIRED TRACK
 228:16245+7+5	F0C8  2805    		JR	Z,DISK3						;SKIP SEEK PART IF SO
 229:								
 230:16252+17	F0CA  CDF8F1  	DISK2:	CALL	SEEKTRK						;GO LOOKING FOR TRACK# IN IOCB
 231:16269+7+5	F0CD  2041    		JR	NZ,DISKX					;EXIT IF HEAD POSITIONING ERROR
 232:				
 233:16276+13	F0CF  3A12FF  	DISK3:	LD	A,(CTCVEC+2)
 234:16289+4	F0D2  3C      		INC	A						;LOOP TILL TX CTC TURNS ITSELF OFF
 235:16293+7+5	F0D3  20FA    		JR	NZ,DISK3					;(INTERRUPT VECTOR LSB SET=FFH)
 236:     -	F0D5          	SalyDISK3:
 237:16300+4	F0D5  F3      		DI
 238:16304+7	F0D6  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL		; SOFTWARE RESET CTC0
 239:16311+11	F0D8  D380    		OUT	(CTC0),A					;DISABLE RX INTERRUPT FROM CTC0
 240:16322+7	F0DA  3E27    		LD	A, CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; SET PRESCALER TO 256 AND SOFTWARE RESET
 241:16329+11	F0DC  D382    		OUT	(CTC2),A					;DISABLE CTC2 AND ALSO INIT FOR CLOCK SOURCE FOR WATCHDOG TIMER
 242:16340+7	F0DE  3E3D    		LD	A,61						;SET TIME COUNTER TO 61, about 3.9ms
 243:16347+11	F0E0  D382    		OUT	(CTC2),A				
 244:16358+10	F0E2  21A8F3  		LD	HL,WATCHDOG					;STORE NEW CTC3 VECTOR FOR SAFETY
 245:16368+16	F0E5  2216FF  		LD	(CTCVEC+6),HL				
 246:								
 247:16384+13	F0E8  3A33FF  		LD	A,(RWMAX)				
 248:16397+13	F0EB  32C6FF  		LD	(RWTRY),A					;SET READ/WRITE RETRY COUNT
 249:16410+19	F0EE  DD7E03  	DISK4:	LD	A,(IX+DSKSEC)					;OUTPUT SECTOR NUMBER FOR READ/WRITE
 250:16429+11	F0F1  D342    		OUT	(SECREG),A				
 251:16440+19	F0F3  DD7E02  		LD	A,(IX+DSKTRK)				
 252:16459+11	F0F6  D341    		OUT	(TRKREG),A					;DITTO FOR TRACK NUMBER
 253:16470+13	F0F8  3AC5FF  		LD	A,(CMDBYT)				
 254:16483+11	F0FB  D340    		OUT	(CMDREG),A					;START 1791 WORKING ON W/R COMMAND
 255:16494+17	F0FD  CDB5F2  		CALL	RWDISK						;DO HALT/NMI DISK DATA TRANSFER
 256:     -	F100          	DISK4a:
 257:16511+7+5	F100  280E    		JR	Z,DISKX						;EXIT IF NO DISK ERRORS
 258:16518+11	F102  F5      		PUSH	AF				
 259:16529+17	F103  CD0EF3  		CALL	RECOVER						;DO READ/WRITE ERROR RECOVERY ROUTINE
 260:16546+10	F106  C1      		POP	BC				
 261:16556+7+5	F107  2006    		JR	NZ,DISK5					;SKIP RETRY IF IRRECOVERABLE ERROR
 262:16563+10	F109  21C6FF  		LD	HL,RWTRY				
 263:16573+11	F10C  35      		DEC	(HL)				
 264:16584+7+5	F10D  20DF    		JR	NZ,DISK4					;ELSE DECREMENT RETRY COUNT TILL=0
 265:16591+4	F10F  78      	DISK5:	LD	A,B						;THEN LOAD A WITH ERROR STATUS
 266:16595+19	F110  DD7708  	DISKX:	LD	(IX+DSKSTS),A					;SAVE COMPLETION STATUS CARRIED IN ACC
 267:16614+17	F113  CD18F0  		CALL	RENEW						;RESTART ATARI AND RS232 INTERRUPTS
 268:16631+17	F116  CD3CF0  		CALL	ACTIVON						;START DISK ACTIVITY TIMER
 269:16648+10	F119  C9      		RET
 270:				;
 271:				;
 272:				;
 273:				;	... SELECT DRIVE# PASSED @IX AND RETURN TYPE 1 STATUS ...
 274:				;
 275:     -	F11A          	SELECT:
 276:16658+19	F11A  DD7E01  		LD	A,(IX+DSKDRV)
 277:16677+8	F11D  CBBF    		RES	7,A		;CLEAR SIDE SELECT BIT FROM DRIVE#
 278:16685+7	F11F  FE04    		CP	4
 279:16692+7+5	F121  306B    		JR	NC,SELX		;EXIT IF INVALID DRIVE NUMBER
 280:				
 281:16699+7	F123  0600    		LD	B,0
 282:16706+4	F125  4F      		LD	C,A		;LOAD BC WITH NEW DRIVE# TO BE SELECTED
 283:16710+10	F126  212CFF  		LD	HL,UNIT
 284:16720+7	F129  96      		SUB	(HL)		;COMPARE NEW AND OLD SELECT CODES AND
 285:16727+11	F12A  F5      		PUSH	AF		; SAVE RESULT STATUS ON STACK
 286:16738+4	F12B  50      		LD	D,B
 287:16742+7	F12C  5E      		LD	E,(HL)		;LOAD DE WITH LAST SELECTED DRIVE#
 288:16749+7	F12D  71      		LD	(HL),C		;THEN STORE NEW UNIT# FROM C
 289:				
 290:16756+10	F12E  2120FF  		LD	HL,DRVTAB
 291:16766+11	F131  19      		ADD	HL,DE		;INDEX INTO TABLE BY CURRENT DRIVE#
 292:16777+13	F132  3A2DFF  		LD	A,(TRACK)
 293:16790+7	F135  77      		LD	(HL),A		;REMEMBER CURENT TRACK NUMBER
 294:16797+7	F136  1E04    		LD	E,4
 295:16804+11	F138  19      		ADD	HL,DE		;NOW INDEX TO CONTROL BYTE FOR UNIT
 296:16815+13	F139  3A2FFF  		LD	A,(OUTCPY)
 297:16828+7	F13C  77      		LD	(HL),A		;REMEMBER CURRENT DENSITY/TYPE
 298:				
 299:16835+10	F13D  2120FF  		LD	HL,DRVTAB
 300:16845+11	F140  09      		ADD	HL,BC		;INDEX INTO TABLE BY NEW DRIVE#
 301:16856+7	F141  7E      		LD	A,(HL)
 302:16863+13	F142  322DFF  		LD	(TRACK),A	;STORE CURRENT (ASSUMED) HEAD POSITION
 303:16876+11	F145  19      		ADD	HL,DE
 304:16887+10	F146  D1      		POP	DE		;POP UNIT# COMPARE RESULT INTO D
 305:16897+7	F147  7E      		LD	A,(HL)		;GET CURRENT SELECT/TYPE BITS FOR DRIVE
 306:16904+4	F148  B7      		OR	A
 307:16908+7+5	F149  201F    		JR	NZ,SEL5		;JUMP IF NOT AN INITIAL DRIVE SELECT
 308:				;
 309:				;	ARRIVE HERE ON INITIAL DRIVE SELECT
 310:				;
 311:16915+10	F14B  2198F1  		LD	HL,SELTAB
 312:16925+11	F14E  09      		ADD	HL,BC		;ELSE INDEX INTO TABLE OF SELECT BITS
 313:16936+7	F14F  7E      		LD	A,(HL)
 314:16943+11	F150  D330    		OUT	(LATCH),A	;OUTPUT NEW DRIVE SELECTS
 315:16954+11	F152  F5      		PUSH	AF
 316:16965+17	F153  CD9CF1  		CALL	SPIN		;NOW SPIN UP TO TEST READY
 317:16982+10	F156  C1      		POP	BC
 318:16992+7	F157  FEDE    		CP	222		;ERROR IF SLOWER THAN 222 MS
 319:16999+7+5	F159  3033    		JR	NC,SELX
 320:				
 321:17006+8	F15B  CBF0    		SET	6,B
 322:17014+7	F15D  FEB5    		CP	181		;MINI FLOPPY IF BETWEEN 222 AND 181 MS
 323:17021+7+5	F15F  3006    		JR	NC,SEL4
 324:				
 325:17028+8	F161  CBB0    		RES	6,B
 326:17036+7	F163  FE99    		CP	153		;BIG FLOPPY IF BETWEEN 181 AND 153 MS
 327:17043+7+5	F165  3827    		JR	C,SELX
 328:				
 329:17050+4	F167  78      	SEL4:	LD	A,B		;GET CONTROL BITS INTO A
 330:17054+7	F168  1600    		LD	D,0		;SET D=0 TO DISABLE HEAD LOAD DELAY
 331:				;
 332:				;	ARRIVE HERE WITH DENSITY/TYPE/SELECT BITS IN ACC
 333:				;	
 334:17061+8	F16A  CBAF    	SEL5:	RES	5,A		;RESET SIDE SELECT BIT UNCONDITIONALLY
 335:17069+20	F16C  DDCB017E		BIT	7,(IX+DSKDRV)
 336:17089+7+5	F170  2802    		JR	Z,SEL5A		;JUMP IF SELECTING SIDE# ZERO
 337:17096+8	F172  CBEF    		SET	5,A		;ELSE SET SIDE SELECT BIT IN ACC
 338:17104+11	F174  D330    	SEL5A:	OUT	(LATCH),A
 339:17115+13	F176  322FFF  		LD	(OUTCPY),A	;OUTPUT AND SAVE NEW PATTERN
 340:17128+4	F179  14      		INC	D
 341:17132+4	F17A  15      		DEC	D
 342:17136+10+7	F17B  C499F3  		CALL	NZ,HLDWAIT	;DO HEAD LOAD DELAY IF NEW DRIVE SELECT
 343:     -	0000          	IF WD1772
 348:				ENDIF
 349:     -	F17E          	SEL5B:
 350:				;	LD	a, 'F'
 351:				;	CALL	seroutfn
 352:17146+17	F17E  CD91F3  		CALL	FORCE
 353:17163+8	F181  CB6F    		BIT	5,A		;TEST 1797 HEAD-LOAD STATUS
 354:17171+5+6	F183  C0      		RET	NZ		;EXIT IF LOADED AND MOTORS ON
 355:				;	JR	SEL5B
 356:					
 357:17176+17	F184  CD9CF1  		CALL	SPIN		;ELSE LET THINGS SPIN A BIT
 358:17193+4	F187  B7      		OR	A		;TEST PERIOD AFTER RE-SPINUP
 359:17197+7+5	F188  2804    	KLUDGE:	JR	Z,SELX		;ERROR IF DISK REFUSES TO TURN
 360:					
 361:     -	0000          	IF WD1772
 363:				ELSE
 364:17204+17	F18A  CD91F3  		CALL	FORCE		;ELSE RETURN TYPE 1 STATUS THIS TIME
 365:17221+10	F18D  C9      		RET
 366:				ENDIF
 367:				;
 368:				;	ARRIVE HERE IF DRIVE CANNOT BE SELECTED AT ALL
 369:				;
 370:17231+4	F18E  AF      	SELX:	XOR	A		;TURN OFF EVERYTHING
 371:     -	0000          	IF WD1772
 376:				ELSE
 377:17235+11	F18F  D330    		OUT	(LATCH),A
 378:17246+13	F191  322FFF  		LD	(OUTCPY),A
 379:17259+7	F194  3E80    		LD	A,10000000B
 380:				ENDIF
 381:17266+4	F196  B7      		OR	A		;RETURN WITH NOT-READY ERROR
 382:17270+10	F197  C9      		RET
 383:				;
 384:				;
 385:				;
 386:				;
 387:				;
 388:     -	F198  01      	SELTAB:	DEFB	00000001B
 389:     -	F199  02      		DEFB	00000010B
 390:     -	F19A  04      		DEFB	00000100B
 391:     -	F19B  08      		DEFB	00001000B
 392:				;
 393:				;
 394:				;
 395:     -	F19C          	SPIN:
 396:     -	0000          	IF WD1772
 400:				ELSE
 401:17280+4	F19C  AF      		XOR	A
 402:17284+11	F19D  D356    		OUT	(INDXSET),A
 403:17295+4	F19F  3C      		INC	A
 404:17299+11	F1A0  D354    		OUT	(INDXCLR),A	;SET TO ENABLE NORMAL INDEX PULSES
 405:17310+11	F1A2  DB41    		IN	A,(TRKREG)
 406:17321+11	F1A4  D343    		OUT	(DATREG),A
 407:17332+7	F1A6  3E18    		LD	A,SKCMD+HLOAD
 408:17339+11	F1A8  D340    		OUT	(CMDREG),A	;DO DUMMY SEEK TO START THE MOTORS
 409:17350+17	F1AA  CDBAF3  		CALL	STARTMR		;THEN RE-PROGRAM CTC1 FOR TIMER
 410:17367+17	F1AD  CD91F3  		CALL	FORCE
 411:				ENDIF
 412:17384+4	F1B0  4F      		LD	C,A		;SAVE CURRENT TYPE 1 DISK STATUS
 413:17388+7	F1B1  0606    		LD	B,6		;SET FOR 6 DISK REVOLUTIONS
 414:17395+10	F1B3  210000  		LD	HL,0
 415:17405+16	F1B6  22C7FF  		LD	(TICKS),HL	;RESET MILLISECOND COUNTER FOR IRQ
 416:17421+20	F1B9  ED5BC7FF	SPIN2:	LD	DE,(TICKS)
 417:17441+17	F1BD  CDE3F1  		CALL	EDGE		;WAIT FOR INDEX INPUT TO CHANGE
 418:17458+7+5	F1C0  380D    		JR	C,SPIN3		;ABORT IF TIMEOUT
 419:17465+17	F1C2  CDE3F1  		CALL	EDGE		;WAIT FOR CHANGE BACK AGAIN
 420:17482+7+5	F1C5  3808    		JR	C,SPIN3
 421:17489+8+5	F1C7  10F0    		DJNZ	SPIN2		;LET 6 REVOLUTIONS PASS
 422:				
 423:17497+16	F1C9  2AC7FF  		LD	HL,(TICKS)	;READ TIME AT END OF REVOLUTION
 424:17513+4	F1CC  B7      		OR	A
 425:17517+15	F1CD  ED52    		SBC	HL,DE		;COMPUTE INDEX PERIOD IN MILLISECONDS
 426:				
 427:     -	0000          	IF WD1772
 434:				ELSE
 435:				
 436:17532+17	F1CF  CDCBF3  	SPIN3:	CALL	STOPTMR		;KILL INTERRUPT FROM CTC3
 437:17549+4	F1D2  AF      		XOR	A
 438:17553+11	F1D3  D354    		OUT	(INDXCLR),A
 439:17564+4	F1D5  3C      		INC	A
 440:17568+11	F1D6  D356    		OUT	(INDXSET),A	;DISABLE INDEX PULSES AFTER THIS
 441:				ENDIF
 442:				
 443:17579+4	F1D8  7D      		LD	A,L
 444:17583+4	F1D9  24      		INC	H
 445:17587+4	F1DA  25      		DEC	H
 446:17591+7+5	F1DB  2802    		JR	Z,SPIN4		;A HOLDS VALID PERIOD IF H=0
 447:17598+7	F1DD  3EFF    		LD	A,255
 448:17605+13	F1DF  3230FF  	SPIN4:	LD	(PERIOD),A
 449:17618+10	F1E2  C9      		RET
 450:				
 451:     -	0000          	IF WD1772
 454:				ENDIF
 455:				;
 456:				;
 457:				;
 458:     -	F1E3          	EDGE:
 459:     -	0000          	IF WD1772
 461:				ELSE
 462:17628+17	F1E3  CD91F3  		CALL	FORCE		;GET 1797 TYPE 1 STATUS
 463:				ENDIF
 464:17645+4	F1E6  A9      		XOR	C
 465:17649+7	F1E7  E602    		AND	00000010B	;CHECK FOR CHANGE IN INDEX BIT
 466:17656+7+5	F1E9  2009    		JR	NZ,EDGE2	;EXIT IF BIT CHANGES
 467:				
 468:17663+13	F1EB  3AC8FF  		LD	A,(TICKS+1)
 469:17676+7	F1EE  FE08    		CP	HIGH 2048	;ELSE CHECK TIME ACCUMULATED IN 'TICKS'
 470:17683+7+5	F1F0  38F1    		JR	C,EDGE		;KEEP LOOPING TILL 2 SECONDS PASS
 471:				
 472:17690+4	F1F2  37      		SCF
 473:17694+10	F1F3  C9      		RET			;THEN RETURN WITH CARRY=1
 474:				;
 475:17704+4	F1F4  79      	EDGE2:	LD	A,C
 476:17708+4	F1F5  2F      		CPL			;FLIP INDEX STATE HELD IN C
 477:17712+4	F1F6  4F      		LD	C,A
 478:17716+10	F1F7  C9      		RET			;RETURN WITH CARRY=0
 479:				;
 480:				;
 481:				;
 482:				;
 483:				;	... SEEK TRACK# IN (IX+DSKTRK) FROM TRACK# IN (TRACK) ...
 484:				;
 485:     -	F1F8          	SEEKTRK:
 486:17726+13	F1F8  3A2DFF  		LD	A,(TRACK)
 487:17739+7	F1FB  FEFF    		CP	255
 488:17746+7+5	F1FD  2005    		JR	NZ,SEEK1	;JUMP IF HEAD POSITION IS KNOWN
 489:				
 490:17753+17	F1FF  CD37F2  		CALL	RESTORE		;ELSE DO SLOW RESTORE TO RECALIBRATE
 491:17770+7+5	F202  202A    		JR	NZ,SEEKX	;EXIT WITH PERMANENT ERROR IF FAILURE
 492:				
 493:17777+7	F204  0601    	SEEK1:	LD	B,1
 494:17784+17	F206  CD57F2  		CALL	SEEK		;FIRST SEEK (IX+DSKTRK) WITH NO RETRIES
 495:17801+5+6	F209  C8      		RET	Z		;EXIT IF WE GOT TO THE DESIRED TRACK
 496:17806+7+5	F20A  3005    		JR	NC,SEEK2	;JUMP IF WE LANDED ON SOME OTHER TRACK
 497:				
 498:17813+17	F20C  CD37F2  		CALL	RESTORE		;ELSE RECALIBRATE BEFORE TRYING AGAIN
 499:17830+7+5	F20F  201D    		JR	NZ,SEEKX	;EXIT IF TRACK ZERO NOT FOUND
 500:				
 501:17837+7	F211  0602    	SEEK2:	LD	B,2
 502:17844+17	F213  CD57F2  		CALL	SEEK		;NOW SEEK WITH TWO TRIES
 503:17861+5+6	F216  C8      		RET	Z		;EXIT IF SUCCESSFUL THIS TIME
 504:17866+7+5	F217  3815    		JR	C,SEEKX		;EXIT IF NO ID MARK COULD BE FOUND
 505:				
 506:17873+10	F219  216400  		LD	HL,100
 507:17883+17	F21C  CD9EF3  		CALL	WAIT		;DELAY TO LET THE STEPPER RELAX ITSELF
 508:17900+10	F21F  2128FF  		LD	HL,RATES
 509:17910+13	F222  3A2CFF  		LD	A,(UNIT)
 510:17923+4	F225  85      		ADD	A,L
 511:17927+4	F226  6F      		LD	L,A		;INDEX INTO TABLE TO DRIVE'S STEP RATE
 512:17931+11	F227  34      		INC	(HL)		; AND MAKE STEP RATE ONE NOTCH SLOWER
 513:17942+7	F228  7E      		LD	A,(HL)
 514:17949+7	F229  E603    		AND	00000011B	;CHECK FOR ROLL AROUND IN LOWER 2 BITS
 515:17956+7+5	F22B  20E4    		JR	NZ,SEEK2	;REPEAT IF STEP RATE BITS WERE NOT=3
 516:				
 517:17963+11	F22D  35      		DEC	(HL)		;ELSE RESTORE FROM ROLL AROUND
 518:17974+7	F22E  3EFF    	SEEKX:	LD	A,255
 519:17981+13	F230  322DFF  		LD	(TRACK),A	;FLAG TRACK POSITION AS UNKNOWN
 520:17994+7	F233  3E10    		LD	A,00010000B	;SET SEEK ERROR BIT IN STATUS WORD
 521:18001+4	F235  B7      		OR	A
 522:18005+10	F236  C9      		RET			;RETURN WITH RNF ERROR STATUS IN A
 523:				;
 524:				;
 525:				;
 526:				;
 527:     -	0001          			IF WD1772 <> 1
 528:     -	F237          	RESTORE:
 529:						ENDIF
 530:     -	F237          	SalyResetFDC:		
 531:18015+13	F237  3A2FFF  		LD	A,(OUTCPY)
 532:18028+8	F23A  CBE7    		SET	4,A
 533:18036+11	F23C  D330    		OUT	(LATCH),A	;TWANG THE DISK CONTROLLER RESET PIN
 534:18047+7	F23E  060F    		LD	B,15
 535:18054+8+5	F240  10FE    		DJNZ	$		;HOLD RESET 50 MICROSECONDS
 536:18062+8	F242  CBA7    		RES	4,A
 537:18070+11	F244  D330    		OUT	(LATCH),A
 538:				
 539:     -	0000          	IF WD1772
 546:				ELSE
 547:18081+7	F246  0600    		LD	B,0
 548:18088+8+5	F248  10FE    		DJNZ	$
 549:18096+17	F24A  CD91F3  		CALL	FORCE		;THEN FORCE CLEAR THE BEAST
 550:				ENDIF
 551:				
 552:18113+7	F24D  3E0B    		LD	A,RSTCMD+HLOAD+STEPRATE
 553:18120+17	F24F  CD6BF3  		CALL	TYP1CMD		;DO RESTORE AT SLOWEST STEP RATE
 554:18137+7	F252  EE04    		XOR	00000100B
 555:     -	0000          	IF WD1772
 557:				ELSE
 558:18144+7	F254  E684    		AND	10000100B
 559:				ENDIF
 560:18151+10	F256  C9      		RET			;RETURN WITH ACC=0 IF HOME
 561:				;
 562:				;
 563:				;
 564:     -	F257          	SEEK:
 565:18161+11	F257  C5      		PUSH	BC		;SAVE LOOPCOUNT IN B
 566:18172+13	F258  3A2DFF  		LD	A,(TRACK)
 567:18185+4	F25B  47      		LD	B,A		;LOAD B WITH CURRENT TRACK POSITION
 568:18189+19	F25C  DD4E02  		LD	C,(IX+DSKTRK)	;LOAD C WITH DESTINATION TRACK#
 569:18208+17	F25F  CD75F2  		CALL	STEP		;HAVE A GO AT STEPPING
 570:18225+17	F262  CD95F2  		CALL	VERIFY		;VERIFY HEAD POSITION WITH READ-ID
 571:18242+10	F265  C1      		POP	BC
 572:18252+4	F266  37      		SCF
 573:18256+5+6	F267  C0      		RET	NZ		;EXIT WITH CARRY SET IF READ-ID FAILS
 574:				
 575:18261+11	F268  DB42    		IN	A,(SECREG)
 576:18272+13	F26A  322DFF  		LD	(TRACK),A	;STORE ACTUAL TRACK# FROM ID MARK
 577:18285+19	F26D  DD9602  		SUB	(IX+DSKTRK)	;COMPARE IF WE GOT THERE THIS TIME
 578:18304+5+6	F270  C8      		RET	Z		;EXIT WITH ACC=0 IF TRACK# VERIFIED
 579:				
 580:18309+8+5	F271  10E4    		DJNZ	SEEK		;DO PRESCRIBED NUMBER OF SEEK RETRIES
 581:				
 582:18317+4	F273  B7      		OR	A
 583:18321+10	F274  C9      		RET			;RETURN WITH CARRY AND ZERO FLAGS CLEAR
 584:				;
 585:				;
 586:				;
 587:				;	STEP FROM TRACK# IN B TOWARDS TRACK# IN C
 588:				;
 589:     -	F275          	STEP:
 590:18331+4	F275  78      		LD	A,B
 591:18335+11	F276  D341    		OUT	(TRKREG),A	;STARTING TRACK# TO TRACK REGISTER
 592:18346+4	F278  79      		LD	A,C
 593:18350+11	F279  D343    		OUT	(DATREG),A	;DESTINATION TRACK# TO DATA REGISTER
 594:					
 595:     -	0000          	IF WD1772
 604:				ELSE
 605:18361+10	F27B  2128FF  		LD	HL,RATES
 606:18371+13	F27E  3A2CFF  		LD	A,(UNIT)
 607:18384+4	F281  85      		ADD	A,L
 608:18388+4	F282  6F      		LD	L,A		;INDEX INTO STEP RATE TABLE FOR DRIVE
 609:18392+7	F283  7E      		LD	A,(HL)	
 610:18399+7	F284  E603    		AND	00000011B	;EXTRACT LOWER 2 BITS FOR STEP RATE
 611:18406+7	F286  F618    		OR	SKCMD+HLOAD	;MERGE WITH SEEK COMAND
 612:				ENDIF
 613:18413+17	F288  CD6BF3  		CALL	TYP1CMD		;DO SEEK WITH SPECIFIED STEP RATE
 614:				
 615:     -	0000          	IF WD1772
 625:				ELSE
 626:18430+7	F28B  7E      		LD	A,(HL)
 627:18437+7	F28C  E6FC    		AND	11111100B	;EXTRACT UPPER 6 BITS FOR SETTLE TIME
 628:18444+7	F28E  2600    		LD	H,0
 629:18451+4	F290  6F      		LD	L,A
 630:18455+17	F291  CD9EF3  		CALL	WAIT		;4..256 MILLISECOND HEAD SETTLING DELAY
 631:				ENDIF
 632:18472+10	F294  C9      		RET
 633:				;
 634:				;
 635:				;
 636:				;
 637:     -	F295          	VERIFY:
 638:18482+7	F295  3EC0    		LD	A,RIDCMD
 639:18489+17	F297  CD62F3  		CALL	TYP2CMD		;READ NEXT ID MARK TO VERIFY SEEK
 640:     -	0000          	IF WD1772
 642:				ELSE
 643:18506+7	F29A  E698    		AND	10011000B
 644:				ENDIF
 645:18513+5+6	F29C  C8      		RET	Z		;EXIT IF ID MARK READ OK
 646:				
 647:18518+13	F29D  3A2FFF  		LD	A,(OUTCPY)
 648:18531+7	F2A0  EE80    		XOR	10000000B	;COMPLIMENT DENSITY BIT OF DRIVE TYPE
 649:18538+13	F2A2  322FFF  		LD	(OUTCPY),A
 650:18551+11	F2A5  D330    		OUT	(LATCH),A
 651:18562+10	F2A7  213200  		LD	HL,50
 652:18572+17	F2AA  CD9EF3  		CALL	WAIT		;ALLOW 50 MS DELAY AFTER CLOCK SWITCH
 653:18589+7	F2AD  3EC0    		LD	A,RIDCMD
 654:18596+17	F2AF  CD62F3  		CALL	TYP2CMD		;TRY AGAIN IN NEW DENSITY
 655:     -	0000          	IF WD1772
 657:				ELSE
 658:18613+7	F2B2  E698    		AND	10011000B
 659:				ENDIF
 660:18620+10	F2B4  C9      		RET			;A=0 IF AN ID MARK WAS FOUND
 661:				;
 662:				;
 663:				;
 664:				;
 665:				;
 666:				;
 667:     -	F2B5          	RWDISK:				;A=1797 TYPE 2 COMMAND BYTE
 668:18630+16	F2B5  2A6600  		LD	HL,(NMIVEC)	;20
 669:18646+11	F2B8  E5      		PUSH	HL		;11
 670:18657+16	F2B9  2A6800  		LD	HL,(NMIVEC+2)	;20
 671:18673+11	F2BC  E5      		PUSH	HL		;11 SAVE 4 BYTES AT NMI VECTOR
 672:18684+10	F2BD  21EDA2  		LD	HL,0A2EDH	;12 LOAD HL WITH 'INI' OPCODE
 673:18694+8	F2C0  CB6F    		BIT	5,A		;8  TEST IF READ OR WRITE BEING DONE
 674:18702+7+5	F2C2  2801    		JR	Z,RW2		;12 JUMP IF COMMAND IS A READ
 675:18709+4	F2C4  24      		INC	H		;4  ELSE TRANSFORM 'INI' INTO 'OUTI'
 676:18713+16	F2C5  226600  	RW2:	LD	(NMIVEC),HL	;16
 677:18729+10	F2C8  216800  		LD	HL,NMIVEC+2	;12
 678:18739+10	F2CB  36C9    		LD	(HL),0C9H	;10 STORE 'RET' OPCODE AFTER INI/OUTI
 679:18749+4	F2CD  F3      		DI			;4
 680:18753+7	F2CE  3EC7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	;7
 681:18760+11	F2D0  D383    		OUT	(CTC3),A	;ARM CTC3 FOR COUNTER MODE INTERRUPT					;11
 682:18771+4	F2D2  AF      		XOR	A		;TIME CONSTANT OF 0 WHICH MEANS 256					;4
 683:18775+11	F2D3  D383    		OUT	(CTC3),A	;COUNT 256 PULSES FROM CTC2						;11
 684:18786+4	F2D5  FB      		EI
 685:18790+19	F2D6  DD6E04  		LD	L,(IX+DSKPTR)	;HL=DISK READ/WRITE DATA POINTER					;19
 686:18809+19	F2D9  DD6605  		LD	H,(IX+DSKPTR+1)										;19
 687:18828+19	F2DC  DD4606  		LD	B,(IX+DSKAUX)	;B=SECTOR LENGTH COUNT (LSB)						;19
 688:18847+7	F2DF  0E43    		LD	C,DATREG	;C=DISK DATA PORT#							;7
 689:18854+19	F2E1  DD7E07  		LD	A,(IX+DSKAUX+1)										;19
 690:18873+8	F2E4  CB3F    		SRL	A											;8
 691:18881+7+5	F2E6  280D    		JR	Z,RW256		;JUMP IF BLOCKSIZE <= 256 BYTES						;12
 692:18888+8	F2E8  CB3F    		SRL	A
 693:18896+7+5	F2EA  2806    		JR	Z,RW512		;JUMP IF BLOCKSIZE <= 512 BYTES
 694:18903+4	F2EC  76      	RW1024:	HALT
 695:18907+7+5	F2ED  20FD    		JR	NZ,$-1
 696:18914+4	F2EF  76      		HALT
 697:18918+7+5	F2F0  20FD    		JR	NZ,$-1
 698:18925+4	F2F2  76      	RW512:	HALT
 699:18929+7+5	F2F3  20FD    		JR	NZ,$-1
 700:18936+4	F2F5  76      	RW256:	HALT
 701:18940+7+5	F2F6  20FD    		JR	NZ,$-1
 702:18947+11	F2F8  DB40    	RWBUSY:	IN	A,(STSREG)
 703:18958+8	F2FA  CB47    		BIT	0,A
 704:18966+7+5	F2FC  20FA    		JR	NZ,RWBUSY	;LOOP TILL 1797 BUSY BIT GOES AWAY
 705:18973+4	F2FE  47      		ld	b,a
 706:18977+17	F2FF  CDCBF3  		call	stoptmr
 707:18994+4	F302  78      		ld	a,b
 708:18998+10	F303  E1      	RWEXIT:	POP	HL
 709:19008+16	F304  226800  		LD	(NMIVEC+2),HL
 710:19024+10	F307  E1      		POP	HL
 711:19034+16	F308  226600  		LD	(NMIVEC),HL	;RESTORE CODE AT NMI
 712:     -	0000          	IF WD1772
 714:				ELSE
 715:19050+7	F30B  E6FD    		AND	11111101B	;MASK FOR DISK ERRORS
 716:				ENDIF
 717:19057+10	F30D  C9      		RET			;RETURN WITH DISK ERROR FLAGS SET
 718:				;
 719:				;
 720:				;
 721:				;
 722:     -	F30E          	RECOVER:
 723:19067+4	F30E  47      		LD	B,A
 724:19071+7	F30F  E6E7    		AND	11100111B	;MASK OFF ALL BUT RNF/CRC ERROR BITS
 725:19078+7+5	F311  2808    		JR	Z,RECOV1	;JUMP IF ONE OF THOSE TWO WERE SET
 726:				
 727:19085+11	F313  F5      		PUSH	AF
 728:19096+17	F314  CD91F3  		CALL	FORCE		;RESET ERROR FLAGS IN 179X STATUS REG
 729:19113+10	F317  F1      		POP	AF
 730:     -	0000          	IF WD1772
 732:				ELSE
 733:19123+7	F318  E6E1    		AND	11100001B	;CLEAR BITS ASSOCIATED WITH LOST DATA
 734:				ENDIF
 735:19130+10	F31A  C9      		RET			;RETURN WITH ACC=0 IF RETRY TO BE DONE
 736:				;
 737:19140+8	F31B  CB60    	RECOV1:	BIT	4,B
 738:19148+7+5	F31D  2023    		JR	NZ,RECOV3	;JUMP IF RECORD-NOT-FOUND ERROR
 739:				;
 740:				;	ARRIVE HERE IF BAD CRC ERROR
 741:				;
 742:19155+13	F31F  3A33FF  	RECOV2:	LD	A,(RWMAX)
 743:19168+10	F322  21C6FF  		LD	HL,RWTRY
 744:19178+7	F325  96      		SUB	(HL)		;COMPUTE HOW MANY RETRYS HAVE BEEN DONE
 745:19185+5+6	F326  C8      		RET	Z		;EXIT IF FIRST RETRY
 746:				
 747:19190+13	F327  3A2DFF  		LD	A,(TRACK)	;ELSE PREPARE TO WIGGLE BACK AND FORTH
 748:19203+4	F32A  47      		LD	B,A		; TO AN ADJACENT TRACK TO RE-CALIBRATE
 749:19207+4	F32B  B7      		OR	A		; AND REMOVE POSSIBLE MEDIA CONTAMINANT
 750:19211+7+5	F32C  2004    		JR	NZ,RCOV2A
 751:19218+7	F32E  0E01    		LD	C, 1		;STEP TO TRACK#1 IF ON TRACK# 0
 752:19225+12	F330  1802    		JR	RCOV2B
 753:				;
 754:19237+4	F332  3D      	RCOV2A:	DEC	A		;STEP TO NEXT OUTER TRACK
 755:19241+4	F333  4F      		LD	C,A
 756:19245+11	F334  C5      	RCOV2B:	PUSH	BC
 757:19256+17	F335  CD75F2  		CALL	STEP		;STEP HEAD TO ADJACENT TRACK
 758:19273+10	F338  D1      		POP	DE
 759:19283+4	F339  43      		LD	B,E		;EXCHANGE CONTENTS OF B AND C
 760:19287+4	F33A  4A      		LD	C,D
 761:19291+17	F33B  CD75F2  		CALL	STEP		;STEP BACK TO ORIGINAL TRACK
 762:19308+17	F33E  CD95F2  		call	verify
 763:19325+10	F341  C9      		ret			;allow retry successful read id
 764:				;
 765:				;	ARRIVE HERE IF RECORD-NOT-FOUND ERROR
 766:				;
 767:19335+17	F342  CD95F2  	recov3:	call	verify		;read an id mark to verify position
 768:19352+7+5	F345  2012    		JR	NZ,RCOV4A	;RECALIBRATE IF VERIFY FAILS
 769:				
 770:19359+11	F347  DB41    		IN	A,(TRKREG)	;LOAD A WITH CURENT TRACK# UNDER HEAD
 771:19370+19	F349  DDBE02  		CP	(IX+DSKTRK)
 772:19389+7+5	F34C  200D    		JR	NZ,RCOV4B	;JUMP IF NOT ON CORRECT TRACK
 773:				;
 774:				;	ARRIVE HERE IF ON CORRECT TRACK
 775:				;
 776:19396+13	F34E  3A33FF  		ld	a,(rwmax)
 777:19409+10	F351  21C6FF  		ld	hl,rwtry
 778:19419+7	F354  96      		sub	(hl)		;test if this is first retry after rnf error
 779:19426+5+6	F355  C8      		ret	z
 780:				
 781:19431+7	F356  3E10    		ld	a,00010000b
 782:19438+10	F358  C9      		ret			;indicate permanent rnf error
 783:				;
 784:				;	ARRIVE HERE IF HEAD POSITION IS INCORRECT
 785:				;
 786:19448+7	F359  3EFF    	RCOV4A:	LD	A,255		;SET A TO FORCE RESTORE BEFORE SEEK
 787:19455+13	F35B  322DFF  	RCOV4B:	LD	(TRACK),A
 788:19468+17	F35E  CDF8F1  		CALL	SEEKTRK		;SEEK TRACK# SPECIFIED IN IOCB
 789:19485+10	F361  C9      		RET
 790:				;
 791:				;
 792:				;
 793:				;
 794:				;	EXECUTE TYPE 2 COMMAND (READ/WRITE/READ ID) WITH TIMEOUT
 795:				;
 796:     -	F362          	TYP2CMD:
 797:19495+17	F362  CD89F3  		CALL	CMDOUT		;ISSUE COMMAND
 798:19512+11	F365  C5      		PUSH	BC
 799:19523+10	F366  016A18  		LD	BC,6250		;500,000/80 FOR ONE HALF SECOND DELAY
 800:19533+12	F369  1807    		JR	TPCMD2
 801:				;
 802:				;
 803:				;	EXECUTE TYPE 1 COMMAND (SEEK/STEP/RESTORE)
 804:				;
 805:     -	F36B          	TYP1CMD:
 806:19545+17	F36B  CD89F3  		CALL	CMDOUT
 807:19562+11	F36E  C5      		PUSH	BC
 808:19573+10	F36F  017C92  		LD	BC,37500	;3,000,000/80 FOR 3 SECONDS DELAY
 809:19583+11	F372  DB40    	TPCMD2:	IN	A,(STSREG)
 810:19594+8	F374  CB47    		BIT	0,A
 811:19602+7+5	F376  280A    		JR	Z,TPCMD3	;EXIT IF BUSY BIT GOES AWAY
 812:				
 813:19609+17	F378  CD8BF3  		CALL	CMDT1		;DELAY 56 MICROSECONDS
 814:19626+6	F37B  0B      		DEC	BC
 815:19632+4	F37C  78      		LD	A,B
 816:19636+4	F37D  B1      		OR	C
 817:19640+7+5	F37E  20F2    		JR	NZ,TPCMD2	;LOOP TAKES 80 MICROSECONDS
 818:				
 819:19647+7	F380  3E10    		LD	A,00010000B
 820:				
 821:     -	F382          	TPCMD3:
 822:     -	0000          	IF WD1772
 824:				ELSE
 825:19654+4	F382  47      		LD	B,A
 826:19658+17	F383  CD91F3  		CALL	FORCE
 827:19675+4	F386  78      		LD	A,B
 828:				ENDIF
 829:19679+10	F387  C1      		POP	BC
 830:19689+10	F388  C9      		RET
 831:				;
 832:				;
 833:				;
 834:     -	F389          	CMDOUT:
 835:19699+11	F389  D340    		OUT	(CMDREG),A	;OUTPUT DISK CONTROLLER COMMAND BYTE
 836:19710+7	F38B  3E0E    	CMDT1:	LD	A,14	
 837:19717+4	F38D  3D      	CMDT2:	DEC	A
 838:19721+7+5	F38E  20FD    		JR	NZ,CMDT2	;DELAY 56 MICROSECONDS
 839:19728+10	F390  C9      		RET
 840:				;
 841:				;
 842:				;
 843:				;
 844:     -	F391          	FORCE:
 845:     -	0000          	IF WD1772
 850:				ELSE
 851:19738+7	F391  3ED0    		LD	A,FINCMD	;LOAD FORCE-INTERRUPT-IMMEDIATE CMD
 852:19745+17	F393  CD89F3  		CALL	CMDOUT		;CLEAR 179X AND LATCH READY/HLD/TK0 ETC
 853:19762+11	F396  DB40    		IN	A,(STSREG)	;READ STATUS REGISTER CONTENTS
 854:19773+10	F398  C9      		RET
 855:				ENDIF
 856:				;
 857:				;
 858:				;
 859:				;
 860:				;
 861:     -	F399          	HLDWAIT:
 862:19783+16	F399  2A32FF  		LD	HL,(HLDTIM)	;LOAD HL WITH HEAD LOAD DELAY
 863:19799+7	F39C  2600    		LD	H,0		;RANGE 1..256 MILLISECONDS
 864:				
 865:19806+4	F39E  AF      	WAIT:	XOR	A
 866:19810+4	F39F  3D      	WAIT2:	DEC	A
 867:19814+7+5	F3A0  20FD    		JR	NZ,WAIT2	;DELAY 1 MILLISECOND
 868:19821+6	F3A2  2B      		DEC	HL
 869:19827+4	F3A3  7C      		LD	A,H
 870:19831+4	F3A4  B5      		OR	L
 871:19835+7+5	F3A5  20F7    		JR	NZ,WAIT		;LOOP UNTIL HL=0
 872:19842+10	F3A7  C9      		RET
 873:				;
 874:				;
 875:				;
 876:				;	... CTC INTERRUPT CONTROL ROUTINES FOR DISK HANDLER ...
 877:				;
 878:				;
 879:				;
 880:     -	F3A8          	WATCHDOG:
 881:19852+7	F3A8  3ED0    		LD	A,FINCMD
 882:19859+11	F3AA  D340    		OUT	(CMDREG),A	;ABORT DISK CONTROLLER OPERATION
 883:19870+7	F3AC  3E01    		LD	A,00000001B
 884:19877+11	F3AE  D383    		OUT	(CTC3),A	;RESET INTERRUPT FROM CTC3
 885:19888+10	F3B0  2103F3  		LD	HL,RWEXIT
 886:19898+19	F3B3  E3      		EX	(SP),HL		;TOSS RETURN ADDRESS AND PLANT FAKE ONE
 887:19917+7	F3B4  3E10    		LD	A,00010000B
 888:19924+4	F3B6  B7      		OR	A		;INDICATE RECORD-NOT-FOUND ERROR
 889:19928+4	F3B7  FB      		EI
 890:19932+14	F3B8  ED4D    		RETI			;INSURE CTC IRQ LOGIC GETS RESTORED
 891:				;
 892:				;
 893:				;
 894:				;
 895:				;
 896:				;	... MILLISECOND TIMER INTERRUPT ROUTINES ...
 897:				;
 898:				;
 899:     -	F3BA          	STARTMR:
 900:19946+4	F3BA  F3      		DI
 901:19950+7	F3BB  3E87    		LD	A,10000111B
 902:19957+11	F3BD  D383    		OUT	(CTC3),A
 903:19968+7	F3BF  3EFA    		LD	A,250
 904:19975+11	F3C1  D383    		OUT	(CTC3),A
 905:19986+10	F3C3  21D2F3  		LD	HL,TMRIRQ
 906:19996+16	F3C6  2216FF  		LD	(CTCVEC+6),HL
 907:20012+4	F3C9  FB      		EI
 908:20016+10	F3CA  C9      		RET
 909:				;
 910:				;
 911:				;
 912:     -	F3CB          	STOPTMR:
 913:20026+4	F3CB  F3      		DI
 914:20030+7	F3CC  3E01    		LD	A,00000001B
 915:20037+11	F3CE  D383    		OUT	(CTC3),A
 916:20048+4	F3D0  FB      		EI
 917:20052+10	F3D1  C9      		RET
 918:				;
 919:				;
 920:				;
 921:     -	F3D2          	TMRIRQ:
 922:20062+11	F3D2  E5      		PUSH	HL
 923:20073+4	F3D3  FB      		EI
 924:20077+16	F3D4  2AC7FF  		LD	HL,(TICKS)
 925:20093+6	F3D7  23      		INC	HL		;BUMP FREE RUNING MILLISECOND COUNTER
 926:20099+16	F3D8  22C7FF  		LD	(TICKS),HL
 927:20115+10	F3DB  E1      		POP	HL
 928:20125+14	F3DC  ED4D    		RETI
 929:				;
 930:				;
 931:				; purpose was to check for HD Disk in order to get it formatted if another format was inserted before
 932:				;
 933:				;HDDISK:		res	6, a				;non HD-DISK
 934:				;		bit	SIZE, (IY+MEDIA)
 935:				;		jz	HDDISK1	
 936:				;		res	6, a
 937:				;HDDISK1:	LD	(OUTCPY),A
 938:				;		PUSH	hl
 939:				;		LD	hl, 0ffffh
 940:				;		LD	(drive), hl
 941:				;		POP	hl
 942:				;		ret
 943:				
 944:     -	0000          	IF WD1772
 963:				ENDIF
**** ..\src\ROM.MAC ****
  40:					INCLUDE	MINIMON.MAC
**** ..\src\MINIMON.MAC ****
   1:				;
   2:				;
   3:				;
   4:     -	F3DE          	MINIMON:
   5:20139+7	F3DE  3E01    		LD	A,1
   6:20146+11	F3E0  D352    		OUT	(BANKSW),A	;SWITCH TO ALL-RAM CONFIGURATION
   7:20157+17	F3E2  CDFCF5  		CALL	CONINIT		;INITIALIZE SERIAL CONSOLE PORT
   8:20174+17	F3E5  CDC9F4  		CALL	PNEXT
   9:     -	F3E8  0D0A    		DEFB	CR,LF
  10:     -	0001          	IF SALLYBUILD
  11:     -	0000          	   IF WD1772 = 1
  13:				   ELSE
  14:     -	F3EA  53414C4C		DEFB	"SALLY1"
	              5931
  15:				   ENDIF
  16:				ELSE
  18:				ENDIF
  19:     -	F3F0  00      		DEFB	NULL
  20:20191+10	F3F1  21F1F3  	PROMPT:	LD	HL,PROMPT
  21:20201+11	F3F4  E5      		PUSH	HL		;PUT RETURN ADDRESS ON STACK
  22:20212+17	F3F5  CDC9F4  		CALL	PNEXT
  23:     -	F3F8  0D0A2320		DEFB	CR,LF,'# ',NULL
	              00
  24:20229+17	F3FD  CDB2F4  		CALL	ECHO
  25:20246+7	F400  FE20    		CP	' '
  26:20253+5+6	F402  D8      		RET	C		;IGNORE NON-PRINTABLE CHATACTERS
  27:				
  28:20258+4	F403  4F      		LD	C,A		;SAVE COMMAND CHARACTER IN C
  29:20262+4	F404  AF      		XOR	A
  30:20266+4	F405  67      		LD	H,A
  31:20270+4	F406  6F      		LD	L,A
  32:20274+11	F407  29      	PROM1:	ADD	HL,HL		;MULTIPLY RESULT BY 16
  33:20285+11	F408  29      		ADD	HL,HL
  34:20296+11	F409  29      		ADD	HL,HL
  35:20307+11	F40A  29      		ADD	HL,HL
  36:20318+4	F40B  B5      		OR	L		;APPEND NEW LOW ORDER DIGIT
  37:20322+4	F40C  6F      		LD	L,A
  38:20326+17	F40D  CDB2F4  		CALL	ECHO		;GET A CHARACTER FROM LINE INPUT
  39:20343+7	F410  FE0D    		CP	CR
  40:20350+7+5	F412  280C    		JR	Z,PROM3		;EXIT LOOP IF RETURN TYPED
  41:20357+17	F414  CD83F4  		CALL	ASCHEX		;CONVERT ASCII TO NUMERIC
  42:20374+7+5	F417  30EE    		JR	NC,PROM1	;KEEP SHIFTING IF VALID HEX
  43:				
  44:20381+17	F419  CDC9F4  	PROM2:	CALL	PNEXT
  45:     -	F41C  203F00  		DEFB	' ?',NULL
  46:20398+10	F41F  C9      		RET
  47:				;
  48:20408+17	F420  CDD5F4  	PROM3:	CALL	CRLF
  49:20425+4	F423  79      		LD	A,C
  50:20429+7	F424  FE47    		CP	'G'
  51:20436+7+5	F426  2836    		JR	Z,GOTO		;DO GOTO IF 'G'
  52:20443+7	F428  FE42    		CP	'B'
  53:20450+7+5	F42A  2833    		JR	Z,BOOT		;DO BOOT LOADER IF 'B'
  54:20457+7	F42C  FE4D    		CP	'M'
  55:20464+7+5	F42E  20E9    		JR	NZ,PROM2	;***TEMP***
  56:				
  57:				;  **** This code section does not exist on production ROM ****
  58:				;	.COMMENT %
  59:				;	JR	Z,VIEW		;DO MEMORY EXAMINE/CHANGE IF 'M'
  60:				;	CP	'D'
  61:				;	JR	NZ,PROM2	;FALL INTO MEMORY DUMP IF 'D'
  62:				;
  63:				;
  64:				;
  65:				;	-- TABULAR MEMORY DUMP COMMAND --
  66:				;
  67:				;DUMP:
  68:				;	LD	C,16
  69:				;DUMP1:	PUSH	HL		;SAVE STARTING ADDRESS
  70:				;	CALL	PUT4HS		;PRINT STARTING ADDRESS IN HEX
  71:				;	LD	B,8
  72:				;DUMP2:	LD	A,(HL)		;GET A DATA BYTE @ HL
  73:				;	INC	HL
  74:				;	CALL	PUT2HS		;PRINT THE DATA IN HEX
  75:				;	DJNZ	DUMP2		;REPEAT 16 TIMES
  76:				;	POP	HL		;RESTORE STARTING ADDRESS
  77:				;	LD	B,8
  78:				;DUMP3:	LD	A,(HL)		;GET BACK DATA BYTE @ HL
  79:				;	INC	HL
  80:				;	RES	7,A
  81:				;	CP	20H
  82:				;	JR	C,DUMP4
  83:				;	CP	7FH
  84:				;	JR	C,DUMP5
  85:				;DUMP4:	LD	A,'.'		;PRINT A DOT IF DATA < 20 OR > 7F
  86:				;DUMP5:	CALL	OUTPUT		;PRINT ASCII CHARACTER IN A
  87:				;	DJNZ	DUMP3
  88:				;	CALL	CRLF
  89:				;	DEC	C
  90:				;	JR	NZ,DUMP1
  91:				;	RET
  92:				;
  93:				;
  94:				;	-- MEMORY EXAMINE COMMAND --
  95:				;
  96:     -	F430          	VIEW:
  97:20471+17	F430  CD93F4  		CALL	PUT4HS
  98:20488+7	F433  7E      		LD	A,(HL)
  99:20495+17	F434  CD98F4  		CALL	PUT2HS
 100:20512+17	F437  CDB2F4  		CALL	ECHO
 101:20529+7	F43A  FE0D    		CP	CR
 102:20536+7+5	F43C  2818    		JR	Z,VIEW4
 103:20543+7	F43E  FE2D    		CP	'-'
 104:20550+7+5	F440  2816    		JR	Z,VIEW5
 105:20557+17	F442  CD83F4  		CALL	ASCHEX
 106:20574+4	F445  3F      		CCF	
 107:20578+5+6	F446  D0      		RET	NC
 108:20583+4	F447  07      		RLCA	
 109:20587+4	F448  07      		RLCA	
 110:20591+4	F449  07      		RLCA	
 111:20595+4	F44A  07      		RLCA	
 112:20599+4	F44B  4F      		LD	C,A
 113:20603+17	F44C  CDB2F4  		CALL	ECHO
 114:20620+17	F44F  CD83F4  		CALL	ASCHEX
 115:20637+4	F452  3F      		CCF	
 116:20641+5+6	F453  D0      		RET	NC
 117:20646+4	F454  B1      		OR	C
 118:20650+7	F455  77      		LD	(HL),A
 119:20657+6	F456  23      	VIEW4:	INC	HL
 120:20663+6	F457  23      		INC	HL
 121:20669+6	F458  2B      	VIEW5:	DEC	HL
 122:20675+17	F459  CDD5F4  		CALL	CRLF
 123:20692+12	F45C  18D2    		JR	VIEW
 124:				;
 125:				;
 126:				;
 127:				;	-- JUMP TO MEMORY LOCATION COMMAND --
 128:				;
 129:     -	F45E          	GOTO:
 130:20704+4	F45E  E9      		JP	(HL)
 131:				;
 132:				;
 133:				;
 134:				;	-- DISK BOOT LOADER --
 135:				;
 136:     -	F45F          	BOOT:
 137:20708+14	F45F  DD217AF4		LD	IX,BOOTCB
 138:20722+17	F463  CD22F0  		CALL	DISKDVR		;ATTEMPT TO READ BOOT SECTOR
 139:20739+19	F466  DD7E08  		LD	A,(IX+DSKSTS)
 140:20758+4	F469  B7      		OR	A
 141:20762+10+7	F46A  CC8000  		CALL	Z,0080H		;EXECUTE BOOT IF NO ERRORS
 142:20772+11	F46D  F5      		PUSH	AF
 143:20783+17	F46E  CDC9F4  		CALL	PNEXT
 144:     -	F471  20455252		DEFB	' ERR ',NULL
	              2000
 145:20800+10	F477  F1      		POP	AF
 146:20810+12	F478  1825    		JR	PUT2HX
 147:				;
 148:				;
 149:     -	F47A  01      	BOOTCB:	DEFB	GETSEC
 150:     -	F47B  00      		DEFB	0
 151:     -	F47C  00      		DEFB	0
 152:     -	F47D  01      		DEFB	1
 153:     -	F47E  8000    		DEFW	0080H
 154:     -	F480  8000    		DEFW	128
 155:     -	F482  00      		DEFB	0
 156:				;
 157:				;
 158:				;
 159:     -	F483          	ASCHEX:
 160:20822+7	F483  D630    		SUB	'0'
 161:20829+5+6	F485  D8      		RET	C
 162:20834+7	F486  FE0A    		CP	10
 163:20841+4	F488  3F      		CCF
 164:20845+5+6	F489  D0      		RET	NC
 165:20850+7	F48A  D607    		SUB	7
 166:20857+7	F48C  FE0A    		CP	10
 167:20864+5+6	F48E  D8      		RET	C
 168:20869+7	F48F  FE10    		CP	16
 169:20876+4	F491  3F      		CCF
 170:20880+10	F492  C9      		RET
 171:				;
 172:				;
 173:				;
 174:     -	F493          	PUT4HS:
 175:20890+4	F493  7C      		LD	A,H
 176:20894+17	F494  CD9FF4  		CALL	PUT2HX
 177:20911+4	F497  7D      		LD	A,L
 178:     -	F498          	PUT2HS:
 179:20915+17	F498  CD9FF4  		CALL	PUT2HX
 180:20932+7	F49B  3E20    		LD	A,' '
 181:20939+12	F49D  181F    		JR	OUTPUT
 182:				;
 183:				;
 184:     -	F49F          	PUT2HX:
 185:20951+11	F49F  F5      		PUSH	AF
 186:20962+4	F4A0  1F      		RRA	
 187:20966+4	F4A1  1F      		RRA	
 188:20970+4	F4A2  1F      		RRA	
 189:20974+4	F4A3  1F      		RRA	
 190:20978+17	F4A4  CDA8F4  		CALL	PUTNIB
 191:20995+10	F4A7  F1      		POP	AF
 192:21005+7	F4A8  E60F    	PUTNIB:	AND	00001111B
 193:21012+7	F4AA  C690    		ADD	A,90H
 194:21019+4	F4AC  27      		DAA
 195:21023+7	F4AD  CE40    		ADC	A,40H
 196:21030+4	F4AF  27      		DAA
 197:21034+12	F4B0  180C    		JR	OUTPUT
 198:				;
 199:				;
 200:				;
 201:				;
 202:     -	F4B2          	ECHO:
 203:21046+11	F4B2  E5      		PUSH	HL
 204:21057+11	F4B3  C5      		PUSH	BC
 205:21068+17	F4B4  CD09F0  		CALL	CIV		;CALL CONSOLE INPUT VECTOR
 206:21085+10	F4B7  C1      		POP	BC
 207:21095+10	F4B8  E1      		POP	HL
 208:21105+8	F4B9  CBBF    		RES	7,A
 209:21113+7	F4BB  FE20    		CP	' '
 210:21120+5+6	F4BD  D8      		RET	C		;DO NOT ECHO CONTROL CHARACTERS
 211:				
 212:     -	F4BE          	OUTPUT:
 213:21125+11	F4BE  E5      		PUSH	HL
 214:21136+11	F4BF  C5      		PUSH	BC
 215:21147+11	F4C0  F5      		PUSH	AF
 216:21158+4	F4C1  4F      		LD	C,A
 217:21162+17	F4C2  CD0CF0  		CALL	COV		;CALL CONSOLE OUTPUT VECTOR
 218:21179+10	F4C5  F1      		POP	AF
 219:21189+10	F4C6  C1      		POP	BC
 220:21199+10	F4C7  E1      		POP	HL
 221:21209+10	F4C8  C9      		RET
 222:				;
 223:				;
 224:				;
 225:     -	F4C9          	PNEXT:
 226:21219+19	F4C9  E3      		EX	(SP),HL
 227:21238+7	F4CA  7E      	PNXT1:	LD	A,(HL)
 228:21245+17	F4CB  CDBEF4  		CALL	OUTPUT
 229:21262+7	F4CE  7E      		LD	A,(HL)
 230:21269+6	F4CF  23      		INC	HL
 231:21275+4	F4D0  B7      		OR	A
 232:21279+7+5	F4D1  20F7    		JR	NZ,PNXT1
 233:21286+19	F4D3  E3      		EX	(SP),HL
 234:21305+10	F4D4  C9      		RET
 235:				;
 236:				;
 237:				;
 238:21315+17	F4D5  CDC9F4  	CRLF:	CALL	PNEXT
 239:     -	F4D8  0D0A00  		DEFB	CR,LF,NULL
 240:21332+10	F4DB  C9      		RET
 241:				;
 242:				;
 243:				;
**** ..\src\ROM.MAC ****
  41:					INCLUDE	PRINTER.MAC
**** ..\src\PRINTER.MAC ****
   1:				;
   2:				;
   3:				;	... PARALLEL PRINTER OUTPUT ROUTINE ...
   4:				;
   5:     -	F4DC          	CENTOUT:
   6:				
   7:21342+4	F4DC  79      		LD	A,C
   8:21346+11	F4DD  D320    		OUT	(PRINTER),A	;OUTPUT DATA BYTE TO PRINTER
   9:21357+19	F4DF  E3      		EX	(SP),HL
  10:21376+19	F4E0  E3      		EX	(SP),HL
  11:21395+7	F4E1  3E19    		LD	A,25
  12:21402+11	F4E3  D353    		OUT	(STROBE),A
  13:21413+4	F4E5  3D      	CENT2:	DEC	A
  14:21417+7+5	F4E6  20FD    		JR	NZ,CENT2
  15:21424+11	F4E8  D353    		OUT	(STROBE),A	;TWANG THE STROBE
  16:21435+10	F4EA  C9      		RET
  17:				;
  18:				;
  19:				;
  20:     -	F4EB          	CENTRDY:
  21:21445+16	F4EB  2A47FF  		LD	HL,(PMASKS)
  22:21461+11	F4EE  DB20    		IN	A,(PRINTER)
  23:21472+4	F4F0  A5      		AND	L		;MASK BITS WITH 'AND'
  24:21476+4	F4F1  AC      		XOR	H		;COMPARE WITH 'XOR'
  25:21480+10	F4F2  C9      		RET			;ACC=0 IF PRINTER IS READY
  26:				;
  27:				;
  28:				;
  29:				;
**** ..\src\ROM.MAC ****
  42:     -	F4F3  95      	        DEFB 95h                ; **** Exists on original ROM? ****
  43:     -	F4F4 ..F4FF 00		defs	(($ and 0ff00h)+100h)-$
  44:					INCLUDE	SERIAL.MAC
**** ..\src\SERIAL.MAC ****
   1:				;
   2:				;
   3:				;
   4:				;	... BAUDRATE AND TIMING CONSIDERATIONS ...
   5:				;
   6:				;	THE FOLLOWING TABLE DETAILS THE BIT TIMES FOR THE BAUDRATES
   7:				;    SUPPORTED BY THE ATR-8000 AND THE CTC PROGRAMMING PARAMETERS
   8:				;    REQUIRED TO GENERATE THEM USING THE CTC IN THE TIMER MODE.
   9:				;    (IE. BY DIVIDING DOWN THE 4MHZ CLOCK WITH 16 OR 256 PRESCALE.)
  10:				;
  11:				;	BAUD      PERIOD    MODULUS   PRESCALE
  12:				;	----      ------    -------   --------
  13:				;      19200        52 us      13        16
  14:				;	9600       104 us      26        16
  15:				;	4800       208 us      52        16
  16:				;	2400       416 us     104        16
  17:				;	1200       832 us     208        16
  18:				;	 600      1664 us      26       256
  19:				;	 300      3328 us      52       256
  20:				;	 150      6656 us     104       256
  21:				;	  75     13312 us     208       256
  22:				;
  23:				;
  24:				;
  25:				;
  26:				;	... INTERRUPT SERVICE ROUTINES FOR SERIAL CONSOLE INPUT ...
  27:				;
  28:				;	AVERAGE EXECUTION TIME = 24.55 us FOR INTERRUPT SERVICE
  29:				;				  4.75 us FOR INTERRUPT ACKNOWLEDGE
  30:				;				 ------
  31:				;				 29.30 us PER BIT
  32:				;
  33:				;
  34:				;	*** START BAGE BOUNDARY RESTRICTIONS ***
  35:				;
  36:     -	F500          	CONPAGE	EQU	$
  37:				;
  38:				;
  39:     -	F500          	RXSTART:
  40:21490+11	F500  F5      		PUSH	AF
  41:21501+7	F501  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  42:21508+11	F503  D380    		OUT	(CTC0),A		;RESET CTC AND PROGRAM FOR TIMER MODE
  43:21519+7	F505  3E1A    		LD	A,26			;TIME CONSTANT OF 26 - exactly 104us WHICH IS 9600 BAUD
  44:     -	F506          	RXBAUD	EQU	$-1			;BAUDRATE PARAM IS STORED HERE
  45:21526+11	F507  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  46:21537+7	F509  3E17    		LD	A,LOW RXDATA
  47:21544+13	F50B  3210FF  		LD	(CTCVEC),A
  48:21557+7	F50E  3E7F    		LD	A,01111111B		;7 DATA BITS
  49:21564+13	F510  321CF5  	RXDAT2:	LD	(RXTEMP),A	;SET DATA SHIFTER TO ALL ONES
  50:21577+10	F513  F1      		POP	AF
  51:21587+4	F514  FB      		EI
  52:21591+14	F515  ED4D    		RETI				;EXECUTION TIME = 115 CLOCK CYCLES
  53:				;
  54:				;
  55:				;
  56:     -	F517          	RXDATA:
  57:21605+11	F517  F5      		PUSH	AF
  58:21616+11	F518  DB70    		IN	A,(ATARI)		;READ SERIAL INPUT BIT STREAM
  59:21627+4	F51A  17      		RLA					;SHIFT DATA BIT (=MSB) INTO CARRY
  60:21631+7	F51B  3E00    		LD	A,NULL			;LOAD A WITH PARTIAL DATA BYTE - NOTE THAT THIS VALUE RESETS AT LABEL RXDAT2
  61:     -	F51C          	RXTEMP	EQU	$-1
  62:21638+4	F51D  1F      		RRA					;SHIFT NEW BIT IN AND ONES OUT
  63:21642+7+5	F51E  38F0    		JR	C,RXDAT2
  64:				
  65:21649+13	F520  3200FF  		LD	(KEYBUF),A		;STORE CHARACTER IN CIRCULAR BUFFER
  66:     -	F521          	RXINP	EQU	$-2
  67:21662+7	F523  3E2C    		LD	A,LOW RXSTOP
  68:21669+13	F525  3210FF  		LD	(CTCVEC),A		;ADVANCE TO STOP BIT STATE
  69:21682+10	F528  F1      		POP	AF
  70:21692+4	F529  FB      		EI
  71:21696+14	F52A  ED4D    		RETI				;EXECUTION TIME = 105 CYCLES
  72:				;
  73:				;
  74:				;
  75:     -	F52C          	RXSTOP:
  76:21710+11	F52C  F5      		PUSH	AF
  77:21721+7	F52D  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  78:21728+11	F52F  D380    		OUT	(CTC0),A		;ENABLE INTERRUPT FROM START BIT
  79:21739+7	F531  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
  80:21746+11	F533  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  81:21757+13	F535  3A21F5  		LD	A,(RXINP)
  82:21770+4	F538  3C      		INC	A
  83:21774+7	F539  E60F    		AND	00001111B		;BUMP BUFFER POINTER MODULO 16
  84:21781+13	F53B  3221F5  		LD	(RXINP),A
  85:21794+7	F53E  3E00    		LD	A,LOW RXSTART
  86:21801+13	F540  3210FF  		LD	(CTCVEC),A		;SET VECTOR BACK TO START BIT CODE
  87:21814+10	F543  F1      		POP	AF
  88:21824+4	F544  FB      		EI
  89:21828+14	F545  ED4D    		RETI				;EXECUTION TIME = 132 CYCLES
  90:				;
  91:				;
  92:				;
  93:				;
  94:				;	... INTERRUPT ROUTINES FOR SERIAL DATA OUTPUT ...
  95:				;
  96:     -	F547          	TXSTART:
  97:21842+11	F547  F5      		PUSH	AF
  98:21853+4	F548  AF      		XOR	A
  99:21857+11	F549  D350    		OUT	(ATROUT),A	;SEND COMPLIMENT OF MARK AS START BIT
 100:21868+7	F54B  3E54    		LD	A,LOW TXDAT0
 101:21875+13	F54D  3212FF  		LD	(CTCVEC+2),A	;SET INTERRUPT VECTOR FOR DATA BIT 0
 102:21888+10	F550  F1      		POP	AF
 103:21898+4	F551  FB      		EI
 104:21902+14	F552  ED4D    		RETI
 105:				;
 106:				;
 107:				;
 108:				;
 109:				;
 110:     -	F554          	TXDAT0:
 111:21916+11	F554  F5      		PUSH	AF
 112:21927+7	F555  3E00    		LD	A,NULL
 113:     -	F556          	TXTMP0	EQU	$-1
 114:21934+11	F557  D350    		OUT	(ATROUT),A	;OUTPUT LSB OF SERIAL DATA TO CONSOLE
 115:21945+4	F559  1F      		RRA
 116:21949+13	F55A  3268F5  		LD	(TXTMP1),A	;SHIFT RIGHT TO PREPARE FOR NEXT BIT
 117:21962+7	F55D  3E66    		LD	A,LOW TXDAT1
 118:21969+13	F55F  3212FF  		LD	(CTCVEC+2),A	;DINK WITH VECTOR FOR NEXT TIME
 119:21982+10	F562  F1      		POP	AF
 120:21992+4	F563  FB      		EI
 121:21996+14	F564  ED4D    		RETI			;EXECUTION TIME = 94 CYCLES
 122:				;
 123:				;
 124:     -	F566          	TXDAT1:
 125:22010+11	F566  F5      		PUSH	AF
 126:22021+7	F567  3E00    		LD	A,NULL
 127:     -	F568          	TXTMP1	EQU	$-1
 128:22028+11	F569  D350    		OUT	(ATROUT),A
 129:22039+4	F56B  1F      		RRA
 130:22043+13	F56C  327AF5  		LD	(TXTMP2),A
 131:22056+7	F56F  3E78    		LD	A,LOW TXDAT2
 132:22063+13	F571  3212FF  		LD	(CTCVEC+2),A
 133:22076+10	F574  F1      		POP	AF
 134:22086+4	F575  FB      		EI
 135:22090+14	F576  ED4D    		RETI
 136:				;
 137:				;
 138:     -	F578          	TXDAT2:
 139:22104+11	F578  F5      		PUSH	AF
 140:22115+7	F579  3E00    		LD	A,NULL
 141:     -	F57A          	TXTMP2	EQU	$-1
 142:22122+11	F57B  D350    		OUT	(ATROUT),A
 143:22133+4	F57D  1F      		RRA
 144:22137+13	F57E  328CF5  		LD	(TXTMP3),A
 145:22150+7	F581  3E8A    		LD	A,LOW TXDAT3
 146:22157+13	F583  3212FF  		LD	(CTCVEC+2),A
 147:22170+10	F586  F1      		POP	AF
 148:22180+4	F587  FB      		EI
 149:22184+14	F588  ED4D    		RETI
 150:				;
 151:				;
 152:     -	F58A          	TXDAT3:
 153:22198+11	F58A  F5      		PUSH	AF
 154:22209+7	F58B  3E00    		LD	A,NULL
 155:     -	F58C          	TXTMP3	EQU	$-1
 156:22216+11	F58D  D350    		OUT	(ATROUT),A
 157:22227+4	F58F  1F      		RRA
 158:22231+13	F590  329EF5  		LD	(TXTMP4),A
 159:22244+7	F593  3E9C    		LD	A,LOW TXDAT4
 160:22251+13	F595  3212FF  		LD	(CTCVEC+2),A
 161:22264+10	F598  F1      		POP	AF
 162:22274+4	F599  FB      		EI
 163:22278+14	F59A  ED4D    		RETI
 164:				;
 165:				;
 166:     -	F59C          	TXDAT4:
 167:22292+11	F59C  F5      		PUSH	AF
 168:22303+7	F59D  3E00    		LD	A,NULL
 169:     -	F59E          	TXTMP4	EQU	$-1
 170:22310+11	F59F  D350    		OUT	(ATROUT),A
 171:22321+4	F5A1  1F      		RRA
 172:22325+13	F5A2  32B0F5  		LD	(TXTMP5),A
 173:22338+7	F5A5  3EAE    		LD	A,LOW TXDAT5
 174:22345+13	F5A7  3212FF  		LD	(CTCVEC+2),A
 175:22358+10	F5AA  F1      		POP	AF
 176:22368+4	F5AB  FB      		EI
 177:22372+14	F5AC  ED4D    		RETI
 178:				;
 179:				;
 180:     -	F5AE          	TXDAT5:
 181:22386+11	F5AE  F5      		PUSH	AF
 182:22397+7	F5AF  3E00    		LD	A,NULL
 183:     -	F5B0          	TXTMP5	EQU	$-1
 184:22404+11	F5B1  D350    		OUT	(ATROUT),A
 185:22415+4	F5B3  1F      		RRA
 186:22419+13	F5B4  32C2F5  		LD	(TXTMP6),A
 187:22432+7	F5B7  3EC0    		LD	A,LOW TXDAT6
 188:22439+13	F5B9  3212FF  		LD	(CTCVEC+2),A
 189:22452+10	F5BC  F1      		POP	AF
 190:22462+4	F5BD  FB      		EI
 191:22466+14	F5BE  ED4D    		RETI
 192:				;
 193:				;
 194:     -	F5C0          	TXDAT6:
 195:22480+11	F5C0  F5      		PUSH	AF
 196:22491+7	F5C1  3E00    		LD	A,NULL
 197:     -	F5C2          	TXTMP6	EQU	$-1
 198:22498+11	F5C3  D350    		OUT	(ATROUT),A
 199:22509+4	F5C5  1F      		RRA
 200:22513+13	F5C6  32D4F5  		LD	(TXTMP7),A
 201:22526+7	F5C9  3ED2    		LD	A,LOW TXDAT7
 202:22533+13	F5CB  3212FF  		LD	(CTCVEC+2),A
 203:22546+10	F5CE  F1      		POP	AF
 204:22556+4	F5CF  FB      		EI
 205:22560+14	F5D0  ED4D    		RETI
 206:				;
 207:				;
 208:				;
 209:     -	F5D2          	TXDAT7:
 210:22574+11	F5D2  F5      		PUSH	AF
 211:22585+7	F5D3  3E00    		LD	A,NULL
 212:     -	F5D4          	TXTMP7	EQU	$-1
 213:22592+11	F5D5  D350    		OUT	(ATROUT),A	;SEND LAST BIT WITHOUT SHIFTING AFTER
 214:22603+7	F5D7  3EE0    		LD	A,LOW TXSTOP
 215:22610+13	F5D9  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR STOP BIT NEXT TIME
 216:22623+10	F5DC  F1      		POP	AF
 217:22633+4	F5DD  FB      		EI
 218:22637+14	F5DE  ED4D    		RETI
 219:				;
 220:				;
 221:				;
 222:     -	F5E0          	TXSTOP:
 223:22651+11	F5E0  F5      		PUSH	AF
 224:22662+7	F5E1  3E01    		LD	A,1
 225:22669+11	F5E3  D350    		OUT	(ATROUT),A
 226:22680+7	F5E5  3EEE    		LD	A,LOW TXEXIT
 227:22687+13	F5E7  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR TO CLEAR TX BUSY FLAG
 228:22700+10	F5EA  F1      		POP	AF
 229:22710+4	F5EB  FB      		EI
 230:22714+14	F5EC  ED4D    		RETI
 231:				;
 232:				;
 233:     -	F5EE          	TXEXIT:
 234:22728+11	F5EE  F5      		PUSH	AF
 235:22739+7	F5EF  3E01    		LD	A,00000001B
 236:22746+11	F5F1  D381    		OUT	(CTC1),A	;DISABLE INTERRUPT FROM XMIT BAUDRATE
 237:22757+7	F5F3  3EFF    		LD	A,255
 238:22764+13	F5F5  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR SO BACKGROUND MONITOR IRQ
 239:22777+10	F5F8  F1      		POP	AF
 240:22787+4	F5F9  FB      	RETI1:	EI
 241:22791+14	F5FA  ED4D    		RETI
 242:				;
 243:				;
 244:     -	0000          		IF	(HIGH CONPAGE) NE (HIGH $)
 246:					ENDIF
 247:				;
 248:				;
 249:				;
 250:				;	*** END PAGE BOUNDARY RESTRICTIONS ***
 251:				;
 252:				;
 253:				;
 254:     -	F5FC          	CONINIT:
 255:22805+4	F5FC  F3      		DI
 256:22809+10	F5FD  21EEF5  		LD	HL,TXEXIT
 257:22819+16	F600  2212FF  		LD	(CTCVEC+2),HL
 258:22835+7	F603  3E07    		LD	A,00000111B
 259:22842+11	F605  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 260:22853+13	F607  3A06F5  		LD	A,(RXBAUD)
 261:22866+11	F60A  D381    		OUT	(CTC1),A	;DIVIDE BY 26 GIVES 9600 BAUD
 262:				
 263:22877+10	F60C  2100FF  		LD	HL,KEYBUF
 264:22887+16	F60F  2221F5  		LD	(RXINP),HL	;RESET RX FIFO IN/OUT POINTERS
 265:22903+16	F612  2233F6  		LD	(RXOUT),HL
 266:     -	F615          	CINIT2:
 267:22919+4	F615  F3      		DI			;ALTERNATE ENTRY FROM 'DISKIO'
 268:22923+7	F616  3E01    		LD	A,1
 269:22930+11	F618  D357    		OUT	(CDMUX),A	;SET MUX TO ENABLE DATA TO CTC0
 270:22941+7	F61A  067E    	CINIT3:	LD	B,126
 271:22948+11	F61C  DB70    	CINIT4:	IN	A,(ATARI)
 272:22959+4	F61E  17      		RLA
 273:22963+7+5	F61F  30F9    		JR	NC,CINIT3		;RE-LOAD COUNT IN B IF INPUT LOW
 274:22970+8+5	F621  10F9    		DJNZ	CINIT4		;ELSE LOOP FOR ONE 9600 BAUD CHAR TIME
 275:				
 276:22978+7	F623  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 277:22985+11	F625  D380    		OUT	(CTC0),A		;PROGRAM RX CTC IN COUNTER MODE
 278:22996+7	F627  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
 279:23003+11	F629  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT AND INTERRUPT ON NEXT START BIT
 280:23014+10	F62B  2100F5  		LD	HL,RXSTART
 281:23024+16	F62E  2210FF  		LD	(CTCVEC),HL
 282:23040+4	F631  FB      		EI
 283:23044+10	F632  C9      		RET
 284:				;
 285:				;
 286:     -	F633  00FF    	RXOUT:	DEFW	KEYBUF		;KEYBOARD BUFFER OUTPUT POINTER
 287:				;
 288:				;
 289:     -	F635          	CONST:
 290:23054+10	F635  2133F6  		LD	HL,RXOUT
 291:23064+13	F638  3A21F5  		LD	A,(RXINP)
 292:23077+7	F63B  96      		SUB	(HL)
 293:23084+5+6	F63C  C8      		RET	Z		;A=0 IF NO DATA AVAILABLE
 294:				
 295:23089+7	F63D  3EFF    		LD	A,255
 296:23096+10	F63F  C9      		RET
 297:				;
 298:				;
 299:				;
 300:     -	F640          	CONIN:
 301:23106+17	F640  CD35F6  		CALL	CONST
 302:23123+7+5	F643  28FB    		JR	Z,CONIN
 303:				
 304:23130+16	F645  2A33F6  		LD	HL,(RXOUT)
 305:23146+7	F648  7E      		LD	A,(HL)		;GET RECEIVED DATA FROM FIFO
 306:23153+4	F649  2C      		INC	L
 307:23157+8	F64A  CBA5    		RES	4,L		;INCREMENT HL MODULO 16
 308:23165+16	F64C  2233F6  		LD	(RXOUT),HL
 309:23181+10	F64F  C9      		RET
 310:				;
 311:				;
 312:				;
 313:     -	F650          	CONOUT:
 314:23191+13	F650  3A12FF  		LD	A,(CTCVEC+2)
 315:23204+7	F653  FEEE    		CP	LOW TXEXIT
 316:23211+7+5	F655  38F9    		JR	C,CONOUT	;LOOP TILL WE REACH 'TEXIT' OR HIGHER
 317:				
 318:23218+4	F657  79      		LD	A,C
 319:23222+7	F658  E67F    		AND	01111111B	;CLEAR BIT 7 AND SET FLAGS
 320:23229+10	F65A  E25FF6  		JP	PO,COUT2
 321:23239+7	F65D  F680    		OR	10000000B
 322:23246+13	F65F  3256F5  	COUT2:	LD	(TXTMP0),A	;STORE RESULTING CHARACTER FOR XMIT
 323:23259+7	F662  3E47    		LD	A,LOW TXSTART
 324:23266+13	F664  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR START BIT INTERRUPT
 325:23279+7	F667  3E81    		LD	A,10000001B
 326:23286+11	F669  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 327:23297+10	F66B  C9      		RET
 328:				;
 329:				;
 330:				;
**** ..\src\ROM.MAC ****
  45:				;
  46:				;	CODE PAST THIS POINT IS ONLY USED IN ATARI DISK MODE
  47:				;
  48:					INCLUDE	BITBANG.MAC
**** ..\src\BITBANG.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	19200 BAUD SERIAL I/O FOR ATARI COMM PORT	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	19200 BAUD SERIAL I/O IS HALF DUPLEX DUE TO OBVIOUS
   9:				;	TIMING CONSTRAINTS. ALL TRANSFERS ARE DONE FROM 4K PAGE
  10:				;	ALIGNED BUFFER 'IOBUFF', WITH BLOCK START ADDRESS
  11:				;	ARRANGED SO END-OF-BLOCK CONDITION IS MET WHEN POINTER
  12:				;	ROLLS OVER THE NEXT EVEN PAGE BYTE BOUNDARY.
  13:				;
  14:				;	CALL WITH BLOCK START POINTER IN HL ,DATA POLARITY MASK
  15:				;	IN D (WHERE D=0 TRUE DATA, D=FF INVERTED DATA) AND
  16:				;	'C' OR 'E' HANDSHAKE CHARACTER IN E.
  17:				;
  18:				;
  19:     -	F66C          	SENDBUFF:
  20:23307+11	F66C  E5      		PUSH	HL		;SAVE DATA BLOCK POINTER
  21:23318+11	F66D  D5      		PUSH	DE		;SAVE POLARITY MASK FOR DATA
  22:23329+10	F66E  2101C3  		LD	HL,IOBUFF+LEN+1
  23:23339+7	F671  73      		LD	(HL),E
  24:23346+7	F672  1600    		LD	D,0
  25:23353+17	F674  CD84F6  		CALL	XMITBUF		;SEND 'C' OR 'E' CHARACTER FROM E
  26:23370+10	F677  D1      		POP	DE
  27:23380+10	F678  E1      		POP	HL
  28:23390+7	F679  1E00    		LD	E,0
  29:23397+17	F67B  CD84F6  		CALL	XMITBUF		;THEN SEND DATA BLOCK TO ATARI
  30:23414+10	F67E  2101C3  		LD	HL,IOBUFF+LEN+1
  31:23424+7	F681  73      		LD	(HL),E		;FALL THROUGH TO SEND CHECKSUM
  32:23431+7	F682  1600    		LD	D,0
  33:				;
  34:				;	CALL WITH DATA BLOCK POINTER IN HL.
  35:				;	PRESERVES MASK/CKECKSUM IN D/E.
  36:				;
  37:     -	F684          	XMITBUF:
  38:23438+4	F684  F3      		DI
  39:23442+10	F685  0119F7  		LD	BC,STARBIT
  40:     -	F688          	SalyXMITBUF:
  41:23452+20	F688  ED4312FF		LD	(CTCVEC+2),BC	;SET UP INITIAL INTERRUPT VECTOR
  42:23472+7	F68C  0608    		LD	B,8
  43:23479+7	F68E  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  44:23486+11	F690  D381    		OUT	(CTC1),A		;PROGRAM CTC1 TO INTERRUPT AT BIT RATE
  45:23497+7	F692  3E0D    		LD	A,13			;SET TIME CONSTANT TO 13 - 52us. EXACT IS 52.083us
  46:23504+11	F694  D381    		OUT	(CTC1),A		;COUNT 13*(16*250 NS) GIVES 19200 BAUD WITH 0.16% ERROR
  47:23515+4	F696  FB      		EI
  48:23519+12	F697  18FE    		JR	$		;SPIN HERE TILL INTERRUPTS GET US OUT
  49:				;
  50:				;
  51:				;
  52:				;
  53:				;
  54:				;
  55:				;	... INTERRUPT FOR COMMAND INPUT HIGH->LOW TRANSITION ..
  56:				;
  57:     -	F699          	CSTART:
  58:23531+4	F699  08      		EX	AF,AF'
  59:23535+4	F69A  D9      		EXX
  60:23539+7	F69B  3EFF    		LD	A,255
  61:23546+13	F69D  3255FF  		LD	(CMDFLG),A	;SET 'CMDFLG' FLAG TO ERROR STATE FIRST
  62:23559+11	F6A0  D357    		OUT	(CDMUX),A	;SWITCH MUX TO ENABLE SERIAL DATA IRQ
  63:23570+10	F6A2  21FBC2  		LD	HL,IOBUFF+LEN-5	;POINT DE 5 BYTES BEFORE END OF BUFFER
  64:23580+17	F6A5  CDD9F6  		CALL	RXBLOCK		;ATTEMPT TO RECEIVE COMMAND FRAME
  65:23597+7+5	F6A8  300A    		JR	NC,CSTRT1	;JUMP IF NO DATA HAPPENED
  66:					
  67:23604+6	F6AA  2B      		DEC	HL
  68:23610+7	F6AB  7E      		LD	A,(HL)
  69:23617+4	F6AC  B9      		CP	C		;COMPARE DERRIVED AND RECVD CHECKSUMS
  70:23621+7+5	F6AD  2005    		JR	NZ,CSTRT1	;JUMP IF CHECKSUM ERROR
  71:				
  72:23628+7	F6AF  3E01    		LD	A,1
  73:23635+13	F6B1  3255FF  		LD	(CMDFLG),A	;SET FLAG IF GOOD COMMAND FRAME
  74:23648+4	F6B4  08      	CSTRT1:	EX	AF,AF'
  75:23652+4	F6B5  D9      		EXX
  76:23656+4	F6B6  FB      		EI
  77:				
  78:23660+14	F6B7  ED4D    		RETI
  79:				;
  80:				;
  81:				;
  82:				;	... DATA FRAME RECEIVE SUBROUTINE ...
  83:				;
  84:     -	F6B9          	RECVBUFF:
  85:23674+4	F6B9  F3      		DI
  86:23678+10	F6BA  2100C1  		LD	HL,IOBUFF
  87:23688+17	F6BD  CDD9F6  		CALL	RXBLOCK		;BITBANG A BLOCK OF INPUT DATA
  88:23705+4	F6C0  FB      		EI
  89:23709+7+5	F6C1  380D    		JR	C,RBUFF2	;JUMP IF BUFFER OVERFLOWED
  90:				
  91:23716+6	F6C3  2B      		DEC	HL
  92:23722+7	F6C4  7E      		LD	A,(HL)
  93:23729+4	F6C5  B9      		CP	C
  94:23733+7+5	F6C6  2008    		JR	NZ,RBUFF2	;JUMP IF CHECKSUMS DON'T AGREE
  95:				
  96:23740+10	F6C8  1100C1  		LD	DE,IOBUFF
  97:23750+4	F6CB  B7      		OR	A
  98:23754+15	F6CC  ED52    		SBC	HL,DE		;ELSE COMPUTE LENGTH OF BLOCK LESS
  99:23769+4	F6CE  AF      		XOR	A		;CHECKSUM BYTE AND RETURN WITH
 100:23773+10	F6CF  C9      		RET			;RESULT IN HL AND ZERO FLAG SET
 101:				;
 102:23783+7	F6D0  3E4E    	RBUFF2:	LD	A,'N'
 103:23790+17	F6D2  CD68FC  		CALL	SENDCHAR	;SEND 'NAK' FOR BAD DATA FRAME
 104:23807+7	F6D5  3EFF    		LD	A,255
 105:23814+4	F6D7  B7      		OR	A
 106:23818+10	F6D8  C9      		RET			;RETURN WITH ACC SET NON=ZERO
 107:				;
 108:				;
 109:				;
 110:				;
 111:				;
 112:				;	... BITBANG INPUT SUBROUTINE ...
 113:				;
 114:				;	CALL WITH BLOCK START POINTER IN HL. RETURNS WITH
 115:				;	HL POINTING TO LAST BYTE+1 OF BLOCK RECEIVED.
 116:				;	THE CARRY BIT IS SET IF THE BUFFER FILLED UP BEFORE
 117:				;	THE BIT STREAM STOPPED.
 118:				;
 119:				;
 120:     -	F6D9          	RXBLOCK:
 121:23828+10	F6D9  11AA0A  		LD	DE,2730		;SET ABORT COUNTER FOR 32 MILLISECONDS
 122:     -	F6DC          	SalyRXBLOCK:
 123:23838+10	F6DC  010000  		LD	BC,0		;CLEAR B/C FOR CHECKSUM DERRIVATION
 124:23848+12	F6DF  1823    		JR	RXB35		;GO START LOOPING FOR START BIT
 125:				;
 126:23860+4	F6E1  79      	RXB1:	LD	A,C		;4
 127:23864+4	F6E2  80      		ADD	A,B		;4
 128:23868+7	F6E3  CE00    		ADC	A,0		;7 ACCUMULATE CHECKSUM ATARI STYLE
 129:23875+4	F6E5  4F      		LD	C,A		;4
 130:23879+19	F6E6  E3      		EX	(SP),HL		;19
 131:23898+19	F6E7  E3      		EX	(SP),HL		;19
 132:23917+19	F6E8  E3      		EX	(SP),HL		;19
 133:23936+19	F6E9  E3      		EX	(SP),HL		;19
 134:23955+7	F6EA  0608    		LD	B,8		;7
 135:				;
 136:				;	SERIAL->PARALLEL CONVERSION AT 52 MICROSECONDS PER BIT
 137:				;
 138:23962+7	F6EC  3E0B    	RXB2:	LD	A,11		;  7 CYCLES
 139:23969+7	F6EE  3E0B    		LD	A,11		;  7 CYCLES
 140:23976+4	F6F0  00      		NOP			;  4 CYCLES
 141:23980+4	F6F1  3D      	RXB3:	DEC	A		; 44 CYCLES  (11*4)
 142:23984+10	F6F2  C2F1F6  		JP	NZ,RXB3		;110 CYCLES  (11*10)
 143:23994+11	F6F5  DB70    		IN	A,(ATARI)	; 11 CYCLES
 144:24005+4	F6F7  17      		RLA			;  4 CYCLES
 145:24009+8	F6F8  CB1A    		RR	D		;  8 CYCLES
 146:24017+8+5	F6FA  10F0    		DJNZ	RXB2		; 13 CYCLES  (8 ON FINAL BIT)
 147:				
 148:24025+4	F6FC  42      		LD	B, D		;SAVE COPY OF LAST DATA BYTE IN B
 149:24029+7	F6FD  72      		LD	(HL),D		;THEN STORE IN MEMORY BUFFER @HL
 150:24036+6	F6FE  23      		INC	HL
 151:24042+4	F6FF  7C      		LD	A,H
 152:24046+7	F700  FEC3    		CP	HIGH (IOBUFF+LEN)
 153:24053+4	F702  3F      		CCF
 154:24057+5+6	F703  D8      		RET	C		;RETURN WITH CARRY SET IF BUFFER FILLED
 155:				
 156:     -	F704          	RXB35:
 157:24062+7	F704  3E47    		LD	A, CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
 158:24069+11	F706  D380    		OUT	(CTC0),A	;PUT CTC0 IN COUNTER MODE
 159:24080+4	F708  AF      		XOR	A		;TIME CONSTANT OF 0 WHICH MEANS 256
 160:24084+11	F709  D380    		OUT	(CTC0),A	;COUNT DATA HIGH->LOW EDGES MOD 256
 161:24095+10	F70B  11A101  		LD	DE,417		;5 MILLISECONDS @ 12 MICROSECONDS/LOOP
 162:				
 163:24105+11	F70E  DB80    	RXB4:	IN	A,(CTC0)
 164:24116+4	F710  B7      		OR	A
 165:24120+7+5	F711  20CE    		JR	NZ,RXB1		;NEW BYTE IS COMING IF START BIT LOW
 166:24127+6	F713  1B      		DEC	DE
 167:24133+4	F714  7A      		LD	A,D
 168:24137+4	F715  B3      		OR	E
 169:24141+7+5	F716  20F6    		JR	NZ,RXB4		;ELSE LOOP TILL TIMER RUNS OUT
 170:				
 171:24148+10	F718  C9      		RET			;RETURN WITH CARRY CLEAR IF TIMED OUT
 172:				;
 173:				;
 174:				;
 175:				;
 176:				;	**** PAGE BOUNDARY SENSITIVE CODE STARTS HERE ****
 177:				;
 178:     -	F719          	SERPAGE	EQU	$
 179:				;
 180:				;
 181:				;	... DAMN FAST TRANSMIT INTERRUPTS ...
 182:				;
 183:				;	HL ... POINTS TO DATA BLOCK TO BE SENT
 184:				;	 D ... HOLDS DATA POLARITY MASK
 185:				;	 E ... USED TO ACCUMULATE CHECKSUM
 186:				;	 B ... USED FOR DJNZ TO COUNT BITS
 187:				;	 C ... USED FOR PARALLEL-SERIAL OUTPUT
 188:				;
 189:				;
 190:     -	F719          	STARBIT:
 191:24158+4	F719  AF      		XOR	A
 192:24162+11	F71A  D350    		OUT	(ATROUT),A	;SEND START BIT
 193:24173+4	F71C  FB      		EI
 194:24177+7	F71D  7E      		LD	A,(HL)		;LOAD A WITH TRANSMIT DATA BYTE
 195:24184+6	F71E  23      		INC	HL		; AND INCREMENT BUFFER POINTER
 196:24190+4	F71F  AA      		XOR	D		;DO DATA POLARITY THING
 197:24194+4	F720  4F      		LD	C,A		;THEN STUFF IN C FOR SHIFTING OUT
 198:24198+4	F721  83      		ADD	A,E
 199:24202+7	F722  CE00    		ADC	A,0
 200:24209+4	F724  5F      		LD	E,A		;ACCUMULATE CHECKSUM IN E
 201:24213+7	F725  3E2C    		LD	A,LOW DATBIT
 202:24220+13	F727  3212FF  		LD	(CTCVEC+2),A	;FIX BAUDRATE INTERRUPT VECTOR
 203:24233+14	F72A  ED4D    		RETI			;RETURN TO IDLE LOOP
 204:				;
 205:				;
 206:				;
 207:     -	F72C          	DATBIT:
 208:24247+4	F72C  79      		LD	A,C
 209:24251+11	F72D  D350    		OUT	(ATROUT),A	;SEND DATA BIT (LSB)
 210:24262+4	F72F  FB      		EI
 211:24266+8	F730  CB19    		RR	C		;SHIFT DATA FOR NEXT BIT
 212:24274+8+5	F732  1005    		DJNZ	DATB2		;DECREMENT AND SKIP IF NOT LAST BIT
 213:				
 214:24282+7	F734  3E3B    		LD	A,LOW STOPB1
 215:24289+13	F736  3212FF  		LD	(CTCVEC+2),A	;THEN FIX VECTOR TO SEND STOP BIT
 216:24302+14	F739  ED4D    	DATB2:	RETI			;RETURN TO IDLE LOOP
 217:				;
 218:				;
 219:				;
 220:     -	F73B          	STOPB1:
 221:24316+7	F73B  3E01    		LD	A,1
 222:24323+11	F73D  D350    		OUT	(ATROUT),A	;SEND STOP BIT
 223:24334+4	F73F  FB      		EI
 224:24338+4	F740  7C      		LD	A,H
 225:24342+7	F741  FEC3    		CP	HIGH (IOBUFF+LEN)
 226:24349+7+5	F743  3009    		JR	NC,STOP1A	;JUMP IF BUFFER END REACHED
 227:				
 228:24356+7	F745  0608    		LD	B,8		;LOAD BITCOUNT FOR NEXT RECEIVE BYTE
 229:24363+7	F747  3E19    		LD	A,LOW STARBIT
 230:24370+13	F749  3212FF  		LD	(CTCVEC+2),A
 231:24383+14	F74C  ED4D    		RETI			;SET TO SEND SECOND STOP BIT
 232:				;
 233:24397+7	F74E  3E55    	STOP1A:	LD	A,LOW ENDBIT
 234:24404+13	F750  3212FF  		LD	(CTCVEC+2),A	;SET TO END TRANSMISSION
 235:24417+14	F753  ED4D    		RETI
 236:				;
 237:				;
 238:				;
 239:     -	0000          		IF	(HIGH SERPAGE) NE (HIGH $)
 241:					ENDIF
 242:				;
 243:				;
 244:				;
 245:     -	F755          	ENDBIT:
 246:     -	0001          	IF SALLYBUILD
 247:24431+7	F755  3E03    		LD	A,CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET - STOP INTERRUPTS FROM BAUDRATE CTC
 248:				ELSE
 250:				ENDIF
 251:24438+11	F757  D381    		OUT	(CTC1),A			;SEND COMMAND TO CTC1
 252:24449+4	F759  FB      		EI
 253:24453+7	F75A  3EFF    		LD	A,255
 254:24460+13	F75C  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR BACK TO STANDARD PLACE
 255:24473+10	F75F  E1      		POP	HL		;DISCARD IRQ RETURN ADDRESS AND RETURN
 256:24483+14	F760  ED4D    		RETI			; TO SECOND ADDRESS ON STACK
 257:				;
 258:				;
 259:				;	**** END PAGE BOUNDARY RESTRICTIONS ****
 260:				;
 261:				;
**** ..\src\ROM.MAC ****
  49:					INCLUDE	ATARI.MAC
**** ..\src\ATARI.MAC ****
   1:				;	PAGE
   2:				;
   3:				;	<<< MAIN LOOP FOR ATARI DISK EMULATOR >>>
   4:				;
   5:				;
   6:				;
   7:				;
   8:     -	F762          	EMULATOR:
   9:24497+7	F762  3E01    		LD	A,1
  10:24504+11	F764  D352    		OUT	(BANKSW),A	;TURN OFF THE ROM
  11:				;
  12:				;	CHECK TO DETERMINE WHICH CONSOLE IS ACTIVE
  13:				;
  14:24515+10	F766  21FEC2  	LOGON:	LD	HL,IOBUFF+LEN-2
  15:24525+4	F769  F3      		DI
  16:24529+17	F76A  CDD9F6  		CALL	RXBLOCK		;LISTEN FOR A MESSAGE FROM ABOVE
  17:24546+4	F76D  FB      		EI
  18:24550+7+5	F76E  30F6    		JR	NC,LOGON	;KEEP LOOPING TILL SOMETHING RECEIVED
  19:24557+16	F770  2AFEC2  		LD	HL,(IOBUFF+LEN-2)
  20:24573+10	F773  11E680  		LD	DE,80E6H
  21:24583+4	F776  B7      		OR	A
  22:24587+15	F777  ED52    		SBC	HL,DE
  23:24602+10	F779  CADEF3  		JP	Z,MINIMON	;GOTO MONITOR IF 9600 BAUD <CR>
  24:				;
  25:				;	ENTER ATARI DISK EMULATOR MODE
  26:				;
  27:24612+7	F77C  3E03    		LD	A,3
  28:     -	F77E          	SalyLOGN1:
  29:24619+13	F77E  3233FF  		LD	(RWMAX),A	;DO LESS RETRIES IN ATARI MODE
  30:     -	F781          	SalyLOGN2:
  31:24632+7	F781  3E38    		LD	A,38H		;LOAD ACC WITH 'JR C,XX' OPCODE
  32:24639+13	F783  3288F1  		LD	(KLUDGE),A	;CRIPPLE READY ERROR FROM 'SELECT'
  33:24652+11	F786  DB50    		IN	A,(SERIN)
  34:24663+8	F788  CB5F    		BIT	3,A
  35:24671+7+5	F78A  2005    		JR	NZ,HAS850	;JUMP IF 850 JUMPER PRESENT
  36:				
  37:24678+7	F78C  3EFF    		LD	A,255
  38:24685+13	F78E  3228F8  		LD	(PTRID),A	;ELSE ZAP PRINTER ID IN TABLE
  39:				
  40:24698+10	F791  21E1F7  	HAS850:	LD	HL,DUMMY
  41:24708+16	F794  2219F0  		LD	(RENEW+1),HL	;MAKE DUMMY CONSOLE RE-INIT VECTOR
  42:24724+20	F797  ED5B1930		LD	DE,(RENEW+1-0C000H)
  43:24744+4	F79B  B7      		OR	A
  44:24748+15	F79C  ED52    		SBC	HL,DE
  45:24763+7+5	F79E  280C    		JR	Z,MAIN		;JUMP IF 16K MEMORY SIZE MACHINE
  46:				
  47:     -	0001          	IF SALLYBUILD
  48:24770+10	F7A0  210034  		LD	HL, 03400h	;was 0000h, now 0800h+26*256 track buffer = 2200h
  49:24780+16	F7A3  224BFF  		LD	(PBASE),HL	;ELSE SETUP FOR 39.5K PRINTER BUFFER
  50:24796+10	F7A6  21FF8B  		LD	HL,0bfffh-3400h	;rom code up to 01000h and 2400h Trackbuffer (36*256b) 	
  51:				ELSE
  55:				ENDIF	;SALLYBUILD
  56:24806+16	F7A9  224DFF  		LD	(PSIZE),HL
  57:				
  58:24822+17	F7AC  CDD6F8  	MAIN:	CALL	SPOOLER		;KEEP BACKGROUND PRINTING GOING
  59:24839+16	F7AF  2A3AFF  		LD	HL,(FSMVEC)
  60:24855+17	F7B2  CDBDF7  		CALL	CALLHL		;DO ATARI TASK ROUTINE
  61:24872+16	F7B5  2A3CFF  		LD	HL,(EXTVEC)
  62:24888+17	F7B8  CDBDF7  		CALL	CALLHL		;DO EXTRA TASK ROUTINE
  63:24905+12	F7BB  18EF    		JR	MAIN
  64:				;
  65:				;
  66:24917+4	F7BD  E9      	CALLHL:	JP	(HL)
  67:				;
  68:				;
  69:				;
  70:     -	F7BE          	PWRWAIT:	
  71:24921+11	F7BE  DB70    		IN	A,(ATARI)
  72:24932+7	F7C0  E68A    		AND	10001010B	;MASK TO DATA/POWER/COMMAND BITS
  73:24939+7	F7C2  FE8A    		CP	10001010B	
  74:24946+5+6	F7C4  C0      		RET	NZ
  75:					
  76:24951+4	F7C5  F3      		DI
  77:24955+4	F7C6  AF      		XOR	A
  78:24959+13	F7C7  3255FF  		LD	(CMDFLG),A	;RESET COMMAND FRAME FLAG
  79:24972+11	F7CA  D357    		OUT	(CDMUX),A	;SET MUX TO GATE COMMAND LINE TO CTC0
  80:								;COMMAND-LINE is inverted and now double-inverted :-)
  81:24983+7	F7CC  3ED7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D4_RISEEDGE + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
  82:24990+11	F7CE  D380    		OUT	(CTC0),A	;RESET CTC AND ARM FOR HIGH->LOW IRQ
  83:25001+7	F7D0  3E01    		LD	A,1		;TIME CONSTANT OF 1
  84:25008+11	F7D2  D380    		OUT	(CTC0),A	;WRITE TIME CONSTANT
  85:25019+10	F7D4  2199F6  		LD	HL,CSTART
  86:25029+16	F7D7  2210FF  		LD	(CTCVEC),HL	;STORE INTERRUPT VECTOR
  87:25045+4	F7DA  FB      		EI
  88:25049+10	F7DB  21E2F7  		LD	HL,CMDWAIT
  89:25059+16	F7DE  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR TO 'CMDHIGH' STATE
  90:25075+10	F7E1  C9      	DUMMY:	RET
  91:				;
  92:				;
  93:				;
  94:     -	F7E2          	CMDWAIT:
  95:25085+13	F7E2  3A55FF  		LD	A,(CMDFLG)
  96:25098+4	F7E5  B7      		OR	A		;SEE IF COMMAND FRAME HAS ARRIVED
  97:25102+5+6	F7E6  C8      		RET	Z		;EXIT IF NOTHING HAS HAPPENED
  98:					
  99:25107+7	F7E7  FE01    		CP	1
 100:25114+7+5	F7E9  2808    		JR	Z,CMDL4		;PROCESS COMMAND IF GOOD FRAME RECVD
 101:				
 102:25121+4	F7EB  F3      		DI			;ELSE RESET INTERRUPT AND START AGAIN
 103:25125+7	F7EC  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	; SOFTWARE RESET CTC0
 104:25132+11	F7EE  D380    		OUT	(CTC0),A	;PERFORM THE RESET
 105:25143+4	F7F0  FB      		EI
 106:25147+12	F7F1  181B    		JR	CMDL5		;GO SET FSM VECTOR
 107:				;
 108:				;
 109:     -	C2FB          	CFRAME	EQU	IOBUFF+LEN-5	;COMMAND FRAME IS LAST 5 BYTES OF BUFF
 110:				;
 111:25159+13	F7F3  3AFBC2  	CMDL4:	LD	A,(CFRAME)
 112:25172+16	F7F6  2A38FF  		LD	HL,(IDPTR)	;GET POINTER TO ID CODE TABLE
 113:25188+17	F7F9  CD15F8  		CALL	SCAN		;SCAN TABLE FOR MATCHING UNIT ID CODE
 114:25205+7+5	F7FC  2010    		JR	NZ,CMDL5	;EXIT IF COMMAND IS NOT FOR US
 115:				
 116:25212+13	F7FE  3AFCC2  		LD	A,(CFRAME+1)
 117:25225+17	F801  CD15F8  		CALL	SCAN		;SCAN FOR COMMAND CODE IN TABLE
 118:25242+7+5	F804  2805    		JR	Z,CMDL4a	;CODE FOUND	
 119:25249+17	F806  CD57FC  		CALL	SENDNACK	;ERROR IF NO MATCH FOUND
 120:25266+12	F809  1803    		JR	CMDL5	
 121:				
 122:25278+17	F80B  CDBDF7  	CMDL4a:	CALL	CALLHL		;GO TO COMMAND PROCESSOR @HL
 123:				;
 124:25295+10	F80E  21BEF7  	CMDL5:	LD	HL,PWRWAIT
 125:25305+16	F811  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR BACK TO IDLE STATE
 126:25321+10	F814  C9      		RET
 127:				;
 128:				;
 129:				;
 130:				;
 131:     -	F815          	SCAN:
 132:25331+7	F815  4E      		LD	C,(HL)		;LOAD BC WITH TABLE LENGTH @HL
 133:25338+6	F816  23      		INC	HL
 134:25344+7	F817  46      		LD	B,(HL)
 135:25351+6	F818  23      		INC	HL
 136:25357+16+5	F819  EDB1    		CPIR			;SCAN STRING @HL FOR MATCH WITH ACC
 137:25373+5+6	F81B  C0      		RET	NZ		;EXIT IF NO MATCH
 138:				
 139:25378+11	F81C  F5      		PUSH	AF
 140:25389+11	F81D  09      		ADD	HL,BC		;ELSE ADD RESIDUE FROM CPIR TO HL
 141:25400+11	F81E  09      		ADD	HL,BC		;THREE TIMES TO POINT TO ADDRESS
 142:25411+11	F81F  09      		ADD	HL,BC		;CORRESPONDING TO MATCHED VALUE
 143:25422+7	F820  7E      		LD	A,(HL)
 144:25429+6	F821  23      		INC	HL
 145:25435+7	F822  66      		LD	H,(HL)
 146:25442+4	F823  6F      		LD	L,A
 147:25446+10	F824  F1      		POP	AF
 148:25456+10	F825  C9      		RET			;RETURN TABLE ENTRY IN HL
 149:				;
 150:				;
 151:				;
 152:				;	... DEVICE ID TABLE FOR DISK/PRINTER/RS232 COMBO BOX ...
 153:				;
 154:     -	F826          	IDTAB:
 155:     -	F826  0600    		DEFW	IDMAX
 156:				
 157:     -	F828  40      	PTRID:	DEFB	'@'		;PRINTER CONTROLLER ID CODE
 158:     -	F829  31      		DEFB	'1'		;DISK UNIT #1 ID CODE
 159:     -	F82A  32      		DEFB	'2'		;DISK #2
 160:     -	F82B  33      		DEFB	'3'		;DISK #3
 161:     -	F82C  34      		DEFB	'4'		;DISK #4
 162:     -	F82D  5A      		DEFB	'Z'		;Z80 LOAD/DUMP/GOTO
 163:				
 164:     -	F82E  59F8    		DEFW	Z80TAB
 165:     -	F830          	SalyDISKID:
 166:     -	F830  42F8    		DEFW	DISKTAB
 167:     -	F832  42F8    		DEFW	DISKTAB
 168:     -	F834  42F8    		DEFW	DISKTAB
 169:     -	F836  42F8    		DEFW	DISKTAB
 170:     -	F838  3AF8    		DEFW	PTRTAB
 171:     -	0006          	IDMAX	EQU	($-IDTAB)/3
 172:				;
 173:				;
 174:				;
 175:     -	F83A          	PTRTAB:				;PRINTER COMMANDS
 176:     -	F83A  0200    		DEFW	PTRMAX
 177:				
 178:     -	F83C  53      		DEFB	'S'		;PRINTER STATUS
 179:     -	F83D  57      		DEFB	'W'		;PRINTER OUTPUT
 180:				
 181:     -	F83E  7DF8    		DEFW	PTRWRITE
 182:     -	F840  67F8    		DEFW	PTRSTAT
 183:     -	0002          	PTRMAX	EQU	($-(PTRTAB+2))/3
 184:				;
 185:				;
 186:				;
 187:     -	0001          		IF SALLYRS = 0
 188:				;
 189:     -	F842          	DISKTAB:			;DISK COMMANDS
 190:     -	F842  0700    		DEFW	DISKMAX
 191:				
 192:     -	F844  52      		DEFB	'R'		;DISK READ
 193:     -	F845  53      		DEFB	'S'		;DISK STATUS
 194:     -	F846  57      		DEFB	'W'		;DISK WRITE
 195:     -	F847  50      		DEFB	'P'		;DISK PUT
 196:     -	F848  4E      		DEFB	'N'		;GET PARAMETERS
 197:     -	F849  4F      		DEFB	'O'		;PUT PARAMETERS
 198:     -	F84A  21      		DEFB	'!'		;FORMAT DISK
 199:				
 200:     -	F84B  45FB    		DEFW	DISKINIT
 201:     -	F84D  12FC    		DEFW	PUTPARAMS
 202:     -	F84F  F4FB    		DEFW	GETPARAMS
 203:     -	F851  0AF9    		DEFW	DISKPUT
 204:     -	F853  0DF9    		DEFW	DISKWRITE
 205:     -	F855  E8FA    		DEFW	DISKSTAT
 206:     -	F857  91F9    		DEFW	DISKREAD
 207:     -	0007          	DISKMAX	EQU	($-(DISKTAB+2))/3
 208:				;
 209:					ENDIF
 210:				;
 211:				;
 212:     -	F859          	Z80TAB:				;Z80 COMMANDS
 213:     -	F859  0400    		DEFW	Z80MAX
 214:				
 215:     -	F85B  52      		DEFB	'R'		;MEMORY READ
 216:     -	F85C  57      		DEFB	'W'		;MEMORY WRITE
 217:     -	F85D  53      		DEFB	'S'		;SET ADDRESS
 218:     -	F85E  47      		DEFB	'G'		;GOTO ADDRESS
 219:				
 220:     -	F85F  C6FC    		DEFW	Z80GOTO
 221:     -	F861  B8FC    		DEFW	Z80SET
 222:     -	F863  8DFC    		DEFW	Z80WRITE
 223:     -	F865  71FC    		DEFW	Z80READ
 224:     -	0004          	Z80MAX	EQU	($-(Z80TAB+2))/3
 225:				;
 226:				;
 227:				;
 229:				;
 230:				;
 231:				;	... PRINTER STATUS COMMAND PROCESSOR ...
 232:				;
 233:     -	F867          	PTRSTAT:
 234:25466+17	F867  CD5BFC  		CALL	SENDACK
 235:25483+10	F86A  2143FF  		LD	HL,PSMSG
 236:25493+10	F86D  11FCC2  		LD	DE,IOBUFF+LEN-4
 237:25503+11	F870  D5      		PUSH	DE
 238:25514+10	F871  010400  		LD	BC,4
 239:25524+16+5	F874  EDB0    		LDIR			;COPY PRINTER STATUS FRAME FROM RAM
 240:25540+10	F876  E1      		POP	HL
 241:25550+10	F877  114300  		LD	DE,'C'		;SEND PRINTER STATUS UN-INVERTED
 242:25560+10	F87A  C36CF6  		JP	SENDBUFF
 243:				;	ret
 244:				;
 245:				;
 246:				;	... PRINTER WRITE COMMAND PROCESSOR ...
 247:				;
 248:     -	F87D          	PTRWRITE:
 249:25570+17	F87D  CD5BFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 250:25587+17	F880  CDB9F6  		CALL	RECVBUFF	;GET PRINT DATA FROM SERIAL BUS
 251:25604+5+6	F883  C0      		RET	NZ		;EXIT IF ERROR OR TIMEOUT
 252:				
 253:25609+10	F884  112800  		LD	DE,40
 254:25619+4	F887  B7      		OR	A
 255:25623+15	F888  ED52    		SBC	HL,DE
 256:25638+5+6	F88A  C0      		RET	NZ		;ERROR IF RX BLOCK LENGTH <> 40 BYTES
 257:				
 258:25643+17	F88B  CD5BFC  		CALL	SENDACK		;ELSE SEND 'ACK'
 259:25660+10	F88E  2100C1  		LD	HL,IOBUFF
 260:25670+7	F891  0628    		LD	B,40
 261:25677+7	F893  7E      	PWRIT3:	LD	A,(HL)
 262:25684+7	F894  FE9B    		CP	9BH		;CHECK FOR 'ATASCII' CARRIAGE RETURN
 263:25691+7+5	F896  2005    		JR	NZ,PWRT3A
 264:				
 265:25698+10	F898  213EFF  		LD	HL,NEWLIN
 266:25708+7	F89B  46      		LD	B,(HL)		;OUTPUT PRINTER'S NEWLINE CHARACTER(S)
 267:25715+6	F89C  23      		INC	HL
 268:				
 269:25721+11	F89D  E5      	PWRT3A:	PUSH	HL
 270:25732+16	F89E  2A4FFF  		LD	HL,(PCOUNT)
 271:25748+20	F8A1  ED5B4DFF		LD	DE,(PSIZE)
 272:25768+4	F8A5  B7      		OR	A
 273:25772+15	F8A6  ED52    		SBC	HL,DE		;TEST IF PRINTER BUFFER IS FULL
 274:25787+10	F8A8  E1      		POP	HL
 275:25797+7+5	F8A9  380E    		JR	C,PWRIT4	;STORE ANOTHER CHARACTER IF NOT FULL
 276:				
 277:25804+11	F8AB  E5      		PUSH	HL
 278:25815+11	F8AC  C5      		PUSH	BC
 279:25826+17	F8AD  CDD6F8  		CALL	SPOOLER		;TRY TO CLEAR OUT BUFFER
 280:25843+10	F8B0  C1      		POP	BC
 281:25853+10	F8B1  E1      		POP	HL
 282:25863+11	F8B2  DB70    		IN	A,(ATARI)
 283:25874+7	F8B4  E602    		AND	00000010B	;TEST ATARI COMMAND LINE AND
 284:				;	JR	NZ,PWRT3A	;STAY IN LOOP IF INACTIVE
 285:25881+7+5	F8B6  28E5    		JR	Z,PWRT3A	;STAY IN LOOP IF INACTIVE
 286:				
 287:25888+10	F8B8  C9      		RET			;ELSE ABORT PRINTING AND RETURN
 288:				;
 289:25898+7	F8B9  7E      	PWRIT4:	LD	A,(HL)
 290:25905+6	F8BA  23      		INC	HL
 291:25911+11	F8BB  E5      		PUSH	HL
 292:25922+11	F8BC  C5      		PUSH	BC
 293:25933+16	F8BD  2A51FF  		LD	HL,(PINP)
 294:25949+17	F8C0  CDF6F8  		CALL	INDEX		;GET INDEX TO FIFO INPUT PLACE
 295:25966+20	F8C3  ED5351FF		LD	(PINP),DE	;STORE UPDATED INPUT OFFSET
 296:25986+7	F8C7  77      		LD	(HL),A		;STORE CHARACTER IN QUEUE
 297:25993+16	F8C8  2A4FFF  		LD	HL,(PCOUNT)
 298:26009+6	F8CB  23      		INC	HL		;BUMP FIFO CHARACTER COUNTER
 299:26015+16	F8CC  224FFF  		LD	(PCOUNT),HL
 300:26031+10	F8CF  C1      		POP	BC
 301:26041+10	F8D0  E1      		POP	HL
 302:26051+8+5	F8D1  10C0    		DJNZ	PWRIT3		;REPEAT TO END OF STRING
 303:				
 304:26059+10	F8D3  C366FC  		JP	SENDCOMP	;SEND 'COMPLETE' TO ATARI
 305:				;	ret
 306:				;
 307:				;
 308:				;
 309:     -	F8D6          	SPOOLER:
 310:26069+16	F8D6  2A4FFF  		LD	HL,(PCOUNT)
 311:26085+4	F8D9  7C      		LD	A,H
 312:26089+4	F8DA  B5      		OR	L
 313:26093+5+6	F8DB  C8      		RET	Z		;EXIT IF NO DATA IN FIFO TO PRINT
 314:				
 315:26098+17	F8DC  CD15F0  		CALL	LISTV+3
 316:26115+5+6	F8DF  C0      		RET	NZ		;EXIT IF PRINTER BUSY
 317:				
 318:26120+16	F8E0  2A53FF  		LD	HL,(POUT)
 319:26136+17	F8E3  CDF6F8  		CALL	INDEX		;GET POINTER WITH AUTO-INCREMENT
 320:26153+20	F8E6  ED5353FF		LD	(POUT),DE
 321:26173+7	F8EA  4E      		LD	C,(HL)
 322:26180+17	F8EB  CD12F0  		CALL	LISTV		;PRINT CHARACTER AND EXIT
 323:26197+16	F8EE  2A4FFF  		LD	HL,(PCOUNT)
 324:26213+6	F8F1  2B      		DEC	HL		;DIMINISH BUFFER COUNT BY ONE
 325:26219+16	F8F2  224FFF  		LD	(PCOUNT),HL
 326:26235+10	F8F5  C9      		RET
 327:				;
 328:				;
 329:				;
 330:				;
 331:     -	F8F6          	INDEX:
 332:26245+4	F8F6  EB      		EX	DE,HL
 333:26249+16	F8F7  2A4BFF  		LD	HL,(PBASE)
 334:26265+11	F8FA  19      		ADD	HL,DE		;ADD OFFSET TO FIFO BASE ADDRESS
 335:26276+11	F8FB  E5      		PUSH	HL
 336:26287+6	F8FC  13      		INC	DE		;BUMP OFFSET NOW IN DE
 337:26293+16	F8FD  2A4DFF  		LD	HL,(PSIZE)
 338:26309+4	F900  B7      		OR	A
 339:26313+15	F901  ED52    		SBC	HL,DE		;COMPARE TO MAX OFFSET VALUE
 340:26328+7+5	F903  3003    		JR	NC,INDEX2
 341:26335+10	F905  110000  		LD	DE,0		;SET OFFSET TO ZERO IF ROLL-OVER
 342:26345+10	F908  E1      	INDEX2:	POP	HL
 343:26355+10	F909  C9      		RET			;RETURN DE=OFFSET AND HL=POINTER
 344:				;
 345:				;
 346:				;
 347:				;	... DISK WRITE COMMAND PROCESSOR ...
 348:				;
 349:     -	F90A          	DISKPUT:
 350:26365+4	F90A  AF      		XOR	A
 351:26369+12	F90B  1802    		JR	DWRT0
 352:				;
 353:     -	F90D          	DISKWRITE:
 354:26381+7	F90D  3E01    		LD	A,1
 355:26388+13	F90F  32B5FF  	DWRT0:	LD	(VFLAG),A
 356:26401+17	F912  CD35FC  		CALL	DRVINDEX	;INDEX TO GET DRIVE PARAMETER POINTER
 357:26418+5+6	F915  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 358:				
 359:26423+17	F916  CD5BFC  		CALL	SENDACK
 360:26440+17	F919  CDB9F6  		CALL	RECVBUFF	;ELSE GO QUICK TO READ DATA FRAME
 361:26457+5+6	F91C  C0      		RET	NZ		;EXIT IF BAD CHECKSUM
 362:     -	F91D          	SalyDISKWRT1:
 363:26462+16	F91D  22A9FF  		LD	(LOGSIZ),HL	;SAVE DATA BLOCK LENGTH
 364:     -	F920          	SalyDISKWRT2:
 365:26478+10	F920  118000  		LD	DE,128
 366:26488+4	F923  B7      		OR	A
 367:26492+15	F924  ED52    		SBC	HL,DE		;TEST FOR 128 BYTE FRAME
 368:26507+7+5	F926  2804    		JR	Z,DWRT1
 369:26514+4	F928  B7      		OR	A
 370:26518+15	F929  ED52    		SBC	HL,DE		;TEST FOR 256 BYTE FRAME
 371:26533+5+6	F92B  C0      		RET	NZ
 372:				
 373:26538+17	F92C  CD5BFC  	DWRT1:	CALL	SENDACK		;SEND 'ACK' IF BLOCKSIZE IS 128 OR 256
 374:26555+17	F92F  CD1DFA  		CALL	SECTRAN		;SET DISK PARAMETERS FOR WRITE
 375:26572+7+5	F932  204E    		JR	NZ,DWRT4	;JUMP IF ERROR FROM 'SECTRAN'
 376:				
 377:26579+10	F934  2100C1  		LD	HL,IOBUFF
 378:26589+16	F937  229CFF  		LD	(DKIOCB+DSKPTR),HL
 379:26605+13	F93A  3AA9FF  		LD	A,(LOGSIZ)
 380:26618+4	F93D  47      		LD	B,A		;PREPARE TO COMPLIMENT DISK DATA BLOCK
 381:26622+7	F93E  7E      	DWRT2:	LD	A,(HL)
 382:26629+4	F93F  2F      		CPL
 383:26633+7	F940  77      		LD	(HL),A		;COMPLIMENT DISK DATA BLOCK
 384:26640+6	F941  23      		INC	HL
 385:26646+8+5	F942  10FA    		DJNZ	DWRT2		;REPEAT TO END OF BLOCK
 386:26654+7	F944  3E02    		LD	A,PUTSEC
 387:26661+13	F946  3298FF  		LD	(DKIOCB+DSKOP),A
 388:26674+14	F949  DD2198FF		LD	IX,DKIOCB
 389:     -	F94D          	SalyDISKWRT3:
 390:26688+17	F94D  CD0FF0  		CALL	DISKV		;CALL PHYSICAL DISK DRIVER
 391:26705+13	F950  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 392:26718+4	F953  B7      		OR	A
 393:26722+7+5	F954  202C    		JR	NZ,DWRT4	;BOMB OUT NOW IF DISK ERROR
 394:				
 395:26729+13	F956  3AB5FF  		LD	A,(VFLAG)
 396:26742+4	F959  B7      		OR	A
 397:26746+7+5	F95A  2826    		JR	Z,DWRT4		;EXIT OK IF NOT WRITE WITH VERIFY
 398:				
 399:26753+7	F95C  3E01    		LD	A,GETSEC
 400:26760+13	F95E  3298FF  		LD	(DKIOCB+DSKOP),A
 401:26773+10	F961  2100C3  		LD	HL,IOBUFF+LEN
 402:26783+16	F964  229CFF  		LD	(DKIOCB+DSKPTR),HL
 403:26799+17	F967  CD0FF0  		CALL	DISKV		;ELSE READ SECTOR BACK FOR VERIFY
 404:26816+13	F96A  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 405:26829+4	F96D  B7      		OR	A
 406:26833+7+5	F96E  2012    		JR	NZ,DWRT4	;BOMB AGAIN IF READ ERROR
 407:				
 408:26840+10	F970  2100C1  		LD	HL,IOBUFF
 409:26850+10	F973  1100C3  		LD	DE,IOBUFF+LEN
 410:26860+13	F976  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 411:26873+4	F979  47      		LD	B,A		;PREPARE TO COMPARE 128 OR 256 BYTES
 412:26877+7	F97A  1A      	DWRT3:	LD	A,(DE)
 413:26884+7	F97B  AE      		XOR	(HL)
 414:26891+7+5	F97C  200B    		JR	NZ,DWRT5
 415:26898+6	F97E  23      		INC	HL
 416:26904+6	F97F  13      		INC	DE
 417:26910+8+5	F980  10F8    		djnz	DWRT3		;fall through last time with acc=0
 418:				
 419:26918+17	F982  CDE8F9  	DWRT4:	CALL	SETSTAT		;DO STATUS SETTING STUFF
 420:26935+4	F985  7B      		LD	A,E
 421:26939+10	F986  C368FC  		JP	SENDCHAR	;SEND 'COMPLETE' OR 'ERROR' TO ATARI
 422:				;	ret
 423:				;
 424:26949+4	F989  AF      	DWRT5:	XOR	A
 425:26953+17	F98A  CD13FA  		CALL	ssts4		;set hardware status=0 but set bad r/w
 426:26970+4	F98D  7B      		LD	a,e
 427:26974+10	F98E  C368FC  		JP	sendchar
 428:				;	ret
 429:				;
 430:				;
 431:				;
 432:				;	... DISK READ COMMAND PROCESSOR ...
 433:				;
 434:     -	F991          	DISKREAD:
 435:26984+17	F991  CD35FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 436:27001+5+6	F994  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 437:				
 438:27006+17	F995  CD5BFC  		CALL	SENDACK
 439:     -	F998          	SalyDISKRD1:
 440:27023+17	F998  CD1DFA  		CALL	SECTRAN		;SET PARAMETERS FOR DISK OPERATION
 441:     -	F99B          	SalyDISKRD2:
 442:27040+11	F99B  F5      		PUSH	AF		;SAVE ERROR STATUS FROM 'SECTRAN'
 443:27051+7+5	F99C  280F    		JR	Z,DRD2		;JUMP IF PARAMS SET OK
 444:				
 445:27058+19	F99E  FD5606  		LD	D,(IY+SECLEN)
 446:27077+19	F9A1  FD5E07  		LD	E,(IY+SECLEN+1)	;LOAD DE WITH SECTOR LEN FROM 'DMATRIX'
 447:27096+4	F9A4  7A      		LD	A,D
 448:27100+4	F9A5  B3      		OR	E
 449:27104+7+5	F9A6  2009    		JR	NZ,DRD2A	;JUMP IF LENGTH <> 0
 450:				
 451:27111+10	F9A8  118000  		LD	DE,128		;ELSE REVERT TO 128 BYTES
 452:27121+12	F9AB  1804    		JR	DRD2A
 453:				;
 454:27133+20	F9AD  ED5B9EFF	DRD2:	LD	DE,(DKIOCB+DSKAUX) ;LOAD DE WITH PHYSICAL SECTOR LENGTH
 455:27153+16	F9B1  2AFDC2  	DRD2A:	LD	HL,(CFRAME+2)
 456:27169+10	F9B4  010400  		LD	BC,4
 457:27179+4	F9B7  B7      		OR	A
 458:27183+15	F9B8  ED42    		SBC	HL,BC		;TEST IF ACCESSING SECTOR# 1,2 OR 3
 459:27198+7+5	F9BA  3003    		JR	NC,DRD3		;JUMP IF NOT ACCESSING A BOOT SECTOR
 460:27205+10	F9BC  118000  		LD	DE,128
 461:27215+20	F9BF  ED53A9FF	DRD3:	LD	(LOGSIZ),DE
 462:27235+10	F9C3  2100C3  		LD	HL,IOBUFF+LEN
 463:27245+4	F9C6  B7      		OR	A
 464:27249+15	F9C7  ED52    		SBC	HL,DE		;COMPUTE STARTING PLACE IN BUFFER
 465:27264+10	F9C9  F1      		POP	AF
 466:27274+7+5	F9CA  2014    		JR	NZ,DRD4		;JUMP IF ERROR FROM 'SECTRAN' ABOVE
 467:				
 468:27281+16	F9CC  229CFF  		LD	(DKIOCB+DSKPTR),HL
 469:27297+7	F9CF  3E01    		LD	A,GETSEC
 470:27304+13	F9D1  3298FF  		LD	(DKIOCB+DSKOP),A
 471:27317+14	F9D4  DD2198FF		LD	IX,DKIOCB
 472:27331+11	F9D8  E5      		PUSH	HL
 473:     -	F9D9          	SalyDISKRD3:
 474:27342+17	F9D9  CD0FF0  		CALL	DISKV		;CALL DISK I/O HANDLER
 475:27359+10	F9DC  E1      		POP	HL
 476:27369+13	F9DD  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 477:				
 478:27382+17	F9E0  CDE8F9  	DRD4:	CALL	SETSTAT		;TEST AND STORE STATUS STUFF
 479:27399+7	F9E3  16FF    		LD	D,255		;SET MASK TO INVERT DISK DATA
 480:27406+10	F9E5  C36CF6  		JP	SENDBUFF	;SEND RESPONSE TO ATARI
 481:				;	ret
 482:				;
 483:				;
 484:				;
 485:				;	ROUTINE TO CHECK STATUS AFTER READ/WRITE
 486:				;
 487:     -	F9E8          	SETSTAT:
 488:27416+4	F9E8  B7      		OR	A
 489:27420+7+5	F9E9  200E    		JR	NZ,SSTS1	;JUMP IF SOME DISK ERROR INDICATED
 490:				
 491:27427+19	F9EB  FD770D  		LD	(IY+HDWSTS),A	;ELSE STORE ZEROS IN HARDWARE STATUS
 492:27446+7	F9EE  1E43    		LD	E,'C'		;LOAD E WITH 'COMPLETE' CHARACTER
 493:27453+23	F9F0  FDCB0C96		RES	BADRW,(IY+CMDSTS)
 494:27476+23	F9F4  FDCB0C9E		RES	WRPROT, (IY + CMDSTS)
 495:27499+10	F9F8  C9      		RET
 496:				;
 497:				;	ACC HOLDS NON-ZERO VALUE INDICATING A DISK ERROR
 498:				;
 499:27509+8	F9F9  CB77    	SSTS1:	BIT	6,A		;BIT HOLDS WPROT STATUS AFTER WRITE
 500:27517+7+5	F9FB  2806    		JR	Z,SSTS2
 501:				
 502:27524+7	F9FD  E69F    		AND	10011111B
 503:27531+23	F9FF  FDCB0CDE		SET	WRPROT, (IY + CMDSTS)
 504:				
 505:27554+8	FA03  CB6F    	SSTS2:	BIT	5,A		;HOLDS DD MARK STATUS AFTER READ
 506:27562+7+5	FA05  2802    		JR	Z,SSTS3
 507:				
 508:27569+7	FA07  F660    		OR	01100000B	;CREATE 1771 DD ADDRESS MARK STATUS
 509:				
 510:27576+4	FA09  4F      	SSTS3:	LD	C,A
 511:27580+7	FA0A  E681    		AND	10000001B	;TEST FOR 'READY' OR 'BUSY' BITS SET
 512:27587+4	FA0C  79      		LD	A,C
 513:27591+7+5	FA0D  2804    		JR	Z,SSTS4		;JUMP IF NOT READY/BUSY LOCK UP
 514:				
 515:27598+7	FA0F  E67E    		AND	01111110B	;ELSE CLEAR BOTH BITS AND REPLACE
 516:27605+7	FA11  F610    		OR	00010000B	; WITH 'RNF' ERROR BIT INSTEAD
 517:				
 518:27612+19	FA13  FD770D  	SSTS4:	LD	(IY+HDWSTS),A	;STORE HARDWARE STATUS FOR ATARI
 519:27631+7	FA16  1E45    		LD	E,'E'		;LOAD E WITH 'ERROR' CHARACTER
 520:27638+23	FA18  FDCB0CD6		SET	BADRW,(IY+CMDSTS)
 521:27661+10	FA1C  C9      		RET
 522:				;
 523:				;
 524:				;
 525:				;
 526:				;
 527:				;
 528:     -	FA1D          	SECTRAN:
 529:				;	BIT	CONFIG,(IY+FLAGS)
 530:				;	JP	NZ,STRAN3	;SKIP IF DRIVE HAS BEEN CONFIGURED
 531:				
 532:27671+13	FA1D  3A2EFF  		LD	A,(DRVOFF)
 533:27684+4	FA20  B7      		OR	A
 534:27688+7+5	FA21  2811    		JR	Z,STRAN2	;JUMP IF DRIVES HAVE NOT BEEN STOPPED
 535:				
 536:27695+4	FA23  AF      		XOR	A
 537:27699+13	FA24  322EFF  		LD	(DRVOFF),A	;CLEAR DRIVES-STOPPED FLAGS
 538:27712+10	FA27  2164FF  		LD	HL,DMATRIX+FLAGS
 539:27722+10	FA2A  111000  		LD	DE,16
 540:27732+7	FA2D  0604    		LD	B,4
 541:27739+15	FA2F  CB86    	STRAN1:	RES	FIRST,(HL)	;ZIP THRU ARRAY RESETING 'FIRST' FLAGS
 542:27754+11	FA31  19      		ADD	HL,DE		; TO FORCE MEDIA TO BE EXAMINED ANEW
 543:27765+8+5	FA32  10FB    		DJNZ	STRAN1
 544:				
 545:27773+20	FA34  FDCB0E46	STRAN2:	BIT	FIRST,(IY+FLAGS)
 546:27793+7+5	FA38  206D    		JR	NZ,STRAN3	;SKIP MEDIA CHECK IF DRIVE IS ACTIVE
 547:				
 548:27800+7	FA3A  3E03    		LD	A,GETID
 549:27807+13	FA3C  3298FF  		LD	(DKIOCB+DSKOP),A
 550:27820+13	FA3F  3A99FF  		LD	A,(DKIOCB+DSKDRV)
 551:27833+10	FA42  2120FF  		LD	HL,DRVTAB
 552:27843+4	FA45  85      		ADD	A,L
 553:27847+4	FA46  6F      		LD	L,A		;POINT TO HEAD POSITION FOR DRIVE#
 554:27851+7	FA47  7E      		LD	A,(HL)
 555:27858+7	FA48  FE50    		CP	80
 556:27865+7+5	FA4A  3801    		JR	C,STR20		;JUMP IF TRACK# IN VALID RANGE
 557:27872+4	FA4C  AF      		XOR	A		;ELSE GOTO TRACK ZERO
 558:27876+13	FA4D  329AFF  	STR20:	LD	(DKIOCB+DSKTRK),A
 559:27889+10	FA50  21ABFF  		LD	HL,IDBUF
 560:27899+16	FA53  229CFF  		LD	(DKIOCB+DSKPTR),HL
 561:27915+14	FA56  DD2198FF		LD	IX,DKIOCB
 562:27929+17	FA5A  CD0FF0  		CALL	DISKV		;READ AN ID MARK FROM CURRENT TRACK
 563:27946+13	FA5D  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 564:27959+4	FA60  B7      		OR	A
 565:27963+5+6	FA61  C0      		RET	NZ		;EXIT IF DISK ERROR ON READ-ID
 566:				;
 567:				;	ARRIVE HERE TO SET DISK PARAMS IMPLICITLY
 568:				;
 569:27968+13	FA62  3AAEFF  		LD	A,(IDBUF+3)	;GET SECTOR LENGTH BYTE FROM ID
 570:27981+17	FA65  CDDAFA  		call	getsize		;compute sector length in bytes
 571:27998+19	FA68  FD7006  		ld	(iy+seclen),b
 572:28017+19	FA6B  FD7107  		ld	(iy+seclen+1),c	;store result in 'seclen' param slot
 573:28036+13	FA6E  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 574:28049+4	FA71  07      		RLCA
 575:28053+4	FA72  07      		RLCA
 576:28057+4	FA73  07      		RLCA
 577:28061+4	FA74  2F      		CPL
 578:28065+7	FA75  E606    		AND	00000110B	;MAKE PERCOM DENSITY/SIZE BITS
 579:28072+19	FA77  FD7705  		LD	(IY+MEDIA),A
 580:28091+8	FA7A  CB4F    		BIT	SIZE,A
 581:28099+7+5	FA7C  2807    		JR	Z,STR25		;JUMP IF FIVE INCH DISK SELECTED
 582:				
 583:28106+7	FA7E  3E4D    		LD	A,77
 584:28113+10	FA80  211A00  		LD	HL,26
 585:28123+12	FA83  1805    		JR	STR26
 586:				;
 587:28135+7	FA85  3E28    	STR25:	LD	A,40
 588:28142+10	FA87  211200  		LD	HL,18
 589:28152+19	FA8A  FDBE00  	str26:	cp	(iy+ntrks)
 590:28171+7+5	FA8D  3803    		jr	c,str27		;skip if ntrks has been set > default
 591:28178+19	FA8F  FD7700  		ld	(iy+ntrks),a	;else set param to default value
 592:28197+19	FA92  FD7402  	STR27:	LD	(IY+NSECS),H
 593:28216+19	FA95  FD7503  		LD	(IY+NSECS+1),L	;STORE SECTORS PER TRACK PARAM
 594:				
 595:28235+23	FA98  FDCB0EC6		SET	FIRST,(IY+FLAGS)
 596:28258+16	FA9C  2A96FF  		LD	HL,(OLDPTR)
 597:28274+4	FA9F  7C      		LD	A,H
 598:28278+4	FAA0  B5      		OR	L
 599:28282+7+5	FAA1  2004    		JR	NZ,STRAN3	;JUMP IF NOT THE FIRST-EVER DISKOP
 600:				
 601:28289+20	FAA3  FD2296FF		LD	(OLDPTR),IY	;ELSE SET POINTER TO THIS GUYS STUFF
 602:				;
 603:				;	ARRIVE HERE TO COMPUTE TRACK/SECTOR AND SET DISK BYTECOUNT
 604:				;
 605:28309+16	FAA7  2AFDC2  	STRAN3:	LD	HL,(CFRAME+2)
 606:28325+6	FAAA  2B      		DEC	HL		;REMOVE +1 BIAS FROM SECTOR NUMBER
 607:28331+7	FAAB  1600    		LD	D,0
 608:28338+19	FAAD  FD5E03  		LD	E,(IY+NSECS+1)
 609:28357+7	FAB0  3EFF    		LD	A,-1
 610:28364+4	FAB2  3C      	STRAN4:	INC	A
 611:28368+4	FAB3  B7      		OR	A
 612:28372+15	FAB4  ED52    		SBC	HL,DE
 613:28387+7+5	FAB6  30FA    		JR	NC,STRAN4	;DIVIDE ABSOLUTE SECTOR NUMBER BY SPT
 614:28394+11	FAB8  19      		ADD	HL,DE
 615:28405+6	FAB9  23      		INC	HL		;RESTORE +1 BIAS TO SECTOR NUMBER
 616:28411+4	FABA  4D      		LD	C,L
 617:28415+10	FABB  219BFF  		LD	HL,DKIOCB+DSKSEC
 618:28425+7	FABE  71      		LD	(HL),C		;STORE PHYSICAL SECTOR#
 619:				
 620:28432+19	FABF  FDBE00  		CP	(IY+NTRKS)	;COMPARE RESULT FROM TRACK# COMPUTATION
 621:28451+7+5	FAC2  3808    		JR	C,STRAN5	; TO 'NTRKS' PARAM AND JUMP IF LESS
 622:				
 623:28458+19	FAC4  FD9600  		SUB	(IY+NTRKS)	;ELSE SUBTRACT EXTRA AND SELECT SIDE# 1
 624:28477+10	FAC7  2199FF  		LD	HL,DKIOCB+DSKDRV
 625:28487+15	FACA  CBFE    		SET	7,(HL)
 626:				
 627:28502+13	FACC  329AFF  	STRAN5:	LD	(DKIOCB+DSKTRK),A  ;STORE PHYSICAL TRACK#
 628:28515+19	FACF  FD6606  		LD	H,(IY+SECLEN)
 629:28534+19	FAD2  FD6E07  		LD	L,(IY+SECLEN+1)
 630:28553+16	FAD5  229EFF  		LD	(DKIOCB+DSKAUX),HL  ;STORE PHYSICAL SECTOR SIZE FOR I/O
 631:28569+4	FAD8  AF      		XOR	A
 632:28573+10	FAD9  C9      		RET
 633:				;
 634:				;
 635:				;
 636:     -	FADA          	getsize:
 637:28583+10	FADA  018000  		ld	bc,128
 638:28593+7	FADD  E603    		and	00000011b
 639:28600+5+6	FADF  C8      		ret	z		;sector length code=0 means 128 bytes
 640:				
 641:28605+8	FAE0  CB21    	getsz2:	sla	c
 642:28613+8	FAE2  CB10    		rl	b		;else multiply 128 by 2,4 or 8
 643:28621+4	FAE4  3D      		dec	a
 644:28625+7+5	FAE5  20F9    		jr	nz,getsz2
 645:28632+10	FAE7  C9      		ret
 646:				;
 647:				;
 648:				;
 649:				;
 650:				;
 651:				;	... DISK STATUS COMMAND PROCESSOR ...
 652:				;
 653:     -	FAE8          	DISKSTAT:
 654:28642+17	FAE8  CD35FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 655:28659+5+6	FAEB  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 656:				
 657:28664+17	FAEC  CD5BFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 658:28681+17	FAEF  CDE0FB  		CALL	HASPARMS	;CHECK IF HAS NEVER BEEN ACCESSED
 659:28698+13	FAF2  3AC9FF  		LD	A,(DRVTMR)
 660:28711+11	FAF5  F5      		PUSH	AF		;SAVE DRIVE TIMER VALUE RIGHT NOW
 661:28722+7	FAF6  3E00    		LD	A,TSTRDY
 662:28729+13	FAF8  3298FF  		LD	(DKIOCB+DSKOP),A
 663:28742+14	FAFB  DD2198FF		LD	IX,DKIOCB
 664:28756+17	FAFF  CD0FF0  		CALL	DISKV		;CALL DISK HANDLER TO GET TYPE 1 STATUS
 665:				
 666:28773+19	FB02  FD4E0C  		LD	C,(IY+CMDSTS)	;PREPARE TO DERRIVE REST OF 'CMDSTS'
 667:28792+19	FB05  FD360C00		LD	(IY+CMDSTS),0	; AND RESET OLD STATUS BITS
 668:28811+10	FB09  F1      		POP	AF
 669:28821+4	FB0A  B7      		OR	A
 670:28825+7+5	FB0B  2804    		JR	Z,DSTAT1	;JUMP IF DRIVES WERE PREVIOUSLY STOPPED
 671:				
 672:28832+8	FB0D  CBE1    		SET	ACTIVE,C
 673:28840+12	FB0F  1802    		JR	DSTAT2
 674:				;
 675:28852+8	FB11  CBA1    	DSTAT1:	RES	ACTIVE,C
 676:28860+20	FB13  FDCB0556	DSTAT2:	BIT	DENSTY,(IY+MEDIA)
 677:28880+7+5	FB17  2804    		JR	Z,DSTAT3	;JUMP IF DRIVE SET FOR SINGLE DENSITY
 678:				
 679:28887+8	FB19  CBE9    		SET	SEC256,C
 680:28895+12	FB1B  1802    		JR	DSTAT4
 681:				;
 682:28907+8	FB1D  CBA9    	DSTAT3:	RES	SEC256,C
 683:28915+20	FB1F  DDCB0876	DSTAT4:	BIT	6,(IX+DSKSTS)
 684:28935+7+5	FB23  2804    		JR	Z,DSTAT5	;JUMP IF DRIVE IS NOT WRITE PROTECTED
 685:				
 686:28942+8	FB25  CBD9    		SET	WRPROT,C
 687:28950+12	FB27  1802    		JR	DSTAT6
 688:				;
 689:28962+8	FB29  CB99    	DSTAT5:	RES	WRPROT,C
 690:28970+10	FB2B  21FCC2  	DSTAT6:	LD	HL,IOBUFF+LEN-4
 691:28980+11	FB2E  E5      		PUSH	HL
 692:28991+7	FB2F  71      		LD	(HL),C		;STORE DRIVE COMMAND STATUS IN BUFFER
 693:28998+6	FB30  23      		INC	HL
 694:29004+19	FB31  FD7E0D  		LD	A,(IY+HDWSTS)
 695:29023+4	FB34  2F      		CPL
 696:29027+7	FB35  77      		LD	(HL),A		;STORE HARDWARE POOP NEXT
 697:29034+6	FB36  23      		INC	HL
 698:29040+10	FB37  36E0    		LD	(HL),224	;STORE MAX TIMEOUT AFTER THAT
 699:29050+6	FB39  23      		INC	HL
 700:29056+13	FB3A  3A2DFF  		LD	A,(TRACK)
 701:29069+7	FB3D  77      		LD	(HL),A		;STORE TRACK# AS FOURTH BYTE
 702:29076+10	FB3E  E1      		POP	HL
 703:29086+10	FB3F  114300  		LD	DE,'C'		;SEND DISK STATUS W/O COMPLIMENT
 704:29096+10	FB42  C36CF6  		JP	SENDBUFF
 705:				;	ret
 706:				;
 707:     -	0001          		IF SALLYRS = 0
 708:				;
 709:				;
 710:				;	... DISK FORMAT COMMAND PROCESSOR ...
 711:				;
 712:     -	FB45          	DISKINIT:
 713:29106+17	FB45  CD35FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 714:29123+5+6	FB48  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 715:				
 716:29128+16	FB49  2A4FFF  		LD	HL,(PCOUNT)
 717:29144+4	FB4C  7C      		LD	A,H
 718:29148+4	FB4D  B5      		OR	L
 719:29152+5+6	FB4E  C0      		RET	NZ		;REFUSE TO FORMAT IF SPOOLER ACTIVE
 720:				
 721:29157+17	FB4F  CDE0FB  		CALL	HASPARMS
 722:29174+5+6	FB52  C8      		RET	Z		;REFUSE TO FORMAT IF PARAMS NOT SET
 723:				
 724:29179+17	FB53  CD5BFC  		CALL	SENDACK
 725:29196+7	FB56  3E00    		LD	A,TSTRDY
 726:29203+13	FB58  3298FF  		LD	(DKIOCB+DSKOP),A
 727:29216+14	FB5B  DD2198FF		LD	IX,DKIOCB
 728:29230+17	FB5F  CD0FF0  		CALL	DISKV		;CALL DRIVER TO TEST READY/WRITE PROT
 729:29247+17	FB62  CDCBF3  		CALL	STOPTMR		;THEN KILL CTC3 TO STOP DISK TIMER
 730:29264+13	FB65  3A2FFF  		LD	A,(OUTCPY)
 731:29277+20	FB68  FDCB0556		BIT	DENSTY,(IY+MEDIA)
 732:29297+7+5	FB6C  2807    		JR	Z,DINIT2
 733:				
 734:29304+8	FB6E  CBBF    		RES	7,A		;RESET DENSITY BIT OF CONTROL BYTE
 735:29312+10	FB70  2100C2  		LD	HL,IOBUFF+LEN-256
 736:29322+12	FB73  1805    		JR	DINIT3
 737:				;
 738:29334+8	FB75  CBFF    	DINIT2:	SET	7,A		;SET SD/DD BIT IF SINGLE DENSITY
 739:29342+10	FB77  2180C2  		LD	HL,IOBUFF+LEN-128
 740:     -	FB7A          	DINIT3:	;CALL	HDDISK		;set B\S 16/8Mhz 
 741:29352+13	FB7A  322FFF  		LD	(OUTCPY),A
 742:29365+11	FB7D  D330    		OUT	(LATCH),A
 743:29376+11	FB7F  E5      		PUSH	HL
 744:29387+16	FB80  22C1FF  		LD	(SEQPTR),HL	;STORE POINTER FOR BAD SECTOR LIST
 745:29403+10	FB83  210100  		LD	HL,1
 746:29413+16	FB86  22BFFF  		LD	(SEQNUM),HL	;RESET BAD SECTOR COUNTER
 747:29429+16	FB89  2A49FF  		LD	HL,(FMTPTR)
 748:29445+10	FB8C  11B6FF  		LD	DE,FMTSTUFF
 749:29455+10	FB8F  010700  		LD	BC,FMTLEN
 750:29465+4	FB92  07      		RLCA
 751:29469+4	FB93  07      		RLCA
 752:29473+7	FB94  E603    		AND	00000011B
 753:29480+7+5	FB96  2804    		JR	Z,SFMT3
 754:29487+11	FB98  09      	SFMT2:	ADD	HL,BC
 755:29498+4	FB99  3D      		DEC	A
 756:29502+7+5	FB9A  20FC    		JR	NZ,SFMT2	;INDEX TO PROPER PARAMS FOR DISK TYPE
 757:29509+16+5	FB9C  EDB0    	SFMT3:	LDIR			;THEN COPY PARAMS TO 'FMTSTUFF'
 758:29525+13	FB9E  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 759:29538+7	FBA1  E6C0    		AND	11000000B
 760:29545+7+5	FBA3  2013    		JR	NZ,DINIT6	;ERROR IF NOT READY OR WRITE PROTECTED
 761:				
 762:29552+19	FBA5  FD7E04  		ld	a,(iy+nsides)	;set for SS/DS init
 763:29571+13	FBA8  32BDFF  		ld	(sides),a
 764:29584+19	FBAB  FD7E00  		ld	a,(iy+ntrks)	;set for number of tracks
 765:29603+13	FBAE  32BEFF  		ld	(tracks),a
 766:29616+15	FBB1  FDE5    		PUSH	IY
 767:29631+17	FBB3  CDD0FC  		CALL	FORMAT		;CALL FORMAT SUBROUTINE
 768:29648+14	FBB6  FDE1    		POP	IY
 769:				
 770:29662+10	FBB8  E1      	DINIT6:	POP	HL
 771:29672+17	FBB9  CDE8F9  		CALL	SETSTAT		;UPDATE STATUS AS SPECIFIED BY ACC
 772:29689+7	FBBC  1600    		LD	D,0
 773:29696+17	FBBE  CD6CF6  		CALL	SENDBUFF	;SEND BAD SECTOR DATA FRAME
 774:29713+10	FBC1  C33CF0  		JP	ACTIVON		;THEN RESTART THE DISK TIMER
 775:				;	ret
 776:				;
 777:				;
 778:				
 779:				;
 780:				;
 781:				;
 782:     -	FBC4          	FMTS:
 783:     -	FBC4  B1FE    		DEFW	DD8N26		;DOUBLE DENSITY 8 INCH
 784:     -	FBC6  F4FE    		DEFW	SKEW17
 785:     -	FBC8  1A      		DEFB	26
 786:     -	FBC9  B028    		DEFW	10416
 787:				
 788:     -	FBCB  47FE    		DEFW	DD5N18		;DOUBLE DENSITY 5 INCH
 789:     -	FBCD  7AFE    		DEFW	SKEWDD
 790:     -	FBCF  12      		DEFB	18
 791:     -	FBD0  6A18    		DEFW	6250
 792:				
 793:     -	FBD2  8CFE    		DEFW	SD8N26		;SINGLE DENSITY 8 INCH
 794:     -	FBD4  DAFE    		DEFW	SKEW13
 795:     -	FBD6  1A      		DEFB	26
 796:     -	FBD7  5814    		DEFW	5208
 797:				
 798:     -	FBD9  28FE    		DEFW	SD5N18		;SINGLE DENSITY 5 INCH
 799:     -	FBDB  68FE    		DEFW	SKEWSD
 800:     -	FBDD  12      		DEFB	18
 801:     -	FBDE  350C    		DEFW	3125
 802:					
 803:					ENDIF
 804:				;
 805:				;
 806:				;
 807:				;
 808:     -	FBE0          	HASPARMS:
 809:29723+19	FBE0  FD7E00  		LD	A,(IY+NTRKS)
 810:29742+4	FBE3  B7      		OR	A
 811:29746+5+6	FBE4  C0      		RET	NZ		;EXIT IF PARAMS HAVE BEEN SET
 812:				
 813:29751+16	FBE5  2A96FF  		LD	HL,(OLDPTR)
 814:29767+4	FBE8  7C      		LD	A,H		;IF POINTER IS ZERO THEN NO DRIVE
 815:29771+4	FBE9  B5      		OR	L		; PARAMS HAVE EVER BEEN SET
 816:29775+5+6	FBEA  C8      		RET	Z
 817:				
 818:29780+15	FBEB  FDE5    		PUSH	IY
 819:29795+10	FBED  D1      		POP	DE
 820:29805+10	FBEE  010C00  		LD	BC,12
 821:29815+16+5	FBF1  EDB0    		LDIR			;COPY BOOT DISK'S PARAMS TO THIS GUY
 822:29831+10	FBF3  C9      		RET
 823:				;
 824:				;
 825:     -	0001          		IF SALLYRS = 0 
 826:				;
 827:				;
 828:				;	... PERCOM 'N' COMMAND PROCESSOR ...
 829:				;
 830:     -	FBF4          	GETPARAMS:
 831:29841+17	FBF4  CD35FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 832:29858+5+6	FBF7  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 833:				
 834:29863+17	FBF8  CDE0FB  		CALL	HASPARMS
 835:29880+5+6	FBFB  C8      		RET	Z		;EXIT IF DISK PARAMS NOT KNOWN
 836:				
 837:29885+17	FBFC  CD5BFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 838:				;	SET	CONFIG,(IY+FLAGS)
 839:29902+15	FBFF  FDE5    		PUSH	IY
 840:29917+10	FC01  E1      		POP	HL
 841:29927+10	FC02  11F4C2  		LD	DE,IOBUFF+LEN-12
 842:29937+11	FC05  D5      		PUSH	DE
 843:29948+10	FC06  010C00  		LD	BC,12
 844:29958+16+5	FC09  EDB0    		LDIR			;COPY PARAMS TO OUTPUT BUFFER
 845:29974+10	FC0B  E1      		POP	HL
 846:29984+10	FC0C  114300  		LD	DE,'C'
 847:29994+10	FC0F  C36CF6  		JP	SENDBUFF	;SEND 'C' AND PARAMS DATA FRAME
 848:				;	ret
 849:				
 850:					ENDIF
 851:				;
 852:				;
 853:				;
 854:				;	... PERCOM 'O' COMMAND PROCESSOR ...
 855:				;
 856:     -	FC12          	PUTPARAMS:
 857:30004+17	FC12  CD35FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 858:30021+5+6	FC15  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 859:				
 860:30026+17	FC16  CD5BFC  		CALL	SENDACK
 861:30043+17	FC19  CDB9F6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
 862:30060+5+6	FC1C  C0      		RET	NZ
 863:				
 864:30065+10	FC1D  110C00  		LD	DE,12
 865:30075+4	FC20  B7      		OR	A
 866:30079+15	FC21  ED52    		SBC	HL,DE
 867:30094+5+6	FC23  C0      		RET	NZ		;ERROR IF DATA FRAME NOT 12 BYTES
 868:				
 869:30099+17	FC24  CD5BFC  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
 870:				;	SET	CONFIG,(IY+FLAGS)  ;INDICATE DRIVE IS NOW CONFIGURED
 871:30116+10	FC27  2100C1  		LD	HL,IOBUFF
 872:30126+15	FC2A  FDE5    		PUSH	IY
 873:30141+10	FC2C  D1      		POP	DE		;POINT DE TO PARAMETERS FOR DRIVE(N)
 874:30151+10	FC2D  010C00  		LD	BC,12
 875:30161+16+5	FC30  EDB0    		LDIR			;COPY NEW STUFF IN THE PLACE	
 876:				
 877:     -	0000          		IF SALLYRS = 1	
 888:					ENDIF
 889:30177+10	FC32  C366FC  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
 890:				;	ret
 891:				;
 892:				;
 893:				;
 894:				;	... DATA STRUCTURE FOR DRIVE PARAMETER BLOCKS ...
 895:				;
 896:     -	0000          	NTRKS	EQU	0		;NUMBER OF TRACKS
 897:     -	0001          	STEPRT	EQU	1		;STEP RATE
 898:     -	0002          	NSECS	EQU	2		;SECTORS PER TRACK (HI/LOW)
 899:     -	0004          	NSIDES	EQU	4		;NUMBER OF SIDES
 900:     -	0005          	MEDIA	EQU	5		;MEDIA SIZE AND FORMAT BITS
 901:     -	0006          	SECLEN	EQU	6		;SECTOR LENGTH (HI/LOW)
 902:     -	0008          	DSKBITS	EQU	8		;MISC NAUGHTY BITS
 903:     -	0009          	SPARE0	EQU	9
 904:     -	000A          	SPARE1	EQU	10
 905:     -	000B          	SPARE2	EQU	11
 906:				
 907:     -	000C          	CMDSTS	EQU	12		;COMMAND STATUS
 908:     -	000D          	HDWSTS	EQU	13		;HARDWARE STATUS
 909:				
 910:     -	000E          	FLAGS	EQU	14		;FLAGS BYTE FOR DISK OPERATION
 911:     -	000F          	SPARE3	EQU	15
 912:				;
 913:				;
 914:				;	EQUATES FOR BITS IN 'MEDIA' BYTE
 915:				;
 916:     -	0001          	SIZE	EQU	1		;DISK SIZE (1=EIGHT, 0=FIVE)
 917:     -	0002          	DENSTY	EQU	2		;DENSITY (1=DOUBLE, 0=SINGLE)
 918:				;
 919:				;
 920:				;	EQUATES FOR BITS IN 'DSKBITS' BYTE
 921:				;
 922:     -	0006          	PRESENT	EQU	6		;DRIVE PRESENT (1=PRESENT)
 923:				;
 924:				;
 925:				;	EQUATES FOR BITS IN 'CMDSTS' BYTE
 926:				;
 927:     -	0000          	BADCMD	EQU	0		;BAD COMMAND FRAME BIT
 928:     -	0001          	BADDAT	EQU	1		;BAD DATA FRAME BIT
 929:     -	0002          	BADRW	EQU	2		;BAD READ/WRITE OPERATION BIT
 930:     -	0003          	WRPROT	EQU	3		;WRITE PROTECTED BIT
 931:     -	0004          	ACTIVE	EQU	4		;DRIVE READY INDICATOR BIT
 932:     -	0005          	SEC256	EQU	5		;LONG/SHORT SECTOR BIT
 933:				;
 934:				;
 935:				;	EQUATES FOR BITS IN 'FLAGS' BYTE
 936:				;
 937:     -	0000          	FIRST	EQU	0		;FIRST ACCESS FLAG (0=NOT ACCESSED)
 938:     -	0001          	CONFIG	EQU	1		;DRIVE CONFIGURED BIT (0=UNCONFIGED)
 939:				;
 940:				;
 941:				;
 942:				;
 943:     -	0001          		IF SALLYRS = 0
 944:				;
 945:     -	FC35          	DRVINDEX:
 946:30187+13	FC35  3AFBC2  		LD	A,(CFRAME)	;GET DRIVE# FROM COMAND FRAME
 947:30200+7	FC38  D631    		SUB	'1'
 948:30207+7	FC3A  FE04    		CP	4
 949:30214+4	FC3C  3F      		CCF
 950:30218+5+6	FC3D  D8      		RET	C		;EXIT IF NOT DRIVE 1,2,3 OR 4
 951:				
 952:30223+7	FC3E  2600    		LD	H,0
 953:30230+4	FC40  6F      		LD	L,A
 954:30234+11	FC41  29      		ADD	HL,HL
 955:30245+11	FC42  29      		ADD	HL,HL
 956:30256+11	FC43  29      		ADD	HL,HL
 957:30267+11	FC44  29      		ADD	HL,HL		;MULTIPLY DRIVE INDEX BY 16
 958:30278+10	FC45  0156FF  		LD	BC,DMATRIX
 959:30288+11	FC48  09      		ADD	HL,BC		;INDEX TO DRIVE'S PARAMETERS
 960:30299+11	FC49  E5      		PUSH	HL
 961:30310+14	FC4A  FDE1    		POP	IY		;GET POINTER INTO IY FOR RETURN
 962:30324+20	FC4C  FDCB0876		BIT	PRESENT,(IY+DSKBITS)
 963:30344+4	FC50  37      		SCF
 964:30348+5+6	FC51  C8      		RET	Z		;EXIT IT DRIVE NOT PRESENT
 965:				
 966:30353+13	FC52  3299FF  		LD	(DKIOCB+DSKDRV),A
 967:30366+4	FC55  AF      		XOR	A
 968:30370+10	FC56  C9      		RET
 969:				;
 970:					ENDIF
 971:				;
 972:				;
 973:				;
 974:     -	FC57          	SENDNACK:
 975:30380+7	FC57  2E4E    		LD	L, 'N'
 976:30387+12	FC59  1802    		JR	SENDACK1
 977:     -	FC5B          	SENDACK:
 978:30399+7	FC5B  2E41    		LD	L, 'A'
 979:     -	FC5D          	SENDACK1:
 980:30406+11	FC5D  DB70    		IN	A,(ATARI)
 981:30417+8	FC5F  CB4F    		BIT	1,A
 982:30425+7+5	FC61  28FA    		JR	Z,SENDACK1	;wait until CMD goes high
 983:				
 984:30432+4	FC63  7D      		LD	A, L
 985:30436+12	FC64  1802    		JR	SENDCHAR
 986:				;
 987:     -	FC66          	SENDCOMP:
 988:30448+7	FC66  3E43    		LD	A,'C'
 989:     -	FC68          	SENDCHAR:
 990:30455+10	FC68  2101C3  		LD	HL,IOBUFF+LEN+1
 991:30465+7	FC6B  77      		LD	(HL),A
 992:30472+7	FC6C  1600    		LD	D,0		;SET FOR TRUE DATA
 993:30479+10	FC6E  C384F6  		JP	XMITBUF		;SEND 1 BYTE BLOCK TO ATARI
 994:				;	ret
 995:				;
 996:				;
 997:				;
 998:				;
 999:				;	... Z80 MEMORY READ COMMAND PROCESSOR ...
1000:				;
1001:     -	FC71          	Z80READ:
1002:30489+17	FC71  CD5BFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND
1003:30506+17	FC74  CDAEFC  		CALL	ZLENGTH		;GET ZCMD BYTECOUNT INTO BC
1004:30523+10	FC77  2100C3  		LD	HL,IOBUFF+LEN
1005:30533+4	FC7A  B7      		OR	A
1006:30537+15	FC7B  ED42    		SBC	HL,BC
1007:30552+11	FC7D  E5      		PUSH	HL
1008:30563+4	FC7E  EB      		EX	DE,HL
1009:30567+16	FC7F  2AC4FC  		LD	HL,(MEMPTR)
1010:30583+4	FC82  F3      		DI
1011:30587+16+5	FC83  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
1012:30603+4	FC85  FB      		EI
1013:30607+10	FC86  E1      		POP	HL
1014:30617+10	FC87  114300  		LD	DE,'C'		;SEND DATA W/O INVERSION
1015:30627+10	FC8A  C36CF6  		JP	SENDBUFF
1016:				;	ret
1017:				;
1018:				;
1019:				;
1020:				;	... Z80 MEMORY WRITE COMMAND PROCESSOR ...
1021:				;
1022:     -	FC8D          	Z80WRITE:
1023:30637+17	FC8D  CD5BFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
1024:30654+17	FC90  CDB9F6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
1025:30671+5+6	FC93  C0      		RET	NZ
1026:				
1027:30676+17	FC94  CDAEFC  		CALL	ZLENGTH		;GET BYTECOUNT FROM CMD FRAME
1028:30693+4	FC97  B7      		OR	A
1029:30697+15	FC98  ED42    		SBC	HL,BC
1030:30712+5+6	FC9A  C0      		RET	NZ		;ERROR IF DATA FRAME LENGTH NOT SAME
1031:				
1032:30717+11	FC9B  C5      		PUSH	BC
1033:30728+17	FC9C  CD5BFC  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
1034:30745+10	FC9F  C1      		POP	BC
1035:30755+10	FCA0  2100C1  		LD	HL,IOBUFF
1036:30765+20	FCA3  ED5BC4FC		LD	DE,(MEMPTR)
1037:30785+4	FCA7  F3      		DI
1038:30789+16+5	FCA8  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
1039:30805+4	FCAA  FB      		EI
1040:30809+10	FCAB  C366FC  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
1041:				;	ret
1042:				;
1043:				;
1044:				;
1045:     -	FCAE          	ZLENGTH:
1046:30819+13	FCAE  3AFDC2  		LD	A,(CFRAME+2)	;GET BYTECOUNT FROM COMMAND FRAME
1047:30832+4	FCB1  4F      		LD	C,A
1048:30836+7	FCB2  0600    		LD	B,0		;LOAD BC WITH BYTECOUNT
1049:30843+4	FCB4  B7      		OR	A
1050:30847+5+6	FCB5  C0      		RET	NZ		;EXIT IF BYTECOUNT NOT=0
1051:				
1052:30852+4	FCB6  04      		INC	B		;ELSE MAKE BC=256
1053:30856+10	FCB7  C9      		RET
1054:				;
1055:				;
1056:				;	... Z80 SET MEMORY POINTER COMMAND PROCESSOR ...
1057:				;
1058:     -	FCB8          	Z80SET:
1059:30866+17	FCB8  CD5BFC  		CALL	SENDACK
1060:30883+16	FCBB  2AFDC2  		LD	HL,(CFRAME+2)	;SET MEMORY POINTER FROM COMMAND
1061:30899+16	FCBE  22C4FC  		LD	(MEMPTR),HL
1062:30915+10	FCC1  C366FC  		JP	SENDCOMP
1063:				;	ret
1064:				;
1065:				;
1066:     -	FCC4  0000    	MEMPTR:	DEFW	0		;POINTER FOR MEMORY READ/WRITE
1067:				;
1068:				;
1069:				;	... Z80 GOTO MEMORY LOCATION COMMAND PROCESSOR ...
1070:				;
1071:     -	FCC6          	Z80GOTO:
1072:30925+17	FCC6  CD5BFC  		CALL	SENDACK
1073:30942+17	FCC9  CD66FC  		CALL	SENDCOMP
1074:30959+16	FCCC  2AFDC2  		LD	HL,(CFRAME+2)
1075:30975+4	FCCF  E9      		jp	(hl)		;execute routine @hl
1076:				;
1077:				;
1078:				;
1079:				;
**** ..\src\ROM.MAC ****
  50:					INCLUDE	FORMAT.MAC
**** ..\src\FORMAT.MAC ****
   1:					;PAGE
   2:				;****************************************************************
   3:				;*								*
   4:				;*								*
   5:				;****************************************************************
   6:				;
   7:				;	... DISKETTE INITIALIZATION ROUTINE ...
   8:				;
   9:				;	'IOBUFF' UTILIZATION IN FORMAT FUNCTION:
  10:				;
  11:				;	|---------------|  IOBUFF
  12:				;	|		|
  13:				;	| BAD SEC NUMS	|	STARTS @ LEN-(128+1) OR LEN-(256+1)
  14:				;	|		|
  15:				;	|---------------|  +LEN
  16:				;	|		|
  17:				;	|  WRTTRK CODE  |	VARIABLE LENGTH HALT/NMI/OUTI ROUTINE
  18:				;	|		|
  19:				;	|---------------|  +N
  20:				;	|		|
  21:				;	|  TRACK IMAGE  |	POINTED TO BY 'TRKPTR'
  22:				;	|		|
  23:				;	|		|  +10200
  24:				;
  25:				;
  26:				;
  27:     -	FCD0          	FORMAT:
  28:30979+4	FCD0  AF      		XOR	A
  29:30983+11	FCD1  D356    		OUT	(INDXSET),A	;SET FLIPFLOP FOR NORMAL INDEX PULSES
  30:30994+4	FCD3  3C      		INC	A
  31:30998+11	FCD4  D354    		OUT	(INDXCLR),A
  32:31009+7	FCD6  3E0B    		LD	A,RSTCMD+HLOAD+STEPRATE
  33:31016+17	FCD8  CD6BF3  		CALL	TYP1CMD		;ISSUE SLOW RESTORE COMMAND
  34:31033+7	FCDB  EE04    		XOR	00000100B	;FLIP TK0 STATUS BIT
  35:31040+7	FCDD  E684    		AND	10000100B
  36:31047+10	FCDF  C2ACFD  		JP	NZ,FORMX	;EXIT IF TRACK ZERO NOT INDICATED
  37:				
  38:31057+10	FCE2  2100C3  		LD	HL,IOBUFF+LEN	;PREP TO BUILD IN-LINE CODE FOR FORMAT
  39:31067+13	FCE5  3ABCFF  		LD	A,(TRKSIZ+1)
  40:31080+4	FCE8  3C      		INC	A
  41:31084+4	FCE9  47      		LD	B,A		;LOAD B WITH # OF PAGES/TRACK PLUS ONE
  42:31088+10	FCEA  3676    	FORM2:	LD	(HL),076H	;STORE 'HALT' OPCODE
  43:31098+6	FCEC  23      		INC	HL
  44:31104+10	FCED  36ED    		LD	(HL),0EDH	;STORE 'OUTI' OPCODE BYTE #1
  45:31114+6	FCEF  23      		INC	HL
  46:31120+10	FCF0  36A3    		LD	(HL),0A3H	;STORE 'OUTI' OPCODE BYTE #2
  47:31130+6	FCF2  23      		INC	HL
  48:31136+10	FCF3  3620    		LD	(HL),020H	;STORE 'JRNZ' OPCODE BYTE
  49:31146+6	FCF5  23      		INC	HL
  50:31152+10	FCF6  36FB    		LD	(HL),-5		;STORE JUMP OFFSET FOR LOOP
  51:31162+6	FCF8  23      		INC	HL
  52:31168+8+5	FCF9  10EF    		DJNZ	FORM2
  53:31176+7	FCFB  3EC9    		LD	A,0C9H
  54:31183+7	FCFD  77      		LD	(HL),A		;STORE 'RET' OPCODE AT END
  55:31190+13	FCFE  326600  		LD	(0066H),A	;ALSO PLUNK ONE DOWN AT NMI VECTOR
  56:31203+6	FD01  23      		INC	HL
  57:31209+16	FD02  22C3FF  		LD	(TRKPTR),HL	;SAVE ADDRESS TO BEGIN TRACK IMAGE
  58:				
  59:31225+4	FD05  AF      		XOR	A
  60:31229+13	FD06  322DFF  	FORM3:	LD	(TRACK),A	;A HOLDS NEXT TRACK NUMBER
  61:31242+4	FD09  B7      		OR	A
  62:31246+7+5	FD0A  2805    		JR	Z,FORM3A	;SKIP STEP-IN IF ON TRACK ZERO
  63:31253+7	FD0C  3E4B    		LD	A,STEPIN+HLOAD+STEPRATE
  64:31260+17	FD0E  CD6BF3  		CALL	TYP1CMD		;STEP TO NEXT TRACK
  65:31277+20	FD11  DD2AB6FF	FORM3A:	LD	IX,(FRMPTR)	;GET SELECTED FORMAT DATA POINTER
  66:31297+20	FD15  FD2AB8FF		LD	IY,(SKWPTR)	;GET SELECTED SKEW TABLE POINTER
  67:31317+13	FD19  3ABDFF  		ld	a,(sides)
  68:31330+4	FD1C  1F      		rra
  69:31334+13	FD1D  3A2FFF  		ld	a,(outcpy)
  70:31347+7+5	FD20  3007    		jr	nc,form3b	;jump if not formatting both sides
  71:31354+7	FD22  EE20    		xor	00100000b
  72:31361+13	FD24  322FFF  		ld	(outcpy),a	;else flip side select bit in latch
  73:31374+11	FD27  D330    		out	(latch),a
  74:31385+17	FD29  CDB6FD  	form3b:	call	build
  75:31402+13	FD2C  3A2DFF  		LD	A,(TRACK)
  76:31415+11	FD2F  D341    		OUT	(TRKREG),A
  77:31426+16	FD31  2AC3FF  		LD	HL,(TRKPTR)	;POINT TO START OF TRACK IMAGE
  78:31442+4	FD34  F3      		DI
  79:31446+7	FD35  3EF4    		LD	A,WRTKDLY	;write track + 30ms settle delay
  80:31453+17	FD37  CD89F3  		CALL	CMDOUT		;ISSUE WRITE TRACK COMMAND
  81:31470+13	FD3A  3ABBFF  		LD	A,(TRKSIZ)
  82:31483+4	FD3D  47      		LD	B,A		;LOAD B WITH TRACK SIZE MOD 256
  83:31487+7	FD3E  0E43    		LD	C,DATREG
  84:31494+17	FD40  CD00C3  		CALL	IOBUFF+LEN	;EXECUTE WRITE TRACK FROM BUFFER
  85:31511+4	FD43  FB      		EI
  86:31515+11	FD44  DB40    	FORM4:	IN	A,(STSREG)
  87:31526+8	FD46  CB47    		BIT	0,A
  88:31534+7+5	FD48  20FA    		JR	NZ,FORM4
  89:					
  90:     -	0000          		IF	SALLYRS = 1
  93:					ENDIF
  94:					
  95:31541+20	FD4A  ED5BBFFF		LD	DE,(SEQNUM)	;LOAD DE WITH SEQUENCE NUMBER
  96:31561+16	FD4E  2AC1FF  		LD	HL,(SEQPTR)	; AND HL WITH CACA TABLE POINTER
  97:31577+13	FD51  3ABAFF  		LD	A,(NSECTS)
  98:31590+4	FD54  47      		LD	B,A
  99:31594+20	FD55  DD2AB8FF		LD	IX,(SKWPTR)	;POINT TO SECTOR TABLE
 100:31614+19	FD59  DD7E00  	FORM5:	LD	A,(IX)
 101:31633+10	FD5C  DD23    		INC	IX
 102:31643+11	FD5E  D342    		OUT	(SECREG),A
 103:31654+13	FD60  3A2FFF  		LD	A,(OUTCPY)
 104:31667+7	FD63  E620    		AND	00100000b
 105:31674+7	FD65  3E88    		LD	A,RDCMD		;determine if reading side 0 or 1
 106:31681+7+5	FD67  2802    		JR	Z,FORM51
 107:31688+8	FD69  CBCF    		SET	1,A		;WD1772 no side-no in cmd (I leave it there, doesn't seem to matter)
 108:31696+17	FD6B  CD62F3  	FORM51:	CALL	TYP2CMD		;read sector discarding the data
 109:31713+7	FD6E  E698    		AND	10011000B	;TEST FOR READY/RNF/CRC ERROR INDICATION
 110:31720+7+5	FD70  2814    		JR	Z,FORM6		;JUMP IF SECTOR READ OK
 111:				
 112:31727+7	FD72  E680    		AND	10000000B
 113:31734+7+5	FD74  2036    		JR	NZ,FORMX	;QUIT TRYING IF NOT-READY ERROR
 114:31741+11	FD76  E5      		PUSH	HL
 115:31752+11	FD77  C5      		PUSH	BC
 116:31763+10	FD78  01FDC2  		LD	BC,IOBUFF+LEN-3
 117:31773+4	FD7B  B7      		OR	A
 118:31777+15	FD7C  ED42    		SBC	HL,BC		;TEST IF CA-CA SECTOR LIST IS FULL
 119:31792+10	FD7E  C1      		POP	BC
 120:31802+10	FD7F  E1      		POP	HL
 121:31812+7+5	FD80  3004    		JR	NC,FORM6	;SKIP IF NO MORE ROOM
 122:31819+7	FD82  73      		LD	(HL),E
 123:31826+6	FD83  23      		INC	HL
 124:31832+7	FD84  72      		LD	(HL),D
 125:31839+6	FD85  23      		INC	HL		;STORE BAD SECTOR NUMBER
 126:31845+6	FD86  13      	FORM6:	INC	DE
 127:31851+8+5	FD87  10D0    		DJNZ	FORM5
 128:31859+20	FD89  ED53BFFF		LD	(SEQNUM),DE	;STORE UPDATED ERROR TRACE STUFF
 129:31879+16	FD8D  22C1FF  		LD	(SEQPTR),HL
 130:31895+13	FD90  3A2FFF  		ld	a,(outcpy)
 131:31908+7	FD93  E620    		and	00100000b
 132:31915+10	FD95  C211FD  		jp	nz,form3a	;go back and do side 0 if on side 1 now
 133:31925+13	FD98  3A2DFF  		LD	A,(TRACK)
 134:31938+4	FD9B  3C      		INC	A
 135:31942+10	FD9C  21BEFF  		ld	hl,tracks
 136:31952+7	FD9F  BE      		CP	(HL)
 137:31959+10	FDA0  DA06FD  		JP	C,FORM3		;FORMAT UP TO LAST TRACK ON DISK
 138:				
 139:31969+16	FDA3  2AC1FF  		LD	HL,(SEQPTR)
 140:31985+10	FDA6  36FF    		LD	(HL),255	;STORE TERMINATOR ON CA-CA BUFFER
 141:31995+6	FDA8  23      		INC	HL
 142:32001+10	FDA9  36FF    		LD	(HL),255
 143:32011+4	FDAB  AF      		XOR	A		;INDICATE FORMAT COMPLETED
 144:32015+11	FDAC  F5      	FORMX:	PUSH	AF
 145:32026+7	FDAD  3EFF    		LD	A,255
 146:32033+13	FDAF  322DFF  		LD	(TRACK),A
 147:32046+11	FDB2  D341    		OUT	(TRKREG),A	;FORCE DISK HANDLER TO RECALIBRATE
 148:32057+10	FDB4  F1      		POP	AF
 149:32067+10	FDB5  C9      		RET			;RETURN COMPLETION STATUS IN A
 150:				;
 151:				;
 152:				;
 153:				;
 154:				;	... SUBROUTINE TO BUILD IMAGE OF FORMATTED TRACK ...
 155:				;
 156:				;	PARAMETERS ARE:  IX ....... (POINTER TO FORMAT PARAMETERS)
 157:				;			 IY ....... (TABLE OF SECTOR NUMBERS)
 158:				;			 TRKPTR ... (POINTER TO TRACK DATA BUFFER)
 159:				;			 TRACK .... (TRACK NUMBER)
 160:				;			 NSECTS ... (NUMBER OF SECTORS)
 161:				;			 sides .... (copy of 'nsides' param)
 162:				;
 163:     -	FDB6          	BUILD:
 164:32077+13	FDB6  3ABAFF  		LD	A,(NSECTS)
 165:32090+4	FDB9  4F      		LD	C,A
 166:32094+15	FDBA  DDE5    		PUSH	IX
 167:32109+10	FDBC  E1      		POP	HL
 168:32119+7	FDBD  46      		LD	B,(HL)		;LOAD B WITH # OF FIELDS IN PREAMBLE
 169:32126+6	FDBE  23      		INC	HL
 170:32132+20	FDBF  ED5BC3FF		LD	DE,(TRKPTR)
 171:32152+17	FDC3  CD1DFE  	BUILD1:	CALL	INSERT		;INSERT FIELDS OF PREAMBLE
 172:32169+8+5	FDC6  10FB    		DJNZ	BUILD1
 173:				
 174:32177+7	FDC8  46      		LD	B,(HL)		;LOAD B WITH NUMBER OF ITEMS IN SECTOR
 175:32184+6	FDC9  23      		INC	HL
 176:32190+11	FDCA  E5      		PUSH	HL
 177:32201+14	FDCB  DDE1    		POP	IX		;IX POINTS TO START OF SECTOR POOP
 178:32215+13	FDCD  3A2DFF  	BUILD3:	LD	A,(TRACK)
 179:32228+19	FDD0  DD7707  		LD	(IX+7),A	;STORE TRACK# FOR TRACK BEING FORMATTED
 180:32247+13	FDD3  3A2FFF  		ld	a,(outcpy)
 181:32260+7	FDD6  E620    		and	00100000b
 182:32267+7	FDD8  3E00    		ld	a,0
 183:32274+7+5	FDDA  2801    		jr	z,bild31	;jump if formatting side 0
 184:32281+4	FDDC  3C      		inc	a
 185:32285+19	FDDD  DD7709  	bild31:	ld	(ix+9),a	;store side# in id
 186:32304+19	FDE0  FD7E00  		LD	A,(IY)
 187:32323+10	FDE3  FD23    		INC	IY
 188:32333+19	FDE5  DD770B  		LD	(IX+11),A	;STORE SECTOR# INTO FORMAT CONSTANTS
 189:				
 190:32352+15	FDE8  DDE5    		PUSH	IX
 191:32367+10	FDEA  E1      		POP	HL		;POINT HL TO SECTOR POOP
 192:32377+11	FDEB  C5      		PUSH	BC
 193:32388+17	FDEC  CD1DFE  	BUILD4:	CALL	INSERT
 194:32405+8+5	FDEF  10FB    		DJNZ	BUILD4		;INSERT ITEMS UP TO SECTOR DATA FIELD
 195:				
 196:32413+19	FDF1  DD7E0D  		LD	A,(IX+13)
 197:32432+17	FDF4  CDDAFA  		call	getsize		;compute sector size in bytes
 198:32449+7	FDF7  3EFF    	build6:	ld	a,0ffh
 199:32456+7	FDF9  12      		ld	(de),a		;fill sector data with ff's
 200:32463+6	FDFA  13      		INC	DE
 201:32469+6	FDFB  0B      		DEC	BC		;REPEAT TILL SECTOR IMAGE IS FILLED
 202:32475+4	FDFC  78      		LD	A,B
 203:32479+4	FDFD  B1      		OR	C
 204:32483+7+5	FDFE  20F7    		JR	NZ,BUILD6
 205:				
 206:32490+7	FE00  46      		LD	B,(HL)		;GET #FIELDS IN POST-SECTOR STUFF
 207:32497+6	FE01  23      		INC	HL
 208:32503+17	FE02  CD1DFE  	BUILD7:	CALL	INSERT		;INSERT FIELDS UP TO GAP 3
 209:32520+8+5	FE05  10FB    		DJNZ	BUILD7
 210:32528+10	FE07  C1      		POP	BC
 211:				
 212:32538+4	FE08  0D      		DEC	C
 213:32542+7+5	FE09  20C2    		JR	NZ,BUILD3
 214:				
 215:32549+16	FE0B  2AC3FF  		LD	HL,(TRKPTR)
 216:32565+10	FE0E  01D827  		LD	BC,10200
 217:32575+11	FE11  09      		ADD	HL,BC		;COMPUTE END OF LONGEST TRACK IMAGE
 218:32586+15	FE12  ED52    		SBC	HL,DE		;COMPUTE BYTES NECESSARY TO GET THERE
 219:32601+4	FE14  44      		LD	B,H
 220:32605+4	FE15  4D      		LD	C,L
 221:32609+4	FE16  62      		LD	H,D
 222:32613+4	FE17  6B      		LD	L,E
 223:32617+6	FE18  13      		INC	DE
 224:32623+7	FE19  77      		LD	(HL),A
 225:32630+16+5	FE1A  EDB0    		LDIR			;FILL REST OF BUFFER
 226:32646+10	FE1C  C9      		RET
 227:				;
 228:				;
 229:				;
 230:32656+11	FE1D  C5      	INSERT:	PUSH	BC
 231:32667+7	FE1E  46      		LD	B,(HL)
 232:32674+6	FE1F  23      		INC	HL
 233:32680+7	FE20  7E      		LD	A,(HL)
 234:32687+6	FE21  23      		INC	HL
 235:32693+7	FE22  12      	INS2:	LD	(DE),A
 236:32700+6	FE23  13      		INC	DE
 237:32706+8+5	FE24  10FC    		DJNZ	INS2
 238:32714+10	FE26  C1      		POP	BC
 239:32724+10	FE27  C9      		RET
 240:				;
 241:				;
 242:				;
 243:				;
 244:				;	... DISK FORMAT DATA TABLES FOR 5/8 DD/SD STANDARDS ...
 245:				;
 246:				;
 247:     -	FE28  01      	SD5N18:	DEFB	1
 248:     -	FE29  10FF    		DEFB	16,0FFH
 249:				
 250:     -	FE2B  0B      		DEFB	11
 251:     -	FE2C  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS TO MAKE
 252:     -	FE2E  0300    		DEFB	3,00H		; ID FIELD COME OUT IN RIGHT LOCATION)
 253:     -	FE30  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 254:     -	FE32  0100    		DEFB	1,00H		;TRACK
 255:     -	FE34  0100    		DEFB	1,00H		;SIDE
 256:     -	FE36  0100    		DEFB	1,00H		;SECTOR
 257:     -	FE38  0100    		DEFB	1,00H		;LENGTH
 258:     -	FE3A  01F7    		DEFB	1,0F7H		;GENERATE CRC
 259:     -	FE3C  0BFF    		DEFB	11,0FFH		;GAP2
 260:     -	FE3E  0600    		DEFB	6,00H		;GAP2
 261:     -	FE40  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 262:				
 263:     -	FE42  02      		DEFB	2
 264:     -	FE43  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 265:     -	FE45  09FF    		DEFB	9,0FFH		;GAP 3
 266:				;
 267:				;
 268:				;
 269:				;
 270:				;
 271:     -	FE47  01      	DD5N18:	DEFB	1
 272:     -	FE48  204E    		DEFB	32,4EH		;GAP 1
 273:				
 274:     -	FE4A  0C      		DEFB	12
 275:     -	FE4B  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 276:     -	FE4D  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 277:     -	FE4F  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 278:     -	FE51  0100    		DEFB	1,0		;TRACK#
 279:     -	FE53  0100    		DEFB	1,00000000B	;SIDE
 280:     -	FE55  0100    		DEFB	1,0		;SECTOR#
 281:     -	FE57  0101    		DEFB	1,00000001B	;LENGTH
 282:     -	FE59  01F7    		DEFB	1,0F7H		;GENERATE CRC
 283:     -	FE5B  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 284:     -	FE5D  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 285:     -	FE5F  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 286:     -	FE61  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 287:				
 288:     -	FE63  02      		DEFB	2
 289:     -	FE64  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 290:     -	FE66  104E    		DEFB	16,4EH		;FIRST PART OF GAP 3
 291:				;
 292:				;
 293:				;
 294:     -	FE68  12100E0C	SKEWSD:	DEFB	18,16,14,12,10,8,6,4,2
	              0A080604
	              02
 295:     -	FE71  110F0D0B		DEFB	17,15,13,11,9,7,5,3,1
	              09070503
	              01
 296:				;
 297:     -	FE7A  01070D  	SKEWDD:	DEFB	1,7,13
 298:     -	FE7D  060C12  		DEFB	6,12,18
 299:     -	FE80  050B11  		DEFB	5,11,17
 300:     -	FE83  040A10  		DEFB	4,10,16
 301:     -	FE86  03090F  		DEFB	3,9,15
 302:     -	FE89  02080E  		DEFB	2,8,14
 303:				;
 304:				;
 305:				;
 306:     -	FE8C  04      	SD8N26:	DEFB	4		;PREAMBLE FIELD
 307:     -	FE8D  28FF    		DEFB	40,0FFH		;GAP 4
 308:     -	FE8F  0600    		DEFB	6,00
 309:     -	FE91  01FC    		DEFB	1,0FCH		;INDEX ADDRESS MARK
 310:     -	FE93  1AFF    		DEFB	26,0FFH
 311:				
 312:     -	FE95  0B      		DEFB	11
 313:     -	FE96  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS)
 314:     -	FE98  0300    		DEFB	3,00H		;
 315:     -	FE9A  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 316:     -	FE9C  0100    		DEFB	1,00H		;TRACK
 317:     -	FE9E  0100    		DEFB	1,00H		;SIDE
 318:     -	FEA0  0100    		DEFB	1,00H		;SECTOR
 319:     -	FEA2  0100    		DEFB	1,00H		;LENGTH
 320:     -	FEA4  01F7    		DEFB	1,0F7H		;GENERATE CRC
 321:     -	FEA6  0BFF    		DEFB	11,0FFH		;GAP2
 322:     -	FEA8  0600    		DEFB	6,00H		;GAP2
 323:     -	FEAA  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 324:				
 325:     -	FEAC  02      		DEFB	2
 326:     -	FEAD  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 327:     -	FEAF  1BFF    		DEFB	27,0FFH		;GAP 3
 328:				;
 329:				;
 330:				;
 331:     -	FEB1  05      	DD8N26:	DEFB	5
 332:     -	FEB2  504E    		DEFB	80,4EH		;POST-INDEX GAP
 333:     -	FEB4  0C00    		DEFB	12,00H		;INDEX SYNC
 334:     -	FEB6  03F6    		DEFB	3,0F6H		;GENERATE SYNC=C1 HEX
 335:     -	FEB8  01FC    		DEFB	1,0FCH		;GENERATE INDEX ADDRESS MARK
 336:     -	FEBA  324E    		DEFB	50,4EH		;GAP 1
 337:				
 338:     -	FEBC  0C      		DEFB	12
 339:     -	FEBD  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 340:     -	FEBF  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 341:     -	FEC1  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 342:     -	FEC3  0100    		DEFB	1,0		;TRACK#
 343:     -	FEC5  0100    		DEFB	1,00000000B	;SIDE
 344:     -	FEC7  0100    		DEFB	1,0		;SECTOR#
 345:     -	FEC9  0101    		DEFB	1,00000001B	;LENGTH
 346:     -	FECB  01F7    		DEFB	1,0F7H		;GENERATE CRC
 347:     -	FECD  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 348:     -	FECF  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 349:     -	FED1  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 350:     -	FED3  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 351:				
 352:     -	FED5  02      		DEFB	2
 353:     -	FED6  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 354:     -	FED8  354E    		DEFB	53,4EH		;FIRST PART OF GAP 3
 355:				;
 356:				;
 357:				;
 358:     -	FEDA  010E0310	SKEW13:	DEFB	1,14,3,16,5,18,7,20,9,22,11,24,13,26
	              05120714
	              09160B18
	              0D1A
 359:     -	FEE8  020F0411		DEFB	2,15,4,17,6,19,8,21,10,23,12,25
	              06130815
	              0A170C19
 360:				;
 361:				;
 362:     -	FEF4  0112091A	SKEW17:	DEFB	1,18,9,26,17,8,25,16,7,24,15,6,23
	              11081910
	              07180F06
	              17
 363:     -	FF01  0E05160D		DEFB	14,5,22,13,4,21,12,3,20,11,2,19,10
	              04150C03
	              140B0213
	              0A
 364:				;
 365:				;
**** ..\src\ROM.MAC ****
  51:				;
  52:				;
  53:				;
  54:     -	1C21          		.DEPHASE
  55:     -	0F0E          	MONSIZE	EQU	$-MONCOPY
  56:				;
  57:				;
  58:     -	1C21          	varcopy	equ	$
  59:     -	FF20          		.phase	0ff00h+32
  60:     -	FF00          	ram	equ	$-32		;put ram on start of 256 byte page
  61:     -	FF00          	keybuf	equ	ram		;16 byte keyboard input fifo
  62:     -	FF10          	ctcvec	equ	ram+16	;8 word interrupt vector table
  63:					INCLUDE	GLOBAL.MAC	;PUT GLOBAL VARIABLES AT TOP OF RAM
**** ..\src\GLOBAL.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	GLOBAL VARIABLES FOR ATARI Z80 ROM		*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:     -	FF20          	glbvars		equ	$
   8:				;
   9:				;	... GLOBAL VARIABLES FOR PHYSICAL DISK HANDLER ...
  10:				;
  11:     -	FF20  FFFFFFFF	DRVTAB:		DEFB	255,255,255,255		;HEAD POSITIONS FOR 4 DRIVES
  12:     -	FF24  00000000			DEFB	0,0,0,0			;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
  13:     -	FF28  10101010	RATES:		DEFB	16,16,16,16		;SETTLING DELAYS / STEP RATES TABLE
  14:     -	FF2C  00      	UNIT:		DEFB	0			;CURRENTLY SELECTED DISK#
  15:     -	FF2D  FF      	TRACK:		DEFB	255			;TRACK POSITION OF SELECTED DRIVE
  16:     -	FF2E  01      	DRVOFF:		DEFB	1			;DRIVES-OFF FLAG FROM DISK TIMER IRQ
  17:     -	FF2F  00      	OUTCPY:		DEFB	00000000B		;COPY OF DISK CONTROL LATCH
  18:     -	FF30  0000    	PERIOD:		DEFW	0			;DISK SPIN PERIOD
  19:     -	FF32  32      	HLDTIM:		DEFB	50			;HEAD LOAD DELAY
  20:     -	FF33  0A      	RWMAX:		DEFB	10			;MAX NUMBER OF READ/WRITE RETRIES
  21:     -	FF34  00000000			DEFB	0,0,0,0			;ROOM FOR EXPANSION
  22:				;
  23:				;
  24:				;	... GLOBAL VARIABLES FOR ATARI HANDLER ...
  25:				;
  26:     -	FF38  26F8    	IDPTR:		DEFW	IDTAB			;POINTER TO DEVICE ID TABLE
  27:     -	FF3A  BEF7    	FSMVEC:		DEFW	PWRWAIT			;POINTER FOR ATARI TASK STATE MACHINE
  28:     -	FF3C  E1F7    	EXTVEC:		DEFW	DUMMY			;POINTER FOR EXTRA TASK PROCESSOR
  29:     -	FF3E  020D0A00	NEWLIN:		DEFB	2,CR,LF,0,0		;PRINTER NEWLINE CHARACTERS
	              00
  30:     -	FF43  00003C00	PSMSG:		DEFB	0,0,60,0		;PRINTER STATUS FRAME
  31:     -	FF47  80      	PMASKS:		DEFB	10000000B		;MASK ALL BITS BUT 'BUSY'
  32:     -	FF48  00      			DEFB	00000000B			;COMPARE TO ZERO FOR READY
  33:     -	FF49  C4FB    	FMTPTR:		DEFW	FMTS			;POINTER TO STANDARD FORMAT TABLES
  34:     -	FF4B  00C5    	PBASE:		DEFW	IOBUFF+(2*LEN)		;PUT PRINT BUFFER AFTER HERE
  35:     -	FF4D  FF0F    	PSIZE:		DEFW	4095			;MAX BUFFER INDEX OFFSET
  36:					
  37:     -	002F          	glbsize		equ	$-glbvars		;length of initialized variables
  38:     -	FF4F  73      			DEFB    73h			; **** Exists in original ROM? ****
  39:				;
  40:				;
  41:				;	*** UNINITIALIZED SCRATCH VARIABLES COME AFTER HERE ***
  42:				;
  43:     -	FF4F          	PCOUNT:		EQU 	$-1			;BYTECOUNT FOR BUFFER
  44:     -	FF51          	PINP:		EQU 	PCOUNT+2		;INPUT OFFSET
  45:     -	FF53          	POUT:		EQU 	PINP+2			;OUTPUT OFFSET
  46:     -	FF55          	CMDFLG:		EQU 	POUT+2			;COMMAND FRAME READY FLAG FROM IRQ
  47:     -	FF56          	DMATRIX:	EQU 	CMDFLG+1    		;DRIVE POOP TABLES
  48:     -	FF96          	OLDPTR:		EQU 	DMATRIX+64		;POINTER TO FIRST DRIVE ACCESSED
  49:     -	FF98          	DKIOCB:		EQU 	OLDPTR+2		;DISK I/O COMMAND BLOCK
  50:     -	FFA8          	DRWCMD:		EQU 	DKIOCB+16		;R/W COMMAND FROM ATARI TO 'DISKIO'
  51:     -	FFA9          	LOGSIZ:		EQU 	DRWCMD+1		;LOGICAL SECTOR LENGTH FOR XFER
  52:     -	FFAB          	IDBUF:		EQU	LOGSIZ+2		;BUFFER FOR ID MARK READS
  53:     -	FFB3          	IOPTR:		EQU 	IDBUF+8			;ATARI BLOCK INPUT POINTER
  54:     -	FFB5          	VFLAG:		EQU 	IOPTR+2			;VERIFY FLAG FOR DISK WRITES
  55:				
  56:				;
  57:				;
  58:				;	... VARIABLES FOR DISK FORMAT FUNCTION ...
  59:				;
  60:     -	FFB6          	FMTSTUFF:	EQU	VFLAG+1
  61:     -	FFB6          	FRMPTR:		EQU	VFLAG+1			;POINTER TO FORMAT DATA TABLE
  62:     -	FFB8          	SKWPTR:		EQU	FRMPTR+2		;POINTER TO SKEW TABLE
  63:     -	FFBA          	NSECTS:		EQU	SKWPTR+2		;NUMBER OF SECTORS
  64:     -	FFBB          	TRKSIZ:		EQU	NSECTS+1		;TRACK LENGTH IN BYTES
  65:     -	0007          	FMTLEN		EQU	(TRKSIZ+2)-FMTSTUFF
  66:						
  67:     -	FFBD          	sides:		EQU	TRKSIZ+2		;copy of 'nsides' for drive#
  68:     -	FFBE          	tracks:		EQU	sides+1			;copy of 'ntrks' for drive#
  69:     -	FFBF          	SEQNUM:		EQU	tracks+1		;TEMP SECTOR SEQUENCE NUMBER
  70:     -	FFC1          	SEQPTR:		EQU	SEQNUM+2		;TEMP ERROR LOG TABLE POINTER
  71:     -	FFC3          	TRKPTR:		EQU	SEQPTR+2		;POINTER TO START OF TRACK IMAGE
  72:				
  73:				;
  74:				;	... LOCAL VARIABLES FOR DISK HANDLER ...
  75:				;
  76:     -	FFC5          	CMDBYT:		EQU	TRKPTR+2		;COMMAND BYTE FOR READS/WRITES
  77:     -	FFC6          	RWTRY:		EQU	CMDBYT+1		;READ/WRITE RETRY COUNT
  78:     -	FFC7          	TICKS:		EQU	RWTRY+1			;FREE RUNNING MILISECOND COUNTER
  79:     -	FFC9          	DRVTMR:		EQU	TICKS+2			;DISK ACTIVITY TIMER
  80:				;
  81:				;
  82:				;
  83:				;
  84:     -	C100          	IOBUFF		EQU	0C100H			;ATARI I/O BUFFER
  85:     -	0200          	LEN		EQU	512
  86:				;
  87:     -	C300          	TRKBUF		EQU	IOBUFF+LEN		;TRACK BUFFER FOR READS
  88:				;
**** ..\src\ROM.MAC ****
  64:				;
  65:     -	1C51          		.DEPHASE
  66:				;
  67:				;
  68:     -	1C51          	LAST	EQU	$
  69:				
  70:     -	0000          		IF SALLYBUILD = 0
  76:					ELSE
  77:     -	1C51  00000000			DB 0,0,0,0,0,0,0,0,0,0,0
	              00000000
	              000000
  78:     -	1C5C  53414C4C			DB  'SALLY 1 Rev 2.00'
	              59203120
	              52657620
	              322E3030
  79:					ENDIF
  80:				
  81:     -	1C6C          	END



Statistics:

     5	passes
     0	jr promotions
   671	symbols
  7020	bytes



Symbol Table:

ACTIVE         =04        4
ACTIVON         F03C      61500
ACTIVTY         F050      61520
ACTV2           F064      61540
ASCHEX          F483      62595
ATARI          =70        112
ATROUT         =50        80
BADCMD         =00        0
BADDAT         =01        1
BADRW          =02        2
BANKSW         =52        82
BOOT            F45F      62559
BOOTCB          F47A      62586
BUILD1          FDC3      64963
BUILD3          FDCD      64973
BUILD4          FDEC      65004
BUILD7          FE02      65026
CALLHL          F7BD      63421
CDMUX          =57        87
CENT2           F4E5      62693
CENTOUT         F4DC      62684
CENTRDY         F4EB      62699
CFRAME         =C2FB      49915
CINIT2          F615      62997
CINIT3          F61A      63002
CINIT4          F61C      63004
CIV             F009      61449
CMDBYT         =FFC5      65477
CMDFLG         =FF55      65365
CMDL4           F7F3      63475
CMDL4a          F80B      63499
CMDL5           F80E      63502
CMDOUT          F389      62345
CMDREG         =40        64
CMDSTS         =0C        12
CMDT1           F38B      62347
CMDT2           F38D      62349
CMDWAIT         F7E2      63458
CONFIG         =01        1
CONIN           F640      63040
CONINIT         F5FC      62972
CONOUT          F650      63056
CONPAGE        =F500      62720
CONST           F635      63029
COUT2           F65F      63071
COV             F00C      61452
CR             =0D        13
CRLF            F4D5      62677
CSTART          F699      63129
CSTRT1          F6B4      63156
CSV             F006      61446
CTC0           =80        128
CTC1           =81        129
CTC2           =82        130
CTC3           =83        131
CTCVEC         =FF10      65296
CTC_D0_CONTROL =01        1
CTC_D0_VECTOR  =00        0
CTC_D1_SW_RST  =02        2
CTC_D2_TCNEXT  =04        4
CTC_D3_AUTOTRG =00        0
CTC_D3_CLKTRG  =08        8
CTC_D4_FALLEDGE=00        0
CTC_D4_RISEEDGE=10        16
CTC_D5_PRESC256=20        32
CTC_D5_PRESC_16=00        0
CTC_D6_MODE_CNT=40        64
CTC_D6_MODE_TIM=00        0
CTC_D7_INT_DIS =00        0
CTC_D7_INT_EN  =80        128
DATB2           F739      63289
DATBIT          F72C      63276
DATREG         =43        67
DD5N18          FE47      65095
DD8N26          FEB1      65201
DDHD           =00        0
DENSTY         =02        2
DINIT2          FB75      64373
DINIT3          FB7A      64378
DINIT6          FBB8      64440
DISK            F0B3      61619
DISK2           F0CA      61642
DISK3           F0CF      61647
DISK4           F0EE      61678
DISK4a          F100      61696
DISK5           F10F      61711
DISKDVR         F022      61474
DISKINIT        FB45      64325
DISKMAX        =07        7
DISKPUT         F90A      63754
DISKREAD        F991      63889
DISKSTAT        FAE8      64232
DISKTAB         F842      63554
DISKV           F00F      61455
DISKWRITE       F90D      63757
DISKX           F110      61712
DKIOCB         =FF98      65432
DMATRIX        =FF56      65366
DRD2            F9AD      63917
DRD2A           F9B1      63921
DRD3            F9BF      63935
DRD4            F9E0      63968
DRVINDEX        FC35      64565
DRVOFF          FF2E      65326
DRVSEL1        =01        1
DRVSEL2        =02        2
DRVSEL3        =04        4
DRVSEL4        =08        8
DRVTAB          FF20      65312
DRVTMR         =FFC9      65481
DRWCMD         =FFA8      65448
DSKAUX         =06        6
DSKBITS        =08        8
DSKDRV         =01        1
DSKOP          =00        0
DSKPTR         =04        4
DSKSEC         =03        3
DSKSTS         =08        8
DSKTRK         =02        2
DSTAT1          FB11      64273
DSTAT2          FB13      64275
DSTAT3          FB1D      64285
DSTAT4          FB1F      64287
DSTAT5          FB29      64297
DSTAT6          FB2B      64299
DTR            =55        85
DUMMY           F7E1      63457
DUMMYSYMBOL     01        1 (command line -D)
DWRT0           F90F      63759
DWRT1           F92C      63788
DWRT2           F93E      63806
DWRT3           F97A      63866
DWRT4           F982      63874
DWRT5           F989      63881
ECHO            F4B2      62642
EDGE            F1E3      61923
EDGE2           F1F4      61940
EMULATOR        F762      63330
ENDBIT          F755      63317
EXTVEC          FF3C      65340
FBS            =40        64
FDCRESET       =10        16
FDCSIDE        =20        32
FDENSITY       =80        128
FINCMD         =D0        208
FIRST          =00        0
FLAGS          =0E        14
FMTLEN         =07        7
FMTPTR          FF49      65353
FMTS            FBC4      64452
FMTSTUFF       =FFB6      65462
FORCE           F391      62353
FORM2           FCEA      64746
FORM3           FD06      64774
FORM3A          FD11      64785
FORM4           FD44      64836
FORM5           FD59      64857
FORM51          FD6B      64875
FORM6           FD86      64902
FORMAT          FCD0      64720
FORMX           FDAC      64940
FRMPTR         =FFB6      65462
FSMVEC          FF3A      65338
GETID          =03        3
GETPARAMS       FBF4      64500
GETSEC         =01        1
GOTO            F45E      62558
HAS850          F791      63377
HASPARMS        FBE0      64480
HDWSTS         =0D        13
HLDTIM          FF32      65330
HLDWAIT         F399      62361
HLOAD          =08        8
IDBUF          =FFAB      65451
IDMAX          =06        6
IDPTR           FF38      65336
IDTAB           F826      63526
INDEX           F8F6      63734
INDEX2          F908      63752
INDXCLR        =54        84
INDXSET        =56        86
INIT            00        0
INIT1           02        2
INIT2           0A        10
INITAB           B98      2968
INS2            FE22      65058
INSERT          FE1D      65053
IOBUFF         =C100      49408
IOPTR          =FFB3      65459
ITBLEN         =16        22
KEYBUF         =FF00      65280
KLUDGE          F188      61832
LAST           =1C51      7249
LATCH          =30        48
LEN            = 200      512
LF             =0A        10
LISTV           F012      61458
LOGON           F766      63334
LOGSIZ         =FFA9      65449
MAIN            F7AC      63404
MEDIA          =05        5
MEMPTR          FCC4      64708
MINIMON         F3DE      62430
MONCOPY        = D13      3347
MONITOR        =F000      61440
MONSIZE        = F0E      3854
NEWLIN          FF3E      65342
NMIVEC         =66        102
NOHIGHSPEEDSIO =00        0
NOWAITMTR      =08        8
NSECS          =02        2
NSECTS         =FFBA      65466
NTRKS          =00        0
NULL           =00        0
OLDPTR         =FF96      65430
OUTCPY          FF2F      65327
OUTPUT          F4BE      62654
PBASE           FF4B      65355
PCOUNT         =FF4F      65359
PERCONFIG      =0F        15
PERIOD          FF30      65328
PERMAXSEC      =11        17
PERSKEWTAB     =14        20
PERSTEPRATE    =13        19
PERTRACK       =10        16
PINP           =FF51      65361
PMASKS          FF47      65351
PNEXT           F4C9      62665
PNXT1           F4CA      62666
POUT           =FF53      65363
PRESENT        =06        6
PRINTER        =20        32
PROM1           F407      62471
PROM2           F419      62489
PROM3           F420      62496
PROMPT          F3F1      62449
PSIZE           FF4D      65357
PSMSG           FF43      65347
PTRID           F828      63528
PTRMAX         =02        2
PTRSTAT         F867      63591
PTRTAB          F83A      63546
PTRWRITE        F87D      63613
PUT2HS          F498      62616
PUT2HX          F49F      62623
PUT4HS          F493      62611
PUTNIB          F4A8      62632
PUTPARAMS       FC12      64530
PUTSEC         =02        2
PWRIT3          F893      63635
PWRIT4          F8B9      63673
PWRT3A          F89D      63645
PWRWAIT         F7BE      63422
RAM            =FF00      65280
RAMTST          10        16
RATES           FF28      65320
RBUFF2          F6D0      63184
RCOV2A          F332      62258
RCOV2B          F334      62260
RCOV4A          F359      62297
RCOV4B          F35B      62299
RDCMD          =88        136
RDTKDLY        =E4        228
RDTRK          =E0        224
READID          F097      61591
RECOV1          F31B      62235
RECOV2          F31F      62239
RECOV3          F342      62274
RECOVER         F30E      62222
RECVBUFF        F6B9      63161
RENEW           F018      61464
REST            75        117
REST1           7C        124
REST2           85        133
REST3           91        145
REST3A          A3        163
REST4           B6        182
REST4A          BC        188
RESTART         F01B      61467
RESTORE         F237      62007
RETI1           F5F9      62969
RIDCMD         =C0        192
RSTCMD         =00        0
RTST1           15        21
RTST2           17        23
RTST3           21        33
RW1024          F2EC      62188
RW2             F2C5      62149
RW256           F2F5      62197
RW512           F2F2      62194
RWBUSY          F2F8      62200
RWDISK          F2B5      62133
RWEXIT          F303      62211
RWMAX           FF33      65331
RWTRY          =FFC6      65478
RXB1            F6E1      63201
RXB2            F6EC      63212
RXB3            F6F1      63217
RXB35           F704      63236
RXB4            F70E      63246
RXBAUD         =F506      62726
RXBLOCK         F6D9      63193
RXDAT2          F510      62736
RXDATA          F517      62743
RXINP          =F521      62753
RXOUT           F633      63027
RXSTART         F500      62720
RXSTOP          F52C      62764
RXTEMP         =F51C      62748
SALLYBUILD     =01        1
SALLYDEBUG     =01        1
SALLYRS        =00        0
SCAN            F815      63509
SD5N18          FE28      65064
SD8N26          FE8C      65164
SEC256         =05        5
SECLEN         =06        6
SECREG         =42        66
SECTRAN         FA1D      64029
SEEK            F257      62039
SEEK1           F204      61956
SEEK2           F211      61969
SEEKTRK         F1F8      61944
SEEKX           F22E      61998
SEL4            F167      61799
SEL5            F16A      61802
SEL5A           F174      61812
SEL5B           F17E      61822
SELECT          F11A      61722
SELTAB          F198      61848
SELX            F18E      61838
SENDACK         FC5B      64603
SENDACK1        FC5D      64605
SENDBUFF        F66C      63084
SENDCHAR        FC68      64616
SENDCOMP        FC66      64614
SENDNACK        FC57      64599
SEQNUM         =FFBF      65471
SEQPTR         =FFC1      65473
SERIN          =50        80
SEROUT         =51        81
SERPAGE        =F719      63257
SETSSO          F0AB      61611
SETSTAT         F9E8      63976
SETTLE         =04        4
SFMT2           FB98      64408
SFMT3           FB9C      64412
SIDECMP        =02        2
SIDESEL        =08        8
SIOFAST        =08        8
SIONORMAL      =28        40
SIZE           =01        1
SKCMD          =10        16
SKEW13          FEDA      65242
SKEW17          FEF4      65268
SKEWDD          FE7A      65146
SKEWSD          FE68      65128
SKWPTR         =FFB8      65464
SPARE0         =09        9
SPARE1         =0A        10
SPARE2         =0B        11
SPARE3         =0F        15
SPIN            F19C      61852
SPIN2           F1B9      61881
SPIN3           F1CF      61903
SPIN4           F1DF      61919
SPINWAIT       =00        0
SPOOLER         F8D6      63702
SSTS1           F9F9      63993
SSTS2           FA03      64003
SSTS3           FA09      64009
STARBIT         F719      63257
STARTMR         F3BA      62394
STEP            F275      62069
STEPIN         =40        64
STEPOUT        =60        96
STEPRATE       =03        3
STEPRATE0      =00        0
STEPRATE1      =01        1
STEPRATE2      =02        2
STEPRATE3      =03        3
STEPRT         =01        1
STOP1A          F74E      63310
STOPB1          F73B      63291
STOPTMR         F3CB      62411
STR20           FA4D      64077
STR25           FA85      64133
STR26           FA8A      64138
STRAN1          FA2F      64047
STRAN2          FA34      64052
STRAN3          FAA7      64167
STRAN4          FAB2      64178
STRAN5          FACC      64204
STROBE         =53        83
STSREG         =40        64
SVERSION         CF4      3316
SalyDISK3       F0D5      61653
SalyDISKID      F830      63536
SalyDISKRD1     F998      63896
SalyDISKRD2     F99B      63899
SalyDISKRD3     F9D9      63961
SalyDISKWRT1    F91D      63773
SalyDISKWRT2    F920      63776
SalyDISKWRT3    F94D      63821
SalyLOGN1       F77E      63358
SalyLOGN2       F781      63361
SalyLogon        148      328
SalyRXBLOCK     F6DC      63196
SalyResetFDC    F237      62007
SalySEL4         159      345
SalySEL4A        18E      398
SalySEL4B        19B      411
SalySEL4ex       1AD      429
SalyXMITBUF     F688      63112
TDRV2           F084      61572
TESTDRV         F078      61560
TICKS          =FFC7      65479
TMRIRQ          F3D2      62418
TPCMD2          F372      62322
TPCMD3          F382      62338
TRACK           FF2D      65325
TRKBUF         =C300      49920
TRKBUFFER      =1000      4096
TRKPTR         =FFC3      65475
TRKREG         =41        65
TRKSIZ         =FFBB      65467
TSTRDY         =00        0
TXDAT0          F554      62804
TXDAT1          F566      62822
TXDAT2          F578      62840
TXDAT3          F58A      62858
TXDAT4          F59C      62876
TXDAT5          F5AE      62894
TXDAT6          F5C0      62912
TXDAT7          F5D2      62930
TXEXIT          F5EE      62958
TXSTART         F547      62791
TXSTOP          F5E0      62944
TXTMP0         =F556      62806
TXTMP1         =F568      62824
TXTMP2         =F57A      62842
TXTMP3         =F58C      62860
TXTMP4         =F59E      62878
TXTMP5         =F5B0      62896
TXTMP6         =F5C2      62914
TXTMP7         =F5D4      62932
TYP1CMD         F36B      62315
TYP2CMD         F362      62306
UNIT            FF2C      65324
VARCOPY        =1C21      7201
VERIFY          F295      62101
VFLAG          =FFB5      65461
VIEW            F430      62512
VIEW4           F456      62550
VIEW5           F458      62552
WAIT            F39E      62366
WAIT2           F39F      62367
WATCHDOG        F3A8      62376
WD1772         =00        0
WD179X         =40        64
WRPCOMP        =02        2
WRPROT         =03        3
WRTCMD         =A8        168
WRTKDLY        =F4        244
WRTRK          =F0        240
XMITBUF         F684      63108
Z80GOTO         FCC6      64710
Z80MAX         =04        4
Z80READ         FC71      64625
Z80SET          FCB8      64696
Z80TAB          F859      63577
Z80WRITE        FC8D      64653
ZEROS           45        69
ZLENGTH         FCAE      64686
adjustsiobuf     573      1395
adjustsiobuf1    57F      1407
adjustsiobuf2    587      1415
bild31          FDDD      64989
build           FDB6      64950
build6          FDF7      65015
checkmaxsec      6F2      1778
checktrack       354      852
cmdwaitfn        82C      2092
cmdwaitfn1       82C      2092
code0000        6C        108
code8000        5A        90
compbufadr       337      823
compbufadr1      352      850
compbufadr2      34E      846
compdskbuf       557      1367
compseclen       672      1650
computeflags     51E      1310
computeflags1    543      1347
computeflags3    550      1360
computeflags4    552      1362
computesecbuf    3F1      1009
dbgRWBUSY        916      2326
dcb              BDE      3038
debugtrk         A42      2626
direct           BD0      3024
diskanalyse      59C      1436
diskanalyse1     609      1545
diskanalyse10    69C      1692
diskanalyse2     5CE      1486
diskanalyse3     5DA      1498
diskanalyse4     5F8      1528
diskanalyse5     6A0      1696
diskanalyse6     65A      1626
diskanalyse7     6AC      1708
diskanalyse8     646      1606
diskanalyse9     6B6      1718
diskformat       471      1137
diskformat1      4D8      1240
diskformat2      4B4      1204
diskformat5      4B8      1208
diskformat6      4FB      1275
diskiodebug      900      2304
diskiodebug1     922      2338
diskop           7A4      1956
diskop1          7AF      1967
diskreadfn       374      884
diskreadfn2      378      888
diskreadfn3      3B0      944
diskwritefn      415      1045
diskwritefn1     42F      1071
diskwritefn2     419      1049
diskwritefn4     46A      1130
diskwritefn5     44D      1101
dloop            939      2361
dloop1           944      2372
drive            BD2      3026
drivedata        BF4      3060
dsector          BCE      3022
dskrd1           1B3      435
dskrd2           1C5      453
dskreadfn        298      664
dsktb            BAE      2990
dskwrite         280      640
dskwrite1        295      661
dumpiocb         A9B      2715
dumpline         966      2406
dumpline1        970      2416
dumpline2        98D      2445
dumpline3        997      2455
dumpline4        999      2457
dumpline5        97D      2429
dumppercom       9AE      2478
dumppercom1      A3A      2618
dumppercom2      A30      2608
dumppercom3      A09      2569
dumpsec          95C      2396
dumpsec1         95F      2399
dumpsecinv       957      2391
dwrt             21E      542
dwrta            22D      557
dwrtb            256      598
dwrtc            243      579
dwrtd            249      585
error            950      2384
error1           955      2389
fastrecv         8BC      2236
fastrecv1        8CF      2255
fastrecv2        8DE      2270
fastsend         881      2177
fastsend1        88D      2189
form3b          FD29      64809
getdrivelatch    704      1796
getdrivelatch1   70B      1803
getfdcstatus     779      1913
getperiod        719      1817
getperiod1       71C      1820
getperiod2       72C      1836
getperiod3       733      1843
getperiod4       73D      1853
getsize         FADA      64218
getskewtab       40D      1037
getspeed         361      865
getsz2          FAE0      64224
glbsize        =2F        47
glbvars        =FF20      65312
idambuf          BE7      3047
idcrc            BEB      3051
idseclen         BEA      3050
idsector         BE9      3049
idside           BE8      3048
idtrack          BE7      3047
irq4ms           8B7      2231
irq4ms1          8B9      2233
isspinning       70F      1807
match            317      791
match1           32E      814
match2           331      817
nsides         =04        4
ok               94E      2382
pokeydiv         BD1      3025
read1024         7D5      2005
read256          7DE      2014
read512          7DB      2011
readidam         796      1942
readskew         6C6      1734
readskew1        6D1      1745
readskew3        6F1      1777
readskew4        6EA      1770
readskew5        6EE      1774
readskew6        6DD      1757
readtrack        2ED      749
readtrack1       2EA      746
readtrack2       2DA      730
readtrack3       2C0      704
readtrack4       309      777
readtrack5       315      789
readtrack6       313      787
readtrk          3BC      956
readtrk1         3C9      969
readtrk2         3CF      975
readtrk3         3D8      984
restoretrack     765      1893
rxblck           8A0      2208
rxblck1          8B1      2225
sec2track        1E9      489
sec2track1       1F2      498
sec2trk          7F0      2032
sec2trk1         801      2049
sec2trk2         7F9      2041
sec2trk3         819      2073
secptr           BD4      3028
seektrack        74A      1866
seektrack1       759      1881
seraddr          B2F      2863
sercmd           AEF      2799
sercr            B27      2855
serdump          B06      2822
serdump1         B0C      2828
serdump2         B07      2823
serdumpcpl       8F7      2295
serhex           B42      2882
serhexspace      B3D      2877
serin1           B85      2949
serin2           B7C      2940
serinfn          B7B      2939
sernib           B51      2897
sernib1          B5B      2907
serout1          B68      2920
seroutfn         B5B      2907
serouthl         AFE      2814
serspace         B1F      2847
setsioerror      743      1859
shutdown        F068      61544
sides          =FFBD      65469
siobuffer        BF2      3058
siocmd           BEE      3054
siorc            BF1      3057
siosector        BEF      3055
siounit          BED      3053
skewtab          BD6      3030
ssts4           FA13      64019
str27           FA92      64146
thetrack         BD3      3027
time19600        B92      2962
time19600a       B94      2964
togglebaud       844      2116
togglebaud1      84F      2127
tracks         =FFBE      65470
trkmatch         3A8      936
trkmatch1        3FE      1022
tryidam          824      2084
waitstatus       781      1921
waitstatus1      784      1924
xmitbuffn        855      2133
xmitfast         863      2147
xmitfast1        86B      2155
