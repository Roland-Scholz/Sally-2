   1:				;
   2:     -	0001          			SALLYBUILD	EQU	1
   3:     -	0001          			WD1772		EQU	1
   4:     -	0001          			SALLYRS		EQU	1
   5:				
   6:						ASEG
   7:     -	0000          			ORG	0
   8:				;
   9:				;
  10:				;
  11:						INCLUDE EQUS.MAC
**** ..\src\EQUS.MAC ****
   1:				;--------------------------------------------------
   2:				; Equates for Sally2 Hi-Speed-SIO code
   3:				;--------------------------------------------------
   4:     -	0000          	NOHIGHSPEEDSIO		EQU	0
   5:				;
   6:				;--------------------------------------------------
   7:				; Track-Buffer 26*256 bytes
   8:				;--------------------------------------------------
   9:     -	1000          	TRKBUFFER		EQU	01000h
  10:					
  11:     -	0028          	SIONORMAL		EQU	40
  12:     -	0008          	SIOFAST			EQU	8
  13:				;--------------------------------------------------
  14:				;
  15:				;--------------------------------------------------
  16:				;
  17:				;
  18:				;
  19:     -	0020          	PRINTER			EQU	20H		;PRINTER OUTPUT/INPUTS
  20:     -	0030          	LATCH			EQU	30H		;DRIVE CONTROL LATCH
  21:     -	0040          	WD179X			EQU	40H		;WD TYPE DISK CONTROLLER
  22:				;		
  23:     -	0050          	SERIN			EQU	50H		;RS232 SERIAL INPUT
  24:				;		
  25:     -	0050          	ATROUT			EQU	50H		;ATARI SERIAL OUTPUT
  26:     -	0051          	SEROUT			EQU	51H		;RS232 SERIAL OUTPUT
  27:     -	0052          	BANKSW			EQU	52H		;ROM BANKSWITCH BIT
  28:     -	0053          	STROBE			EQU	53H		;PRINTER STROBE
  29:     -	0054          	INDXCLR			EQU	54H		;INDEX CONTROL FLOP CLEAR
  30:     -	0055          	DTR			EQU	55H		;DTR OUTPUT CONTROL
  31:     -	0056          	INDXSET			EQU	56H		;INDEX CONTROL FLOP SET
  32:     -	0057          	CDMUX			EQU	57H		;ATARI CMD/DATA MUX CONTROL
  33:				;		
  34:     -	0070          	ATARI			EQU	70H		;ATARI INPUT BITS PORT
  35:     -	0080          	CTC0			EQU	80H		;ZILOG COUNTER/TIMER 0
  36:     -	0081          	CTC1			EQU	81H		;ZILOG COUNTER/TIMER 1
  37:     -	0082          	CTC2			EQU	82H		;ZILOG COUNTER/TIMER 2
  38:     -	0083          	CTC3			EQU	83H		;ZILOG COUNTER/TIMER 3
  39:				;
  40:     -	0000          	CTC_D0_VECTOR:		EQU	00000000B	;Data is a Vector
  41:     -	0001          	CTC_D0_CONTROL:		EQU	00000001B	;Data is a Control Word
  42:     -	0002          	CTC_D1_SW_RST:		EQU	00000010B	;Perform a software reset
  43:     -	0004          	CTC_D2_TCNEXT:		EQU	00000100B	;Time Constant follows
  44:     -	0000          	CTC_D3_AUTOTRG:		EQU	00000000B	;Automatic trigger when Time Constant loaded
  45:     -	0008          	CTC_D3_CLKTRG:		EQU	00001000B	;CLK/TRIG pin pulse starts timer
  46:     -	0000          	CTC_D4_FALLEDGE:	EQU	00000000B	;CLK/TRIG edge selection - falling edge
  47:     -	0010          	CTC_D4_RISEEDGE:	EQU	00010000B	;CLK/TRIG edge selection - rising edge
  48:     -	0000          	CTC_D5_PRESC_16:	EQU	00000000B	;Timer prescaler value of 16
  49:     -	0020          	CTC_D5_PRESC256:	EQU	00100000B	;Timer prescaler value of 256
  50:     -	0000          	CTC_D6_MODE_TIM:	EQU	00000000B	;Selects Timer mode
  51:     -	0040          	CTC_D6_MODE_CNT:	EQU	01000000B	;Selects Counter mode
  52:     -	0000          	CTC_D7_INT_DIS:		EQU	00000000B	;Disables Interrupt
  53:     -	0080          	CTC_D7_INT_EN:		EQU	10000000B	;Enables Interrupt
  54:				;
  55:     -	0000          	NULL			EQU	00H
  56:     -	000D          	CR			EQU	0DH
  57:     -	000A          	LF			EQU	0AH
  58:				;
**** ..\src\sally2rs.asm ****
  12:				;--------------------------------------------------
  13:				; Code executed after Reset
  14:				;--------------------------------------------------
  15:						INCLUDE SYSINIT.MAC
**** ..\src\SYSINIT.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*							*
   4:				;********************************************************
   5:				;
   6:				;
   7:     -	0001          		SALLYDEBUG = 1
   8:				;
   9:				;
  10:				;
  11:    0+4	0000  F3      	INIT:		DI
  12:    4+4	0001  AF      			XOR	A
  13:    8+4	0002  3D      	INIT1:		DEC	A
  14:   12+7+5	0003  20FD    			JR	NZ,INIT1				;DO NOTHING FOR 1 MILLISECOND
  15:				
  16:   19+10	0005  214E0C  			LD	HL,INITAB
  17:   29+7	0008  060B    			LD	B,ITBLEN/2				;SEND INITIAL POOP TO PROGRAMABLE I/O'S
  18:   36+7	000A  4E      	INIT2:		LD	C,(HL)
  19:   43+6	000B  23      			INC	HL
  20:   49+16	000C  EDA3    			OUTI
  21:   65+7+5	000E  20FA    			JR	NZ,INIT2
  22:				;
  23:				;	PERFORM READ/WRITE TEST OF TOP 4K RAM
  24:				;
  25:   72+10	0010  2100F0  	RAMTST:		LD	HL,MONITOR
  26:   82+7	0013  3E01    			LD	A,1
  27:   89+7	0015  0610    	RTST1:		LD	B,16
  28:   96+7	0017  77      	RTST2:		LD	(HL),A					;WRITE TEST BYTE INTO MONITOR/GLOBALS
  29:  103+4	0018  07      			RLCA						;ROTATE BIT PATTERN IN A
  30:  107+4	0019  2C      			INC	L					;BUMP L TO DO INNER LOOP 256 TIMES
  31:  111+7+5	001A  20FB    			JR	NZ,RTST2
  32:  118+4	001C  24      			INC	H
  33:  122+8+5	001D  10F8    			DJNZ	RTST2					;REPEAT 16 TIMES FOR 4096 BYTES
  34:				
  35:  130+7	001F  0E10    			LD	C,16
  36:  137+6	0021  2B      	RTST3:		DEC	HL
  37:  143+4	0022  0F      			RRCA
  38:  147+7	0023  BE      			CP	(HL)					;VERIFY THAT TEST PATTERN IS WRITTEN
  39:  154+7+5	0024  20FE    			JR	NZ,$					;STICK FOREVER IF MONITOR RAM FAILURE
  40:  161+8+5	0026  10F9    			DJNZ	RTST3
  41:  169+4	0028  0D      			DEC	C
  42:  173+7+5	0029  20F6    			JR	NZ,RTST3
  43:				
  44:  180+4	002B  87      			ADD	A,A
  45:  184+7+5	002C  20E7    			JR	NZ,RTST1				;DO 8 PASSES OVER MEMORY
  46:				;
  47:				;	NOW COPY MONITOR AND VARIABLES TO HIGH RAM
  48:				;
  49:  191+10	002E  21260E  			LD	HL,MONCOPY
  50:  201+10	0031  1100F0  			LD	DE,MONITOR
  51:  211+10	0034  013B0E  			LD	BC,MONSIZE
  52:  221+16+5	0037  EDB0    			LDIR						;COPY RESIDENT CODE INTO RAM
  53:				
  54:  237+10	0039  21611C  			LD	HL,VARCOPY
  55:  247+10	003C  1120FF  			LD	DE,glbvars
  56:  257+10	003F  012F00  			LD	BC,glbsize
  57:  267+16+5	0042  EDB0    			LDIR						;INITIALIZE GLOBAL VARIABLES
  58:  283+4	0044  AF      			XOR	A
  59:  287+7	0045  12      	ZEROS:		LD	(DE),A
  60:  294+4	0046  1C      			INC	E
  61:  298+7+5	0047  20FC    			JR	NZ,ZEROS				;FILL REST OF SCRATCHPAD WITH ZEROS
  62:				
  63:     -	0001          	IF SALLYBUILD			
  64:  305+10	0049  210000  			LD	HL, 00000h				; source
  65:  315+10	004C  110080  			LD	DE, 08000h				; dest
  66:  325+10	004F  010020  			LD	BC, 02000h
  67:  335+16+5	0052  EDB0    			LDIR
  68:  351+10	0054  215A00  			LD	HL, code8000
  69:  361+8	0057  CBFC    			SET	7, H
  70:  369+4	0059  E9      			JP	(HL)
  71:     -	005A          	code8000:
  72:  373+7	005A  3E01    			LD	A, 1
  73:  380+11	005C  D352    			OUT	(BANKSW), A
  74:  391+10	005E  210080  			LD	HL, 08000h
  75:  401+10	0061  110000  			LD	DE, 00000h
  76:  411+10	0064  010020  			LD	BC, 02000h
  77:  421+16+5	0067  EDB0    			LDIR
  78:  437+10	0069  C36C00  			JP	code0000
  79:     -	006C          	code0000:
  80:				ENDIF	;SALLYBUILD
  81:				
  82:				
  83:				;
  84:				;	ESTABLISH STACK AND INTERRUPT VECTOR BASE
  85:				;
  86:  447+10	006C  3110FF  			LD	SP,KEYBUF+16				;TEMP PLACE FOR STACK
  87:  457+7	006F  3EFF    			LD	A,HIGH RAM			
  88:  464+9	0071  ED47    			LD	I,A					;POINT I REGISTER TO VECTOR TABLE
  89:  473+8	0073  ED5E    			IM	2					;SELECT VECTORED INTERRUPTS
  90:				;			
  91:				;step 5 times in and then out to trk00.  
  92:				;set bit 6 for each online floppy in ff5eh percom block (16 bytes, byte 8 bit 6)
  93:				;
  94:  481+7	0075  3E4F    	REST:		LD	A, FBS+DRVSEL4+DRVSEL3+DRVSEL2+DRVSEL1	;INITIAL DRIVE PATTERN (ALL SELECTED) - select drive 1-4, Motor off, side 0, B/S=1, DD
  95:  488+11	0077  D330    			OUT	(LATCH), A
  96:  499+4	0079  57      			LD	D,A					;KEEP PATTERN IN D (d = 4fh)
  97:  503+7	007A  0605    			LD	B,5					;step 5 times
  98:  510+7	007C  3E48    	REST1:		LD	A,STEPIN+NOWAITMTR+STEPRATE		;4b: 4 = step-in, b = NOWAITMTR+STEPRATE3
  99:				
 100:     -	0001          	IF WD1772
 101:  517+17	007E  CD400C  			CALL	SalyCMDOUT				;write A to FDC command and wait
 102:				ELSE			
 104:				ENDIF	;WD1772			
 105:							
 106:  534+8+5	0081  10F9    			DJNZ	REST1					; DRIVES THAT GET BEHIND TK0 SENSOR
 107:  542+7	0083  0664    			LD	B,100					;DO 100 STEPS TOWARD TRACK ZERO (support 100 track drives)
 108:  549+4	0085  7A      	REST2:		LD	A,D			
 109:  553+11	0086  D330    			OUT	(LATCH),A				;ISSUE SELECTS AND PAUSE A BIT
 110:  564+19	0088  E3      			EX	(SP),HL
 111:  583+19	0089  E3      			EX	(SP),HL
 112:  602+7	008A  3E68    			LD	A,STEPOUT+NOWAITMTR+STEPRATE		;6b: 6 = step-out, b = NOWAITMTR+STEPRATE3
 113:				
 114:     -	0001          	IF WD1772
 115:  609+17	008C  CD400C  			CALL	SalyCMDOUT				;write A to FDC command and wait
 116:				ELSE			
 118:				ENDIF	;WD1772			
 119:							
 120:  626+7	008F  1E01    			LD	E,DRVSEL1				;PREPARE TO TEST TK0 INDICATORS
 121:  633+4	0091  7B      	REST3:		LD	A,E			
 122:  637+7	0092  F640    			OR	FBS			
 123:  644+11	0094  D330    			OUT	(LATCH),A				;SELECT ONE DRIVE AT A TIME
 124:  655+19	0096  E3      			EX	(SP),HL					;Use this benign operation pair
 125:  674+19	0097  E3      			EX	(SP),HL					;to wait 38 T-states
 126:				
 127:     -	0001          	IF WD1772
 128:  693+11	0098  DB40    			IN	A, (STSREG)
 129:				ELSE
 131:				ENDIF	;WD1772			
 132:							
 133:  704+8	009A  CB57    			BIT	2, A			
 134:  712+7+5	009C  2804    			JR	Z,REST3A				;JUMP IF TRACK ZERO NOT INDICATED
 135:  719+4	009E  7B      			LD	A,E			
 136:  723+4	009F  2F      			CPL			
 137:  727+4	00A0  A2      			AND	D					;ELSE RESET SELECT BIT FOR DRIVE IN D
 138:  731+4	00A1  57      			LD	D,A			
 139:  735+8	00A2  CB23    	REST3A:		SLA	E					;ADVANCE SELECT BIT
 140:  743+8	00A4  CB63    			BIT	4,E			
 141:  751+7+5	00A6  28E9    			JR	Z,REST3					;DO SAME FOR ALL 4 DRIVES
 142:  758+8+5	00A8  10DB    			DJNZ	REST2					;THEN REPEAT STEP OUT 100 TIMES
 143:							
 144:     -	0001          	IF WD1772			
 145:  766+7	00AA  3E50    			LD	A, FDCRESET+FBS				;reset FDC and deselct
 146:  773+11	00AC  D330    			OUT	(LATCH), A			
 147:  784+7	00AE  3E40    			LD	A, FBS					;reset FDC and deselct
 148:  791+11	00B0  D330    			OUT	(LATCH), A			
 149:				ELSE			
 151:				ENDIF	;WD1772
 152:				
 153:     -	0001          		IF SALLYRS = 1
 154:  802+4	00B2  AF      			xor	a
 155:  806+4	00B3  47      			ld	b, a
 156:  810+10	00B4  21070D  			ld	hl, drivedata
 157:  820+7	00B7  77      	cleardrivedata:	ld	(hl), a
 158:  827+6	00B8  23      			inc	hl
 159:  833+8+5	00B9  10FC    			djnz	cleardrivedata
 160:					ENDIF
 161:				
 162:     -	0000          		IF SALLYRS = 0
 165:					ELSE
 166:  841+10	00BB  210F0D  			LD	HL, drivedata + DSKBITS
 167:  851+10	00BE  014000  			LD	BC, 64
 168:					ENDIF
 169:  861+7	00C1  3E04    			LD	A, 4					;PREP TO SET FLAGS FOR DRIVES PRESENT
 170:  868+8	00C3  CB1A    	REST4:		RR	D			
 171:  876+7+5	00C5  3802    			JR	C,REST4A				;JUMP IF DRIVE(N) NOT AT TRACK ZERO
 172:  883+15	00C7  CBF6    			SET	PRESENT,(HL)				;ELSE SET BIT IN ARRAY(HL)
 173:  898+11	00C9  09      	REST4A:		ADD	HL,BC			
 174:  909+4	00CA  3D      			DEC	 A			
 175:  913+7+5	00CB  20F6    			JR	NZ,REST4				;DO FOR ALL 4 DRIVES
 176:				;			
 177:				
 178:  920+10	00CD  3100C1  			LD	SP, IOBUFF				;NEW PLACE FOR STACK
 179:				
 180:     -	0001          	IF SALLYBUILD
 181:				;--------------------------------------------------
 182:				; firmware patch
 183:				;--------------------------------------------------
 184:  930+7	00D0  3E28    			LD	A, SIONORMAL				;init Pokey-divisor
 185:  937+13	00D2  32E40C  			LD	(pokeydiv), A
 186:						
 187:  950+7	00D5  3E02    			LD	A, 2
 188:  957+13	00D7  32E30C  			LD	(direct), A
 189:						
 190:  970+10	00DA  21FFFF  			LD	HL, 0ffffh				;reset drive / track buffer
 191:  980+16	00DD  22E50C  			LD	(drive), HL
 192:				
 193:     -	0000          		IF SALLYRS = 0
 218:					ENDIF
 219:  996+7	00E0  3EC3    			LD	A, 0c3h					;'JP' instruction
 220: 1003+13	00E2  3286F6  			LD	(XMITBUF), A
 221: 1016+13	00E5  32DBF6  			LD	(RXBLOCK), A
 222: 1029+13	00E8  32E4F7  			LD	(CMDWAIT), A
 223: 1042+13	00EB  3280F7  			LD	(SalyLOGN1), A
 224: 1055+13	00EE  3208F9  			LD	(SalyDISKWRT1), A
 225: 1068+13	00F1  3283F9  			LD	(SalyDISKRD1), A
 226:				;		LD	(DISK4),A
 227:				
 228: 1081+10	00F4  21FD08  			LD	HL, xmitbuffn
 229: 1091+16	00F7  2287F6  			LD	(XMITBUF+1), HL
 230: 1107+10	00FA  214809  			LD	HL, rxblck
 231: 1117+16	00FD  22DCF6  			LD	(RXBLOCK+1), HL
 232: 1133+10	0100  21D408  			LD	HL, cmdwaitfn
 233: 1143+16	0103  22E5F7  			LD	(CMDWAIT+1), HL
 234: 1159+10	0106  212701  			LD	HL, SalyLogon
 235: 1169+16	0109  2281F7  			LD	(SalyLOGN1+1), HL
 236: 1185+10	010C  218902  			LD	HL, dskreadfn
 237: 1195+16	010F  22C5F9  			LD	(SalyDISKRD3+1), HL
 238: 1211+10	0112  21A401  			LD	HL, dskrd1
 239: 1221+16	0115  2284F9  			LD	(SalyDISKRD1+1), HL
 240: 1237+10	0118  217102  			LD	HL, dskwrite
 241: 1247+16	011B  2239F9  			LD	(SalyDISKWRT3+1), HL
 242: 1263+10	011E  210F02  			LD	HL, dwrt
 243: 1273+16	0121  2209F9  			LD	(SalyDISKWRT1+1), HL
 244:				;		LD	HL, diskiodebug
 245:				;		LD	(DISK4+1),HL
 246:				
 247:				
 248:				ENDIF	;SALLYBUILD
 249:				
 250: 1289+10	0124  C364F7  			JP	EMULATOR				;GO INITIALIZE FOR ATARI OR CP/M
 251:				
 252:				
 253:     -	0001          	IF SALLYBUILD
 254:				
 255:     -	0127          	SalyLogon:
 256: 1299+13	0127  3233FF  			LD	(RWMAX),A				;DO LESS RETRIES IN ATARI MODE
 257:				
 258: 1312+7	012A  3EC3    			LD	A, 0c3h					;'JP' instruction
 259: 1319+13	012C  3257F1  			LD	(SEL4), A
 260: 1332+10	012F  214A01  			LD	HL, SalySEL4
 261: 1342+16	0132  2258F1  			LD	(SEL4+1), HL
 262:     -	0001          		IF WD1772
 263: 1358+10	0135  213E01  			LD	HL, SalyShutdn
 264: 1368+16	0138  2269F0  			LD	(SHUTDOWN+1), HL
 265:					ENDIF
 266: 1384+10	013B  C383F7  			JP	SalyLOGN2
 267:				
 268:     -	0001          		IF WD1772
 269:					
 270:     -	013E          	SalyShutdn:
 271: 1394+17	013E  CD1FF2  			CALL	SalyResetFDC
 272: 1411+7	0141  3E07    			LD	A, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 273: 1418+11	0143  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
 274: 1429+7	0145  3E01    			LD	A, 1					;TIME CONSTANT OF 1 - 4uS pulses (1/4Mhz)*16
 275: 1436+11	0147  D381    			OUT	(CTC1), A
 276: 1447+10	0149  C9      			RET
 277:					ENDIF
 278:				;
 279:				;
 280:				;
 281:     -	014A          	SalySEL4:
 282: 1457+8	014A  CB70    			BIT	6, B					;8" found?
 283: 1465+7+5	014C  2850    			JR	Z, SalySEL4ex				;yes, do nothing
 284:				
 285: 1472+11	014E  C5      			PUSH	BC					;save registers
 286: 1483+11	014F  D5      			PUSH	DE
 287: 1494+11	0150  E5      			PUSH	HL
 288: 1505+15	0151  DDE5    			PUSH	IX
 289:				
 290: 1520+4	0153  78      			LD	A, B					;switch HD on
 291: 1524+8	0154  CBB7    			RES	6, A
 292: 1532+11	0156  D330    			OUT	(LATCH), A
 293:				
 294: 1543+15	0158  DDE5    			PUSH	IX					;load HL with IX
 295: 1558+10	015A  E1      			POP	HL
 296: 1568+10	015B  11F10C  			LD	DE, dcb
 297: 1578+10	015E  010900  			LD	BC, 9
 298: 1588+16+5	0161  EDB0    			LDIR						;copy dcb
 299:							
 300: 1604+14	0163  DD21F10C			LD	IX, dcb
 301: 1618+10	0167  21FA0C  			LD	HL, idambuf
 302: 1628+16	016A  22F50C  			LD	(dcb + DSKPTR), HL
 303: 1644+10	016D  210600  			LD	HL, 6
 304: 1654+16	0170  22F70C  			LD	(dcb + DSKAUX), HL
 305: 1670+7	0173  3EC4    			LD	A, RIDCMD+4				;read address + settle delay
 306: 1677+13	0175  32C5FF  			LD	(CMDBYT), A
 307: 1690+7	0178  3E18    			LD	A, 018h					;substitute JR	Z,xx by JR xx
 308: 1697+13	017A  32F0F0  			LD	(DISK3 + 031h), A
 309: 1710+7	017D  0603    			LD	B, 3
 310:     -	017F          	SalySEL4A:
 311: 1717+11	017F  C5      			PUSH	BC
 312: 1728+17	0180  CDC5F0  			CALL	SalyDISK3				;DISK3: READ 6 BYTE ID RECORD
 313: 1745+10	0183  C1      			POP	BC
 314: 1755+13	0184  3AF90C  			LD	A, (dcb + DSKSTS)
 315: 1768+4	0187  B7      			OR	A
 316: 1772+7+5	0188  2802    			JR	Z, SalySEL4B
 317: 1779+8+5	018A  10F3    			DJNZ	SalySEL4A
 318:				
 319: 1787+7	018C  3E28    	SalySEL4B:	LD	A, 028h					;reset JR Z,xx
 320: 1794+13	018E  32F0F0  			LD	(DISK3 + 031h), A
 321:							
 322: 1807+14	0191  DDE1    			POP	IX
 323: 1821+10	0193  E1      			POP	HL
 324: 1831+10	0194  D1      			POP	DE
 325: 1841+10	0195  C1      			POP	BC
 326: 1851+13	0196  3AF90C  			LD	A, (dcb + DSKSTS)			;check disk status
 327: 1864+4	0199  B7      			OR	A
 328: 1868+7+5	019A  2002    			JR	NZ, SalySEL4ex				;not zero, no HD
 329: 1875+8	019C  CBB0    			RES	6, B					;
 330:     -	019E          	SalySEL4ex:             
 331: 1883+4	019E  78      			LD	A, B
 332: 1887+7	019F  1600    			LD	D, 0
 333: 1894+10	01A1  C35AF1  			JP	SEL5
 334:				
 335:				;--------------------------------------------------
 336:				; hook for read directSector if aux1/2 = 0
 337:				;--------------------------------------------------
 338:     -	01A4          	dskrd1:
 339: 1904+7	01A4  3E02    			LD	A, 2
 340: 1911+13	01A6  32E30C  			LD	(direct), A				;clear direct
 341:				
 342: 1924+16	01A9  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2, test if zero
 343: 1940+4	01AC  7D      			LD	A, L
 344: 1944+4	01AD  B4      			OR	H
 345: 1948+7+5	01AE  2806    			JR	Z, dskrd2				;if zero, use direct sector number
 346: 1955+17	01B0  CD08FA  			CALL	SECTRAN					;else use original code, call SECTRAN
 347: 1972+10	01B3  C386F9  			JP	SalyDISKRD2				;and procees
 348:				
 349:     -	01B6          	dskrd2:
 350: 1982+14	01B6  DD2198FF			LD	IX, DKIOCB
 351: 1996+19	01BA  DD360000			LD	(IX + DSKOP), TSTRDY
 352:				;		CALL	dumpdcb
 353: 2015+11	01BE  E5      			PUSH	HL
 354: 2026+17	01BF  CD0FF0  			CALL	DISKV
 355: 2043+10	01C2  E1      			POP	HL
 356:				
 357: 2053+17	01C3  CDDA01  			CALL	sec2track				;compute sector, track, side from direct sector
 358: 2070+19	01C6  DD360001			LD	(IX + DSKOP), GETSEC
 359:				;		CALL	dumpdcb
 360: 2089+11	01CA  E5      			PUSH	HL
 361: 2100+17	01CB  CD8902  			CALL	dskreadfn				;CALL DISK I/O HANDLER
 362: 2117+10	01CE  E1      			POP	HL
 363:				
 364: 2127+13	01CF  3AA0FF  			LD	A, (DKIOCB+DSKSTS)
 365: 2140+17	01D2  CDD3F9  			CALL	SETSTAT					;call SETSTAT
 366: 2157+7	01D5  1600    			LD	D, 0					;no invert
 367: 2164+10	01D7  C36EF6  			JP	SENDBUFF				;jump SENDBUFF
 368:				
 369:				;--------------------------------------------------
 370:				;compute sector, track, side from direct sector
 371:				;--------------------------------------------------
 372:     -	01DA          	sec2track:
 373: 2174+4	01DA  AF      			XOR	A					;clear carry and a
 374: 2178+7	01DB  06FF    			LD	B, 0ffh					;also b
 375: 2185+16	01DD  2AE10C  			LD	HL, (dsector)				;compute track and side numer
 376: 2201+10	01E0  111200  			LD	DE, 18					;18 secs per track
 377:     -	01E3          	sec2track1:             
 378: 2211+4	01E3  04      			INC	B					;b holds track-number
 379: 2215+15	01E4  ED52    			sbc	HL, DE
 380: 2230+7+5	01E6  30FB    			JR	NC, sec2track1				;subtract 18 as long carry clear
 381: 2237+4	01E8  7D      			LD	A, L
 382: 2241+7	01E9  C613    			ADD	19					;add 19 to get sector number + 1
 383: 2248+13	01EB  329BFF  			LD	(DKIOCB+DSKSEC), A
 384: 2261+8	01EE  CB38    			SRL	B					;divide track by two, (we have two sides)
 385: 2269+4	01F0  78      			LD	A, B
 386: 2273+13	01F1  329AFF  			LD	(DKIOCB+DSKTRK), A
 387: 2286+4	01F4  1F      			RRA						;shift-in side-number from previously lowest-bit
 388: 2290+7	01F5  E680    			AND	080h					;mask out bit 0-6
 389: 2297+10	01F7  2199FF  			LD	HL, DKIOCB+DSKDRV
 390: 2307+15	01FA  CBBE    			RES	7, (HL)
 391: 2322+7	01FC  B6      			OR	(HL)
 392: 2329+7	01FD  77      			LD	(HL), A
 393:							
 394:				;		CALL	serhex
 395:				;		CALL	serspace
 396:				;		LD	A, 'S'
 397:				;		CALL	seroutfn
 398:				;		LD	A, (DKIOCB+DSKSEC)
 399:				;		CALL	serhex
 400:				;		CALL	serspace
 401:				;		LD	A, 'T'
 402:				;		CALL	seroutfn
 403:				;		LD	A, (DKIOCB+DSKTRK)
 404:				;		CALL	serhex
 405:				;		CALL	sercr
 406:							
 407: 2336+10	01FE  210002  			LD	HL, 512
 408: 2346+16	0201  229EFF  			LD	(DKIOCB+DSKAUX), HL
 409: 2362+10	0204  2100C1  			LD	HL, IOBUFF
 410: 2372+16	0207  229CFF  			LD	(DKIOCB+DSKPTR), HL
 411: 2388+14	020A  DD2198FF			LD	IX, DKIOCB
 412: 2402+10	020E  C9      			RET     
 413:				
 414:				;--------------------------------------------------
 415:				; hook for setDirectSector if aux1/2 = 0
 416:				;--------------------------------------------------
 417: 2412+11	020F  E5      	dwrt:		PUSH	HL
 418: 2423+16	0210  22A9FF  			LD	(LOGSIZ),HL				;SAVE DATA BLOCK LENGTH
 419:				
 420: 2439+16	0213  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2
 421: 2455+4	0216  7D      			LD	A, L
 422: 2459+4	0217  B4      			OR	H
 423: 2463+7+5	0218  2804    			JR	Z, dwrta				;if zero, do special stuff
 424:				
 425: 2470+10	021A  E1      			POP	HL					;otherwise continue
 426: 2480+10	021B  C30BF9  			JP	SalyDISKWRT2				;normal
 427:				
 428: 2490+17	021E  CD84FB  	dwrta:		CALL	SENDACK
 429:				
 430: 2507+10	0221  21E30C  			LD	HL, direct				;direct
 431:				;		LD	A, (HL)
 432:				;		CALL	serhex
 433: 2517+11	0224  35      			DEC	(HL)
 434: 2528+7+5	0225  2813    			JR	Z, dwrtd				;first sector
 435: 2535+10	0227  FA4702  			JP	M, dwrtb				;second sector
 436:				
 437: 2545+7	022A  0640    			LD	B, 64
 438: 2552+8+5	022C  10FE    			DJNZ	$					;wait some time
 439:				
 440: 2560+16	022E  2A00C1  			LD	HL, (IOBUFF)				;save 2-byte sector number (0-xxxx)
 441: 2576+16	0231  22E10C  			LD	(dsector), HL
 442:				
 443: 2592+10	0234  E1      	dwrtc:		POP	HL
 444: 2602+7	0235  3E43    			LD	A, 'C'
 445: 2609+10	0237  C391FB  			JP	SENDCHAR
 446:				
 447: 2619+10	023A  2100C1  	dwrtd:		LD	HL, IOBUFF
 448: 2629+10	023D  1102C3  			LD	DE, IOBUFF+LEN+2
 449: 2639+10	0240  010001  			LD	BC, 0100h				;rec first half
 450: 2649+16+5	0243  EDB0    			LDIR
 451: 2665+12	0245  18ED    			JR	dwrtc
 452:				
 453: 2677+10	0247  3602    	dwrtb:		LD	(HL), 2					;direct = 2
 454:				
 455: 2687+10	0249  210002  			LD	HL, 512					;LOGSIZ 512 bytes in this case
 456: 2697+16	024C  22A9FF  			LD	(LOGSIZ), HL
 457:							
 458: 2713+10	024F  2100C1  			LD	HL, IOBUFF
 459: 2723+10	0252  1100C2  			LD	DE, IOBUFF+0100h
 460: 2733+10	0255  010001  			LD	BC, 0100h
 461: 2743+16+5	0258  EDB0    			LDIR    
 462: 2759+10	025A  2102C3  			LD	HL, IOBUFF+LEN+2
 463: 2769+10	025D  1100C1  			LD	DE, IOBUFF
 464: 2779+10	0260  010001  			LD	BC, 0100h
 465: 2789+16+5	0263  EDB0    			LDIR
 466:				
 467: 2805+17	0265  CDDA01  			CALL	sec2track
 468:				
 469: 2822+19	0268  DD360002			LD	(IX + DSKOP), PUTSEC
 470: 2841+17	026C  CD7102  			CALL	dskwrite
 471:				
 472: 2858+12	026F  18C3    			JR	dwrtc
 473:				;--------------------------------------------------
 474:				; dskwrite: write through sector
 475:				;--------------------------------------------------
 476:     -	0271          	dskwrite:
 477:				;		LD	A, 'W';
 478:				;		CALL	seroutfn
 479:				
 480:				;		JP	DISKV
 481:				
 482: 2870+17	0271  CD4A03  			CALL	checktrack
 483: 2887+7+5	0274  2010    			JR	NZ, dskwrite1
 484:				
 485:				;		LD	HL, (LOGSIZ)
 486:				;		CALL	seraddr
 487:				
 488: 2894+17	0276  CD2D03  			CALL	compbufadr
 489:				;		CALL	seraddr
 490:				
 491: 2911+4	0279  EB      			EX	DE, HL
 492: 2915+19	027A  DD6605  			LD	H, (IX + DSKPTR+1)
 493: 2934+19	027D  DD6E04  			LD	L, (IX + DSKPTR)
 494: 2953+20	0280  ED4BA9FF			LD	BC, (LOGSIZ)
 495:				
 496: 2973+16+5	0284  EDB0    			LDIR
 497:				
 498:     -	0286          	dskwrite1:
 499: 2989+10	0286  C30FF0  			JP	DISKV
 500:				
 501:				
 502:				;--------------------------------------------------
 503:				; dskreadfn: cache a track
 504:				;--------------------------------------------------
 505:     -	0289          	dskreadfn:
 506:				;		LD	A, 'R'
 507:				;		CALL	debug
 508:				
 509: 2999+17	0289  CD4A03  			CALL	checktrack
 510: 3016+10	028C  CA0803  			JP	Z, match
 511:				; 		ld	a, 'N'
 512:				;		CALL	seroutfn
 513: 3026+20	028F  ED53E50C			LD	(drive), DE				;save new drive and track
 514: 3046+15	0293  DDE5    			PUSH	IX					;save IX
 515:				
 516: 3061+15	0295  DDE5    			PUSH	IX					;load HL with IX
 517: 3076+10	0297  E1      			POP	HL
 518: 3086+10	0298  11F10C  			LD	DE, dcb
 519: 3096+10	029B  010900  			LD	BC, 9
 520: 3106+16+5	029E  EDB0    			LDIR						;copy dcb
 521:							
 522: 3122+14	02A0  DD21F10C			LD	IX, dcb					;load IX with new dcb
 523:							
 524: 3136+13	02A4  3AF80C  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 525: 3149+7	02A7  FE02    			CP	2
 526: 3156+7+5	02A9  2020    			JR	NZ, readtrack2				;no MS-DOS disk
 527:				
 528:				
 529: 3163+10	02AB  210010  			LD	HL, TRKBUFFER
 530: 3173+10	02AE  010112  			LD	BC, 18 * 256 + 1			;b=18, c = 1
 531:				
 532:     -	02B1          	readtrack3:
 533: 3183+16	02B1  22F50C  			LD	(dcb + DSKPTR), HL
 534: 3199+19	02B4  DD7103  			LD	(IX + DSKSEC),	C
 535:				
 536:				;		CALL	dumpdcb
 537:				
 538: 3218+11	02B7  E5      			PUSH	HL
 539: 3229+11	02B8  C5      			PUSH	BC
 540: 3240+17	02B9  CD0FF0  			CALL	DISKV
 541: 3257+10	02BC  C1      			POP	BC
 542: 3267+10	02BD  E1      			POP	HL
 543:				;		CALL	dumpsec 
 544: 3277+13	02BE  3AF90C  			LD	A, (dcb + DSKSTS)			;error occured?
 545: 3290+4	02C1  B7      			OR	A
 546: 3294+7+5	02C2  2036    			JR	NZ, readtrack4				;yes
 547: 3301+4	02C4  24      			INC	H
 548: 3305+4	02C5  24      			INC	H
 549: 3309+4	02C6  0C      			INC	C
 550: 3313+8+5	02C7  10E8    			DJNZ	readtrack3
 551: 3321+12	02C9  183B    			JR	readtrack5
 552:				
 553:     -	02CB          	readtrack2:
 554: 3333+7	02CB  0600    			LD	B, 0					;compute skew-list from media type
 555: 3340+19	02CD  FD4E05  			LD	C, (IY + MEDIA)
 556: 3359+10	02D0  21E90C  			LD	HL, skewtab
 557: 3369+11	02D3  09      			ADD	HL, BC
 558: 3380+7	02D4  7E      			LD	A, (HL)
 559: 3387+6	02D5  23      			INC	HL
 560: 3393+7	02D6  66      			LD	H, (HL)
 561: 3400+4	02D7  6F      			LD	L, A
 562: 3404+19	02D8  FD4603  			LD	B, (IY + NSECS+1)
 563:				
 564:     -	02DB          	readtrack1:
 565: 3423+16	02DB  22E70C  			LD	(secptr), HL
 566:				
 567:     -	02DE          	readtrack:
 568: 3439+16	02DE  2AE70C  			LD	HL, (secptr)
 569: 3455+7	02E1  7E      			LD	A, (HL)
 570: 3462+13	02E2  32F40C  			LD	(dcb + DSKSEC), A
 571: 3475+6	02E5  23      			INC	HL
 572: 3481+16	02E6  22E70C  			LD	(secptr), HL
 573:				
 574: 3497+11	02E9  C5      			PUSH	BC
 575: 3508+17	02EA  CD2D03  			CALL	compbufadr
 576: 3525+16	02ED  22F50C  			LD	(dcb + DSKPTR), HL
 577:				;		CALL	dumpdcb
 578: 3541+17	02F0  CD0FF0  			CALL	DISKV
 579: 3558+10	02F3  C1      			POP	BC
 580:				
 581: 3568+13	02F4  3AF90C  			LD	A, (dcb + DSKSTS)			;error occured?
 582: 3581+4	02F7  B7      			OR	A
 583: 3585+7+5	02F8  280A    			JR	Z, readtrack6				;no
 584:     -	02FA          	readtrack4:             
 585: 3592+10	02FA  21FFFF  			LD	HL, 0ffffh
 586: 3602+16	02FD  22E50C  			LD	(drive), HL
 587: 3618+14	0300  DDE1    			POP	IX					;yes, store in original dcb
 588: 3632+12	0302  181E    			JR	match2
 589:     -	0304          	readtrack6:             
 590: 3644+8+5	0304  10D8    			DJNZ	readtrack
 591:     -	0306          	readtrack5:
 592: 3652+14	0306  DDE1    			POP	IX
 593:				
 594:     -	0308          	match:
 595:				;		ld	a, 'M'
 596:				;		CALL	seroutfn
 597:						
 598: 3666+17	0308  CD2D03  			CALL	compbufadr
 599: 3683+19	030B  DD5605  			LD	D, (IX + DSKPTR+1)
 600: 3702+19	030E  DD5E04  			LD	E, (IX + DSKPTR)
 601: 3721+20	0311  ED4BA9FF			LD	BC, (LOGSIZ)
 602: 3741+13	0315  3AF80C  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 603: 3754+7	0318  FE02    			CP	2
 604: 3761+7+5	031A  2003    			JR	NZ, match1
 605: 3768+10	031C  010002  			LD	BC, 512
 606:     -	031F          	match1:
 607: 3778+16+5	031F  EDB0    			LDIR
 608:				
 609: 3794+4	0321  AF      			XOR	A
 610:     -	0322          	match2:
 611: 3798+19	0322  DD7708  			LD	(IX + DSKSTS), A
 612:				
 613:     -	0001          		IF	WD1772
 614: 3817+7	0325  3ED0    			LD	A, FINCMD				;keeps motor spinning
 615: 3824+17	0327  CD400C  			CALL	SalyCMDOUT
 616:					ENDIF
 617: 3841+10	032A  C33CF0  			JP	ACTIVON
 618:				
 619:				
 620:				;--------------------------------------------------
 621:				; HL = TRKBUF + DSKSEC * (128/256/512)
 622:				;--------------------------------------------------
 623:     -	032D          	compbufadr:
 624: 3851+10	032D  210010  			LD	HL, TRKBUFFER
 625: 3861+19	0330  DD4603  			LD	B, (IX + DSKSEC)
 626: 3880+4	0333  05      			DEC	B
 627: 3884+7	0334  0E00    			LD	C, 0
 628: 3891+13	0336  3AF80C  			LD	A, (dcb + DSKAUX + 1)			;load seclen highbyte
 629: 3904+4	0339  B7      			OR	A
 630: 3908+7+5	033A  2808    			JR	Z, compbufadr2				;if zero, assume 128 bytes length
 631: 3915+7	033C  FE01    			CP	1
 632: 3922+7+5	033E  2808    			JR	Z, compbufadr1				;if 1, assume 256 bytes
 633: 3929+8	0340  CB20    			SLA	B					;512 bytes
 634: 3937+12	0342  1804    			JR	compbufadr1
 635:     -	0344          	compbufadr2:
 636: 3949+8	0344  CB38    			SRL	B					;128 bytes
 637: 3957+8	0346  CB19    			RR	C
 638:     -	0348          	compbufadr1:
 639: 3965+11	0348  09      			ADD	HL, BC
 640: 3976+10	0349  C9      			RET
 641:				
 642:     -	034A          	checktrack:
 643: 3986+16	034A  2AE50C  			LD	HL, (drive)				;load
 644: 4002+19	034D  DD5602  			LD	D, (IX + DSKTRK)			;high
 645: 4021+19	0350  DD5E01  			LD	E, (IX + DSKDRV)			;low
 646: 4040+4	0353  B7      			OR	A					;clear carry
 647: 4044+15	0354  ED52    			SBC	HL, DE
 648: 4059+10	0356  C9      			RET
 649:				;
 650:				;
 651:				;--------------------------------------------------
 652:				; get Pokeydivisor command '?'
 653:				;--------------------------------------------------
 654:				;
 655:				;
 656:     -	0357          	getspeed:
 657:				;		LD	A, '?'
 658:				;		CALL	seroutfn
 659:				
 660: 4069+17	0357  CD7A07  			CALL	DRVINDEX				;POINT IY TO DRIVE'S DATA AREA
 661: 4086+5+6	035A  D8      			RET	C					;EXIT IF NOT A DRIVE IN OUR BOX
 662:				
 663:				;		CALL	HASPARMS
 664:				;		RET	Z					;EXIT IF DISK PARAMS NOT KNOWN
 665:				
 666: 4091+17	035B  CD84FB  			CALL	SENDACK					;SEND 'ACK' FOR COMMAND FRAME
 667:				
 668: 4108+10	035E  21FFC2  			LD	HL, IOBUFF+LEN-1
 669:				
 670:     -	0001          		IF NOHIGHSPEEDSIO <> 1
 671: 4118+7	0361  3E08    			LD	A, SIOFAST
 672: 4125+7	0363  77      			LD	(HL), A
 673:					ELSE
 675:					ENDIF	; HIGHSPEEDSIO
 676:				
 677: 4132+10	0364  114300  			LD	DE, 'C'
 678: 4142+10	0367  C36EF6  			JP	SENDBUFF				;SEND 'C' AND PARAMS DATA FRAME
 679:				
 680:				;
 681:				;
 682:     -	0001          		IF SALLYRS = 1
 683:				;
 684:				;--------------------------------------------------
 685:				;	... PERCOM 'N' COMMAND PROCESSOR ...
 686:				;--------------------------------------------------
 687:				;
 688:				;
 689:				;
 690:     -	036A          	GETPARAMS:
 691: 4152+17	036A  CD7A07  			CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 692: 4169+5+6	036D  D8      			RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 693:					
 694:				;		CALL	HASPARMS
 695:				;		RET	Z		;EXIT IF DISK PARAMS NOT KNOWN
 696:					
 697: 4174+17	036E  CD84FB  			CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 698:				
 699: 4191+17	0371  CD1206  			call	diskanalyse
 700:						
 701: 4208+17	0374  CD560A  			call	dumppercom
 702:				
 703:				;		SET	CONFIG,(IY+FLAGS)
 704: 4225+15	0377  FDE5    	GETPARAMS1	PUSH	IY
 705: 4240+10	0379  E1      			POP	HL
 706: 4250+10	037A  11F4C2  			LD	DE,IOBUFF+LEN-12
 707: 4260+11	037D  D5      			PUSH	DE
 708: 4271+10	037E  010C00  			LD	BC,12
 709: 4281+16+5	0381  EDB0    			LDIR			;COPY PARAMS TO OUTPUT BUFFER
 710: 4297+10	0383  E1      			POP	HL
 711: 4307+7	0384  1600    			ld	d, 0
 712: 4314+13	0386  3A040D  			ld	a, (siorc)
 713: 4327+4	0389  5F      			ld	e, a
 714: 4331+10	038A  C36EF6  			JP	SENDBUFF	;SEND 'C' AND PARAMS DATA FRAME
 715:						
 716:				;
 717:				;
 718:				;
 719:				;--------------------------------------------------
 720:				; Disk status
 721:				;--------------------------------------------------
 722:				;
 723:				;
 724:				;
 725: 4341+17	038D  CD7A07  	diskstatus:	CALL	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 726: 4358+5+6	0390  D8      			RET	C			;EXIT IF NOT A DRIVE IN OUR BOX
 727:				
 728: 4363+17	0391  CD84FB  			CALL	SENDACK			;SEND 'ACK' FOR COMMAND FRAME
 729:				
 730: 4380+17	0394  CD1206  			call	diskanalyse
 731: 4397+7+5	0397  3841    			jr	C, diskstatus4
 732:						
 733: 4404+17	0399  CD2908  			call	waitstatus		;get idle status for motor on
 734: 4421+4	039C  47      			ld	b, a			;save status from FDC
 735:							
 736: 4425+7	039D  3EFD    			ld	a, not BADRW
 737: 4432+19	039F  FDA60C  			and	(IY + CMDSTS)		;keep BADRW
 738:						
 739: 4451+8	03A2  CB78    			bit	7, b			;motor on?
 740: 4459+7+5	03A4  2802    			jr	z, diskstatus1		;no
 741: 4466+8	03A6  CBE7    			set	ACTIVE, a
 742:				
 743: 4474+20	03A8  FDCB0556	diskstatus1:	bit	DENSTY, (IY + MEDIA)	;double density?
 744: 4494+7+5	03AC  2802    			jr	z, diskstatus2		;no
 745: 4501+8	03AE  CBEF    			set	SEC256, a
 746:				
 747: 4509+20	03B0  DDCB0876	diskstatus2:	bit	6, (IX + DSKSTS)	;last command wp?
 748: 4529+7+5	03B4  2802    			jr	z, diskstatus3		;no
 749: 4536+8	03B6  CBDF    			set	WRPROT, a
 750:				
 751: 4544+8	03B8  CB6F    	diskstatus3:	bit	SEC256, a
 752: 4552+7+5	03BA  200B    			jr	NZ, diskstatus5
 753: 4559+4	03BC  47      			ld	b, a
 754: 4563+19	03BD  FD7E03  			ld	a, (IY + NSECS + 1)
 755: 4582+7	03C0  FE1A    			cp	26
 756: 4589+4	03C2  78      			ld	a, b
 757: 4593+7+5	03C3  2002    			jr	NZ, diskstatus5
 758: 4600+8	03C5  CBFF    			set	7, a
 759:						
 760: 4608+10	03C7  21E603  	diskstatus5:	ld	hl, statbytes
 761: 4618+7	03CA  77      			ld	(hl), a
 762:				;		call	serhex
 763: 4625+19	03CB  FD7E0D  			ld	a,(IY+HDWSTS)
 764: 4644+4	03CE  2F      			cpl
 765: 4648+6	03CF  23      			inc	hl
 766: 4654+7	03D0  77      			ld	(hl), a
 767:						
 768: 4661+6	03D1  2B      			dec	hl
 769: 4667+10	03D2  11FCC2  			ld	de, IOBUFF+LEN-4
 770: 4677+10	03D5  010400  			ld	bc, 4
 771: 4687+16+5	03D8  EDB0    			ldir				;COPY PARAMS TO OUTPUT BUFFER
 772:						
 773: 4703+7	03DA  1600    	diskstatus4:	ld	d, 00h			;true data
 774: 4710+13	03DC  3A040D  			ld	a, (siorc)		;get rc to br returned
 775:				;		call	seroutfn
 776: 4723+4	03DF  5F      			ld	e, a
 777: 4727+10	03E0  21FCC2  			ld	hl, IOBUFF+LEN-4
 778: 4737+10	03E3  C36EF6  			JP	SENDBUFF		;SEND 'C' or 'E' AND PARAMS DATA FRAME		
 779:				
 780:     -	03E6  00FFE000	statbytes:	DEFB	0h, 0ffh, 224, 0
 781:				
 782:					ENDIF
 783:				;
 784:				;
 785:				;
 786:				;--------------------------------------------------
 787:				; Disk read
 788:				;--------------------------------------------------
 789:				;
 790:				;
 791:				;
 792: 4747+17	03EA  CD7A07  	diskreadfn:	call	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 793: 4764+5+6	03ED  D8      			ret	C			;EXIT IF NOT A DRIVE IN OUR BOX
 794:					
 795: 4769+17	03EE  CD84FB  	diskreadfn2:	call	SENDACK			;SEND 'ACK' FOR COMMAND FRAME
 796:						
 797: 4786+17	03F1  CDB707  			call	isspinning
 798: 4803+7+5	03F4  3830    			jr	C, diskreadfn3
 799:								
 800: 4810+17	03F6  CD1206  			call	diskanalyse
 801: 4827+7+5	03F9  382B    			jr	C, diskreadfn3
 802:							
 803: 4834+17	03FB  CD6807  			call	checkmaxsec		;check if sio sector > max sector
 804: 4851+7+5	03FE  3826    			jr	C, diskreadfn3		;no carry, ok
 805:				
 806: 4858+17	0400  CD9808  			call	sec2trk			;compute head / track / sec and seek
 807:				
 808: 4875+13	0403  3A2FFF  			ld	a, (OUTCPY)		;make head info as bit 7
 809: 4888+4	0406  17      			rla
 810: 4892+4	0407  17      			rla
 811: 4896+7	0408  E680    			and	10000000b
 812: 4903+19	040A  DDB601  			or	(IX + DSKDRV)
 813: 4922+4	040D  47      			ld	b, a
 814: 4926+19	040E  DD4E02  			ld	c, (IX + DSKTRK)	;BC = DRIVE/TRACK
 815:						
 816: 4945+16	0411  2AE50C  			ld	hl, (drive)
 817: 4961+15	0414  ED42    			sbc	hl, bc			;or above, carry clear!
 818: 4976+7+5	0416  2806    			jr	z, trkmatch
 819:						
 820: 4983+17	0418  CD3204  			call	readtrk
 821: 5000+17	041B  CDCD05  			call	compdskbuf
 822:						
 823: 5017+17	041E  CD6704  	trkmatch:	call	computesecbuf
 824:						
 825:				;		call	sercr
 826:				;		call	seraddr
 827:				;		call	serspace
 828:				;		ex	de, hl
 829:				;		call	seraddr
 830:				;		call	serspace
 831:				;		push	bc
 832:				;		pop	hl
 833:				;		call	seraddr
 834:				;		call	serspace
 835:						
 836: 5034+7	0421  3E80    			ld	a, RDCMD
 837: 5041+17	0423  CD4C08  			call	diskop			;call diskio routine
 838:				
 839: 5058+17	0426  CDE905  	diskreadfn3:	call	adjustsiobuf
 840: 5075+7	0429  16FF    			ld	d, 0ffh			;invert data
 841: 5082+13	042B  3A040D  			ld	a, (siorc)
 842: 5095+4	042E  5F      			ld	e, a
 843: 5099+10	042F  C36EF6  			jp	SENDBUFF		;SEND 'C' AND PARAMS DATA FRAME	
 844:				
 845:				;
 846:				;
 847:				;
 848: 5109+10	0432  C9      	readtrk:	ret
 849: 5119+17	0433  CD3E08  			call	readidam
 850:				
 851: 5136+17	0436  CD8304  			call	getskewtab
 852:				
 853: 5153+13	0439  3AFC0C  			ld	a, (idsector)
 854: 5166+19	043C  FD4603  			ld	b, (IY + NSECS + 1)	;loop over #secs		
 855:				;		call	serhex
 856: 5185+7	043F  BE      	readtrk1:	cp	(hl)
 857: 5192+7+5	0440  2803    			jr	Z, readtrk2		;initial secnr found
 858: 5199+6	0442  23      			inc	hl
 859: 5205+12	0443  18FA    			jr	readtrk1
 860:						
 861: 5217+6	0445  23      	readtrk2:	inc	hl
 862: 5223+7	0446  7E      			ld	a, (hl)
 863: 5230+4	0447  B7      			or	a
 864: 5234+7+5	0448  2004    			jr	NZ, readtrk3
 865: 5241+17	044A  CD8304  			call	getskewtab
 866: 5258+7	044D  7E      			ld	a, (hl)
 867:				
 868: 5265+19	044E  DD4E03  	readtrk3:	ld	c, (IX + DSKSEC)
 869: 5284+19	0451  DD7703  			ld	(IX + DSKSEC), a
 870: 5303+11	0454  C5      			push	bc
 871: 5314+11	0455  E5      			push	hl
 872: 5325+17	0456  CD6704  			call	computesecbuf
 873: 5342+17	0459  CDD70B  			call	seraddr
 874: 5359+17	045C  CDC70B  			call	serspace
 875: 5376+10	045F  E1      			pop	hl
 876: 5386+10	0460  C1      			pop	bc
 877: 5396+19	0461  DD7103  			ld	(IX + DSKSEC), c
 878:				
 879: 5415+8+5	0464  10DF    			djnz	readtrk2
 880:						
 881: 5423+10	0466  C9      			ret
 882:				
 883:				
 884:     -	0467          	computesecbuf:
 885: 5433+19	0467  FD5606  			ld	d, (IY + SECLEN)	;hi
 886: 5452+19	046A  FD5E07  			ld	e, (IY + SECLEN + 1)	;lo
 887: 5471+11	046D  D5      			push	de
 888: 5482+19	046E  DD4603  			ld	b, (IX + DSKSEC)	;sec to be read;
 889: 5501+10	0471  210000  			ld	hl, 0
 890: 5511+11	0474  19      	trkmatch1:	add	hl, de
 891: 5522+8+5	0475  10FD    			djnz	trkmatch1		;compute start of sector
 892: 5530+4	0477  B7      			or	a
 893: 5534+15	0478  ED52    			sbc	hl, de
 894: 5549+10	047A  110010  			ld	de, TRKBUFFER
 895: 5559+11	047D  19      			add	hl, de
 896: 5570+10	047E  1100C2  			ld	de, IOBUFF+LEN-256
 897: 5580+10	0481  C1      			pop	bc
 898: 5590+10	0482  C9      			ret
 899:				
 900:     -	0483          	getskewtab:
 901: 5600+15	0483  FDE5    			push	iy
 902: 5615+10	0485  E1      			pop	hl
 903: 5625+10	0486  111400  			ld	de, PERSKEWTAB
 904: 5635+11	0489  19      			add	hl, de
 905: 5646+10	048A  C9      			ret
 906:				;
 907:				;
 908:				;
 909:				;--------------------------------------------------
 910:				; Disk write
 911:				;--------------------------------------------------
 912:				;
 913:				;
 914:				;
 915: 5656+17	048B  CD7A07  	diskwritefn:	call	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 916: 5673+5+6	048E  D8      			ret	C			;EXIT IF NOT A DRIVE IN OUR BOX
 917:									
 918: 5678+17	048F  CD84FB  	diskwritefn2:	call	SENDACK			;SEND 'ACK' FOR COMMAND FRAME
 919:				
 920: 5695+17	0492  CDBBF6  			CALL	RECVBUFF		;ATTEMPT TO READ DATA FRAME FROM ATARI
 921: 5712+5+6	0495  C0      			RET	NZ
 922:				
 923: 5717+16	0496  229EFF  			LD	(DKIOCB + DSKAUX),HL	;SAVE DATA BLOCK LENGTH
 924: 5733+10	0499  118000  			LD	DE,128
 925: 5743+4	049C  B7      			OR	A
 926: 5747+15	049D  ED52    			SBC	HL,DE			;TEST FOR 128 BYTE FRAME
 927: 5762+7+5	049F  2804    			JR	Z,diskwritefn1
 928: 5769+4	04A1  B7      			OR	A
 929: 5773+15	04A2  ED52    			SBC	HL,DE			;TEST FOR 256 BYTE FRAME
 930: 5788+5+6	04A4  C0      			RET	NZ		
 931:						
 932: 5793+17	04A5  CD84FB  	diskwritefn1:	call	SENDACK			;SEND 'ACK' IF BLOCKSIZE IS 128 OR 256
 933:							
 934: 5810+17	04A8  CDB707  			call	isspinning
 935: 5827+7+5	04AB  3833    			jr	C, diskwritefn4
 936:						
 937: 5834+17	04AD  CD1206  			call	diskanalyse
 938: 5851+7+5	04B0  382E    			jr	C, diskwritefn4
 939:						
 940: 5858+17	04B2  CD6807  			call	checkmaxsec		;check if sio sector > max sector
 941: 5875+7+5	04B5  3829    			jr	C, diskwritefn4		;no carry, ok
 942:						
 943: 5882+17	04B7  CD9808  			call	sec2trk			;compute head / track / sec and seek
 944:				
 945: 5899+10	04BA  2100C1  			ld	hl, IOBUFF
 946: 5909+16	04BD  229CFF  			ld	(DKIOCB + DSKPTR), hl
 947:				
 948: 5925+19	04C0  DD4606  			ld	b, (IX + DSKAUX)	;complement data frame, only up to 256 byte sectors
 949: 5944+7	04C3  7E      	diskwritefn5:	ld	a, (hl)
 950: 5951+4	04C4  2F      			cpl
 951: 5955+7	04C5  77      			ld	(hl), a
 952: 5962+6	04C6  23      			inc	hl
 953: 5968+8+5	04C7  10FA    			djnz	diskwritefn5
 954:				
 955: 5976+19	04C9  FD7E06  			ld	a, (IY + SECLEN)
 956: 5995+13	04CC  329FFF  			ld	(DKIOCB + DSKAUX + 1), a
 957: 6008+19	04CF  FD7E07  			ld	a, (IY + SECLEN + 1)
 958: 6027+13	04D2  329EFF  			ld	(DKIOCB + DSKAUX), a
 959:				
 960: 6040+7	04D5  3EA0    			ld	a, WRTCMD
 961: 6047+17	04D7  CD4C08  			call	diskop			;call diskio routine
 962: 6064+19	04DA  FD7E0C  			ld	a, (IY + CMDSTS)
 963: 6083+17	04DD  CDEA0B  			call	serhex
 964:						
 965: 6100+13	04E0  3A040D  	diskwritefn4:	ld	a, (siorc)
 966:				;		call	seroutfn
 967: 6113+4	04E3  5F      			ld	e, a
 968: 6117+10	04E4  C391FB  			jp	SENDCHAR		;SEND 'C' AND PARAMS DATA FRAME	
 969:				
 970:				
 971:				;
 972:				;
 973:				;	... DISK FORMAT COMMAND PROCESSOR ...
 974:				;
 975:     -	04E7          	diskformat:
 976: 6127+17	04E7  CD7A07  			CALL	DRVINDEX		;POINT IY TO DRIVE'S DATA AREA
 977: 6144+5+6	04EA  D8      			RET	C			;EXIT IF NOT A DRIVE IN OUR BOX
 978:										
 979: 6149+16	04EB  2A4FFF  			LD	HL,(PCOUNT)             
 980: 6165+4	04EE  7C      			LD	A,H                     
 981: 6169+4	04EF  B5      			OR	L                       
 982: 6173+5+6	04F0  C0      			RET	NZ			;REFUSE TO FORMAT IF SPOOLER ACTIVE
 983:										
 984: 6178+19	04F1  FD7E00  			ld	a, (IY + NTRKS) 	;REFUSE TO FORMAT IF PARAMS NOT SET
 985: 6197+4	04F4  B7      			or	a                       
 986: 6201+5+6	04F5  C8      			ret	Z                       
 987:										
 988: 6206+17	04F6  CD84FB  			call	SENDACK                 
 989: 6223+17	04F9  CDAFF3  			call	STOPTMR			;THEN KILL CTC3 TO STOP DISK TIMER
 990:										
 991: 6240+7	04FC  3E43    			ld	a, 'C'
 992: 6247+13	04FE  32040D  			ld	(siorc), a
 993:				
 994: 6260+17	0501  CD9405  			call	computeflags
 995:						
 996: 6277+13	0504  322FFF  			ld	(OUTCPY), a
 997: 6290+11	0507  D330    			out	(LATCH), a
 998: 6301+17	0509  CDEA0B  			call	serhex
 999:				
1000: 6318+11	050C  F5      			push	af
1001: 6329+17	050D  CD0D08  			call	restoretrack
1002: 6346+10	0510  F1      			pop	af
1003:						
1004: 6356+11	0511  E5      			push	hl
1005:					
1006: 6367+16	0512  22C1FF  			ld	(SEQPTR), hl			;STORE POINTER FOR BAD SECTOR LIST
1007: 6383+10	0515  210100  			ld	hl , 1
1008: 6393+16	0518  22BFFF  			ld	(SEQNUM), HL			;RESET BAD SECTOR COUNTER
1009: 6409+16	051B  2A49FF  			ld	HL, (FMTPTR)			;pointer to formats
1010: 6425+10	051E  11B6FF  			ld	DE, FMTSTUFF
1011: 6435+10	0521  010700  			ld	BC, FMTLEN
1012: 6445+4	0524  07      			rlca
1013: 6449+4	0525  07      			rlca
1014: 6453+7	0526  E603    			and	00000011B
1015: 6460+7+5	0528  2804    			jr	Z, diskformat5
1016: 6467+11	052A  09      	diskformat2:	add	HL,BC
1017: 6478+4	052B  3D      			dec	A
1018: 6482+7+5	052C  20FC    			jr	NZ, diskformat2			;INDEX TO PROPER PARAMS FOR DISK TYPE
1019:						
1020: 6489+13	052E  3A010D  	diskformat5:	ld	a, (siocmd)			;check for medium density
1021: 6502+17	0531  CDE50B  			call	serhexspace
1022: 6519+7	0534  FE22    			cp	'"'
1023: 6526+7+5	0536  2016    			jr	NZ, diskformat1
1024: 6533+16	0538  2A49FF  			ld	hl, (FMTPTR)
1025: 6549+11	053B  09      			add	hl, bc
1026: 6560+11	053C  09      			add	hl, bc
1027: 6571+11	053D  09      			add	hl, bc
1028: 6582+11	053E  09      			add	hl, bc
1029: 6593+13	053F  3A2FFF  			ld	a, (OUTCPY)
1030: 6606+7	0542  E63F    			and	00111111b
1031: 6613+7	0544  F640    			or	01000000b
1032: 6620+13	0546  322FFF  			ld	(OUTCPY), a
1033: 6633+19	0549  FD770E  			ld	(IY + FLAGS), a
1034: 6652+11	054C  D330    			out	(LATCH), a
1035:				;		ld	(IY + NSECS + 1), 26
1036:				
1037: 6663+17	054E  CDD70B  	diskformat1:	call	seraddr
1038: 6680+16+5	0551  EDB0    			ldir					;THEN COPY PARAMS TO 'FMTSTUFF'
1039: 6696+13	0553  3AA0FF  			ld	A,(DKIOCB+DSKSTS)
1040: 6709+7	0556  E6C0    			and	11000000B
1041: 6716+7+5	0558  2017    			jr	NZ, diskformat6			;ERROR IF NOT READY OR WRITE PROTECTED
1042:					
1043: 6723+19	055A  FD7E04  			ld	a,(iy+nsides)			;set for SS/DS init
1044: 6742+13	055D  32BDFF  			ld	(sides),a
1045: 6755+19	0560  FD7E00  			ld	a,(iy+ntrks)			;set for number of tracks
1046: 6774+13	0563  32BEFF  			ld	(tracks),a
1047: 6787+15	0566  FDE5    			push	IY
1048: 6802+15	0568  DDE5    			push	IX
1049: 6817+17	056A  CDF9FB  			call	FORMAT				;CALL FORMAT SUBROUTINE
1050: 6834+14	056D  DDE1    			pop	IX
1051: 6848+14	056F  FDE1    			pop	IY
1052:				
1053:				
1054: 6862+8	0571  CBBF    	diskformat6:	res	7, a
1055: 6870+11	0573  F5      			push	af
1056: 6881+7	0574  3E3A    			ld	a, ':'
1057: 6888+17	0576  CD030C  			call	seroutfn
1058: 6905+10	0579  F1      			pop	af
1059: 6915+17	057A  CDEA0B  			call	serhex
1060: 6932+17	057D  CDD3F9  			CALL	SETSTAT				;UPDATE STATUS AS SPECIFIED BY ACC
1061:						
1062: 6949+19	0580  FD360E00			ld	(IY + FLAGS), 0
1063:				;		call	serinfn
1064: 6968+17	0584  CD1206  			call	diskanalyse			;compute maxsec
1065:				;		call	restoretrack
1066: 6985+17	0587  CD560A  			call	dumppercom
1067:						
1068: 7002+10	058A  E1      			POP	HL
1069: 7012+7	058B  1600    			LD	D,0
1070: 7019+13	058D  3A040D  			ld	a, (siorc)
1071: 7032+4	0590  5F      			ld	e, a
1072: 7036+10	0591  C36EF6  			jp	SENDBUFF			;SEND BAD SECTOR DATA FRAME
1073:				;		JP	ACTIVON		;THEN RESTART THE DISK TIMER
1074:					
1075:				;--------------------------------------------------
1076:				; computeflags
1077:				;--------------------------------------------------
1078: 7046+19	0594  FD361300	computeflags:	ld	(IY + PERSTEPRATE), STEPRATE0
1079: 7065+17	0598  CDAC07  			call	getdrivelatch
1080: 7082+4	059B  47      			ld	b, a
1081:						
1082: 7086+10	059C  2100C2  			ld	hl, IOBUFF+LEN-256	;256 byte bad sector list
1083: 7096+20	059F  FDCB0556			bit	DENSTY, (IY + MEDIA)    
1084: 7116+7+5	05A3  2014    			jr	nz, computeflags1         
1085: 7123+10	05A5  2180C2  			ld	HL, IOBUFF+LEN-128	;128 byte bad sector list
1086: 7133+8	05A8  CBF0    			set	6, b			;and no HD
1087: 7141+19	05AA  FD361303			ld	(IY + PERSTEPRATE), STEPRATE3
1088: 7160+19	05AE  FD7E03  			ld	a, (IY + NSECS + 1)
1089: 7179+7	05B1  FE1A    			cp	26
1090: 7186+7+5	05B3  2813    			jr	Z, computeflags4
1091: 7193+8	05B5  CBF8    			set	7, b			;set single density (FM)
1092: 7201+12	05B7  180F    			jr	computeflags4
1093:				;
1094:				; HD/DD selection
1095:				; number sector >= 26 and sector-size > 128 then hd
1096:				;
1097: 7213+20	05B9  FDCB077E	computeflags1:	bit	7, (IY + SECLEN + 1)		;bit 7 - low byte (128) = 1?
1098: 7233+7+5	05BD  2007    			jr	NZ, computeflags3		;probably medium density
1099: 7240+19	05BF  FD7E03  			ld	a, (IY + NSECS + 1)
1100: 7259+7	05C2  FE1A    			cp	26
1101: 7266+7+5	05C4  3002    			jr	NC, computeflags4		;>= 26 HD
1102: 7273+8	05C6  CBF0    	computeflags3:	set	6, b				;< 26 sectores, normal DD
1103: 7281+4	05C8  78      	computeflags4:	ld	a, b
1104: 7285+19	05C9  FD770E  			ld	(IY + FLAGS), a
1105: 7304+10	05CC  C9      			ret
1106:				;--------------------------------------------------
1107:				; compdskbufbuf
1108:				; siorc default to 'C' - complete
1109:				; copy percom sector length to IX + DSKAUX
1110:				; computer start of serial buffer (IOBUF+LEN - seclen)
1111:				;--------------------------------------------------
1112:     -	05CD          	compdskbuf:
1113: 7314+7	05CD  3E43    			ld	a, 'C'
1114: 7321+13	05CF  32040D  			ld	(siorc), a
1115:				
1116: 7334+19	05D2  FD6606  			ld	h, (IY + SECLEN)	;compute start of disk-data
1117: 7353+19	05D5  FD6E07  			ld	l, (IY + SECLEN + 1)	;in transfer buffer
1118: 7372+16	05D8  229EFF  			ld	(DKIOCB + DSKAUX), hl
1119: 7388+4	05DB  EB      			ex	de, hl
1120: 7392+4	05DC  B7      			or	a
1121: 7396+10	05DD  2100C3  			ld	hl, IOBUFF+LEN
1122: 7406+15	05E0  ED52    			sbc	hl, de
1123: 7421+16	05E2  229CFF  			ld	(DKIOCB + DSKPTR), hl
1124: 7437+16	05E5  22050D  			ld	(siobuffer), hl
1125: 7453+10	05E8  C9      			ret
1126:				
1127:				;--------------------------------------------------
1128:				; adjustsiobufbuf
1129:				; if sector < 4, copy data to IOBUF+LEN - 128
1130:				; return start of SIo buffer in HL
1131:				;--------------------------------------------------
1132:     -	05E9          	adjustsiobuf:	
1133: 7463+19	05E9  FD7E0E  			ld	a, (IY + FLAGS)
1134: 7482+4	05EC  B7      			or	a
1135: 7486+7+5	05ED  2006    			jr	NZ, adjustsiobuf1
1136: 7493+10	05EF  2100C2  			ld	hl, IOBUFF+256
1137: 7503+4	05F2  AF      			xor	a
1138: 7507+12	05F3  1808    			jr 	adjustsiobuf2
1139:				
1140: 7519+16	05F5  2A9CFF  	adjustsiobuf1:	ld	hl, (DKIOCB + DSKPTR)
1141: 7535+19	05F8  DD7E06  			ld	a, (IX + DSKAUX)		;sectorlen < 256
1142: 7554+4	05FB  B7      			or	a
1143: 7558+5+6	05FC  C0      			ret	NZ				;yes, do nothing
1144:						
1145: 7563+13	05FD  3A030D  	adjustsiobuf2:	ld	a, (siosector + 1)		;hi-byte <> 0
1146: 7576+4	0600  B7      			or	a
1147: 7580+5+6	0601  C0      			ret	NZ				;yes, no nothing
1148:						
1149: 7585+13	0602  3A020D  			ld	a, (siosector)		
1150: 7598+7	0605  FE04    			cp	4
1151: 7605+5+6	0607  D0      			ret	NC				;>= 4
1152:				
1153: 7610+11	0608  E5      			push	hl
1154: 7621+10	0609  018000  			ld	bc, 128
1155: 7631+11	060C  09      			add	hl, bc
1156: 7642+4	060D  EB      			ex	de, hl				;de = hl+128
1157: 7646+10	060E  E1      			pop	hl				;hl = diskbuffer
1158: 7656+16+5	060F  EDB0    			ldir
1159:				
1160: 7672+10	0611  C9      			ret
1161:						
1162:				;--------------------------------------------------
1163:				; diskanalyse - compute PERCOM values
1164:				;--------------------------------------------------
1165: 7682+7	0612  3E43    	diskanalyse:	ld	a, 'C'
1166: 7689+13	0614  32040D  			ld	(siorc), a
1167:						
1168: 7702+19	0617  FD7E0E  			ld	a, (IY + FLAGS)			;check if percom empty
1169: 7721+13	061A  322FFF  			ld	(OUTCPY), a			;set LATCH und OUTCPY
1170: 7734+11	061D  D330    			out	(LATCH), a
1171: 7745+4	061F  B7      			or	a
1172: 7749+5+6	0620  C0      			ret	NZ				;no continue without disk analyse
1173:				
1174:						
1175: 7754+19	0621  FD360504			ld	(IY + MEDIA), 4			;set DD (MFM)
1176: 7773+19	0625  FD360F03			ld	(IY + PERCONFIG), 3		;set SIZE and DDHD
1177: 7792+19	0629  FD360400			ld	(IY + NSIDES), 0
1178: 7811+19	062D  FD361300			ld	(IY + PERSTEPRATE), STEPRATE0	;select 6ms/3ms
1179:						
1180: 7830+17	0631  CDAC07  			call	getdrivelatch
1181: 7847+19	0634  FD770E  			ld	(IY + FLAGS), a	
1182: 7866+11	0637  D330    			out	(LATCH), a
1183: 7877+13	0639  322FFF  			ld	(OUTCPY), a
1184:				
1185: 7890+17	063C  CD0D08  			call	restoretrack
1186:				
1187: 7907+17	063F  CDC107  			call	getperiod
1188: 7924+7+5	0642  300C    			jr	NC, diskanalyse3		;if no period, error
1189:				
1190: 7931+7	0644  3E2D    	diskanalyse2:	ld	a, '-'
1191: 7938+17	0646  CD030C  			call	seroutfn
1192: 7955+19	0649  FD360E00			ld	(IY + FLAGS), 0
1193: 7974+10	064D  C3EB07  			jp	setsioerror
1194:						
1195: 7984+19	0650  FD7E0E  	diskanalyse3:	ld	a, (IY + FLAGS)	
1196: 8003+11	0653  D330    			out	(LATCH), a	
1197: 8014+17	0655  CDCC08  			call 	tryidam	
1198: 8031+7+5	0658  2825    			jr	z, diskanalyse1	
1199:				
1200: 8038+20	065A  FDCB0E76			bit 	6, (IY + FLAGS)			;DD already set?
1201: 8058+7+5	065E  200E    			jr	nz, diskanalyse4		;yes	
1202: 8065+23	0660  FDCB0EF6			set	6, (IY + FLAGS)			;switch back to DD
1203: 8088+23	0664  FDCB0F86			res	DDHD, (IY + PERCONFIG)		;reset DDHD
1204: 8111+19	0668  FD361303			ld	(IY + PERSTEPRATE), STEPRATE3	;set to 3ms in DD mode
1205: 8130+12	066C  18E2    			jr	diskanalyse3	
1206:							
1207: 8142+20	066E  FDCB0E7E	diskanalyse4:	bit 	7, (IY + FLAGS)			;FM already set?
1208: 8162+10	0672  C24406  			jp	nz, diskanalyse2		;bail out with C set
1209: 8172+23	0675  FDCB0EFE			set	7, (IY + FLAGS)			;set FM
1210: 8195+23	0679  FDCB0596			res	DENSTY, (IY + MEDIA)		;reset DENSTY (FM/MFM)
1211: 8218+12	067D  18D1    			jr	diskanalyse3	
1212:				
1213:				;
1214:				; arrive here if IDAM has been found
1215:				; check for track 41 to be readable
1216:				;
1217: 8230+7	067F  3E28    	diskanalyse1:	ld	a, 40				;check for track 41
1218: 8237+19	0681  FD7700  			ld	(IY + NTRKS), a
1219: 8256+19	0684  DD7702  			ld	(IX + DSKTRK), a
1220: 8275+17	0687  CDF207  			call	seektrack
1221: 8292+17	068A  CDCC08  			call 	tryidam
1222: 8309+7+5	068D  202D    			jr	nz, diskanalyse8
1223:				;
1224:				; track 41 was readable, check if ID holds also track 41
1225:				; if not is was a 40 TRK drive and the head hit the bottom
1226:				;
1227: 8316+13	068F  3AFA0C  			ld	a, (idtrack)
1228: 8329+19	0692  FDBE00  			cp	(IY + NTRKS)
1229: 8348+7+5	0695  2025    			jr	nz, diskanalyse8
1230:						
1231:				;
1232:				; now check for track 77
1233:				;
1234: 8355+7	0697  3E4D    			ld	a, 77
1235: 8362+19	0699  FD7700  			ld	(IY + NTRKS), a			;assume at least 77 tracks
1236: 8381+19	069C  DD7702  			ld	(IX + DSKTRK), a
1237: 8400+17	069F  CDF207  			call	seektrack
1238: 8417+17	06A2  CDCC08  			call 	tryidam
1239: 8434+7+5	06A5  2015    			jr	nz, diskanalyse8
1240:				
1241: 8441+13	06A7  3AFA0C  			ld	a, (idtrack)
1242: 8454+19	06AA  FDBE00  			cp	(IY + NTRKS)
1243: 8473+7+5	06AD  200D    			jr	nz, diskanalyse8
1244:				
1245: 8480+13	06AF  3AFD0C  			ld	a, (idseclen)			;check seclen
1246: 8493+7	06B2  E603    			and	a, 3
1247: 8500+7	06B4  FE01    			cp	1				;has to be a 256 byte sector
1248: 8507+7+5	06B6  2004    			jr	nz, diskanalyse8
1249:						
1250: 8514+19	06B8  FD360050			ld	(IY + NTRKS), 80
1251:						
1252: 8533+17	06BC  CD0D08  	diskanalyse8:	call	restoretrack			;restore and check other side
1253:					
1254: 8550+23	06BF  FDCB0EEE			set	5, (IY + FLAGS)			;set side 1
1255: 8573+19	06C3  FD7E0E  			ld	a, (IY + FLAGS)
1256: 8592+11	06C6  D330    			out	(LATCH), a
1257: 8603+17	06C8  CDCC08  			call 	tryidam
1258: 8620+7+5	06CB  2003    			jr	nz, diskanalyse6
1259:						
1260: 8627+23	06CD  FD3404  			inc	(IY + NSIDES)
1261:				
1262: 8650+23	06D0  FDCB0EAE	diskanalyse6:	res	5, (IY + FLAGS)			;set side 0
1263: 8673+19	06D4  FD7E0E  			ld	a, (IY + FLAGS)
1264: 8692+11	06D7  D330    			out	(LATCH), a
1265: 8703+13	06D9  322FFF  			ld	(OUTCPY), a			;set LATCH und OUTCPY
1266:				
1267: 8716+17	06DC  CD3C07  			call	readskew
1268:				;		call 	tryidam				;read fresh IDAM (could be CRC error from above)	
1269:						
1270: 8733+13	06DF  3AFD0C  			ld	a, (idseclen)			;compute sector length
1271: 8746+7	06E2  E603    			and	3				;from IDAM field
1272: 8753+4	06E4  3C      			inc	a
1273: 8757+10	06E5  214000  			ld	hl, 64
1274: 8767+8	06E8  CB25    	compseclen:	sla	l
1275: 8775+8	06EA  CB14    			rl	h
1276: 8783+4	06EC  3D      			dec	a
1277: 8787+7+5	06ED  20F9    			jr	NZ, compseclen	
1278: 8794+19	06EF  FD7406  			ld	(IY + SECLEN), h
1279: 8813+19	06F2  FD7507  			ld	(IY + SECLEN + 1), l
1280:						
1281:				;		call	seraddr		
1282:				
1283: 8832+19	06F5  FD360200			ld	(IY + NSECS), 0
1284: 8851+19	06F9  FD360312			ld	(IY + NSECS + 1), 18
1285: 8870+20	06FD  FDCB0E76			bit	6, (IY + FLAGS)			;HD mode, set to 26
1286: 8890+7+5	0701  280F    			jr	Z, diskanalyse10
1287: 8897+20	0703  FDCB0E7E			bit	7, (IY + FLAGS)			;MFM mode 
1288: 8917+7+5	0707  200D    			jr	NZ, diskanalyse5
1289: 8924+19	0709  FD7E06  			ld	a, (IY + SECLEN)		;and seclen < 256
1290: 8943+4	070C  B7      			or	a
1291: 8947+7+5	070D  2007    			jr	NZ, diskanalyse5 		;then set also to 26
1292: 8954+19	070F  FD7705  			ld	(IY + MEDIA), a
1293:				
1294: 8973+19	0712  FD36031A	diskanalyse10:	ld	(IY + NSECS + 1), 26
1295:						
1296: 8992+10	0716  210000  	diskanalyse5:	ld	hl, 0				;compute PERcom MAXSEC
1297: 9002+19	0719  FD4600  			ld	b, (IY + NTRKS)
1298: 9021+19	071C  FD5602  			ld	d, (IY + NSECS)			;compute max sector
1299: 9040+19	071F  FD5E03  			ld 	e, (IY + NSECS + 1)		;NSECS by NTRKS
1300: 9059+11	0722  19      	diskanalyse7:	add	hl, de
1301: 9070+8+5	0723  10FD    			djnz	diskanalyse7			;multiply
1302: 9078+20	0725  FDCB0446			bit	0, (IY + NSIDES)
1303: 9098+7+5	0729  2801    			jr	z, diskanalyse9
1304: 9105+11	072B  29      			add	hl, hl				;double
1305: 9116+19	072C  FD7511  	diskanalyse9:	ld	(IY + PERMAXSEC), l		;save as low/hi pair
1306: 9135+19	072F  FD7412  			ld	(IY + PERMAXSEC + 1), h
1307:				
1308: 9154+7	0732  3E43    			ld	a, 'C'
1309: 9161+13	0734  32040D  			ld	(siorc), a
1310: 9174+19	0737  FD7E0E  			ld	a, (IY + FLAGS)			;return LATCH bytes
1311: 9193+4	073A  B7      			or	a				;return carry clear
1312: 9197+10	073B  C9      			ret
1313:				
1314:				;--------------------------------------------------
1315:				; readskew
1316:				;--------------------------------------------------
1317:     -	073C          	readskew:
1318: 9207+15	073C  FDE5    			push	iy
1319: 9222+10	073E  E1      			pop	hl
1320: 9232+10	073F  011400  			ld	bc, PERSKEWTAB
1321: 9242+11	0742  09      			add	hl, bc
1322: 9253+7	0743  0624    			ld	b, 36
1323: 9260+4	0745  EB      			ex	de, hl
1324: 9264+11	0746  D5      			push	de
1325:						
1326: 9275+11	0747  C5      	readskew1:	push	bc
1327: 9286+11	0748  D5      			push	de
1328: 9297+17	0749  CD3E08  			call	readidam
1329: 9314+10	074C  D1      			pop	de
1330: 9324+10	074D  C1      			pop	bc
1331:						
1332: 9334+10	074E  E1      			pop	hl
1333: 9344+11	074F  E5      			push	hl
1334: 9355+13	0750  3AFC0C  			ld	a, (idsector)
1335: 9368+11	0753  E5      	readskew6:	push	hl
1336: 9379+4	0754  B7      			or	a
1337: 9383+15	0755  ED52    			sbc 	hl, de
1338: 9398+10	0757  E1      			pop	hl
1339: 9408+7+5	0758  2806    			jr	Z, readskew4				;store value if c = 0		
1340: 9415+7	075A  BE      			cp	(hl)					;did we have this sector already?
1341: 9422+7+5	075B  2807    			jr	Z, readskew5				;get out of loop
1342: 9429+6	075D  23      			inc	hl
1343: 9435+12	075E  18F3    			jr	readskew6
1344:						
1345: 9447+7	0760  12      	readskew4:	ld	(de), a
1346: 9454+6	0761  13      			inc	de
1347: 9460+8+5	0762  10E3    			djnz	readskew1
1348:				
1349: 9468+4	0764  AF      	readskew5:	xor	a
1350: 9472+7	0765  12      			ld	(de), a
1351: 9479+10	0766  E1      			pop	hl
1352:						
1353:				;		call	sercr
1354:				;		ld	b, 36
1355:				;readskew2:	ld	a, (hl)
1356:				;		or	a
1357:				;		ret	Z
1358:				;		call	serhexspace
1359:				;		inc	hl
1360:				;		djnz	readskew2
1361: 9489+10	0767  C9      	readskew3:	ret
1362:						
1363:				;--------------------------------------------------
1364:				; checkmaxsec
1365:				; compare zero
1366:				; compare against max sector
1367:				;--------------------------------------------------
1368:     -	0768          	checkmaxsec:
1369: 9499+16	0768  2A020D  			ld	hl, (siosector)
1370: 9515+6	076B  2B      			dec	hl
1371:						
1372: 9521+19	076C  FD5612  			ld	d, (IY + PERMAXSEC + 1)		;siosec - maxsec
1373: 9540+19	076F  FD5E11  			ld	e, (IY + PERMAXSEC)
1374: 9559+4	0772  B7      			or	a
1375: 9563+15	0773  ED52    			sbc	hl, de
1376: 9578+4	0775  3F      			ccf
1377: 9582+5+6	0776  D0      			ret	NC
1378:				
1379: 9587+10	0777  C3EB07  			jp	setsioerror
1380:				
1381:     -	0001          		IF SALLYRS = 1
1382:				;--------------------------------------------------
1383:				; DRVINDEX 64 Bytes per drive
1384:				;--------------------------------------------------
1385:				
1386:     -	077A          	DRVINDEX:
1387: 9597+16	077A  2AFDC2  		ld	hl, (CFRAME + 2)
1388: 9613+16	077D  22020D  		ld	(siosector), hl
1389: 9629+16	0780  2AFBC2  		ld	hl, (CFRAME)
1390: 9645+16	0783  22000D  		ld	(siounit), hl
1391:					
1392: 9661+4	0786  7D      		ld	a, l	
1393:				;	ld	a,(CFRAME)	;GET DRIVE# FROM COMAND FRAME
1394: 9665+7	0787  D631    		sub	'1'
1395: 9672+7	0789  FE04    		cp	4
1396: 9679+4	078B  3F      		ccf
1397: 9683+5+6	078C  D8      		ret	C		;EXIT IF NOT DRIVE 1,2,3 OR 4
1398:				
1399: 9688+7	078D  2600    		ld	h,0
1400: 9695+4	078F  6F      		ld	l,a
1401: 9699+11	0790  29      		add	hl,hl
1402: 9710+11	0791  29      		add	hl,hl
1403: 9721+11	0792  29      		add	hl,hl
1404: 9732+11	0793  29      		add	hl,hl
1405: 9743+11	0794  29      		add	hl,hl
1406: 9754+11	0795  29      		add	hl,hl		;MULTIPLY DRIVE INDEX BY 64
1407:					
1408: 9765+10	0796  01070D  		ld	bc, drivedata
1409: 9775+11	0799  09      		add	hl, bc		;INDEX TO DRIVE'S PARAMETERS
1410: 9786+11	079A  E5      		push	hl
1411: 9797+14	079B  FDE1    		pop	iy		;GET POINTER INTO IY FOR RETURN
1412: 9811+20	079D  FDCB0876		bit	PRESENT, (IY + DSKBITS)
1413: 9831+4	07A1  37      		scf
1414: 9835+5+6	07A2  C8      		ret	Z		;EXIT IT DRIVE NOT PRESENT
1415:				
1416: 9840+14	07A3  DD2198FF		ld	IX, DKIOCB
1417: 9854+13	07A7  3299FF  		ld	(DKIOCB+DSKDRV), a
1418: 9867+4	07AA  AF      		xor	a
1419: 9871+10	07AB  C9      		ret
1420:				;
1421:					ENDIF
1422:				;
1423:								
1424:				;--------------------------------------------------
1425:				; getdrivelatch
1426:				;--------------------------------------------------
1427:     -	07AC          	getdrivelatch:
1428: 9881+13	07AC  3A99FF  			ld	a, (DKIOCB+DSKDRV)
1429: 9894+4	07AF  3C      			inc	a
1430: 9898+4	07B0  47      			ld	b, a
1431: 9902+4	07B1  AF      			xor	a
1432: 9906+4	07B2  37      			scf
1433: 9910+4	07B3  17      	getdrivelatch1:	rla
1434: 9914+8+5	07B4  10FD    			djnz	getdrivelatch1
1435: 9922+10	07B6  C9      			ret
1436:				
1437:				;--------------------------------------------------
1438:				; isspinning
1439:				;--------------------------------------------------
1440: 9932+11	07B7  DB40    	isspinning:	in	a, (STSREG)			;Motor on?
1441: 9943+7	07B9  E680    			and	10000000b			;mask bit 7 and clear carry
1442: 9950+5+6	07BB  C0      			ret	NZ				;yes
1443:						
1444: 9955+17	07BC  CDAC07  			call	getdrivelatch
1445: 9972+11	07BF  D330    			out	(LATCH), a			;fall through to getperiod
1446:						
1447:				;--------------------------------------------------
1448:				; getperiod
1449:				;--------------------------------------------------
1450: 9983+10	07C1  11B80B  	getperiod:	ld	de, 3000
1451:				
1452: 9993+6	07C4  1B      	getperiod1:	dec	de				;get an Index within x iterations
1453: 9999+4	07C5  7A      			ld	a, d
1454:10003+4	07C6  B3      			or	e
1455:10007+7+5	07C7  281C    			jr	z, getperiod4
1456:10014+17	07C9  CD2108  			call	getfdcstatus
1457:10031+7+5	07CC  3817    			jr	C, getperiod4			;no status at all
1458:10038+8	07CE  CB4F    			bit	1, a
1459:10046+7+5	07D0  28F2    			jr	z, getperiod1
1460:							
1461:10053+7	07D2  2600    			ld	h, 0
1462:						
1463:10060+17	07D4  CD2108  	getperiod2:	call	getfdcstatus
1464:10077+8	07D7  CB4F    			bit	1, a
1465:10085+7+5	07D9  20F9    			jr	nz, getperiod2
1466:				
1467:10092+6	07DB  23      	getperiod3:	inc	hl
1468:10098+17	07DC  CD2108  			call	getfdcstatus		
1469:10115+8	07DF  CB4F    			bit	1, a
1470:10123+7+5	07E1  28F8    			jr	z, getperiod3
1471:				
1472:				;		call	seraddr
1473:10130+4	07E3  B7      			or	a
1474:10134+10	07E4  C9      			ret
1475:						
1476:     -	07E5          	getperiod4:	
1477:10144+17	07E5  CD1FF2  			call	SalyResetFDC
1478:				
1479:10161+4	07E8  AF      			xor	a
1480:10165+11	07E9  D330    			out	(LATCH), a
1481:						
1482:10176+7	07EB  3E45    	setsioerror:	ld	a, 'E'
1483:10183+13	07ED  32040D  			ld	(siorc), a
1484:10196+4	07F0  37      			scf
1485:10200+10	07F1  C9      			ret
1486:						
1487:				;--------------------------------------------------
1488:				; seektrack
1489:				;--------------------------------------------------
1490:     -	07F2          	seektrack:
1491:10210+19	07F2  FD7E10  			ld	a, (IY + PERTRACK)		;populate track reg
1492:10229+11	07F5  D341    			out	(TRKREG), a			;from number stored
1493:10240+19	07F7  DD7E02  			ld	a, (IX + DSKTRK)		;seek to track
1494:10259+11	07FA  D343    			out	(DATREG), a			;into DATREG
1495:10270+19	07FC  FD7E13  			ld	a, (IY + PERSTEPRATE)
1496:10289+7	07FF  C610    			add	a, SKCMD	
1497:10296+11	0801  D340    	seektrack1:	out	(CMDREG), a			;issue step command
1498:10307+17	0803  CD2908  			call	waitstatus
1499:10324+19	0806  DD7E02  			ld	a, (IX + DSKTRK)		;update registers
1500:				;		out	(TRKREG), a
1501:10343+19	0809  FD7710  			ld	(IY + PERTRACK), a
1502:10362+10	080C  C9      			ret
1503:						
1504:				;--------------------------------------------------
1505:				; restoretrack
1506:				;--------------------------------------------------
1507:10372+19	080D  FD7E13  	restoretrack:	ld	a, (IY + PERSTEPRATE)
1508:10391+7	0810  C600    			add	a, RSTCMD
1509:10398+11	0812  D340    			out	(CMDREG), a
1510:10409+17	0814  CD2908  			call	waitstatus
1511:						
1512:10426+4	0817  AF      			xor	a
1513:10430+19	0818  FD7710  			ld	(IY + PERTRACK), a
1514:10449+19	081B  DD7702  			ld	(IX + DSKTRK), a
1515:10468+11	081E  D341    			out	(TRKREG), a
1516:10479+10	0820  C9      			ret
1517:				;--------------------------------------------------
1518:				; getfdcstatus
1519:				;--------------------------------------------------
1520:10489+11	0821  DB41    	getfdcstatus:	in	a, (TRKREG)			
1521:10500+11	0823  D343    			out	(DATREG), a
1522:10511+7	0825  3E10    			ld	a, SKCMD
1523:10518+11	0827  D340    			out	(CMDREG), a			
1524:						
1525:				;--------------------------------------------------
1526:				; waitstatus
1527:				;--------------------------------------------------
1528:10529+10	0829  013075  	waitstatus:	ld	bc, 30000
1529:				
1530:10539+7	082C  3E0E    	waitstatus1:	LD	A,14	
1531:10546+4	082E  3D      			DEC	A
1532:10550+7+5	082F  20FD    			JR	NZ,$-1	;DELAY 56 MICROSECONDS
1533:				
1534:10557+11	0831  DB40    			in	a, (STSREG)
1535:10568+4	0833  B7      			or	a
1536:10572+8	0834  CB47    			bit	0, a
1537:10580+5+6	0836  C8      			ret	z
1538:						
1539:10585+6	0837  0B      			dec	bc
1540:10591+4	0838  78      			ld	a, b
1541:10595+4	0839  B1      			or	a, c
1542:10599+7+5	083A  20F0    			jr	nz, waitstatus1
1543:						
1544:10606+4	083C  37      			scf
1545:10610+10	083D  C9      			ret
1546:						
1547:				;--------------------------------------------------
1548:				; read an IDAM
1549:				;--------------------------------------------------
1550:10620+10	083E  210600  	readidam:	ld	hl, 6
1551:10630+16	0841  229EFF  			ld	(DKIOCB + DSKAUX), hl
1552:10646+10	0844  21FA0C  			ld	hl, idambuf
1553:10656+16	0847  229CFF  			ld	(DKIOCB + DSKPTR), hl
1554:10672+7	084A  3EC0    			ld	a, RIDCMD
1555:				;		call	diskop					;fall through
1556:				;		ret
1557:						
1558:				
1559:				;--------------------------------------------------
1560:				; general disk operation
1561:				;--------------------------------------------------
1562:10679+13	084C  32C5FF  	diskop:		ld	(CMDBYT), a
1563:10692+10	084F  21EDA2  			ld	hl, 0a2edh	;12 LOAD HL WITH 'INI' OPCODE
1564:10702+8	0852  CB6F    			bit	5, a		;check if write command
1565:10710+7+5	0854  2801    			jr	z, diskop1
1566:10717+4	0856  24      			inc	h		;change to outi
1567:10721+16	0857  226600  	diskop1		LD	(NMIVEC), hl
1568:10737+10	085A  216800  			LD	HL,NMIVEC+2	;12
1569:10747+10	085D  36C9    			LD	(HL),0C9H	;10 STORE 'RET' OPCODE AFTER INI/OUTI
1570:				
1571:				;		call	resetcmd
1572:						
1573:				;		call	dumpiocb
1574:						
1575:10757+7	085F  0E43    			ld	c, DATREG
1576:10764+19	0861  DD7E06  			ld	a, (IX + DSKAUX)
1577:10783+4	0864  47      			ld	b, a
1578:10787+16	0865  2A9CFF  			ld	hl, (DKIOCB + DSKPTR)
1579:						
1580:10803+19	0868  DD7E03  			ld	a, (IX + DSKSEC)
1581:10822+11	086B  D342    			out	(SECREG), a
1582:				
1583:10833+13	086D  3AC5FF  			ld	a, (CMDBYT)				
1584:10846+11	0870  D340    			out	(CMDREG), a
1585:						
1586:10857+19	0872  DD7E07  			ld	a, (IX + DSKAUX+1)
1587:10876+8	0875  CB3F    			srl	a											;8
1588:10884+7+5	0877  280D    			jr	Z,read256	;JUMP IF BLOCKSIZE <= 256 BYTES						;12
1589:10891+8	0879  CB3F    			srl	a
1590:10899+7+5	087B  2806    			jr	Z,read512	;JUMP IF BLOCKSIZE <= 512 BYTES
1591:				
1592:				;
1593:				; 16 uS time at 500khZ
1594:				;
1595:10906+4	087D  76      	read1024:	halt
1596:10910+7+5	087E  20FD    			jr	NZ, $-1
1597:10917+4	0880  76      			halt
1598:10921+7+5	0881  20FD    			jr	NZ, $-1
1599:10928+4	0883  76      	read512:	halt
1600:10932+7+5	0884  20FD    			jr	NZ, $-1
1601:10939+4	0886  76      	read256:	halt
1602:10943+7+5	0887  20FD    			jr	NZ, $-1
1603:10950+17	0889  CD2908  			call	waitstatus	
1604:10967+11	088C  DB40    			in	a, (STSREG)		
1605:10978+7	088E  E67F    			and	01111111b
1606:10985+17	0890  CDD3F9  			call	SETSTAT
1607:11002+4	0893  7B      			ld	a, e
1608:11006+13	0894  32040D  			ld	(siorc), a
1609:11019+10	0897  C9      			ret
1610:						
1611:				;--------------------------------------------------
1612:				; sec2trk
1613:				; compute IX + DSKSEC and IX + DSKTRK from siosector
1614:				;--------------------------------------------------
1615:11029+16	0898  2A020D  	sec2trk:	ld	hl, (siosector)		;sector from SIO 
1616:11045+6	089B  2B      			dec	hl			;minus 1	
1617:11051+4	089C  AF      			xor	a			;track to zero
1618:11055+4	089D  57      			ld	d, a
1619:11059+19	089E  FD5E03  			ld	e, (IY + NSECS + 1)	;load DE with assumed sec per track
1620:						
1621:11078+4	08A1  B7      	sec2trk2:	or	a			;compute track number siosector / NSECS
1622:11082+15	08A2  ED52    			sbc	hl, de
1623:11097+7+5	08A4  3803    			jr	c, sec2trk1
1624:11104+4	08A6  3C      			inc	a
1625:11108+12	08A7  18F8    			jr	sec2trk2
1626:						
1627:11120+19	08A9  DD7702  	sec2trk1:	ld	(IX + DSKTRK), a	;track to be read
1628:11139+19	08AC  FDBE00  			cp	(IY + NTRKS)		;check if > NTRKS
1629:11158+7+5	08AF  3810    			jr	C, sec2trk3
1630:11165+19	08B1  FD9600  			sub	(IY + NTRKS)
1631:11184+19	08B4  DD7702  			ld	(IX + DSKTRK), a
1632:11203+13	08B7  3A2FFF  			ld	a, (OUTCPY)
1633:11216+8	08BA  CBEF    			set	5, a			;set head 1
1634:11224+13	08BC  322FFF  			ld	(OUTCPY), a
1635:11237+11	08BF  D330    			out	(LATCH), a
1636:					
1637:11248+4	08C1  7D      	sec2trk3:	ld	a, l
1638:11252+19	08C2  FD8603  			add	a, (IY + NSECS + 1)	;add NSECS we have subtracted too much 
1639:11271+4	08C5  3C      			inc 	a			;offset by 1
1640:11275+19	08C6  DD7703  			ld	(IX + DSKSEC),a		;store in IOCB
1641:						
1642:11294+10	08C9  C3F207  			jp	seektrack
1643:				
1644:				;--------------------------------------------------
1645:				; tryidam
1646:				;--------------------------------------------------
1647:11304+17	08CC  CD3E08  	tryidam:	call	readidam		;try to get an id in MFM / HD
1648:				
1649:11321+11	08CF  DB40    			in	a, (STSREG)
1650:11332+7	08D1  E61C    			and	00011100b
1651:						
1652:				;		push	af
1653:				;		push	af
1654:				;		ld	a, 'i'
1655:				;		call	seroutfn
1656:				;		pop	af
1657:				;		call	serhex
1658:				;		pop	af
1659:						
1660:11339+10	08D3  C9      			ret
1661:					
1662:				;--------------------------------------------------
1663:				; cmdwaitfn
1664:				;--------------------------------------------------
1665:     -	08D4          	cmdwaitfn:	;in	a, (STSREG)
1666:						;rla
1667:						;jr	c, cmdwaitfn1
1668:						;xor	a
1669:						;out	(LATCH), a
1670:						
1671:11349+13	08D4  3A55FF  	cmdwaitfn1:	LD	A, (CMDFLG)
1672:11362+4	08D7  B7      			OR	A					;SEE IF COMMAND FRAME HAS ARRIVED
1673:11366+5+6	08D8  C8      			RET	Z					;EXIT IF NOTHING HAS HAPPENED
1674:				
1675:11371+17	08D9  CD970B  			call	sercmd
1676:						
1677:11388+13	08DC  3A55FF  			LD	A, (CMDFLG)
1678:11401+7	08DF  FE01    			CP	1
1679:				
1680:11408+4	08E1  F3      			DI						;ELSE RESET INTERRUPT AND START AGAIN
1681:11412+7	08E2  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
1682:11419+11	08E4  D380    			OUT	(CTC0), A				;PERFORM THE RESET
1683:11430+4	08E6  FB      			EI
1684:				
1685:				;		JP	Z, CMDL4				;good cmd-frame
1686:												;fall through
1687:11434+7+5	08E7  2003    			JR	NZ, togglebaud
1688:     -	0000          		IF SALLYRS = 2
1690:					ENDIF
1691:11441+10	08E9  C3F5F7  			JP	CMDL4
1692:						
1693:				;--------------------------------------------------
1694:				; togglebaud
1695:				;--------------------------------------------------
1696:     -	08EC          	togglebaud:
1697:11451+13	08EC  3AE40C  			LD	A, (pokeydiv)
1698:11464+7	08EF  FE28    			CP	SIONORMAL
1699:11471+7	08F1  3E08    			LD	A, SIOFAST
1700:11478+7+5	08F3  2802    			JR	Z, togglebaud1
1701:11485+7	08F5  3E28    			LD	A, SIONORMAL
1702:     -	08F7          	togglebaud1:
1703:11492+13	08F7  32E40C  			LD	(pokeydiv), A
1704:				;		CALL	serhex
1705:11505+10	08FA  C310F8  			JP	CMDL5
1706:				
1707:				;--------------------------------------------------
1708:				; xmitbuffn
1709:				;--------------------------------------------------
1710:     -	08FD          	xmitbuffn:
1711:11515+4	08FD  F3      			DI
1712:11519+13	08FE  3AE40C  			LD	A, (pokeydiv)				;is fast?
1713:11532+7	0901  FE28    			CP	SIONORMAL
1714:11539+7+5	0903  2006    			JR	NZ, xmitfast				;yes, jump
1715:11546+10	0905  011BF7  			LD	BC, STARBIT
1716:11556+10	0908  C38AF6  			JP	SalyXMITBUF
1717:				
1718:				
1719:     -	090B          	xmitfast:
1720:11566+7	090B  3E07    			LD	A, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
1721:11573+11	090D  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
1722:11584+7	090F  3E01    			LD	A, 1					;TIME CONSTANT OF 1 - 4uS pulses (1/4Mhz)*16
1723:11591+11	0911  D381    			OUT	(CTC1), A
1724:				
1725:     -	0913          	xmitfast1:
1726:11602+7	0913  7E      			LD	A, (HL)					;7
1727:11609+6	0914  23      			INC	HL					;6
1728:11615+4	0915  AA      			XOR	D					;4
1729:11619+4	0916  4F      			LD	C, A					;4
1730:11623+4	0917  83      			ADD	A, E					;4
1731:11627+7	0918  CE00    			ADC	0					;7
1732:11634+4	091A  5F      			LD	E, A					;4
1733:11638+17	091B  CD2909  			CALL	fastsend				;17 send byte in c (53 T-States)
1734:11655+4	091E  7C      			LD	A, H					;4
1735:11659+7	091F  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
1736:11666+7+5	0921  38F0    			JR	C, xmitfast1				;12/7 loop if buffer end not reached
1737:				
1738:11673+7	0923  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
1739:11680+11	0925  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
1740:11691+4	0927  FB      			EI
1741:11695+10	0928  C9      			RET
1742:				
1743:     -	0929          	fastsend:
1744:11705+4	0929  AF      			XOR	A					;4
1745:11709+11	092A  D350    			OUT	(ATROUT), A				;11
1746:				
1747:11720+15	092C  DDE5    			PUSH	IX					;15
1748:11735+14	092E  DDE1    			POP	IX					;14
1749:11749+4	0930  79      			LD	A, C					;4
1750:11753+7	0931  0608    			LD	B, 8					;7
1751:11760+6	0933  03      			INC	BC					;6
1752:11766+4	0934  00      			NOP						;4
1753:				
1754:     -	0935          	fastsend1:
1755:11770+4	0935  00      			NOP						;4
1756:11774+7	0936  FE01    			CP	1					;7
1757:11781+11	0938  D350    			OUT	(ATROUT), A				;11
1758:11792+4	093A  0F      			RRCA						;4
1759:11796+15	093B  DDE5    			PUSH	IX					;15
1760:11811+14	093D  DDE1    			POP	IX					;14
1761:11825+8+5	093F  10F4    			DJNZ	fastsend1				;13 / 8
1762:				
1763:11833+9	0941  ED5F    			LD	A, r					;9
1764:11842+7	0943  3E01    			LD	A, 1					;7
1765:11849+11	0945  D350    			OUT	(ATROUT), A				;11
1766:								
1767:11860+10	0947  C9      			RET						;10
1768:						
1769:				
1770:				;--------------------------------------------------
1771:				; rxblck
1772:				;--------------------------------------------------
1773:     -	0948          	rxblck:
1774:11870+13	0948  3AE40C  			LD	A, (pokeydiv)				;is fast?
1775:11883+7	094B  FE28    			CP	SIONORMAL
1776:11890+10	094D  CA5909  			JP	Z, rxblck1
1777:				
1778:11900+17	0950  CD6409  			CALL	fastrecv				;yes, fast speed
1779:11917+7	0953  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
1780:11924+11	0955  D383    			OUT	(CTC3), A				;SOFWARE RESET CTC3
1781:11935+4	0957  4A      			LD	C, D					;checksum in c
1782:11939+10	0958  C9      			RET
1783:				
1784:     -	0959          	rxblck1:
1785:11949+10	0959  010000  			LD	BC, 0					;no, normal speed
1786:11959+10	095C  C3DEF6  			JP	SalyRXBLOCK
1787:				
1788:				
1789:				;--------------------------------------------------
1790:				; set 4ms watchdog
1791:				;--------------------------------------------------
1792:     -	095F          	irq4ms:
1793:11969+10	095F  F1      			POP	AF					;pop irq-addr
1794:11979+4	0960  B7      			OR	A					;clear carry
1795:     -	0961          	irq4ms1:
1796:11983+4	0961  FB      			EI
1797:11987+14	0962  ED4D    			RETI
1798:				
1799:				;--------------------------------------------------
1800:				; SIO receive 57600 baud
1801:				;--------------------------------------------------
1802:     -	0964          	fastrecv:
1803:12001+4	0964  F3      			DI
1804:12005+10	0965  015F09  			LD	BC, irq4ms
1805:12015+20	0968  ED4316FF			LD	(CTCVEC+6),bc				;SET VECTOR TO irq4ms ROUTINE
1806:12035+10	096C  018300  			LD	BC, CTC3				;CLEAR B, LOAD C WITH ADDRESS OF CTC3
1807:12045+10	096F  11A700  			LD	DE, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
1808:12055+12	0972  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
1809:12067+12	0974  ED49    			OUT	(C), C					;TIME CONSTANT OF 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
1810:12079+4	0976  FB      			EI
1811:				
1812:     -	0977          	fastrecv1:              
1813:12083+11	0977  DB70    			IN	A, (ATARI)				;11
1814:12094+4	0979  17      			RLA						;4
1815:12098+10	097A  DA7709  			JP	C, fastrecv1				;10	NEW BYTE IS COMING IF START BIT LOW
1816:												;14-25 / 7
1817:12108+4	097D  7A      			LD	A, D					;4
1818:12112+4	097E  80      			ADD	A, B					;4
1819:12116+7	097F  CE00    			ADC	A, 0					;7 ACCUMULATE CHECKSUM ATARI STYLE
1820:12123+4	0981  57      			LD	D, A					;4
1821:								
1822:12127+7	0982  067F    			LD	B, 07fh					;7
1823:12134+12	0984  1800    			jr	$+2					;10 = 50
1824:				;
1825:				; SERIAL->PARALLEL CONVERSION
1826:				; Pokey DIV 8 = 59114 / 59659 average 59400 baud equals about 68 T-states
1827:				;
1828:     -	0986          	fastrecv2:
1829:12146+11	0986  F5      			push	af					;11
1830:12157+10	0987  F1      			pop	af					;10
1831:12167+12	0988  ED78    			in	a, (c)					;12
1832:						
1833:12179+11	098A  DB70    			IN	A, (ATARI)				;11 CYCLES
1834:12190+4	098C  17      			RLA						; 4 CYCLES
1835:12194+8	098D  CB18    			RR	B					; 8 CYCLES
1836:12202+7+5	098F  38F5    			JR	C, fastrecv2				;12 = 69 / 65 cycles
1837:				
1838:12209+7	0991  70      			LD	(HL), B					;7 THEN STORE IN MEMORY BUFFER @HL
1839:12216+6	0992  23      			INC	HL					;6
1840:12222+4	0993  7C      			LD	A, H					;4
1841:12226+7	0994  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
1842:12233+4	0996  3F      			CCF						;4
1843:12237+5+6	0997  D8      			RET	C					;5 RETURN WITH CARRY SET IF BUFFER FILLED
1844:				
1845:12242+12	0998  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
1846:12254+12	099A  ED49    			OUT	(C), C					;12 COUNT MOD 256 - ACTUALLY C = 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
1847:				
1848:12266+10	099C  C37709  			JP	fastrecv1				;10 = 82 
1849:				
1850:     -	0001          		if SALLYDEBUG = 1 
1851:				;--------------------------------------------------
1852:				; debug and dump rouines
1853:				;--------------------------------------------------
1854:				
1855:				
1856:				;--------------------------------------------------
1857:				; dump sector inverted
1858:				;--------------------------------------------------
1859:     -	099F          	serdumpcpl:
1860:12276+11	099F  E5      			PUSH	HL
1861:12287+11	09A0  F5      			PUSH	AF
1862:12298+11	09A1  C5      			PUSH	BC
1863:12309+11	09A2  D5      			PUSH	DE
1864:12320+7	09A3  16FF    			LD	D, 255
1865:12327+10	09A5  C3B40B  			JP	serdump1
1866:				
1867:				
1868:				;--------------------------------------------------
1869:				; dump DKIOCB
1870:				;--------------------------------------------------
1871:12337+13	09A8  3AC5FF  	diskiodebug:	LD	a, (CMDBYT)
1872:12350+7	09AB  FE80    			CP	080h
1873:12357+7+5	09AD  201B    			JR	NZ, diskiodebug1
1874:						
1875:12364+17	09AF  CDEA0B  			call	serhex
1876:12381+19	09B2  DD7E02  			LD	A,(IX+DSKTRK)	
1877:12400+17	09B5  CDEA0B  			CALL	serhex
1878:12417+19	09B8  DD7E03  			LD	A,(IX+DSKSEC)	
1879:12436+17	09BB  CDEA0B  			CALL	serhex
1880:				
1881:12453+11	09BE  DB40    	dbgRWBUSY:	IN	A,(STSREG)
1882:12464+8	09C0  CB47    			BIT	0,A
1883:12472+7+5	09C2  20FA    			JR	NZ,dbgRWBUSY				;LOOP TILL 1797 BUSY BIT GOES AWAY
1884:12479+17	09C4  CDEA0B  			CALL	serhex
1885:				
1886:12496+17	09C7  CDCF0B  			CALL	sercr
1887:					
1888:12513+19	09CA  DD7E03  	diskiodebug1:	LD	A,(IX+DSKSEC)
1889:12532+10	09CD  C3E1F0  			JP	DISK4+3
1890:						
1891:				;--------------------------------------------------
1892:				; debug code for VR177x
1893:				; test 1 write/read TRKREG or SECREG 
1894:				;--------------------------------------------------
1895:12542+4	09D0  F3      			DI
1896:						
1897:12546+17	09D1  CDCF0B  			CALL	sercr	
1898:						
1899:12563+11	09D4  DB40    			in	a, (STSREG)
1900:12574+17	09D6  CDEA0B  			CALL	serhex
1901:12591+17	09D9  CDCF0B  			CALL	sercr
1902:				
1903:12608+17	09DC  CD230C  			call	serinfn
1904:						
1905:12625+7	09DF  0600    			LD	b, 0 
1906:12632+4	09E1  78      	dloop:		LD	a, b
1907:12636+17	09E2  CDEA0B  			CALL	serhex
1908:12653+17	09E5  CDC70B  			CALL	serspace
1909:							
1910:12670+11	09E8  D342    			out	(SECREG),a
1911:12681+7	09EA  0E04    			LD	c, 4				;4*8 = 32uS
1912:12688+4	09EC  0D      	dloop1:		DEC	c				;4
1913:12692+7+5	09ED  20FD    			JR	nz, dloop1			;12 = 16 T-states = 4uS
1914:						
1915:12699+11	09EF  DB42    			in	a,(SECREG)
1916:						
1917:12710+4	09F1  B8      			CP	b
1918:12714+7+5	09F2  2004    			JR	NZ, error
1919:12721+8+5	09F4  10EB    			DJNZ	dloop
1920:12729+12	09F6  18FE    	ok:		JR	ok
1921:						
1922:12741+7	09F8  3E45    	error:		ld	a, 'E'
1923:12748+17	09FA  CD030C  			CALL	seroutfn
1924:12765+12	09FD  18FE    	error1:		JR	error1
1925:				
1926:				;--------------------------------------------------
1927:				; dump 512 bytes at HL
1928:				;--------------------------------------------------
1929:12777+11	09FF  D5      	dumpsecinv	push	de
1930:12788+7	0A00  16FF    			ld	d, 255
1931:12795+12	0A02  1803    			jr	dumpsec1
1932:     -	0A04          	dumpsec:
1933:12807+11	0A04  D5      			push	de
1934:12818+7	0A05  1600    			ld	d, 0
1935:						
1936:12825+11	0A07  C5      	dumpsec1:	push	bc
1937:12836+11	0A08  E5      			push	hl
1938:12847+17	0A09  CDCF0B  			call	sercr
1939:12864+7	0A0C  0E10    			ld	c, 16
1940:						
1941:12871+17	0A0E  CDD70B  	dumpline:	call	seraddr
1942:12888+7	0A11  3E3A    			ld	a, ':'
1943:12895+17	0A13  CD030C  			call	seroutfn
1944:						
1945:12912+7	0A16  0610    			ld	b, 16
1946:12919+7	0A18  7E      	dumpline1:	ld	a, (hl)
1947:12926+4	0A19  AA      			xor	a, d
1948:12930+17	0A1A  CDE50B  			call	serhexspace
1949:12947+4	0A1D  78      			ld	a, b
1950:12951+7	0A1E  FE09    			cp	9
1951:12958+7+5	0A20  2003    			jr	NZ, dumpline5
1952:12965+17	0A22  CDC70B  			call	serspace
1953:12982+6	0A25  23      	dumpline5:	inc	hl
1954:12988+8+5	0A26  10F0    			djnz	dumpline1
1955:				
1956:12996+4	0A28  7A      			ld	a, d
1957:13000+10	0A29  11F0FF  			ld	de, -16				;subtract 16 from hl
1958:13010+11	0A2C  19      			add	hl, de
1959:13021+4	0A2D  57      			ld	d, a
1960:13025+7	0A2E  0610    			ld	b, 16
1961:13032+7	0A30  3E7C    			ld	a, '|'
1962:13039+17	0A32  CD030C  			call	seroutfn
1963:						
1964:13056+7	0A35  7E      	dumpline2:	ld	a, (hl)
1965:13063+4	0A36  AA      			xor	a, d
1966:13067+7	0A37  FE20    			cp	32
1967:13074+7+5	0A39  3804    			jr	C, dumpline3			;< 32
1968:13081+7	0A3B  FE7F    			cp	127				;< 127
1969:13088+7+5	0A3D  3802    			jr	C, dumpline4
1970:13095+7	0A3F  3E2E    	dumpline3:	ld	a, '.'		
1971:13102+17	0A41  CD030C  	dumpline4:	call	seroutfn
1972:13119+6	0A44  23      			inc	hl
1973:13125+8+5	0A45  10EE    			djnz	dumpline2
1974:						
1975:13133+7	0A47  3E7C    			ld	a, '|'
1976:13140+17	0A49  CD030C  			call	seroutfn
1977:13157+17	0A4C  CDCF0B  			call	sercr			
1978:						
1979:13174+4	0A4F  0D      			dec	c
1980:13178+7+5	0A50  20BC    			jr	NZ, dumpline
1981:						
1982:13185+10	0A52  E1      			pop	hl
1983:13195+10	0A53  C1      			pop	bc
1984:13205+10	0A54  D1      			pop	de
1985:13215+10	0A55  C9      			ret
1986:						
1987:				;--------------------------------------------------
1988:				; Dump Percom Block in IY
1989:				;--------------------------------------------------
1990:13225+11	0A56  F5      	dumppercom:	push	af
1991:13236+11	0A57  C5      			push	bc
1992:13247+11	0A58  D5      			push	de
1993:13258+11	0A59  E5      			push	hl
1994:						
1995:13269+15	0A5A  FDE5    			push	iy
1996:13284+10	0A5C  E1      			pop	hl
1997:						
1998:13294+17	0A5D  CDCF0B  			call	sercr
1999:						
2000:13311+7	0A60  3E54    			ld	a, 'T'
2001:13318+17	0A62  CD030C  			call	seroutfn
2002:13335+7	0A65  7E      			ld	a, (hl)
2003:13342+17	0A66  CDE50B  			call	serhexspace
2004:						
2005:13359+6	0A69  23      			inc	hl
2006:13365+7	0A6A  3E73    			ld	a, 's'
2007:13372+17	0A6C  CD030C  			call	seroutfn
2008:13389+7	0A6F  7E      			ld	a, (hl)
2009:13396+17	0A70  CDE50B  			call	serhexspace
2010:				
2011:13413+6	0A73  23      			inc	hl
2012:13419+7	0A74  3E53    			ld	a, 'S'
2013:13426+17	0A76  CD030C  			call	seroutfn
2014:13443+7	0A79  7E      			ld	a, (hl)
2015:13450+17	0A7A  CDEA0B  			call	serhex
2016:13467+6	0A7D  23      			inc	hl
2017:13473+7	0A7E  7E      			ld	a, (hl)
2018:13480+17	0A7F  CDE50B  			call	serhexspace
2019:				
2020:13497+6	0A82  23      			inc	hl
2021:13503+7	0A83  3E48    			ld	a, 'H'
2022:13510+17	0A85  CD030C  			call	seroutfn
2023:13527+7	0A88  7E      			ld	a, (hl)
2024:13534+17	0A89  CDE50B  			call	serhexspace
2025:				
2026:13551+6	0A8C  23      			inc	hl
2027:13557+7	0A8D  3E44    			ld	a, 'D'
2028:13564+17	0A8F  CD030C  			call	seroutfn
2029:13581+7	0A92  7E      			ld	a, (hl)
2030:13588+17	0A93  CDE50B  			call	serhexspace
2031:				
2032:13605+6	0A96  23      			inc	hl
2033:13611+7	0A97  3E4C    			ld	a, 'L'
2034:13618+17	0A99  CD030C  			call	seroutfn
2035:13635+7	0A9C  7E      			ld	a, (hl)
2036:13642+17	0A9D  CDEA0B  			call	serhex
2037:13659+6	0AA0  23      			inc	hl
2038:13665+7	0AA1  7E      			ld	a, (hl)
2039:13672+17	0AA2  CDE50B  			call	serhexspace
2040:						
2041:13689+6	0AA5  23      			inc	hl
2042:13695+7	0AA6  3E2D    			ld	a, '-'
2043:13702+17	0AA8  CD030C  			call	seroutfn
2044:13719+7	0AAB  7E      			ld	a, (hl)
2045:13726+17	0AAC  CDE50B  			call	serhexspace
2046:				
2047:13743+7	0AAF  0603    			ld	b, 3
2048:13750+6	0AB1  23      	dumppercom3:	inc	hl
2049:13756+7	0AB2  7E      			ld	a, (hl)
2050:13763+17	0AB3  CDE50B  			call	serhexspace
2051:13780+8+5	0AB6  10F9    			djnz	dumppercom3
2052:13788+17	0AB8  CDCF0B  			call	sercr
2053:				
2054:13805+15	0ABB  FDE5    			push	iy
2055:13820+10	0ABD  E1      			pop	hl
2056:13830+10	0ABE  011100  			ld	bc, PERMAXSEC
2057:13840+11	0AC1  09      			add	hl, bc
2058:13851+7	0AC2  7E      			ld	a, (hl)
2059:13858+6	0AC3  23      			inc	hl
2060:13864+11	0AC4  E5      			push	hl
2061:13875+7	0AC5  66      			ld	h, (hl)
2062:13882+6	0AC6  23      			inc	hl
2063:13888+4	0AC7  6F      			ld	l, a
2064:13892+7	0AC8  3E4D    			ld	a, 'M'
2065:13899+17	0ACA  CD030C  			call	seroutfn
2066:13916+17	0ACD  CDD70B  			call	seraddr
2067:								
2068:13933+17	0AD0  CDCF0B  			call	sercr
2069:						
2070:13950+10	0AD3  E1      			pop	hl
2071:13960+6	0AD4  23      			inc	hl
2072:13966+6	0AD5  23      			inc	hl
2073:13972+7	0AD6  0624    			ld	b, 36
2074:						
2075:13979+7	0AD8  7E      	dumppercom2:	ld	a, (hl)
2076:13986+4	0AD9  B7      			or	a
2077:13990+7+5	0ADA  2806    			jr	Z, dumppercom1
2078:13997+17	0ADC  CDE50B  			call 	serhexspace
2079:14014+6	0ADF  23      			inc	hl
2080:14020+8+5	0AE0  10F6    			djnz	dumppercom2
2081:						
2082:14028+17	0AE2  CDCF0B  	dumppercom1:	call	sercr
2083:14045+10	0AE5  E1      			pop	hl
2084:14055+10	0AE6  D1      			pop	de
2085:14065+10	0AE7  C1      			pop	bc
2086:14075+10	0AE8  F1      			pop	af
2087:14085+10	0AE9  C9      			ret
2088:						
2089:				;--------------------------------------------------
2090:				; Debug routine
2091:				;--------------------------------------------------
2092:14095+17	0AEA  CD030C  	debugtrk:	CALL	seroutfn
2093:14112+19	0AED  DD7E01  			LD	A, (IX + DSKDRV)
2094:14131+17	0AF0  CDEA0B  			CALL	serhex
2095:14148+7	0AF3  3E74    			LD	A, 't'
2096:14155+17	0AF5  CD030C  			CALL	seroutfn
2097:14172+19	0AF8  DD7E02  			LD	A, (IX + DSKTRK)
2098:14191+17	0AFB  CDEA0B  			CALL	serhex
2099:14208+7	0AFE  3E73    			LD	A, 's'
2100:14215+17	0B00  CD030C  			CALL	seroutfn
2101:14232+19	0B03  DD7E03  			LD	A, (IX + DSKSEC)
2102:14251+17	0B06  CDEA0B  			CALL	serhex
2103:14268+19	0B09  DD7E05  			LD	A, (IX + DSKPTR+1)
2104:14287+17	0B0C  CDEA0B  			CALL	serhex
2105:14304+19	0B0F  DD7E04  			LD	A, (IX + DSKPTR)
2106:14323+17	0B12  CDEA0B  			CALL	serhex
2107:14340+19	0B15  DD7E07  			LD	A, (IX + DSKAUX+1)
2108:14359+17	0B18  CDEA0B  			CALL	serhex
2109:14376+19	0B1B  DD7E06  			LD	A, (IX + DSKAUX)
2110:14395+17	0B1E  CDEA0B  			CALL	serhex
2111:				
2112:14412+17	0B21  CDC70B  			CALL	serspace
2113:14429+13	0B24  3AFEC2  			LD	A, (CFRAME+3)
2114:14442+17	0B27  CDEA0B  			CALL	serhex
2115:14459+13	0B2A  3AFDC2  			LD	A, (CFRAME+2)
2116:14472+17	0B2D  CDEA0B  			CALL	serhex
2117:14489+17	0B30  CDC70B  			CALL	serspace
2118:14506+19	0B33  FD7E03  			LD	A, (IY+NSECS+1)
2119:14525+17	0B36  CDEA0B  			CALL	serhex
2120:14542+19	0B39  FD7E00  			LD	A, (IY+NTRKS)
2121:14561+17	0B3C  CDEA0B  			CALL	serhex
2122:				
2123:14578+17	0B3F  CDCF0B  			CALL	sercr
2124:14595+10	0B42  C9      			RET
2125:				;--------------------------------------------------
2126:				; dump DKIOCB
2127:				;--------------------------------------------------
2128:     -	0B43          	dumpiocb:
2129:14605+11	0B43  F5      			PUSH	AF
2130:14616+11	0B44  C5      			PUSH	BC
2131:14627+11	0B45  E5      			PUSH	HL
2132:				
2133:14638+17	0B46  CDCF0B  			call	sercr
2134:14655+7	0B49  3E25    			ld	a, '%'
2135:14662+17	0B4B  CD030C  			call	seroutfn
2136:14679+13	0B4E  3AC5FF  			ld	a, (CMDBYT)
2137:14692+17	0B51  CDE50B  			call	serhexspace
2138:14709+7	0B54  3E40    			ld	a, '@'
2139:14716+17	0B56  CD030C  			call	seroutfn
2140:14733+16	0B59  2A9CFF  			ld	hl, (DKIOCB + DSKPTR)
2141:14749+17	0B5C  CDD70B  			call	seraddr
2142:14766+7	0B5F  3E23    			ld	a, '#'
2143:14773+17	0B61  CD030C  			call	seroutfn
2144:14790+16	0B64  2A9EFF  			ld	hl, (DKIOCB + DSKAUX)
2145:14806+17	0B67  CDD70B  			call	seraddr
2146:14823+7	0B6A  3E48    			ld	a, 'H'
2147:14830+17	0B6C  CD030C  			call	seroutfn
2148:14847+13	0B6F  3A2FFF  			ld	a, (OUTCPY)
2149:14860+4	0B72  07      			rlca
2150:14864+4	0B73  07      			rlca
2151:14868+4	0B74  07      			rlca
2152:14872+7	0B75  E601    			and	1
2153:14879+17	0B77  CDE50B  			call	serhexspace
2154:14896+7	0B7A  3E54    			ld	a, 'T'
2155:14903+17	0B7C  CD030C  			call	seroutfn
2156:14920+19	0B7F  DD7E02  			ld	a, (IX + DSKTRK)
2157:14939+17	0B82  CDE50B  			call 	serhexspace
2158:14956+7	0B85  3E53    			ld	a, 'S'
2159:14963+17	0B87  CD030C  			call	seroutfn
2160:14980+19	0B8A  DD7E03  			ld	a, (IX + DSKSEC)
2161:14999+17	0B8D  CDE50B  			call 	serhexspace
2162:15016+17	0B90  CDCF0B  			call	sercr
2163:				
2164:15033+10	0B93  E1      			POP	HL
2165:15043+10	0B94  C1      			POP	BC
2166:15053+10	0B95  F1      			POP	AF
2167:15063+10	0B96  C9      			RET
2168:				
2169:				;--------------------------------------------------
2170:				; RS232 sercmd
2171:				;--------------------------------------------------
2172:     -	0B97          	sercmd:
2173:15073+11	0B97  E5      			PUSH	HL
2174:15084+10	0B98  21FBC2  			LD	HL, CFRAME
2175:15094+17	0B9B  CDCF0B  			CALL	sercr
2176:15111+17	0B9E  CDA60B  			call	serouthl
2177:15128+17	0BA1  CDA60B  			call	serouthl		
2178:15145+12	0BA4  1809    			JR	serdump2
2179:						
2180:15157+7	0BA6  7E      	serouthl:	ld	a, (hl)
2181:15164+6	0BA7  23      			inc	hl
2182:15170+17	0BA8  CD030C  			call	seroutfn
2183:15187+10	0BAB  C3C70B  			jp	serspace
2184:				;--------------------------------------------------
2185:				; RS232 dump
2186:				;--------------------------------------------------
2187:     -	0BAE          	serdump:
2188:15197+11	0BAE  E5      			PUSH	HL
2189:     -	0BAF          	serdump2:
2190:15208+11	0BAF  F5      			PUSH	AF
2191:15219+11	0BB0  C5      			PUSH	BC
2192:15230+11	0BB1  D5      			PUSH	DE
2193:				
2194:15241+7	0BB2  1600    			LD	D, 0
2195:     -	0BB4          	serdump1:
2196:15248+7	0BB4  7E      			LD	A, (HL)
2197:15255+4	0BB5  AA      			XOR	D
2198:15259+17	0BB6  CDEA0B  			CALL	serhex
2199:15276+17	0BB9  CDC70B  			CALL	serspace
2200:15293+6	0BBC  23      			INC	HL
2201:15299+4	0BBD  7C      			LD	A, H
2202:15303+7	0BBE  FEC3    			CP	A, 0c3h
2203:15310+7+5	0BC0  38F2    			JR	C, serdump1
2204:				
2205:15317+10	0BC2  D1      			POP	DE
2206:15327+10	0BC3  C1      			POP	BC
2207:15337+10	0BC4  F1      			POP	AF
2208:15347+10	0BC5  E1      			POP	HL
2209:15357+10	0BC6  C9      			RET
2210:				
2211:				;--------------------------------------------------
2212:				; RS232 <space>
2213:				;--------------------------------------------------
2214:     -	0BC7          	serspace:
2215:15367+11	0BC7  F5      			PUSH	AF
2216:15378+7	0BC8  3E20    			LD	A, ' '
2217:15385+17	0BCA  CD030C  			CALL	seroutfn
2218:15402+10	0BCD  F1      			POP	AF
2219:15412+10	0BCE  C9      			RET
2220:				
2221:				;--------------------------------------------------
2222:				; RS232 <CR>
2223:				;--------------------------------------------------
2224:     -	0BCF          	sercr:
2225:15422+11	0BCF  F5      			PUSH	AF
2226:15433+7	0BD0  3E0D    			LD	A, CR
2227:15440+17	0BD2  CD030C  			CALL	seroutfn
2228:15457+10	0BD5  F1      			POP	AF
2229:15467+10	0BD6  C9      			RET
2230:				
2231:				;--------------------------------------------------
2232:				; RS232 output HL in hex
2233:				;--------------------------------------------------
2234:15477+11	0BD7  F5      	seraddr:	push	af
2235:15488+4	0BD8  7C      			ld	a, h
2236:15492+17	0BD9  CDEA0B  			call	serhex
2237:15509+4	0BDC  7D      			ld	a, l
2238:15513+17	0BDD  CDEA0B  			call	serhex
2239:15530+17	0BE0  CDC70B  			call	serspace
2240:15547+10	0BE3  F1      			pop	af
2241:15557+10	0BE4  C9      			ret
2242:						
2243:				;--------------------------------------------------
2244:				; RS232 output A in hex and trailing space
2245:				;--------------------------------------------------
2246:15567+17	0BE5  CDEA0B  	serhexspace:	call	serhex
2247:15584+12	0BE8  18DD    			jr	serspace
2248:						
2249:				;--------------------------------------------------
2250:				; RS232 output A in hex
2251:				;--------------------------------------------------
2252:     -	0BEA          	serhex:
2253:15596+11	0BEA  F5      			PUSH	AF
2254:15607+11	0BEB  F5      			PUSH	AF
2255:15618+4	0BEC  0F      			RRCA
2256:15622+4	0BED  0F      			RRCA
2257:15626+4	0BEE  0F      			RRCA
2258:15630+4	0BEF  0F      			RRCA
2259:15634+17	0BF0  CDF90B  			CALL	sernib
2260:15651+10	0BF3  F1      			POP	AF
2261:15661+17	0BF4  CDF90B  			CALL	sernib
2262:15678+10	0BF7  F1      			POP	AF
2263:15688+10	0BF8  C9      			RET
2264:				
2265:     -	0BF9          	sernib:
2266:15698+7	0BF9  E60F    			AND	0fh
2267:15705+7	0BFB  C630    			ADD	'0'
2268:15712+7	0BFD  FE3A    			CP	'9' + 1
2269:15719+7+5	0BFF  3802    			JR	C, sernib1
2270:15726+7	0C01  C607    			ADD	7
2271:     -	0C03          	sernib1:
2272:				;--------------------------------------------------
2273:				; RS232 out	208 T-States
2274:				;--------------------------------------------------
2275:     -	0C03          	seroutfn:
2276:15733+11	0C03  F5      			PUSH	AF
2277:15744+11	0C04  C5      			PUSH	BC
2278:15755+4	0C05  47      			LD	B, A
2279:15759+4	0C06  AF      			XOR	A
2280:15763+4	0C07  F3      			DI
2281:15767+11	0C08  D351    			OUT	(SEROUT), A				;startbit
2282:15778+17	0C0A  CD3A0C  			CALL	time19600				;17
2283:					
2284:15795+4	0C0D  78      			LD	A, B	
2285:15799+7	0C0E  0608    			LD	B, 8					;7
2286:     -	0C10          	serout1:	
2287:15806+11	0C10  D351    			OUT	(SEROUT), A				;11
2288:15817+17	0C12  CD3A0C  			CALL	time19600				;17
2289:15834+4	0C15  0F      			RRCA						;4
2290:15838+8+5	0C16  10F8    			DJNZ	serout1					;8
2291:15846+4	0C18  FB      			EI	
2292:				
2293:15850+7	0C19  3E01    			LD	A, 1					;7 stopbit
2294:15857+11	0C1B  D351    			OUT	(SEROUT), A				;11
2295:15868+17	0C1D  CD3A0C  			CALL	time19600				;17
2296:				
2297:15885+10	0C20  C1      			POP	BC
2298:15895+10	0C21  F1      			POP	AF
2299:15905+10	0C22  C9      			RET
2300:				
2301:				
2302:				;--------------------------------------------------
2303:				; RS232 in	208 T-States
2304:				;--------------------------------------------------
2305:     -	0C23          	serinfn:
2306:15915+11	0C23  C5      			PUSH	BC
2307:     -	0C24          	serin2:
2308:15926+11	0C24  DB50    			IN	A, (SERIN)
2309:15937+4	0C26  07      			RLCA
2310:15941+7+5	0C27  38FB    			JR	C, serin2
2311:				
2312:15948+19	0C29  E3      			EX	(SP), HL				;19, 4.75uS
2313:15967+19	0C2A  E3      			EX	(SP), HL				;19  9uS
2314:				
2315:15986+7	0C2B  0680    			LD	B, 80h
2316:     -	0C2D          	serin1:
2317:15993+17	0C2D  CD3A0C  			CALL	time19600
2318:16010+11	0C30  DB50    			IN	A, (SERIN)
2319:16021+4	0C32  07      			RLCA
2320:16025+8	0C33  CB18    			RR	B
2321:16033+7+5	0C35  30F6    			JR	NC, serin1
2322:				
2323:16040+4	0C37  78      			LD	A, B
2324:16044+10	0C38  C1      			POP	BC
2325:16054+10	0C39  C9      			RET
2326:				
2327:     -	0C3A          	time19600:
2328:16064+7	0C3A  0E09    			LD	C, 9					;4
2329:     -	0C3C          	time19600a:
2330:16071+4	0C3C  0D      			DEC	C					;4
2331:16075+7+5	0C3D  20FD    			JR	NZ, time19600a				;12/7
2332:16082+10	0C3F  C9      			RET						;10
2333:				
2334:					ENDIF
2335:				ENDIF	; SALLYBUILD
2336:				
2337:     -	0001          	IF WD1772
2338:     -	0C40          	SalyCMDOUT:
2339:16092+11	0C40  D340    			OUT	(CMDREG),A				;OUTPUT DISK CONTROLLER COMMAND BYTE
2340:     -	0C42          	slyCMDT1:
2341:16103+7	0C42  3E0E    			LD	A,14
2342:     -	0C44          	slyCMDT2:
2343:16110+4	0C44  3D      			DEC	A
2344:16114+7+5	0C45  20FD    			JR	NZ,slyCMDT2				;DELAY 56 MICROSECONDS
2345:     -	0C47          	CMDT3:
2346:16121+11	0C47  DB40    			IN	A, (STSREG)
2347:16132+8	0C49  CB47    			BIT	0, A
2348:16140+7+5	0C4B  20F5    			JR	NZ, slyCMDT1
2349:16147+10	0C4D  C9      			RET
2350:				ENDIF
2351:				
2352:				;--------------------------------------------------
2353:				; 11 times port:value
2354:				;--------------------------------------------------
2355:     -	0C4E  5001    	INITAB:		DEFB	ATROUT,1				;SET ATART OUTPUT TO MARK STATE
2356:     -	0C50  5101    			DEFB	SEROUT,1				;SET RS232 OUTPUT TO MARK STATE
2357:     -	0C52  8003    			DEFB	CTC0, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
2358:     -	0C54  8010    			DEFB	CTC0, low ctcvec			;SET CTC0 BASE INTERRUPT VECTOR
2359:     -	0C56  8107    			DEFB	CTC1, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	;PUT CTC1 IN TIMER MODE + SET TIME CONSTANT
2360:     -	0C58  8101    			DEFB	CTC1, 1					;CTC1 TIME CONSTANT (DIVIDE BY 1 - 6.5us)
2361:     -	0C5A  8203    			DEFB	CTC2, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC2
2362:     -	0C5C  8303    			DEFB	CTC3, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC3
2363:     -	0C5E  5701    			DEFB	CDMUX, 1				;SET MUX TO PASS ATARI DATA
2364:     -	0001          		IF WD1772
2365:     -	0C60  3050    			DB	LATCH, 050h				;DRIVE CONTROL reset FDC
2366:     -	0C62  3040    			DB	LATCH, 040h				;DRIVE CONTROL 8Mhz
2367:					ELSE
2370:					ENDIF	;WD1772
2371:     -	0016          	ITBLEN		EQU	$-INITAB
2372:				;
2373:				;
2374:				;
2375:				;
2376:				;
2377:				;
2378:				
2379:     -	0001          		IF SALLYRS = 1
2380:				;
2381:     -	0C64          	DISKTAB:			;DISK COMMANDS
2382:     -	0C64  0900    		DEFW	DISKMAX
2383:				
2384:     -	0C66  52      		DEFB	'R'		;DISK READ
2385:     -	0C67  53      		DEFB	'S'		;DISK STATUS
2386:     -	0C68  57      		DEFB	'W'		;DISK WRITE
2387:     -	0C69  50      		DEFB	'P'		;DISK PUT
2388:     -	0C6A  4E      		DEFB	'N'		;N GET PARAMETERS
2389:     -	0C6B  4F      		DEFB	'O'		;O PUT PARAMETERS
2390:     -	0C6C  21      		DEFB	'!'		;FORMAT DISK
2391:     -	0C6D  3F      		DEFB	'?'		;? get speed byte
2392:     -	0C6E  22      		DEFB	'"'		;" format medium density
2393:				
2394:     -	0C6F  E704    		DEFW	diskformat
2395:     -	0C71  5703    		DEFW	getspeed
2396:				;	DEFW	DISKINIT
2397:     -	0C73  E704    		DEFW 	diskformat
2398:     -	0C75  44FB    		DEFW	PUTPARAMS
2399:     -	0C77  6A03    		DEFW	GETPARAMS
2400:				;	DEFW	DISKPUT
2401:				;	DEFW	DISKWRITE	
2402:				;	DEFW	DISKSTAT
2403:				;	DEFW	DISKREAD
2404:     -	0C79  8B04    		DEFW	diskwritefn
2405:     -	0C7B  8B04    		DEFW	diskwritefn
2406:     -	0C7D  8D03    		DEFW	diskstatus
2407:     -	0C7F  EA03    		DEFW	diskreadfn
2408:						
2409:     -	0009          	DISKMAX	EQU	($-(DISKTAB+2))/3
2410:				
2411:				;
2412:				;
2413:				;
2414:     -	0C81          	FMTS:
2415:     -	0C81  DEFD    		DEFW	DD8N26		;DOUBLE DENSITY 8 INCH
2416:     -	0C83  21FE    		DEFW	SKEW17
2417:     -	0C85  1A      		DEFB	26
2418:     -	0C86  B028    		DEFW	10416
2419:				
2420:     -	0C88  74FD    		DEFW	DD5N18		;DOUBLE DENSITY 5 INCH
2421:     -	0C8A  A7FD    		DEFW	SKEWDD
2422:     -	0C8C  12      		DEFB	18
2423:     -	0C8D  6A18    		DEFW	6250
2424:				
2425:     -	0C8F  B9FD    		DEFW	SD8N26		;SINGLE DENSITY 8 INCH
2426:     -	0C91  07FE    		DEFW	SKEW13
2427:     -	0C93  1A      		DEFB	26
2428:     -	0C94  5814    		DEFW	5208
2429:				
2430:     -	0C96  55FD    		DEFW	SD5N18		;SINGLE DENSITY 5 INCH
2431:     -	0C98  95FD    		DEFW	SKEWSD
2432:     -	0C9A  12      		DEFB	18
2433:     -	0C9B  350C    		DEFW	3125
2434:					
2435:     -	0C9D  A40C    		DEFW	DD5N26		;DOUBLE DENSITY 128B/sec 26 secs
2436:     -	0C9F  C70C    		DEFW	SKEWMD		;Medium or Enhanced density (ATARI 1050)
2437:     -	0CA1  1A      		DEFB	26
2438:     -	0CA2  6419    		DEFW	6500		;6238
2439:				;
2440:				;
2441:				;
2442:				
2443:     -	0CA4  01      	DD5N26:	DEFB	1
2444:     -	0CA5  324E    		DEFB	50, 4EH
2445:						
2446:     -	0CA7  0C      		DEFB	12
2447:     -	0CA8  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
2448:     -	0CAA  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
2449:     -	0CAC  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
2450:     -	0CAE  0100    		DEFB	1,0		;TRACK#
2451:     -	0CB0  0100    		DEFB	1,00000000B	;SIDE
2452:     -	0CB2  0100    		DEFB	1,0		;SECTOR#
2453:     -	0CB4  0100    		DEFB	1,00000000B	;LENGTH
2454:     -	0CB6  01F7    		DEFB	1,0F7H		;GENERATE CRC
2455:     -	0CB8  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
2456:     -	0CBA  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
2457:     -	0CBC  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
2458:     -	0CBE  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
2459:				
2460:     -	0CC0  03      		DEFB	3
2461:     -	0CC1  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
2462:     -	0CC3  1200    		DEFB	18,00H
2463:     -	0CC5  204E    		DEFB	32,4EH		;FIRST PART OF GAP 3
2464:					
2465:     -	0CC7  01030507	SKEWMD:	DEFB	1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25
	              090B0D0F
	              11131517
	              19
2466:     -	0CD4  02040608		DEFB	2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26
	              0A0C0E10
	              12141618
	              1A
2467:					
2468:					ENDIF
2469:					
2470:     -	0001          	IF SALLYBUILD
2471:				
2472:     -	0000          		IF SALLYRS = 0
2483:					ENDIF
2484:				;
2485:				; direct MSDOS sector for each drive
2486:				;
2487:     -	0CE1  0000    	dsector:	DB	0, 0
2488:     -	0CE3  00      	direct:		DB	0
2489:				
2490:     -	0CE4  28      	pokeydiv:	DB	SIONORMAL
2491:				
2492:     -	0CE5  FF      	drive:		DB	255
2493:     -	0CE6  FF      	thetrack:	DB	255
2494:     -	0CE7  0000    	secptr:		DW	0
2495:				
2496:     -	0CE9  95FD    	skewtab:	DW	SKEWSD
2497:     -	0CEB  07FE    			DW	SKEW13
2498:     -	0CED  A7FD    			DW	SKEWDD
2499:     -	0CEF  21FE    			DW	SKEW17
2500:				
2501:     -	0CF1  00      	dcb:		DB	0					;DISK OPERATION CODE
2502:     -	0CF2  00      			DB	0					;DRIVE# (WITH SIDE# IN BIT 7)
2503:     -	0CF3  00      			DB	0					;TRACK#
2504:     -	0CF4  00      			DB	0					;SECTOR#
2505:     -	0CF5  0000    			DW	0					;READ/WRITE POINTER
2506:     -	0CF7  0000    			DW	0					;AUXILLIARY PARAMETERS (2 BYTES)
2507:     -	0CF9  00      			DB	0					;OPERATION COMPLETION STATUS
2508:				
2509:     -	0CFA          	idambuf:
2510:     -	0CFA  00      	idtrack:	db	0
2511:     -	0CFB  00      	idside:		db	0
2512:     -	0CFC  00      	idsector:	db	0
2513:     -	0CFD  00      	idseclen:	db	0
2514:     -	0CFE  0000    	idcrc:		dw	0
2515:				
2516:     -	0D00  00      	siounit:	db	0
2517:     -	0D01  00      	siocmd:		db	0
2518:     -	0D02  0000    	siosector:	dw	0
2519:				
2520:     -	0D04  00      	siorc:		db	0
2521:     -	0D05  0000    	siobuffer:	dw	0
2522:				
2523:     -	0D07          	drivedata:
2524:				;
2525:				;
2526:				;	... DATA STRUCTURE FOR DRIVE PARAMETER BLOCKS ...
2527:				;
2528:				;NTRKS		EQU	0		;NUMBER OF TRACKS
2529:				;STEPRT		EQU	1		;STEP RATE
2530:				;NSECS		EQU	2		;SECTORS PER TRACK (HI/LOW)
2531:				;NSIDES		EQU	4		;NUMBER OF SIDES
2532:				;MEDIA		EQU	5		;MEDIA SIZE AND FORMAT BITS
2533:				;SECLEN		EQU	6		;SECTOR LENGTH (HI/LOW)
2534:				;DSKBITS	EQU	8		;MISC NAUGHTY BITS
2535:				;SPARE0		EQU	9
2536:				;SPARE1		EQU	10
2537:				;SPARE2		EQU	11
2538:				;	
2539:				;CMDSTS		EQU	12		;COMMAND STATUS
2540:				;HDWSTS		EQU	13		;HARDWARE STATUS
2541:				;	
2542:				;FLAGS		EQU	14		;FLAGS BYTE FOR DISK OPERATION
2543:				;SPARE3		EQU	15
2544:				
2545:     -	000F          	PERCONFIG	equ	SPARE3
2546:				
2547:     -	0010          	PERTRACK	equ 	16
2548:     -	0011          	PERMAXSEC	equ	17
2549:     -	0013          	PERSTEPRATE	equ	19
2550:     -	0014          	PERSKEWTAB	equ	20		;NSECS+1 bytes for sector skew
2551:				
2552:     -	0000          	DDHD		equ	0
2553:				
2554:     -	0E07          			org	$ + 256
2555:						
2556:				
2557:						include	version.asm
**** ..\src\version.asm ****
   1:     -	0E07  73616C6C	SVERSION DB "sally-1.0.5-11-g" 
	              792D312E
	              302E352D
	              31312D67
**** ..\src\SYSINIT.MAC ****
2558:						
2559:16157+4	0E17  F3      			di
2560:16161+10	0E18  210080  			ld	hl,08000h
2561:16171+10	0E1B  110000  			ld	de,00000h
2562:16181+10	0E1E  010080  			ld	bc,08000h
2563:16191+16+5	0E21  EDB0    			ldir
2564:16207+10	0E23  C31000  			jp	RAMTST
2565:				ENDIF	;SALLYBUILD
2566:				;
2567:				;
**** ..\src\sally2rs.asm ****
  16:				;
  17:				;	PHASE TO RAM-RESIDENT PART OF PROGRAM
  18:				;
  19:     -	0E26          	MONCOPY		EQU	$
  20:     -	F000          			.PHASE	0F000H
  21:				;
  22:				;
  23:     -	F000          	MONITOR		EQU	$
  24:16217+10	F000  C31BF0  			JP	RESTART
  25:16227+10	F003  C3E0F3  			JP	MINIMON		;MONITOR WARM ENTRY POINT
  26:16237+10	F006  C337F6  	CSV:		JP	CONST		;CONSOLE STATUS
  27:16247+10	F009  C342F6  	CIV:		JP	CONIN		;CONSOLE INPUT
  28:16257+10	F00C  C352F6  	COV:		JP	CONOUT		;CONSOLE OUTPUT
  29:16267+10	F00F  C322F0  	DISKV:		JP	DISKDVR		;DISK HANDLER
  30:16277+10	F012  C3DEF4  	LISTV:		JP	CENTOUT		;PARALLEL PRINTER OUT
  31:16287+10	F015  C3EDF4  			JP	CENTRDY		;PARALLEL PRINTER STATUS
  32:16297+10	F018  C317F6  	RENEW:		JP	CINIT2		;CONSOLE PORT INITAILZATION
  33:				;
  34:     -	F01B          	RESTART:	
  35:16307+4	F01B  F3      			DI
  36:16311+4	F01C  AF      			XOR	A
  37:16315+11	F01D  D352    			OUT	(BANKSW),A
  38:16326+10	F01F  C30000  			JP	0			;JUMP TO ROM
  39:				;
  40:				;
  41:				;
  42:						INCLUDE	DISKIO.MAC
**** ..\src\DISKIO.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	DISK I/O DRIVER FOR ATARI BOX.	18-FEB-82	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	EQUATES FOR DISK CONTROLLER PORTS AND COMMAND CODES
   9:				;
  10:     -	0040          	STSREG		EQU	WD179X+0	;STATUS REGISTER
  11:     -	0040          	CMDREG		EQU	WD179X+0	;COMMAND REGISTER
  12:     -	0041          	TRKREG		EQU	WD179X+1	;TRACK REGISTER
  13:     -	0042          	SECREG		EQU	WD179X+2	;SECTOR REGISTER
  14:     -	0043          	DATREG		EQU	WD179X+3	;DATA REGISTER
  15:				;
  16:				;	TYPE I COMMANDS LOW NIBBLE
  17:				;
  18:     -	0000          	STEPRATE0	EQU 0			;6ms,  3 ms if 179x and 2 MHz
  19:     -	0001          	STEPRATE1	EQU 1			;12ms, 6 ms if 179x and 2 MHz
  20:     -	0002          	STEPRATE2	EQU 2			;20ms, 10ms if 179x and 2 MHz, 2ms if WD1772
  21:     -	0003          	STEPRATE3	EQU 3			;30ms, 15ms if 179x and 2 MHz, 3ms if WD1772
  22:				;
  23:				;	TYPE I AND TYPE II COMMANDS LOW NIBBLE
  24:				;	1770/1772 only
  25:     -	0000          	SPINWAIT	EQU 00000000B		;1770/1772: Enable spin up sequence
  26:     -	0008          	NOWAITMTR	EQU 00001000B		;1770/1772: Disable spin up sequence
  27:				;
  28:				;	TYPE II COMMANDS LOW NIBBLE
  29:				;	(F1)
  30:     -	0002          	SIDECMP		EQU	00000010B	;1791/1793: Side Select Compare Enabled \ 1795/1797: Update SSO to 1 \ 1773: Enable Side Compare
  31:				;
  32:				;	(F2) - Read Sector and Write Sector commands only
  33:     -	0008          	SIDESEL		EQU	00001000B	;1791/1793/1773: Side Select Compare for Side 1 \ 1795/1797: Interpret Sector Len Field 00=128, 01=256, 10=512,  11=1024
  34:				;		EQU	00000000B	;1791/1793/1773: Side Select Compare for Side 0 \ 1795/1797: Interpret Sector Len Field 00=256, 01=512, 10=1024, 11=128
  35:				;
  36:				;	TYPE II AND TYPE III COMMANDS LOW NIBBLE
  37:				;
  38:     -	0004          	SETTLE		EQU	00000100B	;179x: Add 15ms delay (2MHz)
  39:     -	0002          	WRPCOMP		EQU	00000010B	;1770/1772/1773 Write Sector and Write Track commands only: Disable Write Precompensation
  40:				;
  41:				;
  42:     -	0001          		IF WD1772
  43:     -	0000          	HLOAD		EQU	SPINWAIT	; Sally2
  44:     -	0000          	STEPRATE	EQU	STEPRATE0	; Sally2 - 6/3ms step rate
  45:					ELSE
  48:					ENDIF
  49:				;
  50:				;
  51:     -	00C0          	RIDCMD		EQU	11000000B	;READ ID COMMAND
  52:     -	0001          		IF WD1772
  53:     -	0080          	RDCMD		EQU	10000000B	;READ COMMAND
  54:     -	00A0          	WRTCMD		EQU	10100000B	;WRITE COMMAND
  55:					ELSE
  58:					ENDIF
  59:     -	00D0          	FINCMD		EQU	11010000B	;FORCE INTERRUPT COMMAND
  60:     -	0010          	SKCMD		EQU	00010000B	;SEEK COMMAND
  61:     -	0000          	RSTCMD		EQU	00000000B	;RESTORE COMMAND
  62:     -	0060          	STEPOUT		EQU	01100000B	;STEP OUT COMMAND
  63:     -	0040          	STEPIN		EQU	01000000B	;STEP IN COMMAND
  64:     -	00E0          	RDTRK		EQU	11100000B	;READ TRACK COMMAND
  65:     -	00F0          	WRTRK		EQU	11110000B	;WRITE TRACK COMMAND
  66:     -	00E4          	RDTKDLY		EQU	RDTRK+100B	;WRITE TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  67:     -	00F4          	WRTKDLY		EQU	WRTRK+100B	;READ TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  68:				;
  69:				;
  70:				; Drive control LATCH (U24)
  71:				;
  72:     -	0001          	DRVSEL1		EQU	00000001B	; 1 = select drive 1
  73:     -	0002          	DRVSEL2		EQU	00000010B	; 1 = select drive 2
  74:     -	0004          	DRVSEL3		EQU	00000100B	; 1 = select drive 3
  75:     -	0008          	DRVSEL4		EQU	00001000B	; 1 = select drive 4
  76:     -	0010          	FDCRESET	EQU	00010000B	; 1 = Put FDC chip in reset, 0 = Release FDC chip from reset
  77:     -	0020          	FDCSIDE		EQU	00100000B	; Side select pin on floppy connector
  78:     -	0040          	FBS		EQU	01000000B	; 0 = B, 1 = S
  79:     -	0080          	FDENSITY	EQU	10000000B	; 0 = Double, 1 = Single
  80:				;
  81:				;
  82:				;
  83:     -	0066          	NMIVEC		EQU	0066H
  84:				;
  85:				;
  86:				;
  87:				;
  88:				;	... DATA STRUCTURE FOR DISK I/O CONTROL BLOCK ...
  89:				;
  90:     -	0000          	DSKOP		EQU	0		;DISK OPERATION CODE
  91:     -	0001          	DSKDRV		EQU	1		;DRIVE# (WITH SIDE# IN BIT 7)
  92:     -	0002          	DSKTRK		EQU	2		;TRACK#
  93:     -	0003          	DSKSEC		EQU	3		;SECTOR#
  94:     -	0004          	DSKPTR		EQU	4		;READ/WRITE POINTER
  95:     -	0006          	DSKAUX		EQU	6		;AUXILLIARY PARAMETERS (2 BYTES)
  96:     -	0008          	DSKSTS		EQU	8		;OPERATION COMPLETION STATUS
  97:				;
  98:				;
  99:				;	... DISK DRIVER OPERATION CODE DEFINITIONS ...
 100:				;
 101:     -	0000          	TSTRDY		EQU	0		;SELECT DRIVE AND TEST READY
 102:     -	0001          	GETSEC		EQU	1		;READ SECTOR
 103:     -	0002          	PUTSEC		EQU	2		;WRITE SECTOR
 104:     -	0003          	GETID		EQU	3		;READ ID MARK
 105:				;
 106:				;
 107:				;
 108:     -	F022          	DISKDVR:
 109:16336+17	F022  CDAFF3  		CALL	STOPTMR		;KILL DISK TIMER INTERRUPT FROM CTC3
 110:16353+19	F025  DD7E00  		LD	A,(IX+DSKOP)
 111:16372+4	F028  B7      		OR	A
 112:16376+7+5	F029  2845    		JR	Z,TESTDRV	;JUMP IF TEST READY OPERATION
 113:16383+7	F02B  0680    		LD	B,RDCMD
 114:16390+4	F02D  3D      		DEC	A
 115:16394+7+5	F02E  2873    		JR	Z,SETSSO	;JUMP IF DISK READ OPERATION
 116:16401+7	F030  06A0    		LD	B,WRTCMD
 117:16408+4	F032  3D      		DEC	A
 118:16412+7+5	F033  286E    		JR	Z,SETSSO	;JUMP IF DISK WRITE OPERATION
 119:16419+4	F035  3D      		DEC	A
 120:16423+7+5	F036  2857    		JR	Z,READID	;JUMP IF DISK ID READ OPERATION
 121:16430+19	F038  DD3608FF		LD	(IX+DSKSTS),255	;ELSE SET ALL ERROR BITS AND RETURN
 122:				
 123:     -	F03C          	ACTIVON:
 124:16449+4	F03C  F3      		DI
 125:16453+7	F03D  3EA7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 126:16460+11	F03F  D383    		OUT	(CTC3),A	;PUT CTC3 IN TIMER MODE, PRESCALE 256
 127:16471+4	F041  AF      		XOR	A			;TIME CONSTANT OF 0 WHICH MEANS 256
 128:16475+11	F042  D383    		OUT	(CTC3),A	;COUNT MOD 256
 129:16486+4	F044  3D      		DEC	A
 130:16490+13	F045  32C9FF  		LD	(DRVTMR),A	;STOP DRIVES AFTER 255 INTERRUPTS
 131:16503+10	F048  2150F0  		LD	HL,ACTIVTY
 132:16513+16	F04B  2216FF  		LD	(CTCVEC+6),HL	;SET VECTOR TO ACTIVITY-CHECK ROUTINE
 133:16529+4	F04E  FB      		EI
 134:16533+10	F04F  C9      		RET
 135:				;
 136:				;
 137:				;
 138:     -	F050          	ACTIVTY:
 139:16543+11	F050  F5      		PUSH	AF
 140:16554+13	F051  3AC9FF  		LD	A,(DRVTMR)
 141:16567+4	F054  3D      		DEC	A
 142:16571+13	F055  32C9FF  		LD	(DRVTMR),A
 143:16584+7+5	F058  200A    		JR	NZ,ACTV2	;EXIT IF 4 SECONDS NOT ELAPSED
 144:				
 145:16591+17	F05A  CD68F0  		call	shutdown
 146:16608+7	F05D  3E21    		LD	A, CTC_D7_INT_DIS + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D0_CONTROL
 147:16615+11	F05F  D383    		OUT	(CTC3),A	;RESET INTERRUPT BUT KEEP COUNTER GOING
 148:16626+13	F061  322EFF  		LD	(DRVOFF),A	;SET 'DRVOFF' FLAG TO NON-ZERO VALUE
 149:				
 150:16639+10	F064  F1      	ACTV2:	POP	AF
 151:16649+4	F065  FB      		EI
 152:16653+14	F066  ED4D    		RETI
 153:				;
 154:				;
 155:				;
 156:     -	F068          	shutdown:
 157:     -	0001          	IF WD1772
 158:16667+17	F068  CD1FF2  		CALL	SalyResetFDC
 159:16684+7	F06B  3E40    		LD	A, 040h
 160:				ELSE
 167:				ENDIF
 168:16691+11	F06D  D330    		OUT	(LATCH),A
 169:16702+10	F06F  C9      		ret
 170:					
 171:				;
 172:				;
 173:				;
 174:				;
 175:				;
 176:				;	... DRIVE READY/STATUS TEST FUNCTION ...
 177:				;
 178:				;
 179:     -	F070          	TESTDRV:
 180:16712+17	F070  CD0AF1  		CALL	SELECT		;SELECT DRIVE FOR SPIN/STATUS CHECK	
 181:16729+8	F073  CB7F    		BIT	7,A
 182:16737+7+5	F075  2805    		JR	Z,TDRV2		;JUMP IF DRIVE READY INDICATED
 183:				
 184:16744+10	F077  2130FF  		LD	HL,PERIOD	;ELSE SET PERIOD TO ZERO
 185:16754+10	F07A  3600    		LD	(HL),0
 186:				
 187:16764+19	F07C  DD7708  	TDRV2:	LD	(IX+DSKSTS),A	;RETURN TYPE 1 STATUS IN 'DSKSTS'
 188:16783+13	F07F  3A2FFF  		LD	A,(OUTCPY)
 189:16796+19	F082  DD7706  		LD	(IX+DSKAUX),A	;RETURN CONTROL BITS IN AUX BYTE #1
 190:16815+13	F085  3A30FF  		LD	A,(PERIOD)
 191:16828+19	F088  DD7707  		LD	(IX+DSKAUX+1),A	;RETURN PERIOD IN AUX BYTE #2
 192:16847+17	F08B  CD3CF0  		CALL	ACTIVON		;START DISK ACTIVITY MONITOR AGAIN
 193:16864+10	F08E  C9      		RET
 194:				;
 195:				;
 196:				;
 197:				;	... READ ID MARK FUNCTION ...
 198:				;
 199:     -	F08F          	READID:
 200:16874+19	F08F  DD360606		LD	(IX+DSKAUX),6
 201:16893+19	F093  DD360700		LD	(IX+DSKAUX+1),0
 202:16912+7	F097  06C0    		LD	B,RIDCMD
 203:16919+17	F099  CDA3F0  		CALL	DISK		;READ 6 BYTE ID RECORD
 204:16936+13	F09C  3A2FFF  		LD	A,(OUTCPY)
 205:16949+19	F09F  DD7706  		LD	(IX+DSKAUX),A	;RETURN DRIVE CONTROL LATCH BYTE
 206:16968+10	F0A2  C9      		RET
 207:				;
 208:				;
 209:				;
 210:				;	... SECTOR READ/WRITE FUNCTION ...
 211:				;
 212:     -	F0A3          	SETSSO:
 213:     -	0000          	IF WD1772 <> 1
 217:				ENDIF
 218:     -	F0A3          	DISK:
 219:16978+4	F0A3  78      		LD	A, B
 220:16982+13	F0A4  32C5FF  		LD	(CMDBYT),A					;STORE 1797 COMMAND PASSED IN B
 221:16995+17	F0A7  CD0AF1  		CALL	SELECT						;SELECT DRIVE/SIDE FOR DISK OPERATION
 222:17012+8	F0AA  CB7F    		BIT	7,A
 223:17020+7+5	F0AC  2052    		JR	NZ,DISKX					;EXIT IF NOT READY
 224:17027+13	F0AE  3A2DFF  		LD	A,(TRACK)				
 225:17040+7	F0B1  FEFF    		CP	255				
 226:17047+7+5	F0B3  2805    		JR	Z,DISK2				
 227:17054+19	F0B5  DDBE02  		CP	(IX+DSKTRK)					;TEST IF ALREADY AT DESIRED TRACK
 228:17073+7+5	F0B8  2805    		JR	Z,DISK3						;SKIP SEEK PART IF SO
 229:								
 230:17080+17	F0BA  CDE0F1  	DISK2:	CALL	SEEKTRK						;GO LOOKING FOR TRACK# IN IOCB
 231:17097+7+5	F0BD  2041    		JR	NZ,DISKX					;EXIT IF HEAD POSITIONING ERROR
 232:				
 233:17104+13	F0BF  3A12FF  	DISK3:	LD	A,(CTCVEC+2)
 234:17117+4	F0C2  3C      		INC	A						;LOOP TILL TX CTC TURNS ITSELF OFF
 235:17121+7+5	F0C3  20FA    		JR	NZ,DISK3					;(INTERRUPT VECTOR LSB SET=FFH)
 236:     -	F0C5          	SalyDISK3:
 237:17128+4	F0C5  F3      		DI
 238:17132+7	F0C6  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL		; SOFTWARE RESET CTC0
 239:17139+11	F0C8  D380    		OUT	(CTC0),A					;DISABLE RX INTERRUPT FROM CTC0
 240:17150+7	F0CA  3E27    		LD	A, CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; SET PRESCALER TO 256 AND SOFTWARE RESET
 241:17157+11	F0CC  D382    		OUT	(CTC2),A					;DISABLE CTC2 AND ALSO INIT FOR CLOCK SOURCE FOR WATCHDOG TIMER
 242:17168+7	F0CE  3E3D    		LD	A,61						;SET TIME COUNTER TO 61, about 3.9ms
 243:17175+11	F0D0  D382    		OUT	(CTC2),A				
 244:17186+10	F0D2  218CF3  		LD	HL,WATCHDOG					;STORE NEW CTC3 VECTOR FOR SAFETY
 245:17196+16	F0D5  2216FF  		LD	(CTCVEC+6),HL				
 246:								
 247:17212+13	F0D8  3A33FF  		LD	A,(RWMAX)				
 248:17225+13	F0DB  32C6FF  		LD	(RWTRY),A					;SET READ/WRITE RETRY COUNT
 249:17238+19	F0DE  DD7E03  	DISK4:	LD	A,(IX+DSKSEC)					;OUTPUT SECTOR NUMBER FOR READ/WRITE
 250:17257+11	F0E1  D342    		OUT	(SECREG),A				
 251:17268+19	F0E3  DD7E02  		LD	A,(IX+DSKTRK)				
 252:17287+11	F0E6  D341    		OUT	(TRKREG),A					;DITTO FOR TRACK NUMBER
 253:17298+13	F0E8  3AC5FF  		LD	A,(CMDBYT)				
 254:17311+11	F0EB  D340    		OUT	(CMDREG),A					;START 1791 WORKING ON W/R COMMAND
 255:17322+17	F0ED  CD9CF2  		CALL	RWDISK						;DO HALT/NMI DISK DATA TRANSFER
 256:     -	F0F0          	DISK4a:
 257:17339+7+5	F0F0  280E    		JR	Z,DISKX						;EXIT IF NO DISK ERRORS
 258:17346+11	F0F2  F5      		PUSH	AF				
 259:17357+17	F0F3  CDF5F2  		CALL	RECOVER						;DO READ/WRITE ERROR RECOVERY ROUTINE
 260:17374+10	F0F6  C1      		POP	BC				
 261:17384+7+5	F0F7  2006    		JR	NZ,DISK5					;SKIP RETRY IF IRRECOVERABLE ERROR
 262:17391+10	F0F9  21C6FF  		LD	HL,RWTRY				
 263:17401+11	F0FC  35      		DEC	(HL)				
 264:17412+7+5	F0FD  20DF    		JR	NZ,DISK4					;ELSE DECREMENT RETRY COUNT TILL=0
 265:17419+4	F0FF  78      	DISK5:	LD	A,B						;THEN LOAD A WITH ERROR STATUS
 266:17423+19	F100  DD7708  	DISKX:	LD	(IX+DSKSTS),A					;SAVE COMPLETION STATUS CARRIED IN ACC
 267:17442+17	F103  CD18F0  		CALL	RENEW						;RESTART ATARI AND RS232 INTERRUPTS
 268:17459+17	F106  CD3CF0  		CALL	ACTIVON						;START DISK ACTIVITY TIMER
 269:17476+10	F109  C9      		RET
 270:				;
 271:				;
 272:				;
 273:				;	... SELECT DRIVE# PASSED @IX AND RETURN TYPE 1 STATUS ...
 274:				;
 275:     -	F10A          	SELECT:
 276:17486+19	F10A  DD7E01  		LD	A,(IX+DSKDRV)
 277:17505+8	F10D  CBBF    		RES	7,A		;CLEAR SIDE SELECT BIT FROM DRIVE#
 278:17513+7	F10F  FE04    		CP	4
 279:17520+7+5	F111  306A    		JR	NC,SELX		;EXIT IF INVALID DRIVE NUMBER
 280:				
 281:17527+7	F113  0600    		LD	B,0
 282:17534+4	F115  4F      		LD	C,A		;LOAD BC WITH NEW DRIVE# TO BE SELECTED
 283:17538+10	F116  212CFF  		LD	HL,UNIT
 284:17548+7	F119  96      		SUB	(HL)		;COMPARE NEW AND OLD SELECT CODES AND
 285:17555+11	F11A  F5      		PUSH	AF		; SAVE RESULT STATUS ON STACK
 286:17566+4	F11B  50      		LD	D,B
 287:17570+7	F11C  5E      		LD	E,(HL)		;LOAD DE WITH LAST SELECTED DRIVE#
 288:17577+7	F11D  71      		LD	(HL),C		;THEN STORE NEW UNIT# FROM C
 289:				
 290:17584+10	F11E  2120FF  		LD	HL,DRVTAB
 291:17594+11	F121  19      		ADD	HL,DE		;INDEX INTO TABLE BY CURRENT DRIVE#
 292:17605+13	F122  3A2DFF  		LD	A,(TRACK)
 293:17618+7	F125  77      		LD	(HL),A		;REMEMBER CURENT TRACK NUMBER
 294:17625+7	F126  1E04    		LD	E,4
 295:17632+11	F128  19      		ADD	HL,DE		;NOW INDEX TO CONTROL BYTE FOR UNIT
 296:17643+13	F129  3A2FFF  		LD	A,(OUTCPY)
 297:17656+7	F12C  77      		LD	(HL),A		;REMEMBER CURRENT DENSITY/TYPE
 298:				
 299:17663+10	F12D  2120FF  		LD	HL,DRVTAB
 300:17673+11	F130  09      		ADD	HL,BC		;INDEX INTO TABLE BY NEW DRIVE#
 301:17684+7	F131  7E      		LD	A,(HL)
 302:17691+13	F132  322DFF  		LD	(TRACK),A	;STORE CURRENT (ASSUMED) HEAD POSITION
 303:17704+11	F135  19      		ADD	HL,DE
 304:17715+10	F136  D1      		POP	DE		;POP UNIT# COMPARE RESULT INTO D
 305:17725+7	F137  7E      		LD	A,(HL)		;GET CURRENT SELECT/TYPE BITS FOR DRIVE
 306:17732+4	F138  B7      		OR	A
 307:17736+7+5	F139  201F    		JR	NZ,SEL5		;JUMP IF NOT AN INITIAL DRIVE SELECT
 308:				;
 309:				;	ARRIVE HERE ON INITIAL DRIVE SELECT
 310:				;
 311:17743+10	F13B  2188F1  		LD	HL,SELTAB
 312:17753+11	F13E  09      		ADD	HL,BC		;ELSE INDEX INTO TABLE OF SELECT BITS
 313:17764+7	F13F  7E      		LD	A,(HL)
 314:17771+11	F140  D330    		OUT	(LATCH),A	;OUTPUT NEW DRIVE SELECTS
 315:17782+11	F142  F5      		PUSH	AF
 316:17793+17	F143  CD8CF1  		CALL	SPIN		;NOW SPIN UP TO TEST READY
 317:17810+10	F146  C1      		POP	BC
 318:17820+7	F147  FEDE    		CP	222		;ERROR IF SLOWER THAN 222 MS
 319:17827+7+5	F149  3032    		JR	NC,SELX
 320:				
 321:17834+8	F14B  CBF0    		SET	6,B
 322:17842+7	F14D  FEB5    		CP	181		;MINI FLOPPY IF BETWEEN 222 AND 181 MS
 323:17849+7+5	F14F  3006    		JR	NC,SEL4
 324:				
 325:17856+8	F151  CBB0    		RES	6,B
 326:17864+7	F153  FE99    		CP	153		;BIG FLOPPY IF BETWEEN 181 AND 153 MS
 327:17871+7+5	F155  3826    		JR	C,SELX
 328:				
 329:17878+4	F157  78      	SEL4:	LD	A,B		;GET CONTROL BITS INTO A
 330:17882+7	F158  1600    		LD	D,0		;SET D=0 TO DISABLE HEAD LOAD DELAY
 331:				;
 332:				;	ARRIVE HERE WITH DENSITY/TYPE/SELECT BITS IN ACC
 333:				;	
 334:17889+8	F15A  CBAF    	SEL5:	RES	5,A		;RESET SIDE SELECT BIT UNCONDITIONALLY
 335:17897+20	F15C  DDCB017E		BIT	7,(IX+DSKDRV)
 336:17917+7+5	F160  2802    		JR	Z,SEL5A		;JUMP IF SELECTING SIDE# ZERO
 337:17924+8	F162  CBEF    		SET	5,A		;ELSE SET SIDE SELECT BIT IN ACC
 338:17932+11	F164  D330    	SEL5A:	OUT	(LATCH),A
 339:17943+13	F166  322FFF  		LD	(OUTCPY),A	;OUTPUT AND SAVE NEW PATTERN
 340:17956+4	F169  14      		INC	D
 341:17960+4	F16A  15      		DEC	D
 342:17964+10+7	F16B  C47DF3  		CALL	NZ,HLDWAIT	;DO HEAD LOAD DELAY IF NEW DRIVE SELECT
 343:     -	0001          	IF WD1772
 344:				;	IN	A,(TRKREG)	;get status
 345:				;	OUT	(DATREG),A
 346:				;	LD	A,SKCMD
 347:				;	CALL	CMDOUT
 348:				ENDIF
 349:     -	F16E          	SEL5B:
 350:				;	LD	a, 'F'
 351:				;	CALL	seroutfn
 352:17974+17	F16E  CD75F3  		CALL	FORCE
 353:17991+8	F171  CB6F    		BIT	5,A		;TEST 1797 HEAD-LOAD STATUS
 354:17999+5+6	F173  C0      		RET	NZ		;EXIT IF LOADED AND MOTORS ON
 355:				;	JR	SEL5B
 356:					
 357:18004+17	F174  CD8CF1  		CALL	SPIN		;ELSE LET THINGS SPIN A BIT
 358:18021+4	F177  B7      		OR	A		;TEST PERIOD AFTER RE-SPINUP
 359:18025+7+5	F178  2803    	KLUDGE:	JR	Z,SELX		;ERROR IF DISK REFUSES TO TURN
 360:					
 361:     -	0001          	IF WD1772
 362:18032+10	F17A  C375F3  		JP	FORCE		;ELSE RETURN TYPE 1 STATUS THIS TIME
 363:				ELSE
 366:				ENDIF
 367:				;
 368:				;	ARRIVE HERE IF DRIVE CANNOT BE SELECTED AT ALL
 369:				;
 370:18042+4	F17D  AF      	SELX:	XOR	A		;TURN OFF EVERYTHING
 371:     -	0001          	IF WD1772
 372:18046+13	F17E  322FFF  		LD	(OUTCPY),A
 373:18059+7	F181  3E40    		LD	a, 040h		;TURN OFF -> 8Mhz
 374:18066+11	F183  D330    		OUT	(LATCH),A
 375:18077+4	F185  07      		rlca			;40h --> 80h
 376:				ELSE
 380:				ENDIF
 381:18081+4	F186  B7      		OR	A		;RETURN WITH NOT-READY ERROR
 382:18085+10	F187  C9      		RET
 383:				;
 384:				;
 385:				;
 386:				;
 387:				;
 388:     -	F188  01      	SELTAB:	DEFB	00000001B
 389:     -	F189  02      		DEFB	00000010B
 390:     -	F18A  04      		DEFB	00000100B
 391:     -	F18B  08      		DEFB	00001000B
 392:				;
 393:				;
 394:				;
 395:     -	F18C          	SPIN:
 396:     -	0001          	IF WD1772
 397:18095+17	F18C  CD9EF3  		CALL	STARTMR		;THEN RE-PROGRAM CTC1 FOR TIMER
 398:18112+7	F18F  3ED0    		LD	A, FINCMD
 399:18119+17	F191  CD6DF3  		CALL	CMDOUT
 400:				ELSE
 411:				ENDIF
 412:18136+4	F194  4F      		LD	C,A		;SAVE CURRENT TYPE 1 DISK STATUS
 413:18140+7	F195  0606    		LD	B,6		;SET FOR 6 DISK REVOLUTIONS
 414:18147+10	F197  210000  		LD	HL,0
 415:18157+16	F19A  22C7FF  		LD	(TICKS),HL	;RESET MILLISECOND COUNTER FOR IRQ
 416:18173+20	F19D  ED5BC7FF	SPIN2:	LD	DE,(TICKS)
 417:18193+17	F1A1  CDCCF1  		CALL	EDGE		;WAIT FOR INDEX INPUT TO CHANGE
 418:18210+7+5	F1A4  3821    		JR	C,SPIN3		;ABORT IF TIMEOUT
 419:18217+17	F1A6  CDCCF1  		CALL	EDGE		;WAIT FOR CHANGE BACK AGAIN
 420:18234+7+5	F1A9  381C    		JR	C,SPIN3
 421:18241+8+5	F1AB  10F0    		DJNZ	SPIN2		;LET 6 REVOLUTIONS PASS
 422:				
 423:18249+16	F1AD  2AC7FF  		LD	HL,(TICKS)	;READ TIME AT END OF REVOLUTION
 424:18265+4	F1B0  B7      		OR	A
 425:18269+15	F1B1  ED52    		SBC	HL,DE		;COMPUTE INDEX PERIOD IN MILLISECONDS
 426:				
 427:     -	0001          	IF WD1772
 428:     -	F1B3          	SPIN5:
 429:18284+11	F1B3  DB40    		in	a, (STSREG)
 430:18295+8	F1B5  CB7F    		bit	7, a
 431:18303+7+5	F1B7  20FA    		jr	nz, SPIN5
 432:18310+17	F1B9  CDAFF3  	SPIN6:	CALL	STOPTMR		;KILL INTERRUPT FROM CTC3
 433:				
 434:				ELSE
 441:				ENDIF
 442:				
 443:18327+4	F1BC  7D      		LD	A,L
 444:18331+4	F1BD  24      		INC	H
 445:18335+4	F1BE  25      		DEC	H
 446:18339+7+5	F1BF  2802    		JR	Z,SPIN4		;A HOLDS VALID PERIOD IF H=0
 447:18346+7	F1C1  3EFF    		LD	A,255
 448:18353+13	F1C3  3230FF  	SPIN4:	LD	(PERIOD),A
 449:18366+10	F1C6  C9      		RET
 450:				
 451:     -	0001          	IF WD1772
 452:18376+17	F1C7  CD1FF2  	SPIN3:	CALL	SalyResetFDC
 453:18393+12	F1CA  18ED    		JR	SPIN6
 454:				ENDIF
 455:				;
 456:				;
 457:				;
 458:     -	F1CC          	EDGE:
 459:     -	0001          	IF WD1772
 460:18405+11	F1CC  DB40    		IN	a, (STSREG)
 461:				ELSE
 463:				ENDIF
 464:18416+4	F1CE  A9      		XOR	C
 465:18420+7	F1CF  E602    		AND	00000010B	;CHECK FOR CHANGE IN INDEX BIT
 466:18427+7+5	F1D1  2009    		JR	NZ,EDGE2	;EXIT IF BIT CHANGES
 467:				
 468:18434+13	F1D3  3AC8FF  		LD	A,(TICKS+1)
 469:18447+7	F1D6  FE08    		CP	HIGH 2048	;ELSE CHECK TIME ACCUMULATED IN 'TICKS'
 470:18454+7+5	F1D8  38F2    		JR	C,EDGE		;KEEP LOOPING TILL 2 SECONDS PASS
 471:				
 472:18461+4	F1DA  37      		SCF
 473:18465+10	F1DB  C9      		RET			;THEN RETURN WITH CARRY=1
 474:				;
 475:18475+4	F1DC  79      	EDGE2:	LD	A,C
 476:18479+4	F1DD  2F      		CPL			;FLIP INDEX STATE HELD IN C
 477:18483+4	F1DE  4F      		LD	C,A
 478:18487+10	F1DF  C9      		RET			;RETURN WITH CARRY=0
 479:				;
 480:				;
 481:				;
 482:				;
 483:				;	... SEEK TRACK# IN (IX+DSKTRK) FROM TRACK# IN (TRACK) ...
 484:				;
 485:     -	F1E0          	SEEKTRK:
 486:18497+13	F1E0  3A2DFF  		LD	A,(TRACK)
 487:18510+7	F1E3  FEFF    		CP	255
 488:18517+7+5	F1E5  2005    		JR	NZ,SEEK1	;JUMP IF HEAD POSITION IS KNOWN
 489:				
 490:18524+17	F1E7  CD31F2  		CALL	RESTORE		;ELSE DO SLOW RESTORE TO RECALIBRATE
 491:18541+7+5	F1EA  202A    		JR	NZ,SEEKX	;EXIT WITH PERMANENT ERROR IF FAILURE
 492:				
 493:18548+7	F1EC  0601    	SEEK1:	LD	B,1
 494:18555+17	F1EE  CD3EF2  		CALL	SEEK		;FIRST SEEK (IX+DSKTRK) WITH NO RETRIES
 495:18572+5+6	F1F1  C8      		RET	Z		;EXIT IF WE GOT TO THE DESIRED TRACK
 496:18577+7+5	F1F2  3005    		JR	NC,SEEK2	;JUMP IF WE LANDED ON SOME OTHER TRACK
 497:				
 498:18584+17	F1F4  CD31F2  		CALL	RESTORE		;ELSE RECALIBRATE BEFORE TRYING AGAIN
 499:18601+7+5	F1F7  201D    		JR	NZ,SEEKX	;EXIT IF TRACK ZERO NOT FOUND
 500:				
 501:18608+7	F1F9  0602    	SEEK2:	LD	B,2
 502:18615+17	F1FB  CD3EF2  		CALL	SEEK		;NOW SEEK WITH TWO TRIES
 503:18632+5+6	F1FE  C8      		RET	Z		;EXIT IF SUCCESSFUL THIS TIME
 504:18637+7+5	F1FF  3815    		JR	C,SEEKX		;EXIT IF NO ID MARK COULD BE FOUND
 505:				
 506:18644+10	F201  216400  		LD	HL,100
 507:18654+17	F204  CD82F3  		CALL	WAIT		;DELAY TO LET THE STEPPER RELAX ITSELF
 508:18671+10	F207  2128FF  		LD	HL,RATES
 509:18681+13	F20A  3A2CFF  		LD	A,(UNIT)
 510:18694+4	F20D  85      		ADD	A,L
 511:18698+4	F20E  6F      		LD	L,A		;INDEX INTO TABLE TO DRIVE'S STEP RATE
 512:18702+11	F20F  34      		INC	(HL)		; AND MAKE STEP RATE ONE NOTCH SLOWER
 513:18713+7	F210  7E      		LD	A,(HL)
 514:18720+7	F211  E603    		AND	00000011B	;CHECK FOR ROLL AROUND IN LOWER 2 BITS
 515:18727+7+5	F213  20E4    		JR	NZ,SEEK2	;REPEAT IF STEP RATE BITS WERE NOT=3
 516:				
 517:18734+11	F215  35      		DEC	(HL)		;ELSE RESTORE FROM ROLL AROUND
 518:18745+7	F216  3EFF    	SEEKX:	LD	A,255
 519:18752+13	F218  322DFF  		LD	(TRACK),A	;FLAG TRACK POSITION AS UNKNOWN
 520:18765+7	F21B  3E10    		LD	A,00010000B	;SET SEEK ERROR BIT IN STATUS WORD
 521:18772+4	F21D  B7      		OR	A
 522:18776+10	F21E  C9      		RET			;RETURN WITH RNF ERROR STATUS IN A
 523:				;
 524:				;
 525:				;
 526:				;
 527:     -	0000          			IF WD1772 <> 1
 529:						ENDIF
 530:     -	F21F          	SalyResetFDC:		
 531:18786+13	F21F  3A2FFF  		LD	A,(OUTCPY)
 532:18799+8	F222  CBE7    		SET	4,A
 533:18807+11	F224  D330    		OUT	(LATCH),A	;TWANG THE DISK CONTROLLER RESET PIN
 534:18818+7	F226  060F    		LD	B,15
 535:18825+8+5	F228  10FE    		DJNZ	$		;HOLD RESET 50 MICROSECONDS
 536:18833+8	F22A  CBA7    		RES	4,A
 537:18841+11	F22C  D330    		OUT	(LATCH),A
 538:				
 539:     -	0001          	IF WD1772
 540:18852+8+5	F22E  10FE    		DJNZ	$
 541:18860+10	F230  C9      		ret
 542:				
 543:     -	F231          	RESTORE:
 544:18870+17	F231  CD1FF2  		CALL	SalyResetFDC
 545:				
 546:				ELSE
 550:				ENDIF
 551:				
 552:18887+7	F234  3E00    		LD	A,RSTCMD+HLOAD+STEPRATE
 553:18894+17	F236  CD52F3  		CALL	TYP1CMD		;DO RESTORE AT SLOWEST STEP RATE
 554:18911+7	F239  EE04    		XOR	00000100B
 555:     -	0001          	IF WD1772
 556:18918+7	F23B  E604    		AND	00000100B
 557:				ELSE
 559:				ENDIF
 560:18925+10	F23D  C9      		RET			;RETURN WITH ACC=0 IF HOME
 561:				;
 562:				;
 563:				;
 564:     -	F23E          	SEEK:
 565:18935+11	F23E  C5      		PUSH	BC		;SAVE LOOPCOUNT IN B
 566:18946+13	F23F  3A2DFF  		LD	A,(TRACK)
 567:18959+4	F242  47      		LD	B,A		;LOAD B WITH CURRENT TRACK POSITION
 568:18963+19	F243  DD4E02  		LD	C,(IX+DSKTRK)	;LOAD C WITH DESTINATION TRACK#
 569:18982+17	F246  CD5CF2  		CALL	STEP		;HAVE A GO AT STEPPING
 570:18999+17	F249  CD7CF2  		CALL	VERIFY		;VERIFY HEAD POSITION WITH READ-ID
 571:19016+10	F24C  C1      		POP	BC
 572:19026+4	F24D  37      		SCF
 573:19030+5+6	F24E  C0      		RET	NZ		;EXIT WITH CARRY SET IF READ-ID FAILS
 574:				
 575:19035+11	F24F  DB42    		IN	A,(SECREG)
 576:19046+13	F251  322DFF  		LD	(TRACK),A	;STORE ACTUAL TRACK# FROM ID MARK
 577:19059+19	F254  DD9602  		SUB	(IX+DSKTRK)	;COMPARE IF WE GOT THERE THIS TIME
 578:19078+5+6	F257  C8      		RET	Z		;EXIT WITH ACC=0 IF TRACK# VERIFIED
 579:				
 580:19083+8+5	F258  10E4    		DJNZ	SEEK		;DO PRESCRIBED NUMBER OF SEEK RETRIES
 581:				
 582:19091+4	F25A  B7      		OR	A
 583:19095+10	F25B  C9      		RET			;RETURN WITH CARRY AND ZERO FLAGS CLEAR
 584:				;
 585:				;
 586:				;
 587:				;	STEP FROM TRACK# IN B TOWARDS TRACK# IN C
 588:				;
 589:     -	F25C          	STEP:
 590:19105+4	F25C  78      		LD	A,B
 591:19109+11	F25D  D341    		OUT	(TRKREG),A	;STARTING TRACK# TO TRACK REGISTER
 592:19120+4	F25F  79      		LD	A,C
 593:19124+11	F260  D343    		OUT	(DATREG),A	;DESTINATION TRACK# TO DATA REGISTER
 594:					
 595:     -	0001          	IF WD1772
 596:19135+4	F262  00      		nop
 597:19139+4	F263  00      		nop
 598:19143+13	F264  3A2FFF  		ld	a, (OUTCPY)
 599:19156+7	F267  E640    		and	FBS
 600:19163+7	F269  3E13    		ld	a, SKCMD+HLOAD+STEPRATE3	;3ms for DD
 601:19170+7+5	F26B  2002    		jr	NZ, STEP1			;if HD Disk
 602:19177+7	F26D  3E10    		ld	a, SKCMD+HLOAD+STEPRATE0	;switch to STEPRATE0 (3ms HD)
 603:     -	F26F          	STEP1:
 604:				ELSE
 612:				ENDIF
 613:19184+17	F26F  CD52F3  		CALL	TYP1CMD		;DO SEEK WITH SPECIFIED STEP RATE
 614:				
 615:     -	0001          	IF WD1772
 616:19201+4	F272  00      		nop
 617:19205+4	F273  00      		nop
 618:19209+4	F274  00      		nop
 619:19213+4	F275  00      		nop
 620:19217+4	F276  00      		nop
 621:19221+4	F277  00      		nop
 622:19225+4	F278  00      		nop
 623:19229+4	F279  00      		nop
 624:19233+4	F27A  00      		nop
 625:				ELSE
 631:				ENDIF
 632:19237+10	F27B  C9      		RET
 633:				;
 634:				;
 635:				;
 636:				;
 637:     -	F27C          	VERIFY:
 638:19247+7	F27C  3EC0    		LD	A,RIDCMD
 639:19254+17	F27E  CD49F3  		CALL	TYP2CMD		;READ NEXT ID MARK TO VERIFY SEEK
 640:     -	0001          	IF WD1772
 641:19271+7	F281  E618    		AND	00011000B	;WD1772, bit 7 reset by TYP2CMD!
 642:				ELSE
 644:				ENDIF
 645:19278+5+6	F283  C8      		RET	Z		;EXIT IF ID MARK READ OK
 646:				
 647:19283+13	F284  3A2FFF  		LD	A,(OUTCPY)
 648:19296+7	F287  EE80    		XOR	10000000B	;COMPLIMENT DENSITY BIT OF DRIVE TYPE
 649:19303+13	F289  322FFF  		LD	(OUTCPY),A
 650:19316+11	F28C  D330    		OUT	(LATCH),A
 651:19327+10	F28E  213200  		LD	HL,50
 652:19337+17	F291  CD82F3  		CALL	WAIT		;ALLOW 50 MS DELAY AFTER CLOCK SWITCH
 653:19354+7	F294  3EC0    		LD	A,RIDCMD
 654:19361+17	F296  CD49F3  		CALL	TYP2CMD		;TRY AGAIN IN NEW DENSITY
 655:     -	0001          	IF WD1772
 656:19378+7	F299  E618    		AND	00011000B
 657:				ELSE
 659:				ENDIF
 660:19385+10	F29B  C9      		RET			;A=0 IF AN ID MARK WAS FOUND
 661:				;
 662:				;
 663:				;
 664:				;
 665:				;
 666:				;
 667:     -	F29C          	RWDISK:				;A=1797 TYPE 2 COMMAND BYTE
 668:19395+16	F29C  2A6600  		LD	HL,(NMIVEC)	;20
 669:19411+11	F29F  E5      		PUSH	HL		;11
 670:19422+16	F2A0  2A6800  		LD	HL,(NMIVEC+2)	;20
 671:19438+11	F2A3  E5      		PUSH	HL		;11 SAVE 4 BYTES AT NMI VECTOR
 672:19449+10	F2A4  21EDA2  		LD	HL,0A2EDH	;12 LOAD HL WITH 'INI' OPCODE
 673:19459+8	F2A7  CB6F    		BIT	5,A		;8  TEST IF READ OR WRITE BEING DONE
 674:19467+7+5	F2A9  2801    		JR	Z,RW2		;12 JUMP IF COMMAND IS A READ
 675:19474+4	F2AB  24      		INC	H		;4  ELSE TRANSFORM 'INI' INTO 'OUTI'
 676:19478+16	F2AC  226600  	RW2:	LD	(NMIVEC),HL	;16
 677:19494+10	F2AF  216800  		LD	HL,NMIVEC+2	;12
 678:19504+10	F2B2  36C9    		LD	(HL),0C9H	;10 STORE 'RET' OPCODE AFTER INI/OUTI
 679:19514+4	F2B4  F3      		DI			;4
 680:19518+7	F2B5  3EC7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	;7
 681:19525+11	F2B7  D383    		OUT	(CTC3),A	;ARM CTC3 FOR COUNTER MODE INTERRUPT					;11
 682:19536+4	F2B9  AF      		XOR	A		;TIME CONSTANT OF 0 WHICH MEANS 256					;4
 683:19540+11	F2BA  D383    		OUT	(CTC3),A	;COUNT 256 PULSES FROM CTC2						;11
 684:19551+4	F2BC  FB      		EI
 685:19555+19	F2BD  DD6E04  		LD	L,(IX+DSKPTR)	;HL=DISK READ/WRITE DATA POINTER					;19
 686:19574+19	F2C0  DD6605  		LD	H,(IX+DSKPTR+1)										;19
 687:19593+19	F2C3  DD4606  		LD	B,(IX+DSKAUX)	;B=SECTOR LENGTH COUNT (LSB)						;19
 688:19612+7	F2C6  0E43    		LD	C,DATREG	;C=DISK DATA PORT#							;7
 689:19619+19	F2C8  DD7E07  		LD	A,(IX+DSKAUX+1)										;19
 690:19638+8	F2CB  CB3F    		SRL	A											;8
 691:19646+7+5	F2CD  280D    		JR	Z,RW256		;JUMP IF BLOCKSIZE <= 256 BYTES						;12
 692:19653+8	F2CF  CB3F    		SRL	A
 693:19661+7+5	F2D1  2806    		JR	Z,RW512		;JUMP IF BLOCKSIZE <= 512 BYTES
 694:19668+4	F2D3  76      	RW1024:	HALT
 695:19672+7+5	F2D4  20FD    		JR	NZ,$-1
 696:19679+4	F2D6  76      		HALT
 697:19683+7+5	F2D7  20FD    		JR	NZ,$-1
 698:19690+4	F2D9  76      	RW512:	HALT
 699:19694+7+5	F2DA  20FD    		JR	NZ,$-1
 700:19701+4	F2DC  76      	RW256:	HALT
 701:19705+7+5	F2DD  20FD    		JR	NZ,$-1
 702:19712+11	F2DF  DB40    	RWBUSY:	IN	A,(STSREG)
 703:19723+8	F2E1  CB47    		BIT	0,A
 704:19731+7+5	F2E3  20FA    		JR	NZ,RWBUSY	;LOOP TILL 1797 BUSY BIT GOES AWAY
 705:19738+4	F2E5  47      		ld	b,a
 706:19742+17	F2E6  CDAFF3  		call	stoptmr
 707:19759+4	F2E9  78      		ld	a,b
 708:19763+10	F2EA  E1      	RWEXIT:	POP	HL
 709:19773+16	F2EB  226800  		LD	(NMIVEC+2),HL
 710:19789+10	F2EE  E1      		POP	HL
 711:19799+16	F2EF  226600  		LD	(NMIVEC),HL	;RESTORE CODE AT NMI
 712:     -	0001          	IF WD1772
 713:19815+7	F2F2  E67D    		AND	01111101B	;MASK FOR DISK ERRORS
 714:				ELSE
 716:				ENDIF
 717:19822+10	F2F4  C9      		RET			;RETURN WITH DISK ERROR FLAGS SET
 718:				;
 719:				;
 720:				;
 721:				;
 722:     -	F2F5          	RECOVER:
 723:19832+4	F2F5  47      		LD	B,A
 724:19836+7	F2F6  E6E7    		AND	11100111B	;MASK OFF ALL BUT RNF/CRC ERROR BITS
 725:19843+7+5	F2F8  2808    		JR	Z,RECOV1	;JUMP IF ONE OF THOSE TWO WERE SET
 726:				
 727:19850+11	F2FA  F5      		PUSH	AF
 728:19861+17	F2FB  CD75F3  		CALL	FORCE		;RESET ERROR FLAGS IN 179X STATUS REG
 729:19878+10	F2FE  F1      		POP	AF
 730:     -	0001          	IF WD1772
 731:19888+7	F2FF  E661    		AND	01100001B	;CLEAR BITS ASSOCIATED WITH LOST DATA
 732:				ELSE
 734:				ENDIF
 735:19895+10	F301  C9      		RET			;RETURN WITH ACC=0 IF RETRY TO BE DONE
 736:				;
 737:19905+8	F302  CB60    	RECOV1:	BIT	4,B
 738:19913+7+5	F304  2023    		JR	NZ,RECOV3	;JUMP IF RECORD-NOT-FOUND ERROR
 739:				;
 740:				;	ARRIVE HERE IF BAD CRC ERROR
 741:				;
 742:19920+13	F306  3A33FF  	RECOV2:	LD	A,(RWMAX)
 743:19933+10	F309  21C6FF  		LD	HL,RWTRY
 744:19943+7	F30C  96      		SUB	(HL)		;COMPUTE HOW MANY RETRYS HAVE BEEN DONE
 745:19950+5+6	F30D  C8      		RET	Z		;EXIT IF FIRST RETRY
 746:				
 747:19955+13	F30E  3A2DFF  		LD	A,(TRACK)	;ELSE PREPARE TO WIGGLE BACK AND FORTH
 748:19968+4	F311  47      		LD	B,A		; TO AN ADJACENT TRACK TO RE-CALIBRATE
 749:19972+4	F312  B7      		OR	A		; AND REMOVE POSSIBLE MEDIA CONTAMINANT
 750:19976+7+5	F313  2004    		JR	NZ,RCOV2A
 751:19983+7	F315  0E01    		LD	C, 1		;STEP TO TRACK#1 IF ON TRACK# 0
 752:19990+12	F317  1802    		JR	RCOV2B
 753:				;
 754:20002+4	F319  3D      	RCOV2A:	DEC	A		;STEP TO NEXT OUTER TRACK
 755:20006+4	F31A  4F      		LD	C,A
 756:20010+11	F31B  C5      	RCOV2B:	PUSH	BC
 757:20021+17	F31C  CD5CF2  		CALL	STEP		;STEP HEAD TO ADJACENT TRACK
 758:20038+10	F31F  D1      		POP	DE
 759:20048+4	F320  43      		LD	B,E		;EXCHANGE CONTENTS OF B AND C
 760:20052+4	F321  4A      		LD	C,D
 761:20056+17	F322  CD5CF2  		CALL	STEP		;STEP BACK TO ORIGINAL TRACK
 762:20073+17	F325  CD7CF2  		call	verify
 763:20090+10	F328  C9      		ret			;allow retry successful read id
 764:				;
 765:				;	ARRIVE HERE IF RECORD-NOT-FOUND ERROR
 766:				;
 767:20100+17	F329  CD7CF2  	recov3:	call	verify		;read an id mark to verify position
 768:20117+7+5	F32C  2012    		JR	NZ,RCOV4A	;RECALIBRATE IF VERIFY FAILS
 769:				
 770:20124+11	F32E  DB41    		IN	A,(TRKREG)	;LOAD A WITH CURENT TRACK# UNDER HEAD
 771:20135+19	F330  DDBE02  		CP	(IX+DSKTRK)
 772:20154+7+5	F333  200D    		JR	NZ,RCOV4B	;JUMP IF NOT ON CORRECT TRACK
 773:				;
 774:				;	ARRIVE HERE IF ON CORRECT TRACK
 775:				;
 776:20161+13	F335  3A33FF  		ld	a,(rwmax)
 777:20174+10	F338  21C6FF  		ld	hl,rwtry
 778:20184+7	F33B  96      		sub	(hl)		;test if this is first retry after rnf error
 779:20191+5+6	F33C  C8      		ret	z
 780:				
 781:20196+7	F33D  3E10    		ld	a,00010000b
 782:20203+10	F33F  C9      		ret			;indicate permanent rnf error
 783:				;
 784:				;	ARRIVE HERE IF HEAD POSITION IS INCORRECT
 785:				;
 786:20213+7	F340  3EFF    	RCOV4A:	LD	A,255		;SET A TO FORCE RESTORE BEFORE SEEK
 787:20220+13	F342  322DFF  	RCOV4B:	LD	(TRACK),A
 788:20233+17	F345  CDE0F1  		CALL	SEEKTRK		;SEEK TRACK# SPECIFIED IN IOCB
 789:20250+10	F348  C9      		RET
 790:				;
 791:				;
 792:				;
 793:				;
 794:				;	EXECUTE TYPE 2 COMMAND (READ/WRITE/READ ID) WITH TIMEOUT
 795:				;
 796:     -	F349          	TYP2CMD:
 797:20260+17	F349  CD6DF3  		CALL	CMDOUT		;ISSUE COMMAND
 798:20277+11	F34C  C5      		PUSH	BC
 799:20288+10	F34D  016A18  		LD	BC,6250		;500,000/80 FOR ONE HALF SECOND DELAY
 800:20298+12	F350  1807    		JR	TPCMD2
 801:				;
 802:				;
 803:				;	EXECUTE TYPE 1 COMMAND (SEEK/STEP/RESTORE)
 804:				;
 805:     -	F352          	TYP1CMD:
 806:20310+17	F352  CD6DF3  		CALL	CMDOUT
 807:20327+11	F355  C5      		PUSH	BC
 808:20338+10	F356  017C92  		LD	BC,37500	;3,000,000/80 FOR 3 SECONDS DELAY
 809:20348+11	F359  DB40    	TPCMD2:	IN	A,(STSREG)
 810:20359+8	F35B  CB47    		BIT	0,A
 811:20367+7+5	F35D  280A    		JR	Z,TPCMD3	;EXIT IF BUSY BIT GOES AWAY
 812:				
 813:20374+17	F35F  CD6FF3  		CALL	CMDT1		;DELAY 56 MICROSECONDS
 814:20391+6	F362  0B      		DEC	BC
 815:20397+4	F363  78      		LD	A,B
 816:20401+4	F364  B1      		OR	C
 817:20405+7+5	F365  20F2    		JR	NZ,TPCMD2	;LOOP TAKES 80 MICROSECONDS
 818:				
 819:20412+7	F367  3E10    		LD	A,00010000B
 820:				
 821:     -	F369          	TPCMD3:
 822:     -	0001          	IF WD1772
 823:20419+8	F369  CBBF    		res	7, a		;reset WD1797: drive not ready, WD1772: motor on!
 824:				ELSE
 828:				ENDIF
 829:20427+10	F36B  C1      		POP	BC
 830:20437+10	F36C  C9      		RET
 831:				;
 832:				;
 833:				;
 834:     -	F36D          	CMDOUT:
 835:20447+11	F36D  D340    		OUT	(CMDREG),A	;OUTPUT DISK CONTROLLER COMMAND BYTE
 836:20458+7	F36F  3E0E    	CMDT1:	LD	A,14	
 837:20465+4	F371  3D      	CMDT2:	DEC	A
 838:20469+7+5	F372  20FD    		JR	NZ,CMDT2	;DELAY 56 MICROSECONDS
 839:20476+10	F374  C9      		RET
 840:				;
 841:				;
 842:				;
 843:				;
 844:     -	F375          	FORCE:
 845:     -	0001          	IF WD1772
 846:20486+11	F375  DB41    		IN	a, (TRKREG)
 847:20497+11	F377  D343    		OUT	(DATREG), a
 848:20508+7	F379  3E10    		LD	A,SKCMD ;+NOWAITMTR	;disable spinup HLOAD
 849:20515+12	F37B  18D5    		jr	TYP1CMD		;CLEAR 179X AND LATCH READY/HLD/TK0 ETC
 850:				ELSE
 855:				ENDIF
 856:				;
 857:				;
 858:				;
 859:				;
 860:				;
 861:     -	F37D          	HLDWAIT:
 862:20527+16	F37D  2A32FF  		LD	HL,(HLDTIM)	;LOAD HL WITH HEAD LOAD DELAY
 863:20543+7	F380  2600    		LD	H,0		;RANGE 1..256 MILLISECONDS
 864:				
 865:20550+4	F382  AF      	WAIT:	XOR	A
 866:20554+4	F383  3D      	WAIT2:	DEC	A
 867:20558+7+5	F384  20FD    		JR	NZ,WAIT2	;DELAY 1 MILLISECOND
 868:20565+6	F386  2B      		DEC	HL
 869:20571+4	F387  7C      		LD	A,H
 870:20575+4	F388  B5      		OR	L
 871:20579+7+5	F389  20F7    		JR	NZ,WAIT		;LOOP UNTIL HL=0
 872:20586+10	F38B  C9      		RET
 873:				;
 874:				;
 875:				;
 876:				;	... CTC INTERRUPT CONTROL ROUTINES FOR DISK HANDLER ...
 877:				;
 878:				;
 879:				;
 880:     -	F38C          	WATCHDOG:
 881:20596+7	F38C  3ED0    		LD	A,FINCMD
 882:20603+11	F38E  D340    		OUT	(CMDREG),A	;ABORT DISK CONTROLLER OPERATION
 883:20614+7	F390  3E01    		LD	A,00000001B
 884:20621+11	F392  D383    		OUT	(CTC3),A	;RESET INTERRUPT FROM CTC3
 885:20632+10	F394  21EAF2  		LD	HL,RWEXIT
 886:20642+19	F397  E3      		EX	(SP),HL		;TOSS RETURN ADDRESS AND PLANT FAKE ONE
 887:20661+7	F398  3E10    		LD	A,00010000B
 888:20668+4	F39A  B7      		OR	A		;INDICATE RECORD-NOT-FOUND ERROR
 889:20672+4	F39B  FB      		EI
 890:20676+14	F39C  ED4D    		RETI			;INSURE CTC IRQ LOGIC GETS RESTORED
 891:				;
 892:				;
 893:				;
 894:				;
 895:				;
 896:				;	... MILLISECOND TIMER INTERRUPT ROUTINES ...
 897:				;
 898:				;
 899:     -	F39E          	STARTMR:
 900:20690+4	F39E  F3      		DI
 901:20694+7	F39F  3E87    		LD	A,10000111B
 902:20701+11	F3A1  D383    		OUT	(CTC3),A
 903:20712+7	F3A3  3EFA    		LD	A,250
 904:20719+11	F3A5  D383    		OUT	(CTC3),A
 905:20730+10	F3A7  21B6F3  		LD	HL,TMRIRQ
 906:20740+16	F3AA  2216FF  		LD	(CTCVEC+6),HL
 907:20756+4	F3AD  FB      		EI
 908:20760+10	F3AE  C9      		RET
 909:				;
 910:				;
 911:				;
 912:     -	F3AF          	STOPTMR:
 913:20770+4	F3AF  F3      		DI
 914:20774+7	F3B0  3E01    		LD	A,00000001B
 915:20781+11	F3B2  D383    		OUT	(CTC3),A
 916:20792+4	F3B4  FB      		EI
 917:20796+10	F3B5  C9      		RET
 918:				;
 919:				;
 920:				;
 921:     -	F3B6          	TMRIRQ:
 922:20806+11	F3B6  E5      		PUSH	HL
 923:20817+4	F3B7  FB      		EI
 924:20821+16	F3B8  2AC7FF  		LD	HL,(TICKS)
 925:20837+6	F3BB  23      		INC	HL		;BUMP FREE RUNING MILLISECOND COUNTER
 926:20843+16	F3BC  22C7FF  		LD	(TICKS),HL
 927:20859+10	F3BF  E1      		POP	HL
 928:20869+14	F3C0  ED4D    		RETI
 929:				;
 930:				;
 931:				; purpose was to check for HD Disk in order to get it formatted if another format was inserted before
 932:				;
 933:				;HDDISK:		res	6, a				;non HD-DISK
 934:				;		bit	SIZE, (IY+MEDIA)
 935:				;		jz	HDDISK1	
 936:				;		res	6, a
 937:				;HDDISK1:	LD	(OUTCPY),A
 938:				;		PUSH	hl
 939:				;		LD	hl, 0ffffh
 940:				;		LD	(drive), hl
 941:				;		POP	hl
 942:				;		ret
 943:				
 944:     -	0001          	IF WD1772
 945:     -	F3C2  000000  		db	0,0,0
 946:     -	F3C5  00000000		db	0,0,0,0
 947:     -	F3C9  000000  		db	0,0,0
 948:     -	F3CC  000000  		db	0,0,0
 949:     -	F3CF  00      		db	0
 950:     -	F3D0  000000  		db	0,0,0
 951:     -	F3D3  000000  		db	0,0,0
 952:     -	F3D6  00      		db	0
 953:     -	F3D7  00      		db	0
 954:					
 955:20883+4	F3D8  00      		nop
 956:20887+4	F3D9  00      		nop
 957:20891+4	F3DA  00      		nop
 958:20895+4	F3DB  00      		nop
 959:20899+4	F3DC  00      		nop
 960:20903+4	F3DD  00      		nop
 961:20907+4	F3DE  00      		nop
 962:20911+4	F3DF  00      		nop
 963:				ENDIF
**** ..\src\sally2rs.asm ****
  43:						INCLUDE	MINIMON.MAC
**** ..\src\MINIMON.MAC ****
   1:				;
   2:				;
   3:				;
   4:     -	F3E0          	MINIMON:
   5:20915+7	F3E0  3E01    		LD	A,1
   6:20922+11	F3E2  D352    		OUT	(BANKSW),A	;SWITCH TO ALL-RAM CONFIGURATION
   7:20933+17	F3E4  CDFEF5  		CALL	CONINIT		;INITIALIZE SERIAL CONSOLE PORT
   8:20950+17	F3E7  CDCBF4  		CALL	PNEXT
   9:     -	F3EA  0D0A    		DEFB	CR,LF
  10:     -	0001          	IF SALLYBUILD
  11:     -	0001          	   IF WD1772 = 1
  12:     -	F3EC  53616C6C		DEFB	"Sally2"
	              7932
  13:				   ELSE
  15:				   ENDIF
  16:				ELSE
  18:				ENDIF
  19:     -	F3F2  00      		DEFB	NULL
  20:20967+10	F3F3  21F3F3  	PROMPT:	LD	HL,PROMPT
  21:20977+11	F3F6  E5      		PUSH	HL		;PUT RETURN ADDRESS ON STACK
  22:20988+17	F3F7  CDCBF4  		CALL	PNEXT
  23:     -	F3FA  0D0A2320		DEFB	CR,LF,'# ',NULL
	              00
  24:21005+17	F3FF  CDB4F4  		CALL	ECHO
  25:21022+7	F402  FE20    		CP	' '
  26:21029+5+6	F404  D8      		RET	C		;IGNORE NON-PRINTABLE CHATACTERS
  27:				
  28:21034+4	F405  4F      		LD	C,A		;SAVE COMMAND CHARACTER IN C
  29:21038+4	F406  AF      		XOR	A
  30:21042+4	F407  67      		LD	H,A
  31:21046+4	F408  6F      		LD	L,A
  32:21050+11	F409  29      	PROM1:	ADD	HL,HL		;MULTIPLY RESULT BY 16
  33:21061+11	F40A  29      		ADD	HL,HL
  34:21072+11	F40B  29      		ADD	HL,HL
  35:21083+11	F40C  29      		ADD	HL,HL
  36:21094+4	F40D  B5      		OR	L		;APPEND NEW LOW ORDER DIGIT
  37:21098+4	F40E  6F      		LD	L,A
  38:21102+17	F40F  CDB4F4  		CALL	ECHO		;GET A CHARACTER FROM LINE INPUT
  39:21119+7	F412  FE0D    		CP	CR
  40:21126+7+5	F414  280C    		JR	Z,PROM3		;EXIT LOOP IF RETURN TYPED
  41:21133+17	F416  CD85F4  		CALL	ASCHEX		;CONVERT ASCII TO NUMERIC
  42:21150+7+5	F419  30EE    		JR	NC,PROM1	;KEEP SHIFTING IF VALID HEX
  43:				
  44:21157+17	F41B  CDCBF4  	PROM2:	CALL	PNEXT
  45:     -	F41E  203F00  		DEFB	' ?',NULL
  46:21174+10	F421  C9      		RET
  47:				;
  48:21184+17	F422  CDD7F4  	PROM3:	CALL	CRLF
  49:21201+4	F425  79      		LD	A,C
  50:21205+7	F426  FE47    		CP	'G'
  51:21212+7+5	F428  2836    		JR	Z,GOTO		;DO GOTO IF 'G'
  52:21219+7	F42A  FE42    		CP	'B'
  53:21226+7+5	F42C  2833    		JR	Z,BOOT		;DO BOOT LOADER IF 'B'
  54:21233+7	F42E  FE4D    		CP	'M'
  55:21240+7+5	F430  20E9    		JR	NZ,PROM2	;***TEMP***
  56:				
  57:				;  **** This code section does not exist on production ROM ****
  58:				;	.COMMENT %
  59:				;	JR	Z,VIEW		;DO MEMORY EXAMINE/CHANGE IF 'M'
  60:				;	CP	'D'
  61:				;	JR	NZ,PROM2	;FALL INTO MEMORY DUMP IF 'D'
  62:				;
  63:				;
  64:				;
  65:				;	-- TABULAR MEMORY DUMP COMMAND --
  66:				;
  67:				;DUMP:
  68:				;	LD	C,16
  69:				;DUMP1:	PUSH	HL		;SAVE STARTING ADDRESS
  70:				;	CALL	PUT4HS		;PRINT STARTING ADDRESS IN HEX
  71:				;	LD	B,8
  72:				;DUMP2:	LD	A,(HL)		;GET A DATA BYTE @ HL
  73:				;	INC	HL
  74:				;	CALL	PUT2HS		;PRINT THE DATA IN HEX
  75:				;	DJNZ	DUMP2		;REPEAT 16 TIMES
  76:				;	POP	HL		;RESTORE STARTING ADDRESS
  77:				;	LD	B,8
  78:				;DUMP3:	LD	A,(HL)		;GET BACK DATA BYTE @ HL
  79:				;	INC	HL
  80:				;	RES	7,A
  81:				;	CP	20H
  82:				;	JR	C,DUMP4
  83:				;	CP	7FH
  84:				;	JR	C,DUMP5
  85:				;DUMP4:	LD	A,'.'		;PRINT A DOT IF DATA < 20 OR > 7F
  86:				;DUMP5:	CALL	OUTPUT		;PRINT ASCII CHARACTER IN A
  87:				;	DJNZ	DUMP3
  88:				;	CALL	CRLF
  89:				;	DEC	C
  90:				;	JR	NZ,DUMP1
  91:				;	RET
  92:				;
  93:				;
  94:				;	-- MEMORY EXAMINE COMMAND --
  95:				;
  96:     -	F432          	VIEW:
  97:21247+17	F432  CD95F4  		CALL	PUT4HS
  98:21264+7	F435  7E      		LD	A,(HL)
  99:21271+17	F436  CD9AF4  		CALL	PUT2HS
 100:21288+17	F439  CDB4F4  		CALL	ECHO
 101:21305+7	F43C  FE0D    		CP	CR
 102:21312+7+5	F43E  2818    		JR	Z,VIEW4
 103:21319+7	F440  FE2D    		CP	'-'
 104:21326+7+5	F442  2816    		JR	Z,VIEW5
 105:21333+17	F444  CD85F4  		CALL	ASCHEX
 106:21350+4	F447  3F      		CCF	
 107:21354+5+6	F448  D0      		RET	NC
 108:21359+4	F449  07      		RLCA	
 109:21363+4	F44A  07      		RLCA	
 110:21367+4	F44B  07      		RLCA	
 111:21371+4	F44C  07      		RLCA	
 112:21375+4	F44D  4F      		LD	C,A
 113:21379+17	F44E  CDB4F4  		CALL	ECHO
 114:21396+17	F451  CD85F4  		CALL	ASCHEX
 115:21413+4	F454  3F      		CCF	
 116:21417+5+6	F455  D0      		RET	NC
 117:21422+4	F456  B1      		OR	C
 118:21426+7	F457  77      		LD	(HL),A
 119:21433+6	F458  23      	VIEW4:	INC	HL
 120:21439+6	F459  23      		INC	HL
 121:21445+6	F45A  2B      	VIEW5:	DEC	HL
 122:21451+17	F45B  CDD7F4  		CALL	CRLF
 123:21468+12	F45E  18D2    		JR	VIEW
 124:				;
 125:				;
 126:				;
 127:				;	-- JUMP TO MEMORY LOCATION COMMAND --
 128:				;
 129:     -	F460          	GOTO:
 130:21480+4	F460  E9      		JP	(HL)
 131:				;
 132:				;
 133:				;
 134:				;	-- DISK BOOT LOADER --
 135:				;
 136:     -	F461          	BOOT:
 137:21484+14	F461  DD217CF4		LD	IX,BOOTCB
 138:21498+17	F465  CD22F0  		CALL	DISKDVR		;ATTEMPT TO READ BOOT SECTOR
 139:21515+19	F468  DD7E08  		LD	A,(IX+DSKSTS)
 140:21534+4	F46B  B7      		OR	A
 141:21538+10+7	F46C  CC8000  		CALL	Z,0080H		;EXECUTE BOOT IF NO ERRORS
 142:21548+11	F46F  F5      		PUSH	AF
 143:21559+17	F470  CDCBF4  		CALL	PNEXT
 144:     -	F473  20455252		DEFB	' ERR ',NULL
	              2000
 145:21576+10	F479  F1      		POP	AF
 146:21586+12	F47A  1825    		JR	PUT2HX
 147:				;
 148:				;
 149:     -	F47C  01      	BOOTCB:	DEFB	GETSEC
 150:     -	F47D  00      		DEFB	0
 151:     -	F47E  00      		DEFB	0
 152:     -	F47F  01      		DEFB	1
 153:     -	F480  8000    		DEFW	0080H
 154:     -	F482  8000    		DEFW	128
 155:     -	F484  00      		DEFB	0
 156:				;
 157:				;
 158:				;
 159:     -	F485          	ASCHEX:
 160:21598+7	F485  D630    		SUB	'0'
 161:21605+5+6	F487  D8      		RET	C
 162:21610+7	F488  FE0A    		CP	10
 163:21617+4	F48A  3F      		CCF
 164:21621+5+6	F48B  D0      		RET	NC
 165:21626+7	F48C  D607    		SUB	7
 166:21633+7	F48E  FE0A    		CP	10
 167:21640+5+6	F490  D8      		RET	C
 168:21645+7	F491  FE10    		CP	16
 169:21652+4	F493  3F      		CCF
 170:21656+10	F494  C9      		RET
 171:				;
 172:				;
 173:				;
 174:     -	F495          	PUT4HS:
 175:21666+4	F495  7C      		LD	A,H
 176:21670+17	F496  CDA1F4  		CALL	PUT2HX
 177:21687+4	F499  7D      		LD	A,L
 178:     -	F49A          	PUT2HS:
 179:21691+17	F49A  CDA1F4  		CALL	PUT2HX
 180:21708+7	F49D  3E20    		LD	A,' '
 181:21715+12	F49F  181F    		JR	OUTPUT
 182:				;
 183:				;
 184:     -	F4A1          	PUT2HX:
 185:21727+11	F4A1  F5      		PUSH	AF
 186:21738+4	F4A2  1F      		RRA	
 187:21742+4	F4A3  1F      		RRA	
 188:21746+4	F4A4  1F      		RRA	
 189:21750+4	F4A5  1F      		RRA	
 190:21754+17	F4A6  CDAAF4  		CALL	PUTNIB
 191:21771+10	F4A9  F1      		POP	AF
 192:21781+7	F4AA  E60F    	PUTNIB:	AND	00001111B
 193:21788+7	F4AC  C690    		ADD	A,90H
 194:21795+4	F4AE  27      		DAA
 195:21799+7	F4AF  CE40    		ADC	A,40H
 196:21806+4	F4B1  27      		DAA
 197:21810+12	F4B2  180C    		JR	OUTPUT
 198:				;
 199:				;
 200:				;
 201:				;
 202:     -	F4B4          	ECHO:
 203:21822+11	F4B4  E5      		PUSH	HL
 204:21833+11	F4B5  C5      		PUSH	BC
 205:21844+17	F4B6  CD09F0  		CALL	CIV		;CALL CONSOLE INPUT VECTOR
 206:21861+10	F4B9  C1      		POP	BC
 207:21871+10	F4BA  E1      		POP	HL
 208:21881+8	F4BB  CBBF    		RES	7,A
 209:21889+7	F4BD  FE20    		CP	' '
 210:21896+5+6	F4BF  D8      		RET	C		;DO NOT ECHO CONTROL CHARACTERS
 211:				
 212:     -	F4C0          	OUTPUT:
 213:21901+11	F4C0  E5      		PUSH	HL
 214:21912+11	F4C1  C5      		PUSH	BC
 215:21923+11	F4C2  F5      		PUSH	AF
 216:21934+4	F4C3  4F      		LD	C,A
 217:21938+17	F4C4  CD0CF0  		CALL	COV		;CALL CONSOLE OUTPUT VECTOR
 218:21955+10	F4C7  F1      		POP	AF
 219:21965+10	F4C8  C1      		POP	BC
 220:21975+10	F4C9  E1      		POP	HL
 221:21985+10	F4CA  C9      		RET
 222:				;
 223:				;
 224:				;
 225:     -	F4CB          	PNEXT:
 226:21995+19	F4CB  E3      		EX	(SP),HL
 227:22014+7	F4CC  7E      	PNXT1:	LD	A,(HL)
 228:22021+17	F4CD  CDC0F4  		CALL	OUTPUT
 229:22038+7	F4D0  7E      		LD	A,(HL)
 230:22045+6	F4D1  23      		INC	HL
 231:22051+4	F4D2  B7      		OR	A
 232:22055+7+5	F4D3  20F7    		JR	NZ,PNXT1
 233:22062+19	F4D5  E3      		EX	(SP),HL
 234:22081+10	F4D6  C9      		RET
 235:				;
 236:				;
 237:				;
 238:22091+17	F4D7  CDCBF4  	CRLF:	CALL	PNEXT
 239:     -	F4DA  0D0A00  		DEFB	CR,LF,NULL
 240:22108+10	F4DD  C9      		RET
 241:				;
 242:				;
 243:				;
**** ..\src\sally2rs.asm ****
  44:						INCLUDE	PRINTER.MAC
**** ..\src\PRINTER.MAC ****
   1:				;
   2:				;
   3:				;	... PARALLEL PRINTER OUTPUT ROUTINE ...
   4:				;
   5:     -	F4DE          	CENTOUT:
   6:				
   7:22118+4	F4DE  79      		LD	A,C
   8:22122+11	F4DF  D320    		OUT	(PRINTER),A	;OUTPUT DATA BYTE TO PRINTER
   9:22133+19	F4E1  E3      		EX	(SP),HL
  10:22152+19	F4E2  E3      		EX	(SP),HL
  11:22171+7	F4E3  3E19    		LD	A,25
  12:22178+11	F4E5  D353    		OUT	(STROBE),A
  13:22189+4	F4E7  3D      	CENT2:	DEC	A
  14:22193+7+5	F4E8  20FD    		JR	NZ,CENT2
  15:22200+11	F4EA  D353    		OUT	(STROBE),A	;TWANG THE STROBE
  16:22211+10	F4EC  C9      		RET
  17:				;
  18:				;
  19:				;
  20:     -	F4ED          	CENTRDY:
  21:22221+16	F4ED  2A47FF  		LD	HL,(PMASKS)
  22:22237+11	F4F0  DB20    		IN	A,(PRINTER)
  23:22248+4	F4F2  A5      		AND	L		;MASK BITS WITH 'AND'
  24:22252+4	F4F3  AC      		XOR	H		;COMPARE WITH 'XOR'
  25:22256+10	F4F4  C9      		RET			;ACC=0 IF PRINTER IS READY
  26:				;
  27:				;
  28:				;
  29:				;
**** ..\src\sally2rs.asm ****
  45:     -	F4F5  95      			DEFB 95h                ; **** Exists on original ROM? ****
  46:     -	0001          	IF SALLYBUILD
  47:     -	F4F6  00000000			dw	0, 0, 0, 0, 0, 0
	              00000000
	              00000000
  48:				ELSE
  50:				ENDIF	;SALLYBUILD
  51:						INCLUDE	SERIAL.MAC
**** ..\src\SERIAL.MAC ****
   1:				;
   2:				;
   3:				;
   4:				;	... BAUDRATE AND TIMING CONSIDERATIONS ...
   5:				;
   6:				;	THE FOLLOWING TABLE DETAILS THE BIT TIMES FOR THE BAUDRATES
   7:				;    SUPPORTED BY THE ATR-8000 AND THE CTC PROGRAMMING PARAMETERS
   8:				;    REQUIRED TO GENERATE THEM USING THE CTC IN THE TIMER MODE.
   9:				;    (IE. BY DIVIDING DOWN THE 4MHZ CLOCK WITH 16 OR 256 PRESCALE.)
  10:				;
  11:				;	BAUD      PERIOD    MODULUS   PRESCALE
  12:				;	----      ------    -------   --------
  13:				;      19200        52 us      13        16
  14:				;	9600       104 us      26        16
  15:				;	4800       208 us      52        16
  16:				;	2400       416 us     104        16
  17:				;	1200       832 us     208        16
  18:				;	 600      1664 us      26       256
  19:				;	 300      3328 us      52       256
  20:				;	 150      6656 us     104       256
  21:				;	  75     13312 us     208       256
  22:				;
  23:				;
  24:				;
  25:				;
  26:				;	... INTERRUPT SERVICE ROUTINES FOR SERIAL CONSOLE INPUT ...
  27:				;
  28:				;	AVERAGE EXECUTION TIME = 24.55 us FOR INTERRUPT SERVICE
  29:				;				  4.75 us FOR INTERRUPT ACKNOWLEDGE
  30:				;				 ------
  31:				;				 29.30 us PER BIT
  32:				;
  33:				;
  34:				;	*** START BAGE BOUNDARY RESTRICTIONS ***
  35:				;
  36:     -	F502          	CONPAGE	EQU	$
  37:				;
  38:				;
  39:     -	F502          	RXSTART:
  40:22266+11	F502  F5      		PUSH	AF
  41:22277+7	F503  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  42:22284+11	F505  D380    		OUT	(CTC0),A		;RESET CTC AND PROGRAM FOR TIMER MODE
  43:22295+7	F507  3E1A    		LD	A,26			;TIME CONSTANT OF 26 - exactly 104us WHICH IS 9600 BAUD
  44:     -	F508          	RXBAUD	EQU	$-1			;BAUDRATE PARAM IS STORED HERE
  45:22302+11	F509  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  46:22313+7	F50B  3E19    		LD	A,LOW RXDATA
  47:22320+13	F50D  3210FF  		LD	(CTCVEC),A
  48:22333+7	F510  3E7F    		LD	A,01111111B		;7 DATA BITS
  49:22340+13	F512  321EF5  	RXDAT2:	LD	(RXTEMP),A	;SET DATA SHIFTER TO ALL ONES
  50:22353+10	F515  F1      		POP	AF
  51:22363+4	F516  FB      		EI
  52:22367+14	F517  ED4D    		RETI				;EXECUTION TIME = 115 CLOCK CYCLES
  53:				;
  54:				;
  55:				;
  56:     -	F519          	RXDATA:
  57:22381+11	F519  F5      		PUSH	AF
  58:22392+11	F51A  DB70    		IN	A,(ATARI)		;READ SERIAL INPUT BIT STREAM
  59:22403+4	F51C  17      		RLA					;SHIFT DATA BIT (=MSB) INTO CARRY
  60:22407+7	F51D  3E00    		LD	A,NULL			;LOAD A WITH PARTIAL DATA BYTE - NOTE THAT THIS VALUE RESETS AT LABEL RXDAT2
  61:     -	F51E          	RXTEMP	EQU	$-1
  62:22414+4	F51F  1F      		RRA					;SHIFT NEW BIT IN AND ONES OUT
  63:22418+7+5	F520  38F0    		JR	C,RXDAT2
  64:				
  65:22425+13	F522  3200FF  		LD	(KEYBUF),A		;STORE CHARACTER IN CIRCULAR BUFFER
  66:     -	F523          	RXINP	EQU	$-2
  67:22438+7	F525  3E2E    		LD	A,LOW RXSTOP
  68:22445+13	F527  3210FF  		LD	(CTCVEC),A		;ADVANCE TO STOP BIT STATE
  69:22458+10	F52A  F1      		POP	AF
  70:22468+4	F52B  FB      		EI
  71:22472+14	F52C  ED4D    		RETI				;EXECUTION TIME = 105 CYCLES
  72:				;
  73:				;
  74:				;
  75:     -	F52E          	RXSTOP:
  76:22486+11	F52E  F5      		PUSH	AF
  77:22497+7	F52F  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  78:22504+11	F531  D380    		OUT	(CTC0),A		;ENABLE INTERRUPT FROM START BIT
  79:22515+7	F533  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
  80:22522+11	F535  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  81:22533+13	F537  3A23F5  		LD	A,(RXINP)
  82:22546+4	F53A  3C      		INC	A
  83:22550+7	F53B  E60F    		AND	00001111B		;BUMP BUFFER POINTER MODULO 16
  84:22557+13	F53D  3223F5  		LD	(RXINP),A
  85:22570+7	F540  3E02    		LD	A,LOW RXSTART
  86:22577+13	F542  3210FF  		LD	(CTCVEC),A		;SET VECTOR BACK TO START BIT CODE
  87:22590+10	F545  F1      		POP	AF
  88:22600+4	F546  FB      		EI
  89:22604+14	F547  ED4D    		RETI				;EXECUTION TIME = 132 CYCLES
  90:				;
  91:				;
  92:				;
  93:				;
  94:				;	... INTERRUPT ROUTINES FOR SERIAL DATA OUTPUT ...
  95:				;
  96:     -	F549          	TXSTART:
  97:22618+11	F549  F5      		PUSH	AF
  98:22629+4	F54A  AF      		XOR	A
  99:22633+11	F54B  D350    		OUT	(ATROUT),A	;SEND COMPLIMENT OF MARK AS START BIT
 100:22644+7	F54D  3E56    		LD	A,LOW TXDAT0
 101:22651+13	F54F  3212FF  		LD	(CTCVEC+2),A	;SET INTERRUPT VECTOR FOR DATA BIT 0
 102:22664+10	F552  F1      		POP	AF
 103:22674+4	F553  FB      		EI
 104:22678+14	F554  ED4D    		RETI
 105:				;
 106:				;
 107:				;
 108:				;
 109:				;
 110:     -	F556          	TXDAT0:
 111:22692+11	F556  F5      		PUSH	AF
 112:22703+7	F557  3E00    		LD	A,NULL
 113:     -	F558          	TXTMP0	EQU	$-1
 114:22710+11	F559  D350    		OUT	(ATROUT),A	;OUTPUT LSB OF SERIAL DATA TO CONSOLE
 115:22721+4	F55B  1F      		RRA
 116:22725+13	F55C  326AF5  		LD	(TXTMP1),A	;SHIFT RIGHT TO PREPARE FOR NEXT BIT
 117:22738+7	F55F  3E68    		LD	A,LOW TXDAT1
 118:22745+13	F561  3212FF  		LD	(CTCVEC+2),A	;DINK WITH VECTOR FOR NEXT TIME
 119:22758+10	F564  F1      		POP	AF
 120:22768+4	F565  FB      		EI
 121:22772+14	F566  ED4D    		RETI			;EXECUTION TIME = 94 CYCLES
 122:				;
 123:				;
 124:     -	F568          	TXDAT1:
 125:22786+11	F568  F5      		PUSH	AF
 126:22797+7	F569  3E00    		LD	A,NULL
 127:     -	F56A          	TXTMP1	EQU	$-1
 128:22804+11	F56B  D350    		OUT	(ATROUT),A
 129:22815+4	F56D  1F      		RRA
 130:22819+13	F56E  327CF5  		LD	(TXTMP2),A
 131:22832+7	F571  3E7A    		LD	A,LOW TXDAT2
 132:22839+13	F573  3212FF  		LD	(CTCVEC+2),A
 133:22852+10	F576  F1      		POP	AF
 134:22862+4	F577  FB      		EI
 135:22866+14	F578  ED4D    		RETI
 136:				;
 137:				;
 138:     -	F57A          	TXDAT2:
 139:22880+11	F57A  F5      		PUSH	AF
 140:22891+7	F57B  3E00    		LD	A,NULL
 141:     -	F57C          	TXTMP2	EQU	$-1
 142:22898+11	F57D  D350    		OUT	(ATROUT),A
 143:22909+4	F57F  1F      		RRA
 144:22913+13	F580  328EF5  		LD	(TXTMP3),A
 145:22926+7	F583  3E8C    		LD	A,LOW TXDAT3
 146:22933+13	F585  3212FF  		LD	(CTCVEC+2),A
 147:22946+10	F588  F1      		POP	AF
 148:22956+4	F589  FB      		EI
 149:22960+14	F58A  ED4D    		RETI
 150:				;
 151:				;
 152:     -	F58C          	TXDAT3:
 153:22974+11	F58C  F5      		PUSH	AF
 154:22985+7	F58D  3E00    		LD	A,NULL
 155:     -	F58E          	TXTMP3	EQU	$-1
 156:22992+11	F58F  D350    		OUT	(ATROUT),A
 157:23003+4	F591  1F      		RRA
 158:23007+13	F592  32A0F5  		LD	(TXTMP4),A
 159:23020+7	F595  3E9E    		LD	A,LOW TXDAT4
 160:23027+13	F597  3212FF  		LD	(CTCVEC+2),A
 161:23040+10	F59A  F1      		POP	AF
 162:23050+4	F59B  FB      		EI
 163:23054+14	F59C  ED4D    		RETI
 164:				;
 165:				;
 166:     -	F59E          	TXDAT4:
 167:23068+11	F59E  F5      		PUSH	AF
 168:23079+7	F59F  3E00    		LD	A,NULL
 169:     -	F5A0          	TXTMP4	EQU	$-1
 170:23086+11	F5A1  D350    		OUT	(ATROUT),A
 171:23097+4	F5A3  1F      		RRA
 172:23101+13	F5A4  32B2F5  		LD	(TXTMP5),A
 173:23114+7	F5A7  3EB0    		LD	A,LOW TXDAT5
 174:23121+13	F5A9  3212FF  		LD	(CTCVEC+2),A
 175:23134+10	F5AC  F1      		POP	AF
 176:23144+4	F5AD  FB      		EI
 177:23148+14	F5AE  ED4D    		RETI
 178:				;
 179:				;
 180:     -	F5B0          	TXDAT5:
 181:23162+11	F5B0  F5      		PUSH	AF
 182:23173+7	F5B1  3E00    		LD	A,NULL
 183:     -	F5B2          	TXTMP5	EQU	$-1
 184:23180+11	F5B3  D350    		OUT	(ATROUT),A
 185:23191+4	F5B5  1F      		RRA
 186:23195+13	F5B6  32C4F5  		LD	(TXTMP6),A
 187:23208+7	F5B9  3EC2    		LD	A,LOW TXDAT6
 188:23215+13	F5BB  3212FF  		LD	(CTCVEC+2),A
 189:23228+10	F5BE  F1      		POP	AF
 190:23238+4	F5BF  FB      		EI
 191:23242+14	F5C0  ED4D    		RETI
 192:				;
 193:				;
 194:     -	F5C2          	TXDAT6:
 195:23256+11	F5C2  F5      		PUSH	AF
 196:23267+7	F5C3  3E00    		LD	A,NULL
 197:     -	F5C4          	TXTMP6	EQU	$-1
 198:23274+11	F5C5  D350    		OUT	(ATROUT),A
 199:23285+4	F5C7  1F      		RRA
 200:23289+13	F5C8  32D6F5  		LD	(TXTMP7),A
 201:23302+7	F5CB  3ED4    		LD	A,LOW TXDAT7
 202:23309+13	F5CD  3212FF  		LD	(CTCVEC+2),A
 203:23322+10	F5D0  F1      		POP	AF
 204:23332+4	F5D1  FB      		EI
 205:23336+14	F5D2  ED4D    		RETI
 206:				;
 207:				;
 208:				;
 209:     -	F5D4          	TXDAT7:
 210:23350+11	F5D4  F5      		PUSH	AF
 211:23361+7	F5D5  3E00    		LD	A,NULL
 212:     -	F5D6          	TXTMP7	EQU	$-1
 213:23368+11	F5D7  D350    		OUT	(ATROUT),A	;SEND LAST BIT WITHOUT SHIFTING AFTER
 214:23379+7	F5D9  3EE2    		LD	A,LOW TXSTOP
 215:23386+13	F5DB  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR STOP BIT NEXT TIME
 216:23399+10	F5DE  F1      		POP	AF
 217:23409+4	F5DF  FB      		EI
 218:23413+14	F5E0  ED4D    		RETI
 219:				;
 220:				;
 221:				;
 222:     -	F5E2          	TXSTOP:
 223:23427+11	F5E2  F5      		PUSH	AF
 224:23438+7	F5E3  3E01    		LD	A,1
 225:23445+11	F5E5  D350    		OUT	(ATROUT),A
 226:23456+7	F5E7  3EF0    		LD	A,LOW TXEXIT
 227:23463+13	F5E9  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR TO CLEAR TX BUSY FLAG
 228:23476+10	F5EC  F1      		POP	AF
 229:23486+4	F5ED  FB      		EI
 230:23490+14	F5EE  ED4D    		RETI
 231:				;
 232:				;
 233:     -	F5F0          	TXEXIT:
 234:23504+11	F5F0  F5      		PUSH	AF
 235:23515+7	F5F1  3E01    		LD	A,00000001B
 236:23522+11	F5F3  D381    		OUT	(CTC1),A	;DISABLE INTERRUPT FROM XMIT BAUDRATE
 237:23533+7	F5F5  3EFF    		LD	A,255
 238:23540+13	F5F7  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR SO BACKGROUND MONITOR IRQ
 239:23553+10	F5FA  F1      		POP	AF
 240:23563+4	F5FB  FB      	RETI1:	EI
 241:23567+14	F5FC  ED4D    		RETI
 242:				;
 243:				;
 244:     -	0000          		IF	(HIGH CONPAGE) NE (HIGH $)
 246:					ENDIF
 247:				;
 248:				;
 249:				;
 250:				;	*** END PAGE BOUNDARY RESTRICTIONS ***
 251:				;
 252:				;
 253:				;
 254:     -	F5FE          	CONINIT:
 255:23581+4	F5FE  F3      		DI
 256:23585+10	F5FF  21F0F5  		LD	HL,TXEXIT
 257:23595+16	F602  2212FF  		LD	(CTCVEC+2),HL
 258:23611+7	F605  3E07    		LD	A,00000111B
 259:23618+11	F607  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 260:23629+13	F609  3A08F5  		LD	A,(RXBAUD)
 261:23642+11	F60C  D381    		OUT	(CTC1),A	;DIVIDE BY 26 GIVES 9600 BAUD
 262:				
 263:23653+10	F60E  2100FF  		LD	HL,KEYBUF
 264:23663+16	F611  2223F5  		LD	(RXINP),HL	;RESET RX FIFO IN/OUT POINTERS
 265:23679+16	F614  2235F6  		LD	(RXOUT),HL
 266:     -	F617          	CINIT2:
 267:23695+4	F617  F3      		DI			;ALTERNATE ENTRY FROM 'DISKIO'
 268:23699+7	F618  3E01    		LD	A,1
 269:23706+11	F61A  D357    		OUT	(CDMUX),A	;SET MUX TO ENABLE DATA TO CTC0
 270:23717+7	F61C  067E    	CINIT3:	LD	B,126
 271:23724+11	F61E  DB70    	CINIT4:	IN	A,(ATARI)
 272:23735+4	F620  17      		RLA
 273:23739+7+5	F621  30F9    		JR	NC,CINIT3		;RE-LOAD COUNT IN B IF INPUT LOW
 274:23746+8+5	F623  10F9    		DJNZ	CINIT4		;ELSE LOOP FOR ONE 9600 BAUD CHAR TIME
 275:				
 276:23754+7	F625  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 277:23761+11	F627  D380    		OUT	(CTC0),A		;PROGRAM RX CTC IN COUNTER MODE
 278:23772+7	F629  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
 279:23779+11	F62B  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT AND INTERRUPT ON NEXT START BIT
 280:23790+10	F62D  2102F5  		LD	HL,RXSTART
 281:23800+16	F630  2210FF  		LD	(CTCVEC),HL
 282:23816+4	F633  FB      		EI
 283:23820+10	F634  C9      		RET
 284:				;
 285:				;
 286:     -	F635  00FF    	RXOUT:	DEFW	KEYBUF		;KEYBOARD BUFFER OUTPUT POINTER
 287:				;
 288:				;
 289:     -	F637          	CONST:
 290:23830+10	F637  2135F6  		LD	HL,RXOUT
 291:23840+13	F63A  3A23F5  		LD	A,(RXINP)
 292:23853+7	F63D  96      		SUB	(HL)
 293:23860+5+6	F63E  C8      		RET	Z		;A=0 IF NO DATA AVAILABLE
 294:				
 295:23865+7	F63F  3EFF    		LD	A,255
 296:23872+10	F641  C9      		RET
 297:				;
 298:				;
 299:				;
 300:     -	F642          	CONIN:
 301:23882+17	F642  CD37F6  		CALL	CONST
 302:23899+7+5	F645  28FB    		JR	Z,CONIN
 303:				
 304:23906+16	F647  2A35F6  		LD	HL,(RXOUT)
 305:23922+7	F64A  7E      		LD	A,(HL)		;GET RECEIVED DATA FROM FIFO
 306:23929+4	F64B  2C      		INC	L
 307:23933+8	F64C  CBA5    		RES	4,L		;INCREMENT HL MODULO 16
 308:23941+16	F64E  2235F6  		LD	(RXOUT),HL
 309:23957+10	F651  C9      		RET
 310:				;
 311:				;
 312:				;
 313:     -	F652          	CONOUT:
 314:23967+13	F652  3A12FF  		LD	A,(CTCVEC+2)
 315:23980+7	F655  FEF0    		CP	LOW TXEXIT
 316:23987+7+5	F657  38F9    		JR	C,CONOUT	;LOOP TILL WE REACH 'TEXIT' OR HIGHER
 317:				
 318:23994+4	F659  79      		LD	A,C
 319:23998+7	F65A  E67F    		AND	01111111B	;CLEAR BIT 7 AND SET FLAGS
 320:24005+10	F65C  E261F6  		JP	PO,COUT2
 321:24015+7	F65F  F680    		OR	10000000B
 322:24022+13	F661  3258F5  	COUT2:	LD	(TXTMP0),A	;STORE RESULTING CHARACTER FOR XMIT
 323:24035+7	F664  3E49    		LD	A,LOW TXSTART
 324:24042+13	F666  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR START BIT INTERRUPT
 325:24055+7	F669  3E81    		LD	A,10000001B
 326:24062+11	F66B  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 327:24073+10	F66D  C9      		RET
 328:				;
 329:				;
 330:				;
**** ..\src\sally2rs.asm ****
  52:				;
  53:				;	CODE PAST THIS POINT IS ONLY USED IN ATARI DISK MODE
  54:				;
  55:						INCLUDE	BITBANG.MAC
**** ..\src\BITBANG.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	19200 BAUD SERIAL I/O FOR ATARI COMM PORT	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	19200 BAUD SERIAL I/O IS HALF DUPLEX DUE TO OBVIOUS
   9:				;	TIMING CONSTRAINTS. ALL TRANSFERS ARE DONE FROM 4K PAGE
  10:				;	ALIGNED BUFFER 'IOBUFF', WITH BLOCK START ADDRESS
  11:				;	ARRANGED SO END-OF-BLOCK CONDITION IS MET WHEN POINTER
  12:				;	ROLLS OVER THE NEXT EVEN PAGE BYTE BOUNDARY.
  13:				;
  14:				;	CALL WITH BLOCK START POINTER IN HL ,DATA POLARITY MASK
  15:				;	IN D (WHERE D=0 TRUE DATA, D=FF INVERTED DATA) AND
  16:				;	'C' OR 'E' HANDSHAKE CHARACTER IN E.
  17:				;
  18:				;
  19:     -	F66E          	SENDBUFF:
  20:24083+11	F66E  E5      		PUSH	HL		;SAVE DATA BLOCK POINTER
  21:24094+11	F66F  D5      		PUSH	DE		;SAVE POLARITY MASK FOR DATA
  22:24105+10	F670  2101C3  		LD	HL,IOBUFF+LEN+1
  23:24115+7	F673  73      		LD	(HL),E
  24:24122+7	F674  1600    		LD	D,0
  25:24129+17	F676  CD86F6  		CALL	XMITBUF		;SEND 'C' OR 'E' CHARACTER FROM E
  26:24146+10	F679  D1      		POP	DE
  27:24156+10	F67A  E1      		POP	HL
  28:24166+7	F67B  1E00    		LD	E,0
  29:24173+17	F67D  CD86F6  		CALL	XMITBUF		;THEN SEND DATA BLOCK TO ATARI
  30:24190+10	F680  2101C3  		LD	HL,IOBUFF+LEN+1
  31:24200+7	F683  73      		LD	(HL),E		;FALL THROUGH TO SEND CHECKSUM
  32:24207+7	F684  1600    		LD	D,0
  33:				;
  34:				;	CALL WITH DATA BLOCK POINTER IN HL.
  35:				;	PRESERVES MASK/CKECKSUM IN D/E.
  36:				;
  37:     -	F686          	XMITBUF:
  38:24214+4	F686  F3      		DI
  39:24218+10	F687  011BF7  		LD	BC,STARBIT
  40:     -	F68A          	SalyXMITBUF:
  41:24228+20	F68A  ED4312FF		LD	(CTCVEC+2),BC	;SET UP INITIAL INTERRUPT VECTOR
  42:24248+7	F68E  0608    		LD	B,8
  43:24255+7	F690  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  44:24262+11	F692  D381    		OUT	(CTC1),A		;PROGRAM CTC1 TO INTERRUPT AT BIT RATE
  45:24273+7	F694  3E0D    		LD	A,13			;SET TIME CONSTANT TO 13 - 52us. EXACT IS 52.083us
  46:24280+11	F696  D381    		OUT	(CTC1),A		;COUNT 13*(16*250 NS) GIVES 19200 BAUD WITH 0.16% ERROR
  47:24291+4	F698  FB      		EI
  48:24295+12	F699  18FE    		JR	$		;SPIN HERE TILL INTERRUPTS GET US OUT
  49:				;
  50:				;
  51:				;
  52:				;
  53:				;
  54:				;
  55:				;	... INTERRUPT FOR COMMAND INPUT HIGH->LOW TRANSITION ..
  56:				;
  57:     -	F69B          	CSTART:
  58:24307+4	F69B  08      		EX	AF,AF'
  59:24311+4	F69C  D9      		EXX
  60:24315+7	F69D  3EFF    		LD	A,255
  61:24322+13	F69F  3255FF  		LD	(CMDFLG),A	;SET 'CMDFLG' FLAG TO ERROR STATE FIRST
  62:24335+11	F6A2  D357    		OUT	(CDMUX),A	;SWITCH MUX TO ENABLE SERIAL DATA IRQ
  63:24346+10	F6A4  21FBC2  		LD	HL,IOBUFF+LEN-5	;POINT DE 5 BYTES BEFORE END OF BUFFER
  64:24356+17	F6A7  CDDBF6  		CALL	RXBLOCK		;ATTEMPT TO RECEIVE COMMAND FRAME
  65:24373+7+5	F6AA  300A    		JR	NC,CSTRT1	;JUMP IF NO DATA HAPPENED
  66:					
  67:24380+6	F6AC  2B      		DEC	HL
  68:24386+7	F6AD  7E      		LD	A,(HL)
  69:24393+4	F6AE  B9      		CP	C		;COMPARE DERRIVED AND RECVD CHECKSUMS
  70:24397+7+5	F6AF  2005    		JR	NZ,CSTRT1	;JUMP IF CHECKSUM ERROR
  71:				
  72:24404+7	F6B1  3E01    		LD	A,1
  73:24411+13	F6B3  3255FF  		LD	(CMDFLG),A	;SET FLAG IF GOOD COMMAND FRAME
  74:24424+4	F6B6  08      	CSTRT1:	EX	AF,AF'
  75:24428+4	F6B7  D9      		EXX
  76:24432+4	F6B8  FB      		EI
  77:				
  78:24436+14	F6B9  ED4D    		RETI
  79:				;
  80:				;
  81:				;
  82:				;	... DATA FRAME RECEIVE SUBROUTINE ...
  83:				;
  84:     -	F6BB          	RECVBUFF:
  85:24450+4	F6BB  F3      		DI
  86:24454+10	F6BC  2100C1  		LD	HL,IOBUFF
  87:24464+17	F6BF  CDDBF6  		CALL	RXBLOCK		;BITBANG A BLOCK OF INPUT DATA
  88:24481+4	F6C2  FB      		EI
  89:24485+7+5	F6C3  380D    		JR	C,RBUFF2	;JUMP IF BUFFER OVERFLOWED
  90:				
  91:24492+6	F6C5  2B      		DEC	HL
  92:24498+7	F6C6  7E      		LD	A,(HL)
  93:24505+4	F6C7  B9      		CP	C
  94:24509+7+5	F6C8  2008    		JR	NZ,RBUFF2	;JUMP IF CHECKSUMS DON'T AGREE
  95:				
  96:24516+10	F6CA  1100C1  		LD	DE,IOBUFF
  97:24526+4	F6CD  B7      		OR	A
  98:24530+15	F6CE  ED52    		SBC	HL,DE		;ELSE COMPUTE LENGTH OF BLOCK LESS
  99:24545+4	F6D0  AF      		XOR	A		;CHECKSUM BYTE AND RETURN WITH
 100:24549+10	F6D1  C9      		RET			;RESULT IN HL AND ZERO FLAG SET
 101:				;
 102:24559+7	F6D2  3E4E    	RBUFF2:	LD	A,'N'
 103:24566+17	F6D4  CD91FB  		CALL	SENDCHAR	;SEND 'NAK' FOR BAD DATA FRAME
 104:24583+7	F6D7  3EFF    		LD	A,255
 105:24590+4	F6D9  B7      		OR	A
 106:24594+10	F6DA  C9      		RET			;RETURN WITH ACC SET NON=ZERO
 107:				;
 108:				;
 109:				;
 110:				;
 111:				;
 112:				;	... BITBANG INPUT SUBROUTINE ...
 113:				;
 114:				;	CALL WITH BLOCK START POINTER IN HL. RETURNS WITH
 115:				;	HL POINTING TO LAST BYTE+1 OF BLOCK RECEIVED.
 116:				;	THE CARRY BIT IS SET IF THE BUFFER FILLED UP BEFORE
 117:				;	THE BIT STREAM STOPPED.
 118:				;
 119:				;
 120:     -	F6DB          	RXBLOCK:
 121:24604+10	F6DB  11AA0A  		LD	DE,2730		;SET ABORT COUNTER FOR 32 MILLISECONDS
 122:     -	F6DE          	SalyRXBLOCK:
 123:24614+10	F6DE  010000  		LD	BC,0		;CLEAR B/C FOR CHECKSUM DERRIVATION
 124:24624+12	F6E1  1823    		JR	RXB35		;GO START LOOPING FOR START BIT
 125:				;
 126:24636+4	F6E3  79      	RXB1:	LD	A,C		;4
 127:24640+4	F6E4  80      		ADD	A,B		;4
 128:24644+7	F6E5  CE00    		ADC	A,0		;7 ACCUMULATE CHECKSUM ATARI STYLE
 129:24651+4	F6E7  4F      		LD	C,A		;4
 130:24655+19	F6E8  E3      		EX	(SP),HL		;19
 131:24674+19	F6E9  E3      		EX	(SP),HL		;19
 132:24693+19	F6EA  E3      		EX	(SP),HL		;19
 133:24712+19	F6EB  E3      		EX	(SP),HL		;19
 134:24731+7	F6EC  0608    		LD	B,8		;7
 135:				;
 136:				;	SERIAL->PARALLEL CONVERSION AT 52 MICROSECONDS PER BIT
 137:				;
 138:24738+7	F6EE  3E0B    	RXB2:	LD	A,11		;  7 CYCLES
 139:24745+7	F6F0  3E0B    		LD	A,11		;  7 CYCLES
 140:24752+4	F6F2  00      		NOP			;  4 CYCLES
 141:24756+4	F6F3  3D      	RXB3:	DEC	A		; 44 CYCLES  (11*4)
 142:24760+10	F6F4  C2F3F6  		JP	NZ,RXB3		;110 CYCLES  (11*10)
 143:24770+11	F6F7  DB70    		IN	A,(ATARI)	; 11 CYCLES
 144:24781+4	F6F9  17      		RLA			;  4 CYCLES
 145:24785+8	F6FA  CB1A    		RR	D		;  8 CYCLES
 146:24793+8+5	F6FC  10F0    		DJNZ	RXB2		; 13 CYCLES  (8 ON FINAL BIT)
 147:				
 148:24801+4	F6FE  42      		LD	B, D		;SAVE COPY OF LAST DATA BYTE IN B
 149:24805+7	F6FF  72      		LD	(HL),D		;THEN STORE IN MEMORY BUFFER @HL
 150:24812+6	F700  23      		INC	HL
 151:24818+4	F701  7C      		LD	A,H
 152:24822+7	F702  FEC3    		CP	HIGH (IOBUFF+LEN)
 153:24829+4	F704  3F      		CCF
 154:24833+5+6	F705  D8      		RET	C		;RETURN WITH CARRY SET IF BUFFER FILLED
 155:				
 156:     -	F706          	RXB35:
 157:24838+7	F706  3E47    		LD	A, CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
 158:24845+11	F708  D380    		OUT	(CTC0),A	;PUT CTC0 IN COUNTER MODE
 159:24856+4	F70A  AF      		XOR	A		;TIME CONSTANT OF 0 WHICH MEANS 256
 160:24860+11	F70B  D380    		OUT	(CTC0),A	;COUNT DATA HIGH->LOW EDGES MOD 256
 161:24871+10	F70D  11A101  		LD	DE,417		;5 MILLISECONDS @ 12 MICROSECONDS/LOOP
 162:				
 163:24881+11	F710  DB80    	RXB4:	IN	A,(CTC0)
 164:24892+4	F712  B7      		OR	A
 165:24896+7+5	F713  20CE    		JR	NZ,RXB1		;NEW BYTE IS COMING IF START BIT LOW
 166:24903+6	F715  1B      		DEC	DE
 167:24909+4	F716  7A      		LD	A,D
 168:24913+4	F717  B3      		OR	E
 169:24917+7+5	F718  20F6    		JR	NZ,RXB4		;ELSE LOOP TILL TIMER RUNS OUT
 170:				
 171:24924+10	F71A  C9      		RET			;RETURN WITH CARRY CLEAR IF TIMED OUT
 172:				;
 173:				;
 174:				;
 175:				;
 176:				;	**** PAGE BOUNDARY SENSITIVE CODE STARTS HERE ****
 177:				;
 178:     -	F71B          	SERPAGE	EQU	$
 179:				;
 180:				;
 181:				;	... DAMN FAST TRANSMIT INTERRUPTS ...
 182:				;
 183:				;	HL ... POINTS TO DATA BLOCK TO BE SENT
 184:				;	 D ... HOLDS DATA POLARITY MASK
 185:				;	 E ... USED TO ACCUMULATE CHECKSUM
 186:				;	 B ... USED FOR DJNZ TO COUNT BITS
 187:				;	 C ... USED FOR PARALLEL-SERIAL OUTPUT
 188:				;
 189:				;
 190:     -	F71B          	STARBIT:
 191:24934+4	F71B  AF      		XOR	A
 192:24938+11	F71C  D350    		OUT	(ATROUT),A	;SEND START BIT
 193:24949+4	F71E  FB      		EI
 194:24953+7	F71F  7E      		LD	A,(HL)		;LOAD A WITH TRANSMIT DATA BYTE
 195:24960+6	F720  23      		INC	HL		; AND INCREMENT BUFFER POINTER
 196:24966+4	F721  AA      		XOR	D		;DO DATA POLARITY THING
 197:24970+4	F722  4F      		LD	C,A		;THEN STUFF IN C FOR SHIFTING OUT
 198:24974+4	F723  83      		ADD	A,E
 199:24978+7	F724  CE00    		ADC	A,0
 200:24985+4	F726  5F      		LD	E,A		;ACCUMULATE CHECKSUM IN E
 201:24989+7	F727  3E2E    		LD	A,LOW DATBIT
 202:24996+13	F729  3212FF  		LD	(CTCVEC+2),A	;FIX BAUDRATE INTERRUPT VECTOR
 203:25009+14	F72C  ED4D    		RETI			;RETURN TO IDLE LOOP
 204:				;
 205:				;
 206:				;
 207:     -	F72E          	DATBIT:
 208:25023+4	F72E  79      		LD	A,C
 209:25027+11	F72F  D350    		OUT	(ATROUT),A	;SEND DATA BIT (LSB)
 210:25038+4	F731  FB      		EI
 211:25042+8	F732  CB19    		RR	C		;SHIFT DATA FOR NEXT BIT
 212:25050+8+5	F734  1005    		DJNZ	DATB2		;DECREMENT AND SKIP IF NOT LAST BIT
 213:				
 214:25058+7	F736  3E3D    		LD	A,LOW STOPB1
 215:25065+13	F738  3212FF  		LD	(CTCVEC+2),A	;THEN FIX VECTOR TO SEND STOP BIT
 216:25078+14	F73B  ED4D    	DATB2:	RETI			;RETURN TO IDLE LOOP
 217:				;
 218:				;
 219:				;
 220:     -	F73D          	STOPB1:
 221:25092+7	F73D  3E01    		LD	A,1
 222:25099+11	F73F  D350    		OUT	(ATROUT),A	;SEND STOP BIT
 223:25110+4	F741  FB      		EI
 224:25114+4	F742  7C      		LD	A,H
 225:25118+7	F743  FEC3    		CP	HIGH (IOBUFF+LEN)
 226:25125+7+5	F745  3009    		JR	NC,STOP1A	;JUMP IF BUFFER END REACHED
 227:				
 228:25132+7	F747  0608    		LD	B,8		;LOAD BITCOUNT FOR NEXT RECEIVE BYTE
 229:25139+7	F749  3E1B    		LD	A,LOW STARBIT
 230:25146+13	F74B  3212FF  		LD	(CTCVEC+2),A
 231:25159+14	F74E  ED4D    		RETI			;SET TO SEND SECOND STOP BIT
 232:				;
 233:25173+7	F750  3E57    	STOP1A:	LD	A,LOW ENDBIT
 234:25180+13	F752  3212FF  		LD	(CTCVEC+2),A	;SET TO END TRANSMISSION
 235:25193+14	F755  ED4D    		RETI
 236:				;
 237:				;
 238:				;
 239:     -	0000          		IF	(HIGH SERPAGE) NE (HIGH $)
 241:					ENDIF
 242:				;
 243:				;
 244:				;
 245:     -	F757          	ENDBIT:
 246:     -	0001          	IF SALLYBUILD
 247:25207+7	F757  3E03    		LD	A,CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET - STOP INTERRUPTS FROM BAUDRATE CTC
 248:				ELSE
 250:				ENDIF
 251:25214+11	F759  D381    		OUT	(CTC1),A			;SEND COMMAND TO CTC1
 252:25225+4	F75B  FB      		EI
 253:25229+7	F75C  3EFF    		LD	A,255
 254:25236+13	F75E  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR BACK TO STANDARD PLACE
 255:25249+10	F761  E1      		POP	HL		;DISCARD IRQ RETURN ADDRESS AND RETURN
 256:25259+14	F762  ED4D    		RETI			; TO SECOND ADDRESS ON STACK
 257:				;
 258:				;
 259:				;	**** END PAGE BOUNDARY RESTRICTIONS ****
 260:				;
 261:				;
**** ..\src\sally2rs.asm ****
  56:						INCLUDE	ATARI.MAC
**** ..\src\ATARI.MAC ****
   1:				;	PAGE
   2:				;
   3:				;	<<< MAIN LOOP FOR ATARI DISK EMULATOR >>>
   4:				;
   5:				;
   6:				;
   7:				;
   8:     -	F764          	EMULATOR:
   9:25273+7	F764  3E01    		LD	A,1
  10:25280+11	F766  D352    		OUT	(BANKSW),A	;TURN OFF THE ROM
  11:				;
  12:				;	CHECK TO DETERMINE WHICH CONSOLE IS ACTIVE
  13:				;
  14:25291+10	F768  21FEC2  	LOGON:	LD	HL,IOBUFF+LEN-2
  15:25301+4	F76B  F3      		DI
  16:25305+17	F76C  CDDBF6  		CALL	RXBLOCK		;LISTEN FOR A MESSAGE FROM ABOVE
  17:25322+4	F76F  FB      		EI
  18:25326+7+5	F770  30F6    		JR	NC,LOGON	;KEEP LOOPING TILL SOMETHING RECEIVED
  19:25333+16	F772  2AFEC2  		LD	HL,(IOBUFF+LEN-2)
  20:25349+10	F775  11E680  		LD	DE,80E6H
  21:25359+4	F778  B7      		OR	A
  22:25363+15	F779  ED52    		SBC	HL,DE
  23:25378+10	F77B  CAE0F3  		JP	Z,MINIMON	;GOTO MONITOR IF 9600 BAUD <CR>
  24:				;
  25:				;	ENTER ATARI DISK EMULATOR MODE
  26:				;
  27:25388+7	F77E  3E03    		LD	A,3
  28:     -	F780          	SalyLOGN1:
  29:25395+13	F780  3233FF  		LD	(RWMAX),A	;DO LESS RETRIES IN ATARI MODE
  30:     -	F783          	SalyLOGN2:
  31:25408+7	F783  3E38    		LD	A,38H		;LOAD ACC WITH 'JR C,XX' OPCODE
  32:25415+13	F785  3278F1  		LD	(KLUDGE),A	;CRIPPLE READY ERROR FROM 'SELECT'
  33:25428+11	F788  DB50    		IN	A,(SERIN)
  34:25439+8	F78A  CB5F    		BIT	3,A
  35:25447+7+5	F78C  2005    		JR	NZ,HAS850	;JUMP IF 850 JUMPER PRESENT
  36:				
  37:25454+7	F78E  3EFF    		LD	A,255
  38:25461+13	F790  322AF8  		LD	(PTRID),A	;ELSE ZAP PRINTER ID IN TABLE
  39:				
  40:25474+10	F793  21E3F7  	HAS850:	LD	HL,DUMMY
  41:25484+16	F796  2219F0  		LD	(RENEW+1),HL	;MAKE DUMMY CONSOLE RE-INIT VECTOR
  42:25500+20	F799  ED5B1930		LD	DE,(RENEW+1-0C000H)
  43:25520+4	F79D  B7      		OR	A
  44:25524+15	F79E  ED52    		SBC	HL,DE
  45:25539+7+5	F7A0  280C    		JR	Z,MAIN		;JUMP IF 16K MEMORY SIZE MACHINE
  46:				
  47:     -	0001          	IF SALLYBUILD
  48:25546+10	F7A2  210034  		LD	HL, 03400h	;was 0000h, now 0800h+26*256 track buffer = 2200h
  49:25556+16	F7A5  224BFF  		LD	(PBASE),HL	;ELSE SETUP FOR 39.5K PRINTER BUFFER
  50:25572+10	F7A8  21FF8B  		LD	HL,0bfffh-3400h	;rom code up to 01000h and 2400h Trackbuffer (36*256b) 	
  51:				ELSE
  55:				ENDIF	;SALLYBUILD
  56:25582+16	F7AB  224DFF  		LD	(PSIZE),HL
  57:				
  58:25598+17	F7AE  CDC1F8  	MAIN:	CALL	SPOOLER		;KEEP BACKGROUND PRINTING GOING
  59:25615+16	F7B1  2A3AFF  		LD	HL,(FSMVEC)
  60:25631+17	F7B4  CDBFF7  		CALL	CALLHL		;DO ATARI TASK ROUTINE
  61:25648+16	F7B7  2A3CFF  		LD	HL,(EXTVEC)
  62:25664+17	F7BA  CDBFF7  		CALL	CALLHL		;DO EXTRA TASK ROUTINE
  63:25681+12	F7BD  18EF    		JR	MAIN
  64:				;
  65:				;
  66:25693+4	F7BF  E9      	CALLHL:	JP	(HL)
  67:				;
  68:				;
  69:				;
  70:     -	F7C0          	PWRWAIT:	
  71:25697+11	F7C0  DB70    		IN	A,(ATARI)
  72:25708+7	F7C2  E68A    		AND	10001010B	;MASK TO DATA/POWER/COMMAND BITS
  73:25715+7	F7C4  FE8A    		CP	10001010B	
  74:25722+5+6	F7C6  C0      		RET	NZ
  75:					
  76:25727+4	F7C7  F3      		DI
  77:25731+4	F7C8  AF      		XOR	A
  78:25735+13	F7C9  3255FF  		LD	(CMDFLG),A	;RESET COMMAND FRAME FLAG
  79:25748+11	F7CC  D357    		OUT	(CDMUX),A	;SET MUX TO GATE COMMAND LINE TO CTC0
  80:								;COMMAND-LINE is inverted and now double-inverted :-)
  81:25759+7	F7CE  3ED7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D4_RISEEDGE + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
  82:25766+11	F7D0  D380    		OUT	(CTC0),A	;RESET CTC AND ARM FOR HIGH->LOW IRQ
  83:25777+7	F7D2  3E01    		LD	A,1		;TIME CONSTANT OF 1
  84:25784+11	F7D4  D380    		OUT	(CTC0),A	;WRITE TIME CONSTANT
  85:25795+10	F7D6  219BF6  		LD	HL,CSTART
  86:25805+16	F7D9  2210FF  		LD	(CTCVEC),HL	;STORE INTERRUPT VECTOR
  87:25821+4	F7DC  FB      		EI
  88:25825+10	F7DD  21E4F7  		LD	HL,CMDWAIT
  89:25835+16	F7E0  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR TO 'CMDHIGH' STATE
  90:25851+10	F7E3  C9      	DUMMY:	RET
  91:				;
  92:				;
  93:				;
  94:     -	F7E4          	CMDWAIT:
  95:25861+13	F7E4  3A55FF  		LD	A,(CMDFLG)
  96:25874+4	F7E7  B7      		OR	A		;SEE IF COMMAND FRAME HAS ARRIVED
  97:25878+5+6	F7E8  C8      		RET	Z		;EXIT IF NOTHING HAS HAPPENED
  98:					
  99:25883+7	F7E9  FE01    		CP	1
 100:25890+7+5	F7EB  2808    		JR	Z,CMDL4		;PROCESS COMMAND IF GOOD FRAME RECVD
 101:				
 102:25897+4	F7ED  F3      		DI			;ELSE RESET INTERRUPT AND START AGAIN
 103:25901+7	F7EE  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	; SOFTWARE RESET CTC0
 104:25908+11	F7F0  D380    		OUT	(CTC0),A	;PERFORM THE RESET
 105:25919+4	F7F2  FB      		EI
 106:25923+12	F7F3  181B    		JR	CMDL5		;GO SET FSM VECTOR
 107:				;
 108:				;
 109:     -	C2FB          	CFRAME	EQU	IOBUFF+LEN-5	;COMMAND FRAME IS LAST 5 BYTES OF BUFF
 110:				;
 111:25935+13	F7F5  3AFBC2  	CMDL4:	LD	A,(CFRAME)
 112:25948+16	F7F8  2A38FF  		LD	HL,(IDPTR)	;GET POINTER TO ID CODE TABLE
 113:25964+17	F7FB  CD17F8  		CALL	SCAN		;SCAN TABLE FOR MATCHING UNIT ID CODE
 114:25981+7+5	F7FE  2010    		JR	NZ,CMDL5	;EXIT IF COMMAND IS NOT FOR US
 115:				
 116:25988+13	F800  3AFCC2  		LD	A,(CFRAME+1)
 117:26001+17	F803  CD17F8  		CALL	SCAN		;SCAN FOR COMMAND CODE IN TABLE
 118:26018+7+5	F806  2805    		JR	Z,CMDL4a	;CODE FOUND	
 119:26025+17	F808  CD80FB  		CALL	SENDNACK	;ERROR IF NO MATCH FOUND
 120:26042+12	F80B  1803    		JR	CMDL5	
 121:				
 122:26054+17	F80D  CDBFF7  	CMDL4a:	CALL	CALLHL		;GO TO COMMAND PROCESSOR @HL
 123:				;
 124:26071+10	F810  21C0F7  	CMDL5:	LD	HL,PWRWAIT
 125:26081+16	F813  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR BACK TO IDLE STATE
 126:26097+10	F816  C9      		RET
 127:				;
 128:				;
 129:				;
 130:				;
 131:     -	F817          	SCAN:
 132:26107+7	F817  4E      		LD	C,(HL)		;LOAD BC WITH TABLE LENGTH @HL
 133:26114+6	F818  23      		INC	HL
 134:26120+7	F819  46      		LD	B,(HL)
 135:26127+6	F81A  23      		INC	HL
 136:26133+16+5	F81B  EDB1    		CPIR			;SCAN STRING @HL FOR MATCH WITH ACC
 137:26149+5+6	F81D  C0      		RET	NZ		;EXIT IF NO MATCH
 138:				
 139:26154+11	F81E  F5      		PUSH	AF
 140:26165+11	F81F  09      		ADD	HL,BC		;ELSE ADD RESIDUE FROM CPIR TO HL
 141:26176+11	F820  09      		ADD	HL,BC		;THREE TIMES TO POINT TO ADDRESS
 142:26187+11	F821  09      		ADD	HL,BC		;CORRESPONDING TO MATCHED VALUE
 143:26198+7	F822  7E      		LD	A,(HL)
 144:26205+6	F823  23      		INC	HL
 145:26211+7	F824  66      		LD	H,(HL)
 146:26218+4	F825  6F      		LD	L,A
 147:26222+10	F826  F1      		POP	AF
 148:26232+10	F827  C9      		RET			;RETURN TABLE ENTRY IN HL
 149:				;
 150:				;
 151:				;
 152:				;	... DEVICE ID TABLE FOR DISK/PRINTER/RS232 COMBO BOX ...
 153:				;
 154:     -	F828          	IDTAB:
 155:     -	F828  0600    		DEFW	IDMAX
 156:				
 157:     -	F82A  40      	PTRID:	DEFB	'@'		;PRINTER CONTROLLER ID CODE
 158:     -	F82B  31      		DEFB	'1'		;DISK UNIT #1 ID CODE
 159:     -	F82C  32      		DEFB	'2'		;DISK #2
 160:     -	F82D  33      		DEFB	'3'		;DISK #3
 161:     -	F82E  34      		DEFB	'4'		;DISK #4
 162:     -	F82F  5A      		DEFB	'Z'		;Z80 LOAD/DUMP/GOTO
 163:				
 164:     -	F830  44F8    		DEFW	Z80TAB
 165:     -	F832          	SalyDISKID:
 166:     -	F832  640C    		DEFW	DISKTAB
 167:     -	F834  640C    		DEFW	DISKTAB
 168:     -	F836  640C    		DEFW	DISKTAB
 169:     -	F838  640C    		DEFW	DISKTAB
 170:     -	F83A  3CF8    		DEFW	PTRTAB
 171:     -	0006          	IDMAX	EQU	($-IDTAB)/3
 172:				;
 173:				;
 174:				;
 175:     -	F83C          	PTRTAB:				;PRINTER COMMANDS
 176:     -	F83C  0200    		DEFW	PTRMAX
 177:				
 178:     -	F83E  53      		DEFB	'S'		;PRINTER STATUS
 179:     -	F83F  57      		DEFB	'W'		;PRINTER OUTPUT
 180:				
 181:     -	F840  68F8    		DEFW	PTRWRITE
 182:     -	F842  52F8    		DEFW	PTRSTAT
 183:     -	0002          	PTRMAX	EQU	($-(PTRTAB+2))/3
 184:				;
 185:				;
 186:				;
 187:     -	0000          		IF SALLYRS = 0
 209:					ENDIF
 210:				;
 211:				;
 212:     -	F844          	Z80TAB:				;Z80 COMMANDS
 213:     -	F844  0400    		DEFW	Z80MAX
 214:				
 215:     -	F846  52      		DEFB	'R'		;MEMORY READ
 216:     -	F847  57      		DEFB	'W'		;MEMORY WRITE
 217:     -	F848  53      		DEFB	'S'		;SET ADDRESS
 218:     -	F849  47      		DEFB	'G'		;GOTO ADDRESS
 219:				
 220:     -	F84A  EFFB    		DEFW	Z80GOTO
 221:     -	F84C  E1FB    		DEFW	Z80SET
 222:     -	F84E  B6FB    		DEFW	Z80WRITE
 223:     -	F850  9AFB    		DEFW	Z80READ
 224:     -	0004          	Z80MAX	EQU	($-(Z80TAB+2))/3
 225:				;
 226:				;
 227:				;
 229:				;
 230:				;
 231:				;	... PRINTER STATUS COMMAND PROCESSOR ...
 232:				;
 233:     -	F852          	PTRSTAT:
 234:26242+17	F852  CD84FB  		CALL	SENDACK
 235:26259+10	F855  2143FF  		LD	HL,PSMSG
 236:26269+10	F858  11FCC2  		LD	DE,IOBUFF+LEN-4
 237:26279+11	F85B  D5      		PUSH	DE
 238:26290+10	F85C  010400  		LD	BC,4
 239:26300+16+5	F85F  EDB0    		LDIR			;COPY PRINTER STATUS FRAME FROM RAM
 240:26316+10	F861  E1      		POP	HL
 241:26326+10	F862  114300  		LD	DE,'C'		;SEND PRINTER STATUS UN-INVERTED
 242:26336+10	F865  C36EF6  		JP	SENDBUFF
 243:				;	ret
 244:				;
 245:				;
 246:				;	... PRINTER WRITE COMMAND PROCESSOR ...
 247:				;
 248:     -	F868          	PTRWRITE:
 249:26346+17	F868  CD84FB  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 250:26363+17	F86B  CDBBF6  		CALL	RECVBUFF	;GET PRINT DATA FROM SERIAL BUS
 251:26380+5+6	F86E  C0      		RET	NZ		;EXIT IF ERROR OR TIMEOUT
 252:				
 253:26385+10	F86F  112800  		LD	DE,40
 254:26395+4	F872  B7      		OR	A
 255:26399+15	F873  ED52    		SBC	HL,DE
 256:26414+5+6	F875  C0      		RET	NZ		;ERROR IF RX BLOCK LENGTH <> 40 BYTES
 257:				
 258:26419+17	F876  CD84FB  		CALL	SENDACK		;ELSE SEND 'ACK'
 259:26436+10	F879  2100C1  		LD	HL,IOBUFF
 260:26446+7	F87C  0628    		LD	B,40
 261:26453+7	F87E  7E      	PWRIT3:	LD	A,(HL)
 262:26460+7	F87F  FE9B    		CP	9BH		;CHECK FOR 'ATASCII' CARRIAGE RETURN
 263:26467+7+5	F881  2005    		JR	NZ,PWRT3A
 264:				
 265:26474+10	F883  213EFF  		LD	HL,NEWLIN
 266:26484+7	F886  46      		LD	B,(HL)		;OUTPUT PRINTER'S NEWLINE CHARACTER(S)
 267:26491+6	F887  23      		INC	HL
 268:				
 269:26497+11	F888  E5      	PWRT3A:	PUSH	HL
 270:26508+16	F889  2A4FFF  		LD	HL,(PCOUNT)
 271:26524+20	F88C  ED5B4DFF		LD	DE,(PSIZE)
 272:26544+4	F890  B7      		OR	A
 273:26548+15	F891  ED52    		SBC	HL,DE		;TEST IF PRINTER BUFFER IS FULL
 274:26563+10	F893  E1      		POP	HL
 275:26573+7+5	F894  380E    		JR	C,PWRIT4	;STORE ANOTHER CHARACTER IF NOT FULL
 276:				
 277:26580+11	F896  E5      		PUSH	HL
 278:26591+11	F897  C5      		PUSH	BC
 279:26602+17	F898  CDC1F8  		CALL	SPOOLER		;TRY TO CLEAR OUT BUFFER
 280:26619+10	F89B  C1      		POP	BC
 281:26629+10	F89C  E1      		POP	HL
 282:26639+11	F89D  DB70    		IN	A,(ATARI)
 283:26650+7	F89F  E602    		AND	00000010B	;TEST ATARI COMMAND LINE AND
 284:				;	JR	NZ,PWRT3A	;STAY IN LOOP IF INACTIVE
 285:26657+7+5	F8A1  28E5    		JR	Z,PWRT3A	;STAY IN LOOP IF INACTIVE
 286:				
 287:26664+10	F8A3  C9      		RET			;ELSE ABORT PRINTING AND RETURN
 288:				;
 289:26674+7	F8A4  7E      	PWRIT4:	LD	A,(HL)
 290:26681+6	F8A5  23      		INC	HL
 291:26687+11	F8A6  E5      		PUSH	HL
 292:26698+11	F8A7  C5      		PUSH	BC
 293:26709+16	F8A8  2A51FF  		LD	HL,(PINP)
 294:26725+17	F8AB  CDE1F8  		CALL	INDEX		;GET INDEX TO FIFO INPUT PLACE
 295:26742+20	F8AE  ED5351FF		LD	(PINP),DE	;STORE UPDATED INPUT OFFSET
 296:26762+7	F8B2  77      		LD	(HL),A		;STORE CHARACTER IN QUEUE
 297:26769+16	F8B3  2A4FFF  		LD	HL,(PCOUNT)
 298:26785+6	F8B6  23      		INC	HL		;BUMP FIFO CHARACTER COUNTER
 299:26791+16	F8B7  224FFF  		LD	(PCOUNT),HL
 300:26807+10	F8BA  C1      		POP	BC
 301:26817+10	F8BB  E1      		POP	HL
 302:26827+8+5	F8BC  10C0    		DJNZ	PWRIT3		;REPEAT TO END OF STRING
 303:				
 304:26835+10	F8BE  C38FFB  		JP	SENDCOMP	;SEND 'COMPLETE' TO ATARI
 305:				;	ret
 306:				;
 307:				;
 308:				;
 309:     -	F8C1          	SPOOLER:
 310:26845+16	F8C1  2A4FFF  		LD	HL,(PCOUNT)
 311:26861+4	F8C4  7C      		LD	A,H
 312:26865+4	F8C5  B5      		OR	L
 313:26869+5+6	F8C6  C8      		RET	Z		;EXIT IF NO DATA IN FIFO TO PRINT
 314:				
 315:26874+17	F8C7  CD15F0  		CALL	LISTV+3
 316:26891+5+6	F8CA  C0      		RET	NZ		;EXIT IF PRINTER BUSY
 317:				
 318:26896+16	F8CB  2A53FF  		LD	HL,(POUT)
 319:26912+17	F8CE  CDE1F8  		CALL	INDEX		;GET POINTER WITH AUTO-INCREMENT
 320:26929+20	F8D1  ED5353FF		LD	(POUT),DE
 321:26949+7	F8D5  4E      		LD	C,(HL)
 322:26956+17	F8D6  CD12F0  		CALL	LISTV		;PRINT CHARACTER AND EXIT
 323:26973+16	F8D9  2A4FFF  		LD	HL,(PCOUNT)
 324:26989+6	F8DC  2B      		DEC	HL		;DIMINISH BUFFER COUNT BY ONE
 325:26995+16	F8DD  224FFF  		LD	(PCOUNT),HL
 326:27011+10	F8E0  C9      		RET
 327:				;
 328:				;
 329:				;
 330:				;
 331:     -	F8E1          	INDEX:
 332:27021+4	F8E1  EB      		EX	DE,HL
 333:27025+16	F8E2  2A4BFF  		LD	HL,(PBASE)
 334:27041+11	F8E5  19      		ADD	HL,DE		;ADD OFFSET TO FIFO BASE ADDRESS
 335:27052+11	F8E6  E5      		PUSH	HL
 336:27063+6	F8E7  13      		INC	DE		;BUMP OFFSET NOW IN DE
 337:27069+16	F8E8  2A4DFF  		LD	HL,(PSIZE)
 338:27085+4	F8EB  B7      		OR	A
 339:27089+15	F8EC  ED52    		SBC	HL,DE		;COMPARE TO MAX OFFSET VALUE
 340:27104+7+5	F8EE  3003    		JR	NC,INDEX2
 341:27111+10	F8F0  110000  		LD	DE,0		;SET OFFSET TO ZERO IF ROLL-OVER
 342:27121+10	F8F3  E1      	INDEX2:	POP	HL
 343:27131+10	F8F4  C9      		RET			;RETURN DE=OFFSET AND HL=POINTER
 344:				;
 345:				;
 346:				;
 347:				;	... DISK WRITE COMMAND PROCESSOR ...
 348:				;
 349:     -	F8F5          	DISKPUT:
 350:27141+4	F8F5  AF      		XOR	A
 351:27145+12	F8F6  1802    		JR	DWRT0
 352:				;
 353:     -	F8F8          	DISKWRITE:
 354:27157+7	F8F8  3E01    		LD	A,1
 355:27164+13	F8FA  32B5FF  	DWRT0:	LD	(VFLAG),A
 356:27177+17	F8FD  CD7A07  		CALL	DRVINDEX	;INDEX TO GET DRIVE PARAMETER POINTER
 357:27194+5+6	F900  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 358:				
 359:27199+17	F901  CD84FB  		CALL	SENDACK
 360:27216+17	F904  CDBBF6  		CALL	RECVBUFF	;ELSE GO QUICK TO READ DATA FRAME
 361:27233+5+6	F907  C0      		RET	NZ		;EXIT IF BAD CHECKSUM
 362:     -	F908          	SalyDISKWRT1:
 363:27238+16	F908  22A9FF  		LD	(LOGSIZ),HL	;SAVE DATA BLOCK LENGTH
 364:     -	F90B          	SalyDISKWRT2:
 365:27254+10	F90B  118000  		LD	DE,128
 366:27264+4	F90E  B7      		OR	A
 367:27268+15	F90F  ED52    		SBC	HL,DE		;TEST FOR 128 BYTE FRAME
 368:27283+7+5	F911  2804    		JR	Z,DWRT1
 369:27290+4	F913  B7      		OR	A
 370:27294+15	F914  ED52    		SBC	HL,DE		;TEST FOR 256 BYTE FRAME
 371:27309+5+6	F916  C0      		RET	NZ
 372:				
 373:27314+17	F917  CD84FB  	DWRT1:	CALL	SENDACK		;SEND 'ACK' IF BLOCKSIZE IS 128 OR 256
 374:27331+17	F91A  CD08FA  		CALL	SECTRAN		;SET DISK PARAMETERS FOR WRITE
 375:27348+7+5	F91D  204E    		JR	NZ,DWRT4	;JUMP IF ERROR FROM 'SECTRAN'
 376:				
 377:27355+10	F91F  2100C1  		LD	HL,IOBUFF
 378:27365+16	F922  229CFF  		LD	(DKIOCB+DSKPTR),HL
 379:27381+13	F925  3AA9FF  		LD	A,(LOGSIZ)
 380:27394+4	F928  47      		LD	B,A		;PREPARE TO COMPLIMENT DISK DATA BLOCK
 381:27398+7	F929  7E      	DWRT2:	LD	A,(HL)
 382:27405+4	F92A  2F      		CPL
 383:27409+7	F92B  77      		LD	(HL),A		;COMPLIMENT DISK DATA BLOCK
 384:27416+6	F92C  23      		INC	HL
 385:27422+8+5	F92D  10FA    		DJNZ	DWRT2		;REPEAT TO END OF BLOCK
 386:27430+7	F92F  3E02    		LD	A,PUTSEC
 387:27437+13	F931  3298FF  		LD	(DKIOCB+DSKOP),A
 388:27450+14	F934  DD2198FF		LD	IX,DKIOCB
 389:     -	F938          	SalyDISKWRT3:
 390:27464+17	F938  CD0FF0  		CALL	DISKV		;CALL PHYSICAL DISK DRIVER
 391:27481+13	F93B  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 392:27494+4	F93E  B7      		OR	A
 393:27498+7+5	F93F  202C    		JR	NZ,DWRT4	;BOMB OUT NOW IF DISK ERROR
 394:				
 395:27505+13	F941  3AB5FF  		LD	A,(VFLAG)
 396:27518+4	F944  B7      		OR	A
 397:27522+7+5	F945  2826    		JR	Z,DWRT4		;EXIT OK IF NOT WRITE WITH VERIFY
 398:				
 399:27529+7	F947  3E01    		LD	A,GETSEC
 400:27536+13	F949  3298FF  		LD	(DKIOCB+DSKOP),A
 401:27549+10	F94C  2100C3  		LD	HL,IOBUFF+LEN
 402:27559+16	F94F  229CFF  		LD	(DKIOCB+DSKPTR),HL
 403:27575+17	F952  CD0FF0  		CALL	DISKV		;ELSE READ SECTOR BACK FOR VERIFY
 404:27592+13	F955  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 405:27605+4	F958  B7      		OR	A
 406:27609+7+5	F959  2012    		JR	NZ,DWRT4	;BOMB AGAIN IF READ ERROR
 407:				
 408:27616+10	F95B  2100C1  		LD	HL,IOBUFF
 409:27626+10	F95E  1100C3  		LD	DE,IOBUFF+LEN
 410:27636+13	F961  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 411:27649+4	F964  47      		LD	B,A		;PREPARE TO COMPARE 128 OR 256 BYTES
 412:27653+7	F965  1A      	DWRT3:	LD	A,(DE)
 413:27660+7	F966  AE      		XOR	(HL)
 414:27667+7+5	F967  200B    		JR	NZ,DWRT5
 415:27674+6	F969  23      		INC	HL
 416:27680+6	F96A  13      		INC	DE
 417:27686+8+5	F96B  10F8    		djnz	DWRT3		;fall through last time with acc=0
 418:				
 419:27694+17	F96D  CDD3F9  	DWRT4:	CALL	SETSTAT		;DO STATUS SETTING STUFF
 420:27711+4	F970  7B      		LD	A,E
 421:27715+10	F971  C391FB  		JP	SENDCHAR	;SEND 'COMPLETE' OR 'ERROR' TO ATARI
 422:				;	ret
 423:				;
 424:27725+4	F974  AF      	DWRT5:	XOR	A
 425:27729+17	F975  CDFEF9  		CALL	ssts4		;set hardware status=0 but set bad r/w
 426:27746+4	F978  7B      		LD	a,e
 427:27750+10	F979  C391FB  		JP	sendchar
 428:				;	ret
 429:				;
 430:				;
 431:				;
 432:				;	... DISK READ COMMAND PROCESSOR ...
 433:				;
 434:     -	F97C          	DISKREAD:
 435:27760+17	F97C  CD7A07  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 436:27777+5+6	F97F  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 437:				
 438:27782+17	F980  CD84FB  		CALL	SENDACK
 439:     -	F983          	SalyDISKRD1:
 440:27799+17	F983  CD08FA  		CALL	SECTRAN		;SET PARAMETERS FOR DISK OPERATION
 441:     -	F986          	SalyDISKRD2:
 442:27816+11	F986  F5      		PUSH	AF		;SAVE ERROR STATUS FROM 'SECTRAN'
 443:27827+7+5	F987  280F    		JR	Z,DRD2		;JUMP IF PARAMS SET OK
 444:				
 445:27834+19	F989  FD5606  		LD	D,(IY+SECLEN)
 446:27853+19	F98C  FD5E07  		LD	E,(IY+SECLEN+1)	;LOAD DE WITH SECTOR LEN FROM 'DMATRIX'
 447:27872+4	F98F  7A      		LD	A,D
 448:27876+4	F990  B3      		OR	E
 449:27880+7+5	F991  2009    		JR	NZ,DRD2A	;JUMP IF LENGTH <> 0
 450:				
 451:27887+10	F993  118000  		LD	DE,128		;ELSE REVERT TO 128 BYTES
 452:27897+12	F996  1804    		JR	DRD2A
 453:				;
 454:27909+20	F998  ED5B9EFF	DRD2:	LD	DE,(DKIOCB+DSKAUX) ;LOAD DE WITH PHYSICAL SECTOR LENGTH
 455:27929+16	F99C  2AFDC2  	DRD2A:	LD	HL,(CFRAME+2)
 456:27945+10	F99F  010400  		LD	BC,4
 457:27955+4	F9A2  B7      		OR	A
 458:27959+15	F9A3  ED42    		SBC	HL,BC		;TEST IF ACCESSING SECTOR# 1,2 OR 3
 459:27974+7+5	F9A5  3003    		JR	NC,DRD3		;JUMP IF NOT ACCESSING A BOOT SECTOR
 460:27981+10	F9A7  118000  		LD	DE,128
 461:27991+20	F9AA  ED53A9FF	DRD3:	LD	(LOGSIZ),DE
 462:28011+10	F9AE  2100C3  		LD	HL,IOBUFF+LEN
 463:28021+4	F9B1  B7      		OR	A
 464:28025+15	F9B2  ED52    		SBC	HL,DE		;COMPUTE STARTING PLACE IN BUFFER
 465:28040+10	F9B4  F1      		POP	AF
 466:28050+7+5	F9B5  2014    		JR	NZ,DRD4		;JUMP IF ERROR FROM 'SECTRAN' ABOVE
 467:				
 468:28057+16	F9B7  229CFF  		LD	(DKIOCB+DSKPTR),HL
 469:28073+7	F9BA  3E01    		LD	A,GETSEC
 470:28080+13	F9BC  3298FF  		LD	(DKIOCB+DSKOP),A
 471:28093+14	F9BF  DD2198FF		LD	IX,DKIOCB
 472:28107+11	F9C3  E5      		PUSH	HL
 473:     -	F9C4          	SalyDISKRD3:
 474:28118+17	F9C4  CD0FF0  		CALL	DISKV		;CALL DISK I/O HANDLER
 475:28135+10	F9C7  E1      		POP	HL
 476:28145+13	F9C8  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 477:				
 478:28158+17	F9CB  CDD3F9  	DRD4:	CALL	SETSTAT		;TEST AND STORE STATUS STUFF
 479:28175+7	F9CE  16FF    		LD	D,255		;SET MASK TO INVERT DISK DATA
 480:28182+10	F9D0  C36EF6  		JP	SENDBUFF	;SEND RESPONSE TO ATARI
 481:				;	ret
 482:				;
 483:				;
 484:				;
 485:				;	ROUTINE TO CHECK STATUS AFTER READ/WRITE
 486:				;
 487:     -	F9D3          	SETSTAT:
 488:28192+4	F9D3  B7      		OR	A
 489:28196+7+5	F9D4  200E    		JR	NZ,SSTS1	;JUMP IF SOME DISK ERROR INDICATED
 490:				
 491:28203+19	F9D6  FD770D  		LD	(IY+HDWSTS),A	;ELSE STORE ZEROS IN HARDWARE STATUS
 492:28222+7	F9D9  1E43    		LD	E,'C'		;LOAD E WITH 'COMPLETE' CHARACTER
 493:28229+23	F9DB  FDCB0C96		RES	BADRW,(IY+CMDSTS)
 494:28252+23	F9DF  FDCB0C9E		RES	WRPROT, (IY + CMDSTS)
 495:28275+10	F9E3  C9      		RET
 496:				;
 497:				;	ACC HOLDS NON-ZERO VALUE INDICATING A DISK ERROR
 498:				;
 499:28285+8	F9E4  CB77    	SSTS1:	BIT	6,A		;BIT HOLDS WPROT STATUS AFTER WRITE
 500:28293+7+5	F9E6  2806    		JR	Z,SSTS2
 501:				
 502:28300+7	F9E8  E69F    		AND	10011111B
 503:28307+23	F9EA  FDCB0CDE		SET	WRPROT, (IY + CMDSTS)
 504:				
 505:28330+8	F9EE  CB6F    	SSTS2:	BIT	5,A		;HOLDS DD MARK STATUS AFTER READ
 506:28338+7+5	F9F0  2802    		JR	Z,SSTS3
 507:				
 508:28345+7	F9F2  F660    		OR	01100000B	;CREATE 1771 DD ADDRESS MARK STATUS
 509:				
 510:28352+4	F9F4  4F      	SSTS3:	LD	C,A
 511:28356+7	F9F5  E681    		AND	10000001B	;TEST FOR 'READY' OR 'BUSY' BITS SET
 512:28363+4	F9F7  79      		LD	A,C
 513:28367+7+5	F9F8  2804    		JR	Z,SSTS4		;JUMP IF NOT READY/BUSY LOCK UP
 514:				
 515:28374+7	F9FA  E67E    		AND	01111110B	;ELSE CLEAR BOTH BITS AND REPLACE
 516:28381+7	F9FC  F610    		OR	00010000B	; WITH 'RNF' ERROR BIT INSTEAD
 517:				
 518:28388+19	F9FE  FD770D  	SSTS4:	LD	(IY+HDWSTS),A	;STORE HARDWARE STATUS FOR ATARI
 519:28407+7	FA01  1E45    		LD	E,'E'		;LOAD E WITH 'ERROR' CHARACTER
 520:28414+23	FA03  FDCB0CD6		SET	BADRW,(IY+CMDSTS)
 521:28437+10	FA07  C9      		RET
 522:				;
 523:				;
 524:				;
 525:				;
 526:				;
 527:				;
 528:     -	FA08          	SECTRAN:
 529:				;	BIT	CONFIG,(IY+FLAGS)
 530:				;	JP	NZ,STRAN3	;SKIP IF DRIVE HAS BEEN CONFIGURED
 531:				
 532:28447+13	FA08  3A2EFF  		LD	A,(DRVOFF)
 533:28460+4	FA0B  B7      		OR	A
 534:28464+7+5	FA0C  2811    		JR	Z,STRAN2	;JUMP IF DRIVES HAVE NOT BEEN STOPPED
 535:				
 536:28471+4	FA0E  AF      		XOR	A
 537:28475+13	FA0F  322EFF  		LD	(DRVOFF),A	;CLEAR DRIVES-STOPPED FLAGS
 538:28488+10	FA12  2164FF  		LD	HL,DMATRIX+FLAGS
 539:28498+10	FA15  111000  		LD	DE,16
 540:28508+7	FA18  0604    		LD	B,4
 541:28515+15	FA1A  CB86    	STRAN1:	RES	FIRST,(HL)	;ZIP THRU ARRAY RESETING 'FIRST' FLAGS
 542:28530+11	FA1C  19      		ADD	HL,DE		; TO FORCE MEDIA TO BE EXAMINED ANEW
 543:28541+8+5	FA1D  10FB    		DJNZ	STRAN1
 544:				
 545:28549+20	FA1F  FDCB0E46	STRAN2:	BIT	FIRST,(IY+FLAGS)
 546:28569+7+5	FA23  206D    		JR	NZ,STRAN3	;SKIP MEDIA CHECK IF DRIVE IS ACTIVE
 547:				
 548:28576+7	FA25  3E03    		LD	A,GETID
 549:28583+13	FA27  3298FF  		LD	(DKIOCB+DSKOP),A
 550:28596+13	FA2A  3A99FF  		LD	A,(DKIOCB+DSKDRV)
 551:28609+10	FA2D  2120FF  		LD	HL,DRVTAB
 552:28619+4	FA30  85      		ADD	A,L
 553:28623+4	FA31  6F      		LD	L,A		;POINT TO HEAD POSITION FOR DRIVE#
 554:28627+7	FA32  7E      		LD	A,(HL)
 555:28634+7	FA33  FE50    		CP	80
 556:28641+7+5	FA35  3801    		JR	C,STR20		;JUMP IF TRACK# IN VALID RANGE
 557:28648+4	FA37  AF      		XOR	A		;ELSE GOTO TRACK ZERO
 558:28652+13	FA38  329AFF  	STR20:	LD	(DKIOCB+DSKTRK),A
 559:28665+10	FA3B  21ABFF  		LD	HL,IDBUF
 560:28675+16	FA3E  229CFF  		LD	(DKIOCB+DSKPTR),HL
 561:28691+14	FA41  DD2198FF		LD	IX,DKIOCB
 562:28705+17	FA45  CD0FF0  		CALL	DISKV		;READ AN ID MARK FROM CURRENT TRACK
 563:28722+13	FA48  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 564:28735+4	FA4B  B7      		OR	A
 565:28739+5+6	FA4C  C0      		RET	NZ		;EXIT IF DISK ERROR ON READ-ID
 566:				;
 567:				;	ARRIVE HERE TO SET DISK PARAMS IMPLICITLY
 568:				;
 569:28744+13	FA4D  3AAEFF  		LD	A,(IDBUF+3)	;GET SECTOR LENGTH BYTE FROM ID
 570:28757+17	FA50  CDC5FA  		call	getsize		;compute sector length in bytes
 571:28774+19	FA53  FD7006  		ld	(iy+seclen),b
 572:28793+19	FA56  FD7107  		ld	(iy+seclen+1),c	;store result in 'seclen' param slot
 573:28812+13	FA59  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 574:28825+4	FA5C  07      		RLCA
 575:28829+4	FA5D  07      		RLCA
 576:28833+4	FA5E  07      		RLCA
 577:28837+4	FA5F  2F      		CPL
 578:28841+7	FA60  E606    		AND	00000110B	;MAKE PERCOM DENSITY/SIZE BITS
 579:28848+19	FA62  FD7705  		LD	(IY+MEDIA),A
 580:28867+8	FA65  CB4F    		BIT	SIZE,A
 581:28875+7+5	FA67  2807    		JR	Z,STR25		;JUMP IF FIVE INCH DISK SELECTED
 582:				
 583:28882+7	FA69  3E4D    		LD	A,77
 584:28889+10	FA6B  211A00  		LD	HL,26
 585:28899+12	FA6E  1805    		JR	STR26
 586:				;
 587:28911+7	FA70  3E28    	STR25:	LD	A,40
 588:28918+10	FA72  211200  		LD	HL,18
 589:28928+19	FA75  FDBE00  	str26:	cp	(iy+ntrks)
 590:28947+7+5	FA78  3803    		jr	c,str27		;skip if ntrks has been set > default
 591:28954+19	FA7A  FD7700  		ld	(iy+ntrks),a	;else set param to default value
 592:28973+19	FA7D  FD7402  	STR27:	LD	(IY+NSECS),H
 593:28992+19	FA80  FD7503  		LD	(IY+NSECS+1),L	;STORE SECTORS PER TRACK PARAM
 594:				
 595:29011+23	FA83  FDCB0EC6		SET	FIRST,(IY+FLAGS)
 596:29034+16	FA87  2A96FF  		LD	HL,(OLDPTR)
 597:29050+4	FA8A  7C      		LD	A,H
 598:29054+4	FA8B  B5      		OR	L
 599:29058+7+5	FA8C  2004    		JR	NZ,STRAN3	;JUMP IF NOT THE FIRST-EVER DISKOP
 600:				
 601:29065+20	FA8E  FD2296FF		LD	(OLDPTR),IY	;ELSE SET POINTER TO THIS GUYS STUFF
 602:				;
 603:				;	ARRIVE HERE TO COMPUTE TRACK/SECTOR AND SET DISK BYTECOUNT
 604:				;
 605:29085+16	FA92  2AFDC2  	STRAN3:	LD	HL,(CFRAME+2)
 606:29101+6	FA95  2B      		DEC	HL		;REMOVE +1 BIAS FROM SECTOR NUMBER
 607:29107+7	FA96  1600    		LD	D,0
 608:29114+19	FA98  FD5E03  		LD	E,(IY+NSECS+1)
 609:29133+7	FA9B  3EFF    		LD	A,-1
 610:29140+4	FA9D  3C      	STRAN4:	INC	A
 611:29144+4	FA9E  B7      		OR	A
 612:29148+15	FA9F  ED52    		SBC	HL,DE
 613:29163+7+5	FAA1  30FA    		JR	NC,STRAN4	;DIVIDE ABSOLUTE SECTOR NUMBER BY SPT
 614:29170+11	FAA3  19      		ADD	HL,DE
 615:29181+6	FAA4  23      		INC	HL		;RESTORE +1 BIAS TO SECTOR NUMBER
 616:29187+4	FAA5  4D      		LD	C,L
 617:29191+10	FAA6  219BFF  		LD	HL,DKIOCB+DSKSEC
 618:29201+7	FAA9  71      		LD	(HL),C		;STORE PHYSICAL SECTOR#
 619:				
 620:29208+19	FAAA  FDBE00  		CP	(IY+NTRKS)	;COMPARE RESULT FROM TRACK# COMPUTATION
 621:29227+7+5	FAAD  3808    		JR	C,STRAN5	; TO 'NTRKS' PARAM AND JUMP IF LESS
 622:				
 623:29234+19	FAAF  FD9600  		SUB	(IY+NTRKS)	;ELSE SUBTRACT EXTRA AND SELECT SIDE# 1
 624:29253+10	FAB2  2199FF  		LD	HL,DKIOCB+DSKDRV
 625:29263+15	FAB5  CBFE    		SET	7,(HL)
 626:				
 627:29278+13	FAB7  329AFF  	STRAN5:	LD	(DKIOCB+DSKTRK),A  ;STORE PHYSICAL TRACK#
 628:29291+19	FABA  FD6606  		LD	H,(IY+SECLEN)
 629:29310+19	FABD  FD6E07  		LD	L,(IY+SECLEN+1)
 630:29329+16	FAC0  229EFF  		LD	(DKIOCB+DSKAUX),HL  ;STORE PHYSICAL SECTOR SIZE FOR I/O
 631:29345+4	FAC3  AF      		XOR	A
 632:29349+10	FAC4  C9      		RET
 633:				;
 634:				;
 635:				;
 636:     -	FAC5          	getsize:
 637:29359+10	FAC5  018000  		ld	bc,128
 638:29369+7	FAC8  E603    		and	00000011b
 639:29376+5+6	FACA  C8      		ret	z		;sector length code=0 means 128 bytes
 640:				
 641:29381+8	FACB  CB21    	getsz2:	sla	c
 642:29389+8	FACD  CB10    		rl	b		;else multiply 128 by 2,4 or 8
 643:29397+4	FACF  3D      		dec	a
 644:29401+7+5	FAD0  20F9    		jr	nz,getsz2
 645:29408+10	FAD2  C9      		ret
 646:				;
 647:				;
 648:				;
 649:				;
 650:				;
 651:				;	... DISK STATUS COMMAND PROCESSOR ...
 652:				;
 653:     -	FAD3          	DISKSTAT:
 654:29418+17	FAD3  CD7A07  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 655:29435+5+6	FAD6  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 656:				
 657:29440+17	FAD7  CD84FB  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 658:29457+17	FADA  CD30FB  		CALL	HASPARMS	;CHECK IF HAS NEVER BEEN ACCESSED
 659:29474+13	FADD  3AC9FF  		LD	A,(DRVTMR)
 660:29487+11	FAE0  F5      		PUSH	AF		;SAVE DRIVE TIMER VALUE RIGHT NOW
 661:29498+7	FAE1  3E00    		LD	A,TSTRDY
 662:29505+13	FAE3  3298FF  		LD	(DKIOCB+DSKOP),A
 663:29518+14	FAE6  DD2198FF		LD	IX,DKIOCB
 664:29532+17	FAEA  CD0FF0  		CALL	DISKV		;CALL DISK HANDLER TO GET TYPE 1 STATUS
 665:				
 666:29549+19	FAED  FD4E0C  		LD	C,(IY+CMDSTS)	;PREPARE TO DERRIVE REST OF 'CMDSTS'
 667:29568+19	FAF0  FD360C00		LD	(IY+CMDSTS),0	; AND RESET OLD STATUS BITS
 668:29587+10	FAF4  F1      		POP	AF
 669:29597+4	FAF5  B7      		OR	A
 670:29601+7+5	FAF6  2804    		JR	Z,DSTAT1	;JUMP IF DRIVES WERE PREVIOUSLY STOPPED
 671:				
 672:29608+8	FAF8  CBE1    		SET	ACTIVE,C
 673:29616+12	FAFA  1802    		JR	DSTAT2
 674:				;
 675:29628+8	FAFC  CBA1    	DSTAT1:	RES	ACTIVE,C
 676:29636+20	FAFE  FDCB0556	DSTAT2:	BIT	DENSTY,(IY+MEDIA)
 677:29656+7+5	FB02  2804    		JR	Z,DSTAT3	;JUMP IF DRIVE SET FOR SINGLE DENSITY
 678:				
 679:29663+8	FB04  CBE9    		SET	SEC256,C
 680:29671+12	FB06  1802    		JR	DSTAT4
 681:				;
 682:29683+8	FB08  CBA9    	DSTAT3:	RES	SEC256,C
 683:29691+20	FB0A  DDCB0876	DSTAT4:	BIT	6,(IX+DSKSTS)
 684:29711+7+5	FB0E  2804    		JR	Z,DSTAT5	;JUMP IF DRIVE IS NOT WRITE PROTECTED
 685:				
 686:29718+8	FB10  CBD9    		SET	WRPROT,C
 687:29726+12	FB12  1802    		JR	DSTAT6
 688:				;
 689:29738+8	FB14  CB99    	DSTAT5:	RES	WRPROT,C
 690:29746+10	FB16  21FCC2  	DSTAT6:	LD	HL,IOBUFF+LEN-4
 691:29756+11	FB19  E5      		PUSH	HL
 692:29767+7	FB1A  71      		LD	(HL),C		;STORE DRIVE COMMAND STATUS IN BUFFER
 693:29774+6	FB1B  23      		INC	HL
 694:29780+19	FB1C  FD7E0D  		LD	A,(IY+HDWSTS)
 695:29799+4	FB1F  2F      		CPL
 696:29803+7	FB20  77      		LD	(HL),A		;STORE HARDWARE POOP NEXT
 697:29810+6	FB21  23      		INC	HL
 698:29816+10	FB22  36E0    		LD	(HL),224	;STORE MAX TIMEOUT AFTER THAT
 699:29826+6	FB24  23      		INC	HL
 700:29832+13	FB25  3A2DFF  		LD	A,(TRACK)
 701:29845+7	FB28  77      		LD	(HL),A		;STORE TRACK# AS FOURTH BYTE
 702:29852+10	FB29  E1      		POP	HL
 703:29862+10	FB2A  114300  		LD	DE,'C'		;SEND DISK STATUS W/O COMPLIMENT
 704:29872+10	FB2D  C36EF6  		JP	SENDBUFF
 705:				;	ret
 706:				;
 707:     -	0000          		IF SALLYRS = 0
 803:					ENDIF
 804:				;
 805:				;
 806:				;
 807:				;
 808:     -	FB30          	HASPARMS:
 809:29882+19	FB30  FD7E00  		LD	A,(IY+NTRKS)
 810:29901+4	FB33  B7      		OR	A
 811:29905+5+6	FB34  C0      		RET	NZ		;EXIT IF PARAMS HAVE BEEN SET
 812:				
 813:29910+16	FB35  2A96FF  		LD	HL,(OLDPTR)
 814:29926+4	FB38  7C      		LD	A,H		;IF POINTER IS ZERO THEN NO DRIVE
 815:29930+4	FB39  B5      		OR	L		; PARAMS HAVE EVER BEEN SET
 816:29934+5+6	FB3A  C8      		RET	Z
 817:				
 818:29939+15	FB3B  FDE5    		PUSH	IY
 819:29954+10	FB3D  D1      		POP	DE
 820:29964+10	FB3E  010C00  		LD	BC,12
 821:29974+16+5	FB41  EDB0    		LDIR			;COPY BOOT DISK'S PARAMS TO THIS GUY
 822:29990+10	FB43  C9      		RET
 823:				;
 824:				;
 825:     -	0000          		IF SALLYRS = 0 
 850:					ENDIF
 851:				;
 852:				;
 853:				;
 854:				;	... PERCOM 'O' COMMAND PROCESSOR ...
 855:				;
 856:     -	FB44          	PUTPARAMS:
 857:30000+17	FB44  CD7A07  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 858:30017+5+6	FB47  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 859:				
 860:30022+17	FB48  CD84FB  		CALL	SENDACK
 861:30039+17	FB4B  CDBBF6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
 862:30056+5+6	FB4E  C0      		RET	NZ
 863:				
 864:30061+10	FB4F  110C00  		LD	DE,12
 865:30071+4	FB52  B7      		OR	A
 866:30075+15	FB53  ED52    		SBC	HL,DE
 867:30090+5+6	FB55  C0      		RET	NZ		;ERROR IF DATA FRAME NOT 12 BYTES
 868:				
 869:30095+17	FB56  CD84FB  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
 870:				;	SET	CONFIG,(IY+FLAGS)  ;INDICATE DRIVE IS NOW CONFIGURED
 871:30112+10	FB59  2100C1  		LD	HL,IOBUFF
 872:30122+15	FB5C  FDE5    		PUSH	IY
 873:30137+10	FB5E  D1      		POP	DE		;POINT DE TO PARAMETERS FOR DRIVE(N)
 874:30147+10	FB5F  010C00  		LD	BC,12
 875:30157+16+5	FB62  EDB0    		LDIR			;COPY NEW STUFF IN THE PLACE	
 876:				
 877:     -	0001          		IF SALLYRS = 1	
 878:30173+20	FB64  FDCB0E76		bit	6, (IY + FLAGS)
 879:30193+7+5	FB68  280A    		jr	Z, PUTPARAMS1
 880:30200+19	FB6A  FD7E06  		ld	a, (IY + SECLEN)
 881:30219+4	FB6D  B7      		or	a
 882:30223+7+5	FB6E  2004    		jr	NZ, PUTPARAMS1
 883:30230+19	FB70  FD36031A		ld	(IY + NSECS + 1), 26
 884:     -	FB74          	PUTPARAMS1:
 885:30249+17	FB74  CD9405  		call	computeflags
 886:30266+17	FB77  CD1607  		call	diskanalyse5	;compute maxsector
 887:30283+17	FB7A  CD560A  		call	dumppercom
 888:					ENDIF
 889:30300+10	FB7D  C38FFB  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
 890:				;	ret
 891:				;
 892:				;
 893:				;
 894:				;	... DATA STRUCTURE FOR DRIVE PARAMETER BLOCKS ...
 895:				;
 896:     -	0000          	NTRKS	EQU	0		;NUMBER OF TRACKS
 897:     -	0001          	STEPRT	EQU	1		;STEP RATE
 898:     -	0002          	NSECS	EQU	2		;SECTORS PER TRACK (HI/LOW)
 899:     -	0004          	NSIDES	EQU	4		;NUMBER OF SIDES
 900:     -	0005          	MEDIA	EQU	5		;MEDIA SIZE AND FORMAT BITS
 901:     -	0006          	SECLEN	EQU	6		;SECTOR LENGTH (HI/LOW)
 902:     -	0008          	DSKBITS	EQU	8		;MISC NAUGHTY BITS
 903:     -	0009          	SPARE0	EQU	9
 904:     -	000A          	SPARE1	EQU	10
 905:     -	000B          	SPARE2	EQU	11
 906:				
 907:     -	000C          	CMDSTS	EQU	12		;COMMAND STATUS
 908:     -	000D          	HDWSTS	EQU	13		;HARDWARE STATUS
 909:				
 910:     -	000E          	FLAGS	EQU	14		;FLAGS BYTE FOR DISK OPERATION
 911:     -	000F          	SPARE3	EQU	15
 912:				;
 913:				;
 914:				;	EQUATES FOR BITS IN 'MEDIA' BYTE
 915:				;
 916:     -	0001          	SIZE	EQU	1		;DISK SIZE (1=EIGHT, 0=FIVE)
 917:     -	0002          	DENSTY	EQU	2		;DENSITY (1=DOUBLE, 0=SINGLE)
 918:				;
 919:				;
 920:				;	EQUATES FOR BITS IN 'DSKBITS' BYTE
 921:				;
 922:     -	0006          	PRESENT	EQU	6		;DRIVE PRESENT (1=PRESENT)
 923:				;
 924:				;
 925:				;	EQUATES FOR BITS IN 'CMDSTS' BYTE
 926:				;
 927:     -	0000          	BADCMD	EQU	0		;BAD COMMAND FRAME BIT
 928:     -	0001          	BADDAT	EQU	1		;BAD DATA FRAME BIT
 929:     -	0002          	BADRW	EQU	2		;BAD READ/WRITE OPERATION BIT
 930:     -	0003          	WRPROT	EQU	3		;WRITE PROTECTED BIT
 931:     -	0004          	ACTIVE	EQU	4		;DRIVE READY INDICATOR BIT
 932:     -	0005          	SEC256	EQU	5		;LONG/SHORT SECTOR BIT
 933:				;
 934:				;
 935:				;	EQUATES FOR BITS IN 'FLAGS' BYTE
 936:				;
 937:     -	0000          	FIRST	EQU	0		;FIRST ACCESS FLAG (0=NOT ACCESSED)
 938:     -	0001          	CONFIG	EQU	1		;DRIVE CONFIGURED BIT (0=UNCONFIGED)
 939:				;
 940:				;
 941:				;
 942:				;
 943:     -	0000          		IF SALLYRS = 0
 970:					ENDIF
 971:				;
 972:				;
 973:				;
 974:     -	FB80          	SENDNACK:
 975:30310+7	FB80  2E4E    		LD	L, 'N'
 976:30317+12	FB82  1802    		JR	SENDACK1
 977:     -	FB84          	SENDACK:
 978:30329+7	FB84  2E41    		LD	L, 'A'
 979:     -	FB86          	SENDACK1:
 980:30336+11	FB86  DB70    		IN	A,(ATARI)
 981:30347+8	FB88  CB4F    		BIT	1,A
 982:30355+7+5	FB8A  28FA    		JR	Z,SENDACK1	;wait until CMD goes high
 983:				
 984:30362+4	FB8C  7D      		LD	A, L
 985:30366+12	FB8D  1802    		JR	SENDCHAR
 986:				;
 987:     -	FB8F          	SENDCOMP:
 988:30378+7	FB8F  3E43    		LD	A,'C'
 989:     -	FB91          	SENDCHAR:
 990:30385+10	FB91  2101C3  		LD	HL,IOBUFF+LEN+1
 991:30395+7	FB94  77      		LD	(HL),A
 992:30402+7	FB95  1600    		LD	D,0		;SET FOR TRUE DATA
 993:30409+10	FB97  C386F6  		JP	XMITBUF		;SEND 1 BYTE BLOCK TO ATARI
 994:				;	ret
 995:				;
 996:				;
 997:				;
 998:				;
 999:				;	... Z80 MEMORY READ COMMAND PROCESSOR ...
1000:				;
1001:     -	FB9A          	Z80READ:
1002:30419+17	FB9A  CD84FB  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND
1003:30436+17	FB9D  CDD7FB  		CALL	ZLENGTH		;GET ZCMD BYTECOUNT INTO BC
1004:30453+10	FBA0  2100C3  		LD	HL,IOBUFF+LEN
1005:30463+4	FBA3  B7      		OR	A
1006:30467+15	FBA4  ED42    		SBC	HL,BC
1007:30482+11	FBA6  E5      		PUSH	HL
1008:30493+4	FBA7  EB      		EX	DE,HL
1009:30497+16	FBA8  2AEDFB  		LD	HL,(MEMPTR)
1010:30513+4	FBAB  F3      		DI
1011:30517+16+5	FBAC  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
1012:30533+4	FBAE  FB      		EI
1013:30537+10	FBAF  E1      		POP	HL
1014:30547+10	FBB0  114300  		LD	DE,'C'		;SEND DATA W/O INVERSION
1015:30557+10	FBB3  C36EF6  		JP	SENDBUFF
1016:				;	ret
1017:				;
1018:				;
1019:				;
1020:				;	... Z80 MEMORY WRITE COMMAND PROCESSOR ...
1021:				;
1022:     -	FBB6          	Z80WRITE:
1023:30567+17	FBB6  CD84FB  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
1024:30584+17	FBB9  CDBBF6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
1025:30601+5+6	FBBC  C0      		RET	NZ
1026:				
1027:30606+17	FBBD  CDD7FB  		CALL	ZLENGTH		;GET BYTECOUNT FROM CMD FRAME
1028:30623+4	FBC0  B7      		OR	A
1029:30627+15	FBC1  ED42    		SBC	HL,BC
1030:30642+5+6	FBC3  C0      		RET	NZ		;ERROR IF DATA FRAME LENGTH NOT SAME
1031:				
1032:30647+11	FBC4  C5      		PUSH	BC
1033:30658+17	FBC5  CD84FB  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
1034:30675+10	FBC8  C1      		POP	BC
1035:30685+10	FBC9  2100C1  		LD	HL,IOBUFF
1036:30695+20	FBCC  ED5BEDFB		LD	DE,(MEMPTR)
1037:30715+4	FBD0  F3      		DI
1038:30719+16+5	FBD1  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
1039:30735+4	FBD3  FB      		EI
1040:30739+10	FBD4  C38FFB  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
1041:				;	ret
1042:				;
1043:				;
1044:				;
1045:     -	FBD7          	ZLENGTH:
1046:30749+13	FBD7  3AFDC2  		LD	A,(CFRAME+2)	;GET BYTECOUNT FROM COMMAND FRAME
1047:30762+4	FBDA  4F      		LD	C,A
1048:30766+7	FBDB  0600    		LD	B,0		;LOAD BC WITH BYTECOUNT
1049:30773+4	FBDD  B7      		OR	A
1050:30777+5+6	FBDE  C0      		RET	NZ		;EXIT IF BYTECOUNT NOT=0
1051:				
1052:30782+4	FBDF  04      		INC	B		;ELSE MAKE BC=256
1053:30786+10	FBE0  C9      		RET
1054:				;
1055:				;
1056:				;	... Z80 SET MEMORY POINTER COMMAND PROCESSOR ...
1057:				;
1058:     -	FBE1          	Z80SET:
1059:30796+17	FBE1  CD84FB  		CALL	SENDACK
1060:30813+16	FBE4  2AFDC2  		LD	HL,(CFRAME+2)	;SET MEMORY POINTER FROM COMMAND
1061:30829+16	FBE7  22EDFB  		LD	(MEMPTR),HL
1062:30845+10	FBEA  C38FFB  		JP	SENDCOMP
1063:				;	ret
1064:				;
1065:				;
1066:     -	FBED  0000    	MEMPTR:	DEFW	0		;POINTER FOR MEMORY READ/WRITE
1067:				;
1068:				;
1069:				;	... Z80 GOTO MEMORY LOCATION COMMAND PROCESSOR ...
1070:				;
1071:     -	FBEF          	Z80GOTO:
1072:30855+17	FBEF  CD84FB  		CALL	SENDACK
1073:30872+17	FBF2  CD8FFB  		CALL	SENDCOMP
1074:30889+16	FBF5  2AFDC2  		LD	HL,(CFRAME+2)
1075:30905+4	FBF8  E9      		jp	(hl)		;execute routine @hl
1076:				;
1077:				;
1078:				;
1079:				;
**** ..\src\sally2rs.asm ****
  57:						INCLUDE	FORMAT.MAC
**** ..\src\FORMAT.MAC ****
   1:					;PAGE
   2:				;****************************************************************
   3:				;*								*
   4:				;*								*
   5:				;****************************************************************
   6:				;
   7:				;	... DISKETTE INITIALIZATION ROUTINE ...
   8:				;
   9:				;	'IOBUFF' UTILIZATION IN FORMAT FUNCTION:
  10:				;
  11:				;	|---------------|  IOBUFF
  12:				;	|		|
  13:				;	| BAD SEC NUMS	|	STARTS @ LEN-(128+1) OR LEN-(256+1)
  14:				;	|		|
  15:				;	|---------------|  +LEN
  16:				;	|		|
  17:				;	|  WRTTRK CODE  |	VARIABLE LENGTH HALT/NMI/OUTI ROUTINE
  18:				;	|		|
  19:				;	|---------------|  +N
  20:				;	|		|
  21:				;	|  TRACK IMAGE  |	POINTED TO BY 'TRKPTR'
  22:				;	|		|
  23:				;	|		|  +10200
  24:				;
  25:				;
  26:				;
  27:     -	FBF9          	FORMAT:
  28:30909+4	FBF9  AF      		XOR	A
  29:30913+11	FBFA  D356    		OUT	(INDXSET),A	;SET FLIPFLOP FOR NORMAL INDEX PULSES
  30:30924+4	FBFC  3C      		INC	A
  31:30928+11	FBFD  D354    		OUT	(INDXCLR),A
  32:30939+7	FBFF  3E00    		LD	A,RSTCMD+HLOAD+STEPRATE
  33:30946+17	FC01  CD52F3  		CALL	TYP1CMD		;ISSUE SLOW RESTORE COMMAND
  34:30963+7	FC04  EE04    		XOR	00000100B	;FLIP TK0 STATUS BIT
  35:30970+7	FC06  E684    		AND	10000100B
  36:30977+10	FC08  C2D9FC  		JP	NZ,FORMX	;EXIT IF TRACK ZERO NOT INDICATED
  37:				
  38:30987+10	FC0B  2100C3  		LD	HL,IOBUFF+LEN	;PREP TO BUILD IN-LINE CODE FOR FORMAT
  39:30997+13	FC0E  3ABCFF  		LD	A,(TRKSIZ+1)
  40:31010+4	FC11  3C      		INC	A
  41:31014+4	FC12  47      		LD	B,A		;LOAD B WITH # OF PAGES/TRACK PLUS ONE
  42:31018+10	FC13  3676    	FORM2:	LD	(HL),076H	;STORE 'HALT' OPCODE
  43:31028+6	FC15  23      		INC	HL
  44:31034+10	FC16  36ED    		LD	(HL),0EDH	;STORE 'OUTI' OPCODE BYTE #1
  45:31044+6	FC18  23      		INC	HL
  46:31050+10	FC19  36A3    		LD	(HL),0A3H	;STORE 'OUTI' OPCODE BYTE #2
  47:31060+6	FC1B  23      		INC	HL
  48:31066+10	FC1C  3620    		LD	(HL),020H	;STORE 'JRNZ' OPCODE BYTE
  49:31076+6	FC1E  23      		INC	HL
  50:31082+10	FC1F  36FB    		LD	(HL),-5		;STORE JUMP OFFSET FOR LOOP
  51:31092+6	FC21  23      		INC	HL
  52:31098+8+5	FC22  10EF    		DJNZ	FORM2
  53:31106+7	FC24  3EC9    		LD	A,0C9H
  54:31113+7	FC26  77      		LD	(HL),A		;STORE 'RET' OPCODE AT END
  55:31120+13	FC27  326600  		LD	(0066H),A	;ALSO PLUNK ONE DOWN AT NMI VECTOR
  56:31133+6	FC2A  23      		INC	HL
  57:31139+16	FC2B  22C3FF  		LD	(TRKPTR),HL	;SAVE ADDRESS TO BEGIN TRACK IMAGE
  58:				
  59:31155+4	FC2E  AF      		XOR	A
  60:31159+13	FC2F  322DFF  	FORM3:	LD	(TRACK),A	;A HOLDS NEXT TRACK NUMBER
  61:31172+4	FC32  B7      		OR	A
  62:31176+7+5	FC33  2805    		JR	Z,FORM3A	;SKIP STEP-IN IF ON TRACK ZERO
  63:31183+7	FC35  3E40    		LD	A,STEPIN+HLOAD+STEPRATE
  64:31190+17	FC37  CD52F3  		CALL	TYP1CMD		;STEP TO NEXT TRACK
  65:31207+20	FC3A  DD2AB6FF	FORM3A:	LD	IX,(FRMPTR)	;GET SELECTED FORMAT DATA POINTER
  66:31227+20	FC3E  FD2AB8FF		LD	IY,(SKWPTR)	;GET SELECTED SKEW TABLE POINTER
  67:31247+13	FC42  3ABDFF  		ld	a,(sides)
  68:31260+4	FC45  1F      		rra
  69:31264+13	FC46  3A2FFF  		ld	a,(outcpy)
  70:31277+7+5	FC49  3007    		jr	nc,form3b	;jump if not formatting both sides
  71:31284+7	FC4B  EE20    		xor	00100000b
  72:31291+13	FC4D  322FFF  		ld	(outcpy),a	;else flip side select bit in latch
  73:31304+11	FC50  D330    		out	(latch),a
  74:31315+17	FC52  CDE3FC  	form3b:	call	build
  75:31332+13	FC55  3A2DFF  		LD	A,(TRACK)
  76:31345+11	FC58  D341    		OUT	(TRKREG),A
  77:31356+16	FC5A  2AC3FF  		LD	HL,(TRKPTR)	;POINT TO START OF TRACK IMAGE
  78:31372+4	FC5D  F3      		DI
  79:31376+7	FC5E  3EF4    		LD	A,WRTKDLY	;write track + 30ms settle delay
  80:31383+17	FC60  CD6DF3  		CALL	CMDOUT		;ISSUE WRITE TRACK COMMAND
  81:31400+13	FC63  3ABBFF  		LD	A,(TRKSIZ)
  82:31413+4	FC66  47      		LD	B,A		;LOAD B WITH TRACK SIZE MOD 256
  83:31417+7	FC67  0E43    		LD	C,DATREG
  84:31424+17	FC69  CD00C3  		CALL	IOBUFF+LEN	;EXECUTE WRITE TRACK FROM BUFFER
  85:31441+4	FC6C  FB      		EI
  86:31445+11	FC6D  DB40    	FORM4:	IN	A,(STSREG)
  87:31456+8	FC6F  CB47    		BIT	0,A
  88:31464+7+5	FC71  20FA    		JR	NZ,FORM4
  89:					
  90:     -	0001          		IF	SALLYRS = 1
  91:31471+8	FC73  CB77    		bit	6, a		;mask out write protect
  92:31479+7+5	FC75  2062    		jr	NZ, FORMX
  93:					ENDIF
  94:					
  95:31486+20	FC77  ED5BBFFF		LD	DE,(SEQNUM)	;LOAD DE WITH SEQUENCE NUMBER
  96:31506+16	FC7B  2AC1FF  		LD	HL,(SEQPTR)	; AND HL WITH CACA TABLE POINTER
  97:31522+13	FC7E  3ABAFF  		LD	A,(NSECTS)
  98:31535+4	FC81  47      		LD	B,A
  99:31539+20	FC82  DD2AB8FF		LD	IX,(SKWPTR)	;POINT TO SECTOR TABLE
 100:31559+19	FC86  DD7E00  	FORM5:	LD	A,(IX)
 101:31578+10	FC89  DD23    		INC	IX
 102:31588+11	FC8B  D342    		OUT	(SECREG),A
 103:31599+13	FC8D  3A2FFF  		LD	A,(OUTCPY)
 104:31612+7	FC90  E620    		AND	00100000b
 105:31619+7	FC92  3E80    		LD	A,RDCMD		;determine if reading side 0 or 1
 106:31626+7+5	FC94  2802    		JR	Z,FORM51
 107:31633+8	FC96  CBCF    		SET	1,A		;WD1772 no side-no in cmd (I leave it there, doesn't seem to matter)
 108:31641+17	FC98  CD49F3  	FORM51:	CALL	TYP2CMD		;read sector discarding the data
 109:31658+7	FC9B  E698    		AND	10011000B	;TEST FOR READY/RNF/CRC ERROR INDICATION
 110:31665+7+5	FC9D  2814    		JR	Z,FORM6		;JUMP IF SECTOR READ OK
 111:				
 112:31672+7	FC9F  E680    		AND	10000000B
 113:31679+7+5	FCA1  2036    		JR	NZ,FORMX	;QUIT TRYING IF NOT-READY ERROR
 114:31686+11	FCA3  E5      		PUSH	HL
 115:31697+11	FCA4  C5      		PUSH	BC
 116:31708+10	FCA5  01FDC2  		LD	BC,IOBUFF+LEN-3
 117:31718+4	FCA8  B7      		OR	A
 118:31722+15	FCA9  ED42    		SBC	HL,BC		;TEST IF CA-CA SECTOR LIST IS FULL
 119:31737+10	FCAB  C1      		POP	BC
 120:31747+10	FCAC  E1      		POP	HL
 121:31757+7+5	FCAD  3004    		JR	NC,FORM6	;SKIP IF NO MORE ROOM
 122:31764+7	FCAF  73      		LD	(HL),E
 123:31771+6	FCB0  23      		INC	HL
 124:31777+7	FCB1  72      		LD	(HL),D
 125:31784+6	FCB2  23      		INC	HL		;STORE BAD SECTOR NUMBER
 126:31790+6	FCB3  13      	FORM6:	INC	DE
 127:31796+8+5	FCB4  10D0    		DJNZ	FORM5
 128:31804+20	FCB6  ED53BFFF		LD	(SEQNUM),DE	;STORE UPDATED ERROR TRACE STUFF
 129:31824+16	FCBA  22C1FF  		LD	(SEQPTR),HL
 130:31840+13	FCBD  3A2FFF  		ld	a,(outcpy)
 131:31853+7	FCC0  E620    		and	00100000b
 132:31860+10	FCC2  C23AFC  		jp	nz,form3a	;go back and do side 0 if on side 1 now
 133:31870+13	FCC5  3A2DFF  		LD	A,(TRACK)
 134:31883+4	FCC8  3C      		INC	A
 135:31887+10	FCC9  21BEFF  		ld	hl,tracks
 136:31897+7	FCCC  BE      		CP	(HL)
 137:31904+10	FCCD  DA2FFC  		JP	C,FORM3		;FORMAT UP TO LAST TRACK ON DISK
 138:				
 139:31914+16	FCD0  2AC1FF  		LD	HL,(SEQPTR)
 140:31930+10	FCD3  36FF    		LD	(HL),255	;STORE TERMINATOR ON CA-CA BUFFER
 141:31940+6	FCD5  23      		INC	HL
 142:31946+10	FCD6  36FF    		LD	(HL),255
 143:31956+4	FCD8  AF      		XOR	A		;INDICATE FORMAT COMPLETED
 144:31960+11	FCD9  F5      	FORMX:	PUSH	AF
 145:31971+7	FCDA  3EFF    		LD	A,255
 146:31978+13	FCDC  322DFF  		LD	(TRACK),A
 147:31991+11	FCDF  D341    		OUT	(TRKREG),A	;FORCE DISK HANDLER TO RECALIBRATE
 148:32002+10	FCE1  F1      		POP	AF
 149:32012+10	FCE2  C9      		RET			;RETURN COMPLETION STATUS IN A
 150:				;
 151:				;
 152:				;
 153:				;
 154:				;	... SUBROUTINE TO BUILD IMAGE OF FORMATTED TRACK ...
 155:				;
 156:				;	PARAMETERS ARE:  IX ....... (POINTER TO FORMAT PARAMETERS)
 157:				;			 IY ....... (TABLE OF SECTOR NUMBERS)
 158:				;			 TRKPTR ... (POINTER TO TRACK DATA BUFFER)
 159:				;			 TRACK .... (TRACK NUMBER)
 160:				;			 NSECTS ... (NUMBER OF SECTORS)
 161:				;			 sides .... (copy of 'nsides' param)
 162:				;
 163:     -	FCE3          	BUILD:
 164:32022+13	FCE3  3ABAFF  		LD	A,(NSECTS)
 165:32035+4	FCE6  4F      		LD	C,A
 166:32039+15	FCE7  DDE5    		PUSH	IX
 167:32054+10	FCE9  E1      		POP	HL
 168:32064+7	FCEA  46      		LD	B,(HL)		;LOAD B WITH # OF FIELDS IN PREAMBLE
 169:32071+6	FCEB  23      		INC	HL
 170:32077+20	FCEC  ED5BC3FF		LD	DE,(TRKPTR)
 171:32097+17	FCF0  CD4AFD  	BUILD1:	CALL	INSERT		;INSERT FIELDS OF PREAMBLE
 172:32114+8+5	FCF3  10FB    		DJNZ	BUILD1
 173:				
 174:32122+7	FCF5  46      		LD	B,(HL)		;LOAD B WITH NUMBER OF ITEMS IN SECTOR
 175:32129+6	FCF6  23      		INC	HL
 176:32135+11	FCF7  E5      		PUSH	HL
 177:32146+14	FCF8  DDE1    		POP	IX		;IX POINTS TO START OF SECTOR POOP
 178:32160+13	FCFA  3A2DFF  	BUILD3:	LD	A,(TRACK)
 179:32173+19	FCFD  DD7707  		LD	(IX+7),A	;STORE TRACK# FOR TRACK BEING FORMATTED
 180:32192+13	FD00  3A2FFF  		ld	a,(outcpy)
 181:32205+7	FD03  E620    		and	00100000b
 182:32212+7	FD05  3E00    		ld	a,0
 183:32219+7+5	FD07  2801    		jr	z,bild31	;jump if formatting side 0
 184:32226+4	FD09  3C      		inc	a
 185:32230+19	FD0A  DD7709  	bild31:	ld	(ix+9),a	;store side# in id
 186:32249+19	FD0D  FD7E00  		LD	A,(IY)
 187:32268+10	FD10  FD23    		INC	IY
 188:32278+19	FD12  DD770B  		LD	(IX+11),A	;STORE SECTOR# INTO FORMAT CONSTANTS
 189:				
 190:32297+15	FD15  DDE5    		PUSH	IX
 191:32312+10	FD17  E1      		POP	HL		;POINT HL TO SECTOR POOP
 192:32322+11	FD18  C5      		PUSH	BC
 193:32333+17	FD19  CD4AFD  	BUILD4:	CALL	INSERT
 194:32350+8+5	FD1C  10FB    		DJNZ	BUILD4		;INSERT ITEMS UP TO SECTOR DATA FIELD
 195:				
 196:32358+19	FD1E  DD7E0D  		LD	A,(IX+13)
 197:32377+17	FD21  CDC5FA  		call	getsize		;compute sector size in bytes
 198:32394+7	FD24  3EFF    	build6:	ld	a,0ffh
 199:32401+7	FD26  12      		ld	(de),a		;fill sector data with ff's
 200:32408+6	FD27  13      		INC	DE
 201:32414+6	FD28  0B      		DEC	BC		;REPEAT TILL SECTOR IMAGE IS FILLED
 202:32420+4	FD29  78      		LD	A,B
 203:32424+4	FD2A  B1      		OR	C
 204:32428+7+5	FD2B  20F7    		JR	NZ,BUILD6
 205:				
 206:32435+7	FD2D  46      		LD	B,(HL)		;GET #FIELDS IN POST-SECTOR STUFF
 207:32442+6	FD2E  23      		INC	HL
 208:32448+17	FD2F  CD4AFD  	BUILD7:	CALL	INSERT		;INSERT FIELDS UP TO GAP 3
 209:32465+8+5	FD32  10FB    		DJNZ	BUILD7
 210:32473+10	FD34  C1      		POP	BC
 211:				
 212:32483+4	FD35  0D      		DEC	C
 213:32487+7+5	FD36  20C2    		JR	NZ,BUILD3
 214:				
 215:32494+16	FD38  2AC3FF  		LD	HL,(TRKPTR)
 216:32510+10	FD3B  01D827  		LD	BC,10200
 217:32520+11	FD3E  09      		ADD	HL,BC		;COMPUTE END OF LONGEST TRACK IMAGE
 218:32531+15	FD3F  ED52    		SBC	HL,DE		;COMPUTE BYTES NECESSARY TO GET THERE
 219:32546+4	FD41  44      		LD	B,H
 220:32550+4	FD42  4D      		LD	C,L
 221:32554+4	FD43  62      		LD	H,D
 222:32558+4	FD44  6B      		LD	L,E
 223:32562+6	FD45  13      		INC	DE
 224:32568+7	FD46  77      		LD	(HL),A
 225:32575+16+5	FD47  EDB0    		LDIR			;FILL REST OF BUFFER
 226:32591+10	FD49  C9      		RET
 227:				;
 228:				;
 229:				;
 230:32601+11	FD4A  C5      	INSERT:	PUSH	BC
 231:32612+7	FD4B  46      		LD	B,(HL)
 232:32619+6	FD4C  23      		INC	HL
 233:32625+7	FD4D  7E      		LD	A,(HL)
 234:32632+6	FD4E  23      		INC	HL
 235:32638+7	FD4F  12      	INS2:	LD	(DE),A
 236:32645+6	FD50  13      		INC	DE
 237:32651+8+5	FD51  10FC    		DJNZ	INS2
 238:32659+10	FD53  C1      		POP	BC
 239:32669+10	FD54  C9      		RET
 240:				;
 241:				;
 242:				;
 243:				;
 244:				;	... DISK FORMAT DATA TABLES FOR 5/8 DD/SD STANDARDS ...
 245:				;
 246:				;
 247:     -	FD55  01      	SD5N18:	DEFB	1
 248:     -	FD56  10FF    		DEFB	16,0FFH
 249:				
 250:     -	FD58  0B      		DEFB	11
 251:     -	FD59  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS TO MAKE
 252:     -	FD5B  0300    		DEFB	3,00H		; ID FIELD COME OUT IN RIGHT LOCATION)
 253:     -	FD5D  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 254:     -	FD5F  0100    		DEFB	1,00H		;TRACK
 255:     -	FD61  0100    		DEFB	1,00H		;SIDE
 256:     -	FD63  0100    		DEFB	1,00H		;SECTOR
 257:     -	FD65  0100    		DEFB	1,00H		;LENGTH
 258:     -	FD67  01F7    		DEFB	1,0F7H		;GENERATE CRC
 259:     -	FD69  0BFF    		DEFB	11,0FFH		;GAP2
 260:     -	FD6B  0600    		DEFB	6,00H		;GAP2
 261:     -	FD6D  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 262:				
 263:     -	FD6F  02      		DEFB	2
 264:     -	FD70  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 265:     -	FD72  09FF    		DEFB	9,0FFH		;GAP 3
 266:				;
 267:				;
 268:				;
 269:				;
 270:				;
 271:     -	FD74  01      	DD5N18:	DEFB	1
 272:     -	FD75  204E    		DEFB	32,4EH		;GAP 1
 273:				
 274:     -	FD77  0C      		DEFB	12
 275:     -	FD78  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 276:     -	FD7A  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 277:     -	FD7C  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 278:     -	FD7E  0100    		DEFB	1,0		;TRACK#
 279:     -	FD80  0100    		DEFB	1,00000000B	;SIDE
 280:     -	FD82  0100    		DEFB	1,0		;SECTOR#
 281:     -	FD84  0101    		DEFB	1,00000001B	;LENGTH
 282:     -	FD86  01F7    		DEFB	1,0F7H		;GENERATE CRC
 283:     -	FD88  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 284:     -	FD8A  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 285:     -	FD8C  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 286:     -	FD8E  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 287:				
 288:     -	FD90  02      		DEFB	2
 289:     -	FD91  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 290:     -	FD93  104E    		DEFB	16,4EH		;FIRST PART OF GAP 3
 291:				;
 292:				;
 293:				;
 294:     -	FD95  12100E0C	SKEWSD:	DEFB	18,16,14,12,10,8,6,4,2
	              0A080604
	              02
 295:     -	FD9E  110F0D0B		DEFB	17,15,13,11,9,7,5,3,1
	              09070503
	              01
 296:				;
 297:     -	FDA7  01070D  	SKEWDD:	DEFB	1,7,13
 298:     -	FDAA  060C12  		DEFB	6,12,18
 299:     -	FDAD  050B11  		DEFB	5,11,17
 300:     -	FDB0  040A10  		DEFB	4,10,16
 301:     -	FDB3  03090F  		DEFB	3,9,15
 302:     -	FDB6  02080E  		DEFB	2,8,14
 303:				;
 304:				;
 305:				;
 306:     -	FDB9  04      	SD8N26:	DEFB	4		;PREAMBLE FIELD
 307:     -	FDBA  28FF    		DEFB	40,0FFH		;GAP 4
 308:     -	FDBC  0600    		DEFB	6,00
 309:     -	FDBE  01FC    		DEFB	1,0FCH		;INDEX ADDRESS MARK
 310:     -	FDC0  1AFF    		DEFB	26,0FFH
 311:				
 312:     -	FDC2  0B      		DEFB	11
 313:     -	FDC3  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS)
 314:     -	FDC5  0300    		DEFB	3,00H		;
 315:     -	FDC7  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 316:     -	FDC9  0100    		DEFB	1,00H		;TRACK
 317:     -	FDCB  0100    		DEFB	1,00H		;SIDE
 318:     -	FDCD  0100    		DEFB	1,00H		;SECTOR
 319:     -	FDCF  0100    		DEFB	1,00H		;LENGTH
 320:     -	FDD1  01F7    		DEFB	1,0F7H		;GENERATE CRC
 321:     -	FDD3  0BFF    		DEFB	11,0FFH		;GAP2
 322:     -	FDD5  0600    		DEFB	6,00H		;GAP2
 323:     -	FDD7  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 324:				
 325:     -	FDD9  02      		DEFB	2
 326:     -	FDDA  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 327:     -	FDDC  1BFF    		DEFB	27,0FFH		;GAP 3
 328:				;
 329:				;
 330:				;
 331:     -	FDDE  05      	DD8N26:	DEFB	5
 332:     -	FDDF  504E    		DEFB	80,4EH		;POST-INDEX GAP
 333:     -	FDE1  0C00    		DEFB	12,00H		;INDEX SYNC
 334:     -	FDE3  03F6    		DEFB	3,0F6H		;GENERATE SYNC=C1 HEX
 335:     -	FDE5  01FC    		DEFB	1,0FCH		;GENERATE INDEX ADDRESS MARK
 336:     -	FDE7  324E    		DEFB	50,4EH		;GAP 1
 337:				
 338:     -	FDE9  0C      		DEFB	12
 339:     -	FDEA  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 340:     -	FDEC  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 341:     -	FDEE  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 342:     -	FDF0  0100    		DEFB	1,0		;TRACK#
 343:     -	FDF2  0100    		DEFB	1,00000000B	;SIDE
 344:     -	FDF4  0100    		DEFB	1,0		;SECTOR#
 345:     -	FDF6  0101    		DEFB	1,00000001B	;LENGTH
 346:     -	FDF8  01F7    		DEFB	1,0F7H		;GENERATE CRC
 347:     -	FDFA  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 348:     -	FDFC  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 349:     -	FDFE  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 350:     -	FE00  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 351:				
 352:     -	FE02  02      		DEFB	2
 353:     -	FE03  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 354:     -	FE05  354E    		DEFB	53,4EH		;FIRST PART OF GAP 3
 355:				;
 356:				;
 357:				;
 358:     -	FE07  010E0310	SKEW13:	DEFB	1,14,3,16,5,18,7,20,9,22,11,24,13,26
	              05120714
	              09160B18
	              0D1A
 359:     -	FE15  020F0411		DEFB	2,15,4,17,6,19,8,21,10,23,12,25
	              06130815
	              0A170C19
 360:				;
 361:				;
 362:     -	FE21  0112091A	SKEW17:	DEFB	1,18,9,26,17,8,25,16,7,24,15,6,23
	              11081910
	              07180F06
	              17
 363:     -	FE2E  0E05160D		DEFB	14,5,22,13,4,21,12,3,20,11,2,19,10
	              04150C03
	              140B0213
	              0A
 364:				;
 365:				;
**** ..\src\sally2rs.asm ****
  58:				;
  59:				;
  60:				;
  61:     -	1C61          			.DEPHASE
  62:     -	0E3B          	MONSIZE		EQU	$-MONCOPY
  63:				;
  64:				;
  65:     -	1C61          	varcopy		equ	$
  66:     -	FF20          			.phase	0ff00h+32
  67:     -	FF00          	ram		equ	$-32		;put ram on start of 256 byte page
  68:     -	FF00          	KEYBUF		equ	ram		;16 byte keyboard input fifo
  69:     -	FF10          	CTCVEC		equ	ram+16		;8 word interrupt vector table
  70:						INCLUDE GLOBAL.MAC	;PUT GLOBAL VARIABLES AT TOP OF RAM
**** ..\src\GLOBAL.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	GLOBAL VARIABLES FOR ATARI Z80 ROM		*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:     -	FF20          	glbvars		equ	$
   8:				;
   9:				;	... GLOBAL VARIABLES FOR PHYSICAL DISK HANDLER ...
  10:				;
  11:     -	FF20  FFFFFFFF	DRVTAB:		DEFB	255,255,255,255		;HEAD POSITIONS FOR 4 DRIVES
  12:     -	FF24  00000000			DEFB	0,0,0,0			;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
  13:     -	FF28  10101010	RATES:		DEFB	16,16,16,16		;SETTLING DELAYS / STEP RATES TABLE
  14:     -	FF2C  00      	UNIT:		DEFB	0			;CURRENTLY SELECTED DISK#
  15:     -	FF2D  FF      	TRACK:		DEFB	255			;TRACK POSITION OF SELECTED DRIVE
  16:     -	FF2E  01      	DRVOFF:		DEFB	1			;DRIVES-OFF FLAG FROM DISK TIMER IRQ
  17:     -	FF2F  00      	OUTCPY:		DEFB	00000000B		;COPY OF DISK CONTROL LATCH
  18:     -	FF30  0000    	PERIOD:		DEFW	0			;DISK SPIN PERIOD
  19:     -	FF32  32      	HLDTIM:		DEFB	50			;HEAD LOAD DELAY
  20:     -	FF33  0A      	RWMAX:		DEFB	10			;MAX NUMBER OF READ/WRITE RETRIES
  21:     -	FF34  00000000			DEFB	0,0,0,0			;ROOM FOR EXPANSION
  22:				;
  23:				;
  24:				;	... GLOBAL VARIABLES FOR ATARI HANDLER ...
  25:				;
  26:     -	FF38  28F8    	IDPTR:		DEFW	IDTAB			;POINTER TO DEVICE ID TABLE
  27:     -	FF3A  C0F7    	FSMVEC:		DEFW	PWRWAIT			;POINTER FOR ATARI TASK STATE MACHINE
  28:     -	FF3C  E3F7    	EXTVEC:		DEFW	DUMMY			;POINTER FOR EXTRA TASK PROCESSOR
  29:     -	FF3E  020D0A00	NEWLIN:		DEFB	2,CR,LF,0,0		;PRINTER NEWLINE CHARACTERS
	              00
  30:     -	FF43  00003C00	PSMSG:		DEFB	0,0,60,0		;PRINTER STATUS FRAME
  31:     -	FF47  80      	PMASKS:		DEFB	10000000B		;MASK ALL BITS BUT 'BUSY'
  32:     -	FF48  00      			DEFB	00000000B			;COMPARE TO ZERO FOR READY
  33:     -	FF49  810C    	FMTPTR:		DEFW	FMTS			;POINTER TO STANDARD FORMAT TABLES
  34:     -	FF4B  00C5    	PBASE:		DEFW	IOBUFF+(2*LEN)		;PUT PRINT BUFFER AFTER HERE
  35:     -	FF4D  FF0F    	PSIZE:		DEFW	4095			;MAX BUFFER INDEX OFFSET
  36:					
  37:     -	002F          	glbsize		equ	$-glbvars		;length of initialized variables
  38:     -	FF4F  73      			DEFB    73h			; **** Exists in original ROM? ****
  39:				;
  40:				;
  41:				;	*** UNINITIALIZED SCRATCH VARIABLES COME AFTER HERE ***
  42:				;
  43:     -	FF4F          	PCOUNT:		EQU 	$-1			;BYTECOUNT FOR BUFFER
  44:     -	FF51          	PINP:		EQU 	PCOUNT+2		;INPUT OFFSET
  45:     -	FF53          	POUT:		EQU 	PINP+2			;OUTPUT OFFSET
  46:     -	FF55          	CMDFLG:		EQU 	POUT+2			;COMMAND FRAME READY FLAG FROM IRQ
  47:     -	FF56          	DMATRIX:	EQU 	CMDFLG+1    		;DRIVE POOP TABLES
  48:     -	FF96          	OLDPTR:		EQU 	DMATRIX+64		;POINTER TO FIRST DRIVE ACCESSED
  49:     -	FF98          	DKIOCB:		EQU 	OLDPTR+2		;DISK I/O COMMAND BLOCK
  50:     -	FFA8          	DRWCMD:		EQU 	DKIOCB+16		;R/W COMMAND FROM ATARI TO 'DISKIO'
  51:     -	FFA9          	LOGSIZ:		EQU 	DRWCMD+1		;LOGICAL SECTOR LENGTH FOR XFER
  52:     -	FFAB          	IDBUF:		EQU	LOGSIZ+2		;BUFFER FOR ID MARK READS
  53:     -	FFB3          	IOPTR:		EQU 	IDBUF+8			;ATARI BLOCK INPUT POINTER
  54:     -	FFB5          	VFLAG:		EQU 	IOPTR+2			;VERIFY FLAG FOR DISK WRITES
  55:				
  56:				;
  57:				;
  58:				;	... VARIABLES FOR DISK FORMAT FUNCTION ...
  59:				;
  60:     -	FFB6          	FMTSTUFF:	EQU	VFLAG+1
  61:     -	FFB6          	FRMPTR:		EQU	VFLAG+1			;POINTER TO FORMAT DATA TABLE
  62:     -	FFB8          	SKWPTR:		EQU	FRMPTR+2		;POINTER TO SKEW TABLE
  63:     -	FFBA          	NSECTS:		EQU	SKWPTR+2		;NUMBER OF SECTORS
  64:     -	FFBB          	TRKSIZ:		EQU	NSECTS+1		;TRACK LENGTH IN BYTES
  65:     -	0007          	FMTLEN		EQU	(TRKSIZ+2)-FMTSTUFF
  66:						
  67:     -	FFBD          	sides:		EQU	TRKSIZ+2		;copy of 'nsides' for drive#
  68:     -	FFBE          	tracks:		EQU	sides+1			;copy of 'ntrks' for drive#
  69:     -	FFBF          	SEQNUM:		EQU	tracks+1		;TEMP SECTOR SEQUENCE NUMBER
  70:     -	FFC1          	SEQPTR:		EQU	SEQNUM+2		;TEMP ERROR LOG TABLE POINTER
  71:     -	FFC3          	TRKPTR:		EQU	SEQPTR+2		;POINTER TO START OF TRACK IMAGE
  72:				
  73:				;
  74:				;	... LOCAL VARIABLES FOR DISK HANDLER ...
  75:				;
  76:     -	FFC5          	CMDBYT:		EQU	TRKPTR+2		;COMMAND BYTE FOR READS/WRITES
  77:     -	FFC6          	RWTRY:		EQU	CMDBYT+1		;READ/WRITE RETRY COUNT
  78:     -	FFC7          	TICKS:		EQU	RWTRY+1			;FREE RUNNING MILISECOND COUNTER
  79:     -	FFC9          	DRVTMR:		EQU	TICKS+2			;DISK ACTIVITY TIMER
  80:				;
  81:				;
  82:				;
  83:				;
  84:     -	C100          	IOBUFF		EQU	0C100H			;ATARI I/O BUFFER
  85:     -	0200          	LEN		EQU	512
  86:				;
  87:     -	C300          	TRKBUF		EQU	IOBUFF+LEN		;TRACK BUFFER FOR READS
  88:				;
**** ..\src\sally2rs.asm ****
  71:				;
  72:     -	1C91          			.DEPHASE
  73:				;
  74:				
  75:     -	0001          	IF SALLYBUILD
  76:				;
  77:				;--------------------------------------------------
  78:				; set to zero in startup code until 0ffffh
  79:				;--------------------------------------------------
  80:				
  81:				ELSE
  92:				ENDIF	;SALLYBUILD
  93:     -	1C91          	END



Statistics:

     5	passes
     0	jr promotions
   683	symbols
  7057	bytes



Symbol Table:

ACTIVE         =04        4
ACTIVON         F03C      61500
ACTIVTY         F050      61520
ACTV2           F064      61540
ASCHEX          F485      62597
ATARI          =70        112
ATROUT         =50        80
BADCMD         =00        0
BADDAT         =01        1
BADRW          =02        2
BANKSW         =52        82
BOOT            F461      62561
BOOTCB          F47C      62588
BUILD1          FCF0      64752
BUILD3          FCFA      64762
BUILD4          FD19      64793
BUILD7          FD2F      64815
CALLHL          F7BF      63423
CDMUX          =57        87
CENT2           F4E7      62695
CENTOUT         F4DE      62686
CENTRDY         F4ED      62701
CFRAME         =C2FB      49915
CINIT2          F617      62999
CINIT3          F61C      63004
CINIT4          F61E      63006
CIV             F009      61449
CMDBYT         =FFC5      65477
CMDFLG         =FF55      65365
CMDL4           F7F5      63477
CMDL4a          F80D      63501
CMDL5           F810      63504
CMDOUT          F36D      62317
CMDREG         =40        64
CMDSTS         =0C        12
CMDT1           F36F      62319
CMDT2           F371      62321
CMDT3            C47      3143
CMDWAIT         F7E4      63460
CONFIG         =01        1
CONIN           F642      63042
CONINIT         F5FE      62974
CONOUT          F652      63058
CONPAGE        =F502      62722
CONST           F637      63031
COUT2           F661      63073
COV             F00C      61452
CR             =0D        13
CRLF            F4D7      62679
CSTART          F69B      63131
CSTRT1          F6B6      63158
CSV             F006      61446
CTC0           =80        128
CTC1           =81        129
CTC2           =82        130
CTC3           =83        131
CTCVEC         =FF10      65296
CTC_D0_CONTROL =01        1
CTC_D0_VECTOR  =00        0
CTC_D1_SW_RST  =02        2
CTC_D2_TCNEXT  =04        4
CTC_D3_AUTOTRG =00        0
CTC_D3_CLKTRG  =08        8
CTC_D4_FALLEDGE=00        0
CTC_D4_RISEEDGE=10        16
CTC_D5_PRESC256=20        32
CTC_D5_PRESC_16=00        0
CTC_D6_MODE_CNT=40        64
CTC_D6_MODE_TIM=00        0
CTC_D7_INT_DIS =00        0
CTC_D7_INT_EN  =80        128
DATB2           F73B      63291
DATBIT          F72E      63278
DATREG         =43        67
DD5N18          FD74      64884
DD5N26           CA4      3236
DD8N26          FDDE      64990
DDHD           =00        0
DENSTY         =02        2
DISK            F0A3      61603
DISK2           F0BA      61626
DISK3           F0BF      61631
DISK4           F0DE      61662
DISK4a          F0F0      61680
DISK5           F0FF      61695
DISKDVR         F022      61474
DISKMAX        =09        9
DISKPUT         F8F5      63733
DISKREAD        F97C      63868
DISKSTAT        FAD3      64211
DISKTAB          C64      3172
DISKV           F00F      61455
DISKWRITE       F8F8      63736
DISKX           F100      61696
DKIOCB         =FF98      65432
DMATRIX        =FF56      65366
DRD2            F998      63896
DRD2A           F99C      63900
DRD3            F9AA      63914
DRD4            F9CB      63947
DRVINDEX         77A      1914
DRVOFF          FF2E      65326
DRVSEL1        =01        1
DRVSEL2        =02        2
DRVSEL3        =04        4
DRVSEL4        =08        8
DRVTAB          FF20      65312
DRVTMR         =FFC9      65481
DRWCMD         =FFA8      65448
DSKAUX         =06        6
DSKBITS        =08        8
DSKDRV         =01        1
DSKOP          =00        0
DSKPTR         =04        4
DSKSEC         =03        3
DSKSTS         =08        8
DSKTRK         =02        2
DSTAT1          FAFC      64252
DSTAT2          FAFE      64254
DSTAT3          FB08      64264
DSTAT4          FB0A      64266
DSTAT5          FB14      64276
DSTAT6          FB16      64278
DTR            =55        85
DUMMMYSYMBOL    01        1 (command line -D)
DUMMY           F7E3      63459
DWRT0           F8FA      63738
DWRT1           F917      63767
DWRT2           F929      63785
DWRT3           F965      63845
DWRT4           F96D      63853
DWRT5           F974      63860
ECHO            F4B4      62644
EDGE            F1CC      61900
EDGE2           F1DC      61916
EMULATOR        F764      63332
ENDBIT          F757      63319
EXTVEC          FF3C      65340
FBS            =40        64
FDCRESET       =10        16
FDCSIDE        =20        32
FDENSITY       =80        128
FINCMD         =D0        208
FIRST          =00        0
FLAGS          =0E        14
FMTLEN         =07        7
FMTPTR          FF49      65353
FMTS             C81      3201
FMTSTUFF       =FFB6      65462
FORCE           F375      62325
FORM2           FC13      64531
FORM3           FC2F      64559
FORM3A          FC3A      64570
FORM4           FC6D      64621
FORM5           FC86      64646
FORM51          FC98      64664
FORM6           FCB3      64691
FORMAT          FBF9      64505
FORMX           FCD9      64729
FRMPTR         =FFB6      65462
FSMVEC          FF3A      65338
GETID          =03        3
GETPARAMS        36A      874
GETPARAMS1       377      887
GETSEC         =01        1
GOTO            F460      62560
HAS850          F793      63379
HASPARMS        FB30      64304
HDWSTS         =0D        13
HLDTIM          FF32      65330
HLDWAIT         F37D      62333
HLOAD          =00        0
IDBUF          =FFAB      65451
IDMAX          =06        6
IDPTR           FF38      65336
IDTAB           F828      63528
INDEX           F8E1      63713
INDEX2          F8F3      63731
INDXCLR        =54        84
INDXSET        =56        86
INIT            00        0
INIT1           02        2
INIT2           0A        10
INITAB           C4E      3150
INS2            FD4F      64847
INSERT          FD4A      64842
IOBUFF         =C100      49408
IOPTR          =FFB3      65459
ITBLEN         =16        22
KEYBUF         =FF00      65280
KLUDGE          F178      61816
LATCH          =30        48
LEN            = 200      512
LF             =0A        10
LISTV           F012      61458
LOGON           F768      63336
LOGSIZ         =FFA9      65449
MAIN            F7AE      63406
MEDIA          =05        5
MEMPTR          FBED      64493
MINIMON         F3E0      62432
MONCOPY        = E26      3622
MONITOR        =F000      61440
MONSIZE        = E3B      3643
NEWLIN          FF3E      65342
NMIVEC         =66        102
NOHIGHSPEEDSIO =00        0
NOWAITMTR      =08        8
NSECS          =02        2
NSECTS         =FFBA      65466
NTRKS          =00        0
NULL           =00        0
OLDPTR         =FF96      65430
OUTCPY          FF2F      65327
OUTPUT          F4C0      62656
PBASE           FF4B      65355
PCOUNT         =FF4F      65359
PERCONFIG      =0F        15
PERIOD          FF30      65328
PERMAXSEC      =11        17
PERSKEWTAB     =14        20
PERSTEPRATE    =13        19
PERTRACK       =10        16
PINP           =FF51      65361
PMASKS          FF47      65351
PNEXT           F4CB      62667
PNXT1           F4CC      62668
POUT           =FF53      65363
PRESENT        =06        6
PRINTER        =20        32
PROM1           F409      62473
PROM2           F41B      62491
PROM3           F422      62498
PROMPT          F3F3      62451
PSIZE           FF4D      65357
PSMSG           FF43      65347
PTRID           F82A      63530
PTRMAX         =02        2
PTRSTAT         F852      63570
PTRTAB          F83C      63548
PTRWRITE        F868      63592
PUT2HS          F49A      62618
PUT2HX          F4A1      62625
PUT4HS          F495      62613
PUTNIB          F4AA      62634
PUTPARAMS       FB44      64324
PUTPARAMS1      FB74      64372
PUTSEC         =02        2
PWRIT3          F87E      63614
PWRIT4          F8A4      63652
PWRT3A          F888      63624
PWRWAIT         F7C0      63424
RAM            =FF00      65280
RAMTST          10        16
RATES           FF28      65320
RBUFF2          F6D2      63186
RCOV2A          F319      62233
RCOV2B          F31B      62235
RCOV4A          F340      62272
RCOV4B          F342      62274
RDCMD          =80        128
RDTKDLY        =E4        228
RDTRK          =E0        224
READID          F08F      61583
RECOV1          F302      62210
RECOV2          F306      62214
RECOV3          F329      62249
RECOVER         F2F5      62197
RECVBUFF        F6BB      63163
RENEW           F018      61464
REST            75        117
REST1           7C        124
REST2           85        133
REST3           91        145
REST3A          A2        162
REST4           C3        195
REST4A          C9        201
RESTART         F01B      61467
RESTORE         F231      62001
RETI1           F5FB      62971
RIDCMD         =C0        192
RSTCMD         =00        0
RTST1           15        21
RTST2           17        23
RTST3           21        33
RW1024          F2D3      62163
RW2             F2AC      62124
RW256           F2DC      62172
RW512           F2D9      62169
RWBUSY          F2DF      62175
RWDISK          F29C      62108
RWEXIT          F2EA      62186
RWMAX           FF33      65331
RWTRY          =FFC6      65478
RXB1            F6E3      63203
RXB2            F6EE      63214
RXB3            F6F3      63219
RXB35           F706      63238
RXB4            F710      63248
RXBAUD         =F508      62728
RXBLOCK         F6DB      63195
RXDAT2          F512      62738
RXDATA          F519      62745
RXINP          =F523      62755
RXOUT           F635      63029
RXSTART         F502      62722
RXSTOP          F52E      62766
RXTEMP         =F51E      62750
SALLYBUILD     =01        1
SALLYDEBUG     =01        1
SALLYRS        =01        1
SCAN            F817      63511
SD5N18          FD55      64853
SD8N26          FDB9      64953
SEC256         =05        5
SECLEN         =06        6
SECREG         =42        66
SECTRAN         FA08      64008
SEEK            F23E      62014
SEEK1           F1EC      61932
SEEK2           F1F9      61945
SEEKTRK         F1E0      61920
SEEKX           F216      61974
SEL4            F157      61783
SEL5            F15A      61786
SEL5A           F164      61796
SEL5B           F16E      61806
SELECT          F10A      61706
SELTAB          F188      61832
SELX            F17D      61821
SENDACK         FB84      64388
SENDACK1        FB86      64390
SENDBUFF        F66E      63086
SENDCHAR        FB91      64401
SENDCOMP        FB8F      64399
SENDNACK        FB80      64384
SEQNUM         =FFBF      65471
SEQPTR         =FFC1      65473
SERIN          =50        80
SEROUT         =51        81
SERPAGE        =F71B      63259
SETSSO          F0A3      61603
SETSTAT         F9D3      63955
SETTLE         =04        4
SHUTDOWN        F068      61544
SIDECMP        =02        2
SIDESEL        =08        8
SIOFAST        =08        8
SIONORMAL      =28        40
SIZE           =01        1
SKCMD          =10        16
SKEW13          FE07      65031
SKEW17          FE21      65057
SKEWDD          FDA7      64935
SKEWMD           CC7      3271
SKEWSD          FD95      64917
SKWPTR         =FFB8      65464
SPARE0         =09        9
SPARE1         =0A        10
SPARE2         =0B        11
SPARE3         =0F        15
SPIN            F18C      61836
SPIN2           F19D      61853
SPIN3           F1C7      61895
SPIN4           F1C3      61891
SPIN5           F1B3      61875
SPIN6           F1B9      61881
SPINWAIT       =00        0
SPOOLER         F8C1      63681
SSTS1           F9E4      63972
SSTS2           F9EE      63982
SSTS3           F9F4      63988
STARBIT         F71B      63259
STARTMR         F39E      62366
STEP            F25C      62044
STEP1           F26F      62063
STEPIN         =40        64
STEPOUT        =60        96
STEPRATE       =00        0
STEPRATE0      =00        0
STEPRATE1      =01        1
STEPRATE2      =02        2
STEPRATE3      =03        3
STEPRT         =01        1
STOP1A          F750      63312
STOPB1          F73D      63293
STOPTMR         F3AF      62383
STR20           FA38      64056
STR25           FA70      64112
STR26           FA75      64117
STRAN1          FA1A      64026
STRAN2          FA1F      64031
STRAN3          FA92      64146
STRAN4          FA9D      64157
STRAN5          FAB7      64183
STROBE         =53        83
STSREG         =40        64
SVERSION         E07      3591
SalyCMDOUT       C40      3136
SalyDISK3       F0C5      61637
SalyDISKID      F832      63538
SalyDISKRD1     F983      63875
SalyDISKRD2     F986      63878
SalyDISKRD3     F9C4      63940
SalyDISKWRT1    F908      63752
SalyDISKWRT2    F90B      63755
SalyDISKWRT3    F938      63800
SalyLOGN1       F780      63360
SalyLOGN2       F783      63363
SalyLogon        127      295
SalyRXBLOCK     F6DE      63198
SalyResetFDC    F21F      61983
SalySEL4         14A      330
SalySEL4A        17F      383
SalySEL4B        18C      396
SalySEL4ex       19E      414
SalyShutdn       13E      318
SalyXMITBUF     F68A      63114
TDRV2           F07C      61564
TESTDRV         F070      61552
TICKS          =FFC7      65479
TMRIRQ          F3B6      62390
TPCMD2          F359      62297
TPCMD3          F369      62313
TRACK           FF2D      65325
TRKBUF         =C300      49920
TRKBUFFER      =1000      4096
TRKPTR         =FFC3      65475
TRKREG         =41        65
TRKSIZ         =FFBB      65467
TSTRDY         =00        0
TXDAT0          F556      62806
TXDAT1          F568      62824
TXDAT2          F57A      62842
TXDAT3          F58C      62860
TXDAT4          F59E      62878
TXDAT5          F5B0      62896
TXDAT6          F5C2      62914
TXDAT7          F5D4      62932
TXEXIT          F5F0      62960
TXSTART         F549      62793
TXSTOP          F5E2      62946
TXTMP0         =F558      62808
TXTMP1         =F56A      62826
TXTMP2         =F57C      62844
TXTMP3         =F58E      62862
TXTMP4         =F5A0      62880
TXTMP5         =F5B2      62898
TXTMP6         =F5C4      62916
TXTMP7         =F5D6      62934
TYP1CMD         F352      62290
TYP2CMD         F349      62281
UNIT            FF2C      65324
VARCOPY        =1C61      7265
VERIFY          F27C      62076
VFLAG          =FFB5      65461
VIEW            F432      62514
VIEW4           F458      62552
VIEW5           F45A      62554
WAIT            F382      62338
WAIT2           F383      62339
WATCHDOG        F38C      62348
WD1772         =01        1
WD179X         =40        64
WRPCOMP        =02        2
WRPROT         =03        3
WRTCMD         =A0        160
WRTKDLY        =F4        244
WRTRK          =F0        240
XMITBUF         F686      63110
Z80GOTO         FBEF      64495
Z80MAX         =04        4
Z80READ         FB9A      64410
Z80SET          FBE1      64481
Z80TAB          F844      63556
Z80WRITE        FBB6      64438
ZEROS           45        69
ZLENGTH         FBD7      64471
adjustsiobuf     5E9      1513
adjustsiobuf1    5F5      1525
adjustsiobuf2    5FD      1533
bild31          FD0A      64778
build           FCE3      64739
build6          FD24      64804
checkmaxsec      768      1896
checktrack       34A      842
cleardrivedata  B7        183
cmdwaitfn        8D4      2260
cmdwaitfn1       8D4      2260
code0000        6C        108
code8000        5A        90
compbufadr       32D      813
compbufadr1      348      840
compbufadr2      344      836
compdskbuf       5CD      1485
compseclen       6E8      1768
computeflags     594      1428
computeflags1    5B9      1465
computeflags3    5C6      1478
computeflags4    5C8      1480
computesecbuf    467      1127
dbgRWBUSY        9BE      2494
dcb              CF1      3313
debugtrk         AEA      2794
direct           CE3      3299
diskanalyse      612      1554
diskanalyse1     67F      1663
diskanalyse10    712      1810
diskanalyse2     644      1604
diskanalyse3     650      1616
diskanalyse4     66E      1646
diskanalyse5     716      1814
diskanalyse6     6D0      1744
diskanalyse7     722      1826
diskanalyse8     6BC      1724
diskanalyse9     72C      1836
diskformat       4E7      1255
diskformat1      54E      1358
diskformat2      52A      1322
diskformat5      52E      1326
diskformat6      571      1393
diskiodebug      9A8      2472
diskiodebug1     9CA      2506
diskop           84C      2124
diskop1          857      2135
diskreadfn       3EA      1002
diskreadfn2      3EE      1006
diskreadfn3      426      1062
diskstatus       38D      909
diskstatus1      3A8      936
diskstatus2      3B0      944
diskstatus3      3B8      952
diskstatus4      3DA      986
diskstatus5      3C7      967
diskwritefn      48B      1163
diskwritefn1     4A5      1189
diskwritefn2     48F      1167
diskwritefn4     4E0      1248
diskwritefn5     4C3      1219
dloop            9E1      2529
dloop1           9EC      2540
drive            CE5      3301
drivedata        D07      3335
dsector          CE1      3297
dskrd1           1A4      420
dskrd2           1B6      438
dskreadfn        289      649
dskwrite         271      625
dskwrite1        286      646
dumpiocb         B43      2883
dumpline         A0E      2574
dumpline1        A18      2584
dumpline2        A35      2613
dumpline3        A3F      2623
dumpline4        A41      2625
dumpline5        A25      2597
dumppercom       A56      2646
dumppercom1      AE2      2786
dumppercom2      AD8      2776
dumppercom3      AB1      2737
dumpsec          A04      2564
dumpsec1         A07      2567
dumpsecinv       9FF      2559
dwrt             20F      527
dwrta            21E      542
dwrtb            247      583
dwrtc            234      564
dwrtd            23A      570
error            9F8      2552
error1           9FD      2557
fastrecv         964      2404
fastrecv1        977      2423
fastrecv2        986      2438
fastsend         929      2345
fastsend1        935      2357
form3b          FC52      64594
getdrivelatch    7AC      1964
getdrivelatch1   7B3      1971
getfdcstatus     821      2081
getperiod        7C1      1985
getperiod1       7C4      1988
getperiod2       7D4      2004
getperiod3       7DB      2011
getperiod4       7E5      2021
getsize         FAC5      64197
getskewtab       483      1155
getspeed         357      855
getsz2          FACB      64203
glbsize        =2F        47
glbvars        =FF20      65312
idambuf          CFA      3322
idcrc            CFE      3326
idseclen         CFD      3325
idsector         CFC      3324
idside           CFB      3323
idtrack          CFA      3322
irq4ms           95F      2399
irq4ms1          961      2401
isspinning       7B7      1975
match            308      776
match1           31F      799
match2           322      802
nsides         =04        4
ok               9F6      2550
pokeydiv         CE4      3300
read1024         87D      2173
read256          886      2182
read512          883      2179
readidam         83E      2110
readskew         73C      1852
readskew1        747      1863
readskew3        767      1895
readskew4        760      1888
readskew5        764      1892
readskew6        753      1875
readtrack        2DE      734
readtrack1       2DB      731
readtrack2       2CB      715
readtrack3       2B1      689
readtrack4       2FA      762
readtrack5       306      774
readtrack6       304      772
readtrk          432      1074
readtrk1         43F      1087
readtrk2         445      1093
readtrk3         44E      1102
restoretrack     80D      2061
rxblck           948      2376
rxblck1          959      2393
sec2track        1DA      474
sec2track1       1E3      483
sec2trk          898      2200
sec2trk1         8A9      2217
sec2trk2         8A1      2209
sec2trk3         8C1      2241
secptr           CE7      3303
seektrack        7F2      2034
seektrack1       801      2049
seraddr          BD7      3031
sercmd           B97      2967
sercr            BCF      3023
serdump          BAE      2990
serdump1         BB4      2996
serdump2         BAF      2991
serdumpcpl       99F      2463
serhex           BEA      3050
serhexspace      BE5      3045
serin1           C2D      3117
serin2           C24      3108
serinfn          C23      3107
sernib           BF9      3065
sernib1          C03      3075
serout1          C10      3088
seroutfn         C03      3075
serouthl         BA6      2982
serspace         BC7      3015
setsioerror      7EB      2027
sides          =FFBD      65469
siobuffer        D05      3333
siocmd           D01      3329
siorc            D04      3332
siosector        D02      3330
siounit          D00      3328
skewtab          CE9      3305
slyCMDT1         C42      3138
slyCMDT2         C44      3140
ssts4           F9FE      63998
statbytes        3E6      998
str27           FA7D      64125
thetrack         CE6      3302
time19600        C3A      3130
time19600a       C3C      3132
togglebaud       8EC      2284
togglebaud1      8F7      2295
tracks         =FFBE      65470
trkmatch         41E      1054
trkmatch1        474      1140
tryidam          8CC      2252
waitstatus       829      2089
waitstatus1      82C      2092
xmitbuffn        8FD      2301
xmitfast         90B      2315
xmitfast1        913      2323
