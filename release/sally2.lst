   1:				;
   2:     -	0001          			SALLYBUILD	EQU	1
   3:     -	0001          			WD1772		EQU	1
   4:				
   5:					ASEG
   6:     -	0000          		ORG	0
   7:				;
   8:				;
   9:				;
  10:						INCLUDE EQUS.MAC
**** ..\src\EQUS.MAC ****
   1:				;--------------------------------------------------
   2:				; Equates for Sally2 Hi-Speed-SIO code
   3:				;--------------------------------------------------
   4:     -	0000          	NOHIGHSPEEDSIO	EQU	0
   5:				;
   6:				;--------------------------------------------------
   7:				; Track-Buffer 26*256 bytes
   8:				;--------------------------------------------------
   9:     -	0800          	TRKBUFFER	EQU	00800h
  10:				
  11:     -	0028          	SIONORMAL	EQU	40
  12:     -	0008          	SIOFAST		EQU	8
  13:				;--------------------------------------------------
  14:				;
  15:				;--------------------------------------------------
  16:				;
  17:				;
  18:				;
  19:     -	0020          	PRINTER	EQU	20H		;PRINTER OUTPUT/INPUTS
  20:     -	0030          	LATCH	EQU	30H		;DRIVE CONTROL LATCH
  21:     -	0040          	WD179X	EQU	40H		;WD TYPE DISK CONTROLLER
  22:				;
  23:     -	0050          	SERIN	EQU	50H		;RS232 SERIAL INPUT
  24:				;
  25:     -	0050          	ATROUT	EQU	50H		;ATARI SERIAL OUTPUT
  26:     -	0051          	SEROUT	EQU	51H		;RS232 SERIAL OUTPUT
  27:     -	0052          	BANKSW	EQU	52H		;ROM BANKSWITCH BIT
  28:     -	0053          	STROBE	EQU	53H		;PRINTER STROBE
  29:     -	0054          	INDXCLR	EQU	54H		;INDEX CONTROL FLOP CLEAR
  30:     -	0055          	DTR		EQU	55H		;DTR OUTPUT CONTROL
  31:     -	0056          	INDXSET	EQU	56H		;INDEX CONTROL FLOP SET
  32:     -	0057          	CDMUX	EQU	57H		;ATARI CMD/DATA MUX CONTROL
  33:				;
  34:     -	0070          	ATARI	EQU	70H		;ATARI INPUT BITS PORT
  35:     -	0080          	CTC0	EQU	80H		;ZILOG COUNTER/TIMER 0
  36:     -	0081          	CTC1	EQU	81H		;ZILOG COUNTER/TIMER 1
  37:     -	0082          	CTC2	EQU	82H		;ZILOG COUNTER/TIMER 2
  38:     -	0083          	CTC3	EQU	83H		;ZILOG COUNTER/TIMER 3
  39:				;
  40:     -	0000          	CTC_D0_VECTOR:		EQU	00000000B	;Data is a Vector
  41:     -	0001          	CTC_D0_CONTROL:		EQU	00000001B	;Data is a Control Word
  42:     -	0002          	CTC_D1_SW_RST:		EQU	00000010B	;Perform a software reset
  43:     -	0004          	CTC_D2_TCNEXT:		EQU	00000100B	;Time Constant follows
  44:     -	0000          	CTC_D3_AUTOTRG:		EQU	00000000B	;Automatic trigger when Time Constant loaded
  45:     -	0008          	CTC_D3_CLKTRG:		EQU	00001000B	;CLK/TRIG pin pulse starts timer
  46:     -	0000          	CTC_D4_FALLEDGE:	EQU	00000000B	;CLK/TRIG edge selection - falling edge
  47:     -	0010          	CTC_D4_RISEEDGE:	EQU	00010000B	;CLK/TRIG edge selection - rising edge
  48:     -	0000          	CTC_D5_PRESC_16:	EQU	00000000B	;Timer prescaler value of 16
  49:     -	0020          	CTC_D5_PRESC256:	EQU	00100000B	;Timer prescaler value of 256
  50:     -	0000          	CTC_D6_MODE_TIM:	EQU	00000000B	;Selects Timer mode
  51:     -	0040          	CTC_D6_MODE_CNT:	EQU	01000000B	;Selects Counter mode
  52:     -	0000          	CTC_D7_INT_DIS:		EQU	00000000B	;Disables Interrupt
  53:     -	0080          	CTC_D7_INT_EN:		EQU	10000000B	;Enables Interrupt
  54:				;
  55:     -	0000          	NULL	EQU	00H
  56:     -	000D          	CR	EQU	0DH
  57:     -	000A          	LF	EQU	0AH
  58:				;
**** ..\src\sally2.asm ****
  11:				;--------------------------------------------------
  12:				; Code executed after Reset
  13:				;--------------------------------------------------
  14:						INCLUDE SYSINIT.MAC
**** ..\src\SYSINIT.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*							*
   4:				;********************************************************
   5:				;
   6:				;
   7:				;
   8:    0+4	0000  F3      	INIT:		DI
   9:    4+4	0001  AF      			XOR	A
  10:    8+4	0002  3D      	INIT1:		DEC	A
  11:   12+7+5	0003  20FD    			JR	NZ,INIT1				;DO NOTHING FOR 1 MILLISECOND
  12:				
  13:   19+10	0005  21E005  			LD	HL,INITAB
  14:   29+7	0008  060B    			LD	B,ITBLEN/2				;SEND INITIAL POOP TO PROGRAMABLE I/O'S
  15:   36+7	000A  4E      	INIT2:		LD	C,(HL)
  16:   43+6	000B  23      			INC	HL
  17:   49+16	000C  EDA3    			OUTI
  18:   65+7+5	000E  20FA    			JR	NZ,INIT2
  19:				;
  20:				;	PERFORM READ/WRITE TEST OF TOP 4K RAM
  21:				;
  22:   72+10	0010  2100F0  	RAMTST:		LD	HL,MONITOR
  23:   82+7	0013  3E01    			LD	A,1
  24:   89+7	0015  0610    	RTST1:		LD	B,16
  25:   96+7	0017  77      	RTST2:		LD	(HL),A					;WRITE TEST BYTE INTO MONITOR/GLOBALS
  26:  103+4	0018  07      			RLCA						;ROTATE BIT PATTERN IN A
  27:  107+4	0019  2C      			INC	L					;BUMP L TO DO INNER LOOP 256 TIMES
  28:  111+7+5	001A  20FB    			JR	NZ,RTST2
  29:  118+4	001C  24      			INC	H
  30:  122+8+5	001D  10F8    			DJNZ	RTST2					;REPEAT 16 TIMES FOR 4096 BYTES
  31:				
  32:  130+7	001F  0E10    			LD	C,16
  33:  137+6	0021  2B      	RTST3:		DEC	HL
  34:  143+4	0022  0F      			RRCA
  35:  147+7	0023  BE      			CP	(HL)					;VERIFY THAT TEST PATTERN IS WRITTEN
  36:  154+7+5	0024  20FE    			JR	NZ,$					;STICK FOREVER IF MONITOR RAM FAILURE
  37:  161+8+5	0026  10F9    			DJNZ	RTST3
  38:  169+4	0028  0D      			DEC	C
  39:  173+7+5	0029  20F6    			JR	NZ,RTST3
  40:				
  41:  180+4	002B  87      			ADD	A,A
  42:  184+7+5	002C  20E7    			JR	NZ,RTST1				;DO 8 PASSES OVER MEMORY
  43:				;
  44:				;	NOW COPY MONITOR AND VARIABLES TO HIGH RAM
  45:				;
  46:  191+10	002E  213606  			LD	HL,MONCOPY
  47:  201+10	0031  1100F0  			LD	DE,MONITOR
  48:  211+10	0034  01FC0E  			LD	BC,MONSIZE
  49:  221+16+5	0037  EDB0    			LDIR						;COPY RESIDENT CODE INTO RAM
  50:				
  51:  237+10	0039  213215  			LD	HL,VARCOPY
  52:  247+10	003C  1120FF  			LD	DE,glbvars
  53:  257+10	003F  012F00  			LD	BC,glbsize
  54:  267+16+5	0042  EDB0    			LDIR						;INITIALIZE GLOBAL VARIABLES
  55:  283+4	0044  AF      			XOR	A
  56:  287+7	0045  12      	ZEROS:		LD	(DE),A
  57:  294+4	0046  1C      			INC	E
  58:  298+7+5	0047  20FC    			JR	NZ,ZEROS				;FILL REST OF SCRATCHPAD WITH ZEROS
  59:				;
  60:				;	ESTABLISH STACK AND INTERRUPT VECTOR BASE
  61:				;
  62:  305+10	0049  3110FF  			LD	SP,KEYBUF+16				;TEMP PLACE FOR STACK
  63:  315+7	004C  3EFF    			LD	A,HIGH RAM			
  64:  322+9	004E  ED47    			LD	I,A					;POINT I REGISTER TO VECTOR TABLE
  65:  331+8	0050  ED5E    			IM	2					;SELECT VECTORED INTERRUPTS
  66:				;			
  67:				;step 5 times in and then out to trk00.  
  68:				;set bit 6 for each online floppy in ff5eh percom block (16 bytes, byte 8 bit 6)
  69:				;
  70:  339+7	0052  3E4F    	REST:		LD	A, FBS+DRVSEL4+DRVSEL3+DRVSEL2+DRVSEL1	;INITIAL DRIVE PATTERN (ALL SELECTED) - select drive 1-4, Motor off, side 0, B/S=1, DD
  71:  346+11	0054  D330    			OUT	(LATCH), A
  72:  357+4	0056  57      			LD	D,A					;KEEP PATTERN IN D (d = 4fh)
  73:  361+7	0057  0605    			LD	B,5					;step 5 times
  74:  368+7	0059  3E49    	REST1:		LD	A,STEPIN+NOWAITMTR+STEPRATE		;4b: 4 = step-in, b = NOWAITMTR+STEPRATE3
  75:				
  76:     -	0001          	IF WD1772
  77:  375+17	005B  CDD205  			CALL	SalyCMDOUT				;write A to FDC command and wait
  78:				ELSE			
  80:				ENDIF	;WD1772			
  81:							
  82:  392+8+5	005E  10F9    			DJNZ	REST1					; DRIVES THAT GET BEHIND TK0 SENSOR
  83:  400+7	0060  0664    			LD	B,100					;DO 100 STEPS TOWARD TRACK ZERO (support 100 track drives)
  84:  407+4	0062  7A      	REST2:		LD	A,D			
  85:  411+11	0063  D330    			OUT	(LATCH),A				;ISSUE SELECTS AND PAUSE A BIT
  86:  422+19	0065  E3      			EX	(SP),HL
  87:  441+19	0066  E3      			EX	(SP),HL
  88:  460+7	0067  3E69    			LD	A,STEPOUT+NOWAITMTR+STEPRATE		;6b: 6 = step-out, b = NOWAITMTR+STEPRATE3
  89:				
  90:     -	0001          	IF WD1772
  91:  467+17	0069  CDD205  			CALL	SalyCMDOUT				;write A to FDC command and wait
  92:				ELSE			
  94:				ENDIF	;WD1772			
  95:							
  96:  484+7	006C  1E01    			LD	E,DRVSEL1				;PREPARE TO TEST TK0 INDICATORS
  97:  491+4	006E  7B      	REST3:		LD	A,E			
  98:  495+7	006F  F640    			OR	FBS			
  99:  502+11	0071  D330    			OUT	(LATCH),A				;SELECT ONE DRIVE AT A TIME
 100:  513+19	0073  E3      			EX	(SP),HL					;Use this benign operation pair
 101:  532+19	0074  E3      			EX	(SP),HL					;to wait 38 T-states
 102:				
 103:     -	0001          	IF WD1772
 104:  551+11	0075  DB40    			IN	A, (STSREG)
 105:				ELSE
 107:				ENDIF	;WD1772			
 108:							
 109:  562+8	0077  CB57    			BIT	2, A			
 110:  570+7+5	0079  2804    			JR	Z,REST3A				;JUMP IF TRACK ZERO NOT INDICATED
 111:  577+4	007B  7B      			LD	A,E			
 112:  581+4	007C  2F      			CPL			
 113:  585+4	007D  A2      			AND	D					;ELSE RESET SELECT BIT FOR DRIVE IN D
 114:  589+4	007E  57      			LD	D,A			
 115:  593+8	007F  CB23    	REST3A:		SLA	E					;ADVANCE SELECT BIT
 116:  601+8	0081  CB63    			BIT	4,E			
 117:  609+7+5	0083  28E9    			JR	Z,REST3					;DO SAME FOR ALL 4 DRIVES
 118:  616+8+5	0085  10DB    			DJNZ	REST2					;THEN REPEAT STEP OUT 100 TIMES
 119:							
 120:     -	0001          	IF WD1772			
 121:  624+7	0087  3E50    			LD	A, FDCRESET+FBS				;reset FDC and deselct
 122:  631+11	0089  D330    			OUT	(LATCH), A			
 123:  642+7	008B  3E40    			LD	A, FBS					;reset FDC and deselct
 124:  649+11	008D  D330    			OUT	(LATCH), A			
 125:				ELSE			
 127:				ENDIF	;WD1772
 128:				
 129:  660+10	008F  215EFF  			LD	HL,DMATRIX+DSKBITS
 130:  670+10	0092  011000  			LD	BC,16
 131:  680+7	0095  3E04    			LD	A,4					;PREP TO SET FLAGS FOR DRIVES PRESENT
 132:  687+8	0097  CB1A    	REST4:		RR	D			
 133:  695+7+5	0099  3802    			JR	C,REST4A				;JUMP IF DRIVE(N) NOT AT TRACK ZERO
 134:  702+15	009B  CBF6    			SET	PRESENT,(HL)				;ELSE SET BIT IN ARRAY(HL)
 135:  717+11	009D  09      	REST4A:		ADD	HL,BC			
 136:  728+4	009E  3D      			DEC	 A			
 137:  732+7+5	009F  20F6    			JR	NZ,REST4				;DO FOR ALL 4 DRIVES
 138:				;			
 139:     -	0001          	IF SALLYBUILD			
 140:  739+10	00A1  210000  			LD	HL, 00000h				; source
 141:  749+10	00A4  110080  			LD	DE, 08000h				; dest
 142:  759+10	00A7  010020  			LD	BC, 02000h
 143:  769+16+5	00AA  EDB0    			LDIR
 144:  785+10	00AC  21B200  			LD	HL, code8000
 145:  795+8	00AF  CBFC    			SET	7, H
 146:  803+4	00B1  E9      			JP	(HL)
 147:     -	00B2          	code8000:
 148:  807+7	00B2  3E01    			LD	A, 1
 149:  814+11	00B4  D352    			OUT	(BANKSW), A
 150:  825+10	00B6  210080  			LD	HL, 08000h
 151:  835+10	00B9  110000  			LD	DE, 00000h
 152:  845+10	00BC  010020  			LD	BC, 02000h
 153:  855+16+5	00BF  EDB0    			LDIR
 154:  871+10	00C1  C3C400  			JP	code0000
 155:     -	00C4          	code0000:
 156:				ENDIF	;SALLYBUILD
 157:				
 158:  881+10	00C4  3100C1  			LD	SP, IOBUFF				;NEW PLACE FOR STACK
 159:				
 160:     -	0001          	IF SALLYBUILD
 161:				;--------------------------------------------------
 162:				; firmware patch
 163:				;--------------------------------------------------
 164:  891+10	00C7  21FFFF  			LD	HL, 0ffffh				;reset drive / track buffer
 165:  901+16	00CA  221B06  			LD	(drive), HL
 166:				
 167:  917+10	00CD  213FF8  			LD	HL, DISKTAB+2
 168:  927+10	00D0  11F905  			LD	DE, dsktb+3
 169:  937+10	00D3  011500  			LD	BC, 3*7
 170:  947+16+5	00D6  EDB0    			LDIR
 171:				
 172:  963+10	00D8  210800  			LD	HL, 8
 173:  973+16	00DB  22F605  			LD	(dsktb),HL
 174:  989+7	00DE  3E3F    			LD	A, '?'
 175:  996+13	00E0  32F805  			LD	(dsktb+2), A
 176: 1009+4	00E3  EB      			EX	DE, HL
 177:				
 178: 1013+7	00E4  3E2A    			LD	A, getspeed & 255
 179: 1020+7	00E6  77      			LD	(HL), A
 180: 1027+6	00E7  23      			INC	HL
 181: 1033+7	00E8  3E04    			LD	A, getspeed / 256
 182: 1040+7	00EA  77      			LD	(HL), A
 183: 1047+6	00EB  23      			INC	HL
 184:				
 185: 1053+10	00EC  21F605  			LD	HL, dsktb
 186: 1063+16	00EF  222BF8  			LD	(SalyDISKID), HL
 187: 1079+16	00F2  222DF8  			LD	(SalyDISKID+2), HL
 188: 1095+16	00F5  222FF8  			LD	(SalyDISKID+4), HL
 189: 1111+16	00F8  2231F8  			LD	(SalyDISKID+6), HL
 190:				
 191: 1127+7	00FB  3E28    			LD	A, SIONORMAL
 192: 1134+13	00FD  321906  			LD	(pokeydiv), A
 193: 1147+4	0100  AF      			XOR	A
 194: 1151+13	0101  321A06  			LD	(hispeed), A
 195: 1164+7	0104  3E02    			LD	A, 2
 196: 1171+13	0106  321806  			LD	(direct), A
 197: 1184+7	0109  3EC3    			LD	A, 0c3h					;'JP' instruction
 198: 1191+13	010B  3284F6  			LD	(XMITBUF), A
 199: 1204+13	010E  32D9F6  			LD	(RXBLOCK), A
 200: 1217+13	0111  32E2F7  			LD	(CMDWAIT), A
 201: 1230+13	0114  327EF7  			LD	(SalyLOGN1), A
 202: 1243+13	0117  3218F9  			LD	(SalyDISKWRT1), A
 203: 1256+13	011A  3293F9  			LD	(SalyDISKRD1), A
 204:				;		LD	(DISK4),A
 205:				
 206: 1269+10	011D  215904  			LD	HL, xmitbuffn
 207: 1279+16	0120  2285F6  			LD	(XMITBUF+1), HL
 208: 1295+10	0123  21A404  			LD	HL, rxblck
 209: 1305+16	0126  22DAF6  			LD	(RXBLOCK+1), HL
 210: 1321+10	0129  214004  			LD	HL, cmdwaitfn
 211: 1331+16	012C  22E3F7  			LD	(CMDWAIT+1), HL
 212: 1347+10	012F  213A03  			LD	HL, dskreadfn
 213: 1357+16	0132  22D5F9  			LD	(SalyDISKRD3+1), HL
 214: 1373+10	0135  21B002  			LD	HL, dskwrite
 215: 1383+16	0138  2249F9  			LD	(SalyDISKWRT3+1), HL
 216: 1399+10	013B  215001  			LD	HL, SalyLogon
 217: 1409+16	013E  227FF7  			LD	(SalyLOGN1+1), HL
 218: 1425+10	0141  214E02  			LD	HL, dwrt
 219: 1435+16	0144  2219F9  			LD	(SalyDISKWRT1+1), HL
 220: 1451+10	0147  21C101  			LD	HL, dskrd1
 221: 1461+16	014A  2294F9  			LD	(SalyDISKRD1+1), HL
 222:				;		LD	HL, diskiodebug
 223:				;		LD	(DISK4+1),HL
 224:				
 225:				;loop:		CALL	serinfn
 226:				;		
 227:				;		LD	A, 041h + 000h + 000h
 228:				;		OUT	(LATCH), A
 229:				;
 230:				;		XOR	A
 231:				;		OUT	(TRKREG), A
 232:				;		LD	A, 01
 233:				;		OUT	(SECREG), A
 234:				;		LD	A, RDCMD
 235:				;		out	(CMDREG), A
 236:				;
 237:				;loop1:		IN	A,(STSREG)
 238:				;		BIT	0,A
 239:				;		JR	NZ,loop1				;LOOP TILL 1797 BUSY BIT GOES AWAY
 240:				;		
 241:				;		CALL	serhex
 242:				;		CALL	sercr		
 243:				;;		CALL	serinfn
 244:				;		
 245:				;		LD	A, 040h
 246:				;		OUT	(LATCH), A
 247:				;		
 248:				;		JP	loop
 249:						
 250:				;--------------------------------------------------
 251:				; test code
 252:				;--------------------------------------------------
 253:				;		LD	A, 0c3h					;'JP' instruction
 254:				;		LD	(SEL4), A
 255:				;		LD	HL, SalySEL4
 256:				;		LD	(SEL4+1), HL
 257:				;
 258:				;		LD	A, 255
 259:				;		LD	(CTCVEC+2), A
 260:				;
 261:				;		LD	B, 3
 262:				;		LD	A, ' '
 263:				;stars:		CALL	seroutfn
 264:				;		DJNZ	stars
 265:				;
 266:				;		LD	IX, testdcb
 267:				;		CALL	sercr
 268:				;		CALL	DISKV
 269:				;		CALL	dumpdcb
 270:				;
 271:				;		LD	A, GETID
 272:				;		LD	(testdcb), A
 273:				;		CALL	DISKV
 274:				;		CALL	dumpdcb
 275:				;		CALL	dumprid
 276:				;
 277:				;		LD	HL, 512
 278:				;		LD	(testdcb+DSKAUX), HL
 279:				;		LD	A, GETSEC
 280:				;		LD	(testdcb), A
 281:				;
 282:				;		LD	A, '*'
 283:				;		CALL	seroutfn
 284:				;
 285:				;		LD	C, 1
 286:				;secloop1:	LD	B, 18
 287:				;		LD	HL, sectab
 288:				;secloop:	LD	A, (HL)
 289:				;		LD	(testdcb + DSKSEC), A
 290:				;		INC	HL
 291:				;		PUSH	BC
 292:				;		PUSH	HL
 293:				;		CALL	DISKV
 294:				;		POP	HL
 295:				;		POP	BC
 296:				;		DJNZ	secloop
 297:				;		DEC	C
 298:				;		JR	NZ, secloop1
 299:				;
 300:				;		LD	A, '-'
 301:				;		CALL	seroutfn
 302:				;
 303:				;loop:		JR	loop
 304:				;
 305:				;
 306:				
 307:				;
 308:				;dumprid:
 309:				;		LD	HL, (testdcb + DSKPTR)
 310:				;		CALL	sercr
 311:				;		LD	B, 6
 312:				;dumprid1:	LD	A, (HL)
 313:				;		INC	HL
 314:				;		CALL	serhex
 315:				;		CALL	serspace
 316:				;		DJNZ	dumprid1
 317:				;		RET
 318:				;
 319:				;dummy:		XOR	A
 320:				;		CALL	serhex
 321:				;		RET
 322:				;
 323:				;testdcb:	DB	TSTRDY					;DISK OPERATION CODE
 324:				;		DB	1					;DRIVE# (WITH SIDE# IN BIT 7)
 325:				;		DB	0					;TRACK#
 326:				;		DB	1					;SECTOR#
 327:				;		DW	08000h					;READ/WRITE POINTER
 328:				;		DW	0					;AUXILLIARY PARAMETERS (2 BYTES)
 329:				;		DB	0					;OPERATION COMPLETION STATUS
 330:				;
 331:				;sectab:
 332:				;		DB	1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18
 333:				;		DB	1, 3, 5, 7, 9, 11, 13, 15, 17, 2, 4, 6, 8, 10, 12, 14, 16, 18
 334:				;		DB	1, 4, 7, 10, 13, 16, 2, 5, 8, 11, 14, 17, 3, 6, 9, 12, 15, 18
 335:				;		DB	1, 5, 9, 13, 17, 3, 7, 11, 15, 2, 6, 10, 14, 18, 4, 8, 12, 16
 336:				;--------------------------------------------------
 337:				; end of test code
 338:				;--------------------------------------------------
 339:				ENDIF	;SALLYBUILD
 340:				
 341: 1477+10	014D  C362F7  			JP	EMULATOR				;GO INITIALIZE FOR ATARI OR CP/M
 342:				
 343:     -	0001          	IF SALLYBUILD
 344:     -	0150          	SalyLogon:
 345: 1487+13	0150  3233FF  			LD	(RWMAX),A				;DO LESS RETRIES IN ATARI MODE
 346:				
 347: 1500+7	0153  3EC3    			LD	A, 0c3h					;'JP' instruction
 348: 1507+13	0155  3257F1  			LD	(SEL4), A
 349: 1520+10	0158  217301  			LD	HL, SalySEL4
 350: 1530+16	015B  2258F1  			LD	(SEL4+1), HL
 351:     -	0001          		IF WD1772
 352: 1546+10	015E  216701  			LD	HL, SalyShutdn
 353: 1556+16	0161  2269F0  			LD	(SHUTDOWN+1), HL
 354:					ENDIF
 355: 1572+10	0164  C381F7  			JP	SalyLOGN2
 356:				
 357:     -	0001          		IF WD1772
 358:					
 359:     -	0167          	SalyShutdn:
 360: 1582+17	0167  CD28F2  			CALL	SalyResetFDC
 361: 1599+7	016A  3E07    			LD	A, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 362: 1606+11	016C  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
 363: 1617+7	016E  3E01    			LD	A, 1					;TIME CONSTANT OF 1 - 4uS pulses (1/4Mhz)*16
 364: 1624+11	0170  D381    			OUT	(CTC1), A
 365: 1635+10	0172  C9      			RET
 366:					ENDIF
 367:				;
 368:				;
 369:				;
 370:     -	0173          	SalySEL4:
 371: 1645+8	0173  CB70    			BIT	6, B					;8" found?
 372: 1653+7+5	0175  2844    			JR	Z, SalySEL4ex				;yes, do nothing
 373:				
 374: 1660+11	0177  C5      			PUSH	BC					;save registers
 375: 1671+11	0178  D5      			PUSH	DE
 376: 1682+11	0179  E5      			PUSH	HL
 377: 1693+15	017A  DDE5    			PUSH	IX
 378:				
 379: 1708+4	017C  78      			LD	A, B					;switch HD on
 380: 1712+8	017D  CBB7    			RES	6, A
 381: 1720+11	017F  D330    			OUT	(LATCH), A
 382:				
 383: 1731+15	0181  DDE5    			PUSH	IX					;load HL with IX
 384: 1746+10	0183  E1      			POP	HL
 385: 1756+10	0184  112706  			LD	DE, dcb
 386: 1766+10	0187  010900  			LD	BC, 9
 387: 1776+16+5	018A  EDB0    			LDIR						;copy dcb
 388:							
 389: 1792+14	018C  DD212706			LD	IX, dcb
 390: 1806+10	0190  213006  			LD	HL, id
 391: 1816+16	0193  222B06  			LD	(dcb + DSKPTR), HL
 392: 1832+7	0196  3EC0    			LD	A, RIDCMD
 393: 1839+13	0198  32C5FF  			LD	(CMDBYT), A
 394: 1852+7	019B  3E18    			LD	A, 018h					;substitute JR	Z,xx by JR xx
 395: 1859+13	019D  32F0F0  			LD	(DISK3 + 031h), A
 396: 1872+7	01A0  0606    			LD	B, 6
 397:     -	01A2          	SalySEL4A:
 398: 1879+11	01A2  C5      			PUSH	BC
 399: 1890+17	01A3  CDC5F0  			CALL	SalyDISK3				;DISK3: READ 6 BYTE ID RECORD
 400: 1907+10	01A6  C1      			POP	BC
 401: 1917+8+5	01A7  10F9    			DJNZ	SalySEL4A
 402:				
 403: 1925+7	01A9  3E28    			LD	A, 028h					;reset JR Z,xx
 404: 1932+13	01AB  32F0F0  			LD	(DISK3 + 031h), A
 405:							
 406: 1945+14	01AE  DDE1    			POP	IX
 407: 1959+10	01B0  E1      			POP	HL
 408: 1969+10	01B1  D1      			POP	DE
 409: 1979+10	01B2  C1      			POP	BC
 410: 1989+13	01B3  3A2F06  			LD	A, (dcb + DSKSTS)			;check disk status
 411: 2002+4	01B6  B7      			OR	A
 412: 2006+7+5	01B7  2002    			JR	NZ, SalySEL4ex				;not zero, no HD
 413: 2013+8	01B9  CBB0    			RES	6, B					;
 414:     -	01BB          	SalySEL4ex:             
 415: 2021+4	01BB  78      			LD	A, B
 416: 2025+7	01BC  1600    			LD	D, 0
 417: 2032+10	01BE  C35AF1  			JP	SEL5
 418:				
 419:				;--------------------------------------------------
 420:				; hook for read directSector if aux1/2 = 0
 421:				;--------------------------------------------------
 422:     -	01C1          	dskrd1:
 423: 2042+7	01C1  3E02    			LD	A, 2
 424: 2049+13	01C3  321806  			LD	(direct), A				;clear direct
 425:				
 426: 2062+16	01C6  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2, test if zero
 427: 2078+4	01C9  7D      			LD	A, L
 428: 2082+4	01CA  B4      			OR	H
 429: 2086+7+5	01CB  2806    			JR	Z, dskrd2				;if zero, use direct sector number
 430: 2093+17	01CD  CD10FA  			CALL	SECTRAN					;else use original code, call SECTRAN
 431: 2110+10	01D0  C396F9  			JP	SalyDISKRD2				;and procees
 432:				
 433:     -	01D3          	dskrd2:
 434: 2120+14	01D3  DD2198FF			LD	IX, DKIOCB
 435: 2134+19	01D7  DD360000			LD	(IX + DSKOP), TSTRDY
 436:				;		CALL	dumpdcb
 437: 2153+11	01DB  E5      			PUSH	HL
 438: 2164+17	01DC  CD0FF0  			CALL	DISKV
 439: 2181+10	01DF  E1      			POP	HL
 440:				
 441: 2191+17	01E0  CDF701  			CALL	sec2track				;compute sector, track, side from direct sector
 442: 2208+19	01E3  DD360001			LD	(IX + DSKOP), GETSEC
 443:				;		CALL	dumpdcb
 444: 2227+11	01E7  E5      			PUSH	HL
 445: 2238+17	01E8  CD3A03  			CALL	dskreadfn				;CALL DISK I/O HANDLER
 446: 2255+10	01EB  E1      			POP	HL
 447:				
 448: 2265+13	01EC  3AA0FF  			LD	A, (DKIOCB+DSKSTS)
 449: 2278+17	01EF  CDE3F9  			CALL	SETSTAT					;call SETSTAT
 450: 2295+7	01F2  1600    			LD	D, 0					;no invert
 451: 2302+10	01F4  C36CF6  			JP	SENDBUFF				;jump SENDBUFF
 452:				
 453:				;--------------------------------------------------
 454:				;compute sector, track, side from direct sector
 455:				;--------------------------------------------------
 456:     -	01F7          	sec2track:
 457: 2312+4	01F7  AF      			XOR	A					;clear carry and a
 458: 2316+7	01F8  06FF    			LD	B, 0ffh					;also b
 459: 2323+16	01FA  2A1606  			LD	HL, (dsector)				;compute track and side numer
 460: 2339+10	01FD  111200  			LD	DE, 18					;18 secs per track
 461:     -	0200          	sec2track1:             
 462: 2349+4	0200  04      			INC	B					;b holds track-number
 463: 2353+15	0201  ED52    			sbc	HL, DE
 464: 2368+7+5	0203  30FB    			JR	NC, sec2track1				;subtract 18 as long carry clear
 465: 2375+4	0205  7D      			LD	A, L
 466: 2379+7	0206  C613    			ADD	19					;add 19 to get sector number + 1
 467: 2386+13	0208  329BFF  			LD	(DKIOCB+DSKSEC), A
 468: 2399+8	020B  CB38    			SRL	B					;divide track by two, (we have two sides)
 469: 2407+4	020D  78      			LD	A, B
 470: 2411+13	020E  329AFF  			LD	(DKIOCB+DSKTRK), A
 471: 2424+4	0211  1F      			RRA						;shift-in side-number from previously lowest-bit
 472: 2428+7	0212  E680    			AND	080h					;mask out bit 0-6
 473: 2435+10	0214  2199FF  			LD	HL, DKIOCB+DSKDRV
 474: 2445+15	0217  CBBE    			RES	7, (HL)
 475: 2460+7	0219  B6      			OR	(HL)
 476: 2467+7	021A  77      			LD	(HL), A
 477:							
 478: 2474+17	021B  CD7C05  			CALL	serhex
 479: 2491+17	021E  CD6205  			CALL	serspace
 480: 2508+7	0221  3E53    			LD	A, 'S'
 481: 2515+17	0223  CD9505  			CALL	seroutfn
 482: 2532+13	0226  3A9BFF  			LD	A, (DKIOCB+DSKSEC)
 483: 2545+17	0229  CD7C05  			CALL	serhex
 484: 2562+17	022C  CD6205  			CALL	serspace
 485: 2579+7	022F  3E54    			LD	A, 'T'
 486: 2586+17	0231  CD9505  			CALL	seroutfn
 487: 2603+13	0234  3A9AFF  			LD	A, (DKIOCB+DSKTRK)
 488: 2616+17	0237  CD7C05  			CALL	serhex
 489: 2633+17	023A  CD6A05  			CALL	sercr
 490:							
 491: 2650+10	023D  210002  			LD	HL, 512
 492: 2660+16	0240  229EFF  			LD	(DKIOCB+DSKAUX), HL
 493: 2676+10	0243  2100C1  			LD	HL, IOBUFF
 494: 2686+16	0246  229CFF  			LD	(DKIOCB+DSKPTR), HL
 495: 2702+14	0249  DD2198FF			LD	IX, DKIOCB
 496: 2716+10	024D  C9      			RET     
 497:				
 498:				;--------------------------------------------------
 499:				; hook for setDirectSector if aux1/2 = 0
 500:				;--------------------------------------------------
 501: 2726+11	024E  E5      	dwrt:		PUSH	HL
 502: 2737+16	024F  22A9FF  			LD	(LOGSIZ),HL				;SAVE DATA BLOCK LENGTH
 503:				
 504: 2753+16	0252  2AFDC2  			LD	HL, (CFRAME + 2)			;load DAUX1/2
 505: 2769+4	0255  7D      			LD	A, L
 506: 2773+4	0256  B4      			OR	H
 507: 2777+7+5	0257  2804    			JR	Z, dwrta				;if zero, do special stuff
 508:				
 509: 2784+10	0259  E1      			POP	HL					;otherwise continue
 510: 2794+10	025A  C31BF9  			JP	SalyDISKWRT2				;normal
 511:				
 512: 2804+17	025D  CD4AFC  	dwrta:		CALL	SENDACK
 513:				
 514: 2821+10	0260  211806  			LD	HL, direct				;direct
 515:				;		LD	A, (HL)
 516:				;		CALL	serhex
 517: 2831+11	0263  35      			DEC	(HL)
 518: 2842+7+5	0264  2813    			JR	Z, dwrtd				;first sector
 519: 2849+10	0266  FA8602  			JP	M, dwrtb				;second sector
 520:				
 521: 2859+7	0269  0640    			LD	B, 64
 522: 2866+8+5	026B  10FE    			DJNZ	$					;wait some time
 523:				
 524: 2874+16	026D  2A00C1  			LD	HL, (IOBUFF)				;save 2-byte sector number (0-xxxx)
 525: 2890+16	0270  221606  			LD	(dsector), HL
 526:				
 527: 2906+10	0273  E1      	dwrtc:		POP	HL
 528: 2916+7	0274  3E43    			LD	A, 'C'
 529: 2923+10	0276  C356FC  			JP	SENDCHAR
 530:				
 531: 2933+10	0279  2100C1  	dwrtd:		LD	HL, IOBUFF
 532: 2943+10	027C  1102C3  			LD	DE, IOBUFF+LEN+2
 533: 2953+10	027F  010001  			LD	BC, 0100h				;rec first half
 534: 2963+16+5	0282  EDB0    			LDIR
 535: 2979+12	0284  18ED    			JR	dwrtc
 536:				
 537: 2991+10	0286  3602    	dwrtb:		LD	(HL), 2					;direct = 2
 538:				
 539: 3001+10	0288  210002  			LD	HL, 512					;LOGSIZ 512 bytes in this case
 540: 3011+16	028B  22A9FF  			LD	(LOGSIZ), HL
 541:							
 542: 3027+10	028E  2100C1  			LD	HL, IOBUFF
 543: 3037+10	0291  1100C2  			LD	DE, IOBUFF+0100h
 544: 3047+10	0294  010001  			LD	BC, 0100h
 545: 3057+16+5	0297  EDB0    			LDIR    
 546: 3073+10	0299  2102C3  			LD	HL, IOBUFF+LEN+2
 547: 3083+10	029C  1100C1  			LD	DE, IOBUFF
 548: 3093+10	029F  010001  			LD	BC, 0100h
 549: 3103+16+5	02A2  EDB0    			LDIR
 550:				
 551: 3119+17	02A4  CDF701  			CALL	sec2track
 552:				
 553: 3136+19	02A7  DD360002			LD	(IX + DSKOP), PUTSEC
 554: 3155+17	02AB  CDB002  			CALL	dskwrite
 555:				
 556: 3172+12	02AE  18C3    			JR	dwrtc
 557:				;--------------------------------------------------
 558:				; dskwrite: write through sector
 559:				;--------------------------------------------------
 560:     -	02B0          	dskwrite:
 561:				;		LD	A, 'W';
 562:				;		CALL	seroutfn
 563:				
 564:				;		JP	DISKV
 565:				
 566: 3184+17	02B0  CD1D04  			CALL	checktrack
 567: 3201+7+5	02B3  2010    			JR	NZ, dskwrite1
 568:				
 569:				;		LD	HL, (LOGSIZ)
 570:				;		CALL	seraddr
 571:				
 572: 3208+17	02B5  CD0004  			CALL	compbufadr
 573:				;		CALL	seraddr
 574:				
 575: 3225+4	02B8  EB      			EX	DE, HL
 576: 3229+19	02B9  DD6605  			LD	H, (IX + DSKPTR+1)
 577: 3248+19	02BC  DD6E04  			LD	L, (IX + DSKPTR)
 578: 3267+20	02BF  ED4BA9FF			LD	BC, (LOGSIZ)
 579:				
 580: 3287+16+5	02C3  EDB0    			LDIR
 581:				
 582:     -	02C5          	dskwrite1:
 583: 3303+10	02C5  C30FF0  			JP	DISKV
 584:				
 585:				;--------------------------------------------------
 586:				; Debug routine
 587:				;--------------------------------------------------
 588: 3313+17	02C8  CD9505  	debug:		CALL	seroutfn
 589: 3330+19	02CB  DD7E01  			LD	A, (IX + DSKDRV)
 590: 3349+17	02CE  CD7C05  			CALL	serhex
 591: 3366+7	02D1  3E74    			LD	A, 't'
 592: 3373+17	02D3  CD9505  			CALL	seroutfn
 593: 3390+19	02D6  DD7E02  			LD	A, (IX + DSKTRK)
 594: 3409+17	02D9  CD7C05  			CALL	serhex
 595: 3426+7	02DC  3E73    			LD	A, 's'
 596: 3433+17	02DE  CD9505  			CALL	seroutfn
 597: 3450+19	02E1  DD7E03  			LD	A, (IX + DSKSEC)
 598: 3469+17	02E4  CD7C05  			CALL	serhex
 599: 3486+19	02E7  DD7E05  			LD	A, (IX + DSKPTR+1)
 600: 3505+17	02EA  CD7C05  			CALL	serhex
 601: 3522+19	02ED  DD7E04  			LD	A, (IX + DSKPTR)
 602: 3541+17	02F0  CD7C05  			CALL	serhex
 603: 3558+19	02F3  DD7E07  			LD	A, (IX + DSKAUX+1)
 604: 3577+17	02F6  CD7C05  			CALL	serhex
 605: 3594+19	02F9  DD7E06  			LD	A, (IX + DSKAUX)
 606: 3613+17	02FC  CD7C05  			CALL	serhex
 607:				
 608: 3630+17	02FF  CD6205  			CALL	serspace
 609: 3647+13	0302  3AFEC2  			LD	A, (CFRAME+3)
 610: 3660+17	0305  CD7C05  			CALL	serhex
 611: 3677+13	0308  3AFDC2  			LD	A, (CFRAME+2)
 612: 3690+17	030B  CD7C05  			CALL	serhex
 613: 3707+17	030E  CD6205  			CALL	serspace
 614: 3724+19	0311  FD7E03  			LD	A, (IY+NSECS+1)
 615: 3743+17	0314  CD7C05  			CALL	serhex
 616: 3760+19	0317  FD7E00  			LD	A, (IY+NTRKS)
 617: 3779+17	031A  CD7C05  			CALL	serhex
 618:				
 619: 3796+17	031D  CD6A05  			CALL	sercr
 620: 3813+10	0320  C9      			RET
 621:				;
 622:     -	0321          	dumpdcb:
 623: 3823+11	0321  F5      			PUSH	AF
 624: 3834+11	0322  C5      			PUSH	BC
 625: 3845+11	0323  E5      			PUSH	HL
 626:				
 627: 3856+15	0324  DDE5    			PUSH	IX
 628: 3871+10	0326  E1      			POP	HL
 629:				;		CALL	sercr
 630: 3881+7	0327  0609    			LD	B, 9
 631:     -	0329          	dumpdcb1:
 632: 3888+7	0329  7E      			LD	A, (HL)
 633: 3895+6	032A  23      			INC	HL
 634: 3901+17	032B  CD7C05  			CALL	serhex
 635: 3918+17	032E  CD6205  			CALL	serspace
 636: 3935+8+5	0331  10F6    			DJNZ	dumpdcb1
 637: 3943+17	0333  CD6A05  			CALL	sercr
 638:				
 639: 3960+10	0336  E1      			POP	HL
 640: 3970+10	0337  C1      			POP	BC
 641: 3980+10	0338  F1      			POP	AF
 642: 3990+10	0339  C9      			RET
 643:				;--------------------------------------------------
 644:				; dskreadfn: cache a track
 645:				;--------------------------------------------------
 646:     -	033A          	dskreadfn:
 647:				;		LD	A, 'R'
 648:				;		CALL	debug
 649:				
 650: 4000+17	033A  CD1D04  			CALL	checktrack
 651: 4017+10	033D  CAB903  			JP	Z, match
 652:				;		ld	a, 'N'
 653:				;		CALL	seroutfn
 654: 4027+20	0340  ED531B06			LD	(drive), DE				;save new drive and track
 655: 4047+15	0344  DDE5    			PUSH	IX					;save IX
 656:				
 657: 4062+15	0346  DDE5    			PUSH	IX					;load HL with IX
 658: 4077+10	0348  E1      			POP	HL
 659: 4087+10	0349  112706  			LD	DE, dcb
 660: 4097+10	034C  010900  			LD	BC, 9
 661: 4107+16+5	034F  EDB0    			LDIR						;copy dcb
 662:							
 663: 4123+14	0351  DD212706			LD	IX, dcb					;load IX with new dcb
 664:							
 665: 4137+13	0355  3A2E06  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 666: 4150+7	0358  FE02    			CP	2
 667: 4157+7+5	035A  2020    			JR	NZ, readtrack2				;no MS-DOS disk
 668:				
 669:				
 670: 4164+10	035C  210008  			LD	HL, TRKBUFFER
 671: 4174+10	035F  010112  			LD	BC, 18 * 256 + 1			;b=18, c = 1
 672:				
 673:     -	0362          	readtrack3:
 674: 4184+16	0362  222B06  			LD	(dcb + DSKPTR), HL
 675: 4200+19	0365  DD7103  			LD	(IX + DSKSEC),	C
 676:				
 677:				;		CALL	dumpdcb
 678:				
 679: 4219+11	0368  E5      			PUSH	HL
 680: 4230+11	0369  C5      			PUSH	BC
 681: 4241+17	036A  CD0FF0  			CALL	DISKV
 682: 4258+10	036D  C1      			POP	BC
 683: 4268+10	036E  E1      			POP	HL
 684:				;		CALL	dumpsec 
 685: 4278+13	036F  3A2F06  			LD	A, (dcb + DSKSTS)			;error occured?
 686: 4291+4	0372  B7      			OR	A
 687: 4295+7+5	0373  2036    			JR	NZ, readtrack4				;yes
 688: 4302+4	0375  24      			INC	H
 689: 4306+4	0376  24      			INC	H
 690: 4310+4	0377  0C      			INC	C
 691: 4314+8+5	0378  10E8    			DJNZ	readtrack3
 692: 4322+12	037A  183B    			JR	readtrack5
 693:				
 694:     -	037C          	readtrack2:
 695: 4334+7	037C  0600    			LD	B, 0					;compute skew-list from media type
 696: 4341+19	037E  FD4E05  			LD	C, (IY + MEDIA)
 697: 4360+10	0381  211F06  			LD	HL, skewtab
 698: 4370+11	0384  09      			ADD	HL, BC
 699: 4381+7	0385  7E      			LD	A, (HL)
 700: 4388+6	0386  23      			INC	HL
 701: 4394+7	0387  66      			LD	H, (HL)
 702: 4401+4	0388  6F      			LD	L, A
 703: 4405+19	0389  FD4603  			LD	B, (IY + NSECS+1)
 704:				
 705:     -	038C          	readtrack1:
 706: 4424+16	038C  221D06  			LD	(secptr), HL
 707:				
 708:     -	038F          	readtrack:
 709: 4440+16	038F  2A1D06  			LD	HL, (secptr)
 710: 4456+7	0392  7E      			LD	A, (HL)
 711: 4463+13	0393  322A06  			LD	(dcb + DSKSEC), A
 712: 4476+6	0396  23      			INC	HL
 713: 4482+16	0397  221D06  			LD	(secptr), HL
 714:				
 715: 4498+11	039A  C5      			PUSH	BC
 716: 4509+17	039B  CD0004  			CALL	compbufadr
 717: 4526+16	039E  222B06  			LD	(dcb + DSKPTR), HL
 718: 4542+17	03A1  CD0FF0  			CALL	DISKV
 719: 4559+10	03A4  C1      			POP	BC
 720:				
 721:				;		IN	A,(TRKREG)
 722:				;		CALL	serhex
 723:				;		IN	A,(SECREG)
 724:				;		CALL	serhex
 725: 4569+13	03A5  3A2F06  			LD	A, (dcb + DSKSTS)			;error occured?
 726:				;		CALL	serhex
 727: 4582+4	03A8  B7      			OR	A
 728: 4586+7+5	03A9  280A    			JR	Z, readtrack6				;no
 729:     -	03AB          	readtrack4:             
 730: 4593+10	03AB  21FFFF  			LD	HL, 0ffffh
 731: 4603+16	03AE  221B06  			LD	(drive), HL
 732: 4619+14	03B1  DDE1    			POP	IX					;yes, store in original dcb
 733: 4633+12	03B3  181E    			JR	match2
 734:     -	03B5          	readtrack6:             
 735: 4645+8+5	03B5  10D8    			DJNZ	readtrack
 736:     -	03B7          	readtrack5:
 737: 4653+14	03B7  DDE1    			POP	IX
 738:				
 739:     -	03B9          	match:
 740:				;		ld	a, 'M'
 741:				;		CALL	seroutfn
 742:						
 743: 4667+17	03B9  CD0004  			CALL	compbufadr
 744: 4684+19	03BC  DD5605  			LD	D, (IX + DSKPTR+1)
 745: 4703+19	03BF  DD5E04  			LD	E, (IX + DSKPTR)
 746: 4722+20	03C2  ED4BA9FF			LD	BC, (LOGSIZ)
 747: 4742+13	03C6  3A2E06  			LD	A, (dcb + DSKAUX+1)			;get sector length high-byte
 748: 4755+7	03C9  FE02    			CP	2
 749: 4762+7+5	03CB  2003    			JR	NZ, match1
 750: 4769+10	03CD  010002  			LD	BC, 512
 751:     -	03D0          	match1:
 752: 4779+16+5	03D0  EDB0    			LDIR
 753:				
 754: 4795+4	03D2  AF      			XOR	A
 755:     -	03D3          	match2:
 756: 4799+19	03D3  DD7708  			LD	(IX + DSKSTS), A
 757:				
 758:     -	0001          		IF	WD1772
 759: 4818+7	03D6  3ED0    			LD	A, FINCMD				;keeps motor spinning
 760: 4825+17	03D8  CDD205  			CALL	SalyCMDOUT
 761:					ENDIF
 762: 4842+10	03DB  C33CF0  			JP	ACTIVON
 763:				
 764:				
 765:				;--------------------------------------------------
 766:				; dump 512 bytes at HL
 767:				;--------------------------------------------------
 768:     -	03DE          	dumpsec:
 769: 4852+11	03DE  C5      			PUSH	BC
 770: 4863+11	03DF  E5      			PUSH	HL
 771: 4874+17	03E0  CD7205  			CALL	seraddr
 772: 4891+17	03E3  CD6A05  			CALL	sercr
 773: 4908+10	03E6  010002  			LD	BC, 512
 774:     -	03E9          	match3a:
 775: 4918+7	03E9  7E      			LD	A, (HL)
 776: 4925+17	03EA  CD7C05  			CALL	serhex
 777: 4942+4	03ED  78      			LD	A, B
 778: 4946+7	03EE  E60F    			AND	15
 779: 4953+7+5	03F0  2003    			JR	NZ, match3
 780: 4960+17	03F2  CD6A05  			CALL	sercr
 781:     -	03F5          	match3:
 782: 4977+6	03F5  23      			INC	HL
 783: 4983+4	03F6  0D      			DEC	C
 784: 4987+7+5	03F7  20F0    			JR	NZ, match3a
 785: 4994+8+5	03F9  10EE    			DJNZ	match3a
 786: 5002+10	03FB  E1      			POP	HL
 787: 5012+10	03FC  C1      			POP	BC
 788: 5022+10	03FD  C36A05  			JP	sercr
 789:				
 790:				;--------------------------------------------------
 791:				; HL = TRKBUF + DSKSEC * (128/256/512)
 792:				;--------------------------------------------------
 793:     -	0400          	compbufadr:
 794: 5032+10	0400  210008  			LD	HL, TRKBUFFER
 795: 5042+19	0403  DD4603  			LD	B, (IX + DSKSEC)
 796: 5061+4	0406  05      			DEC	B
 797: 5065+7	0407  0E00    			LD	C, 0
 798: 5072+13	0409  3A2E06  			LD	A, (dcb + DSKAUX + 1)			;load seclen highbyte
 799: 5085+4	040C  B7      			OR	A
 800: 5089+7+5	040D  2808    			JR	Z, compbufadr2				;if zero, assume 128 bytes length
 801: 5096+7	040F  FE01    			CP	1
 802: 5103+7+5	0411  2808    			JR	Z, compbufadr1				;if 1, assume 256 bytes
 803: 5110+8	0413  CB20    			SLA	B					;512 bytes
 804: 5118+12	0415  1804    			JR	compbufadr1
 805:     -	0417          	compbufadr2:
 806: 5130+8	0417  CB38    			SRL	B					;128 bytes
 807: 5138+8	0419  CB19    			RR	C
 808:     -	041B          	compbufadr1:
 809: 5146+11	041B  09      			ADD	HL, BC
 810: 5157+10	041C  C9      			RET
 811:				
 812:     -	041D          	checktrack:
 813: 5167+16	041D  2A1B06  			LD	HL, (drive)				;load
 814: 5183+19	0420  DD5602  			LD	D, (IX + DSKTRK)			;high
 815: 5202+19	0423  DD5E01  			LD	E, (IX + DSKDRV)			;low
 816: 5221+4	0426  B7      			OR	A					;clear carry
 817: 5225+15	0427  ED52    			sbc	HL, DE
 818: 5240+10	0429  C9      			RET
 819:				
 820:				;--------------------------------------------------
 821:				; get Pokeydivisor command '?'
 822:				;--------------------------------------------------
 823:     -	042A          	getspeed:
 824:				;		LD	A, '?'
 825:				;		CALL	seroutfn
 826:				
 827: 5250+17	042A  CD28FC  			CALL	DRVINDEX				;POINT IY TO DRIVE'S DATA AREA
 828: 5267+5+6	042D  D8      			RET	C					;EXIT IF NOT A DRIVE IN OUR BOX
 829:				
 830:				;		CALL	HASPARMS
 831:				;		RET	Z					;EXIT IF DISK PARAMS NOT KNOWN
 832:				
 833: 5272+17	042E  CD4AFC  			CALL	SENDACK					;SEND 'ACK' FOR COMMAND FRAME
 834:				
 835: 5289+10	0431  21FFC2  			LD	HL, IOBUFF+LEN-1
 836:				
 837:     -	0001          		IF NOHIGHSPEEDSIO <> 1
 838: 5299+7	0434  3E08    			LD	A, SIOFAST
 839: 5306+7	0436  77      			LD	(HL), A
 840: 5313+13	0437  321A06  			LD	(hispeed), A
 841:					ELSE
 843:					ENDIF	; HIGHSPEEDSIO
 844:				
 845: 5326+10	043A  114300  			LD	DE, 'C'
 846: 5336+10	043D  C36CF6  			JP	SENDBUFF				;SEND 'C' AND PARAMS DATA FRAME
 847:				
 848:				
 849:				;--------------------------------------------------
 850:				; cmdwaitfn
 851:				;--------------------------------------------------
 852:     -	0440          	cmdwaitfn:
 853: 5346+13	0440  3A55FF  			LD	A, (CMDFLG)
 854: 5359+4	0443  B7      			OR	A					;SEE IF COMMAND FRAME HAS ARRIVED
 855: 5363+5+6	0444  C8      			RET	Z					;EXIT IF NOTHING HAS HAPPENED
 856:				
 857:				;		CALL	sercmd					;5-byte command frame
 858:				
 859: 5368+13	0445  3A55FF  			LD	A, (CMDFLG)
 860: 5381+7	0448  FE01    			CP	1
 861:				
 862: 5388+4	044A  F3      			DI						;ELSE RESET INTERRUPT AND START AGAIN
 863: 5392+7	044B  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
 864: 5399+11	044D  D380    			OUT	(CTC0),A				;PERFORM THE RESET
 865: 5410+4	044F  FB      			EI
 866:				
 867: 5414+10	0450  CAF3F7  			JP	Z, CMDL4				;good cmd-frame
 868:				
 869: 5424+17	0453  CDBB04  			CALL	togglebaud
 870: 5441+10	0456  C309F8  			JP	CMDL5
 871:				
 872:				
 873:				
 874:				;--------------------------------------------------
 875:				; xmitbuffn
 876:				;--------------------------------------------------
 877:     -	0459          	xmitbuffn:
 878: 5451+4	0459  F3      			DI
 879: 5455+13	045A  3A1906  			LD	A, (pokeydiv)				;is fast?
 880: 5468+7	045D  FE28    			CP	SIONORMAL
 881: 5475+7+5	045F  2006    			JR	NZ, xmitfast				;yes, jump
 882: 5482+10	0461  0119F7  			LD	BC, STARBIT
 883: 5492+10	0464  C388F6  			JP	SalyXMITBUF
 884:				
 885:				
 886:     -	0467          	xmitfast:
 887: 5502+7	0467  3E07    			LD	A, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 888: 5509+11	0469  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
 889: 5520+7	046B  3E01    			LD	A, 1					;TIME CONSTANT OF 1 - 4uS pulses (1/4Mhz)*16
 890: 5527+11	046D  D381    			OUT	(CTC1), A
 891:				
 892:     -	046F          	xmitfast1:
 893: 5538+7	046F  7E      			LD	A, (HL)					;7
 894: 5545+6	0470  23      			INC	HL					;6
 895: 5551+4	0471  AA      			XOR	D					;4
 896: 5555+4	0472  4F      			LD	C, A					;4
 897: 5559+4	0473  83      			ADD	A, E					;4
 898: 5563+7	0474  CE00    			ADC	0					;7
 899: 5570+4	0476  5F      			LD	E, A					;4
 900: 5574+17	0477  CD8504  			CALL	fastsend				;17 send byte in c
 901: 5591+4	047A  7C      			LD	A, H					;4
 902: 5595+7	047B  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
 903: 5602+7+5	047D  38F0    			JR	C, xmitfast1				;12/7 loop if buffer end not reached
 904:				
 905: 5609+7	047F  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
 906: 5616+11	0481  D381    			OUT	(CTC1), A				;SOFWARE RESET CTC1
 907: 5627+4	0483  FB      			EI
 908: 5631+10	0484  C9      			RET
 909:				
 910:     -	0485          	fastsend:
 911: 5641+4	0485  AF      			XOR	A
 912: 5645+11	0486  D350    			OUT	(ATROUT), A
 913:				
 914: 5656+15	0488  DDE5    			PUSH	IX					;15
 915: 5671+14	048A  DDE1    			POP	IX					;14
 916: 5685+4	048C  79      			LD	A,	C				;4
 917: 5689+7	048D  0608    			LD	B, 8					;7
 918: 5696+6	048F  03      			INC	BC					;6
 919: 5702+4	0490  00      			NOP						;4
 920:				
 921:     -	0491          	fastsend1:
 922: 5706+4	0491  00      			NOP						;4
 923: 5710+7	0492  FE01    			CP	1					;7
 924: 5717+11	0494  D350    			OUT	(ATROUT), A				;11
 925: 5728+4	0496  0F      			RRCA						;4
 926: 5732+15	0497  DDE5    			PUSH	IX					;15
 927: 5747+14	0499  DDE1    			POP	IX					;14
 928: 5761+8+5	049B  10F4    			DJNZ	fastsend1				;13 / 8
 929:				
 930: 5769+9	049D  ED5F    			LD	A, r					;9
 931: 5778+7	049F  3E01    			LD	A, 1					;7
 932: 5785+11	04A1  D350    			OUT	(ATROUT), A				;11
 933: 5796+10	04A3  C9      			RET						;10
 934:				
 935:				;--------------------------------------------------
 936:				; rxblck
 937:				;--------------------------------------------------
 938:     -	04A4          	rxblck:
 939: 5806+13	04A4  3A1906  			LD	A, (pokeydiv)				;is fast?
 940: 5819+7	04A7  FE28    			CP	SIONORMAL
 941: 5826+10	04A9  CAB504  			JP	Z, rxblck1
 942:				
 943: 5836+17	04AC  CDCF04  			CALL	fastrecv				;yes, fast speed
 944: 5853+7	04AF  3E03    			LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL
 945: 5860+11	04B1  D383    			OUT	(CTC3), A				;SOFWARE RESET CTC3
 946: 5871+4	04B3  4A      			LD	C, D					;checksum in c
 947: 5875+10	04B4  C9      			RET
 948:				
 949:     -	04B5          	rxblck1:
 950: 5885+10	04B5  010000  			LD	BC, 0					;no, normal speed
 951: 5895+10	04B8  C3DCF6  			JP	SalyRXBLOCK
 952:				
 953:				;--------------------------------------------------
 954:				; togglebaud
 955:				;--------------------------------------------------
 956:     -	04BB          	togglebaud:
 957:				;		LD	A, (hispeed)
 958:				;		OR	A
 959:				;		RET	Z
 960:				
 961: 5905+13	04BB  3A1906  			LD	A, (pokeydiv)
 962: 5918+7	04BE  FE28    			CP	SIONORMAL
 963: 5925+7	04C0  3E08    			LD	A, SIOFAST
 964: 5932+7+5	04C2  2802    			JR	Z, togglebaud1
 965: 5939+7	04C4  3E28    			LD	A, SIONORMAL
 966:     -	04C6          	togglebaud1:
 967: 5946+13	04C6  321906  			LD	(pokeydiv), A
 968: 5959+10	04C9  C9      			RET
 969:				
 970:				;--------------------------------------------------
 971:				; set 4ms watchdog
 972:				;--------------------------------------------------
 973:     -	04CA          	irq4ms:
 974: 5969+10	04CA  F1      			POP	AF					;pop irq-addr
 975: 5979+4	04CB  B7      			OR	A					;clear carry
 976:     -	04CC          	irq4ms1:
 977: 5983+4	04CC  FB      			EI
 978: 5987+14	04CD  ED4D    			RETI
 979:				
 980:				;--------------------------------------------------
 981:				; SIO receive 57600 baud
 982:				;--------------------------------------------------
 983:     -	04CF          	fastrecv:
 984: 6001+4	04CF  F3      			DI
 985: 6005+10	04D0  01CA04  			LD	BC, irq4ms
 986: 6015+20	04D3  ED4316FF			LD	(CTCVEC+6),bc				;SET VECTOR TO irq4ms ROUTINE
 987: 6035+10	04D7  018300  			LD	BC, CTC3				;CLEAR B, LOAD C WITH ADDRESS OF CTC3
 988: 6045+10	04DA  11A700  			LD	DE, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 989: 6055+12	04DD  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
 990: 6067+12	04DF  ED49    			OUT	(C), C					;TIME CONSTANT OF 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
 991: 6079+4	04E1  FB      			EI
 992:				
 993:     -	04E2          	fastrecv1:              
 994: 6083+11	04E2  DB70    			IN	A, (ATARI)				;11
 995: 6094+4	04E4  17      			RLA						;4
 996: 6098+10	04E5  DAE204  			JP	C, fastrecv1				;10	NEW BYTE IS COMING IF START BIT LOW
 997:												;14-25 / 7
 998: 6108+4	04E8  7A      			LD	A, D					;4
 999: 6112+4	04E9  80      			ADD	A, B					;4
1000: 6116+7	04EA  CE00    			ADC	A, 0					;7 ACCUMULATE CHECKSUM ATARI STYLE
1001: 6123+4	04EC  57      			LD	D, A					;4
1002:								
1003: 6127+7	04ED  067F    			LD	B, 07fh					;7
1004: 6134+10	04EF  C3F404  			JP	fastrecv2a				;10 = 50
1005:				;
1006:				; SERIAL->PARALLEL CONVERSION AT 17,36 MICROSECONDS PER BIT
1007:				;
1008:     -	04F2          	fastrecv2:
1009: 6144+11	04F2  F5      			PUSH	AF					;11
1010: 6155+10	04F3  F1      			POP	AF					;10
1011:     -	04F4          	fastrecv2a:
1012: 6165+7	04F4  7E      			LD	A, (HL)					;7
1013: 6172+7	04F5  7E      			LD	A, (HL)					;7
1014:				
1015: 6179+11	04F6  DB70    			IN	A, (ATARI)				;11 CYCLES
1016: 6190+4	04F8  17      			RLA						; 4 CYCLES
1017: 6194+8	04F9  CB18    			RR	B					; 8 CYCLES
1018: 6202+7+5	04FB  38F5    			JR	C, fastrecv2				;12/7 = 70 / 65 cycles
1019:				
1020: 6209+7	04FD  70      			LD	(HL), B					;7 THEN STORE IN MEMORY BUFFER @HL
1021: 6216+6	04FE  23      			INC	HL					;6
1022: 6222+4	04FF  7C      			LD	A, H					;4
1023: 6226+7	0500  FEC3    			CP	HIGH (IOBUFF+LEN)			;7
1024: 6233+4	0502  3F      			CCF						;4
1025: 6237+5+6	0503  D8      			RET	C					;5 RETURN WITH CARRY SET IF BUFFER FILLED
1026:				
1027: 6242+12	0504  ED59    			OUT	(C), E					;12 PUT CTC3 IN TIMER MODE, PRESCALE 256
1028: 6254+12	0506  ED49    			OUT	(C), C					;12 COUNT MOD 256 - ACTUALLY C = 131 (CTC3 ADDRESS WHICH IS 083h)? 8.38ms? MAYBE MEANT , B
1029:				
1030: 6266+10	0508  C3E204  			JP	fastrecv1				;10
1031:				
1032:				
1033:				;serdumpcpl:
1034:				;		PUSH	HL
1035:				;		PUSH	AF
1036:				;		PUSH	BC
1037:				;		PUSH	DE
1038:				;		LD	D, 255
1039:				;		JR	serdump1
1040:				
1041: 6276+13	050B  3AC5FF  	diskiodebug:	LD	a, (CMDBYT)
1042: 6289+7	050E  FE80    			CP	080h
1043: 6296+7+5	0510  2028    			JR	NZ, diskiodebug1
1044:				
1045: 6303+17	0512  CD6A05  			CALL	sercr
1046:						
1047: 6320+19	0515  DD7E03  			LD	A,(IX+DSKSEC)	
1048: 6339+11	0518  D342    			OUT	(SECREG),A	
1049: 6350+19	051A  DD7E02  			LD	A,(IX+DSKTRK)	
1050: 6369+11	051D  D341    			OUT	(TRKREG),A	
1051:				
1052: 6380+11	051F  DB41    			in	a, (TRKREG)
1053: 6391+17	0521  CD7C05  			CALL	serhex
1054: 6408+11	0524  DB42    			in	a, (SECREG)
1055: 6419+17	0526  CD7C05  			CALL	serhex		
1056: 6436+13	0529  3AC5FF  			LD	A,(CMDBYT)				
1057: 6449+11	052C  D340    			OUT	(CMDREG),A				;START 1791 WORKING ON W/R COMMAND
1058:				
1059: 6460+11	052E  DB40    	dbgRWBUSY:	IN	A,(STSREG)
1060: 6471+8	0530  CB47    			BIT	0,A
1061: 6479+7+5	0532  20FA    			JR	NZ,dbgRWBUSY				;LOOP TILL 1797 BUSY BIT GOES AWAY
1062: 6486+17	0534  CD7C05  			CALL	serhex
1063: 6503+17	0537  CD6A05  			CALL	sercr
1064:					
1065: 6520+19	053A  DD7E03  	diskiodebug1:	LD	A,(IX+DSKSEC)
1066: 6539+10	053D  C3E1F0  			JP	DISK4+3
1067:						
1068:				;--------------------------------------------------
1069:				; RS232 sercmd
1070:				;--------------------------------------------------
1071:     -	0540          	sercmd:
1072: 6549+11	0540  E5      			PUSH	HL
1073: 6560+10	0541  21FBC2  			LD	HL, CFRAME
1074: 6570+17	0544  CD6A05  			CALL	sercr
1075: 6587+12	0547  1801    			JR	serdump2
1076:				
1077:				;--------------------------------------------------
1078:				; RS232 dump
1079:				;--------------------------------------------------
1080:     -	0549          	serdump:
1081: 6599+11	0549  E5      			PUSH	HL
1082:     -	054A          	serdump2:
1083: 6610+11	054A  F5      			PUSH	AF
1084: 6621+11	054B  C5      			PUSH	BC
1085: 6632+11	054C  D5      			PUSH	DE
1086:				
1087: 6643+7	054D  1600    			LD	D, 0
1088:				
1089:     -	054F          	serdump1:
1090: 6650+7	054F  7E      			LD	A, (HL)
1091: 6657+4	0550  AA      			XOR	D
1092: 6661+17	0551  CD7C05  			CALL	serhex
1093: 6678+17	0554  CD6205  			CALL	serspace
1094: 6695+6	0557  23      			INC	HL
1095: 6701+4	0558  7C      			LD	A, H
1096: 6705+7	0559  FEC3    			CP	A, 0c3h
1097: 6712+7+5	055B  38F2    			JR	C, serdump1
1098:				
1099: 6719+10	055D  D1      			POP	DE
1100: 6729+10	055E  C1      			POP	BC
1101: 6739+10	055F  F1      			POP	AF
1102: 6749+10	0560  E1      			POP	HL
1103: 6759+10	0561  C9      			RET
1104:				
1105:				;--------------------------------------------------
1106:				; RS232 <space>
1107:				;--------------------------------------------------
1108:     -	0562          	serspace:
1109: 6769+11	0562  F5      			PUSH	AF
1110: 6780+7	0563  3E20    			LD	A, ' '
1111: 6787+17	0565  CD9505  			CALL	seroutfn
1112: 6804+10	0568  F1      			POP	AF
1113: 6814+10	0569  C9      			RET
1114:				
1115:				;--------------------------------------------------
1116:				; RS232 <CR>
1117:				;--------------------------------------------------
1118:     -	056A          	sercr:
1119: 6824+11	056A  F5      			PUSH	AF
1120: 6835+7	056B  3E0D    			LD	A, CR
1121: 6842+17	056D  CD9505  			CALL	seroutfn
1122: 6859+10	0570  F1      			POP	AF
1123: 6869+10	0571  C9      			RET
1124:				
1125:				;--------------------------------------------------
1126:				; RS232 output HL in hex
1127:				;--------------------------------------------------
1128:     -	0572          	seraddr:
1129: 6879+4	0572  7C      			LD	A, H
1130: 6883+17	0573  CD7C05  			CALL	serhex
1131: 6900+4	0576  7D      			LD	A, L
1132: 6904+17	0577  CD7C05  			CALL	serhex
1133: 6921+12	057A  18E6    			JR	serspace
1134:				;--------------------------------------------------
1135:				; RS232 output A in hex
1136:				;--------------------------------------------------
1137:     -	057C          	serhex:
1138: 6933+11	057C  F5      			PUSH	AF
1139: 6944+11	057D  F5      			PUSH	AF
1140: 6955+4	057E  0F      			RRCA
1141: 6959+4	057F  0F      			RRCA
1142: 6963+4	0580  0F      			RRCA
1143: 6967+4	0581  0F      			RRCA
1144: 6971+17	0582  CD8B05  			CALL	sernib
1145: 6988+10	0585  F1      			POP	AF
1146: 6998+17	0586  CD8B05  			CALL	sernib
1147: 7015+10	0589  F1      			POP	AF
1148: 7025+10	058A  C9      			RET
1149:				
1150:     -	058B          	sernib:
1151: 7035+7	058B  E60F    			AND	0fh
1152: 7042+7	058D  C630    			ADD	'0'
1153: 7049+7	058F  FE3A    			CP	'9' + 1
1154: 7056+7+5	0591  3802    			JR	C, sernib1
1155: 7063+7	0593  C607    			ADD	7
1156:     -	0595          	sernib1:
1157:				;--------------------------------------------------
1158:				; RS232 out	208 T-States
1159:				;--------------------------------------------------
1160:     -	0595          	seroutfn:
1161: 7070+11	0595  F5      			PUSH	AF
1162: 7081+11	0596  C5      			PUSH	BC
1163: 7092+4	0597  47      			LD	B, A
1164: 7096+4	0598  AF      			XOR	A
1165: 7100+4	0599  F3      			DI
1166: 7104+11	059A  D351    			OUT	(SEROUT), A				;startbit
1167: 7115+17	059C  CDCC05  			CALL	time19600				;17
1168:					
1169: 7132+4	059F  78      			LD	A, B	
1170: 7136+7	05A0  0608    			LD	B, 8					;7
1171:     -	05A2          	serout1:	
1172: 7143+11	05A2  D351    			OUT	(SEROUT), A				;11
1173: 7154+17	05A4  CDCC05  			CALL	time19600				;17
1174: 7171+4	05A7  0F      			RRCA						;4
1175: 7175+8+5	05A8  10F8    			DJNZ	serout1					;8
1176: 7183+4	05AA  FB      			EI	
1177: 7187+7	05AB  3E01    			LD	A, 1					;7
1178: 7194+11	05AD  D351    			OUT	(SEROUT), A				;11
1179: 7205+17	05AF  CDCC05  			CALL	time19600				;17
1180:				
1181: 7222+10	05B2  C1      			POP	BC
1182: 7232+10	05B3  F1      			POP	AF
1183: 7242+10	05B4  C9      			RET
1184:				
1185:				
1186:				;--------------------------------------------------
1187:				; RS232 in	208 T-States
1188:				;--------------------------------------------------
1189:     -	05B5          	serinfn:
1190: 7252+11	05B5  C5      			PUSH	BC
1191:     -	05B6          	serin2:
1192: 7263+11	05B6  DB50    			IN	A, (SERIN)
1193: 7274+4	05B8  07      			RLCA
1194: 7278+7+5	05B9  38FB    			JR	C, serin2
1195:				
1196: 7285+19	05BB  E3      			EX	(SP), HL				;19, 4.75uS
1197: 7304+19	05BC  E3      			EX	(SP), HL				;19  9uS
1198:				
1199: 7323+7	05BD  0680    			LD	B, 80h
1200:     -	05BF          	serin1:
1201: 7330+17	05BF  CDCC05  			CALL	time19600
1202: 7347+11	05C2  DB50    			IN	A, (SERIN)
1203: 7358+4	05C4  07      			RLCA
1204: 7362+8	05C5  CB18    			RR	B
1205: 7370+7+5	05C7  30F6    			JR	NC, serin1
1206:				
1207: 7377+4	05C9  78      			LD	A, B
1208: 7381+10	05CA  C1      			POP	BC
1209: 7391+10	05CB  C9      			RET
1210:				
1211:     -	05CC          	time19600:
1212: 7401+7	05CC  0E09    			LD	C, 9					;4
1213:     -	05CE          	time19600a:
1214: 7408+4	05CE  0D      			DEC	C					;4
1215: 7412+7+5	05CF  20FD    			JR	NZ, time19600a				;12/7
1216: 7419+10	05D1  C9      			RET						;10
1217:				
1218:     -	05D2          	SalyCMDOUT:
1219: 7429+11	05D2  D340    			OUT	(CMDREG),A				;OUTPUT DISK CONTROLLER COMMAND BYTE
1220:     -	05D4          	slyCMDT1:
1221: 7440+7	05D4  3E0E    			LD	A,14
1222:     -	05D6          	slyCMDT2:
1223: 7447+4	05D6  3D      			DEC	A
1224: 7451+7+5	05D7  20FD    			JR	NZ,slyCMDT2				;DELAY 56 MICROSECONDS
1225:     -	05D9          	CMDT3:
1226: 7458+11	05D9  DB40    			IN	A, (STSREG)
1227: 7469+8	05DB  CB47    			BIT	0, A
1228: 7477+7+5	05DD  20F5    			JR	NZ, slyCMDT1
1229: 7484+10	05DF  C9      			RET
1230:						ENDIF	; SALLYBUILD
1231:				
1232:				;--------------------------------------------------
1233:				; 11 times port:value
1234:				;--------------------------------------------------
1235:     -	05E0  5001    	INITAB:		DEFB	ATROUT,1				;SET ATART OUTPUT TO MARK STATE
1236:     -	05E2  5101    			DEFB	SEROUT,1				;SET RS232 OUTPUT TO MARK STATE
1237:     -	05E4  8003    			DEFB	CTC0, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC0
1238:     -	05E6  8010    			DEFB	CTC0, low ctcvec			;SET CTC0 BASE INTERRUPT VECTOR
1239:     -	05E8  8107    			DEFB	CTC1, CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	;PUT CTC1 IN TIMER MODE + SET TIME CONSTANT
1240:     -	05EA  8101    			DEFB	CTC1, 1					;CTC1 TIME CONSTANT (DIVIDE BY 1 - 6.5us)
1241:     -	05EC  8203    			DEFB	CTC2, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC2
1242:     -	05EE  8303    			DEFB	CTC3, CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET CTC3
1243:     -	05F0  5701    			DEFB	CDMUX, 1				;SET MUX TO PASS ATARI DATA
1244:     -	0001          		IF WD1772
1245:     -	05F2  3050    			DB	LATCH, 050h				;DRIVE CONTROL reset FDC
1246:     -	05F4  3040    			DB	LATCH, 040h				;DRIVE CONTROL 8Mhz
1247:					ELSE
1250:					ENDIF	;WD1772
1251:     -	0016          	ITBLEN		EQU	$-INITAB
1252:				;
1253:				;
1254:				;
1255:				;
1256:				;
1257:				;
1258:				
1259:     -	0001          	IF SALLYBUILD
1260:				;--------------------------------------------------
1261:				; variables and data structure
1262:				;--------------------------------------------------
1263:				;
1264:				; 32 bytes for dsktb
1265:				; 7 commands copied in from DISKTAB, 3x7=21
1266:				; 2 commands added '?' and 0xDD (setDirectSector)
1267:				;
1268:     -	05F6  00000000	dsktb:		DW	0, 0, 0, 0, 0, 0, 0, 0
	              00000000
	              00000000
	              00000000
1269:     -	0606  00000000			DW	0, 0, 0, 0, 0, 0, 0, 0
	              00000000
	              00000000
	              00000000
1270:				
1271:				;
1272:				; direct MSDOS sector for each drive
1273:				;
1274:     -	0616  0000    	dsector:	DB	0, 0
1275:     -	0618  00      	direct:		DB	0
1276:				
1277:     -	0619  28      	pokeydiv:	DB	SIONORMAL
1278:     -	061A  00      	hispeed:	DB	0
1279:				
1280:     -	061B  FF      	drive:		DB	255
1281:     -	061C  FF      	thetrack:	DB	255
1282:     -	061D  0000    	secptr:		DW	0
1283:				
1284:     -	061F  56FE    	skewtab:	DW	SKEWSD
1285:     -	0621  C8FE    			DW	SKEW13
1286:     -	0623  68FE    			DW	SKEWDD
1287:     -	0625  E2FE    			DW	SKEW17
1288:				
1289:     -	0627  00      	dcb:		DB	0					;DISK OPERATION CODE
1290:     -	0628  00      			DB	0					;DRIVE# (WITH SIDE# IN BIT 7)
1291:     -	0629  00      			DB	0					;TRACK#
1292:     -	062A  00      			DB	0					;SECTOR#
1293:     -	062B  0000    			DW	0					;READ/WRITE POINTER
1294:     -	062D  0000    			DW	0					;AUXILLIARY PARAMETERS (2 BYTES)
1295:     -	062F  00      			DB	0					;OPERATION COMPLETION STATUS
1296:				
1297:     -	0630  00000000	id:		DW	0, 0, 0
	              0000
1298:				
1299:				ENDIF	;SALLYBUILD
1300:				;
1301:				;
**** ..\src\sally2.asm ****
  15:				;
  16:				;	PHASE TO RAM-RESIDENT PART OF PROGRAM
  17:				;
  18:     -	0636          	MONCOPY	EQU	$
  19:     -	F000          		.PHASE	0F000H
  20:				;
  21:				;
  22:     -	F000          	MONITOR	EQU	$
  23: 7494+10	F000  C31BF0  			JP	RESTART
  24: 7504+10	F003  C3DEF3  			JP	MINIMON		;MONITOR WARM ENTRY POINT
  25: 7514+10	F006  C335F6  	CSV:	JP	CONST		;CONSOLE STATUS
  26: 7524+10	F009  C340F6  	CIV:	JP	CONIN		;CONSOLE INPUT
  27: 7534+10	F00C  C350F6  	COV:	JP	CONOUT		;CONSOLE OUTPUT
  28: 7544+10	F00F  C322F0  	DISKV:	JP	DISKDVR		;DISK HANDLER
  29: 7554+10	F012  C3DCF4  	LISTV:	JP	CENTOUT		;PARALLEL PRINTER OUT
  30: 7564+10	F015  C3EBF4  			JP	CENTRDY		;PARALLEL PRINTER STATUS
  31: 7574+10	F018  C315F6  	RENEW:	JP	CINIT2		;CONSOLE PORT INITAILZATION
  32:				;
  33:     -	F01B          	RESTART:	
  34: 7584+4	F01B  F3      			DI
  35: 7588+4	F01C  AF      			XOR	A
  36: 7592+11	F01D  D352    			OUT	(BANKSW),A
  37: 7603+10	F01F  C30000  			JP	0			;JUMP TO ROM
  38:				;
  39:				;
  40:				;
  41:					INCLUDE	DISKIO.MAC
**** ..\src\DISKIO.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	DISK I/O DRIVER FOR ATARI BOX.	18-FEB-82	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	EQUATES FOR DISK CONTROLLER PORTS AND COMMAND CODES
   9:				;
  10:     -	0040          	STSREG	EQU	WD179X+0	;STATUS REGISTER
  11:     -	0040          	CMDREG	EQU	WD179X+0	;COMMAND REGISTER
  12:     -	0041          	TRKREG	EQU	WD179X+1	;TRACK REGISTER
  13:     -	0042          	SECREG	EQU	WD179X+2	;SECTOR REGISTER
  14:     -	0043          	DATREG	EQU	WD179X+3	;DATA REGISTER
  15:				;
  16:				;	TYPE I COMMANDS LOW NIBBLE
  17:				;
  18:     -	0000          	STEPRATE0	EQU 0		;6ms,  3 ms if 179x and 2 MHz
  19:     -	0001          	STEPRATE1	EQU 1		;12ms, 6 ms if 179x and 2 MHz
  20:     -	0002          	STEPRATE2	EQU 2		;20ms, 10ms if 179x and 2 MHz, 2ms if WD1772
  21:     -	0003          	STEPRATE3	EQU 3		;30ms, 15ms if 179x and 2 MHz, 3ms if WD1772
  22:				;
  23:				;	TYPE I AND TYPE II COMMANDS LOW NIBBLE
  24:				;	1770/1772 only
  25:     -	0000          	SPINWAIT	EQU 00000000B	;1770/1772: Enable spin up sequence
  26:     -	0008          	NOWAITMTR	EQU 00001000B	;1770/1772: Disable spin up sequence
  27:				;
  28:				;	TYPE II COMMANDS LOW NIBBLE
  29:				;	(F1)
  30:     -	0002          	SIDECMP	EQU	00000010B	;1791/1793: Side Select Compare Enabled \ 1795/1797: Update SSO to 1 \ 1773: Enable Side Compare
  31:				;
  32:				;	(F2) - Read Sector and Write Sector commands only
  33:     -	0008          	SIDESEL	EQU	00001000B	;1791/1793/1773: Side Select Compare for Side 1 \ 1795/1797: Interpret Sector Len Field 00=128, 01=256, 10=512,  11=1024
  34:				;		EQU	00000000B	;1791/1793/1773: Side Select Compare for Side 0 \ 1795/1797: Interpret Sector Len Field 00=256, 01=512, 10=1024, 11=128
  35:				;
  36:				;	TYPE II AND TYPE III COMMANDS LOW NIBBLE
  37:				;
  38:     -	0004          	SETTLE	EQU	00000100B	;179x: Add 15ms delay (2MHz)
  39:     -	0002          	WRPCOMP	EQU	00000010B	;1770/1772/1773 Write Sector and Write Track commands only: Enable Write Precompensation
  40:				;
  41:				;
  42:     -	0001          			IF WD1772
  43:     -	0000          	HLOAD		EQU	SPINWAIT	; Sally2
  44:     -	0001          	STEPRATE	EQU	STEPRATE1	; Sally2 - 12ms step rate
  45:						ELSE
  48:						ENDIF
  49:				;
  50:				;
  51:     -	00C0          	RIDCMD	EQU	11000000B	;READ ID COMMAND
  52:     -	0001          	IF WD1772
  53:     -	0080          	RDCMD	EQU	10000000B	;READ COMMAND
  54:     -	00A0          	WRTCMD	EQU	10100000B	;WRITE COMMAND
  55:				ELSE
  58:				ENDIF
  59:     -	00D0          	FINCMD	EQU	11010000B	;FORCE INTERRUPT COMMAND
  60:     -	0010          	SKCMD	EQU	00010000B	;SEEK COMMAND
  61:     -	0000          	RSTCMD	EQU	00000000B	;RESTORE COMMAND
  62:     -	0060          	STEPOUT	EQU	01100000B	;STEP OUT COMMAND
  63:     -	0040          	STEPIN	EQU	01000000B	;STEP IN COMMAND
  64:     -	00E0          	RDTRK	EQU	11100000B	;READ TRACK COMMAND
  65:     -	00F0          	WRTRK	EQU	11110000B	;WRITE TRACK COMMAND
  66:     -	00E4          	RDTKDLY	EQU	RDTRK+100B	;WRITE TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  67:     -	00F4          	WRTKDLY	EQU	WRTRK+100B	;READ TRACK COMMAND with 15ms settling delay (179x/1773: 30ms if 1MHz)
  68:				;
  69:				;
  70:				; Drive control LATCH (U24)
  71:				;
  72:     -	0001          	DRVSEL1		EQU 00000001B	; 1 = select drive 1
  73:     -	0002          	DRVSEL2		EQU 00000010B	; 1 = select drive 2
  74:     -	0004          	DRVSEL3		EQU 00000100B	; 1 = select drive 3
  75:     -	0008          	DRVSEL4		EQU 00001000B	; 1 = select drive 4
  76:     -	0010          	FDCRESET	EQU 00010000B	; 1 = Put FDC chip in reset, 0 = Release FDC chip from reset
  77:     -	0020          	FDCSIDE		EQU 00100000B	; Side select pin on floppy connector
  78:     -	0040          	FBS			EQU 01000000B	; 0 = B, 1 = S
  79:     -	0080          	FDENSITY	EQU 10000000B	; 0 = Double, 1 = Single
  80:				;
  81:				;
  82:				;
  83:     -	0066          	NMIVEC	EQU	0066H
  84:				;
  85:				;
  86:				;
  87:				;
  88:				;	... DATA STRUCTURE FOR DISK I/O CONTROL BLOCK ...
  89:				;
  90:     -	0000          	DSKOP	EQU	0		;DISK OPERATION CODE
  91:     -	0001          	DSKDRV	EQU	1		;DRIVE# (WITH SIDE# IN BIT 7)
  92:     -	0002          	DSKTRK	EQU	2		;TRACK#
  93:     -	0003          	DSKSEC	EQU	3		;SECTOR#
  94:     -	0004          	DSKPTR	EQU	4		;READ/WRITE POINTER
  95:     -	0006          	DSKAUX	EQU	6		;AUXILLIARY PARAMETERS (2 BYTES)
  96:     -	0008          	DSKSTS	EQU	8		;OPERATION COMPLETION STATUS
  97:				;
  98:				;
  99:				;	... DISK DRIVER OPERATION CODE DEFINITIONS ...
 100:				;
 101:     -	0000          	TSTRDY	EQU	0		;SELECT DRIVE AND TEST READY
 102:     -	0001          	GETSEC	EQU	1		;READ SECTOR
 103:     -	0002          	PUTSEC	EQU	2		;WRITE SECTOR
 104:     -	0003          	GETID	EQU	3		;READ ID MARK
 105:				;
 106:				;
 107:				;
 108:     -	F022          	DISKDVR:
 109: 7613+17	F022  CDB6F3  		CALL	STOPTMR		;KILL DISK TIMER INTERRUPT FROM CTC3
 110: 7630+19	F025  DD7E00  		LD	A,(IX+DSKOP)
 111: 7649+4	F028  B7      		OR	A
 112: 7653+7+5	F029  2845    		JR	Z,TESTDRV	;JUMP IF TEST READY OPERATION
 113: 7660+7	F02B  0680    		LD	B,RDCMD
 114: 7667+4	F02D  3D      		DEC	A
 115: 7671+7+5	F02E  2873    		JR	Z,SETSSO	;JUMP IF DISK READ OPERATION
 116: 7678+7	F030  06A0    		LD	B,WRTCMD
 117: 7685+4	F032  3D      		DEC	A
 118: 7689+7+5	F033  286E    		JR	Z,SETSSO	;JUMP IF DISK WRITE OPERATION
 119: 7696+4	F035  3D      		DEC	A
 120: 7700+7+5	F036  2857    		JR	Z,READID	;JUMP IF DISK ID READ OPERATION
 121: 7707+19	F038  DD3608FF		LD	(IX+DSKSTS),255	;ELSE SET ALL ERROR BITS AND RETURN
 122:				
 123:     -	F03C          	ACTIVON:
 124: 7726+4	F03C  F3      		DI
 125: 7730+7	F03D  3EA7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 126: 7737+11	F03F  D383    		OUT	(CTC3),A	;PUT CTC3 IN TIMER MODE, PRESCALE 256
 127: 7748+4	F041  AF      		XOR	A			;TIME CONSTANT OF 0 WHICH MEANS 256
 128: 7752+11	F042  D383    		OUT	(CTC3),A	;COUNT MOD 256
 129: 7763+4	F044  3D      		DEC	A
 130: 7767+13	F045  32C9FF  		LD	(DRVTMR),A	;STOP DRIVES AFTER 255 INTERRUPTS
 131: 7780+10	F048  2150F0  		LD	HL,ACTIVTY
 132: 7790+16	F04B  2216FF  		LD	(CTCVEC+6),HL	;SET VECTOR TO ACTIVITY-CHECK ROUTINE
 133: 7806+4	F04E  FB      		EI
 134: 7810+10	F04F  C9      		RET
 135:				;
 136:				;
 137:				;
 138:     -	F050          	ACTIVTY:
 139: 7820+11	F050  F5      		PUSH	AF
 140: 7831+13	F051  3AC9FF  		LD	A,(DRVTMR)
 141: 7844+4	F054  3D      		DEC	A
 142: 7848+13	F055  32C9FF  		LD	(DRVTMR),A
 143: 7861+7+5	F058  200A    		JR	NZ,ACTV2	;EXIT IF 4 SECONDS NOT ELAPSED
 144:				
 145: 7868+17	F05A  CD68F0  		call	shutdown
 146: 7885+7	F05D  3E21    		LD	A, CTC_D7_INT_DIS + CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D0_CONTROL
 147: 7892+11	F05F  D383    		OUT	(CTC3),A	;RESET INTERRUPT BUT KEEP COUNTER GOING
 148: 7903+13	F061  322EFF  		LD	(DRVOFF),A	;SET 'DRVOFF' FLAG TO NON-ZERO VALUE
 149:				
 150: 7916+10	F064  F1      	ACTV2:	POP	AF
 151: 7926+4	F065  FB      		EI
 152: 7930+14	F066  ED4D    		RETI
 153:				;
 154:				;
 155:				;
 156:     -	F068          	shutdown:
 157:     -	0001          	IF WD1772
 158: 7944+17	F068  CD28F2  		CALL	SalyResetFDC
 159: 7961+7	F06B  3E40    		LD	A, 040h
 160:				ELSE
 167:				ENDIF
 168: 7968+11	F06D  D330    		OUT	(LATCH),A
 169: 7979+10	F06F  C9      		ret
 170:					
 171:				;
 172:				;
 173:				;
 174:				;
 175:				;
 176:				;	... DRIVE READY/STATUS TEST FUNCTION ...
 177:				;
 178:				;
 179:     -	F070          	TESTDRV:
 180: 7989+17	F070  CD0AF1  		CALL	SELECT		;SELECT DRIVE FOR SPIN/STATUS CHECK	
 181: 8006+8	F073  CB7F    		BIT	7,A
 182: 8014+7+5	F075  2805    		JR	Z,TDRV2		;JUMP IF DRIVE READY INDICATED
 183:				
 184: 8021+10	F077  2130FF  		LD	HL,PERIOD	;ELSE SET PERIOD TO ZERO
 185: 8031+10	F07A  3600    		LD	(HL),0
 186:				
 187: 8041+19	F07C  DD7708  	TDRV2:	LD	(IX+DSKSTS),A	;RETURN TYPE 1 STATUS IN 'DSKSTS'
 188: 8060+13	F07F  3A2FFF  		LD	A,(OUTCPY)
 189: 8073+19	F082  DD7706  		LD	(IX+DSKAUX),A	;RETURN CONTROL BITS IN AUX BYTE #1
 190: 8092+13	F085  3A30FF  		LD	A,(PERIOD)
 191: 8105+19	F088  DD7707  		LD	(IX+DSKAUX+1),A	;RETURN PERIOD IN AUX BYTE #2
 192: 8124+17	F08B  CD3CF0  		CALL	ACTIVON		;START DISK ACTIVITY MONITOR AGAIN
 193: 8141+10	F08E  C9      		RET
 194:				;
 195:				;
 196:				;
 197:				;	... READ ID MARK FUNCTION ...
 198:				;
 199:     -	F08F          	READID:
 200: 8151+19	F08F  DD360606		LD	(IX+DSKAUX),6
 201: 8170+19	F093  DD360700		LD	(IX+DSKAUX+1),0
 202: 8189+7	F097  06C0    		LD	B,RIDCMD
 203: 8196+17	F099  CDA3F0  		CALL	DISK		;READ 6 BYTE ID RECORD
 204: 8213+13	F09C  3A2FFF  		LD	A,(OUTCPY)
 205: 8226+19	F09F  DD7706  		LD	(IX+DSKAUX),A	;RETURN DRIVE CONTROL LATCH BYTE
 206: 8245+10	F0A2  C9      		RET
 207:				;
 208:				;
 209:				;
 210:				;	... SECTOR READ/WRITE FUNCTION ...
 211:				;
 212:     -	F0A3          	SETSSO:
 213:     -	0000          	IF WD1772 <> 1
 217:				ENDIF
 218:     -	F0A3          	DISK:
 219: 8255+4	F0A3  78      		LD	A, B
 220: 8259+13	F0A4  32C5FF  		LD	(CMDBYT),A					;STORE 1797 COMMAND PASSED IN B
 221: 8272+17	F0A7  CD0AF1  		CALL	SELECT						;SELECT DRIVE/SIDE FOR DISK OPERATION
 222: 8289+8	F0AA  CB7F    		BIT	7,A
 223: 8297+7+5	F0AC  2052    		JR	NZ,DISKX					;EXIT IF NOT READY
 224: 8304+13	F0AE  3A2DFF  		LD	A,(TRACK)				
 225: 8317+7	F0B1  FEFF    		CP	255				
 226: 8324+7+5	F0B3  2805    		JR	Z,DISK2				
 227: 8331+19	F0B5  DDBE02  		CP	(IX+DSKTRK)					;TEST IF ALREADY AT DESIRED TRACK
 228: 8350+7+5	F0B8  2805    		JR	Z,DISK3						;SKIP SEEK PART IF SO
 229:								
 230: 8357+17	F0BA  CDE9F1  	DISK2:	CALL	SEEKTRK						;GO LOOKING FOR TRACK# IN IOCB
 231: 8374+7+5	F0BD  2041    		JR	NZ,DISKX					;EXIT IF HEAD POSITIONING ERROR
 232:				
 233: 8381+13	F0BF  3A12FF  	DISK3:	LD	A,(CTCVEC+2)
 234: 8394+4	F0C2  3C      		INC	A						;LOOP TILL TX CTC TURNS ITSELF OFF
 235: 8398+7+5	F0C3  20FA    		JR	NZ,DISK3					;(INTERRUPT VECTOR LSB SET=FFH)
 236:     -	F0C5          	SalyDISK3:
 237: 8405+4	F0C5  F3      		DI
 238: 8409+7	F0C6  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL		; SOFTWARE RESET CTC0
 239: 8416+11	F0C8  D380    		OUT	(CTC0),A					;DISABLE RX INTERRUPT FROM CTC0
 240: 8427+7	F0CA  3E27    		LD	A, CTC_D6_MODE_TIM + CTC_D5_PRESC256 + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; SET PRESCALER TO 256 AND SOFTWARE RESET
 241: 8434+11	F0CC  D382    		OUT	(CTC2),A					;DISABLE CTC2 AND ALSO INIT FOR CLOCK SOURCE FOR WATCHDOG TIMER
 242: 8445+7	F0CE  3E3D    		LD	A,61						;SET TIME COUNTER TO 61, about 3.9ms
 243: 8452+11	F0D0  D382    		OUT	(CTC2),A				
 244: 8463+10	F0D2  2193F3  		LD	HL,WATCHDOG					;STORE NEW CTC3 VECTOR FOR SAFETY
 245: 8473+16	F0D5  2216FF  		LD	(CTCVEC+6),HL				
 246:								
 247: 8489+13	F0D8  3A33FF  		LD	A,(RWMAX)				
 248: 8502+13	F0DB  32C6FF  		LD	(RWTRY),A					;SET READ/WRITE RETRY COUNT
 249: 8515+19	F0DE  DD7E03  	DISK4:	LD	A,(IX+DSKSEC)					;OUTPUT SECTOR NUMBER FOR READ/WRITE
 250: 8534+11	F0E1  D342    		OUT	(SECREG),A				
 251: 8545+19	F0E3  DD7E02  		LD	A,(IX+DSKTRK)				
 252: 8564+11	F0E6  D341    		OUT	(TRKREG),A					;DITTO FOR TRACK NUMBER
 253: 8575+13	F0E8  3AC5FF  		LD	A,(CMDBYT)				
 254: 8588+11	F0EB  D340    		OUT	(CMDREG),A					;START 1791 WORKING ON W/R COMMAND
 255: 8599+17	F0ED  CDA3F2  		CALL	RWDISK						;DO HALT/NMI DISK DATA TRANSFER
 256:     -	F0F0          	DISK4a:
 257: 8616+7+5	F0F0  280E    		JR	Z,DISKX						;EXIT IF NO DISK ERRORS
 258: 8623+11	F0F2  F5      		PUSH	AF				
 259: 8634+17	F0F3  CDFCF2  		CALL	RECOVER						;DO READ/WRITE ERROR RECOVERY ROUTINE
 260: 8651+10	F0F6  C1      		POP	BC				
 261: 8661+7+5	F0F7  2006    		JR	NZ,DISK5					;SKIP RETRY IF IRRECOVERABLE ERROR
 262: 8668+10	F0F9  21C6FF  		LD	HL,RWTRY				
 263: 8678+11	F0FC  35      		DEC	(HL)				
 264: 8689+7+5	F0FD  20DF    		JR	NZ,DISK4					;ELSE DECREMENT RETRY COUNT TILL=0
 265: 8696+4	F0FF  78      	DISK5:	LD	A,B						;THEN LOAD A WITH ERROR STATUS
 266: 8700+19	F100  DD7708  	DISKX:	LD	(IX+DSKSTS),A					;SAVE COMPLETION STATUS CARRIED IN ACC
 267: 8719+17	F103  CD18F0  		CALL	RENEW						;RESTART ATARI AND RS232 INTERRUPTS
 268: 8736+17	F106  CD3CF0  		CALL	ACTIVON						;START DISK ACTIVITY TIMER
 269: 8753+10	F109  C9      		RET
 270:				;
 271:				;
 272:				;
 273:				;	... SELECT DRIVE# PASSED @IX AND RETURN TYPE 1 STATUS ...
 274:				;
 275:     -	F10A          	SELECT:
 276: 8763+19	F10A  DD7E01  		LD	A,(IX+DSKDRV)
 277: 8782+8	F10D  CBBF    		RES	7,A		;CLEAR SIDE SELECT BIT FROM DRIVE#
 278: 8790+7	F10F  FE04    		CP	4
 279: 8797+7+5	F111  3073    		JR	NC,SELX		;EXIT IF INVALID DRIVE NUMBER
 280:				
 281: 8804+7	F113  0600    		LD	B,0
 282: 8811+4	F115  4F      		LD	C,A		;LOAD BC WITH NEW DRIVE# TO BE SELECTED
 283: 8815+10	F116  212CFF  		LD	HL,UNIT
 284: 8825+7	F119  96      		SUB	(HL)		;COMPARE NEW AND OLD SELECT CODES AND
 285: 8832+11	F11A  F5      		PUSH	AF		; SAVE RESULT STATUS ON STACK
 286: 8843+4	F11B  50      		LD	D,B
 287: 8847+7	F11C  5E      		LD	E,(HL)		;LOAD DE WITH LAST SELECTED DRIVE#
 288: 8854+7	F11D  71      		LD	(HL),C		;THEN STORE NEW UNIT# FROM C
 289:				
 290: 8861+10	F11E  2120FF  		LD	HL,DRVTAB
 291: 8871+11	F121  19      		ADD	HL,DE		;INDEX INTO TABLE BY CURRENT DRIVE#
 292: 8882+13	F122  3A2DFF  		LD	A,(TRACK)
 293: 8895+7	F125  77      		LD	(HL),A		;REMEMBER CURENT TRACK NUMBER
 294: 8902+7	F126  1E04    		LD	E,4
 295: 8909+11	F128  19      		ADD	HL,DE		;NOW INDEX TO CONTROL BYTE FOR UNIT
 296: 8920+13	F129  3A2FFF  		LD	A,(OUTCPY)
 297: 8933+7	F12C  77      		LD	(HL),A		;REMEMBER CURRENT DENSITY/TYPE
 298:				
 299: 8940+10	F12D  2120FF  		LD	HL,DRVTAB
 300: 8950+11	F130  09      		ADD	HL,BC		;INDEX INTO TABLE BY NEW DRIVE#
 301: 8961+7	F131  7E      		LD	A,(HL)
 302: 8968+13	F132  322DFF  		LD	(TRACK),A	;STORE CURRENT (ASSUMED) HEAD POSITION
 303: 8981+11	F135  19      		ADD	HL,DE
 304: 8992+10	F136  D1      		POP	DE		;POP UNIT# COMPARE RESULT INTO D
 305: 9002+7	F137  7E      		LD	A,(HL)		;GET CURRENT SELECT/TYPE BITS FOR DRIVE
 306: 9009+4	F138  B7      		OR	A
 307: 9013+7+5	F139  201F    		JR	NZ,SEL5		;JUMP IF NOT AN INITIAL DRIVE SELECT
 308:				;
 309:				;	ARRIVE HERE ON INITIAL DRIVE SELECT
 310:				;
 311: 9020+10	F13B  2191F1  		LD	HL,SELTAB
 312: 9030+11	F13E  09      		ADD	HL,BC		;ELSE INDEX INTO TABLE OF SELECT BITS
 313: 9041+7	F13F  7E      		LD	A,(HL)
 314: 9048+11	F140  D330    		OUT	(LATCH),A	;OUTPUT NEW DRIVE SELECTS
 315: 9059+11	F142  F5      		PUSH	AF
 316: 9070+17	F143  CD95F1  		CALL	SPIN		;NOW SPIN UP TO TEST READY
 317: 9087+10	F146  C1      		POP	BC
 318: 9097+7	F147  FEDE    		CP	222		;ERROR IF SLOWER THAN 222 MS
 319: 9104+7+5	F149  303B    		JR	NC,SELX
 320:				
 321: 9111+8	F14B  CBF0    		SET	6,B
 322: 9119+7	F14D  FEB5    		CP	181		;MINI FLOPPY IF BETWEEN 222 AND 181 MS
 323: 9126+7+5	F14F  3006    		JR	NC,SEL4
 324:				
 325: 9133+8	F151  CBB0    		RES	6,B
 326: 9141+7	F153  FE99    		CP	153		;BIG FLOPPY IF BETWEEN 181 AND 153 MS
 327: 9148+7+5	F155  382F    		JR	C,SELX
 328:				
 329: 9155+4	F157  78      	SEL4:	LD	A,B		;GET CONTROL BITS INTO A
 330: 9159+7	F158  1600    		LD	D,0		;SET D=0 TO DISABLE HEAD LOAD DELAY
 331:				;
 332:				;	ARRIVE HERE WITH DENSITY/TYPE/SELECT BITS IN ACC
 333:				;	
 334: 9166+8	F15A  CBAF    	SEL5:	RES	5,A		;RESET SIDE SELECT BIT UNCONDITIONALLY
 335: 9174+20	F15C  DDCB017E		BIT	7,(IX+DSKDRV)
 336: 9194+7+5	F160  2802    		JR	Z,SEL5A		;JUMP IF SELECTING SIDE# ZERO
 337: 9201+8	F162  CBEF    		SET	5,A		;ELSE SET SIDE SELECT BIT IN ACC
 338: 9209+11	F164  D330    	SEL5A:	OUT	(LATCH),A
 339: 9220+13	F166  322FFF  		LD	(OUTCPY),A	;OUTPUT AND SAVE NEW PATTERN
 340: 9233+4	F169  14      		INC	D
 341: 9237+4	F16A  15      		DEC	D
 342: 9241+10+7	F16B  C484F3  		CALL	NZ,HLDWAIT	;DO HEAD LOAD DELAY IF NEW DRIVE SELECT
 343:     -	0001          	IF WD1772
 344: 9251+11	F16E  DB41    		IN	A,(TRKREG)	;get status
 345: 9262+11	F170  D343    		OUT	(DATREG),A
 346: 9273+7	F172  3E10    		LD	A,SKCMD
 347: 9280+17	F174  CD74F3  		CALL	CMDOUT
 348:				ENDIF
 349: 9297+17	F177  CD7CF3  		CALL	FORCE
 350: 9314+8	F17A  CB6F    		BIT	5,A		;TEST 1797 HEAD-LOAD STATUS
 351: 9322+5+6	F17C  C0      		RET	NZ		;EXIT IF LOADED AND MOTORS ON
 352:					
 353: 9327+17	F17D  CD95F1  		CALL	SPIN		;ELSE LET THINGS SPIN A BIT
 354: 9344+4	F180  B7      		OR	A		;TEST PERIOD AFTER RE-SPINUP
 355: 9348+7+5	F181  2803    	KLUDGE:	JR	Z,SELX		;ERROR IF DISK REFUSES TO TURN
 356:					
 357:     -	0001          	IF WD1772
 358: 9355+10	F183  C37CF3  		JP	FORCE		;ELSE RETURN TYPE 1 STATUS THIS TIME
 359:				ELSE
 362:				ENDIF
 363:				;
 364:				;	ARRIVE HERE IF DRIVE CANNOT BE SELECTED AT ALL
 365:				;
 366: 9365+4	F186  AF      	SELX:	XOR	A		;TURN OFF EVERYTHING
 367:     -	0001          	IF WD1772
 368: 9369+13	F187  322FFF  		LD	(OUTCPY),A
 369: 9382+7	F18A  3E40    		LD	a, 040h		;TURN OFF -> 8Mhz
 370: 9389+11	F18C  D330    		OUT	(LATCH),A
 371: 9400+4	F18E  07      		rlca			;40h --> 80h
 372:				ELSE
 376:				ENDIF
 377: 9404+4	F18F  B7      		OR	A		;RETURN WITH NOT-READY ERROR
 378: 9408+10	F190  C9      		RET
 379:				;
 380:				;
 381:				;
 382:				;
 383:				;
 384:     -	F191  01      	SELTAB:	DEFB	00000001B
 385:     -	F192  02      		DEFB	00000010B
 386:     -	F193  04      		DEFB	00000100B
 387:     -	F194  08      		DEFB	00001000B
 388:				;
 389:				;
 390:				;
 391:     -	F195          	SPIN:
 392:     -	0001          	IF WD1772
 393: 9418+17	F195  CDA5F3  		CALL	STARTMR		;THEN RE-PROGRAM CTC1 FOR TIMER
 394: 9435+7	F198  3ED0    		LD	A, FINCMD
 395: 9442+17	F19A  CD74F3  		CALL	CMDOUT
 396:				ELSE
 407:				ENDIF
 408: 9459+4	F19D  4F      		LD	C,A		;SAVE CURRENT TYPE 1 DISK STATUS
 409: 9463+7	F19E  0606    		LD	B,6		;SET FOR 6 DISK REVOLUTIONS
 410: 9470+10	F1A0  210000  		LD	HL,0
 411: 9480+16	F1A3  22C7FF  		LD	(TICKS),HL	;RESET MILLISECOND COUNTER FOR IRQ
 412: 9496+20	F1A6  ED5BC7FF	SPIN2:	LD	DE,(TICKS)
 413: 9516+17	F1AA  CDD5F1  		CALL	EDGE		;WAIT FOR INDEX INPUT TO CHANGE
 414: 9533+7+5	F1AD  3821    		JR	C,SPIN3		;ABORT IF TIMEOUT
 415: 9540+17	F1AF  CDD5F1  		CALL	EDGE		;WAIT FOR CHANGE BACK AGAIN
 416: 9557+7+5	F1B2  381C    		JR	C,SPIN3
 417: 9564+8+5	F1B4  10F0    		DJNZ	SPIN2		;LET 6 REVOLUTIONS PASS
 418:				
 419: 9572+16	F1B6  2AC7FF  		LD	HL,(TICKS)	;READ TIME AT END OF REVOLUTION
 420: 9588+4	F1B9  B7      		OR	A
 421: 9592+15	F1BA  ED52    		SBC	HL,DE		;COMPUTE INDEX PERIOD IN MILLISECONDS
 422:				
 423:     -	0001          	IF WD1772
 424:     -	F1BC          	SPIN5:
 425: 9607+11	F1BC  DB40    		in	a, (STSREG)
 426: 9618+8	F1BE  CB7F    		bit	7, a
 427: 9626+7+5	F1C0  20FA    		jr	nz, SPIN5
 428: 9633+17	F1C2  CDB6F3  	SPIN6:	CALL	STOPTMR		;KILL INTERRUPT FROM CTC3
 429:				
 430:				ELSE
 437:				ENDIF
 438:				
 439: 9650+4	F1C5  7D      		LD	A,L
 440: 9654+4	F1C6  24      		INC	H
 441: 9658+4	F1C7  25      		DEC	H
 442: 9662+7+5	F1C8  2802    		JR	Z,SPIN4		;A HOLDS VALID PERIOD IF H=0
 443: 9669+7	F1CA  3EFF    		LD	A,255
 444: 9676+13	F1CC  3230FF  	SPIN4:	LD	(PERIOD),A
 445: 9689+10	F1CF  C9      		RET
 446:				
 447:     -	0001          	IF WD1772
 448: 9699+17	F1D0  CD28F2  	SPIN3:	CALL	SalyResetFDC
 449: 9716+12	F1D3  18ED    		JR	SPIN6
 450:				ENDIF
 451:				;
 452:				;
 453:				;
 454:     -	F1D5          	EDGE:
 455:     -	0001          	IF WD1772
 456: 9728+11	F1D5  DB40    		IN	a, (STSREG)
 457:				ELSE
 459:				ENDIF
 460: 9739+4	F1D7  A9      		XOR	C
 461: 9743+7	F1D8  E602    		AND	00000010B	;CHECK FOR CHANGE IN INDEX BIT
 462: 9750+7+5	F1DA  2009    		JR	NZ,EDGE2	;EXIT IF BIT CHANGES
 463:				
 464: 9757+13	F1DC  3AC8FF  		LD	A,(TICKS+1)
 465: 9770+7	F1DF  FE08    		CP	HIGH 2048	;ELSE CHECK TIME ACCUMULATED IN 'TICKS'
 466: 9777+7+5	F1E1  38F2    		JR	C,EDGE		;KEEP LOOPING TILL 2 SECONDS PASS
 467:				
 468: 9784+4	F1E3  37      		SCF
 469: 9788+10	F1E4  C9      		RET			;THEN RETURN WITH CARRY=1
 470:				;
 471: 9798+4	F1E5  79      	EDGE2:	LD	A,C
 472: 9802+4	F1E6  2F      		CPL			;FLIP INDEX STATE HELD IN C
 473: 9806+4	F1E7  4F      		LD	C,A
 474: 9810+10	F1E8  C9      		RET			;RETURN WITH CARRY=0
 475:				;
 476:				;
 477:				;
 478:				;
 479:				;	... SEEK TRACK# IN (IX+DSKTRK) FROM TRACK# IN (TRACK) ...
 480:				;
 481:     -	F1E9          	SEEKTRK:
 482: 9820+13	F1E9  3A2DFF  		LD	A,(TRACK)
 483: 9833+7	F1EC  FEFF    		CP	255
 484: 9840+7+5	F1EE  2005    		JR	NZ,SEEK1	;JUMP IF HEAD POSITION IS KNOWN
 485:				
 486: 9847+17	F1F0  CD3AF2  		CALL	RESTORE		;ELSE DO SLOW RESTORE TO RECALIBRATE
 487: 9864+7+5	F1F3  202A    		JR	NZ,SEEKX	;EXIT WITH PERMANENT ERROR IF FAILURE
 488:				
 489: 9871+7	F1F5  0601    	SEEK1:	LD	B,1
 490: 9878+17	F1F7  CD47F2  		CALL	SEEK		;FIRST SEEK (IX+DSKTRK) WITH NO RETRIES
 491: 9895+5+6	F1FA  C8      		RET	Z		;EXIT IF WE GOT TO THE DESIRED TRACK
 492: 9900+7+5	F1FB  3005    		JR	NC,SEEK2	;JUMP IF WE LANDED ON SOME OTHER TRACK
 493:				
 494: 9907+17	F1FD  CD3AF2  		CALL	RESTORE		;ELSE RECALIBRATE BEFORE TRYING AGAIN
 495: 9924+7+5	F200  201D    		JR	NZ,SEEKX	;EXIT IF TRACK ZERO NOT FOUND
 496:				
 497: 9931+7	F202  0602    	SEEK2:	LD	B,2
 498: 9938+17	F204  CD47F2  		CALL	SEEK		;NOW SEEK WITH TWO TRIES
 499: 9955+5+6	F207  C8      		RET	Z		;EXIT IF SUCCESSFUL THIS TIME
 500: 9960+7+5	F208  3815    		JR	C,SEEKX		;EXIT IF NO ID MARK COULD BE FOUND
 501:				
 502: 9967+10	F20A  216400  		LD	HL,100
 503: 9977+17	F20D  CD89F3  		CALL	WAIT		;DELAY TO LET THE STEPPER RELAX ITSELF
 504: 9994+10	F210  2128FF  		LD	HL,RATES
 505:10004+13	F213  3A2CFF  		LD	A,(UNIT)
 506:10017+4	F216  85      		ADD	A,L
 507:10021+4	F217  6F      		LD	L,A		;INDEX INTO TABLE TO DRIVE'S STEP RATE
 508:10025+11	F218  34      		INC	(HL)		; AND MAKE STEP RATE ONE NOTCH SLOWER
 509:10036+7	F219  7E      		LD	A,(HL)
 510:10043+7	F21A  E603    		AND	00000011B	;CHECK FOR ROLL AROUND IN LOWER 2 BITS
 511:10050+7+5	F21C  20E4    		JR	NZ,SEEK2	;REPEAT IF STEP RATE BITS WERE NOT=3
 512:				
 513:10057+11	F21E  35      		DEC	(HL)		;ELSE RESTORE FROM ROLL AROUND
 514:10068+7	F21F  3EFF    	SEEKX:	LD	A,255
 515:10075+13	F221  322DFF  		LD	(TRACK),A	;FLAG TRACK POSITION AS UNKNOWN
 516:10088+7	F224  3E10    		LD	A,00010000B	;SET SEEK ERROR BIT IN STATUS WORD
 517:10095+4	F226  B7      		OR	A
 518:10099+10	F227  C9      		RET			;RETURN WITH RNF ERROR STATUS IN A
 519:				;
 520:				;
 521:				;
 522:				;
 523:     -	0001          			IF WD1772
 524:     -	F228          	SalyResetFDC:
 525:						ELSE
 528:						ENDIF
 529:10109+13	F228  3A2FFF  		LD	A,(OUTCPY)
 530:10122+8	F22B  CBE7    		SET	4,A
 531:10130+11	F22D  D330    		OUT	(LATCH),A	;TWANG THE DISK CONTROLLER RESET PIN
 532:10141+7	F22F  060F    		LD	B,15
 533:10148+8+5	F231  10FE    		DJNZ	$		;HOLD RESET 50 MICROSECONDS
 534:10156+8	F233  CBA7    		RES	4,A
 535:10164+11	F235  D330    		OUT	(LATCH),A
 536:				
 537:     -	0001          	IF WD1772
 538:10175+8+5	F237  10FE    		DJNZ	$
 539:10183+10	F239  C9      		ret
 540:				
 541:     -	F23A          	RESTORE:
 542:10193+17	F23A  CD28F2  		CALL	SalyResetFDC
 543:				
 544:				ELSE
 548:				ENDIF
 549:				
 550:10210+7	F23D  3E01    		LD	A,RSTCMD+HLOAD+STEPRATE
 551:10217+17	F23F  CD59F3  		CALL	TYP1CMD		;DO RESTORE AT SLOWEST STEP RATE
 552:10234+7	F242  EE04    		XOR	00000100B
 553:     -	0001          	IF WD1772
 554:10241+7	F244  E604    		AND	00000100B
 555:				ELSE
 557:				ENDIF
 558:10248+10	F246  C9      		RET			;RETURN WITH ACC=0 IF HOME
 559:				;
 560:				;
 561:				;
 562:     -	F247          	SEEK:
 563:10258+11	F247  C5      		PUSH	BC		;SAVE LOOPCOUNT IN B
 564:10269+13	F248  3A2DFF  		LD	A,(TRACK)
 565:10282+4	F24B  47      		LD	B,A		;LOAD B WITH CURRENT TRACK POSITION
 566:10286+19	F24C  DD4E02  		LD	C,(IX+DSKTRK)	;LOAD C WITH DESTINATION TRACK#
 567:10305+17	F24F  CD65F2  		CALL	STEP		;HAVE A GO AT STEPPING
 568:10322+17	F252  CD83F2  		CALL	VERIFY		;VERIFY HEAD POSITION WITH READ-ID
 569:10339+10	F255  C1      		POP	BC
 570:10349+4	F256  37      		SCF
 571:10353+5+6	F257  C0      		RET	NZ		;EXIT WITH CARRY SET IF READ-ID FAILS
 572:				
 573:10358+11	F258  DB42    		IN	A,(SECREG)
 574:10369+13	F25A  322DFF  		LD	(TRACK),A	;STORE ACTUAL TRACK# FROM ID MARK
 575:10382+19	F25D  DD9602  		SUB	(IX+DSKTRK)	;COMPARE IF WE GOT THERE THIS TIME
 576:10401+5+6	F260  C8      		RET	Z		;EXIT WITH ACC=0 IF TRACK# VERIFIED
 577:				
 578:10406+8+5	F261  10E4    		DJNZ	SEEK		;DO PRESCRIBED NUMBER OF SEEK RETRIES
 579:				
 580:10414+4	F263  B7      		OR	A
 581:10418+10	F264  C9      		RET			;RETURN WITH CARRY AND ZERO FLAGS CLEAR
 582:				;
 583:				;
 584:				;
 585:				;	STEP FROM TRACK# IN B TOWARDS TRACK# IN C
 586:				;
 587:     -	F265          	STEP:
 588:10428+4	F265  78      		LD	A,B
 589:10432+11	F266  D341    		OUT	(TRKREG),A	;STARTING TRACK# TO TRACK REGISTER
 590:10443+4	F268  79      		LD	A,C
 591:10447+11	F269  D343    		OUT	(DATREG),A	;DESTINATION TRACK# TO DATA REGISTER
 592:10458+10	F26B  2128FF  		LD	HL,RATES
 593:10468+13	F26E  3A2CFF  		LD	A,(UNIT)
 594:10481+4	F271  85      		ADD	A,L
 595:10485+4	F272  6F      		LD	L,A		;INDEX INTO STEP RATE TABLE FOR DRIVE
 596:10489+7	F273  7E      		LD	A,(HL)
 597:     -	0001          	IF WD1772
 598:10496+7	F274  3E11    		ld	a, SKCMD+HLOAD+STEPRATE
 599:				ELSE
 602:				ENDIF
 603:10503+17	F276  CD59F3  		CALL	TYP1CMD		;DO SEEK WITH SPECIFIED STEP RATE
 604:10520+7	F279  7E      		LD	A,(HL)
 605:10527+7	F27A  E6FC    		AND	11111100B	;EXTRACT UPPER 6 BITS FOR SETTLE TIME
 606:10534+7	F27C  2600    		LD	H,0
 607:10541+4	F27E  6F      		LD	L,A
 608:10545+17	F27F  CD89F3  		CALL	WAIT		;4..256 MILLISECOND HEAD SETTLING DELAY
 609:10562+10	F282  C9      		RET
 610:				;
 611:				;
 612:				;
 613:				;
 614:     -	F283          	VERIFY:
 615:10572+7	F283  3EC0    		LD	A,RIDCMD
 616:10579+17	F285  CD50F3  		CALL	TYP2CMD		;READ NEXT ID MARK TO VERIFY SEEK
 617:     -	0001          	IF WD1772
 618:10596+7	F288  E618    		AND	00011000B	;WD1772, bit 7 reset by TYP2CMD!
 619:				ELSE
 621:				ENDIF
 622:10603+5+6	F28A  C8      		RET	Z		;EXIT IF ID MARK READ OK
 623:				
 624:10608+13	F28B  3A2FFF  		LD	A,(OUTCPY)
 625:10621+7	F28E  EE80    		XOR	10000000B	;COMPLIMENT DENSITY BIT OF DRIVE TYPE
 626:10628+13	F290  322FFF  		LD	(OUTCPY),A
 627:10641+11	F293  D330    		OUT	(LATCH),A
 628:10652+10	F295  213200  		LD	HL,50
 629:10662+17	F298  CD89F3  		CALL	WAIT		;ALLOW 50 MS DELAY AFTER CLOCK SWITCH
 630:10679+7	F29B  3EC0    		LD	A,RIDCMD
 631:10686+17	F29D  CD50F3  		CALL	TYP2CMD		;TRY AGAIN IN NEW DENSITY
 632:     -	0001          	IF WD1772
 633:10703+7	F2A0  E618    		AND	00011000B
 634:				ELSE
 636:				ENDIF
 637:10710+10	F2A2  C9      		RET			;A=0 IF AN ID MARK WAS FOUND
 638:				;
 639:				;
 640:				;
 641:				;
 642:				;
 643:				;
 644:     -	F2A3          	RWDISK:				;A=1797 TYPE 2 COMMAND BYTE
 645:10720+16	F2A3  2A6600  		LD	HL,(NMIVEC)
 646:10736+11	F2A6  E5      		PUSH	HL
 647:10747+16	F2A7  2A6800  		LD	HL,(NMIVEC+2)
 648:10763+11	F2AA  E5      		PUSH	HL		;SAVE 4 BYTES AT NMI VECTOR
 649:10774+10	F2AB  21EDA2  		LD	HL,0A2EDH	;LOAD HL WITH 'INI' OPCODE
 650:10784+8	F2AE  CB6F    		BIT	5,A		;TEST IF READ OR WRITE BEING DONE
 651:10792+7+5	F2B0  2801    		JR	Z,RW2		;JUMP IF COMMAND IS A READ
 652:10799+4	F2B2  24      		INC	H		;ELSE TRANSFORM 'INI' INTO 'OUTI'
 653:10803+16	F2B3  226600  	RW2:	LD	(NMIVEC),HL
 654:10819+10	F2B6  216800  		LD	HL,NMIVEC+2
 655:10829+10	F2B9  36C9    		LD	(HL),0C9H	;STORE 'RET' OPCODE AFTER INI/OUTI
 656:10839+4	F2BB  F3      		DI
 657:10843+7	F2BC  3EC7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 658:10850+11	F2BE  D383    		OUT	(CTC3),A	;ARM CTC3 FOR COUNTER MODE INTERRUPT
 659:10861+4	F2C0  AF      		XOR	A		;TIME CONSTANT OF 0 WHICH MEANS 256
 660:10865+11	F2C1  D383    		OUT	(CTC3),A	;COUNT 256 PULSES FROM CTC3
 661:10876+4	F2C3  FB      		EI
 662:10880+19	F2C4  DD6E04  		LD	L,(IX+DSKPTR)	;HL=DISK READ/WRITE DATA POINTER
 663:10899+19	F2C7  DD6605  		LD	H,(IX+DSKPTR+1)
 664:10918+19	F2CA  DD4606  		LD	B,(IX+DSKAUX)	;B=SECTOR LENGTH COUNT (LSB)
 665:10937+7	F2CD  0E43    		LD	C,DATREG	;C=DISK DATA PORT#
 666:10944+19	F2CF  DD7E07  		LD	A,(IX+DSKAUX+1)
 667:10963+8	F2D2  CB3F    		SRL	A
 668:10971+7+5	F2D4  280D    		JR	Z,RW256		;JUMP IF BLOCKSIZE <= 256 BYTES
 669:10978+8	F2D6  CB3F    		SRL	A
 670:10986+7+5	F2D8  2806    		JR	Z,RW512		;JUMP IF BLOCKSIZE <= 512 BYTES
 671:10993+4	F2DA  76      	RW1024:	HALT
 672:10997+7+5	F2DB  20FD    		JR	NZ,$-1
 673:11004+4	F2DD  76      		HALT
 674:11008+7+5	F2DE  20FD    		JR	NZ,$-1
 675:11015+4	F2E0  76      	RW512:	HALT
 676:11019+7+5	F2E1  20FD    		JR	NZ,$-1
 677:11026+4	F2E3  76      	RW256:	HALT
 678:11030+7+5	F2E4  20FD    		JR	NZ,$-1
 679:11037+11	F2E6  DB40    	RWBUSY:	IN	A,(STSREG)
 680:11048+8	F2E8  CB47    		BIT	0,A
 681:11056+7+5	F2EA  20FA    		JR	NZ,RWBUSY	;LOOP TILL 1797 BUSY BIT GOES AWAY
 682:11063+4	F2EC  47      		ld	b,a
 683:11067+17	F2ED  CDB6F3  		call	stoptmr
 684:11084+4	F2F0  78      		ld	a,b
 685:11088+10	F2F1  E1      	RWEXIT:	POP	HL
 686:11098+16	F2F2  226800  		LD	(NMIVEC+2),HL
 687:11114+10	F2F5  E1      		POP	HL
 688:11124+16	F2F6  226600  		LD	(NMIVEC),HL	;RESTORE CODE AT NMI
 689:     -	0001          	IF WD1772
 690:11140+7	F2F9  E67D    		AND	01111101B	;MASK FOR DISK ERRORS
 691:				ELSE
 693:				ENDIF
 694:11147+10	F2FB  C9      		RET			;RETURN WITH DISK ERROR FLAGS SET
 695:				;
 696:				;
 697:				;
 698:				;
 699:     -	F2FC          	RECOVER:
 700:11157+4	F2FC  47      		LD	B,A
 701:11161+7	F2FD  E6E7    		AND	11100111B	;MASK OFF ALL BUT RNF/CRC ERROR BITS
 702:11168+7+5	F2FF  2808    		JR	Z,RECOV1	;JUMP IF ONE OF THOSE TWO WERE SET
 703:				
 704:11175+11	F301  F5      		PUSH	AF
 705:11186+17	F302  CD7CF3  		CALL	FORCE		;RESET ERROR FLAGS IN 179X STATUS REG
 706:11203+10	F305  F1      		POP	AF
 707:     -	0001          	IF WD1772
 708:11213+7	F306  E661    		AND	01100001B	;CLEAR BITS ASSOCIATED WITH LOST DATA
 709:				ELSE
 711:				ENDIF
 712:11220+10	F308  C9      		RET			;RETURN WITH ACC=0 IF RETRY TO BE DONE
 713:				;
 714:11230+8	F309  CB60    	RECOV1:	BIT	4,B
 715:11238+7+5	F30B  2023    		JR	NZ,RECOV3	;JUMP IF RECORD-NOT-FOUND ERROR
 716:				;
 717:				;	ARRIVE HERE IF BAD CRC ERROR
 718:				;
 719:11245+13	F30D  3A33FF  	RECOV2:	LD	A,(RWMAX)
 720:11258+10	F310  21C6FF  		LD	HL,RWTRY
 721:11268+7	F313  96      		SUB	(HL)		;COMPUTE HOW MANY RETRYS HAVE BEEN DONE
 722:11275+5+6	F314  C8      		RET	Z		;EXIT IF FIRST RETRY
 723:				
 724:11280+13	F315  3A2DFF  		LD	A,(TRACK)	;ELSE PREPARE TO WIGGLE BACK AND FORTH
 725:11293+4	F318  47      		LD	B,A		; TO AN ADJACENT TRACK TO RE-CALIBRATE
 726:11297+4	F319  B7      		OR	A		; AND REMOVE POSSIBLE MEDIA CONTAMINANT
 727:11301+7+5	F31A  2004    		JR	NZ,RCOV2A
 728:11308+7	F31C  0E01    		LD	C, 1		;STEP TO TRACK#1 IF ON TRACK# 0
 729:11315+12	F31E  1802    		JR	RCOV2B
 730:				;
 731:11327+4	F320  3D      	RCOV2A:	DEC	A		;STEP TO NEXT OUTER TRACK
 732:11331+4	F321  4F      		LD	C,A
 733:11335+11	F322  C5      	RCOV2B:	PUSH	BC
 734:11346+17	F323  CD65F2  		CALL	STEP		;STEP HEAD TO ADJACENT TRACK
 735:11363+10	F326  D1      		POP	DE
 736:11373+4	F327  43      		LD	B,E		;EXCHANGE CONTENTS OF B AND C
 737:11377+4	F328  4A      		LD	C,D
 738:11381+17	F329  CD65F2  		CALL	STEP		;STEP BACK TO ORIGINAL TRACK
 739:11398+17	F32C  CD83F2  		call	verify
 740:11415+10	F32F  C9      		ret			;allow retry successful read id
 741:				;
 742:				;	ARRIVE HERE IF RECORD-NOT-FOUND ERROR
 743:				;
 744:11425+17	F330  CD83F2  	recov3:	call	verify		;read an id mark to verify position
 745:11442+7+5	F333  2012    		JR	NZ,RCOV4A	;RECALIBRATE IF VERIFY FAILS
 746:				
 747:11449+11	F335  DB41    		IN	A,(TRKREG)	;LOAD A WITH CURENT TRACK# UNDER HEAD
 748:11460+19	F337  DDBE02  		CP	(IX+DSKTRK)
 749:11479+7+5	F33A  200D    		JR	NZ,RCOV4B	;JUMP IF NOT ON CORRECT TRACK
 750:				;
 751:				;	ARRIVE HERE IF ON CORRECT TRACK
 752:				;
 753:11486+13	F33C  3A33FF  		ld	a,(rwmax)
 754:11499+10	F33F  21C6FF  		ld	hl,rwtry
 755:11509+7	F342  96      		sub	(hl)		;test if this is first retry after rnf error
 756:11516+5+6	F343  C8      		ret	z
 757:				
 758:11521+7	F344  3E10    		ld	a,00010000b
 759:11528+10	F346  C9      		ret			;indicate permanent rnf error
 760:				;
 761:				;	ARRIVE HERE IF HEAD POSITION IS INCORRECT
 762:				;
 763:11538+7	F347  3EFF    	RCOV4A:	LD	A,255		;SET A TO FORCE RESTORE BEFORE SEEK
 764:11545+13	F349  322DFF  	RCOV4B:	LD	(TRACK),A
 765:11558+17	F34C  CDE9F1  		CALL	SEEKTRK		;SEEK TRACK# SPECIFIED IN IOCB
 766:11575+10	F34F  C9      		RET
 767:				;
 768:				;
 769:				;
 770:				;
 771:				;	EXECUTE TYPE 2 COMMAND (READ/WRITE/READ ID) WITH TIMEOUT
 772:				;
 773:     -	F350          	TYP2CMD:
 774:11585+17	F350  CD74F3  		CALL	CMDOUT		;ISSUE COMMAND
 775:11602+11	F353  C5      		PUSH	BC
 776:11613+10	F354  016A18  		LD	BC,6250		;500,000/80 FOR ONE HALF SECOND DELAY
 777:11623+12	F357  1807    		JR	TPCMD2
 778:				;
 779:				;
 780:				;	EXECUTE TYPE 1 COMMAND (SEEK/STEP/RESTORE)
 781:				;
 782:     -	F359          	TYP1CMD:
 783:11635+17	F359  CD74F3  		CALL	CMDOUT
 784:11652+11	F35C  C5      		PUSH	BC
 785:11663+10	F35D  017C92  		LD	BC,37500	;3,000,000/80 FOR 3 SECONDS DELAY
 786:11673+11	F360  DB40    	TPCMD2:	IN	A,(STSREG)
 787:11684+8	F362  CB47    		BIT	0,A
 788:11692+7+5	F364  280A    		JR	Z,TPCMD3	;EXIT IF BUSY BIT GOES AWAY
 789:				
 790:11699+17	F366  CD76F3  		CALL	CMDT1		;DELAY 56 MICROSECONDS
 791:11716+6	F369  0B      		DEC	BC
 792:11722+4	F36A  78      		LD	A,B
 793:11726+4	F36B  B1      		OR	C
 794:11730+7+5	F36C  20F2    		JR	NZ,TPCMD2	;LOOP TAKES 80 MICROSECONDS
 795:				
 796:11737+7	F36E  3E10    		LD	A,00010000B
 797:				
 798:     -	F370          	TPCMD3:
 799:     -	0001          	IF WD1772
 800:11744+8	F370  CBBF    		res	7, a		;reset WD1797: drive not ready, WD1772: motor on!
 801:				ELSE
 805:				ENDIF
 806:11752+10	F372  C1      		POP	BC
 807:11762+10	F373  C9      		RET
 808:				;
 809:				;
 810:				;
 811:     -	F374          	CMDOUT:
 812:11772+11	F374  D340    		OUT	(CMDREG),A	;OUTPUT DISK CONTROLLER COMMAND BYTE
 813:11783+7	F376  3E0E    	CMDT1:	LD	A,14	
 814:11790+4	F378  3D      	CMDT2:	DEC	A
 815:11794+7+5	F379  20FD    		JR	NZ,CMDT2	;DELAY 56 MICROSECONDS
 816:11801+10	F37B  C9      		RET
 817:				;
 818:				;
 819:				;
 820:				;
 821:     -	F37C          	FORCE:
 822:     -	0001          	IF WD1772
 823:11811+11	F37C  DB41    		IN	a, (TRKREG)
 824:11822+11	F37E  D343    		OUT	(DATREG), a
 825:11833+7	F380  3E18    		LD	A,SKCMD+NOWAITMTR	;disable spinup HLOAD
 826:11840+12	F382  18D5    		jr	TYP1CMD		;CLEAR 179X AND LATCH READY/HLD/TK0 ETC
 827:				ELSE
 832:				ENDIF
 833:				;
 834:				;
 835:				;
 836:				;
 837:				;
 838:     -	F384          	HLDWAIT:
 839:11852+16	F384  2A32FF  		LD	HL,(HLDTIM)	;LOAD HL WITH HEAD LOAD DELAY
 840:11868+7	F387  2600    		LD	H,0		;RANGE 1..256 MILLISECONDS
 841:				
 842:11875+4	F389  AF      	WAIT:	XOR	A
 843:11879+4	F38A  3D      	WAIT2:	DEC	A
 844:11883+7+5	F38B  20FD    		JR	NZ,WAIT2	;DELAY 1 MILLISECOND
 845:11890+6	F38D  2B      		DEC	HL
 846:11896+4	F38E  7C      		LD	A,H
 847:11900+4	F38F  B5      		OR	L
 848:11904+7+5	F390  20F7    		JR	NZ,WAIT		;LOOP UNTIL HL=0
 849:11911+10	F392  C9      		RET
 850:				;
 851:				;
 852:				;
 853:				;	... CTC INTERRUPT CONTROL ROUTINES FOR DISK HANDLER ...
 854:				;
 855:				;
 856:				;
 857:     -	F393          	WATCHDOG:
 858:11921+7	F393  3ED0    		LD	A,FINCMD
 859:11928+11	F395  D340    		OUT	(CMDREG),A	;ABORT DISK CONTROLLER OPERATION
 860:11939+7	F397  3E01    		LD	A,00000001B
 861:11946+11	F399  D383    		OUT	(CTC3),A	;RESET INTERRUPT FROM CTC3
 862:11957+10	F39B  21F1F2  		LD	HL,RWEXIT
 863:11967+19	F39E  E3      		EX	(SP),HL		;TOSS RETURN ADDRESS AND PLANT FAKE ONE
 864:11986+7	F39F  3E10    		LD	A,00010000B
 865:11993+4	F3A1  B7      		OR	A		;INDICATE RECORD-NOT-FOUND ERROR
 866:11997+4	F3A2  FB      		EI
 867:12001+14	F3A3  ED4D    		RETI			;INSURE CTC IRQ LOGIC GETS RESTORED
 868:				;
 869:				;
 870:				;
 871:				;
 872:				;
 873:				;	... MILLISECOND TIMER INTERRUPT ROUTINES ...
 874:				;
 875:				;
 876:     -	F3A5          	STARTMR:
 877:12015+4	F3A5  F3      		DI
 878:12019+7	F3A6  3E87    		LD	A,10000111B
 879:12026+11	F3A8  D383    		OUT	(CTC3),A
 880:12037+7	F3AA  3EFA    		LD	A,250
 881:12044+11	F3AC  D383    		OUT	(CTC3),A
 882:12055+10	F3AE  21BDF3  		LD	HL,TMRIRQ
 883:12065+16	F3B1  2216FF  		LD	(CTCVEC+6),HL
 884:12081+4	F3B4  FB      		EI
 885:12085+10	F3B5  C9      		RET
 886:				;
 887:				;
 888:				;
 889:     -	F3B6          	STOPTMR:
 890:12095+4	F3B6  F3      		DI
 891:12099+7	F3B7  3E01    		LD	A,00000001B
 892:12106+11	F3B9  D383    		OUT	(CTC3),A
 893:12117+4	F3BB  FB      		EI
 894:12121+10	F3BC  C9      		RET
 895:				;
 896:				;
 897:				;
 898:     -	F3BD          	TMRIRQ:
 899:12131+11	F3BD  E5      		PUSH	HL
 900:12142+4	F3BE  FB      		EI
 901:12146+16	F3BF  2AC7FF  		LD	HL,(TICKS)
 902:12162+6	F3C2  23      		INC	HL		;BUMP FREE RUNING MILLISECOND COUNTER
 903:12168+16	F3C3  22C7FF  		LD	(TICKS),HL
 904:12184+10	F3C6  E1      		POP	HL
 905:12194+14	F3C7  ED4D    		RETI
 906:				;
 907:				;
 908:     -	0001          	IF WD1772
 909:12208+4	F3C9  00      		nop
 910:12212+4	F3CA  00      		nop
 911:12216+4	F3CB  00      		nop
 912:12220+4	F3CC  00      		nop
 913:12224+4	F3CD  00      		nop
 914:12228+4	F3CE  00      		nop
 915:12232+4	F3CF  00      		nop
 916:12236+4	F3D0  00      		nop
 917:12240+4	F3D1  00      		nop
 918:12244+4	F3D2  00      		nop
 919:12248+4	F3D3  00      		nop
 920:12252+4	F3D4  00      		nop
 921:12256+4	F3D5  00      		nop
 922:12260+4	F3D6  00      		nop
 923:12264+4	F3D7  00      		nop
 924:12268+4	F3D8  00      		nop
 925:12272+4	F3D9  00      		nop
 926:12276+4	F3DA  00      		nop
 927:12280+4	F3DB  00      		nop
 928:12284+4	F3DC  00      		nop
 929:12288+4	F3DD  00      		nop
 930:				ENDIF
**** ..\src\sally2.asm ****
  42:					INCLUDE	MINIMON.MAC
**** ..\src\MINIMON.MAC ****
   1:				;
   2:				;
   3:				;
   4:     -	F3DE          	MINIMON:
   5:12292+7	F3DE  3E01    		LD	A,1
   6:12299+11	F3E0  D352    		OUT	(BANKSW),A	;SWITCH TO ALL-RAM CONFIGURATION
   7:12310+17	F3E2  CDFCF5  		CALL	CONINIT		;INITIALIZE SERIAL CONSOLE PORT
   8:12327+17	F3E5  CDC9F4  		CALL	PNEXT
   9:     -	F3E8  0D0A    		DEFB	CR,LF
  10:     -	0001          	IF SALLYBUILD
  11:     -	F3EA  53616C6C		DEFB	"Sally2"
	              7932
  12:				ELSE
  14:				ENDIF
  15:     -	F3F0  00      		DEFB	NULL
  16:12344+10	F3F1  21F1F3  	PROMPT:	LD	HL,PROMPT
  17:12354+11	F3F4  E5      		PUSH	HL		;PUT RETURN ADDRESS ON STACK
  18:12365+17	F3F5  CDC9F4  		CALL	PNEXT
  19:     -	F3F8  0D0A2320		DEFB	CR,LF,'# ',NULL
	              00
  20:12382+17	F3FD  CDB2F4  		CALL	ECHO
  21:12399+7	F400  FE20    		CP	' '
  22:12406+5+6	F402  D8      		RET	C		;IGNORE NON-PRINTABLE CHATACTERS
  23:				
  24:12411+4	F403  4F      		LD	C,A		;SAVE COMMAND CHARACTER IN C
  25:12415+4	F404  AF      		XOR	A
  26:12419+4	F405  67      		LD	H,A
  27:12423+4	F406  6F      		LD	L,A
  28:12427+11	F407  29      	PROM1:	ADD	HL,HL		;MULTIPLY RESULT BY 16
  29:12438+11	F408  29      		ADD	HL,HL
  30:12449+11	F409  29      		ADD	HL,HL
  31:12460+11	F40A  29      		ADD	HL,HL
  32:12471+4	F40B  B5      		OR	L		;APPEND NEW LOW ORDER DIGIT
  33:12475+4	F40C  6F      		LD	L,A
  34:12479+17	F40D  CDB2F4  		CALL	ECHO		;GET A CHARACTER FROM LINE INPUT
  35:12496+7	F410  FE0D    		CP	CR
  36:12503+7+5	F412  280C    		JR	Z,PROM3		;EXIT LOOP IF RETURN TYPED
  37:12510+17	F414  CD83F4  		CALL	ASCHEX		;CONVERT ASCII TO NUMERIC
  38:12527+7+5	F417  30EE    		JR	NC,PROM1	;KEEP SHIFTING IF VALID HEX
  39:				
  40:12534+17	F419  CDC9F4  	PROM2:	CALL	PNEXT
  41:     -	F41C  203F00  		DEFB	' ?',NULL
  42:12551+10	F41F  C9      		RET
  43:				;
  44:12561+17	F420  CDD5F4  	PROM3:	CALL	CRLF
  45:12578+4	F423  79      		LD	A,C
  46:12582+7	F424  FE47    		CP	'G'
  47:12589+7+5	F426  2836    		JR	Z,GOTO		;DO GOTO IF 'G'
  48:12596+7	F428  FE42    		CP	'B'
  49:12603+7+5	F42A  2833    		JR	Z,BOOT		;DO BOOT LOADER IF 'B'
  50:12610+7	F42C  FE4D    		CP	'M'
  51:12617+7+5	F42E  20E9    		JR	NZ,PROM2	;***TEMP***
  52:				
  53:				;  **** This code section does not exist on production ROM ****
  54:				;	.COMMENT %
  55:				;	JR	Z,VIEW		;DO MEMORY EXAMINE/CHANGE IF 'M'
  56:				;	CP	'D'
  57:				;	JR	NZ,PROM2	;FALL INTO MEMORY DUMP IF 'D'
  58:				;
  59:				;
  60:				;
  61:				;	-- TABULAR MEMORY DUMP COMMAND --
  62:				;
  63:				;DUMP:
  64:				;	LD	C,16
  65:				;DUMP1:	PUSH	HL		;SAVE STARTING ADDRESS
  66:				;	CALL	PUT4HS		;PRINT STARTING ADDRESS IN HEX
  67:				;	LD	B,8
  68:				;DUMP2:	LD	A,(HL)		;GET A DATA BYTE @ HL
  69:				;	INC	HL
  70:				;	CALL	PUT2HS		;PRINT THE DATA IN HEX
  71:				;	DJNZ	DUMP2		;REPEAT 16 TIMES
  72:				;	POP	HL		;RESTORE STARTING ADDRESS
  73:				;	LD	B,8
  74:				;DUMP3:	LD	A,(HL)		;GET BACK DATA BYTE @ HL
  75:				;	INC	HL
  76:				;	RES	7,A
  77:				;	CP	20H
  78:				;	JR	C,DUMP4
  79:				;	CP	7FH
  80:				;	JR	C,DUMP5
  81:				;DUMP4:	LD	A,'.'		;PRINT A DOT IF DATA < 20 OR > 7F
  82:				;DUMP5:	CALL	OUTPUT		;PRINT ASCII CHARACTER IN A
  83:				;	DJNZ	DUMP3
  84:				;	CALL	CRLF
  85:				;	DEC	C
  86:				;	JR	NZ,DUMP1
  87:				;	RET
  88:				;
  89:				;
  90:				;	-- MEMORY EXAMINE COMMAND --
  91:				;
  92:     -	F430          	VIEW:
  93:12624+17	F430  CD93F4  		CALL	PUT4HS
  94:12641+7	F433  7E      		LD	A,(HL)
  95:12648+17	F434  CD98F4  		CALL	PUT2HS
  96:12665+17	F437  CDB2F4  		CALL	ECHO
  97:12682+7	F43A  FE0D    		CP	CR
  98:12689+7+5	F43C  2818    		JR	Z,VIEW4
  99:12696+7	F43E  FE2D    		CP	'-'
 100:12703+7+5	F440  2816    		JR	Z,VIEW5
 101:12710+17	F442  CD83F4  		CALL	ASCHEX
 102:12727+4	F445  3F      		CCF	
 103:12731+5+6	F446  D0      		RET	NC
 104:12736+4	F447  07      		RLCA	
 105:12740+4	F448  07      		RLCA	
 106:12744+4	F449  07      		RLCA	
 107:12748+4	F44A  07      		RLCA	
 108:12752+4	F44B  4F      		LD	C,A
 109:12756+17	F44C  CDB2F4  		CALL	ECHO
 110:12773+17	F44F  CD83F4  		CALL	ASCHEX
 111:12790+4	F452  3F      		CCF	
 112:12794+5+6	F453  D0      		RET	NC
 113:12799+4	F454  B1      		OR	C
 114:12803+7	F455  77      		LD	(HL),A
 115:12810+6	F456  23      	VIEW4:	INC	HL
 116:12816+6	F457  23      		INC	HL
 117:12822+6	F458  2B      	VIEW5:	DEC	HL
 118:12828+17	F459  CDD5F4  		CALL	CRLF
 119:12845+12	F45C  18D2    		JR	VIEW
 120:				;
 121:				;
 122:				;
 123:				;	-- JUMP TO MEMORY LOCATION COMMAND --
 124:				;
 125:     -	F45E          	GOTO:
 126:12857+4	F45E  E9      		JP	(HL)
 127:				;
 128:				;
 129:				;
 130:				;	-- DISK BOOT LOADER --
 131:				;
 132:     -	F45F          	BOOT:
 133:12861+14	F45F  DD217AF4		LD	IX,BOOTCB
 134:12875+17	F463  CD22F0  		CALL	DISKDVR		;ATTEMPT TO READ BOOT SECTOR
 135:12892+19	F466  DD7E08  		LD	A,(IX+DSKSTS)
 136:12911+4	F469  B7      		OR	A
 137:12915+10+7	F46A  CC8000  		CALL	Z,0080H		;EXECUTE BOOT IF NO ERRORS
 138:12925+11	F46D  F5      		PUSH	AF
 139:12936+17	F46E  CDC9F4  		CALL	PNEXT
 140:     -	F471  20455252		DEFB	' ERR ',NULL
	              2000
 141:12953+10	F477  F1      		POP	AF
 142:12963+12	F478  1825    		JR	PUT2HX
 143:				;
 144:				;
 145:     -	F47A  01      	BOOTCB:	DEFB	GETSEC
 146:     -	F47B  00      		DEFB	0
 147:     -	F47C  00      		DEFB	0
 148:     -	F47D  01      		DEFB	1
 149:     -	F47E  8000    		DEFW	0080H
 150:     -	F480  8000    		DEFW	128
 151:     -	F482  00      		DEFB	0
 152:				;
 153:				;
 154:				;
 155:     -	F483          	ASCHEX:
 156:12975+7	F483  D630    		SUB	'0'
 157:12982+5+6	F485  D8      		RET	C
 158:12987+7	F486  FE0A    		CP	10
 159:12994+4	F488  3F      		CCF
 160:12998+5+6	F489  D0      		RET	NC
 161:13003+7	F48A  D607    		SUB	7
 162:13010+7	F48C  FE0A    		CP	10
 163:13017+5+6	F48E  D8      		RET	C
 164:13022+7	F48F  FE10    		CP	16
 165:13029+4	F491  3F      		CCF
 166:13033+10	F492  C9      		RET
 167:				;
 168:				;
 169:				;
 170:     -	F493          	PUT4HS:
 171:13043+4	F493  7C      		LD	A,H
 172:13047+17	F494  CD9FF4  		CALL	PUT2HX
 173:13064+4	F497  7D      		LD	A,L
 174:     -	F498          	PUT2HS:
 175:13068+17	F498  CD9FF4  		CALL	PUT2HX
 176:13085+7	F49B  3E20    		LD	A,' '
 177:13092+12	F49D  181F    		JR	OUTPUT
 178:				;
 179:				;
 180:     -	F49F          	PUT2HX:
 181:13104+11	F49F  F5      		PUSH	AF
 182:13115+4	F4A0  1F      		RRA	
 183:13119+4	F4A1  1F      		RRA	
 184:13123+4	F4A2  1F      		RRA	
 185:13127+4	F4A3  1F      		RRA	
 186:13131+17	F4A4  CDA8F4  		CALL	PUTNIB
 187:13148+10	F4A7  F1      		POP	AF
 188:13158+7	F4A8  E60F    	PUTNIB:	AND	00001111B
 189:13165+7	F4AA  C690    		ADD	A,90H
 190:13172+4	F4AC  27      		DAA
 191:13176+7	F4AD  CE40    		ADC	A,40H
 192:13183+4	F4AF  27      		DAA
 193:13187+12	F4B0  180C    		JR	OUTPUT
 194:				;
 195:				;
 196:				;
 197:				;
 198:     -	F4B2          	ECHO:
 199:13199+11	F4B2  E5      		PUSH	HL
 200:13210+11	F4B3  C5      		PUSH	BC
 201:13221+17	F4B4  CD09F0  		CALL	CIV		;CALL CONSOLE INPUT VECTOR
 202:13238+10	F4B7  C1      		POP	BC
 203:13248+10	F4B8  E1      		POP	HL
 204:13258+8	F4B9  CBBF    		RES	7,A
 205:13266+7	F4BB  FE20    		CP	' '
 206:13273+5+6	F4BD  D8      		RET	C		;DO NOT ECHO CONTROL CHARACTERS
 207:				
 208:     -	F4BE          	OUTPUT:
 209:13278+11	F4BE  E5      		PUSH	HL
 210:13289+11	F4BF  C5      		PUSH	BC
 211:13300+11	F4C0  F5      		PUSH	AF
 212:13311+4	F4C1  4F      		LD	C,A
 213:13315+17	F4C2  CD0CF0  		CALL	COV		;CALL CONSOLE OUTPUT VECTOR
 214:13332+10	F4C5  F1      		POP	AF
 215:13342+10	F4C6  C1      		POP	BC
 216:13352+10	F4C7  E1      		POP	HL
 217:13362+10	F4C8  C9      		RET
 218:				;
 219:				;
 220:				;
 221:     -	F4C9          	PNEXT:
 222:13372+19	F4C9  E3      		EX	(SP),HL
 223:13391+7	F4CA  7E      	PNXT1:	LD	A,(HL)
 224:13398+17	F4CB  CDBEF4  		CALL	OUTPUT
 225:13415+7	F4CE  7E      		LD	A,(HL)
 226:13422+6	F4CF  23      		INC	HL
 227:13428+4	F4D0  B7      		OR	A
 228:13432+7+5	F4D1  20F7    		JR	NZ,PNXT1
 229:13439+19	F4D3  E3      		EX	(SP),HL
 230:13458+10	F4D4  C9      		RET
 231:				;
 232:				;
 233:				;
 234:13468+17	F4D5  CDC9F4  	CRLF:	CALL	PNEXT
 235:     -	F4D8  0D0A00  		DEFB	CR,LF,NULL
 236:13485+10	F4DB  C9      		RET
 237:				;
 238:				;
 239:				;
**** ..\src\sally2.asm ****
  43:					INCLUDE	PRINTER.MAC
**** ..\src\PRINTER.MAC ****
   1:				;
   2:				;
   3:				;	... PARALLEL PRINTER OUTPUT ROUTINE ...
   4:				;
   5:     -	F4DC          	CENTOUT:
   6:				
   7:13495+4	F4DC  79      		LD	A,C
   8:13499+11	F4DD  D320    		OUT	(PRINTER),A	;OUTPUT DATA BYTE TO PRINTER
   9:13510+19	F4DF  E3      		EX	(SP),HL
  10:13529+19	F4E0  E3      		EX	(SP),HL
  11:13548+7	F4E1  3E19    		LD	A,25
  12:13555+11	F4E3  D353    		OUT	(STROBE),A
  13:13566+4	F4E5  3D      	CENT2:	DEC	A
  14:13570+7+5	F4E6  20FD    		JR	NZ,CENT2
  15:13577+11	F4E8  D353    		OUT	(STROBE),A	;TWANG THE STROBE
  16:13588+10	F4EA  C9      		RET
  17:				;
  18:				;
  19:				;
  20:     -	F4EB          	CENTRDY:
  21:13598+16	F4EB  2A47FF  		LD	HL,(PMASKS)
  22:13614+11	F4EE  DB20    		IN	A,(PRINTER)
  23:13625+4	F4F0  A5      		AND	L		;MASK BITS WITH 'AND'
  24:13629+4	F4F1  AC      		XOR	H		;COMPARE WITH 'XOR'
  25:13633+10	F4F2  C9      		RET			;ACC=0 IF PRINTER IS READY
  26:				;
  27:				;
  28:				;
  29:				;
**** ..\src\sally2.asm ****
  44:     -	F4F3  95      			DEFB 95h                ; **** Exists on original ROM? ****
  45:     -	0001          	IF SALLYBUILD
  46:     -	F4F4  00000000			dw	0, 0, 0, 0, 0, 0
	              00000000
	              00000000
  47:				ELSE
  49:				ENDIF	;SALLYBUILD
  50:					INCLUDE	SERIAL.MAC
**** ..\src\SERIAL.MAC ****
   1:				;
   2:				;
   3:				;
   4:				;	... BAUDRATE AND TIMING CONSIDERATIONS ...
   5:				;
   6:				;	THE FOLLOWING TABLE DETAILS THE BIT TIMES FOR THE BAUDRATES
   7:				;    SUPPORTED BY THE ATR-8000 AND THE CTC PROGRAMMING PARAMETERS
   8:				;    REQUIRED TO GENERATE THEM USING THE CTC IN THE TIMER MODE.
   9:				;    (IE. BY DIVIDING DOWN THE 4MHZ CLOCK WITH 16 OR 256 PRESCALE.)
  10:				;
  11:				;	BAUD      PERIOD    MODULUS   PRESCALE
  12:				;	----      ------    -------   --------
  13:				;      19200        52 us      13        16
  14:				;	9600       104 us      26        16
  15:				;	4800       208 us      52        16
  16:				;	2400       416 us     104        16
  17:				;	1200       832 us     208        16
  18:				;	 600      1664 us      26       256
  19:				;	 300      3328 us      52       256
  20:				;	 150      6656 us     104       256
  21:				;	  75     13312 us     208       256
  22:				;
  23:				;
  24:				;
  25:				;
  26:				;	... INTERRUPT SERVICE ROUTINES FOR SERIAL CONSOLE INPUT ...
  27:				;
  28:				;	AVERAGE EXECUTION TIME = 24.55 us FOR INTERRUPT SERVICE
  29:				;				  4.75 us FOR INTERRUPT ACKNOWLEDGE
  30:				;				 ------
  31:				;				 29.30 us PER BIT
  32:				;
  33:				;
  34:				;	*** START BAGE BOUNDARY RESTRICTIONS ***
  35:				;
  36:     -	F500          	CONPAGE	EQU	$
  37:				;
  38:				;
  39:     -	F500          	RXSTART:
  40:13643+11	F500  F5      		PUSH	AF
  41:13654+7	F501  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  42:13661+11	F503  D380    		OUT	(CTC0),A		;RESET CTC AND PROGRAM FOR TIMER MODE
  43:13672+7	F505  3E1A    		LD	A,26			;TIME CONSTANT OF 26 - exactly 104us WHICH IS 9600 BAUD
  44:     -	F506          	RXBAUD	EQU	$-1			;BAUDRATE PARAM IS STORED HERE
  45:13679+11	F507  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  46:13690+7	F509  3E17    		LD	A,LOW RXDATA
  47:13697+13	F50B  3210FF  		LD	(CTCVEC),A
  48:13710+7	F50E  3E7F    		LD	A,01111111B		;7 DATA BITS
  49:13717+13	F510  321CF5  	RXDAT2:	LD	(RXTEMP),A	;SET DATA SHIFTER TO ALL ONES
  50:13730+10	F513  F1      		POP	AF
  51:13740+4	F514  FB      		EI
  52:13744+14	F515  ED4D    		RETI				;EXECUTION TIME = 115 CLOCK CYCLES
  53:				;
  54:				;
  55:				;
  56:     -	F517          	RXDATA:
  57:13758+11	F517  F5      		PUSH	AF
  58:13769+11	F518  DB70    		IN	A,(ATARI)		;READ SERIAL INPUT BIT STREAM
  59:13780+4	F51A  17      		RLA					;SHIFT DATA BIT (=MSB) INTO CARRY
  60:13784+7	F51B  3E00    		LD	A,NULL			;LOAD A WITH PARTIAL DATA BYTE - NOTE THAT THIS VALUE RESETS AT LABEL RXDAT2
  61:     -	F51C          	RXTEMP	EQU	$-1
  62:13791+4	F51D  1F      		RRA					;SHIFT NEW BIT IN AND ONES OUT
  63:13795+7+5	F51E  38F0    		JR	C,RXDAT2
  64:				
  65:13802+13	F520  3200FF  		LD	(KEYBUF),A		;STORE CHARACTER IN CIRCULAR BUFFER
  66:     -	F521          	RXINP	EQU	$-2
  67:13815+7	F523  3E2C    		LD	A,LOW RXSTOP
  68:13822+13	F525  3210FF  		LD	(CTCVEC),A		;ADVANCE TO STOP BIT STATE
  69:13835+10	F528  F1      		POP	AF
  70:13845+4	F529  FB      		EI
  71:13849+14	F52A  ED4D    		RETI				;EXECUTION TIME = 105 CYCLES
  72:				;
  73:				;
  74:				;
  75:     -	F52C          	RXSTOP:
  76:13863+11	F52C  F5      		PUSH	AF
  77:13874+7	F52D  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  78:13881+11	F52F  D380    		OUT	(CTC0),A		;ENABLE INTERRUPT FROM START BIT
  79:13892+7	F531  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
  80:13899+11	F533  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT
  81:13910+13	F535  3A21F5  		LD	A,(RXINP)
  82:13923+4	F538  3C      		INC	A
  83:13927+7	F539  E60F    		AND	00001111B		;BUMP BUFFER POINTER MODULO 16
  84:13934+13	F53B  3221F5  		LD	(RXINP),A
  85:13947+7	F53E  3E00    		LD	A,LOW RXSTART
  86:13954+13	F540  3210FF  		LD	(CTCVEC),A		;SET VECTOR BACK TO START BIT CODE
  87:13967+10	F543  F1      		POP	AF
  88:13977+4	F544  FB      		EI
  89:13981+14	F545  ED4D    		RETI				;EXECUTION TIME = 132 CYCLES
  90:				;
  91:				;
  92:				;
  93:				;
  94:				;	... INTERRUPT ROUTINES FOR SERIAL DATA OUTPUT ...
  95:				;
  96:     -	F547          	TXSTART:
  97:13995+11	F547  F5      		PUSH	AF
  98:14006+4	F548  AF      		XOR	A
  99:14010+11	F549  D350    		OUT	(ATROUT),A	;SEND COMPLIMENT OF MARK AS START BIT
 100:14021+7	F54B  3E54    		LD	A,LOW TXDAT0
 101:14028+13	F54D  3212FF  		LD	(CTCVEC+2),A	;SET INTERRUPT VECTOR FOR DATA BIT 0
 102:14041+10	F550  F1      		POP	AF
 103:14051+4	F551  FB      		EI
 104:14055+14	F552  ED4D    		RETI
 105:				;
 106:				;
 107:				;
 108:				;
 109:				;
 110:     -	F554          	TXDAT0:
 111:14069+11	F554  F5      		PUSH	AF
 112:14080+7	F555  3E00    		LD	A,NULL
 113:     -	F556          	TXTMP0	EQU	$-1
 114:14087+11	F557  D350    		OUT	(ATROUT),A	;OUTPUT LSB OF SERIAL DATA TO CONSOLE
 115:14098+4	F559  1F      		RRA
 116:14102+13	F55A  3268F5  		LD	(TXTMP1),A	;SHIFT RIGHT TO PREPARE FOR NEXT BIT
 117:14115+7	F55D  3E66    		LD	A,LOW TXDAT1
 118:14122+13	F55F  3212FF  		LD	(CTCVEC+2),A	;DINK WITH VECTOR FOR NEXT TIME
 119:14135+10	F562  F1      		POP	AF
 120:14145+4	F563  FB      		EI
 121:14149+14	F564  ED4D    		RETI			;EXECUTION TIME = 94 CYCLES
 122:				;
 123:				;
 124:     -	F566          	TXDAT1:
 125:14163+11	F566  F5      		PUSH	AF
 126:14174+7	F567  3E00    		LD	A,NULL
 127:     -	F568          	TXTMP1	EQU	$-1
 128:14181+11	F569  D350    		OUT	(ATROUT),A
 129:14192+4	F56B  1F      		RRA
 130:14196+13	F56C  327AF5  		LD	(TXTMP2),A
 131:14209+7	F56F  3E78    		LD	A,LOW TXDAT2
 132:14216+13	F571  3212FF  		LD	(CTCVEC+2),A
 133:14229+10	F574  F1      		POP	AF
 134:14239+4	F575  FB      		EI
 135:14243+14	F576  ED4D    		RETI
 136:				;
 137:				;
 138:     -	F578          	TXDAT2:
 139:14257+11	F578  F5      		PUSH	AF
 140:14268+7	F579  3E00    		LD	A,NULL
 141:     -	F57A          	TXTMP2	EQU	$-1
 142:14275+11	F57B  D350    		OUT	(ATROUT),A
 143:14286+4	F57D  1F      		RRA
 144:14290+13	F57E  328CF5  		LD	(TXTMP3),A
 145:14303+7	F581  3E8A    		LD	A,LOW TXDAT3
 146:14310+13	F583  3212FF  		LD	(CTCVEC+2),A
 147:14323+10	F586  F1      		POP	AF
 148:14333+4	F587  FB      		EI
 149:14337+14	F588  ED4D    		RETI
 150:				;
 151:				;
 152:     -	F58A          	TXDAT3:
 153:14351+11	F58A  F5      		PUSH	AF
 154:14362+7	F58B  3E00    		LD	A,NULL
 155:     -	F58C          	TXTMP3	EQU	$-1
 156:14369+11	F58D  D350    		OUT	(ATROUT),A
 157:14380+4	F58F  1F      		RRA
 158:14384+13	F590  329EF5  		LD	(TXTMP4),A
 159:14397+7	F593  3E9C    		LD	A,LOW TXDAT4
 160:14404+13	F595  3212FF  		LD	(CTCVEC+2),A
 161:14417+10	F598  F1      		POP	AF
 162:14427+4	F599  FB      		EI
 163:14431+14	F59A  ED4D    		RETI
 164:				;
 165:				;
 166:     -	F59C          	TXDAT4:
 167:14445+11	F59C  F5      		PUSH	AF
 168:14456+7	F59D  3E00    		LD	A,NULL
 169:     -	F59E          	TXTMP4	EQU	$-1
 170:14463+11	F59F  D350    		OUT	(ATROUT),A
 171:14474+4	F5A1  1F      		RRA
 172:14478+13	F5A2  32B0F5  		LD	(TXTMP5),A
 173:14491+7	F5A5  3EAE    		LD	A,LOW TXDAT5
 174:14498+13	F5A7  3212FF  		LD	(CTCVEC+2),A
 175:14511+10	F5AA  F1      		POP	AF
 176:14521+4	F5AB  FB      		EI
 177:14525+14	F5AC  ED4D    		RETI
 178:				;
 179:				;
 180:     -	F5AE          	TXDAT5:
 181:14539+11	F5AE  F5      		PUSH	AF
 182:14550+7	F5AF  3E00    		LD	A,NULL
 183:     -	F5B0          	TXTMP5	EQU	$-1
 184:14557+11	F5B1  D350    		OUT	(ATROUT),A
 185:14568+4	F5B3  1F      		RRA
 186:14572+13	F5B4  32C2F5  		LD	(TXTMP6),A
 187:14585+7	F5B7  3EC0    		LD	A,LOW TXDAT6
 188:14592+13	F5B9  3212FF  		LD	(CTCVEC+2),A
 189:14605+10	F5BC  F1      		POP	AF
 190:14615+4	F5BD  FB      		EI
 191:14619+14	F5BE  ED4D    		RETI
 192:				;
 193:				;
 194:     -	F5C0          	TXDAT6:
 195:14633+11	F5C0  F5      		PUSH	AF
 196:14644+7	F5C1  3E00    		LD	A,NULL
 197:     -	F5C2          	TXTMP6	EQU	$-1
 198:14651+11	F5C3  D350    		OUT	(ATROUT),A
 199:14662+4	F5C5  1F      		RRA
 200:14666+13	F5C6  32D4F5  		LD	(TXTMP7),A
 201:14679+7	F5C9  3ED2    		LD	A,LOW TXDAT7
 202:14686+13	F5CB  3212FF  		LD	(CTCVEC+2),A
 203:14699+10	F5CE  F1      		POP	AF
 204:14709+4	F5CF  FB      		EI
 205:14713+14	F5D0  ED4D    		RETI
 206:				;
 207:				;
 208:				;
 209:     -	F5D2          	TXDAT7:
 210:14727+11	F5D2  F5      		PUSH	AF
 211:14738+7	F5D3  3E00    		LD	A,NULL
 212:     -	F5D4          	TXTMP7	EQU	$-1
 213:14745+11	F5D5  D350    		OUT	(ATROUT),A	;SEND LAST BIT WITHOUT SHIFTING AFTER
 214:14756+7	F5D7  3EE0    		LD	A,LOW TXSTOP
 215:14763+13	F5D9  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR STOP BIT NEXT TIME
 216:14776+10	F5DC  F1      		POP	AF
 217:14786+4	F5DD  FB      		EI
 218:14790+14	F5DE  ED4D    		RETI
 219:				;
 220:				;
 221:				;
 222:     -	F5E0          	TXSTOP:
 223:14804+11	F5E0  F5      		PUSH	AF
 224:14815+7	F5E1  3E01    		LD	A,1
 225:14822+11	F5E3  D350    		OUT	(ATROUT),A
 226:14833+7	F5E5  3EEE    		LD	A,LOW TXEXIT
 227:14840+13	F5E7  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR TO CLEAR TX BUSY FLAG
 228:14853+10	F5EA  F1      		POP	AF
 229:14863+4	F5EB  FB      		EI
 230:14867+14	F5EC  ED4D    		RETI
 231:				;
 232:				;
 233:     -	F5EE          	TXEXIT:
 234:14881+11	F5EE  F5      		PUSH	AF
 235:14892+7	F5EF  3E01    		LD	A,00000001B
 236:14899+11	F5F1  D381    		OUT	(CTC1),A	;DISABLE INTERRUPT FROM XMIT BAUDRATE
 237:14910+7	F5F3  3EFF    		LD	A,255
 238:14917+13	F5F5  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR SO BACKGROUND MONITOR IRQ
 239:14930+10	F5F8  F1      		POP	AF
 240:14940+4	F5F9  FB      	RETI1:	EI
 241:14944+14	F5FA  ED4D    		RETI
 242:				;
 243:				;
 244:     -	0000          		IF	(HIGH CONPAGE) NE (HIGH $)
 246:					ENDIF
 247:				;
 248:				;
 249:				;
 250:				;	*** END PAGE BOUNDARY RESTRICTIONS ***
 251:				;
 252:				;
 253:				;
 254:     -	F5FC          	CONINIT:
 255:14958+4	F5FC  F3      		DI
 256:14962+10	F5FD  21EEF5  		LD	HL,TXEXIT
 257:14972+16	F600  2212FF  		LD	(CTCVEC+2),HL
 258:14988+7	F603  3E07    		LD	A,00000111B
 259:14995+11	F605  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 260:15006+13	F607  3A06F5  		LD	A,(RXBAUD)
 261:15019+11	F60A  D381    		OUT	(CTC1),A	;DIVIDE BY 26 GIVES 9600 BAUD
 262:				
 263:15030+10	F60C  2100FF  		LD	HL,KEYBUF
 264:15040+16	F60F  2221F5  		LD	(RXINP),HL	;RESET RX FIFO IN/OUT POINTERS
 265:15056+16	F612  2233F6  		LD	(RXOUT),HL
 266:     -	F615          	CINIT2:
 267:15072+4	F615  F3      		DI			;ALTERNATE ENTRY FROM 'DISKIO'
 268:15076+7	F616  3E01    		LD	A,1
 269:15083+11	F618  D357    		OUT	(CDMUX),A	;SET MUX TO ENABLE DATA TO CTC0
 270:15094+7	F61A  067E    	CINIT3:	LD	B,126
 271:15101+11	F61C  DB70    	CINIT4:	IN	A,(ATARI)
 272:15112+4	F61E  17      		RLA
 273:15116+7+5	F61F  30F9    		JR	NC,CINIT3		;RE-LOAD COUNT IN B IF INPUT LOW
 274:15123+8+5	F621  10F9    		DJNZ	CINIT4		;ELSE LOOP FOR ONE 9600 BAUD CHAR TIME
 275:				
 276:15131+7	F623  3EC7    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
 277:15138+11	F625  D380    		OUT	(CTC0),A		;PROGRAM RX CTC IN COUNTER MODE
 278:15149+7	F627  3E01    		LD	A,1				;SET TIME CONSTANT TO 1 - 6.5us
 279:15156+11	F629  D380    		OUT	(CTC0),A		;PROGRAM THE TIME CONSTANT AND INTERRUPT ON NEXT START BIT
 280:15167+10	F62B  2100F5  		LD	HL,RXSTART
 281:15177+16	F62E  2210FF  		LD	(CTCVEC),HL
 282:15193+4	F631  FB      		EI
 283:15197+10	F632  C9      		RET
 284:				;
 285:				;
 286:     -	F633  00FF    	RXOUT:	DEFW	KEYBUF		;KEYBOARD BUFFER OUTPUT POINTER
 287:				;
 288:				;
 289:     -	F635          	CONST:
 290:15207+10	F635  2133F6  		LD	HL,RXOUT
 291:15217+13	F638  3A21F5  		LD	A,(RXINP)
 292:15230+7	F63B  96      		SUB	(HL)
 293:15237+5+6	F63C  C8      		RET	Z		;A=0 IF NO DATA AVAILABLE
 294:				
 295:15242+7	F63D  3EFF    		LD	A,255
 296:15249+10	F63F  C9      		RET
 297:				;
 298:				;
 299:				;
 300:     -	F640          	CONIN:
 301:15259+17	F640  CD35F6  		CALL	CONST
 302:15276+7+5	F643  28FB    		JR	Z,CONIN
 303:				
 304:15283+16	F645  2A33F6  		LD	HL,(RXOUT)
 305:15299+7	F648  7E      		LD	A,(HL)		;GET RECEIVED DATA FROM FIFO
 306:15306+4	F649  2C      		INC	L
 307:15310+8	F64A  CBA5    		RES	4,L		;INCREMENT HL MODULO 16
 308:15318+16	F64C  2233F6  		LD	(RXOUT),HL
 309:15334+10	F64F  C9      		RET
 310:				;
 311:				;
 312:				;
 313:     -	F650          	CONOUT:
 314:15344+13	F650  3A12FF  		LD	A,(CTCVEC+2)
 315:15357+7	F653  FEEE    		CP	LOW TXEXIT
 316:15364+7+5	F655  38F9    		JR	C,CONOUT	;LOOP TILL WE REACH 'TEXIT' OR HIGHER
 317:				
 318:15371+4	F657  79      		LD	A,C
 319:15375+7	F658  E67F    		AND	01111111B	;CLEAR BIT 7 AND SET FLAGS
 320:15382+10	F65A  E25FF6  		JP	PO,COUT2
 321:15392+7	F65D  F680    		OR	10000000B
 322:15399+13	F65F  3256F5  	COUT2:	LD	(TXTMP0),A	;STORE RESULTING CHARACTER FOR XMIT
 323:15412+7	F662  3E47    		LD	A,LOW TXSTART
 324:15419+13	F664  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR FOR START BIT INTERRUPT
 325:15432+7	F667  3E81    		LD	A,10000001B
 326:15439+11	F669  D381    		OUT	(CTC1),A	;PROGRAM TX CTC IN TIMER MODE
 327:15450+10	F66B  C9      		RET
 328:				;
 329:				;
 330:				;
**** ..\src\sally2.asm ****
  51:				;
  52:				;	CODE PAST THIS POINT IS ONLY USED IN ATARI DISK MODE
  53:				;
  54:					INCLUDE	BITBANG.MAC
**** ..\src\BITBANG.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	19200 BAUD SERIAL I/O FOR ATARI COMM PORT	*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:				;
   8:				;	19200 BAUD SERIAL I/O IS HALF DUPLEX DUE TO OBVIOUS
   9:				;	TIMING CONSTRAINTS. ALL TRANSFERS ARE DONE FROM 4K PAGE
  10:				;	ALIGNED BUFFER 'IOBUFF', WITH BLOCK START ADDRESS
  11:				;	ARRANGED SO END-OF-BLOCK CONDITION IS MET WHEN POINTER
  12:				;	ROLLS OVER THE NEXT EVEN PAGE BYTE BOUNDARY.
  13:				;
  14:				;	CALL WITH BLOCK START POINTER IN HL ,DATA POLARITY MASK
  15:				;	IN D (WHERE D=0 TRUE DATA, D=FF INVERTED DATA) AND
  16:				;	'C' OR 'E' HANDSHAKE CHARACTER IN E.
  17:				;
  18:				;
  19:     -	F66C          	SENDBUFF:
  20:15460+11	F66C  E5      		PUSH	HL		;SAVE DATA BLOCK POINTER
  21:15471+11	F66D  D5      		PUSH	DE		;SAVE POLARITY MASK FOR DATA
  22:15482+10	F66E  2101C3  		LD	HL,IOBUFF+LEN+1
  23:15492+7	F671  73      		LD	(HL),E
  24:15499+7	F672  1600    		LD	D,0
  25:15506+17	F674  CD84F6  		CALL	XMITBUF		;SEND 'C' OR 'E' CHARACTER FROM E
  26:15523+10	F677  D1      		POP	DE
  27:15533+10	F678  E1      		POP	HL
  28:15543+7	F679  1E00    		LD	E,0
  29:15550+17	F67B  CD84F6  		CALL	XMITBUF		;THEN SEND DATA BLOCK TO ATARI
  30:15567+10	F67E  2101C3  		LD	HL,IOBUFF+LEN+1
  31:15577+7	F681  73      		LD	(HL),E		;FALL THROUGH TO SEND CHECKSUM
  32:15584+7	F682  1600    		LD	D,0
  33:				;
  34:				;	CALL WITH DATA BLOCK POINTER IN HL.
  35:				;	PRESERVES MASK/CKECKSUM IN D/E.
  36:				;
  37:     -	F684          	XMITBUF:
  38:15591+4	F684  F3      		DI
  39:15595+10	F685  0119F7  		LD	BC,STARBIT
  40:     -	F688          	SalyXMITBUF:
  41:15605+20	F688  ED4312FF		LD	(CTCVEC+2),BC	;SET UP INITIAL INTERRUPT VECTOR
  42:15625+7	F68C  0608    		LD	B,8
  43:15632+7	F68E  3E87    		LD	A, CTC_D7_INT_EN + CTC_D6_MODE_TIM + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL
  44:15639+11	F690  D381    		OUT	(CTC1),A		;PROGRAM CTC1 TO INTERRUPT AT BIT RATE
  45:15650+7	F692  3E0D    		LD	A,13			;SET TIME CONSTANT TO 13 - 52us. EXACT IS 52.083us
  46:15657+11	F694  D381    		OUT	(CTC1),A		;COUNT 13*(16*250 NS) GIVES 19200 BAUD WITH 0.16% ERROR
  47:15668+4	F696  FB      		EI
  48:15672+12	F697  18FE    		JR	$		;SPIN HERE TILL INTERRUPTS GET US OUT
  49:				;
  50:				;
  51:				;
  52:				;
  53:				;
  54:				;
  55:				;	... INTERRUPT FOR COMMAND INPUT HIGH->LOW TRANSITION ..
  56:				;
  57:     -	F699          	CSTART:
  58:15684+4	F699  08      		EX	AF,AF'
  59:15688+4	F69A  D9      		EXX
  60:15692+7	F69B  3EFF    		LD	A,255
  61:15699+13	F69D  3255FF  		LD	(CMDFLG),A	;SET 'CMDFLG' FLAG TO ERROR STATE FIRST
  62:15712+11	F6A0  D357    		OUT	(CDMUX),A	;SWITCH MUX TO ENABLE SERIAL DATA IRQ
  63:15723+10	F6A2  21FBC2  		LD	HL,IOBUFF+LEN-5	;POINT DE 5 BYTES BEFORE END OF BUFFER
  64:15733+17	F6A5  CDD9F6  		CALL	RXBLOCK		;ATTEMPT TO RECEIVE COMMAND FRAME
  65:15750+7+5	F6A8  300A    		JR	NC,CSTRT1	;JUMP IF NO DATA HAPPENED
  66:				
  67:15757+6	F6AA  2B      		DEC	HL
  68:15763+7	F6AB  7E      		LD	A,(HL)
  69:15770+4	F6AC  B9      		CP	C		;COMPARE DERRIVED AND RECVD CHECKSUMS
  70:15774+7+5	F6AD  2005    		JR	NZ,CSTRT1	;JUMP IF CHECKSUM ERROR
  71:				
  72:15781+7	F6AF  3E01    		LD	A,1
  73:15788+13	F6B1  3255FF  		LD	(CMDFLG),A	;SET FLAG IF GOOD COMMAND FRAME
  74:15801+4	F6B4  08      	CSTRT1:	EX	AF,AF'
  75:15805+4	F6B5  D9      		EXX
  76:15809+4	F6B6  FB      		EI
  77:15813+14	F6B7  ED4D    		RETI
  78:				;
  79:				;
  80:				;
  81:				;	... DATA FRAME RECEIVE SUBROUTINE ...
  82:				;
  83:     -	F6B9          	RECVBUFF:
  84:15827+4	F6B9  F3      		DI
  85:15831+10	F6BA  2100C1  		LD	HL,IOBUFF
  86:15841+17	F6BD  CDD9F6  		CALL	RXBLOCK		;BITBANG A BLOCK OF INPUT DATA
  87:15858+4	F6C0  FB      		EI
  88:15862+7+5	F6C1  380D    		JR	C,RBUFF2	;JUMP IF BUFFER OVERFLOWED
  89:				
  90:15869+6	F6C3  2B      		DEC	HL
  91:15875+7	F6C4  7E      		LD	A,(HL)
  92:15882+4	F6C5  B9      		CP	C
  93:15886+7+5	F6C6  2008    		JR	NZ,RBUFF2	;JUMP IF CHECKSUMS DON'T AGREE
  94:				
  95:15893+10	F6C8  1100C1  		LD	DE,IOBUFF
  96:15903+4	F6CB  B7      		OR	A
  97:15907+15	F6CC  ED52    		SBC	HL,DE		;ELSE COMPUTE LENGTH OF BLOCK LESS
  98:15922+4	F6CE  AF      		XOR	A		; CHECKSUM BYTE AND RETURN WITH
  99:15926+10	F6CF  C9      		RET			; RESULT IN HL AND ZERO FLAG SET
 100:				;
 101:15936+7	F6D0  3E4E    	RBUFF2:	LD	A,'N'
 102:15943+17	F6D2  CD56FC  		CALL	SENDCHAR	;SEND 'NAK' FOR BAD DATA FRAME
 103:15960+7	F6D5  3EFF    		LD	A,255
 104:15967+4	F6D7  B7      		OR	A
 105:15971+10	F6D8  C9      		RET			;RETURN WITH ACC SET NON=ZERO
 106:				;
 107:				;
 108:				;
 109:				;
 110:				;
 111:				;	... BITBANG INPUT SUBROUTINE ...
 112:				;
 113:				;	CALL WITH BLOCK START POINTER IN HL. RETURNS WITH
 114:				;	HL POINTING TO LAST BYTE+1 OF BLOCK RECEIVED.
 115:				;	THE CARRY BIT IS SET IF THE BUFFER FILLED UP BEFORE
 116:				;	THE BIT STREAM STOPPED.
 117:				;
 118:				;
 119:     -	F6D9          	RXBLOCK:
 120:15981+10	F6D9  11AA0A  		LD	DE,2730		;SET ABORT COUNTER FOR 32 MILLISECONDS
 121:     -	F6DC          	SalyRXBLOCK:
 122:15991+10	F6DC  010000  		LD	BC,0		;CLEAR B/C FOR CHECKSUM DERRIVATION
 123:16001+12	F6DF  1823    		JR	RXB35		;GO START LOOPING FOR START BIT
 124:				;
 125:16013+4	F6E1  79      	RXB1:	LD	A,C
 126:16017+4	F6E2  80      		ADD	A,B
 127:16021+7	F6E3  CE00    		ADC	A,0		;ACCUMULATE CHECKSUM ATARI STYLE
 128:16028+4	F6E5  4F      		LD	C,A
 129:16032+19	F6E6  E3      		EX	(SP),HL
 130:16051+19	F6E7  E3      		EX	(SP),HL
 131:16070+19	F6E8  E3      		EX	(SP),HL
 132:16089+19	F6E9  E3      		EX	(SP),HL
 133:16108+7	F6EA  0608    		LD	B,8
 134:				;
 135:				;	SERIAL->PARALLEL CONVERSION AT 52 MICROSECONDS PER BIT
 136:				;
 137:16115+7	F6EC  3E0B    	RXB2:	LD	A,11		;  7 CYCLES
 138:16122+7	F6EE  3E0B    		LD	A,11		;  7 CYCLES
 139:16129+4	F6F0  00      		NOP			;  4 CYCLES
 140:16133+4	F6F1  3D      	RXB3:	DEC	A		; 44 CYCLES  (11*4)
 141:16137+10	F6F2  C2F1F6  		JP	NZ,RXB3		;110 CYCLES  (11*10)
 142:16147+11	F6F5  DB70    		IN	A,(ATARI)	; 11 CYCLES
 143:16158+4	F6F7  17      		RLA			;  4 CYCLES
 144:16162+8	F6F8  CB1A    		RR	D		;  8 CYCLES
 145:16170+8+5	F6FA  10F0    		DJNZ	RXB2		; 13 CYCLES  (8 ON FINAL BIT)
 146:				
 147:16178+4	F6FC  42      		LD	B,D		;SAVE COPY OF LAST DATA BYTE IN B
 148:16182+7	F6FD  72      		LD	(HL),D		;THEN STORE IN MEMORY BUFFER @HL
 149:16189+6	F6FE  23      		INC	HL
 150:16195+4	F6FF  7C      		LD	A,H
 151:16199+7	F700  FEC3    		CP	HIGH (IOBUFF+LEN)
 152:16206+4	F702  3F      		CCF
 153:16210+5+6	F703  D8      		RET	C		;RETURN WITH CARRY SET IF BUFFER FILLED
 154:				
 155:     -	F704          	RXB35:
 156:     -	0001          	IF SALLYBUILD
 157:16215+10	F704  11A101  		LD	DE,417		;5 MILLISECONDS @ 12 MICROSECONDS/LOOP
 158:				ENDIF
 159:16225+7	F707  3E47    		LD	A, CTC_D6_MODE_CNT + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
 160:16232+11	F709  D380    		OUT	(CTC0),A	;PUT CTC0 IN COUNTER MODE
 161:16243+4	F70B  AF      		XOR	A			;TIME CONSTANT OF 0 WHICH MEANS 256
 162:16247+11	F70C  D380    		OUT	(CTC0),A	;COUNT DATA HIGH->LOW EDGES MOD 256
 163:     -	0000          	IF SALLYBUILD <> 1
 165:				ENDIF
 166:				
 167:16258+11	F70E  DB80    	RXB4:	IN	A,(CTC0)
 168:16269+4	F710  B7      		OR	A
 169:16273+7+5	F711  20CE    		JR	NZ,RXB1		;NEW BYTE IS COMING IF START BIT LOW
 170:16280+6	F713  1B      		DEC	DE
 171:16286+4	F714  7A      		LD	A,D
 172:16290+4	F715  B3      		OR	E
 173:16294+7+5	F716  20F6    		JR	NZ,RXB4		;ELSE LOOP TILL TIMER RUNS OUT
 174:				
 175:16301+10	F718  C9      		RET			;RETURN WITH CARRY CLEAR IF TIMED OUT
 176:				;
 177:				;
 178:				;
 179:				;
 180:				;	**** PAGE BOUNDARY SENSITIVE CODE STARTS HERE ****
 181:				;
 182:     -	F719          	SERPAGE	EQU	$
 183:				;
 184:				;
 185:				;	... DAMN FAST TRANSMIT INTERRUPTS ...
 186:				;
 187:				;	HL ... POINTS TO DATA BLOCK TO BE SENT
 188:				;	 D ... HOLDS DATA POLARITY MASK
 189:				;	 E ... USED TO ACCUMULATE CHECKSUM
 190:				;	 B ... USED FOR DJNZ TO COUNT BITS
 191:				;	 C ... USED FOR PARALLEL-SERIAL OUTPUT
 192:				;
 193:				;
 194:     -	F719          	STARBIT:
 195:16311+4	F719  AF      		XOR	A
 196:16315+11	F71A  D350    		OUT	(ATROUT),A	;SEND START BIT
 197:16326+4	F71C  FB      		EI
 198:16330+7	F71D  7E      		LD	A,(HL)		;LOAD A WITH TRANSMIT DATA BYTE
 199:16337+6	F71E  23      		INC	HL		; AND INCREMENT BUFFER POINTER
 200:16343+4	F71F  AA      		XOR	D		;DO DATA POLARITY THING
 201:16347+4	F720  4F      		LD	C,A		;THEN STUFF IN C FOR SHIFTING OUT
 202:16351+4	F721  83      		ADD	A,E
 203:16355+7	F722  CE00    		ADC	A,0
 204:16362+4	F724  5F      		LD	E,A		;ACCUMULATE CHECKSUM IN E
 205:16366+7	F725  3E2C    		LD	A,LOW DATBIT
 206:16373+13	F727  3212FF  		LD	(CTCVEC+2),A	;FIX BAUDRATE INTERRUPT VECTOR
 207:16386+14	F72A  ED4D    		RETI			;RETURN TO IDLE LOOP
 208:				;
 209:				;
 210:				;
 211:     -	F72C          	DATBIT:
 212:16400+4	F72C  79      		LD	A,C
 213:16404+11	F72D  D350    		OUT	(ATROUT),A	;SEND DATA BIT (LSB)
 214:16415+4	F72F  FB      		EI
 215:16419+8	F730  CB19    		RR	C		;SHIFT DATA FOR NEXT BIT
 216:16427+8+5	F732  1005    		DJNZ	DATB2		;DECREMENT AND SKIP IF NOT LAST BIT
 217:				
 218:16435+7	F734  3E3B    		LD	A,LOW STOPB1
 219:16442+13	F736  3212FF  		LD	(CTCVEC+2),A	;THEN FIX VECTOR TO SEND STOP BIT
 220:16455+14	F739  ED4D    	DATB2:	RETI			;RETURN TO IDLE LOOP
 221:				;
 222:				;
 223:				;
 224:     -	F73B          	STOPB1:
 225:16469+7	F73B  3E01    		LD	A,1
 226:16476+11	F73D  D350    		OUT	(ATROUT),A	;SEND STOP BIT
 227:16487+4	F73F  FB      		EI
 228:16491+4	F740  7C      		LD	A,H
 229:16495+7	F741  FEC3    		CP	HIGH (IOBUFF+LEN)
 230:16502+7+5	F743  3009    		JR	NC,STOP1A	;JUMP IF BUFFER END REACHED
 231:				
 232:16509+7	F745  0608    		LD	B,8		;LOAD BITCOUNT FOR NEXT RECEIVE BYTE
 233:16516+7	F747  3E19    		LD	A,LOW STARBIT
 234:16523+13	F749  3212FF  		LD	(CTCVEC+2),A
 235:16536+14	F74C  ED4D    		RETI			;SET TO SEND SECOND STOP BIT
 236:				;
 237:16550+7	F74E  3E55    	STOP1A:	LD	A,LOW ENDBIT
 238:16557+13	F750  3212FF  		LD	(CTCVEC+2),A	;SET TO END TRANSMISSION
 239:16570+14	F753  ED4D    		RETI
 240:				;
 241:				;
 242:				;
 243:     -	0000          		IF	(HIGH SERPAGE) NE (HIGH $)
 245:					ENDIF
 246:				;
 247:				;
 248:				;
 249:     -	F755          	ENDBIT:
 250:     -	0001          	IF SALLYBUILD
 251:16584+7	F755  3E03    		LD	A,CTC_D1_SW_RST + CTC_D0_CONTROL	;SOFTWARE RESET - STOP INTERRUPTS FROM BAUDRATE CTC
 252:				ELSE
 254:				ENDIF
 255:16591+11	F757  D381    		OUT	(CTC1),A			;SEND COMMAND TO CTC1
 256:16602+4	F759  FB      		EI
 257:16606+7	F75A  3EFF    		LD	A,255
 258:16613+13	F75C  3212FF  		LD	(CTCVEC+2),A	;SET VECTOR BACK TO STANDARD PLACE
 259:16626+10	F75F  E1      		POP	HL		;DISCARD IRQ RETURN ADDRESS AND RETURN
 260:16636+14	F760  ED4D    		RETI			; TO SECOND ADDRESS ON STACK
 261:				;
 262:				;
 263:				;	**** END PAGE BOUNDARY RESTRICTIONS ****
 264:				;
 265:				;
**** ..\src\sally2.asm ****
  55:					INCLUDE	ATARI.MAC
**** ..\src\ATARI.MAC ****
   1:				;	PAGE
   2:				;
   3:				;	<<< MAIN LOOP FOR ATARI DISK EMULATOR >>>
   4:				;
   5:				;
   6:				;
   7:				;
   8:     -	F762          	EMULATOR:
   9:16650+7	F762  3E01    		LD	A,1
  10:16657+11	F764  D352    		OUT	(BANKSW),A	;TURN OFF THE ROM
  11:				;
  12:				;	CHECK TO DETERMINE WHICH CONSOLE IS ACTIVE
  13:				;
  14:16668+10	F766  21FEC2  	LOGON:	LD	HL,IOBUFF+LEN-2
  15:16678+4	F769  F3      		DI
  16:16682+17	F76A  CDD9F6  		CALL	RXBLOCK		;LISTEN FOR A MESSAGE FROM ABOVE
  17:16699+4	F76D  FB      		EI
  18:16703+7+5	F76E  30F6    		JR	NC,LOGON	;KEEP LOOPING TILL SOMETHING RECEIVED
  19:16710+16	F770  2AFEC2  		LD	HL,(IOBUFF+LEN-2)
  20:16726+10	F773  11E680  		LD	DE,80E6H
  21:16736+4	F776  B7      		OR	A
  22:16740+15	F777  ED52    		SBC	HL,DE
  23:16755+10	F779  CADEF3  		JP	Z,MINIMON	;GOTO MONITOR IF 9600 BAUD <CR>
  24:				;
  25:				;	ENTER ATARI DISK EMULATOR MODE
  26:				;
  27:16765+7	F77C  3E03    		LD	A,3
  28:     -	F77E          	SalyLOGN1:
  29:16772+13	F77E  3233FF  		LD	(RWMAX),A	;DO LESS RETRIES IN ATARI MODE
  30:     -	F781          	SalyLOGN2:
  31:16785+7	F781  3E38    		LD	A,38H		;LOAD ACC WITH 'JR C,XX' OPCODE
  32:16792+13	F783  3281F1  		LD	(KLUDGE),A	;CRIPPLE READY ERROR FROM 'SELECT'
  33:16805+11	F786  DB50    		IN	A,(SERIN)
  34:16816+8	F788  CB5F    		BIT	3,A
  35:16824+7+5	F78A  2005    		JR	NZ,HAS850	;JUMP IF 850 JUMPER PRESENT
  36:				
  37:16831+7	F78C  3EFF    		LD	A,255
  38:16838+13	F78E  3223F8  		LD	(PTRID),A	;ELSE ZAP PRINTER ID IN TABLE
  39:				
  40:16851+10	F791  21E1F7  	HAS850:	LD	HL,DUMMY
  41:16861+16	F794  2219F0  		LD	(RENEW+1),HL	;MAKE DUMMY CONSOLE RE-INIT VECTOR
  42:16877+20	F797  ED5B1930		LD	DE,(RENEW+1-0C000H)
  43:16897+4	F79B  B7      		OR	A
  44:16901+15	F79C  ED52    		SBC	HL,DE
  45:16916+7+5	F79E  280C    		JR	Z,MAIN		;JUMP IF 16K MEMORY SIZE MACHINE
  46:				
  47:     -	0001          	IF SALLYBUILD
  48:16923+10	F7A0  210022  		LD	HL, 02200h	;was 0000h, now 0800h+26*256 track buffer = 2200h
  49:16933+16	F7A3  224BFF  		LD	(PBASE),HL	;ELSE SETUP FOR 39.5K PRINTER BUFFER
  50:16949+10	F7A6  21FF9D  		LD	HL,09DFFH	;bfffh - 2200h = 9dffh	
  51:				ELSE
  55:				ENDIF	;SALLYBUILD
  56:16959+16	F7A9  224DFF  		LD	(PSIZE),HL
  57:				
  58:16975+17	F7AC  CDD1F8  	MAIN:	CALL	SPOOLER		;KEEP BACKGROUND PRINTING GOING
  59:16992+16	F7AF  2A3AFF  		LD	HL,(FSMVEC)
  60:17008+17	F7B2  CDBDF7  		CALL	CALLHL		;DO ATARI TASK ROUTINE
  61:17025+16	F7B5  2A3CFF  		LD	HL,(EXTVEC)
  62:17041+17	F7B8  CDBDF7  		CALL	CALLHL		;DO EXTRA TASK ROUTINE
  63:17058+12	F7BB  18EF    		JR	MAIN
  64:				;
  65:				;
  66:17070+4	F7BD  E9      	CALLHL:	JP	(HL)
  67:				;
  68:				;
  69:				;
  70:     -	F7BE          	PWRWAIT:
  71:17074+11	F7BE  DB70    		IN	A,(ATARI)
  72:17085+7	F7C0  E68A    		AND	10001010B	;MASK TO DATA/POWER/COMMAND BITS
  73:17092+7	F7C2  FE8A    		CP	10001010B
  74:17099+5+6	F7C4  C0      		RET	NZ
  75:				
  76:17104+4	F7C5  F3      		DI
  77:17108+4	F7C6  AF      		XOR	A
  78:17112+13	F7C7  3255FF  		LD	(CMDFLG),A	;RESET COMMAND FRAME FLAG
  79:17125+11	F7CA  D357    		OUT	(CDMUX),A	;SET MUX TO GATE COMMAND LINE TO CTC0
  80:17136+7	F7CC  3ED7    		LD	A,CTC_D7_INT_EN + CTC_D6_MODE_CNT + CTC_D4_RISEEDGE + CTC_D2_TCNEXT + CTC_D1_SW_RST + CTC_D0_CONTROL	; Set up values for CTC0
  81:17143+11	F7CE  D380    		OUT	(CTC0),A	;RESET CTC AND ARM FOR HIGH->LOW IRQ
  82:17154+7	F7D0  3E01    		LD	A,1			;TIME CONSTANT OF 1
  83:17161+11	F7D2  D380    		OUT	(CTC0),A	;WRITE TIME CONSTANT
  84:17172+10	F7D4  2199F6  		LD	HL,CSTART
  85:17182+16	F7D7  2210FF  		LD	(CTCVEC),HL	;STORE INTERRUPT VECTOR
  86:17198+4	F7DA  FB      		EI
  87:17202+10	F7DB  21E2F7  		LD	HL,CMDWAIT
  88:17212+16	F7DE  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR TO 'CMDHIGH' STATE
  89:17228+10	F7E1  C9      	DUMMY:	RET
  90:				;
  91:				;
  92:				;
  93:     -	F7E2          	CMDWAIT:
  94:17238+13	F7E2  3A55FF  		LD	A,(CMDFLG)
  95:17251+4	F7E5  B7      		OR	A			;SEE IF COMMAND FRAME HAS ARRIVED
  96:17255+5+6	F7E6  C8      		RET	Z			;EXIT IF NOTHING HAS HAPPENED
  97:				
  98:17260+7	F7E7  FE01    		CP	1
  99:17267+7+5	F7E9  2808    		JR	Z,CMDL4		;PROCESS COMMAND IF GOOD FRAME RECVD
 100:				
 101:17274+4	F7EB  F3      		DI				;ELSE RESET INTERRUPT AND START AGAIN
 102:17278+7	F7EC  3E03    		LD	A, CTC_D1_SW_RST + CTC_D0_CONTROL	; SOFTWARE RESET CTC0
 103:17285+11	F7EE  D380    		OUT	(CTC0),A	;PERFORM THE RESET
 104:17296+4	F7F0  FB      		EI
 105:17300+12	F7F1  1816    		JR	CMDL5		;GO SET FSM VECTOR
 106:				;
 107:				;
 108:     -	C2FB          	CFRAME	EQU	IOBUFF+LEN-5	;COMMAND FRAME IS LAST 5 BYTES OF BUFF
 109:				;
 110:17312+13	F7F3  3AFBC2  	CMDL4:	LD	A,(CFRAME)
 111:17325+16	F7F6  2A38FF  		LD	HL,(IDPTR)	;GET POINTER TO ID CODE TABLE
 112:17341+17	F7F9  CD10F8  		CALL	SCAN		;SCAN TABLE FOR MATCHING UNIT ID CODE
 113:17358+7+5	F7FC  200B    		JR	NZ,CMDL5	;EXIT IF COMMAND IS NOT FOR US
 114:				
 115:17365+13	F7FE  3AFCC2  		LD	A,(CFRAME+1)
 116:17378+17	F801  CD10F8  		CALL	SCAN		;SCAN FOR COMMAND CODE IN TABLE
 117:17395+7+5	F804  2003    		JR	NZ,CMDL5	;ERROR IF NO MATCH FOUND
 118:				
 119:17402+17	F806  CDBDF7  		CALL	CALLHL		;GO TO COMMAND PROCESSOR @HL
 120:				;
 121:17419+10	F809  21BEF7  	CMDL5:	LD	HL,PWRWAIT
 122:17429+16	F80C  223AFF  		LD	(FSMVEC),HL	;SET FSM VECTOR BACK TO IDLE STATE
 123:17445+10	F80F  C9      		RET
 124:				;
 125:				;
 126:				;
 127:				;
 128:     -	F810          	SCAN:
 129:17455+7	F810  4E      		LD	C,(HL)		;LOAD BC WITH TABLE LENGTH @HL
 130:17462+6	F811  23      		INC	HL
 131:17468+7	F812  46      		LD	B,(HL)
 132:17475+6	F813  23      		INC	HL
 133:17481+16+5	F814  EDB1    		CPIR			;SCAN STRING @HL FOR MATCH WITH ACC
 134:17497+5+6	F816  C0      		RET	NZ		;EXIT IF NO MATCH
 135:				
 136:17502+11	F817  F5      		PUSH	AF
 137:17513+11	F818  09      		ADD	HL,BC		;ELSE ADD RESIDUE FROM CPIR TO HL
 138:17524+11	F819  09      		ADD	HL,BC		; THREE TIMES TO POINT TO ADDRESS
 139:17535+11	F81A  09      		ADD	HL,BC		; CORRESPONDING TO MATCHED VALUE
 140:17546+7	F81B  7E      		LD	A,(HL)
 141:17553+6	F81C  23      		INC	HL
 142:17559+7	F81D  66      		LD	H,(HL)
 143:17566+4	F81E  6F      		LD	L,A
 144:17570+10	F81F  F1      		POP	AF
 145:17580+10	F820  C9      		RET			;RETURN TABLE ENTRY IN HL
 146:				;
 147:				;
 148:				;
 149:				;	... DEVICE ID TABLE FOR DISK/PRINTER/RS232 COMBO BOX ...
 150:				;
 151:     -	F821          	IDTAB:
 152:     -	F821  0600    		DEFW	IDMAX
 153:				
 154:     -	F823  40      	PTRID:	DEFB	'@'		;PRINTER CONTROLLER ID CODE
 155:     -	F824  31      		DEFB	'1'		;DISK UNIT #1 ID CODE
 156:     -	F825  32      		DEFB	'2'		;DISK #2
 157:     -	F826  33      		DEFB	'3'		;DISK #3
 158:     -	F827  34      		DEFB	'4'		;DISK #4
 159:     -	F828  5A      		DEFB	'Z'		;Z80 LOAD/DUMP/GOTO
 160:				
 161:     -	F829  54F8    		DEFW	Z80TAB
 162:     -	F82B          	SalyDISKID:
 163:     -	F82B  3DF8    		DEFW	DISKTAB
 164:     -	F82D  3DF8    		DEFW	DISKTAB
 165:     -	F82F  3DF8    		DEFW	DISKTAB
 166:     -	F831  3DF8    		DEFW	DISKTAB
 167:     -	F833  35F8    		DEFW	PTRTAB
 168:     -	0006          	IDMAX	EQU	($-IDTAB)/3
 169:				;
 170:				;
 171:				;
 172:     -	F835          	PTRTAB:				;PRINTER COMMANDS
 173:     -	F835  0200    		DEFW	PTRMAX
 174:				
 175:     -	F837  53      		DEFB	'S'		;PRINTER STATUS
 176:     -	F838  57      		DEFB	'W'		;PRINTER OUTPUT
 177:				
 178:     -	F839  78F8    		DEFW	PTRWRITE
 179:     -	F83B  62F8    		DEFW	PTRSTAT
 180:     -	0002          	PTRMAX	EQU	($-(PTRTAB+2))/3
 181:				;
 182:				;
 183:				;
 184:     -	F83D          	DISKTAB:			;DISK COMMANDS
 185:     -	F83D  0700    		DEFW	DISKMAX
 186:				
 187:     -	F83F  52      		DEFB	'R'		;DISK READ
 188:     -	F840  53      		DEFB	'S'		;DISK STATUS
 189:     -	F841  57      		DEFB	'W'		;DISK WRITE
 190:     -	F842  50      		DEFB	'P'		;DISK PUT
 191:     -	F843  4E      		DEFB	'N'		;GET PARAMETERS
 192:     -	F844  4F      		DEFB	'O'		;PUT PARAMETERS
 193:     -	F845  21      		DEFB	'!'		;FORMAT DISK
 194:				
 195:     -	F846  38FB    		DEFW	DISKINIT
 196:     -	F848  05FC    		DEFW	PUTPARAMS
 197:     -	F84A  E7FB    		DEFW	GETPARAMS
 198:     -	F84C  05F9    		DEFW	DISKPUT
 199:     -	F84E  08F9    		DEFW	DISKWRITE
 200:     -	F850  DBFA    		DEFW	DISKSTAT
 201:     -	F852  8CF9    		DEFW	DISKREAD
 202:     -	0007          	DISKMAX	EQU	($-(DISKTAB+2))/3
 203:				;
 204:				;
 205:				;
 206:     -	F854          	Z80TAB:				;Z80 COMMANDS
 207:     -	F854  0400    		DEFW	Z80MAX
 208:				
 209:     -	F856  52      		DEFB	'R'		;MEMORY READ
 210:     -	F857  57      		DEFB	'W'		;MEMORY WRITE
 211:     -	F858  53      		DEFB	'S'		;SET ADDRESS
 212:     -	F859  47      		DEFB	'G'		;GOTO ADDRESS
 213:				
 214:     -	F85A  B4FC    		DEFW	Z80GOTO
 215:     -	F85C  A6FC    		DEFW	Z80SET
 216:     -	F85E  7BFC    		DEFW	Z80WRITE
 217:     -	F860  5FFC    		DEFW	Z80READ
 218:     -	0004          	Z80MAX	EQU	($-(Z80TAB+2))/3
 219:				;
 220:				;
 221:				;
 223:				;
 224:				;
 225:				;	... PRINTER STATUS COMMAND PROCESSOR ...
 226:				;
 227:     -	F862          	PTRSTAT:
 228:17590+17	F862  CD4AFC  		CALL	SENDACK
 229:17607+10	F865  2143FF  		LD	HL,PSMSG
 230:17617+10	F868  11FCC2  		LD	DE,IOBUFF+LEN-4
 231:17627+11	F86B  D5      		PUSH	DE
 232:17638+10	F86C  010400  		LD	BC,4
 233:17648+16+5	F86F  EDB0    		LDIR			;COPY PRINTER STATUS FRAME FROM RAM
 234:17664+10	F871  E1      		POP	HL
 235:17674+10	F872  114300  		LD	DE,'C'		;SEND PRINTER STATUS UN-INVERTED
 236:17684+10	F875  C36CF6  		JP	SENDBUFF
 237:				;	ret
 238:				;
 239:				;
 240:				;	... PRINTER WRITE COMMAND PROCESSOR ...
 241:				;
 242:     -	F878          	PTRWRITE:
 243:17694+17	F878  CD4AFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 244:17711+17	F87B  CDB9F6  		CALL	RECVBUFF	;GET PRINT DATA FROM SERIAL BUS
 245:17728+5+6	F87E  C0      		RET	NZ		;EXIT IF ERROR OR TIMEOUT
 246:				
 247:17733+10	F87F  112800  		LD	DE,40
 248:17743+4	F882  B7      		OR	A
 249:17747+15	F883  ED52    		SBC	HL,DE
 250:17762+5+6	F885  C0      		RET	NZ		;ERROR IF RX BLOCK LENGTH <> 40 BYTES
 251:				
 252:17767+17	F886  CD4AFC  		CALL	SENDACK		;ELSE SEND 'ACK'
 253:17784+10	F889  2100C1  		LD	HL,IOBUFF
 254:17794+7	F88C  0628    		LD	B,40
 255:17801+7	F88E  7E      	PWRIT3:	LD	A,(HL)
 256:17808+7	F88F  FE9B    		CP	9BH		;CHECK FOR 'ATASCII' CARRIAGE RETURN
 257:17815+7+5	F891  2005    		JR	NZ,PWRT3A
 258:				
 259:17822+10	F893  213EFF  		LD	HL,NEWLIN
 260:17832+7	F896  46      		LD	B,(HL)		;OUTPUT PRINTER'S NEWLINE CHARACTER(S)
 261:17839+6	F897  23      		INC	HL
 262:				
 263:17845+11	F898  E5      	PWRT3A:	PUSH	HL
 264:17856+16	F899  2A4FFF  		LD	HL,(PCOUNT)
 265:17872+20	F89C  ED5B4DFF		LD	DE,(PSIZE)
 266:17892+4	F8A0  B7      		OR	A
 267:17896+15	F8A1  ED52    		SBC	HL,DE		;TEST IF PRINTER BUFFER IS FULL
 268:17911+10	F8A3  E1      		POP	HL
 269:17921+7+5	F8A4  380E    		JR	C,PWRIT4	;STORE ANOTHER CHARACTER IF NOT FULL
 270:				
 271:17928+11	F8A6  E5      		PUSH	HL
 272:17939+11	F8A7  C5      		PUSH	BC
 273:17950+17	F8A8  CDD1F8  		CALL	SPOOLER		;TRY TO CLEAR OUT BUFFER
 274:17967+10	F8AB  C1      		POP	BC
 275:17977+10	F8AC  E1      		POP	HL
 276:17987+11	F8AD  DB70    		IN	A,(ATARI)
 277:17998+7	F8AF  E602    		AND	00000010B	;TEST ATARI COMMAND LINE AND
 278:18005+7+5	F8B1  20E5    		JR	NZ,PWRT3A	;STAY IN LOOP IF INACTIVE
 279:				
 280:18012+10	F8B3  C9      		RET			;ELSE ABORT PRINTING AND RETURN
 281:				;
 282:18022+7	F8B4  7E      	PWRIT4:	LD	A,(HL)
 283:18029+6	F8B5  23      		INC	HL
 284:18035+11	F8B6  E5      		PUSH	HL
 285:18046+11	F8B7  C5      		PUSH	BC
 286:18057+16	F8B8  2A51FF  		LD	HL,(PINP)
 287:18073+17	F8BB  CDF1F8  		CALL	INDEX		;GET INDEX TO FIFO INPUT PLACE
 288:18090+20	F8BE  ED5351FF		LD	(PINP),DE	;STORE UPDATED INPUT OFFSET
 289:18110+7	F8C2  77      		LD	(HL),A		;STORE CHARACTER IN QUEUE
 290:18117+16	F8C3  2A4FFF  		LD	HL,(PCOUNT)
 291:18133+6	F8C6  23      		INC	HL		;BUMP FIFO CHARACTER COUNTER
 292:18139+16	F8C7  224FFF  		LD	(PCOUNT),HL
 293:18155+10	F8CA  C1      		POP	BC
 294:18165+10	F8CB  E1      		POP	HL
 295:18175+8+5	F8CC  10C0    		DJNZ	PWRIT3		;REPEAT TO END OF STRING
 296:				
 297:18183+10	F8CE  C354FC  		JP	SENDCOMP	;SEND 'COMPLETE' TO ATARI
 298:				;	ret
 299:				;
 300:				;
 301:				;
 302:     -	F8D1          	SPOOLER:
 303:18193+16	F8D1  2A4FFF  		LD	HL,(PCOUNT)
 304:18209+4	F8D4  7C      		LD	A,H
 305:18213+4	F8D5  B5      		OR	L
 306:18217+5+6	F8D6  C8      		RET	Z		;EXIT IF NO DATA IN FIFO TO PRINT
 307:				
 308:18222+17	F8D7  CD15F0  		CALL	LISTV+3
 309:18239+5+6	F8DA  C0      		RET	NZ		;EXIT IF PRINTER BUSY
 310:				
 311:18244+16	F8DB  2A53FF  		LD	HL,(POUT)
 312:18260+17	F8DE  CDF1F8  		CALL	INDEX		;GET POINTER WITH AUTO-INCREMENT
 313:18277+20	F8E1  ED5353FF		LD	(POUT),DE
 314:18297+7	F8E5  4E      		LD	C,(HL)
 315:18304+17	F8E6  CD12F0  		CALL	LISTV		;PRINT CHARACTER AND EXIT
 316:18321+16	F8E9  2A4FFF  		LD	HL,(PCOUNT)
 317:18337+6	F8EC  2B      		DEC	HL		;DIMINISH BUFFER COUNT BY ONE
 318:18343+16	F8ED  224FFF  		LD	(PCOUNT),HL
 319:18359+10	F8F0  C9      		RET
 320:				;
 321:				;
 322:				;
 323:				;
 324:     -	F8F1          	INDEX:
 325:18369+4	F8F1  EB      		EX	DE,HL
 326:18373+16	F8F2  2A4BFF  		LD	HL,(PBASE)
 327:18389+11	F8F5  19      		ADD	HL,DE		;ADD OFFSET TO FIFO BASE ADDRESS
 328:18400+11	F8F6  E5      		PUSH	HL
 329:18411+6	F8F7  13      		INC	DE		;BUMP OFFSET NOW IN DE
 330:18417+16	F8F8  2A4DFF  		LD	HL,(PSIZE)
 331:18433+4	F8FB  B7      		OR	A
 332:18437+15	F8FC  ED52    		SBC	HL,DE		;COMPARE TO MAX OFFSET VALUE
 333:18452+7+5	F8FE  3003    		JR	NC,INDEX2
 334:18459+10	F900  110000  		LD	DE,0		;SET OFFSET TO ZERO IF ROLL-OVER
 335:18469+10	F903  E1      	INDEX2:	POP	HL
 336:18479+10	F904  C9      		RET			;RETURN DE=OFFSET AND HL=POINTER
 337:				;
 338:				;
 339:				;
 340:				;	... DISK WRITE COMMAND PROCESSOR ...
 341:				;
 342:     -	F905          	DISKPUT:
 343:18489+4	F905  AF      		XOR	A
 344:18493+12	F906  1802    		JR	DWRT0
 345:				;
 346:     -	F908          	DISKWRITE:
 347:18505+7	F908  3E01    		LD	A,1
 348:18512+13	F90A  32B5FF  	DWRT0:	LD	(VFLAG),A
 349:18525+17	F90D  CD28FC  		CALL	DRVINDEX	;INDEX TO GET DRIVE PARAMETER POINTER
 350:18542+5+6	F910  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 351:				
 352:18547+17	F911  CD4AFC  		CALL	SENDACK
 353:18564+17	F914  CDB9F6  		CALL	RECVBUFF	;ELSE GO QUICK TO READ DATA FRAME
 354:18581+5+6	F917  C0      		RET	NZ		;EXIT IF BAD CHECKSUM
 355:     -	F918          	SalyDISKWRT1:
 356:18586+16	F918  22A9FF  		LD	(LOGSIZ),HL	;SAVE DATA BLOCK LENGTH
 357:     -	F91B          	SalyDISKWRT2:
 358:18602+10	F91B  118000  		LD	DE,128
 359:18612+4	F91E  B7      		OR	A
 360:18616+15	F91F  ED52    		SBC	HL,DE		;TEST FOR 128 BYTE FRAME
 361:18631+7+5	F921  2804    		JR	Z,DWRT1
 362:18638+4	F923  B7      		OR	A
 363:18642+15	F924  ED52    		SBC	HL,DE		;TEST FOR 256 BYTE FRAME
 364:18657+5+6	F926  C0      		RET	NZ
 365:				
 366:18662+17	F927  CD4AFC  	DWRT1:	CALL	SENDACK		;SEND 'ACK' IF BLOCKSIZE IS 128 OR 256
 367:18679+17	F92A  CD10FA  		CALL	SECTRAN		;SET DISK PARAMETERS FOR WRITE
 368:18696+7+5	F92D  204E    		JR	NZ,DWRT4	;JUMP IF ERROR FROM 'SECTRAN'
 369:				
 370:18703+10	F92F  2100C1  		LD	HL,IOBUFF
 371:18713+16	F932  229CFF  		LD	(DKIOCB+DSKPTR),HL
 372:18729+13	F935  3AA9FF  		LD	A,(LOGSIZ)
 373:18742+4	F938  47      		LD	B,A		;PREPARE TO COMPLIMENT DISK DATA BLOCK
 374:18746+7	F939  7E      	DWRT2:	LD	A,(HL)
 375:18753+4	F93A  2F      		CPL
 376:18757+7	F93B  77      		LD	(HL),A		;COMPLIMENT DISK DATA BLOCK
 377:18764+6	F93C  23      		INC	HL
 378:18770+8+5	F93D  10FA    		DJNZ	DWRT2		;REPEAT TO END OF BLOCK
 379:18778+7	F93F  3E02    		LD	A,PUTSEC
 380:18785+13	F941  3298FF  		LD	(DKIOCB+DSKOP),A
 381:18798+14	F944  DD2198FF		LD	IX,DKIOCB
 382:     -	F948          	SalyDISKWRT3:
 383:18812+17	F948  CD0FF0  		CALL	DISKV		;CALL PHYSICAL DISK DRIVER
 384:18829+13	F94B  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 385:18842+4	F94E  B7      		OR	A
 386:18846+7+5	F94F  202C    		JR	NZ,DWRT4	;BOMB OUT NOW IF DISK ERROR
 387:				
 388:18853+13	F951  3AB5FF  		LD	A,(VFLAG)
 389:18866+4	F954  B7      		OR	A
 390:18870+7+5	F955  2826    		JR	Z,DWRT4		;EXIT OK IF NOT WRITE WITH VERIFY
 391:				
 392:18877+7	F957  3E01    		LD	A,GETSEC
 393:18884+13	F959  3298FF  		LD	(DKIOCB+DSKOP),A
 394:18897+10	F95C  2100C3  		LD	HL,IOBUFF+LEN
 395:18907+16	F95F  229CFF  		LD	(DKIOCB+DSKPTR),HL
 396:18923+17	F962  CD0FF0  		CALL	DISKV		;ELSE READ SECTOR BACK FOR VERIFY
 397:18940+13	F965  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 398:18953+4	F968  B7      		OR	A
 399:18957+7+5	F969  2012    		JR	NZ,DWRT4	;BOMB AGAIN IF READ ERROR
 400:				
 401:18964+10	F96B  2100C1  		LD	HL,IOBUFF
 402:18974+10	F96E  1100C3  		LD	DE,IOBUFF+LEN
 403:18984+13	F971  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 404:18997+4	F974  47      		LD	B,A		;PREPARE TO COMPARE 128 OR 256 BYTES
 405:19001+7	F975  1A      	DWRT3:	LD	A,(DE)
 406:19008+7	F976  AE      		XOR	(HL)
 407:19015+7+5	F977  200B    		JR	NZ,DWRT5
 408:19022+6	F979  23      		INC	HL
 409:19028+6	F97A  13      		INC	DE
 410:19034+8+5	F97B  10F8    		djnz	DWRT3		;fall through last time with acc=0
 411:				
 412:19042+17	F97D  CDE3F9  	DWRT4:	CALL	SETSTAT		;DO STATUS SETTING STUFF
 413:19059+4	F980  7B      		LD	A,E
 414:19063+10	F981  C356FC  		JP	SENDCHAR	;SEND 'COMPLETE' OR 'ERROR' TO ATARI
 415:				;	ret
 416:				;
 417:19073+4	F984  AF      	DWRT5:	XOR	A
 418:19077+17	F985  CD06FA  		CALL	ssts4		;set hardware status=0 but set bad r/w
 419:19094+4	F988  7B      		LD	a,e
 420:19098+10	F989  C356FC  		JP	sendchar
 421:				;	ret
 422:				;
 423:				;
 424:				;
 425:				;	... DISK READ COMMAND PROCESSOR ...
 426:				;
 427:     -	F98C          	DISKREAD:
 428:19108+17	F98C  CD28FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 429:19125+5+6	F98F  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 430:				
 431:19130+17	F990  CD4AFC  		CALL	SENDACK
 432:     -	F993          	SalyDISKRD1:
 433:19147+17	F993  CD10FA  		CALL	SECTRAN		;SET PARAMETERS FOR DISK OPERATION
 434:     -	F996          	SalyDISKRD2:
 435:19164+11	F996  F5      		PUSH	AF		;SAVE ERROR STATUS FROM 'SECTRAN'
 436:19175+7+5	F997  280F    		JR	Z,DRD2		;JUMP IF PARAMS SET OK
 437:				
 438:19182+19	F999  FD5606  		LD	D,(IY+SECLEN)
 439:19201+19	F99C  FD5E07  		LD	E,(IY+SECLEN+1)	;LOAD DE WITH SECTOR LEN FROM 'DMATRIX'
 440:19220+4	F99F  7A      		LD	A,D
 441:19224+4	F9A0  B3      		OR	E
 442:19228+7+5	F9A1  2009    		JR	NZ,DRD2A	;JUMP IF LENGTH <> 0
 443:				
 444:19235+10	F9A3  118000  		LD	DE,128		;ELSE REVERT TO 128 BYTES
 445:19245+12	F9A6  1804    		JR	DRD2A
 446:				;
 447:19257+20	F9A8  ED5B9EFF	DRD2:	LD	DE,(DKIOCB+DSKAUX) ;LOAD DE WITH PHYSICAL SECTOR LENGTH
 448:19277+16	F9AC  2AFDC2  	DRD2A:	LD	HL,(CFRAME+2)
 449:19293+10	F9AF  010400  		LD	BC,4
 450:19303+4	F9B2  B7      		OR	A
 451:19307+15	F9B3  ED42    		SBC	HL,BC		;TEST IF ACCESSING SECTOR# 1,2 OR 3
 452:19322+7+5	F9B5  3003    		JR	NC,DRD3		;JUMP IF NOT ACCESSING A BOOT SECTOR
 453:19329+10	F9B7  118000  		LD	DE,128
 454:19339+20	F9BA  ED53A9FF	DRD3:	LD	(LOGSIZ),DE
 455:19359+10	F9BE  2100C3  		LD	HL,IOBUFF+LEN
 456:19369+4	F9C1  B7      		OR	A
 457:19373+15	F9C2  ED52    		SBC	HL,DE		;COMPUTE STARTING PLACE IN BUFFER
 458:19388+10	F9C4  F1      		POP	AF
 459:19398+7+5	F9C5  2014    		JR	NZ,DRD4		;JUMP IF ERROR FROM 'SECTRAN' ABOVE
 460:				
 461:19405+16	F9C7  229CFF  		LD	(DKIOCB+DSKPTR),HL
 462:19421+7	F9CA  3E01    		LD	A,GETSEC
 463:19428+13	F9CC  3298FF  		LD	(DKIOCB+DSKOP),A
 464:19441+14	F9CF  DD2198FF		LD	IX,DKIOCB
 465:19455+11	F9D3  E5      		PUSH	HL
 466:     -	F9D4          	SalyDISKRD3:
 467:19466+17	F9D4  CD0FF0  		CALL	DISKV		;CALL DISK I/O HANDLER
 468:19483+10	F9D7  E1      		POP	HL
 469:19493+13	F9D8  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 470:				
 471:19506+17	F9DB  CDE3F9  	DRD4:	CALL	SETSTAT		;TEST AND STORE STATUS STUFF
 472:19523+7	F9DE  16FF    		LD	D,255		;SET MASK TO INVERT DISK DATA
 473:19530+10	F9E0  C36CF6  		JP	SENDBUFF	;SEND RESPONSE TO ATARI
 474:				;	ret
 475:				;
 476:				;
 477:				;
 478:				;	ROUTINE TO CHECK STATUS AFTER READ/WRITE
 479:				;
 480:     -	F9E3          	SETSTAT:
 481:19540+4	F9E3  B7      		OR	A
 482:19544+7+5	F9E4  200A    		JR	NZ,SSTS1	;JUMP IF SOME DISK ERROR INDICATED
 483:				
 484:19551+19	F9E6  FD770D  		LD	(IY+HDWSTS),A	;ELSE STORE ZEROS IN HARDWARE STATUS
 485:19570+7	F9E9  1E43    		LD	E,'C'		;LOAD E WITH 'COMPLETE' CHARACTER
 486:19577+23	F9EB  FDCB0C96		RES	BADRW,(IY+CMDSTS)
 487:19600+10	F9EF  C9      		RET
 488:				;
 489:				;	ACC HOLDS NON-ZERO VALUE INDICATING A DISK ERROR
 490:				;
 491:19610+8	F9F0  CB77    	SSTS1:	BIT	6,A		;BIT HOLDS WPROT STATUS AFTER WRITE
 492:19618+7+5	F9F2  2802    		JR	Z,SSTS2
 493:				
 494:19625+7	F9F4  E69F    		AND	10011111B
 495:				
 496:19632+8	F9F6  CB6F    	SSTS2:	BIT	5,A		;HOLDS DD MARK STATUS AFTER READ
 497:19640+7+5	F9F8  2802    		JR	Z,SSTS3
 498:				
 499:19647+7	F9FA  F660    		OR	01100000B	;CREATE 1771 DD ADDRESS MARK STATUS
 500:				
 501:19654+4	F9FC  4F      	SSTS3:	LD	C,A
 502:19658+7	F9FD  E681    		AND	10000001B	;TEST FOR 'READY' OR 'BUSY' BITS SET
 503:19665+4	F9FF  79      		LD	A,C
 504:19669+7+5	FA00  2804    		JR	Z,SSTS4		;JUMP IF NOT READY/BUSY LOCK UP
 505:				
 506:19676+7	FA02  E67E    		AND	01111110B	;ELSE CLEAR BOTH BITS AND REPLACE
 507:19683+7	FA04  F610    		OR	00010000B	; WITH 'RNF' ERROR BIT INSTEAD
 508:				
 509:19690+19	FA06  FD770D  	SSTS4:	LD	(IY+HDWSTS),A	;STORE HARDWARE STATUS FOR ATARI
 510:19709+7	FA09  1E45    		LD	E,'E'		;LOAD E WITH 'ERROR' CHARACTER
 511:19716+23	FA0B  FDCB0CD6		SET	BADRW,(IY+CMDSTS)
 512:19739+10	FA0F  C9      		RET
 513:				;
 514:				;
 515:				;
 516:				;
 517:				;
 518:				;
 519:     -	FA10          	SECTRAN:
 520:				;	BIT	CONFIG,(IY+FLAGS)
 521:				;	JP	NZ,STRAN3	;SKIP IF DRIVE HAS BEEN CONFIGURED
 522:				
 523:19749+13	FA10  3A2EFF  		LD	A,(DRVOFF)
 524:19762+4	FA13  B7      		OR	A
 525:19766+7+5	FA14  2811    		JR	Z,STRAN2	;JUMP IF DRIVES HAVE NOT BEEN STOPPED
 526:				
 527:19773+4	FA16  AF      		XOR	A
 528:19777+13	FA17  322EFF  		LD	(DRVOFF),A	;CLEAR DRIVES-STOPPED FLAGS
 529:19790+10	FA1A  2164FF  		LD	HL,DMATRIX+FLAGS
 530:19800+10	FA1D  111000  		LD	DE,16
 531:19810+7	FA20  0604    		LD	B,4
 532:19817+15	FA22  CB86    	STRAN1:	RES	FIRST,(HL)	;ZIP THRU ARRAY RESETING 'FIRST' FLAGS
 533:19832+11	FA24  19      		ADD	HL,DE		; TO FORCE MEDIA TO BE EXAMINED ANEW
 534:19843+8+5	FA25  10FB    		DJNZ	STRAN1
 535:				
 536:19851+20	FA27  FDCB0E46	STRAN2:	BIT	FIRST,(IY+FLAGS)
 537:19871+7+5	FA2B  206D    		JR	NZ,STRAN3	;SKIP MEDIA CHECK IF DRIVE IS ACTIVE
 538:				
 539:19878+7	FA2D  3E03    		LD	A,GETID
 540:19885+13	FA2F  3298FF  		LD	(DKIOCB+DSKOP),A
 541:19898+13	FA32  3A99FF  		LD	A,(DKIOCB+DSKDRV)
 542:19911+10	FA35  2120FF  		LD	HL,DRVTAB
 543:19921+4	FA38  85      		ADD	A,L
 544:19925+4	FA39  6F      		LD	L,A		;POINT TO HEAD POSITION FOR DRIVE#
 545:19929+7	FA3A  7E      		LD	A,(HL)
 546:19936+7	FA3B  FE50    		CP	80
 547:19943+7+5	FA3D  3801    		JR	C,STR20		;JUMP IF TRACK# IN VALID RANGE
 548:19950+4	FA3F  AF      		XOR	A		;ELSE GOTO TRACK ZERO
 549:19954+13	FA40  329AFF  	STR20:	LD	(DKIOCB+DSKTRK),A
 550:19967+10	FA43  21ABFF  		LD	HL,IDBUF
 551:19977+16	FA46  229CFF  		LD	(DKIOCB+DSKPTR),HL
 552:19993+14	FA49  DD2198FF		LD	IX,DKIOCB
 553:20007+17	FA4D  CD0FF0  		CALL	DISKV		;READ AN ID MARK FROM CURRENT TRACK
 554:20024+13	FA50  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 555:20037+4	FA53  B7      		OR	A
 556:20041+5+6	FA54  C0      		RET	NZ		;EXIT IF DISK ERROR ON READ-ID
 557:				;
 558:				;	ARRIVE HERE TO SET DISK PARAMS IMPLICITLY
 559:				;
 560:20046+13	FA55  3AAEFF  		LD	A,(IDBUF+3)	;GET SECTOR LENGTH BYTE FROM ID
 561:20059+17	FA58  CDCDFA  		call	getsize		;compute sector length in bytes
 562:20076+19	FA5B  FD7006  		ld	(iy+seclen),b
 563:20095+19	FA5E  FD7107  		ld	(iy+seclen+1),c	;store result in 'seclen' param slot
 564:20114+13	FA61  3A9EFF  		LD	A,(DKIOCB+DSKAUX)
 565:20127+4	FA64  07      		RLCA
 566:20131+4	FA65  07      		RLCA
 567:20135+4	FA66  07      		RLCA
 568:20139+4	FA67  2F      		CPL
 569:20143+7	FA68  E606    		AND	00000110B	;MAKE PERCOM DENSITY/SIZE BITS
 570:20150+19	FA6A  FD7705  		LD	(IY+MEDIA),A
 571:20169+8	FA6D  CB4F    		BIT	SIZE,A
 572:20177+7+5	FA6F  2807    		JR	Z,STR25		;JUMP IF FIVE INCH DISK SELECTED
 573:				
 574:20184+7	FA71  3E4D    		LD	A,77
 575:20191+10	FA73  211A00  		LD	HL,26
 576:20201+12	FA76  1805    		JR	STR26
 577:				;
 578:20213+7	FA78  3E28    	STR25:	LD	A,40
 579:20220+10	FA7A  211200  		LD	HL,18
 580:20230+19	FA7D  FDBE00  	str26:	cp	(iy+ntrks)
 581:20249+7+5	FA80  3803    		jr	c,str27		;skip if ntrks has been set > default
 582:20256+19	FA82  FD7700  		ld	(iy+ntrks),a	;else set param to default value
 583:20275+19	FA85  FD7402  	STR27:	LD	(IY+NSECS),H
 584:20294+19	FA88  FD7503  		LD	(IY+NSECS+1),L	;STORE SECTORS PER TRACK PARAM
 585:				
 586:20313+23	FA8B  FDCB0EC6		SET	FIRST,(IY+FLAGS)
 587:20336+16	FA8F  2A96FF  		LD	HL,(OLDPTR)
 588:20352+4	FA92  7C      		LD	A,H
 589:20356+4	FA93  B5      		OR	L
 590:20360+7+5	FA94  2004    		JR	NZ,STRAN3	;JUMP IF NOT THE FIRST-EVER DISKOP
 591:				
 592:20367+20	FA96  FD2296FF		LD	(OLDPTR),IY	;ELSE SET POINTER TO THIS GUYS STUFF
 593:				;
 594:				;	ARRIVE HERE TO COMPUTE TRACK/SECTOR AND SET DISK BYTECOUNT
 595:				;
 596:20387+16	FA9A  2AFDC2  	STRAN3:	LD	HL,(CFRAME+2)
 597:20403+6	FA9D  2B      		DEC	HL		;REMOVE +1 BIAS FROM SECTOR NUMBER
 598:20409+7	FA9E  1600    		LD	D,0
 599:20416+19	FAA0  FD5E03  		LD	E,(IY+NSECS+1)
 600:20435+7	FAA3  3EFF    		LD	A,-1
 601:20442+4	FAA5  3C      	STRAN4:	INC	A
 602:20446+4	FAA6  B7      		OR	A
 603:20450+15	FAA7  ED52    		SBC	HL,DE
 604:20465+7+5	FAA9  30FA    		JR	NC,STRAN4	;DIVIDE ABSOLUTE SECTOR NUMBER BY SPT
 605:20472+11	FAAB  19      		ADD	HL,DE
 606:20483+6	FAAC  23      		INC	HL		;RESTORE +1 BIAS TO SECTOR NUMBER
 607:20489+4	FAAD  4D      		LD	C,L
 608:20493+10	FAAE  219BFF  		LD	HL,DKIOCB+DSKSEC
 609:20503+7	FAB1  71      		LD	(HL),C		;STORE PHYSICAL SECTOR#
 610:				
 611:20510+19	FAB2  FDBE00  		CP	(IY+NTRKS)	;COMPARE RESULT FROM TRACK# COMPUTATION
 612:20529+7+5	FAB5  3808    		JR	C,STRAN5	; TO 'NTRKS' PARAM AND JUMP IF LESS
 613:				
 614:20536+19	FAB7  FD9600  		SUB	(IY+NTRKS)	;ELSE SUBTRACT EXTRA AND SELECT SIDE# 1
 615:20555+10	FABA  2199FF  		LD	HL,DKIOCB+DSKDRV
 616:20565+15	FABD  CBFE    		SET	7,(HL)
 617:				
 618:20580+13	FABF  329AFF  	STRAN5:	LD	(DKIOCB+DSKTRK),A  ;STORE PHYSICAL TRACK#
 619:20593+19	FAC2  FD6606  		LD	H,(IY+SECLEN)
 620:20612+19	FAC5  FD6E07  		LD	L,(IY+SECLEN+1)
 621:20631+16	FAC8  229EFF  		LD	(DKIOCB+DSKAUX),HL  ;STORE PHYSICAL SECTOR SIZE FOR I/O
 622:20647+4	FACB  AF      		XOR	A
 623:20651+10	FACC  C9      		RET
 624:				;
 625:				;
 626:				;
 627:     -	FACD          	getsize:
 628:20661+10	FACD  018000  		ld	bc,128
 629:20671+7	FAD0  E603    		and	00000011b
 630:20678+5+6	FAD2  C8      		ret	z		;sector length code=0 means 128 bytes
 631:				
 632:20683+8	FAD3  CB21    	getsz2:	sla	c
 633:20691+8	FAD5  CB10    		rl	b		;else multiply 128 by 2,4 or 8
 634:20699+4	FAD7  3D      		dec	a
 635:20703+7+5	FAD8  20F9    		jr	nz,getsz2
 636:20710+10	FADA  C9      		ret
 637:				;
 638:				;
 639:				;
 640:				;
 641:				;
 642:				;	... DISK STATUS COMMAND PROCESSOR ...
 643:				;
 644:     -	FADB          	DISKSTAT:
 645:20720+17	FADB  CD28FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 646:20737+5+6	FADE  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 647:				
 648:20742+17	FADF  CD4AFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 649:20759+17	FAE2  CDD3FB  		CALL	HASPARMS	;CHECK IF HAS NEVER BEEN ACCESSED
 650:20776+13	FAE5  3AC9FF  		LD	A,(DRVTMR)
 651:20789+11	FAE8  F5      		PUSH	AF		;SAVE DRIVE TIMER VALUE RIGHT NOW
 652:20800+7	FAE9  3E00    		LD	A,TSTRDY
 653:20807+13	FAEB  3298FF  		LD	(DKIOCB+DSKOP),A
 654:20820+14	FAEE  DD2198FF		LD	IX,DKIOCB
 655:20834+17	FAF2  CD0FF0  		CALL	DISKV		;CALL DISK HANDLER TO GET TYPE 1 STATUS
 656:				
 657:20851+19	FAF5  FD4E0C  		LD	C,(IY+CMDSTS)	;PREPARE TO DERRIVE REST OF 'CMDSTS'
 658:20870+19	FAF8  FD360C00		LD	(IY+CMDSTS),0	; AND RESET OLD STATUS BITS
 659:20889+10	FAFC  F1      		POP	AF
 660:20899+4	FAFD  B7      		OR	A
 661:20903+7+5	FAFE  2804    		JR	Z,DSTAT1	;JUMP IF DRIVES WERE PREVIOUSLY STOPPED
 662:				
 663:20910+8	FB00  CBE1    		SET	ACTIVE,C
 664:20918+12	FB02  1802    		JR	DSTAT2
 665:				;
 666:20930+8	FB04  CBA1    	DSTAT1:	RES	ACTIVE,C
 667:20938+20	FB06  FDCB0556	DSTAT2:	BIT	DENSTY,(IY+MEDIA)
 668:20958+7+5	FB0A  2804    		JR	Z,DSTAT3	;JUMP IF DRIVE SET FOR SINGLE DENSITY
 669:				
 670:20965+8	FB0C  CBE9    		SET	SEC256,C
 671:20973+12	FB0E  1802    		JR	DSTAT4
 672:				;
 673:20985+8	FB10  CBA9    	DSTAT3:	RES	SEC256,C
 674:20993+20	FB12  DDCB0876	DSTAT4:	BIT	6,(IX+DSKSTS)
 675:21013+7+5	FB16  2804    		JR	Z,DSTAT5	;JUMP IF DRIVE IS NOT WRITE PROTECTED
 676:				
 677:21020+8	FB18  CBD9    		SET	WRPROT,C
 678:21028+12	FB1A  1802    		JR	DSTAT6
 679:				;
 680:21040+8	FB1C  CB99    	DSTAT5:	RES	WRPROT,C
 681:21048+10	FB1E  21FCC2  	DSTAT6:	LD	HL,IOBUFF+LEN-4
 682:21058+11	FB21  E5      		PUSH	HL
 683:21069+7	FB22  71      		LD	(HL),C		;STORE DRIVE COMMAND STATUS IN BUFFER
 684:21076+6	FB23  23      		INC	HL
 685:21082+19	FB24  FD7E0D  		LD	A,(IY+HDWSTS)
 686:21101+4	FB27  2F      		CPL
 687:21105+7	FB28  77      		LD	(HL),A		;STORE HARDWARE POOP NEXT
 688:21112+6	FB29  23      		INC	HL
 689:21118+10	FB2A  36E0    		LD	(HL),224	;STORE MAX TIMEOUT AFTER THAT
 690:21128+6	FB2C  23      		INC	HL
 691:21134+13	FB2D  3A2DFF  		LD	A,(TRACK)
 692:21147+7	FB30  77      		LD	(HL),A		;STORE TRACK# AS FOURTH BYTE
 693:21154+10	FB31  E1      		POP	HL
 694:21164+10	FB32  114300  		LD	DE,'C'		;SEND DISK STATUS W/O COMPLIMENT
 695:21174+10	FB35  C36CF6  		JP	SENDBUFF
 696:				;	ret
 697:				;
 698:				;
 699:				;
 700:				;	... DISK FORMAT COMMAND PROCESSOR ...
 701:				;
 702:     -	FB38          	DISKINIT:
 703:21184+17	FB38  CD28FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 704:21201+5+6	FB3B  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 705:				
 706:21206+16	FB3C  2A4FFF  		LD	HL,(PCOUNT)
 707:21222+4	FB3F  7C      		LD	A,H
 708:21226+4	FB40  B5      		OR	L
 709:21230+5+6	FB41  C0      		RET	NZ		;REFUSE TO FORMAT IF SPOOLER ACTIVE
 710:				
 711:21235+17	FB42  CDD3FB  		CALL	HASPARMS
 712:21252+5+6	FB45  C8      		RET	Z		;REFUSE TO FORMAT IF PARAMS NOT SET
 713:				
 714:21257+17	FB46  CD4AFC  		CALL	SENDACK
 715:21274+7	FB49  3E00    		LD	A,TSTRDY
 716:21281+13	FB4B  3298FF  		LD	(DKIOCB+DSKOP),A
 717:21294+14	FB4E  DD2198FF		LD	IX,DKIOCB
 718:21308+17	FB52  CD0FF0  		CALL	DISKV		;CALL DRIVER TO TEST READY/WRITE PROT
 719:21325+17	FB55  CDB6F3  		CALL	STOPTMR		;THEN KILL CTC3 TO STOP DISK TIMER
 720:21342+13	FB58  3A2FFF  		LD	A,(OUTCPY)
 721:21355+20	FB5B  FDCB0556		BIT	DENSTY,(IY+MEDIA)
 722:21375+7+5	FB5F  2807    		JR	Z,DINIT2
 723:				
 724:21382+8	FB61  CBBF    		RES	7,A		;RESET DENSITY BIT OF CONTROL BYTE
 725:21390+10	FB63  2100C2  		LD	HL,IOBUFF+LEN-256
 726:21400+12	FB66  1805    		JR	DINIT3
 727:				;
 728:21412+8	FB68  CBFF    	DINIT2:	SET	7,A		;SET SD/DD BIT IF SINGLE DENSITY
 729:21420+10	FB6A  2180C2  		LD	HL,IOBUFF+LEN-128
 730:21430+13	FB6D  322FFF  	DINIT3:	LD	(OUTCPY),A
 731:21443+11	FB70  D330    		OUT	(LATCH),A
 732:21454+11	FB72  E5      		PUSH	HL
 733:21465+16	FB73  22C1FF  		LD	(SEQPTR),HL	;STORE POINTER FOR BAD SECTOR LIST
 734:21481+10	FB76  210100  		LD	HL,1
 735:21491+16	FB79  22BFFF  		LD	(SEQNUM),HL	;RESET BAD SECTOR COUNTER
 736:21507+16	FB7C  2A49FF  		LD	HL,(FMTPTR)
 737:21523+10	FB7F  11B6FF  		LD	DE,FMTSTUFF
 738:21533+10	FB82  010700  		LD	BC,FMTLEN
 739:21543+4	FB85  07      		RLCA
 740:21547+4	FB86  07      		RLCA
 741:21551+7	FB87  E603    		AND	00000011B
 742:21558+7+5	FB89  2804    		JR	Z,SFMT3
 743:21565+11	FB8B  09      	SFMT2:	ADD	HL,BC
 744:21576+4	FB8C  3D      		DEC	A
 745:21580+7+5	FB8D  20FC    		JR	NZ,SFMT2	;INDEX TO PROPER PARAMS FOR DISK TYPE
 746:21587+16+5	FB8F  EDB0    	SFMT3:	LDIR			;THEN COPY PARAMS TO 'FMTSTUFF'
 747:21603+13	FB91  3AA0FF  		LD	A,(DKIOCB+DSKSTS)
 748:21616+7	FB94  E6C0    		AND	11000000B
 749:21623+7+5	FB96  2013    		JR	NZ,DINIT6	;ERROR IF NOT READY OR WRITE PROTECTED
 750:				
 751:21630+19	FB98  FD7E04  		ld	a,(iy+nsides)	;set for SS/DS init
 752:21649+13	FB9B  32BDFF  		ld	(sides),a
 753:21662+19	FB9E  FD7E00  		ld	a,(iy+ntrks)	;set for number of tracks
 754:21681+13	FBA1  32BEFF  		ld	(tracks),a
 755:21694+15	FBA4  FDE5    		PUSH	IY
 756:21709+17	FBA6  CDBEFC  		CALL	FORMAT		;CALL FORMAT SUBROUTINE
 757:21726+14	FBA9  FDE1    		POP	IY
 758:				
 759:21740+10	FBAB  E1      	DINIT6:	POP	HL
 760:21750+17	FBAC  CDE3F9  		CALL	SETSTAT		;UPDATE STATUS AS SPECIFIED BY ACC
 761:21767+7	FBAF  1600    		LD	D,0
 762:21774+17	FBB1  CD6CF6  		CALL	SENDBUFF	;SEND BAD SECTOR DATA FRAME
 763:21791+10	FBB4  C33CF0  		JP	ACTIVON		;THEN RESTART THE DISK TIMER
 764:				;	ret
 765:				;
 766:				;
 767:				;
 768:				;
 769:				;
 770:     -	FBB7          	FMTS:
 771:     -	FBB7  9FFE    		DEFW	DD8N26		;DOUBLE DENSITY 8 INCH
 772:     -	FBB9  E2FE    		DEFW	SKEW17
 773:     -	FBBB  1A      		DEFB	26
 774:     -	FBBC  B028    		DEFW	10416
 775:				
 776:     -	FBBE  35FE    		DEFW	DD5N18		;DOUBLE DENSITY 5 INCH
 777:     -	FBC0  68FE    		DEFW	SKEWDD
 778:     -	FBC2  12      		DEFB	18
 779:     -	FBC3  6A18    		DEFW	6250
 780:				
 781:     -	FBC5  7AFE    		DEFW	SD8N26		;SINGLE DENSITY 8 INCH
 782:     -	FBC7  C8FE    		DEFW	SKEW13
 783:     -	FBC9  1A      		DEFB	26
 784:     -	FBCA  5814    		DEFW	5208
 785:				
 786:     -	FBCC  16FE    		DEFW	SD5N18		;SINGLE DENSITY 5 INCH
 787:     -	FBCE  56FE    		DEFW	SKEWSD
 788:     -	FBD0  12      		DEFB	18
 789:     -	FBD1  350C    		DEFW	3125
 790:				;
 791:				;
 792:				;
 793:				;
 794:     -	FBD3          	HASPARMS:
 795:21801+19	FBD3  FD7E00  		LD	A,(IY+NTRKS)
 796:21820+4	FBD6  B7      		OR	A
 797:21824+5+6	FBD7  C0      		RET	NZ		;EXIT IF PARAMS HAVE BEEN SET
 798:				
 799:21829+16	FBD8  2A96FF  		LD	HL,(OLDPTR)
 800:21845+4	FBDB  7C      		LD	A,H		;IF POINTER IS ZERO THEN NO DRIVE
 801:21849+4	FBDC  B5      		OR	L		; PARAMS HAVE EVER BEEN SET
 802:21853+5+6	FBDD  C8      		RET	Z
 803:				
 804:21858+15	FBDE  FDE5    		PUSH	IY
 805:21873+10	FBE0  D1      		POP	DE
 806:21883+10	FBE1  010C00  		LD	BC,12
 807:21893+16+5	FBE4  EDB0    		LDIR			;COPY BOOT DISK'S PARAMS TO THIS GUY
 808:21909+10	FBE6  C9      		RET
 809:				;
 810:				;
 811:				;
 812:				;
 813:				;	... PERCOM 'N' COMMAND PROCESSOR ...
 814:				;
 815:     -	FBE7          	GETPARAMS:
 816:21919+17	FBE7  CD28FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 817:21936+5+6	FBEA  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 818:				
 819:21941+17	FBEB  CDD3FB  		CALL	HASPARMS
 820:21958+5+6	FBEE  C8      		RET	Z		;EXIT IF DISK PARAMS NOT KNOWN
 821:				
 822:21963+17	FBEF  CD4AFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 823:				;	SET	CONFIG,(IY+FLAGS)
 824:21980+15	FBF2  FDE5    		PUSH	IY
 825:21995+10	FBF4  E1      		POP	HL
 826:22005+10	FBF5  11F4C2  		LD	DE,IOBUFF+LEN-12
 827:22015+11	FBF8  D5      		PUSH	DE
 828:22026+10	FBF9  010C00  		LD	BC,12
 829:22036+16+5	FBFC  EDB0    		LDIR			;COPY PARAMS TO OUTPUT BUFFER
 830:22052+10	FBFE  E1      		POP	HL
 831:22062+10	FBFF  114300  		LD	DE,'C'
 832:22072+10	FC02  C36CF6  		JP	SENDBUFF	;SEND 'C' AND PARAMS DATA FRAME
 833:				;	ret
 834:				;
 835:				;
 836:				;
 837:				;	... PERCOM 'O' COMMAND PROCESSOR ...
 838:				;
 839:     -	FC05          	PUTPARAMS:
 840:22082+17	FC05  CD28FC  		CALL	DRVINDEX	;POINT IY TO DRIVE'S DATA AREA
 841:22099+5+6	FC08  D8      		RET	C		;EXIT IF NOT A DRIVE IN OUR BOX
 842:				
 843:22104+17	FC09  CD4AFC  		CALL	SENDACK
 844:22121+17	FC0C  CDB9F6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
 845:22138+5+6	FC0F  C0      		RET	NZ
 846:				
 847:22143+10	FC10  110C00  		LD	DE,12
 848:22153+4	FC13  B7      		OR	A
 849:22157+15	FC14  ED52    		SBC	HL,DE
 850:22172+5+6	FC16  C0      		RET	NZ		;ERROR IF DATA FRAME NOT 12 BYTES
 851:				
 852:22177+17	FC17  CD4AFC  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
 853:				;	SET	CONFIG,(IY+FLAGS)  ;INDICATE DRIVE IS NOW CONFIGURED
 854:22194+10	FC1A  2100C1  		LD	HL,IOBUFF
 855:22204+15	FC1D  FDE5    		PUSH	IY
 856:22219+10	FC1F  D1      		POP	DE		;POINT DE TO PARAMETERS FOR DRIVE(N)
 857:22229+10	FC20  010C00  		LD	BC,12
 858:22239+16+5	FC23  EDB0    		LDIR			;COPY NEW STUFF IN THE PLACE
 859:22255+10	FC25  C354FC  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
 860:				;	ret
 861:				;
 862:				;
 863:				;
 864:				;	... DATA STRUCTURE FOR DRIVE PARAMETER BLOCKS ...
 865:				;
 866:     -	0000          	NTRKS	EQU	0		;NUMBER OF TRACKS
 867:     -	0001          	STEPRT	EQU	1		;STEP RATE
 868:     -	0002          	NSECS	EQU	2		;SECTORS PER TRACK (HI/LOW)
 869:     -	0004          	NSIDES	EQU	4		;NUMBER OF SIDES
 870:     -	0005          	MEDIA	EQU	5		;MEDIA SIZE AND FORMAT BITS
 871:     -	0006          	SECLEN	EQU	6		;SECTOR LENGTH (HI/LOW)
 872:     -	0008          	DSKBITS	EQU	8		;MISC NAUGHTY BITS
 873:     -	0009          	SPARE0	EQU	9
 874:     -	000A          	SPARE1	EQU	10
 875:     -	000B          	SPARE2	EQU	11
 876:				
 877:     -	000C          	CMDSTS	EQU	12		;COMMAND STATUS
 878:     -	000D          	HDWSTS	EQU	13		;HARDWARE STATUS
 879:				
 880:     -	000E          	FLAGS	EQU	14		;FLAGS BYTE FOR DISK OPERATION
 881:     -	000F          	SPARE3	EQU	15
 882:				;
 883:				;
 884:				;	EQUATES FOR BITS IN 'MEDIA' BYTE
 885:				;
 886:     -	0001          	SIZE	EQU	1		;DISK SIZE (1=EIGHT, 0=FIVE)
 887:     -	0002          	DENSTY	EQU	2		;DENSITY (1=DOUBLE, 0=SINGLE)
 888:				;
 889:				;
 890:				;	EQUATES FOR BITS IN 'DSKBITS' BYTE
 891:				;
 892:     -	0006          	PRESENT	EQU	6		;DRIVE PRESENT (1=PRESENT)
 893:				;
 894:				;
 895:				;	EQUATES FOR BITS IN 'CMDSTS' BYTE
 896:				;
 897:     -	0000          	BADCMD	EQU	0		;BAD COMMAND FRAME BIT
 898:     -	0001          	BADDAT	EQU	1		;BAD DATA FRAME BIT
 899:     -	0002          	BADRW	EQU	2		;BAD READ/WRITE OPERATION BIT
 900:     -	0003          	WRPROT	EQU	3		;WRITE PROTECTED BIT
 901:     -	0004          	ACTIVE	EQU	4		;DRIVE READY INDICATOR BIT
 902:     -	0005          	SEC256	EQU	5		;LONG/SHORT SECTOR BIT
 903:				;
 904:				;
 905:				;	EQUATES FOR BITS IN 'FLAGS' BYTE
 906:				;
 907:     -	0000          	FIRST	EQU	0		;FIRST ACCESS FLAG (0=NOT ACCESSED)
 908:     -	0001          	CONFIG	EQU	1		;DRIVE CONFIGURED BIT (0=UNCONFIGED)
 909:				;
 910:				;
 911:				;
 912:				;
 913:				;
 914:     -	FC28          	DRVINDEX:
 915:22265+13	FC28  3AFBC2  		LD	A,(CFRAME)	;GET DRIVE# FROM COMAND FRAME
 916:22278+7	FC2B  D631    		SUB	'1'
 917:22285+7	FC2D  FE04    		CP	4
 918:22292+4	FC2F  3F      		CCF
 919:22296+5+6	FC30  D8      		RET	C		;EXIT IF NOT DRIVE 1,2,3 OR 4
 920:				
 921:22301+7	FC31  2600    		LD	H,0
 922:22308+4	FC33  6F      		LD	L,A
 923:22312+11	FC34  29      		ADD	HL,HL
 924:22323+11	FC35  29      		ADD	HL,HL
 925:22334+11	FC36  29      		ADD	HL,HL
 926:22345+11	FC37  29      		ADD	HL,HL		;MULTIPLY DRIVE INDEX BY 16
 927:22356+10	FC38  0156FF  		LD	BC,DMATRIX
 928:22366+11	FC3B  09      		ADD	HL,BC		;INDEX TO DRIVE'S PARAMETERS
 929:22377+11	FC3C  E5      		PUSH	HL
 930:22388+14	FC3D  FDE1    		POP	IY		;GET POINTER INTO IY FOR RETURN
 931:22402+20	FC3F  FDCB0876		BIT	PRESENT,(IY+DSKBITS)
 932:22422+4	FC43  37      		SCF
 933:22426+5+6	FC44  C8      		RET	Z		;EXIT IT DRIVE NOT PRESENT
 934:				
 935:22431+13	FC45  3299FF  		LD	(DKIOCB+DSKDRV),A
 936:22444+4	FC48  AF      		XOR	A
 937:22448+10	FC49  C9      		RET
 938:				;
 939:				;
 940:				;
 941:				;
 942:     -	FC4A          	SENDACK:
 943:22458+11	FC4A  DB70    		IN	A,(ATARI)
 944:22469+8	FC4C  CB4F    		BIT	1,A
 945:22477+7+5	FC4E  28FA    		JR	Z,SENDACK
 946:				
 947:22484+7	FC50  3E41    		LD	A,'A'
 948:22491+12	FC52  1802    		JR	SENDCHAR
 949:				;
 950:     -	FC54          	SENDCOMP:
 951:22503+7	FC54  3E43    		LD	A,'C'
 952:     -	FC56          	SENDCHAR:
 953:22510+10	FC56  2101C3  		LD	HL,IOBUFF+LEN+1
 954:22520+7	FC59  77      		LD	(HL),A
 955:22527+7	FC5A  1600    		LD	D,0		;SET FOR TRUE DATA
 956:22534+10	FC5C  C384F6  		JP	XMITBUF		;SEND 1 BYTE BLOCK TO ATARI
 957:				;	ret
 958:				;
 959:				;
 960:				;
 961:				;
 962:				;	... Z80 MEMORY READ COMMAND PROCESSOR ...
 963:				;
 964:     -	FC5F          	Z80READ:
 965:22544+17	FC5F  CD4AFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND
 966:22561+17	FC62  CD9CFC  		CALL	ZLENGTH		;GET ZCMD BYTECOUNT INTO BC
 967:22578+10	FC65  2100C3  		LD	HL,IOBUFF+LEN
 968:22588+4	FC68  B7      		OR	A
 969:22592+15	FC69  ED42    		SBC	HL,BC
 970:22607+11	FC6B  E5      		PUSH	HL
 971:22618+4	FC6C  EB      		EX	DE,HL
 972:22622+16	FC6D  2AB2FC  		LD	HL,(MEMPTR)
 973:22638+4	FC70  F3      		DI
 974:22642+16+5	FC71  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
 975:22658+4	FC73  FB      		EI
 976:22662+10	FC74  E1      		POP	HL
 977:22672+10	FC75  114300  		LD	DE,'C'		;SEND DATA W/O INVERSION
 978:22682+10	FC78  C36CF6  		JP	SENDBUFF
 979:				;	ret
 980:				;
 981:				;
 982:				;
 983:				;	... Z80 MEMORY WRITE COMMAND PROCESSOR ...
 984:				;
 985:     -	FC7B          	Z80WRITE:
 986:22692+17	FC7B  CD4AFC  		CALL	SENDACK		;SEND 'ACK' FOR COMMAND FRAME
 987:22709+17	FC7E  CDB9F6  		CALL	RECVBUFF	;ATTEMPT TO READ DATA FRAME FROM ATARI
 988:22726+5+6	FC81  C0      		RET	NZ
 989:				
 990:22731+17	FC82  CD9CFC  		CALL	ZLENGTH		;GET BYTECOUNT FROM CMD FRAME
 991:22748+4	FC85  B7      		OR	A
 992:22752+15	FC86  ED42    		SBC	HL,BC
 993:22767+5+6	FC88  C0      		RET	NZ		;ERROR IF DATA FRAME LENGTH NOT SAME
 994:				
 995:22772+11	FC89  C5      		PUSH	BC
 996:22783+17	FC8A  CD4AFC  		CALL	SENDACK		;ELSE SEND 'ACK' FOR DATA FRAME
 997:22800+10	FC8D  C1      		POP	BC
 998:22810+10	FC8E  2100C1  		LD	HL,IOBUFF
 999:22820+20	FC91  ED5BB2FC		LD	DE,(MEMPTR)
1000:22840+4	FC95  F3      		DI
1001:22844+16+5	FC96  EDB0    		LDIR			;DO BLOCK MOVE INTO BUFFER
1002:22860+4	FC98  FB      		EI
1003:22864+10	FC99  C354FC  		JP	SENDCOMP	;SEND 'COMPLETE' BACK TO ATARI
1004:				;	ret
1005:				;
1006:				;
1007:				;
1008:     -	FC9C          	ZLENGTH:
1009:22874+13	FC9C  3AFDC2  		LD	A,(CFRAME+2)	;GET BYTECOUNT FROM COMMAND FRAME
1010:22887+4	FC9F  4F      		LD	C,A
1011:22891+7	FCA0  0600    		LD	B,0		;LOAD BC WITH BYTECOUNT
1012:22898+4	FCA2  B7      		OR	A
1013:22902+5+6	FCA3  C0      		RET	NZ		;EXIT IF BYTECOUNT NOT=0
1014:				
1015:22907+4	FCA4  04      		INC	B		;ELSE MAKE BC=256
1016:22911+10	FCA5  C9      		RET
1017:				;
1018:				;
1019:				;	... Z80 SET MEMORY POINTER COMMAND PROCESSOR ...
1020:				;
1021:     -	FCA6          	Z80SET:
1022:22921+17	FCA6  CD4AFC  		CALL	SENDACK
1023:22938+16	FCA9  2AFDC2  		LD	HL,(CFRAME+2)	;SET MEMORY POINTER FROM COMMAND
1024:22954+16	FCAC  22B2FC  		LD	(MEMPTR),HL
1025:22970+10	FCAF  C354FC  		JP	SENDCOMP
1026:				;	ret
1027:				;
1028:				;
1029:     -	FCB2  0000    	MEMPTR:	DEFW	0		;POINTER FOR MEMORY READ/WRITE
1030:				;
1031:				;
1032:				;	... Z80 GOTO MEMORY LOCATION COMMAND PROCESSOR ...
1033:				;
1034:     -	FCB4          	Z80GOTO:
1035:22980+17	FCB4  CD4AFC  		CALL	SENDACK
1036:22997+17	FCB7  CD54FC  		CALL	SENDCOMP
1037:23014+16	FCBA  2AFDC2  		LD	HL,(CFRAME+2)
1038:23030+4	FCBD  E9      		jp	(hl)		;execute routine @hl
1039:				;
1040:				;
1041:				;
1042:				;
**** ..\src\sally2.asm ****
  56:					INCLUDE	FORMAT.MAC
**** ..\src\FORMAT.MAC ****
   1:					;PAGE
   2:				;****************************************************************
   3:				;*								*
   4:				;*								*
   5:				;****************************************************************
   6:				;
   7:				;	... DISKETTE INITIALIZATION ROUTINE ...
   8:				;
   9:				;	'IOBUFF' UTILIZATION IN FORMAT FUNCTION:
  10:				;
  11:				;	|---------------|  IOBUFF
  12:				;	|		|
  13:				;	| BAD SEC NUMS	|	STARTS @ LEN-(128+1) OR LEN-(256+1)
  14:				;	|		|
  15:				;	|---------------|  +LEN
  16:				;	|		|
  17:				;	|  WRTTRK CODE  |	VARIABLE LENGTH HALT/NMI/OUTI ROUTINE
  18:				;	|		|
  19:				;	|---------------|  +N
  20:				;	|		|
  21:				;	|  TRACK IMAGE  |	POINTED TO BY 'TRKPTR'
  22:				;	|		|
  23:				;	|		|  +10200
  24:				;
  25:				;
  26:				;
  27:     -	FCBE          	FORMAT:
  28:23034+4	FCBE  AF      		XOR	A
  29:23038+11	FCBF  D356    		OUT	(INDXSET),A	;SET FLIPFLOP FOR NORMAL INDEX PULSES
  30:23049+4	FCC1  3C      		INC	A
  31:23053+11	FCC2  D354    		OUT	(INDXCLR),A
  32:23064+7	FCC4  3E01    		LD	A,RSTCMD+HLOAD+STEPRATE
  33:23071+17	FCC6  CD59F3  		CALL	TYP1CMD		;ISSUE SLOW RESTORE COMMAND
  34:23088+7	FCC9  EE04    		XOR	00000100B	;FLIP TK0 STATUS BIT
  35:23095+7	FCCB  E684    		AND	10000100B
  36:23102+10	FCCD  C29AFD  		JP	NZ,FORMX	;EXIT IF TRACK ZERO NOT INDICATED
  37:				
  38:23112+10	FCD0  2100C3  		LD	HL,IOBUFF+LEN	;PREP TO BUILD IN-LINE CODE FOR FORMAT
  39:23122+13	FCD3  3ABCFF  		LD	A,(TRKSIZ+1)
  40:23135+4	FCD6  3C      		INC	A
  41:23139+4	FCD7  47      		LD	B,A		;LOAD B WITH # OF PAGES/TRACK PLUS ONE
  42:23143+10	FCD8  3676    	FORM2:	LD	(HL),076H	;STORE 'HALT' OPCODE
  43:23153+6	FCDA  23      		INC	HL
  44:23159+10	FCDB  36ED    		LD	(HL),0EDH	;STORE 'OUTI' OPCODE BYTE #1
  45:23169+6	FCDD  23      		INC	HL
  46:23175+10	FCDE  36A3    		LD	(HL),0A3H	;STORE 'OUTI' OPCODE BYTE #2
  47:23185+6	FCE0  23      		INC	HL
  48:23191+10	FCE1  3620    		LD	(HL),020H	;STORE 'JRNZ' OPCODE BYTE
  49:23201+6	FCE3  23      		INC	HL
  50:23207+10	FCE4  36FB    		LD	(HL),-5		;STORE JUMP OFFSET FOR LOOP
  51:23217+6	FCE6  23      		INC	HL
  52:23223+8+5	FCE7  10EF    		DJNZ	FORM2
  53:23231+7	FCE9  3EC9    		LD	A,0C9H
  54:23238+7	FCEB  77      		LD	(HL),A		;STORE 'RET' OPCODE AT END
  55:23245+13	FCEC  326600  		LD	(0066H),A	;ALSO PLUNK ONE DOWN AT NMI VECTOR
  56:23258+6	FCEF  23      		INC	HL
  57:23264+16	FCF0  22C3FF  		LD	(TRKPTR),HL	;SAVE ADDRESS TO BEGIN TRACK IMAGE
  58:				
  59:23280+4	FCF3  AF      		XOR	A
  60:23284+13	FCF4  322DFF  	FORM3:	LD	(TRACK),A	;A HOLDS NEXT TRACK NUMBER
  61:23297+4	FCF7  B7      		OR	A
  62:23301+7+5	FCF8  2805    		JR	Z,FORM3A	;SKIP STEP-IN IF ON TRACK ZERO
  63:23308+7	FCFA  3E41    		LD	A,STEPIN+HLOAD+STEPRATE
  64:23315+17	FCFC  CD59F3  		CALL	TYP1CMD		;STEP TO NEXT TRACK
  65:23332+20	FCFF  DD2AB6FF	FORM3A:	LD	IX,(FRMPTR)	;GET SELECTED FORMAT DATA POINTER
  66:23352+20	FD03  FD2AB8FF		LD	IY,(SKWPTR)	;GET SELECTED SKEW TABLE POINTER
  67:23372+13	FD07  3ABDFF  		ld	a,(sides)
  68:23385+4	FD0A  1F      		rra
  69:23389+13	FD0B  3A2FFF  		ld	a,(outcpy)
  70:23402+7+5	FD0E  3007    		jr	nc,form3b	;jump if not formatting both sides
  71:23409+7	FD10  EE20    		xor	00100000b
  72:23416+13	FD12  322FFF  		ld	(outcpy),a	;else flip side select bit in latch
  73:23429+11	FD15  D330    		out	(latch),a
  74:23440+17	FD17  CDA4FD  	form3b:	call	build
  75:23457+13	FD1A  3A2DFF  		LD	A,(TRACK)
  76:23470+11	FD1D  D341    		OUT	(TRKREG),A
  77:23481+16	FD1F  2AC3FF  		LD	HL,(TRKPTR)	;POINT TO START OF TRACK IMAGE
  78:23497+4	FD22  F3      		DI
  79:23501+7	FD23  3EF4    		LD	A,WRTKDLY	;write track + 30ms settle delay
  80:23508+17	FD25  CD74F3  		CALL	CMDOUT		;ISSUE WRITE TRACK COMMAND
  81:23525+13	FD28  3ABBFF  		LD	A,(TRKSIZ)
  82:23538+4	FD2B  47      		LD	B,A		;LOAD B WITH TRACK SIZE MOD 256
  83:23542+7	FD2C  0E43    		LD	C,DATREG
  84:23549+17	FD2E  CD00C3  		CALL	IOBUFF+LEN	;EXECUTE WRITE TRACK FROM BUFFER
  85:23566+4	FD31  FB      		EI
  86:23570+11	FD32  DB40    	FORM4:	IN	A,(STSREG)
  87:23581+8	FD34  CB47    		BIT	0,A
  88:23589+7+5	FD36  20FA    		JR	NZ,FORM4
  89:23596+20	FD38  ED5BBFFF		LD	DE,(SEQNUM)	;LOAD DE WITH SEQUENCE NUMBER
  90:23616+16	FD3C  2AC1FF  		LD	HL,(SEQPTR)	; AND HL WITH CACA TABLE POINTER
  91:23632+13	FD3F  3ABAFF  		LD	A,(NSECTS)
  92:23645+4	FD42  47      		LD	B,A
  93:23649+20	FD43  DD2AB8FF		LD	IX,(SKWPTR)	;POINT TO SECTOR TABLE
  94:23669+19	FD47  DD7E00  	FORM5:	LD	A,(IX)
  95:23688+10	FD4A  DD23    		INC	IX
  96:23698+11	FD4C  D342    		OUT	(SECREG),A
  97:23709+13	FD4E  3A2FFF  		LD	A,(OUTCPY)
  98:23722+7	FD51  E620    		AND	00100000b
  99:23729+7	FD53  3E80    		LD	A,RDCMD		;determine if reading side 0 or 1
 100:23736+7+5	FD55  2802    		JR	Z,FORM51
 101:23743+8	FD57  CBCF    		SET	1,A		;WD1772 no side-no in cmd (I leave it there, doesn't seem to matter)
 102:23751+17	FD59  CD50F3  	FORM51:	CALL	TYP2CMD		;read sector discarding the data
 103:23768+7	FD5C  E698    		AND	10011000B	;TEST FOR READY/RNF/CRC ERROR INDICATION
 104:23775+7+5	FD5E  2814    		JR	Z,FORM6		;JUMP IF SECTOR READ OK
 105:				
 106:23782+7	FD60  E680    		AND	10000000B
 107:23789+7+5	FD62  2036    		JR	NZ,FORMX	;QUIT TRYING IF NOT-READY ERROR
 108:23796+11	FD64  E5      		PUSH	HL
 109:23807+11	FD65  C5      		PUSH	BC
 110:23818+10	FD66  01FDC2  		LD	BC,IOBUFF+LEN-3
 111:23828+4	FD69  B7      		OR	A
 112:23832+15	FD6A  ED42    		SBC	HL,BC		;TEST IF CA-CA SECTOR LIST IS FULL
 113:23847+10	FD6C  C1      		POP	BC
 114:23857+10	FD6D  E1      		POP	HL
 115:23867+7+5	FD6E  3004    		JR	NC,FORM6	;SKIP IF NO MORE ROOM
 116:23874+7	FD70  73      		LD	(HL),E
 117:23881+6	FD71  23      		INC	HL
 118:23887+7	FD72  72      		LD	(HL),D
 119:23894+6	FD73  23      		INC	HL		;STORE BAD SECTOR NUMBER
 120:23900+6	FD74  13      	FORM6:	INC	DE
 121:23906+8+5	FD75  10D0    		DJNZ	FORM5
 122:23914+20	FD77  ED53BFFF		LD	(SEQNUM),DE	;STORE UPDATED ERROR TRACE STUFF
 123:23934+16	FD7B  22C1FF  		LD	(SEQPTR),HL
 124:23950+13	FD7E  3A2FFF  		ld	a,(outcpy)
 125:23963+7	FD81  E620    		and	00100000b
 126:23970+10	FD83  C2FFFC  		jp	nz,form3a	;go back and do side 0 if on side 1 now
 127:23980+13	FD86  3A2DFF  		LD	A,(TRACK)
 128:23993+4	FD89  3C      		INC	A
 129:23997+10	FD8A  21BEFF  		ld	hl,tracks
 130:24007+7	FD8D  BE      		CP	(HL)
 131:24014+10	FD8E  DAF4FC  		JP	C,FORM3		;FORMAT UP TO LAST TRACK ON DISK
 132:				
 133:24024+16	FD91  2AC1FF  		LD	HL,(SEQPTR)
 134:24040+10	FD94  36FF    		LD	(HL),255	;STORE TERMINATOR ON CA-CA BUFFER
 135:24050+6	FD96  23      		INC	HL
 136:24056+10	FD97  36FF    		LD	(HL),255
 137:24066+4	FD99  AF      		XOR	A		;INDICATE FORMAT COMPLETED
 138:24070+11	FD9A  F5      	FORMX:	PUSH	AF
 139:24081+7	FD9B  3EFF    		LD	A,255
 140:24088+13	FD9D  322DFF  		LD	(TRACK),A
 141:24101+11	FDA0  D341    		OUT	(TRKREG),A	;FORCE DISK HANDLER TO RECALIBRATE
 142:24112+10	FDA2  F1      		POP	AF
 143:24122+10	FDA3  C9      		RET			;RETURN COMPLETION STATUS IN A
 144:				;
 145:				;
 146:				;
 147:				;
 148:				;	... SUBROUTINE TO BUILD IMAGE OF FORMATTED TRACK ...
 149:				;
 150:				;	PARAMETERS ARE:  IX ....... (POINTER TO FORMAT PARAMETERS)
 151:				;			 IY ....... (TABLE OF SECTOR NUMBERS)
 152:				;			 TRKPTR ... (POINTER TO TRACK DATA BUFFER)
 153:				;			 TRACK .... (TRACK NUMBER)
 154:				;			 NSECTS ... (NUMBER OF SECTORS)
 155:				;			 sides .... (copy of 'nsides' param)
 156:				;
 157:     -	FDA4          	BUILD:
 158:24132+13	FDA4  3ABAFF  		LD	A,(NSECTS)
 159:24145+4	FDA7  4F      		LD	C,A
 160:24149+15	FDA8  DDE5    		PUSH	IX
 161:24164+10	FDAA  E1      		POP	HL
 162:24174+7	FDAB  46      		LD	B,(HL)		;LOAD B WITH # OF FIELDS IN PREAMBLE
 163:24181+6	FDAC  23      		INC	HL
 164:24187+20	FDAD  ED5BC3FF		LD	DE,(TRKPTR)
 165:24207+17	FDB1  CD0BFE  	BUILD1:	CALL	INSERT		;INSERT FIELDS OF PREAMBLE
 166:24224+8+5	FDB4  10FB    		DJNZ	BUILD1
 167:				
 168:24232+7	FDB6  46      		LD	B,(HL)		;LOAD B WITH NUMBER OF ITEMS IN SECTOR
 169:24239+6	FDB7  23      		INC	HL
 170:24245+11	FDB8  E5      		PUSH	HL
 171:24256+14	FDB9  DDE1    		POP	IX		;IX POINTS TO START OF SECTOR POOP
 172:24270+13	FDBB  3A2DFF  	BUILD3:	LD	A,(TRACK)
 173:24283+19	FDBE  DD7707  		LD	(IX+7),A	;STORE TRACK# FOR TRACK BEING FORMATTED
 174:24302+13	FDC1  3A2FFF  		ld	a,(outcpy)
 175:24315+7	FDC4  E620    		and	00100000b
 176:24322+7	FDC6  3E00    		ld	a,0
 177:24329+7+5	FDC8  2801    		jr	z,bild31	;jump if formatting side 0
 178:24336+4	FDCA  3C      		inc	a
 179:24340+19	FDCB  DD7709  	bild31:	ld	(ix+9),a	;store side# in id
 180:24359+19	FDCE  FD7E00  		LD	A,(IY)
 181:24378+10	FDD1  FD23    		INC	IY
 182:24388+19	FDD3  DD770B  		LD	(IX+11),A	;STORE SECTOR# INTO FORMAT CONSTANTS
 183:				
 184:24407+15	FDD6  DDE5    		PUSH	IX
 185:24422+10	FDD8  E1      		POP	HL		;POINT HL TO SECTOR POOP
 186:24432+11	FDD9  C5      		PUSH	BC
 187:24443+17	FDDA  CD0BFE  	BUILD4:	CALL	INSERT
 188:24460+8+5	FDDD  10FB    		DJNZ	BUILD4		;INSERT ITEMS UP TO SECTOR DATA FIELD
 189:				
 190:24468+19	FDDF  DD7E0D  		LD	A,(IX+13)
 191:24487+17	FDE2  CDCDFA  		call	getsize		;compute sector size in bytes
 192:24504+7	FDE5  3EFF    	build6:	ld	a,0ffh
 193:24511+7	FDE7  12      		ld	(de),a		;fill sector data with ff's
 194:24518+6	FDE8  13      		INC	DE
 195:24524+6	FDE9  0B      		DEC	BC		;REPEAT TILL SECTOR IMAGE IS FILLED
 196:24530+4	FDEA  78      		LD	A,B
 197:24534+4	FDEB  B1      		OR	C
 198:24538+7+5	FDEC  20F7    		JR	NZ,BUILD6
 199:				
 200:24545+7	FDEE  46      		LD	B,(HL)		;GET #FIELDS IN POST-SECTOR STUFF
 201:24552+6	FDEF  23      		INC	HL
 202:24558+17	FDF0  CD0BFE  	BUILD7:	CALL	INSERT		;INSERT FIELDS UP TO GAP 3
 203:24575+8+5	FDF3  10FB    		DJNZ	BUILD7
 204:24583+10	FDF5  C1      		POP	BC
 205:				
 206:24593+4	FDF6  0D      		DEC	C
 207:24597+7+5	FDF7  20C2    		JR	NZ,BUILD3
 208:				
 209:24604+16	FDF9  2AC3FF  		LD	HL,(TRKPTR)
 210:24620+10	FDFC  01D827  		LD	BC,10200
 211:24630+11	FDFF  09      		ADD	HL,BC		;COMPUTE END OF LONGEST TRACK IMAGE
 212:24641+15	FE00  ED52    		SBC	HL,DE		;COMPUTE BYTES NECESSARY TO GET THERE
 213:24656+4	FE02  44      		LD	B,H
 214:24660+4	FE03  4D      		LD	C,L
 215:24664+4	FE04  62      		LD	H,D
 216:24668+4	FE05  6B      		LD	L,E
 217:24672+6	FE06  13      		INC	DE
 218:24678+7	FE07  77      		LD	(HL),A
 219:24685+16+5	FE08  EDB0    		LDIR			;FILL REST OF BUFFER
 220:24701+10	FE0A  C9      		RET
 221:				;
 222:				;
 223:				;
 224:24711+11	FE0B  C5      	INSERT:	PUSH	BC
 225:24722+7	FE0C  46      		LD	B,(HL)
 226:24729+6	FE0D  23      		INC	HL
 227:24735+7	FE0E  7E      		LD	A,(HL)
 228:24742+6	FE0F  23      		INC	HL
 229:24748+7	FE10  12      	INS2:	LD	(DE),A
 230:24755+6	FE11  13      		INC	DE
 231:24761+8+5	FE12  10FC    		DJNZ	INS2
 232:24769+10	FE14  C1      		POP	BC
 233:24779+10	FE15  C9      		RET
 234:				;
 235:				;
 236:				;
 237:				;
 238:				;	... DISK FORMAT DATA TABLES FOR 5/8 DD/SD STANDARDS ...
 239:				;
 240:				;
 241:     -	FE16  01      	SD5N18:	DEFB	1
 242:     -	FE17  10FF    		DEFB	16,0FFH
 243:				
 244:     -	FE19  0B      		DEFB	11
 245:     -	FE1A  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS TO MAKE
 246:     -	FE1C  0300    		DEFB	3,00H		; ID FIELD COME OUT IN RIGHT LOCATION)
 247:     -	FE1E  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 248:     -	FE20  0100    		DEFB	1,00H		;TRACK
 249:     -	FE22  0100    		DEFB	1,00H		;SIDE
 250:     -	FE24  0100    		DEFB	1,00H		;SECTOR
 251:     -	FE26  0100    		DEFB	1,00H		;LENGTH
 252:     -	FE28  01F7    		DEFB	1,0F7H		;GENERATE CRC
 253:     -	FE2A  0BFF    		DEFB	11,0FFH		;GAP2
 254:     -	FE2C  0600    		DEFB	6,00H		;GAP2
 255:     -	FE2E  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 256:				
 257:     -	FE30  02      		DEFB	2
 258:     -	FE31  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 259:     -	FE33  09FF    		DEFB	9,0FFH		;GAP 3
 260:				;
 261:				;
 262:				;
 263:				;
 264:				;
 265:     -	FE35  01      	DD5N18:	DEFB	1
 266:     -	FE36  204E    		DEFB	32,4EH		;GAP 1
 267:				
 268:     -	FE38  0C      		DEFB	12
 269:     -	FE39  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 270:     -	FE3B  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 271:     -	FE3D  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 272:     -	FE3F  0100    		DEFB	1,0		;TRACK#
 273:     -	FE41  0100    		DEFB	1,00000000B	;SIDE
 274:     -	FE43  0100    		DEFB	1,0		;SECTOR#
 275:     -	FE45  0101    		DEFB	1,00000001B	;LENGTH
 276:     -	FE47  01F7    		DEFB	1,0F7H		;GENERATE CRC
 277:     -	FE49  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 278:     -	FE4B  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 279:     -	FE4D  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 280:     -	FE4F  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 281:				
 282:     -	FE51  02      		DEFB	2
 283:     -	FE52  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 284:     -	FE54  104E    		DEFB	16,4EH		;FIRST PART OF GAP 3
 285:				;
 286:				;
 287:				;
 288:     -	FE56  12100E0C	SKEWSD:	DEFB	18,16,14,12,10,8,6,4,2
	              0A080604
	              02
 289:     -	FE5F  110F0D0B		DEFB	17,15,13,11,9,7,5,3,1
	              09070503
	              01
 290:				;
 291:     -	FE68  01070D  	SKEWDD:	DEFB	1,7,13
 292:     -	FE6B  060C12  		DEFB	6,12,18
 293:     -	FE6E  050B11  		DEFB	5,11,17
 294:     -	FE71  040A10  		DEFB	4,10,16
 295:     -	FE74  03090F  		DEFB	3,9,15
 296:     -	FE77  02080E  		DEFB	2,8,14
 297:				;
 298:				;
 299:				;
 300:     -	FE7A  04      	SD8N26:	DEFB	4		;PREAMBLE FIELD
 301:     -	FE7B  28FF    		DEFB	40,0FFH		;GAP 4
 302:     -	FE7D  0600    		DEFB	6,00
 303:     -	FE7F  01FC    		DEFB	1,0FCH		;INDEX ADDRESS MARK
 304:     -	FE81  1AFF    		DEFB	26,0FFH
 305:				
 306:     -	FE83  0B      		DEFB	11
 307:     -	FE84  0300    		DEFB	3,00H		;GAP 3 (DONE AS 2 FIELDS)
 308:     -	FE86  0300    		DEFB	3,00H		;
 309:     -	FE88  01FE    		DEFB	1,0FEH		;ID ADDRESS MARK
 310:     -	FE8A  0100    		DEFB	1,00H		;TRACK
 311:     -	FE8C  0100    		DEFB	1,00H		;SIDE
 312:     -	FE8E  0100    		DEFB	1,00H		;SECTOR
 313:     -	FE90  0100    		DEFB	1,00H		;LENGTH
 314:     -	FE92  01F7    		DEFB	1,0F7H		;GENERATE CRC
 315:     -	FE94  0BFF    		DEFB	11,0FFH		;GAP2
 316:     -	FE96  0600    		DEFB	6,00H		;GAP2
 317:     -	FE98  01FB    		DEFB	1,0FBH		;DATA ADDRESS MARK
 318:				
 319:     -	FE9A  02      		DEFB	2
 320:     -	FE9B  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 321:     -	FE9D  1BFF    		DEFB	27,0FFH		;GAP 3
 322:				;
 323:				;
 324:				;
 325:     -	FE9F  05      	DD8N26:	DEFB	5
 326:     -	FEA0  504E    		DEFB	80,4EH		;POST-INDEX GAP
 327:     -	FEA2  0C00    		DEFB	12,00H		;INDEX SYNC
 328:     -	FEA4  03F6    		DEFB	3,0F6H		;GENERATE SYNC=C1 HEX
 329:     -	FEA6  01FC    		DEFB	1,0FCH		;GENERATE INDEX ADDRESS MARK
 330:     -	FEA8  324E    		DEFB	50,4EH		;GAP 1
 331:				
 332:     -	FEAA  0C      		DEFB	12
 333:     -	FEAB  0C00    		DEFB	12,00H		;SECOND PART OF GAP 3
 334:     -	FEAD  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 335:     -	FEAF  01FE    		DEFB	1,0FEH		;GENERATE ID ADDRESS MARK
 336:     -	FEB1  0100    		DEFB	1,0		;TRACK#
 337:     -	FEB3  0100    		DEFB	1,00000000B	;SIDE
 338:     -	FEB5  0100    		DEFB	1,0		;SECTOR#
 339:     -	FEB7  0101    		DEFB	1,00000001B	;LENGTH
 340:     -	FEB9  01F7    		DEFB	1,0F7H		;GENERATE CRC
 341:     -	FEBB  164E    		DEFB	22,4EH		;FIRST PART OF GAP 2
 342:     -	FEBD  0C00    		DEFB	12,00H		;SECOND PART OF GAP 2
 343:     -	FEBF  03F5    		DEFB	3,0F5H		;GENERATE SYNC=A1 HEX
 344:     -	FEC1  01FB    		DEFB	1,0FBH		;GENERATE DATA ADDRESS MARK
 345:				
 346:     -	FEC3  02      		DEFB	2
 347:     -	FEC4  01F7    		DEFB	1,0F7H		;GENERATE CRC BYTES
 348:     -	FEC6  354E    		DEFB	53,4EH		;FIRST PART OF GAP 3
 349:				;
 350:				;
 351:				;
 352:     -	FEC8  010E0310	SKEW13:	DEFB	1,14,3,16,5,18,7,20,9,22,11,24,13,26
	              05120714
	              09160B18
	              0D1A
 353:     -	FED6  020F0411		DEFB	2,15,4,17,6,19,8,21,10,23,12,25
	              06130815
	              0A170C19
 354:				;
 355:				;
 356:     -	FEE2  0112091A	SKEW17:	DEFB	1,18,9,26,17,8,25,16,7,24,15,6,23
	              11081910
	              07180F06
	              17
 357:     -	FEEF  0E05160D		DEFB	14,5,22,13,4,21,12,3,20,11,2,19,10
	              04150C03
	              140B0213
	              0A
 358:				;
 359:				;
**** ..\src\sally2.asm ****
  57:				;
  58:				;
  59:				;
  60:     -	1532          		.DEPHASE
  61:     -	0EFC          	MONSIZE	EQU	$-MONCOPY
  62:				;
  63:				;
  64:     -	1532          	varcopy	equ	$
  65:     -	FF20          		.phase	0ff00h+32
  66:     -	FF00          	ram	equ	$-32		;put ram on start of 256 byte page
  67:     -	FF00          	KEYBUF	equ	ram		;16 byte keyboard input fifo
  68:     -	FF10          	CTCVEC	equ	ram+16	;8 word interrupt vector table
  69:					INCLUDE GLOBAL.MAC	;PUT GLOBAL VARIABLES AT TOP OF RAM
**** ..\src\GLOBAL.MAC ****
   1:				;********************************************************
   2:				;*							*
   3:				;*	GLOBAL VARIABLES FOR ATARI Z80 ROM		*
   4:				;*							*
   5:				;********************************************************
   6:				;
   7:     -	FF20          	glbvars	equ	$
   8:				;
   9:				;	... GLOBAL VARIABLES FOR PHYSICAL DISK HANDLER ...
  10:				;
  11:     -	FF20  FFFFFFFF	DRVTAB:	DEFB	255,255,255,255	;HEAD POSITIONS FOR 4 DRIVES
  12:     -	FF24  00000000		DEFB	0,0,0,0		;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
  13:     -	FF28  10101010	RATES:	DEFB	16,16,16,16	;SETTLING DELAYS / STEP RATES TABLE
  14:     -	FF2C  00      	UNIT:	DEFB	0		;CURRENTLY SELECTED DISK#
  15:     -	FF2D  FF      	TRACK:	DEFB	255		;TRACK POSITION OF SELECTED DRIVE
  16:     -	FF2E  01      	DRVOFF:	DEFB	1		;DRIVES-OFF FLAG FROM DISK TIMER IRQ
  17:     -	FF2F  00      	OUTCPY:	DEFB	00000000B	;COPY OF DISK CONTROL LATCH
  18:     -	FF30  0000    	PERIOD:	DEFW	0		;DISK SPIN PERIOD
  19:     -	FF32  32      	HLDTIM:	DEFB	50		;HEAD LOAD DELAY
  20:     -	FF33  0A      	RWMAX:	DEFB	10		;MAX NUMBER OF READ/WRITE RETRIES
  21:     -	FF34  00000000		DEFB	0,0,0,0		;ROOM FOR EXPANSION
  22:				;
  23:				;
  24:				;	... GLOBAL VARIABLES FOR ATARI HANDLER ...
  25:				;
  26:     -	FF38  21F8    	IDPTR:	DEFW	IDTAB		;POINTER TO DEVICE ID TABLE
  27:     -	FF3A  BEF7    	FSMVEC:	DEFW	PWRWAIT		;POINTER FOR ATARI TASK STATE MACHINE
  28:     -	FF3C  E1F7    	EXTVEC:	DEFW	DUMMY		;POINTER FOR EXTRA TASK PROCESSOR
  29:     -	FF3E  020D0A00	NEWLIN:	DEFB	2,CR,LF,0,0	;PRINTER NEWLINE CHARACTERS
	              00
  30:     -	FF43  00003C00	PSMSG:	DEFB	0,0,60,0	;PRINTER STATUS FRAME
  31:     -	FF47  80      	PMASKS:	DEFB	10000000B	;MASK ALL BITS BUT 'BUSY'
  32:     -	FF48  00      		DEFB	00000000B		;COMPARE TO ZERO FOR READY
  33:     -	FF49  B7FB    	FMTPTR:	DEFW	FMTS		;POINTER TO STANDARD FORMAT TABLES
  34:     -	FF4B  00C5    	PBASE:	DEFW	IOBUFF+(2*LEN)	;PUT PRINT BUFFER AFTER HERE
  35:     -	FF4D  FF0F    	PSIZE:	DEFW	4095		;MAX BUFFER INDEX OFFSET
  36:				
  37:     -	002F          	glbsize	equ	$-glbvars		;length of initialized variables
  38:     -	FF4F  73      	        DEFB    73h			; **** Exists in original ROM? ****
  39:				;
  40:				;
  41:				;	*** UNINITIALIZED SCRATCH VARIABLES COME AFTER HERE ***
  42:				;
  43:     -	FF4F          	PCOUNT:	EQU $-1				;BYTECOUNT FOR BUFFER
  44:     -	FF51          	PINP:	EQU PCOUNT+2		;INPUT OFFSET
  45:     -	FF53          	POUT:	EQU PINP+2			;OUTPUT OFFSET
  46:     -	FF55          	CMDFLG:	EQU POUT+2			;COMMAND FRAME READY FLAG FROM IRQ
  47:     -	FF56          	DMATRIX: EQU CMDFLG+1    	;DRIVE POOP TABLES
  48:     -	FF96          	OLDPTR:	EQU DMATRIX+64		;POINTER TO FIRST DRIVE ACCESSED
  49:     -	FF98          	DKIOCB:	EQU OLDPTR+2		;DISK I/O COMMAND BLOCK
  50:     -	FFA8          	DRWCMD:	EQU DKIOCB+16		;R/W COMMAND FROM ATARI TO 'DISKIO'
  51:     -	FFA9          	LOGSIZ:	EQU DRWCMD+1		;LOGICAL SECTOR LENGTH FOR XFER
  52:     -	FFAB          	IDBUF:	EQU	LOGSIZ+2		;BUFFER FOR ID MARK READS
  53:     -	FFB3          	IOPTR:	EQU IDBUF+8			;ATARI BLOCK INPUT POINTER
  54:     -	FFB5          	VFLAG:	EQU IOPTR+2			;VERIFY FLAG FOR DISK WRITES
  55:				
  56:				;
  57:				;
  58:				;	... VARIABLES FOR DISK FORMAT FUNCTION ...
  59:				;
  60:     -	FFB6          	FMTSTUFF	EQU	VFLAG+1
  61:     -	FFB6          	FRMPTR:	EQU VFLAG+1			;POINTER TO FORMAT DATA TABLE
  62:     -	FFB8          	SKWPTR:	EQU FRMPTR+2		;POINTER TO SKEW TABLE
  63:     -	FFBA          	NSECTS:	EQU SKWPTR+2		;NUMBER OF SECTORS
  64:     -	FFBB          	TRKSIZ:	EQU NSECTS+1		;TRACK LENGTH IN BYTES
  65:     -	0007          	FMTLEN	EQU	(TRKSIZ+2)-FMTSTUFF
  66:				
  67:     -	FFBD          	sides:	EQU TRKSIZ+2		;copy of 'nsides' for drive#
  68:     -	FFBE          	tracks:	EQU sides+1			;copy of 'ntrks' for drive#
  69:     -	FFBF          	SEQNUM:	EQU tracks+1		;TEMP SECTOR SEQUENCE NUMBER
  70:     -	FFC1          	SEQPTR:	EQU SEQNUM+2		;TEMP ERROR LOG TABLE POINTER
  71:     -	FFC3          	TRKPTR:	EQU SEQPTR+2		;POINTER TO START OF TRACK IMAGE
  72:				
  73:				;
  74:				;	... LOCAL VARIABLES FOR DISK HANDLER ...
  75:				;
  76:     -	FFC5          	CMDBYT:	EQU TRKPTR+2		;COMMAND BYTE FOR READS/WRITES
  77:     -	FFC6          	RWTRY:	EQU	CMDBYT+1		;READ/WRITE RETRY COUNT
  78:     -	FFC7          	TICKS:	EQU	RWTRY+1			;FREE RUNNING MILISECOND COUNTER
  79:     -	FFC9          	DRVTMR:	EQU TICKS+2			;DISK ACTIVITY TIMER
  80:				;
  81:				;
  82:				;
  83:				;
  84:     -	C100          	IOBUFF	EQU	0C100H		;ATARI I/O BUFFER
  85:     -	0200          	LEN	EQU	512
  86:				;
  87:     -	C300          	TRKBUF	EQU	IOBUFF+LEN	;TRACK BUFFER FOR READS
  88:				;
**** ..\src\sally2.asm ****
  70:				;
  71:     -	1562          		.DEPHASE
  72:				;
  73:     -	0001          	IF SALLYBUILD
  74:				;
  75:				;--------------------------------------------------
  76:				; set to zero in startup code until 0ffffh
  77:				;--------------------------------------------------
  78:24789+4	1562  00      			NOP
  79:24793+4	1563  00      			NOP
  80:24797+4	1564  00      			NOP
  81:24801+4	1565  00      			NOP
  82:24805+4	1566  00      			NOP
  83:24809+4	1567  00      			NOP
  84:24813+4	1568  00      			NOP
  85:24817+4	1569  00      			NOP
  86:24821+4	156A  00      			NOP
  87:24825+4	156B  00      			NOP
  88:24829+4	156C  00      			NOP
  89:     -	156D  524F4C4C			DB  'ROLLI 1 Rev 1.00'
	              49203120
	              52657620
	              312E3030
  90:				ELSE
 101:				ENDIF	;SALLYBUILD
 102:     -	157D          	END



Statistics:

     5	passes
     0	jr promotions
   562	symbols
  5501	bytes



Symbol Table:

ACTIVE         =04        4
ACTIVON         F03C      61500
ACTIVTY         F050      61520
ACTV2           F064      61540
ASCHEX          F483      62595
ATARI          =70        112
ATROUT         =50        80
BADCMD         =00        0
BADDAT         =01        1
BADRW          =02        2
BANKSW         =52        82
BOOT            F45F      62559
BOOTCB          F47A      62586
BUILD1          FDB1      64945
BUILD3          FDBB      64955
BUILD4          FDDA      64986
BUILD7          FDF0      65008
CALLHL          F7BD      63421
CDMUX          =57        87
CENT2           F4E5      62693
CENTOUT         F4DC      62684
CENTRDY         F4EB      62699
CFRAME         =C2FB      49915
CINIT2          F615      62997
CINIT3          F61A      63002
CINIT4          F61C      63004
CIV             F009      61449
CMDBYT         =FFC5      65477
CMDFLG         =FF55      65365
CMDL4           F7F3      63475
CMDL5           F809      63497
CMDOUT          F374      62324
CMDREG         =40        64
CMDSTS         =0C        12
CMDT1           F376      62326
CMDT2           F378      62328
CMDT3            5D9      1497
CMDWAIT         F7E2      63458
CONFIG         =01        1
CONIN           F640      63040
CONINIT         F5FC      62972
CONOUT          F650      63056
CONPAGE        =F500      62720
CONST           F635      63029
COUT2           F65F      63071
COV             F00C      61452
CR             =0D        13
CRLF            F4D5      62677
CSTART          F699      63129
CSTRT1          F6B4      63156
CSV             F006      61446
CTC0           =80        128
CTC1           =81        129
CTC2           =82        130
CTC3           =83        131
CTCVEC         =FF10      65296
CTC_D0_CONTROL =01        1
CTC_D0_VECTOR  =00        0
CTC_D1_SW_RST  =02        2
CTC_D2_TCNEXT  =04        4
CTC_D3_AUTOTRG =00        0
CTC_D3_CLKTRG  =08        8
CTC_D4_FALLEDGE=00        0
CTC_D4_RISEEDGE=10        16
CTC_D5_PRESC256=20        32
CTC_D5_PRESC_16=00        0
CTC_D6_MODE_CNT=40        64
CTC_D6_MODE_TIM=00        0
CTC_D7_INT_DIS =00        0
CTC_D7_INT_EN  =80        128
DATB2           F739      63289
DATBIT          F72C      63276
DATREG         =43        67
DD5N18          FE35      65077
DD8N26          FE9F      65183
DENSTY         =02        2
DINIT2          FB68      64360
DINIT3          FB6D      64365
DINIT6          FBAB      64427
DISK            F0A3      61603
DISK2           F0BA      61626
DISK3           F0BF      61631
DISK4           F0DE      61662
DISK4a          F0F0      61680
DISK5           F0FF      61695
DISKDVR         F022      61474
DISKINIT        FB38      64312
DISKMAX        =07        7
DISKPUT         F905      63749
DISKREAD        F98C      63884
DISKSTAT        FADB      64219
DISKTAB         F83D      63549
DISKV           F00F      61455
DISKWRITE       F908      63752
DISKX           F100      61696
DKIOCB         =FF98      65432
DMATRIX        =FF56      65366
DRD2            F9A8      63912
DRD2A           F9AC      63916
DRD3            F9BA      63930
DRD4            F9DB      63963
DRVINDEX        FC28      64552
DRVOFF          FF2E      65326
DRVSEL1        =01        1
DRVSEL2        =02        2
DRVSEL3        =04        4
DRVSEL4        =08        8
DRVTAB          FF20      65312
DRVTMR         =FFC9      65481
DRWCMD         =FFA8      65448
DSKAUX         =06        6
DSKBITS        =08        8
DSKDRV         =01        1
DSKOP          =00        0
DSKPTR         =04        4
DSKSEC         =03        3
DSKSTS         =08        8
DSKTRK         =02        2
DSTAT1          FB04      64260
DSTAT2          FB06      64262
DSTAT3          FB10      64272
DSTAT4          FB12      64274
DSTAT5          FB1C      64284
DSTAT6          FB1E      64286
DTR            =55        85
DUMMMYSYMBOL    01        1 (command line -D)
DUMMY           F7E1      63457
DWRT0           F90A      63754
DWRT1           F927      63783
DWRT2           F939      63801
DWRT3           F975      63861
DWRT4           F97D      63869
DWRT5           F984      63876
ECHO            F4B2      62642
EDGE            F1D5      61909
EDGE2           F1E5      61925
EMULATOR        F762      63330
ENDBIT          F755      63317
EXTVEC          FF3C      65340
FBS            =40        64
FDCRESET       =10        16
FDCSIDE        =20        32
FDENSITY       =80        128
FINCMD         =D0        208
FIRST          =00        0
FLAGS          =0E        14
FMTLEN         =07        7
FMTPTR          FF49      65353
FMTS            FBB7      64439
FMTSTUFF       =FFB6      65462
FORCE           F37C      62332
FORM2           FCD8      64728
FORM3           FCF4      64756
FORM3A          FCFF      64767
FORM4           FD32      64818
FORM5           FD47      64839
FORM51          FD59      64857
FORM6           FD74      64884
FORMAT          FCBE      64702
FORMX           FD9A      64922
FRMPTR         =FFB6      65462
FSMVEC          FF3A      65338
GETID          =03        3
GETPARAMS       FBE7      64487
GETSEC         =01        1
GOTO            F45E      62558
HAS850          F791      63377
HASPARMS        FBD3      64467
HDWSTS         =0D        13
HLDTIM          FF32      65330
HLDWAIT         F384      62340
HLOAD          =00        0
IDBUF          =FFAB      65451
IDMAX          =06        6
IDPTR           FF38      65336
IDTAB           F821      63521
INDEX           F8F1      63729
INDEX2          F903      63747
INDXCLR        =54        84
INDXSET        =56        86
INIT            00        0
INIT1           02        2
INIT2           0A        10
INITAB           5E0      1504
INS2            FE10      65040
INSERT          FE0B      65035
IOBUFF         =C100      49408
IOPTR          =FFB3      65459
ITBLEN         =16        22
KEYBUF         =FF00      65280
KLUDGE          F181      61825
LATCH          =30        48
LEN            = 200      512
LF             =0A        10
LISTV           F012      61458
LOGON           F766      63334
LOGSIZ         =FFA9      65449
MAIN            F7AC      63404
MEDIA          =05        5
MEMPTR          FCB2      64690
MINIMON         F3DE      62430
MONCOPY        = 636      1590
MONITOR        =F000      61440
MONSIZE        = EFC      3836
NEWLIN          FF3E      65342
NMIVEC         =66        102
NOHIGHSPEEDSIO =00        0
NOWAITMTR      =08        8
NSECS          =02        2
NSECTS         =FFBA      65466
NTRKS          =00        0
NULL           =00        0
OLDPTR         =FF96      65430
OUTCPY          FF2F      65327
OUTPUT          F4BE      62654
PBASE           FF4B      65355
PCOUNT         =FF4F      65359
PERIOD          FF30      65328
PINP           =FF51      65361
PMASKS          FF47      65351
PNEXT           F4C9      62665
PNXT1           F4CA      62666
POUT           =FF53      65363
PRESENT        =06        6
PRINTER        =20        32
PROM1           F407      62471
PROM2           F419      62489
PROM3           F420      62496
PROMPT          F3F1      62449
PSIZE           FF4D      65357
PSMSG           FF43      65347
PTRID           F823      63523
PTRMAX         =02        2
PTRSTAT         F862      63586
PTRTAB          F835      63541
PTRWRITE        F878      63608
PUT2HS          F498      62616
PUT2HX          F49F      62623
PUT4HS          F493      62611
PUTNIB          F4A8      62632
PUTPARAMS       FC05      64517
PUTSEC         =02        2
PWRIT3          F88E      63630
PWRIT4          F8B4      63668
PWRT3A          F898      63640
PWRWAIT         F7BE      63422
RAM            =FF00      65280
RAMTST          10        16
RATES           FF28      65320
RBUFF2          F6D0      63184
RCOV2A          F320      62240
RCOV2B          F322      62242
RCOV4A          F347      62279
RCOV4B          F349      62281
RDCMD          =80        128
RDTKDLY        =E4        228
RDTRK          =E0        224
READID          F08F      61583
RECOV1          F309      62217
RECOV2          F30D      62221
RECOV3          F330      62256
RECOVER         F2FC      62204
RECVBUFF        F6B9      63161
RENEW           F018      61464
REST            52        82
REST1           59        89
REST2           62        98
REST3           6E        110
REST3A          7F        127
REST4           97        151
REST4A          9D        157
RESTART         F01B      61467
RESTORE         F23A      62010
RETI1           F5F9      62969
RIDCMD         =C0        192
RSTCMD         =00        0
RTST1           15        21
RTST2           17        23
RTST3           21        33
RW1024          F2DA      62170
RW2             F2B3      62131
RW256           F2E3      62179
RW512           F2E0      62176
RWBUSY          F2E6      62182
RWDISK          F2A3      62115
RWEXIT          F2F1      62193
RWMAX           FF33      65331
RWTRY          =FFC6      65478
RXB1            F6E1      63201
RXB2            F6EC      63212
RXB3            F6F1      63217
RXB35           F704      63236
RXB4            F70E      63246
RXBAUD         =F506      62726
RXBLOCK         F6D9      63193
RXDAT2          F510      62736
RXDATA          F517      62743
RXINP          =F521      62753
RXOUT           F633      63027
RXSTART         F500      62720
RXSTOP          F52C      62764
RXTEMP         =F51C      62748
SALLYBUILD     =01        1
SCAN            F810      63504
SD5N18          FE16      65046
SD8N26          FE7A      65146
SEC256         =05        5
SECLEN         =06        6
SECREG         =42        66
SECTRAN         FA10      64016
SEEK            F247      62023
SEEK1           F1F5      61941
SEEK2           F202      61954
SEEKTRK         F1E9      61929
SEEKX           F21F      61983
SEL4            F157      61783
SEL5            F15A      61786
SEL5A           F164      61796
SELECT          F10A      61706
SELTAB          F191      61841
SELX            F186      61830
SENDACK         FC4A      64586
SENDBUFF        F66C      63084
SENDCHAR        FC56      64598
SENDCOMP        FC54      64596
SEQNUM         =FFBF      65471
SEQPTR         =FFC1      65473
SERIN          =50        80
SEROUT         =51        81
SERPAGE        =F719      63257
SETSSO          F0A3      61603
SETSTAT         F9E3      63971
SETTLE         =04        4
SFMT2           FB8B      64395
SFMT3           FB8F      64399
SHUTDOWN        F068      61544
SIDECMP        =02        2
SIDESEL        =08        8
SIOFAST        =08        8
SIONORMAL      =28        40
SIZE           =01        1
SKCMD          =10        16
SKEW13          FEC8      65224
SKEW17          FEE2      65250
SKEWDD          FE68      65128
SKEWSD          FE56      65110
SKWPTR         =FFB8      65464
SPARE0         =09        9
SPARE1         =0A        10
SPARE2         =0B        11
SPARE3         =0F        15
SPIN            F195      61845
SPIN2           F1A6      61862
SPIN3           F1D0      61904
SPIN4           F1CC      61900
SPIN5           F1BC      61884
SPIN6           F1C2      61890
SPINWAIT       =00        0
SPOOLER         F8D1      63697
SSTS1           F9F0      63984
SSTS2           F9F6      63990
SSTS3           F9FC      63996
STARBIT         F719      63257
STARTMR         F3A5      62373
STEP            F265      62053
STEPIN         =40        64
STEPOUT        =60        96
STEPRATE       =01        1
STEPRATE0      =00        0
STEPRATE1      =01        1
STEPRATE2      =02        2
STEPRATE3      =03        3
STEPRT         =01        1
STOP1A          F74E      63310
STOPB1          F73B      63291
STOPTMR         F3B6      62390
STR20           FA40      64064
STR25           FA78      64120
STR26           FA7D      64125
STRAN1          FA22      64034
STRAN2          FA27      64039
STRAN3          FA9A      64154
STRAN4          FAA5      64165
STRAN5          FABF      64191
STROBE         =53        83
STSREG         =40        64
SalyCMDOUT       5D2      1490
SalyDISK3       F0C5      61637
SalyDISKID      F82B      63531
SalyDISKRD1     F993      63891
SalyDISKRD2     F996      63894
SalyDISKRD3     F9D4      63956
SalyDISKWRT1    F918      63768
SalyDISKWRT2    F91B      63771
SalyDISKWRT3    F948      63816
SalyLOGN1       F77E      63358
SalyLOGN2       F781      63361
SalyLogon        150      336
SalyRXBLOCK     F6DC      63196
SalyResetFDC    F228      61992
SalySEL4         173      371
SalySEL4A        1A2      418
SalySEL4ex       1BB      443
SalyShutdn       167      359
SalyXMITBUF     F688      63112
TDRV2           F07C      61564
TESTDRV         F070      61552
TICKS          =FFC7      65479
TMRIRQ          F3BD      62397
TPCMD2          F360      62304
TPCMD3          F370      62320
TRACK           FF2D      65325
TRKBUF         =C300      49920
TRKBUFFER      = 800      2048
TRKPTR         =FFC3      65475
TRKREG         =41        65
TRKSIZ         =FFBB      65467
TSTRDY         =00        0
TXDAT0          F554      62804
TXDAT1          F566      62822
TXDAT2          F578      62840
TXDAT3          F58A      62858
TXDAT4          F59C      62876
TXDAT5          F5AE      62894
TXDAT6          F5C0      62912
TXDAT7          F5D2      62930
TXEXIT          F5EE      62958
TXSTART         F547      62791
TXSTOP          F5E0      62944
TXTMP0         =F556      62806
TXTMP1         =F568      62824
TXTMP2         =F57A      62842
TXTMP3         =F58C      62860
TXTMP4         =F59E      62878
TXTMP5         =F5B0      62896
TXTMP6         =F5C2      62914
TXTMP7         =F5D4      62932
TYP1CMD         F359      62297
TYP2CMD         F350      62288
UNIT            FF2C      65324
VARCOPY        =1532      5426
VERIFY          F283      62083
VFLAG          =FFB5      65461
VIEW            F430      62512
VIEW4           F456      62550
VIEW5           F458      62552
WAIT            F389      62345
WAIT2           F38A      62346
WATCHDOG        F393      62355
WD1772         =01        1
WD179X         =40        64
WRPCOMP        =02        2
WRPROT         =03        3
WRTCMD         =A0        160
WRTKDLY        =F4        244
WRTRK          =F0        240
XMITBUF         F684      63108
Z80GOTO         FCB4      64692
Z80MAX         =04        4
Z80READ         FC5F      64607
Z80SET          FCA6      64678
Z80TAB          F854      63572
Z80WRITE        FC7B      64635
ZEROS           45        69
ZLENGTH         FC9C      64668
bild31          FDCB      64971
build           FDA4      64932
build6          FDE5      64997
checktrack       41D      1053
cmdwaitfn        440      1088
code0000        C4        196
code8000        B2        178
compbufadr       400      1024
compbufadr1      41B      1051
compbufadr2      417      1047
dbgRWBUSY        52E      1326
dcb              627      1575
debug            2C8      712
direct           618      1560
diskiodebug      50B      1291
diskiodebug1     53A      1338
drive            61B      1563
dsector          616      1558
dskrd1           1C1      449
dskrd2           1D3      467
dskreadfn        33A      826
dsktb            5F6      1526
dskwrite         2B0      688
dskwrite1        2C5      709
dumpdcb          321      801
dumpdcb1         329      809
dumpsec          3DE      990
dwrt             24E      590
dwrta            25D      605
dwrtb            286      646
dwrtc            273      627
dwrtd            279      633
fastrecv         4CF      1231
fastrecv1        4E2      1250
fastrecv2        4F2      1266
fastrecv2a       4F4      1268
fastsend         485      1157
fastsend1        491      1169
form3b          FD17      64791
getsize         FACD      64205
getspeed         42A      1066
getsz2          FAD3      64211
glbsize        =2F        47
glbvars        =FF20      65312
hispeed          61A      1562
id               630      1584
irq4ms           4CA      1226
irq4ms1          4CC      1228
match            3B9      953
match1           3D0      976
match2           3D3      979
match3           3F5      1013
match3a          3E9      1001
nsides         =04        4
pokeydiv         619      1561
readtrack        38F      911
readtrack1       38C      908
readtrack2       37C      892
readtrack3       362      866
readtrack4       3AB      939
readtrack5       3B7      951
readtrack6       3B5      949
rxblck           4A4      1188
rxblck1          4B5      1205
sec2track        1F7      503
sec2track1       200      512
secptr           61D      1565
seraddr          572      1394
sercmd           540      1344
sercr            56A      1386
serdump          549      1353
serdump1         54F      1359
serdump2         54A      1354
serhex           57C      1404
serin1           5BF      1471
serin2           5B6      1462
serinfn          5B5      1461
sernib           58B      1419
sernib1          595      1429
serout1          5A2      1442
seroutfn         595      1429
serspace         562      1378
sides          =FFBD      65469
skewtab          61F      1567
slyCMDT1         5D4      1492
slyCMDT2         5D6      1494
ssts4           FA06      64006
str27           FA85      64133
thetrack         61C      1564
time19600        5CC      1484
time19600a       5CE      1486
togglebaud       4BB      1211
togglebaud1      4C6      1222
tracks         =FFBE      65470
xmitbuffn        459      1113
xmitfast         467      1127
xmitfast1        46F      1135
